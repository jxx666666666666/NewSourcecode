!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TGApp={})}(this,(function(exports){"use strict";class About{constructor(){this.version="3.2",this.buildDateTime="2022-4-1 18:24:23 GMT+8"}print(){logger.debug(`TGApp SDK ${this.version}, built at ${this.buildDateTime}.`)}}class TGInterface{constructor(e,t){if(2!==arguments.length)throw new Error("接口构造器参数必须是两个。");this.name=e,this.methods=[];for(var r=0;r<t.length;r++){if("string"!=typeof t[r])throw new Error("接口实现的函数名称必须是字符串。");this.methods.push(t[r])}}}TGInterface.ensureImplements=function(e){if(arguments.length<2)throw new Error("接口检查失败：参数必须多于 2 个。");for(var t=1,r=arguments.length;t<r;t++){var n=arguments[t];if(n.constructor!==TGInterface)throw new Error("接口检查失败：必须传入接口对象。");for(var i=[],a=0;a<n.methods.length;a++){var o=n.methods[a];e[o]&&"function"==typeof e[o]||i.push(o)}if(i.length>0)throw new Error(`接口检查失败：以下接口方法未被实现（${i.join(", ")}）。`)}};var TGRendererInterface=new TGInterface("TGRendererInterface",[]),commonjsGlobal$1="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function commonjsRequire$1(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var adapterLatest={exports:{}};!function(e,t){e.exports=function(){function e(t,r,n){function i(o,s){if(!r[o]){if(!t[o]){var l="function"==typeof commonjsRequire$1&&commonjsRequire$1;if(!s&&l)return l(o,!0);if(a)return a(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var h=r[o]={exports:{}};t[o][0].call(h.exports,(function(e){return i(t[o][1][e]||e)}),h,h.exports,e,t,r,n)}return r[o].exports}for(var a="function"==typeof commonjsRequire$1&&commonjsRequire$1,o=0;o<n.length;o++)i(n[o]);return i}return e}()({1:[function(e,t,r){var n=(0,e("./adapter_factory.js").adapterFactory)({window:"undefined"==typeof window?void 0:window});t.exports=n},{"./adapter_factory.js":2}],2:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.adapterFactory=h;var n=c(e("./utils")),i=c(e("./chrome/chrome_shim")),a=c(e("./firefox/firefox_shim")),o=c(e("./safari/safari_shim")),s=c(e("./common_shim")),l=c(e("sdp"));function c(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function h(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).window,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0},r=n.log,c=n.detectBrowser(e),h={browserDetails:c,commonShim:s,extractVersion:n.extractVersion,disableLog:n.disableLog,disableWarnings:n.disableWarnings,sdp:l};switch(c.browser){case"chrome":if(!i||!i.shimPeerConnection||!t.shimChrome)return r("Chrome shim is not included in this adapter release."),h;if(null===c.version)return r("Chrome shim can not determine version, not shimming."),h;r("adapter.js shimming chrome."),h.browserShim=i,s.shimAddIceCandidateNullOrEmpty(e,c),s.shimParameterlessSetLocalDescription(e,c),i.shimGetUserMedia(e,c),i.shimMediaStream(e,c),i.shimPeerConnection(e,c),i.shimOnTrack(e,c),i.shimAddTrackRemoveTrack(e,c),i.shimGetSendersWithDtmf(e,c),i.shimGetStats(e,c),i.shimSenderReceiverGetStats(e,c),i.fixNegotiationNeeded(e,c),s.shimRTCIceCandidate(e,c),s.shimConnectionState(e,c),s.shimMaxMessageSize(e,c),s.shimSendThrowTypeError(e,c),s.removeExtmapAllowMixed(e,c);break;case"firefox":if(!a||!a.shimPeerConnection||!t.shimFirefox)return r("Firefox shim is not included in this adapter release."),h;r("adapter.js shimming firefox."),h.browserShim=a,s.shimAddIceCandidateNullOrEmpty(e,c),s.shimParameterlessSetLocalDescription(e,c),a.shimGetUserMedia(e,c),a.shimPeerConnection(e,c),a.shimOnTrack(e,c),a.shimRemoveStream(e,c),a.shimSenderGetStats(e,c),a.shimReceiverGetStats(e,c),a.shimRTCDataChannel(e,c),a.shimAddTransceiver(e,c),a.shimGetParameters(e,c),a.shimCreateOffer(e,c),a.shimCreateAnswer(e,c),s.shimRTCIceCandidate(e,c),s.shimConnectionState(e,c),s.shimMaxMessageSize(e,c),s.shimSendThrowTypeError(e,c);break;case"safari":if(!o||!t.shimSafari)return r("Safari shim is not included in this adapter release."),h;r("adapter.js shimming safari."),h.browserShim=o,s.shimAddIceCandidateNullOrEmpty(e,c),s.shimParameterlessSetLocalDescription(e,c),o.shimRTCIceServerUrls(e,c),o.shimCreateOfferLegacy(e,c),o.shimCallbacksAPI(e,c),o.shimLocalStreamsAPI(e,c),o.shimRemoteStreamsAPI(e,c),o.shimTrackEventTransceiver(e,c),o.shimGetUserMedia(e,c),o.shimAudioContext(e,c),s.shimRTCIceCandidate(e,c),s.shimMaxMessageSize(e,c),s.shimSendThrowTypeError(e,c),s.removeExtmapAllowMixed(e,c);break;default:r("Unsupported browser!")}return h}},{"./chrome/chrome_shim":3,"./common_shim":6,"./firefox/firefox_shim":7,"./safari/safari_shim":10,"./utils":11,sdp:12}],3:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return i.shimGetUserMedia}});var a=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return a.shimGetDisplayMedia}}),r.shimMediaStream=c,r.shimOnTrack=h,r.shimGetSendersWithDtmf=u,r.shimGetStats=d,r.shimSenderReceiverGetStats=p,r.shimAddTrackRemoveTrackWithNative=f,r.shimAddTrackRemoveTrack=m,r.shimPeerConnection=g,r.fixNegotiationNeeded=y;var o=s(e("../utils.js"));function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function l(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function c(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function h(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var r=this;return this._ontrackpoly||(this._ontrackpoly=function(t){t.stream.addEventListener("addtrack",(function(n){var i=void 0;i=e.RTCPeerConnection.prototype.getReceivers?r.getReceivers().find((function(e){return e.track&&e.track.id===n.track.id})):{track:n.track};var a=new Event("track");a.track=n.track,a.receiver=i,a.transceiver={receiver:i},a.streams=[t.stream],r.dispatchEvent(a)})),t.stream.getTracks().forEach((function(n){var i=void 0;i=e.RTCPeerConnection.prototype.getReceivers?r.getReceivers().find((function(e){return e.track&&e.track.id===n.id})):{track:n};var a=new Event("track");a.track=n,a.receiver=i,a.transceiver={receiver:i},a.streams=[t.stream],r.dispatchEvent(a)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else o.wrapPeerConnectionEvent(e,"track",(function(e){return e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e}))}function u(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){var i=r.apply(this,arguments);return i||(i=t(this,e),this._senders.push(i)),i};var i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){i.apply(this,arguments);var t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}var a=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;this._senders=this._senders||[],a.apply(this,[e]),e.getTracks().forEach((function(e){r._senders.push(t(r,e))}))};var o=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._senders=this._senders||[],o.apply(this,[e]),e.getTracks().forEach((function(e){var r=t._senders.find((function(t){return t.track===e}));r&&t._senders.splice(t._senders.indexOf(r),1)}))}}else if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var s=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=s.apply(this,[]);return t.forEach((function(t){return t._pc=e})),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function d(e){if(e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){var e=this,r=Array.prototype.slice.call(arguments),n=r[0],i=r[1],a=r[2];if(arguments.length>0&&"function"==typeof n)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof n))return t.apply(this,[]);var o=function(e){var t={};return e.result().forEach((function(e){var r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((function(t){r[t]=e.stat(t)})),t[r.id]=r})),t},s=function(e){return new Map(Object.keys(e).map((function(t){return[t,e[t]]})))};if(arguments.length>=2){var l=function(e){i(s(o(e)))};return t.apply(this,[l,n])}return new Promise((function(r,n){t.apply(e,[function(e){r(s(o(e)))},n])})).then(i,a)}}}function p(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver){if(!("getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(this,[]);return r.forEach((function(t){return t._pc=e})),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){var e=this;return this._pc.getStats().then((function(t){return o.filterStats(t,e.track,!0)}))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){var i=e.RTCPeerConnection.prototype.getReceivers;i&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,t=i.apply(this,[]);return t.forEach((function(t){return t._pc=e})),t}),o.wrapPeerConnectionEvent(e,"track",(function(e){return e.receiver._pc=e.srcElement,e})),e.RTCRtpReceiver.prototype.getStats=function(){var e=this;return this._pc.getStats().then((function(t){return o.filterStats(t,e.track,!1)}))}}if("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype){var a=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){var t=arguments[0],r=void 0,n=void 0,i=void 0;return this.getSenders().forEach((function(e){e.track===t&&(r?i=!0:r=e)})),this.getReceivers().forEach((function(e){return e.track===t&&(n?i=!0:n=e),e.track===t})),i||r&&n?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():n?n.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return a.apply(this,arguments)}}}}function f(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((function(t){return e._shimmedLocalStreams[t][0]}))};var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var n=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(n)&&this._shimmedLocalStreams[r.id].push(n):this._shimmedLocalStreams[r.id]=[r,n],n};var r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var t=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((function(e){if(t.getSenders().find((function(t){return t.track===e})))throw new DOMException("Track already exists.","InvalidAccessError")}));var n=this.getSenders();r.apply(this,arguments);var i=this.getSenders().filter((function(e){return-1===n.indexOf(e)}));this._shimmedLocalStreams[e.id]=[e].concat(i)};var n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],n.apply(this,arguments)};var i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((function(r){var n=t._shimmedLocalStreams[r].indexOf(e);-1!==n&&t._shimmedLocalStreams[r].splice(n,1),1===t._shimmedLocalStreams[r].length&&delete t._shimmedLocalStreams[r]})),i.apply(this,arguments)}}function m(e,t){if(e.RTCPeerConnection){if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return f(e);var r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=r.apply(this);return this._reverseStreams=this._reverseStreams||{},t.map((function(t){return e._reverseStreams[t.id]}))};var n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var r=this;if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((function(e){if(r.getSenders().find((function(t){return t.track===e})))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){var i=new e.MediaStream(t.getTracks());this._streams[t.id]=i,this._reverseStreams[i.id]=t,t=i}n.apply(this,[t])};var i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},i.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,r){var n=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find((function(e){return e===t})))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find((function(e){return e.track===t})))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};var a=this._streams[r.id];if(a)a.addTrack(t),Promise.resolve().then((function(){n.dispatchEvent(new Event("negotiationneeded"))}));else{var o=new e.MediaStream([t]);this._streams[r.id]=o,this._reverseStreams[o.id]=r,this.addStream(o)}return this.getSenders().find((function(e){return e.track===t}))},["createOffer","createAnswer"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t],n=l({},t,(function(){var e=this,t=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(this,[function(r){var n=s(e,r);t[0].apply(null,[n])},function(e){t[1]&&t[1].apply(null,e)},arguments[2]]):r.apply(this,arguments).then((function(t){return s(e,t)}))}));e.RTCPeerConnection.prototype[t]=n[t]}));var a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=c(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};var o=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=o.get.apply(this);return""===e.type?e:s(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};var r=void 0;Object.keys(this._streams).forEach((function(n){t._streams[n].getTracks().find((function(t){return e.track===t}))&&(r=t._streams[n])})),r&&(1===r.getTracks().length?this.removeStream(this._reverseStreams[r.id]):r.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function s(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((function(t){var n=e._reverseStreams[t],i=e._streams[n.id];r=r.replace(new RegExp(i.id,"g"),n.id)})),new RTCSessionDescription({type:t.type,sdp:r})}function c(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((function(t){var n=e._reverseStreams[t],i=e._streams[n.id];r=r.replace(new RegExp(n.id,"g"),i.id)})),new RTCSessionDescription({type:t.type,sdp:r})}}function g(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t],n=l({},t,(function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}));e.RTCPeerConnection.prototype[t]=n[t]}))}function y(e,t){o.wrapPeerConnectionEvent(e,"negotiationneeded",(function(e){var r=e.target;if(!(t.version<72||r.getConfiguration&&"plan-b"===r.getConfiguration().sdpSemantics)||"stable"===r.signalingState)return e}))}},{"../utils.js":11,"./getdisplaymedia":4,"./getusermedia":5}],4:[function(e,t,r){function n(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(r){return t(r).then((function(t){var n=r.video&&r.video.width,i=r.video&&r.video.height,a=r.video&&r.video.frameRate;return r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:a||3}},n&&(r.video.mandatory.maxWidth=n),i&&(r.video.mandatory.maxHeight=i),e.navigator.mediaDevices.getUserMedia(r)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=n},{}],5:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}r.shimGetUserMedia=o;var a=i(e("../utils.js")).log;function o(e,t){var r=e&&e.navigator;if(r.mediaDevices){var i=function(e){if("object"!==(void 0===e?"undefined":n(e))||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach((function(r){if("require"!==r&&"advanced"!==r&&"mediaSource"!==r){var i="object"===n(e[r])?e[r]:{ideal:e[r]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);var a=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==i.ideal){t.optional=t.optional||[];var o={};"number"==typeof i.ideal?(o[a("min",r)]=i.ideal,t.optional.push(o),(o={})[a("max",r)]=i.ideal,t.optional.push(o)):(o[a("",r)]=i.ideal,t.optional.push(o))}void 0!==i.exact&&"number"!=typeof i.exact?(t.mandatory=t.mandatory||{},t.mandatory[a("",r)]=i.exact):["min","max"].forEach((function(e){void 0!==i[e]&&(t.mandatory=t.mandatory||{},t.mandatory[a(e,r)]=i[e])}))}})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},o=function(e,o){if(t.version>=61)return o(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"===n(e.audio)){var s=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])};s((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),s(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=i(e.audio)}if(e&&"object"===n(e.video)){var l=e.video.facingMode;l=l&&("object"===(void 0===l?"undefined":n(l))?l:{ideal:l});var c=t.version<66;if(l&&("user"===l.exact||"environment"===l.exact||"user"===l.ideal||"environment"===l.ideal)&&(!r.mediaDevices.getSupportedConstraints||!r.mediaDevices.getSupportedConstraints().facingMode||c)){delete e.video.facingMode;var h=void 0;if("environment"===l.exact||"environment"===l.ideal?h=["back","rear"]:"user"!==l.exact&&"user"!==l.ideal||(h=["front"]),h)return r.mediaDevices.enumerateDevices().then((function(t){var r=(t=t.filter((function(e){return"videoinput"===e.kind}))).find((function(e){return h.some((function(t){return e.label.toLowerCase().includes(t)}))}));return!r&&t.length&&h.includes("back")&&(r=t[t.length-1]),r&&(e.video.deviceId=l.exact?{exact:r.deviceId}:{ideal:r.deviceId}),e.video=i(e.video),a("chrome: "+JSON.stringify(e)),o(e)}))}e.video=i(e.video)}return a("chrome: "+JSON.stringify(e)),o(e)},s=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},l=function(e,t,n){o(e,(function(e){r.webkitGetUserMedia(e,t,(function(e){n&&n(s(e))}))}))};if(r.getUserMedia=l.bind(r),r.mediaDevices.getUserMedia){var c=r.mediaDevices.getUserMedia.bind(r.mediaDevices);r.mediaDevices.getUserMedia=function(e){return o(e,(function(e){return c(e).then((function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach((function(e){e.stop()})),new DOMException("","NotFoundError");return t}),(function(e){return Promise.reject(s(e))}))}))}}}}},{"../utils.js":11}],6:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimRTCIceCandidate=l,r.shimMaxMessageSize=c,r.shimSendThrowTypeError=h,r.shimConnectionState=u,r.removeExtmapAllowMixed=d,r.shimAddIceCandidateNullOrEmpty=p,r.shimParameterlessSetLocalDescription=f;var i=s(e("sdp")),a=o(e("./utils"));function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function s(e){return e&&e.__esModule?e:{default:e}}function l(e){if(!(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)){var t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"===(void 0===e?"undefined":n(e))&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){var r=new t(e),a=i.default.parseCandidate(e.candidate),o=Object.assign(r,a);return o.toJSON=function(){return{candidate:o.candidate,sdpMid:o.sdpMid,sdpMLineIndex:o.sdpMLineIndex,usernameFragment:o.usernameFragment}},o}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,a.wrapPeerConnectionEvent(e,"icecandidate",(function(t){return t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t}))}}function c(e,t){if(e.RTCPeerConnection){"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp}});var r=function(e){if(!e||!e.sdp)return!1;var t=i.default.splitSections(e.sdp);return t.shift(),t.some((function(e){var t=i.default.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},n=function(e){var t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;var r=parseInt(t[1],10);return r!=r?-1:r},a=function(e){var r=65536;return"firefox"===t.browser&&(r=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),r},o=function(e,r){var n=65536;"firefox"===t.browser&&57===t.version&&(n=65535);var a=i.default.matchPrefix(e.sdp,"a=max-message-size:");return a.length>0?n=parseInt(a[0].substr(19),10):"firefox"===t.browser&&-1!==r&&(n=2147483637),n},s=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76&&"plan-b"===this.getConfiguration().sdpSemantics&&Object.defineProperty(this,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0}),r(arguments[0])){var e=n(arguments[0]),i=a(e),l=o(arguments[0],e),c=void 0;c=0===i&&0===l?Number.POSITIVE_INFINITY:0===i||0===l?Math.max(i,l):Math.min(i,l);var h={};Object.defineProperty(h,"maxMessageSize",{get:function(){return c}}),this._sctp=h}return s.apply(this,arguments)}}}function h(e){if(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype){var t=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){var e=t.apply(this,arguments);return r(e,this),e},a.wrapPeerConnectionEvent(e,"datachannel",(function(e){return r(e.channel,e.target),e}))}function r(e,t){var r=e.send;e.send=function(){var n=arguments[0],i=n.length||n.size||n.byteLength;if("open"===e.readyState&&t.sctp&&i>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)}}}function u(e){if(e.RTCPeerConnection&&!("connectionState"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get:function(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get:function(){return this._onconnectionstatechange||null},set:function(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((function(e){var r=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=function(e){var t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;var r=new Event("connectionstatechange",e);t.dispatchEvent(r)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}}))}}function d(e,t){if(e.RTCPeerConnection&&!("chrome"===t.browser&&t.version>=71||"safari"===t.browser&&t.version>=605)){var r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){var n=t.sdp.split("\n").filter((function(e){return"a=extmap-allow-mixed"!==e.trim()})).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:n}):t.sdp=n}return r.apply(this,arguments)}}}function p(e,t){if(e.RTCPeerConnection&&e.RTCPeerConnection.prototype){var r=e.RTCPeerConnection.prototype.addIceCandidate;r&&0!==r.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}}function f(e,t){if(e.RTCPeerConnection&&e.RTCPeerConnection.prototype){var r=e.RTCPeerConnection.prototype.setLocalDescription;r&&0!==r.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){var e=this,t=arguments[0]||{};if("object"!==(void 0===t?"undefined":n(t))||t.type&&t.sdp)return r.apply(this,arguments);if(!(t={type:t.type,sdp:t.sdp}).type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":t.type="offer";break;default:t.type="answer"}return t.sdp||"offer"!==t.type&&"answer"!==t.type?r.apply(this,[t]):("offer"===t.type?this.createOffer:this.createAnswer).apply(this).then((function(t){return r.apply(e,[t])}))})}}},{"./utils":11,sdp:12}],7:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return i.shimGetUserMedia}});var a=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return a.shimGetDisplayMedia}}),r.shimOnTrack=c,r.shimPeerConnection=h,r.shimSenderGetStats=u,r.shimReceiverGetStats=d,r.shimRemoveStream=p,r.shimRTCDataChannel=f,r.shimAddTransceiver=m,r.shimGetParameters=g,r.shimCreateOffer=y,r.shimCreateAnswer=v;var o=s(e("../utils"));function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function l(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function c(e){"object"===(void 0===e?"undefined":n(e))&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})}function h(e,t){if("object"===(void 0===e?"undefined":n(e))&&(e.RTCPeerConnection||e.mozRTCPeerConnection)){!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t],n=l({},t,(function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}));e.RTCPeerConnection.prototype[t]=n[t]}));var r={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){var e=Array.prototype.slice.call(arguments),n=e[0],a=e[1],o=e[2];return i.apply(this,[n||null]).then((function(e){if(t.version<53&&!a)try{e.forEach((function(e){e.type=r[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach((function(t,n){e.set(n,Object.assign({},t,{type:r[t.type]||t.type}))}))}return e})).then(a,o)}}}function u(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&(!e.RTCRtpSender||!("getStats"in e.RTCRtpSender.prototype))){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(this,[]);return r.forEach((function(t){return t._pc=e})),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}}function d(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&(!e.RTCRtpSender||!("getStats"in e.RTCRtpReceiver.prototype))){var t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,r=t.apply(this,[]);return r.forEach((function(t){return t._pc=e})),r}),o.wrapPeerConnectionEvent(e,"track",(function(e){return e.receiver._pc=e.srcElement,e})),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}}function p(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;o.deprecated("removeStream","removeTrack"),this.getSenders().forEach((function(r){r.track&&e.getTracks().includes(r.track)&&t.removeTrack(r)}))})}function f(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function m(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];var e=arguments[1],r=e&&"sendEncodings"in e;r&&e.sendEncodings.forEach((function(e){if("rid"in e&&!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));var n=t.apply(this,arguments);if(r){var i=n.sender,a=i.getParameters();(!("encodings"in a)||1===a.encodings.length&&0===Object.keys(a.encodings[0]).length)&&(a.encodings=e.sendEncodings,i.sendEncodings=e.sendEncodings,this.setParametersPromises.push(i.setParameters(a).then((function(){delete i.sendEncodings})).catch((function(){delete i.sendEncodings}))))}return n})}}function g(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCRtpSender){var t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){var e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}}function y(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){var e=this,r=arguments;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((function(){return t.apply(e,r)})).finally((function(){e.setParametersPromises=[]})):t.apply(this,arguments)}}}function v(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){var e=this,r=arguments;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((function(){return t.apply(e,r)})).finally((function(){e.setParametersPromises=[]})):t.apply(this,arguments)}}}},{"../utils":11,"./getdisplaymedia":8,"./getusermedia":9}],8:[function(e,t,r){function n(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(r){if(!r||!r.video){var n=new DOMException("getDisplayMedia without video constraints is undefined");return n.name="NotFoundError",n.code=8,Promise.reject(n)}return!0===r.video?r.video={mediaSource:t}:r.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(r)})}Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=n},{}],9:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimGetUserMedia=o;var i=a(e("../utils"));function a(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function o(e,t){var r=e&&e.navigator,a=e&&e.MediaStreamTrack;if(r.getUserMedia=function(e,t,n){i.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(t,n)},!(t.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){var o=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])},s=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(e){return"object"===(void 0===e?"undefined":n(e))&&"object"===n(e.audio)&&(e=JSON.parse(JSON.stringify(e)),o(e.audio,"autoGainControl","mozAutoGainControl"),o(e.audio,"noiseSuppression","mozNoiseSuppression")),s(e)},a&&a.prototype.getSettings){var l=a.prototype.getSettings;a.prototype.getSettings=function(){var e=l.apply(this,arguments);return o(e,"mozAutoGainControl","autoGainControl"),o(e,"mozNoiseSuppression","noiseSuppression"),e}}if(a&&a.prototype.applyConstraints){var c=a.prototype.applyConstraints;a.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"===(void 0===e?"undefined":n(e))&&(e=JSON.parse(JSON.stringify(e)),o(e,"autoGainControl","mozAutoGainControl"),o(e,"noiseSuppression","mozNoiseSuppression")),c.apply(this,[e])}}}}},{"../utils":11}],10:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimLocalStreamsAPI=o,r.shimRemoteStreamsAPI=s,r.shimCallbacksAPI=l,r.shimGetUserMedia=c,r.shimConstraints=h,r.shimRTCIceServerUrls=u,r.shimTrackEventTransceiver=d,r.shimCreateOfferLegacy=p,r.shimAudioContext=f;var i=a(e("../utils"));function a(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function o(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((function(n){return t.call(r,n,e)})),e.getVideoTracks().forEach((function(n){return t.call(r,n,e)}))},e.RTCPeerConnection.prototype.addTrack=function(e){for(var r=this,n=arguments.length,i=Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];return i&&i.forEach((function(e){r._localStreams?r._localStreams.includes(e)||r._localStreams.push(e):r._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._localStreams||(this._localStreams=[]);var r=this._localStreams.indexOf(e);if(-1!==r){this._localStreams.splice(r,1);var n=e.getTracks();this.getSenders().forEach((function(e){n.includes(e.track)&&t.removeTrack(e)}))}})}}function s(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){var t=this;this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach((function(e){if(t._remoteStreams||(t._remoteStreams=[]),!t._remoteStreams.includes(e)){t._remoteStreams.push(e);var r=new Event("addstream");r.stream=e,t.dispatchEvent(r)}}))})}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((function(t){if(e._remoteStreams||(e._remoteStreams=[]),!(e._remoteStreams.indexOf(t)>=0)){e._remoteStreams.push(t);var r=new Event("addstream");r.stream=t,e.dispatchEvent(r)}}))}),t.apply(e,arguments)}}}function l(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype,r=t.createOffer,i=t.createAnswer,a=t.setLocalDescription,o=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(e,t){var n=arguments.length>=2?arguments[2]:arguments[0],i=r.apply(this,[n]);return t?(i.then(e,t),Promise.resolve()):i},t.createAnswer=function(e,t){var r=arguments.length>=2?arguments[2]:arguments[0],n=i.apply(this,[r]);return t?(n.then(e,t),Promise.resolve()):n};var l=function(e,t,r){var n=a.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n};t.setLocalDescription=l,l=function(e,t,r){var n=o.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.setRemoteDescription=l,l=function(e,t,r){var n=s.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.addIceCandidate=l}}function c(e){var t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){var r=t.mediaDevices,n=r.getUserMedia.bind(r);t.mediaDevices.getUserMedia=function(e){return n(h(e))}}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,n){t.mediaDevices.getUserMedia(e).then(r,n)}.bind(t))}function h(e){return e&&void 0!==e.video?Object.assign({},e,{video:i.compactObject(e.video)}):e}function u(e){if(e.RTCPeerConnection){var t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){for(var n=[],a=0;a<e.iceServers.length;a++){var o=e.iceServers[a];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(i.deprecated("RTCIceServer.url","RTCIceServer.urls"),(o=JSON.parse(JSON.stringify(o))).urls=o.url,delete o.url,n.push(o)):n.push(e.iceServers[a])}e.iceServers=n}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}})}}function d(e){"object"===(void 0===e?"undefined":n(e))&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})}function p(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);var r=this.getTransceivers().find((function(e){return"audio"===e.receiver.track.kind}));!1===e.offerToReceiveAudio&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==e.offerToReceiveAudio||r||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);var n=this.getTransceivers().find((function(e){return"video"===e.receiver.track.kind}));!1===e.offerToReceiveVideo&&n?"sendrecv"===n.direction?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":"recvonly"===n.direction&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):!0!==e.offerToReceiveVideo||n||this.addTransceiver("video")}return t.apply(this,arguments)}}function f(e){"object"!==(void 0===e?"undefined":n(e))||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}},{"../utils":11}],11:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}r.extractVersion=s,r.wrapPeerConnectionEvent=l,r.disableLog=c,r.disableWarnings=h,r.log=u,r.deprecated=d,r.detectBrowser=p,r.compactObject=m,r.walkStats=g,r.filterStats=y;var a=!0,o=!0;function s(e,t,r){var n=e.match(t);return n&&n.length>=r&&parseInt(n[r],10)}function l(e,t,r){if(e.RTCPeerConnection){var n=e.RTCPeerConnection.prototype,i=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return i.apply(this,arguments);var a=function(e){var t=r(e);t&&(n.handleEvent?n.handleEvent(t):n(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(n,a),i.apply(this,[e,a])};var a=n.removeEventListener;n.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[t])return a.apply(this,arguments);if(!this._eventMap[t].has(r))return a.apply(this,arguments);var n=this._eventMap[t].get(r);return this._eventMap[t].delete(r),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,a.apply(this,[e,n])},Object.defineProperty(n,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}}function c(e){return"boolean"!=typeof e?new Error("Argument type: "+(void 0===e?"undefined":n(e))+". Please use a boolean."):(a=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function h(e){return"boolean"!=typeof e?new Error("Argument type: "+(void 0===e?"undefined":n(e))+". Please use a boolean."):(o=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function u(){if("object"===("undefined"==typeof window?"undefined":n(window))){if(a)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function d(e,t){o&&console.warn(e+" is deprecated, please use "+t+" instead.")}function p(e){var t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;var r=e.navigator;if(r.mozGetUserMedia)t.browser="firefox",t.version=s(r.userAgent,/Firefox\/(\d+)\./,1);else if(r.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)t.browser="chrome",t.version=s(r.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!e.RTCPeerConnection||!r.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=s(r.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}function f(e){return"[object Object]"===Object.prototype.toString.call(e)}function m(e){return f(e)?Object.keys(e).reduce((function(t,r){var n=f(e[r]),a=n?m(e[r]):e[r],o=n&&!Object.keys(a).length;return void 0===a||o?t:Object.assign(t,i({},r,a))}),{}):e}function g(e,t,r){t&&!r.has(t.id)&&(r.set(t.id,t),Object.keys(t).forEach((function(n){n.endsWith("Id")?g(e,e.get(t[n]),r):n.endsWith("Ids")&&t[n].forEach((function(t){g(e,e.get(t),r)}))})))}function y(e,t,r){var n=r?"outbound-rtp":"inbound-rtp",i=new Map;if(null===t)return i;var a=[];return e.forEach((function(e){"track"===e.type&&e.trackIdentifier===t.id&&a.push(e)})),a.forEach((function(t){e.forEach((function(r){r.type===n&&r.trackId===t.id&&g(e,r,i)}))})),i}},{}],12:[function(e,t,r){var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};i.localCName=i.generateIdentifier(),i.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},i.splitSections=function(e){return e.split("\nm=").map((function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"}))},i.getDescription=function(e){var t=i.splitSections(e);return t&&t[0]},i.getMediaSections=function(e){var t=i.splitSections(e);return t.shift(),t},i.matchPrefix=function(e,t){return i.splitLines(e).filter((function(e){return 0===e.indexOf(t)}))},i.parseCandidate=function(e){for(var t=void 0,r={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},n=8;n<t.length;n+=2)switch(t[n]){case"raddr":r.relatedAddress=t[n+1];break;case"rport":r.relatedPort=parseInt(t[n+1],10);break;case"tcptype":r.tcpType=t[n+1];break;case"ufrag":r.ufrag=t[n+1],r.usernameFragment=t[n+1];break;default:void 0===r[t[n]]&&(r[t[n]]=t[n+1])}return r},i.writeCandidate=function(e){var t=[];t.push(e.foundation);var r=e.component;"rtp"===r?t.push(1):"rtcp"===r?t.push(2):t.push(r),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},i.parseIceOptions=function(e){return e.substr(14).split(" ")},i.parseRtpMap=function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},i.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},i.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},i.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},i.parseFmtp=function(e){for(var t={},r=void 0,n=e.substr(e.indexOf(" ")+1).split(";"),i=0;i<n.length;i++)t[(r=n[i].trim().split("="))[0].trim()]=r[1];return t},i.writeFmtp=function(e){var t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var n=[];Object.keys(e.parameters).forEach((function(t){void 0!==e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t)})),t+="a=fmtp:"+r+" "+n.join(";")+"\r\n"}return t},i.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},i.writeRtcpFb=function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},i.parseSsrcMedia=function(e){var t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},n=e.indexOf(":",t);return n>-1?(r.attribute=e.substr(t+1,n-t-1),r.value=e.substr(n+1)):r.attribute=e.substr(t+1),r},i.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},i.getMid=function(e){var t=i.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},i.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},i.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:i.matchPrefix(e+t,"a=fingerprint:").map(i.parseFingerprint)}},i.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),r},i.parseCryptoLine=function(e){var t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},i.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"===n(e.keyParams)?i.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},i.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},i.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},i.getCryptoParameters=function(e,t){return i.matchPrefix(e+t,"a=crypto:").map(i.parseCryptoLine)},i.getIceParameters=function(e,t){var r=i.matchPrefix(e+t,"a=ice-ufrag:")[0],n=i.matchPrefix(e+t,"a=ice-pwd:")[0];return r&&n?{usernameFragment:r.substr(12),password:n.substr(10)}:null},i.writeIceParameters=function(e){var t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},i.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=i.splitLines(e)[0].split(" "),n=3;n<r.length;n++){var a=r[n],o=i.matchPrefix(e,"a=rtpmap:"+a+" ")[0];if(o){var s=i.parseRtpMap(o),l=i.matchPrefix(e,"a=fmtp:"+a+" ");switch(s.parameters=l.length?i.parseFmtp(l[0]):{},s.rtcpFeedback=i.matchPrefix(e,"a=rtcp-fb:"+a+" ").map(i.parseRtcpFb),t.codecs.push(s),s.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(s.name.toUpperCase())}}}return i.matchPrefix(e,"a=extmap:").forEach((function(e){t.headerExtensions.push(i.parseExtmap(e))})),t},i.writeRtpDescription=function(e,t){var r="";r+="m="+e+" ",r+=t.codecs.length>0?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=t.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach((function(e){r+=i.writeRtpMap(e),r+=i.writeFmtp(e),r+=i.writeRtcpFb(e)}));var n=0;return t.codecs.forEach((function(e){e.maxptime>n&&(n=e.maxptime)})),n>0&&(r+="a=maxptime:"+n+"\r\n"),t.headerExtensions&&t.headerExtensions.forEach((function(e){r+=i.writeExtmap(e)})),r},i.parseRtpEncodingParameters=function(e){var t=[],r=i.parseRtpParameters(e),n=-1!==r.fecMechanisms.indexOf("RED"),a=-1!==r.fecMechanisms.indexOf("ULPFEC"),o=i.matchPrefix(e,"a=ssrc:").map((function(e){return i.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute})),s=o.length>0&&o[0].ssrc,l=void 0,c=i.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));c.length>0&&c[0].length>1&&c[0][0]===s&&(l=c[0][1]),r.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var r={ssrc:s,codecPayloadType:parseInt(e.parameters.apt,10)};s&&l&&(r.rtx={ssrc:l}),t.push(r),n&&((r=JSON.parse(JSON.stringify(r))).fec={ssrc:s,mechanism:a?"red+ulpfec":"red"},t.push(r))}})),0===t.length&&s&&t.push({ssrc:s});var h=i.matchPrefix(e,"b=");return h.length&&(h=0===h[0].indexOf("b=TIAS:")?parseInt(h[0].substr(7),10):0===h[0].indexOf("b=AS:")?1e3*parseInt(h[0].substr(5),10)*.95-16e3:void 0,t.forEach((function(e){e.maxBitrate=h}))),t},i.parseRtcpParameters=function(e){var t={},r=i.matchPrefix(e,"a=ssrc:").map((function(e){return i.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))[0];r&&(t.cname=r.value,t.ssrc=r.ssrc);var n=i.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=n.length>0,t.compound=0===n.length;var a=i.matchPrefix(e,"a=rtcp-mux");return t.mux=a.length>0,t},i.writeRtcpParameters=function(e){var t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},i.parseMsid=function(e){var t=void 0,r=i.matchPrefix(e,"a=msid:");if(1===r.length)return{stream:(t=r[0].substr(7).split(" "))[0],track:t[1]};var n=i.matchPrefix(e,"a=ssrc:").map((function(e){return i.parseSsrcMedia(e)})).filter((function(e){return"msid"===e.attribute}));return n.length>0?{stream:(t=n[0].value.split(" "))[0],track:t[1]}:void 0},i.parseSctpDescription=function(e){var t=i.parseMLine(e),r=i.matchPrefix(e,"a=max-message-size:"),n=void 0;r.length>0&&(n=parseInt(r[0].substr(19),10)),isNaN(n)&&(n=65536);var a=i.matchPrefix(e,"a=sctp-port:");if(a.length>0)return{port:parseInt(a[0].substr(12),10),protocol:t.fmt,maxMessageSize:n};var o=i.matchPrefix(e,"a=sctpmap:");if(o.length>0){var s=o[0].substr(10).split(" ");return{port:parseInt(s[0],10),protocol:s[1],maxMessageSize:n}}},i.writeSctpDescription=function(e,t){var r=[];return r="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&r.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),r.join("")},i.generateSessionId=function(){return Math.random().toString().substr(2,21)},i.writeSessionBoilerplate=function(e,t,r){var n=void 0!==t?t:2;return"v=0\r\no="+(r||"thisisadapterortc")+" "+(e||i.generateSessionId())+" "+n+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},i.getDirection=function(e,t){for(var r=i.splitLines(e),n=0;n<r.length;n++)switch(r[n]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[n].substr(2)}return t?i.getDirection(t):"sendrecv"},i.getKind=function(e){return i.splitLines(e)[0].split(" ")[0].substr(2)},i.isRejected=function(e){return"0"===e.split(" ",2)[1]},i.parseMLine=function(e){var t=i.splitLines(e)[0].substr(2).split(" ");return{kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}},i.parseOLine=function(e){var t=i.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}},i.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=i.splitLines(e),r=0;r<t.length;r++)if(t[r].length<2||"="!==t[r].charAt(1))return!1;return!0},"object"===(void 0===t?"undefined":n(t))&&(t.exports=i)},{}]},{},[1])(1)}(adapterLatest);class WebRtcPlayer{constructor(e){e=e||{};var t=this;this.cfg=e.peerConnectionOptions||{},this.useTCP=e.useTCP||!0,this.cfg.sdpSemantics="unified-plan",this.cfg.offerExtmapAllowMixed=!1,this.pcClient=null,this.dcClient=null,this.tnClient=null,this.sdpConstraints={offerToReceiveAudio:0,offerToReceiveVideo:1,voiceActivityDetection:!1},this.dataChannelOptions={ordered:!0};const r=new URLSearchParams(window.location.search);this.useMic=r.has("useMic"),this.useMic||console.log("Microphone access is not enabled. Pass ?useMic in the url to enable it.");let n="localhost"===location.hostname||"127.0.0.1"===location.hostname,i="https:"===location.protocol;function a(e){console.info("signaling state change:",e)}function o(e){console.info("ice connection state change:",e)}function s(e){console.info("ice gathering state change:",e)}function l(e){if(console.log("handleOnTrack",e.streams),e.track&&console.log("Got track - "+e.track.kind+" id="+e.track.id+" readyState="+e.track.readyState),"audio"!=e.track.kind)return"video"==e.track.kind&&(t.video.srcObject,e.streams[0]),t.video.srcObject=e.streams[0],void console.log("Set video source from video track ontrack.");!function(e){if(t.video.srcObject==e)return;if(t.video.srcObject&&t.video.srcObject!==e){let t=document.createElement("Audio");t.autoplay=!0,t.srcObject=e,t.play(),console.log("Created new audio element to play seperate audio stream.")}}(e.streams[0])}function c(e){console.log("ICE candidate",e),e.candidate&&e.candidate.candidate&&t.onWebRtcCandidate(e.candidate)}!this.useMic||n||i||(this.useMic=!1,console.error("Microphone access in the browser will not work if you are not on HTTPS or localhost. Disabling mic access."),console.error("For testing you can enable HTTP microphone access Chrome by visiting chrome://flags/ and enabling 'unsafely-treat-insecure-origin-as-secure'")),this.latencyTestTimings={TestStartTimeMs:null,UEReceiptTimeMs:null,UEPreCaptureTimeMs:null,UEPostCaptureTimeMs:null,UEPreEncodeTimeMs:null,UEPostEncodeTimeMs:null,UETransmissionTimeMs:null,BrowserReceiptTimeMs:null,FrameDisplayDeltaTimeMs:null,Reset:function(){this.TestStartTimeMs=null,this.UEReceiptTimeMs=null,this.UEPreCaptureTimeMs=null,this.UEPostCaptureTimeMs=null,this.UEPreEncodeTimeMs=null,this.UEPostEncodeTimeMs=null,this.UETransmissionTimeMs=null,this.BrowserReceiptTimeMs=null,this.FrameDisplayDeltaTimeMs=null},SetUETimings:function(e){this.UEReceiptTimeMs=e.ReceiptTimeMs,this.UEPreCaptureTimeMs=e.PreCaptureTimeMs,this.UEPostCaptureTimeMs=e.PostCaptureTimeMs,this.UEPreEncodeTimeMs=e.PreEncodeTimeMs,this.UEPostEncodeTimeMs=e.PostEncodeTimeMs,this.UETransmissionTimeMs=e.TransmissionTimeMs,this.BrowserReceiptTimeMs=Date.now(),this.OnAllLatencyTimingsReady(this)},SetFrameDisplayDeltaTime:function(e){null==this.FrameDisplayDeltaTimeMs&&(this.FrameDisplayDeltaTimeMs=Math.round(e),this.OnAllLatencyTimingsReady(this))},OnAllLatencyTimingsReady:function(e){}},this.video=function(){var e=document.createElement("video");if(e.id="streamingVideo",e.playsInline=!0,e.disablepictureinpicture=!0,e.muted=!1,e.addEventListener("loadedmetadata",(function(e){t.onVideoInitialised&&t.onVideoInitialised()}),!0),"requestVideoFrameCallback"in HTMLVideoElement.prototype){const r=(n,i)=>{if(i.receiveTime&&i.expectedDisplayTime){const e=i.presentationTime-i.receiveTime;t.aggregatedStats.receiveToCompositeMs=e}e.requestVideoFrameCallback(r)};e.requestVideoFrameCallback(r)}return e}(),this.startLatencyTest=function(e){t.video&&(t.latencyTestTimings.Reset(),t.latencyTestTimings.TestStartTimeMs=Date.now(),e(t.latencyTestTimings.TestStartTimeMs))},this.handleCandidateFromServer=function(e){console.log("ICE candidate: ",e);let r=new RTCIceCandidate(e);t.useTCP||"tcp"!=r.protocol?t.pcClient.addIceCandidate(r).then((e=>{console.log("ICE candidate successfully added")})):console.log("RTCIceCandidate protocol TCP Not add in")},this.createOffer=function(){t.pcClient&&(console.log("Closing existing PeerConnection"),t.pcClient.close(),t.pcClient=null),t.pcClient=new RTCPeerConnection(t.cfg),async function(e){if(e.addTransceiver("video",{direction:"recvonly"}),t.useMic){let r=!!t.useMic&&{autoGainControl:!1,channelCount:1,echoCancellation:!1,latency:0,noiseSuppression:!1,sampleRate:16e3,volume:1};const n=await navigator.mediaDevices.getUserMedia({video:!1,audio:r});if(n)for(const t of n.getTracks())t.kind&&"audio"==t.kind&&e.addTransceiver(t,{direction:"sendrecv"});else e.addTransceiver("audio",{direction:"recvonly"})}else e.addTransceiver("audio",{direction:"recvonly"})}(t.pcClient).finally((function(){var e;(e=t.pcClient).SetBitrate&&console.log("Hurray! there's RTCPeerConnection.SetBitrate function"),e.onsignalingstatechange=a,e.oniceconnectionstatechange=o,e.onicegatheringstatechange=s,e.ontrack=l,e.onicecandidate=c,t.dcClient=function(e,r,n){try{let i=e.createDataChannel(r,n);return console.log(`Created datachannel (${r})`),i.binaryType="arraybuffer",i.onopen=function(e){console.log(`data channel (${r}) connect`),t.onDataChannelConnected&&t.onDataChannelConnected()},i.onclose=function(e){console.log(`data channel (${r}) closed`)},i.onmessage=function(e){t.onDataChannelMessage&&t.onDataChannelMessage(e.data)},i}catch(e){return console.warn("No data channel",e),null}}(t.pcClient,"cirrus",t.dataChannelOptions),function(e){e.createOffer(t.sdpConstraints).then((function(r){!function(e){e.sdp=e.sdp.replace("useinbandfec=1","useinbandfec=1;stereo=1;sprop-maxcapturerate=48000")}(r),e.setLocalDescription(r),t.onWebRtcOffer&&t.onWebRtcOffer(r)}),(function(){console.warn("Couldn't create offer")}))}(t.pcClient)}))},this.receiveAnswer=function(e){console.log("Received answer:"),console.log(e);var r=new RTCSessionDescription(e);t.pcClient.setRemoteDescription(r);let n=t.pcClient.getReceivers();for(let e of n)e.playoutDelayHint=0},this.close=function(){t.pcClient&&(console.log("Closing existing peerClient"),t.pcClient.close(),t.pcClient=null),t.aggregateStatsIntervalId&&clearInterval(t.aggregateStatsIntervalId)},this.send=function(e){t.dcClient&&"open"==t.dcClient.readyState&&t.dcClient.send(e)},this.getStats=function(e){t.pcClient&&e&&t.pcClient.getStats(null).then((t=>{e(t)}))},this.aggregateStats=function(e){let r=(t.aggregatedStats||(t.aggregatedStats={}),function(e){let r={};console.log("----------------------------- Stats start -----------------------------"),e.forEach((e=>{"inbound-rtp"!=e.type||e.isRemote||"video"!=e.mediaType&&!e.id.toLowerCase().includes("video")||(r.timestamp=e.timestamp,r.bytesReceived=e.bytesReceived,r.framesDecoded=e.framesDecoded,r.packetsLost=e.packetsLost,r.bytesReceivedStart=t.aggregatedStats&&t.aggregatedStats.bytesReceivedStart?t.aggregatedStats.bytesReceivedStart:e.bytesReceived,r.framesDecodedStart=t.aggregatedStats&&t.aggregatedStats.framesDecodedStart?t.aggregatedStats.framesDecodedStart:e.framesDecoded,r.timestampStart=t.aggregatedStats&&t.aggregatedStats.timestampStart?t.aggregatedStats.timestampStart:e.timestamp,t.aggregatedStats&&t.aggregatedStats.timestamp&&(t.aggregatedStats.bytesReceived&&(r.bitrate=8*(r.bytesReceived-t.aggregatedStats.bytesReceived)/(r.timestamp-t.aggregatedStats.timestamp),r.bitrate=Math.floor(r.bitrate),r.lowBitrate=t.aggregatedStats.lowBitrate&&t.aggregatedStats.lowBitrate<r.bitrate?t.aggregatedStats.lowBitrate:r.bitrate,r.highBitrate=t.aggregatedStats.highBitrate&&t.aggregatedStats.highBitrate>r.bitrate?t.aggregatedStats.highBitrate:r.bitrate),t.aggregatedStats.bytesReceivedStart&&(r.avgBitrate=8*(r.bytesReceived-t.aggregatedStats.bytesReceivedStart)/(r.timestamp-t.aggregatedStats.timestampStart),r.avgBitrate=Math.floor(r.avgBitrate)),t.aggregatedStats.framesDecoded&&(r.framerate=(r.framesDecoded-t.aggregatedStats.framesDecoded)/((r.timestamp-t.aggregatedStats.timestamp)/1e3),r.framerate=Math.floor(r.framerate),r.lowFramerate=t.aggregatedStats.lowFramerate&&t.aggregatedStats.lowFramerate<r.framerate?t.aggregatedStats.lowFramerate:r.framerate,r.highFramerate=t.aggregatedStats.highFramerate&&t.aggregatedStats.highFramerate>r.framerate?t.aggregatedStats.highFramerate:r.framerate),t.aggregatedStats.framesDecodedStart&&(r.avgframerate=(r.framesDecoded-t.aggregatedStats.framesDecodedStart)/((r.timestamp-t.aggregatedStats.timestampStart)/1e3),r.avgframerate=Math.floor(r.avgframerate)))),"track"!=e.type||"video_label"!=e.trackIdentifier&&"video"!=e.kind||(r.framesDropped=e.framesDropped,r.framesReceived=e.framesReceived,r.framesDroppedPercentage=e.framesDropped/e.framesReceived*100,r.frameHeight=e.frameHeight,r.frameWidth=e.frameWidth,r.frameHeightStart=t.aggregatedStats&&t.aggregatedStats.frameHeightStart?t.aggregatedStats.frameHeightStart:e.frameHeight,r.frameWidthStart=t.aggregatedStats&&t.aggregatedStats.frameWidthStart?t.aggregatedStats.frameWidthStart:e.frameWidth),"candidate-pair"==e.type&&e.hasOwnProperty("currentRoundTripTime")&&0!=e.currentRoundTripTime&&(r.currentRoundTripTime=e.currentRoundTripTime)})),t.aggregatedStats.receiveToCompositeMs&&(r.receiveToCompositeMs=t.aggregatedStats.receiveToCompositeMs,t.latencyTestTimings.SetFrameDisplayDeltaTime(t.aggregatedStats.receiveToCompositeMs)),t.aggregatedStats=r,t.onAggregatedStats&&t.onAggregatedStats(r)});t.aggregateStatsIntervalId=setInterval((()=>{t.getStats(r)}),e)}}}var hammer={exports:{}};
/*! Hammer.JS - v2.0.8 - 2016-04-23
   * http://hammerjs.github.io/
   *
   * Copyright (c) 2016 Jorik Tangelder;
   * Licensed under the MIT license */!function(e){!function(t,r,n,i){var a,o=["","webkit","Moz","MS","ms","o"],s=r.createElement("div"),l=Math.round,c=Math.abs,h=Date.now;function u(e,t,r){return setTimeout(v(e,r),t)}function d(e,t,r){return!!Array.isArray(e)&&(p(e,r[t],r),!0)}function p(e,t,r){var n;if(e)if(e.forEach)e.forEach(t,r);else if(e.length!==i)for(n=0;n<e.length;)t.call(r,e[n],n,e),n++;else for(n in e)e.hasOwnProperty(n)&&t.call(r,e[n],n,e)}function f(e,r,n){var i="DEPRECATED METHOD: "+r+"\n"+n+" AT \n";return function(){var r=new Error("get-stack-trace"),n=r&&r.stack?r.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",a=t.console&&(t.console.warn||t.console.log);return a&&a.call(t.console,i,n),e.apply(this,arguments)}}a="function"!=typeof Object.assign?function(e){if(e===i||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),r=1;r<arguments.length;r++){var n=arguments[r];if(n!==i&&null!==n)for(var a in n)n.hasOwnProperty(a)&&(t[a]=n[a])}return t}:Object.assign;var m=f((function(e,t,r){for(var n=Object.keys(t),a=0;a<n.length;)(!r||r&&e[n[a]]===i)&&(e[n[a]]=t[n[a]]),a++;return e}),"extend","Use `assign`."),g=f((function(e,t){return m(e,t,!0)}),"merge","Use `assign`.");function y(e,t,r){var n,i=t.prototype;(n=e.prototype=Object.create(i)).constructor=e,n._super=i,r&&a(n,r)}function v(e,t){return function(){return e.apply(t,arguments)}}function b(e,t){return"function"==typeof e?e.apply(t&&t[0]||i,t):e}function _(e,t){return e===i?t:e}function x(e,t,r){p(T(t),(function(t){e.addEventListener(t,r,!1)}))}function w(e,t,r){p(T(t),(function(t){e.removeEventListener(t,r,!1)}))}function S(e,t){for(;e;){if(e==t)return!0;e=e.parentNode}return!1}function M(e,t){return e.indexOf(t)>-1}function T(e){return e.trim().split(/\s+/g)}function A(e,t,r){if(e.indexOf&&!r)return e.indexOf(t);for(var n=0;n<e.length;){if(r&&e[n][r]==t||!r&&e[n]===t)return n;n++}return-1}function E(e){return Array.prototype.slice.call(e,0)}function C(e,t,r){for(var n=[],i=[],a=0;a<e.length;){var o=t?e[a][t]:e[a];A(i,o)<0&&n.push(e[a]),i[a]=o,a++}return r&&(n=t?n.sort((function(e,r){return e[t]>r[t]})):n.sort()),n}function L(e,t){for(var r,n,a=t[0].toUpperCase()+t.slice(1),s=0;s<o.length;){if((n=(r=o[s])?r+a:t)in e)return n;s++}return i}var D=1;function R(e){var r=e.ownerDocument||e;return r.defaultView||r.parentWindow||t}var P="ontouchstart"in t,O=L(t,"PointerEvent")!==i,I=P&&/mobile|tablet|ip(ad|hone|od)|android/i.test(navigator.userAgent),k="touch",B="mouse",N=24,F=["x","y"],U=["clientX","clientY"];function z(e,t){var r=this;this.manager=e,this.callback=t,this.element=e.element,this.target=e.options.inputTarget,this.domHandler=function(t){b(e.options.enable,[e])&&r.handler(t)},this.init()}function H(e,t,r){var n=r.pointers.length,a=r.changedPointers.length,o=1&t&&n-a==0,s=12&t&&n-a==0;r.isFirst=!!o,r.isFinal=!!s,o&&(e.session={}),r.eventType=t,function(e,t){var r=e.session,n=t.pointers,a=n.length;r.firstInput||(r.firstInput=G(t));a>1&&!r.firstMultiple?r.firstMultiple=G(t):1===a&&(r.firstMultiple=!1);var o=r.firstInput,s=r.firstMultiple,l=s?s.center:o.center,u=t.center=V(n);t.timeStamp=h(),t.deltaTime=t.timeStamp-o.timeStamp,t.angle=X(l,u),t.distance=Y(l,u),function(e,t){var r=t.center,n=e.offsetDelta||{},i=e.prevDelta||{},a=e.prevInput||{};1!==t.eventType&&4!==a.eventType||(i=e.prevDelta={x:a.deltaX||0,y:a.deltaY||0},n=e.offsetDelta={x:r.x,y:r.y});t.deltaX=i.x+(r.x-n.x),t.deltaY=i.y+(r.y-n.y)}(r,t),t.offsetDirection=W(t.deltaX,t.deltaY);var d=j(t.deltaTime,t.deltaX,t.deltaY);t.overallVelocityX=d.x,t.overallVelocityY=d.y,t.overallVelocity=c(d.x)>c(d.y)?d.x:d.y,t.scale=s?(p=s.pointers,f=n,Y(f[0],f[1],U)/Y(p[0],p[1],U)):1,t.rotation=s?function(e,t){return X(t[1],t[0],U)+X(e[1],e[0],U)}(s.pointers,n):0,t.maxPointers=r.prevInput?t.pointers.length>r.prevInput.maxPointers?t.pointers.length:r.prevInput.maxPointers:t.pointers.length,function(e,t){var r,n,a,o,s=e.lastInterval||t,l=t.timeStamp-s.timeStamp;if(8!=t.eventType&&(l>25||s.velocity===i)){var h=t.deltaX-s.deltaX,u=t.deltaY-s.deltaY,d=j(l,h,u);n=d.x,a=d.y,r=c(d.x)>c(d.y)?d.x:d.y,o=W(h,u),e.lastInterval=t}else r=s.velocity,n=s.velocityX,a=s.velocityY,o=s.direction;t.velocity=r,t.velocityX=n,t.velocityY=a,t.direction=o}(r,t);var p,f;var m=e.element;S(t.srcEvent.target,m)&&(m=t.srcEvent.target);t.target=m}(e,r),e.emit("hammer.input",r),e.recognize(r),e.session.prevInput=r}function G(e){for(var t=[],r=0;r<e.pointers.length;)t[r]={clientX:l(e.pointers[r].clientX),clientY:l(e.pointers[r].clientY)},r++;return{timeStamp:h(),pointers:t,center:V(t),deltaX:e.deltaX,deltaY:e.deltaY}}function V(e){var t=e.length;if(1===t)return{x:l(e[0].clientX),y:l(e[0].clientY)};for(var r=0,n=0,i=0;i<t;)r+=e[i].clientX,n+=e[i].clientY,i++;return{x:l(r/t),y:l(n/t)}}function j(e,t,r){return{x:t/e||0,y:r/e||0}}function W(e,t){return e===t?1:c(e)>=c(t)?e<0?2:4:t<0?8:16}function Y(e,t,r){r||(r=F);var n=t[r[0]]-e[r[0]],i=t[r[1]]-e[r[1]];return Math.sqrt(n*n+i*i)}function X(e,t,r){r||(r=F);var n=t[r[0]]-e[r[0]],i=t[r[1]]-e[r[1]];return 180*Math.atan2(i,n)/Math.PI}z.prototype={handler:function(){},init:function(){this.evEl&&x(this.element,this.evEl,this.domHandler),this.evTarget&&x(this.target,this.evTarget,this.domHandler),this.evWin&&x(R(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&w(this.element,this.evEl,this.domHandler),this.evTarget&&w(this.target,this.evTarget,this.domHandler),this.evWin&&w(R(this.element),this.evWin,this.domHandler)}};var $={mousedown:1,mousemove:2,mouseup:4},Z="mousedown",q="mousemove mouseup";function J(){this.evEl=Z,this.evWin=q,this.pressed=!1,z.apply(this,arguments)}y(J,z,{handler:function(e){var t=$[e.type];1&t&&0===e.button&&(this.pressed=!0),2&t&&1!==e.which&&(t=4),this.pressed&&(4&t&&(this.pressed=!1),this.callback(this.manager,t,{pointers:[e],changedPointers:[e],pointerType:B,srcEvent:e}))}});var Q={pointerdown:1,pointermove:2,pointerup:4,pointercancel:8,pointerout:8},K={2:k,3:"pen",4:B,5:"kinect"},ee="pointerdown",te="pointermove pointerup pointercancel";function re(){this.evEl=ee,this.evWin=te,z.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}t.MSPointerEvent&&!t.PointerEvent&&(ee="MSPointerDown",te="MSPointerMove MSPointerUp MSPointerCancel"),y(re,z,{handler:function(e){var t=this.store,r=!1,n=e.type.toLowerCase().replace("ms",""),i=Q[n],a=K[e.pointerType]||e.pointerType,o=a==k,s=A(t,e.pointerId,"pointerId");1&i&&(0===e.button||o)?s<0&&(t.push(e),s=t.length-1):12&i&&(r=!0),s<0||(t[s]=e,this.callback(this.manager,i,{pointers:t,changedPointers:[e],pointerType:a,srcEvent:e}),r&&t.splice(s,1))}});var ne={touchstart:1,touchmove:2,touchend:4,touchcancel:8},ie="touchstart",ae="touchstart touchmove touchend touchcancel";function oe(){this.evTarget=ie,this.evWin=ae,this.started=!1,z.apply(this,arguments)}function se(e,t){var r=E(e.touches),n=E(e.changedTouches);return 12&t&&(r=C(r.concat(n),"identifier",!0)),[r,n]}y(oe,z,{handler:function(e){var t=ne[e.type];if(1===t&&(this.started=!0),this.started){var r=se.call(this,e,t);12&t&&r[0].length-r[1].length==0&&(this.started=!1),this.callback(this.manager,t,{pointers:r[0],changedPointers:r[1],pointerType:k,srcEvent:e})}}});var le={touchstart:1,touchmove:2,touchend:4,touchcancel:8},ce="touchstart touchmove touchend touchcancel";function he(){this.evTarget=ce,this.targetIds={},z.apply(this,arguments)}function ue(e,t){var r=E(e.touches),n=this.targetIds;if(3&t&&1===r.length)return n[r[0].identifier]=!0,[r,r];var i,a,o=E(e.changedTouches),s=[],l=this.target;if(a=r.filter((function(e){return S(e.target,l)})),1===t)for(i=0;i<a.length;)n[a[i].identifier]=!0,i++;for(i=0;i<o.length;)n[o[i].identifier]&&s.push(o[i]),12&t&&delete n[o[i].identifier],i++;return s.length?[C(a.concat(s),"identifier",!0),s]:void 0}y(he,z,{handler:function(e){var t=le[e.type],r=ue.call(this,e,t);r&&this.callback(this.manager,t,{pointers:r[0],changedPointers:r[1],pointerType:k,srcEvent:e})}});function de(){z.apply(this,arguments);var e=v(this.handler,this);this.touch=new he(this.manager,e),this.mouse=new J(this.manager,e),this.primaryTouch=null,this.lastTouches=[]}function pe(e,t){1&e?(this.primaryTouch=t.changedPointers[0].identifier,fe.call(this,t)):12&e&&fe.call(this,t)}function fe(e){var t=e.changedPointers[0];if(t.identifier===this.primaryTouch){var r={x:t.clientX,y:t.clientY};this.lastTouches.push(r);var n=this.lastTouches;setTimeout((function(){var e=n.indexOf(r);e>-1&&n.splice(e,1)}),2500)}}function me(e){for(var t=e.srcEvent.clientX,r=e.srcEvent.clientY,n=0;n<this.lastTouches.length;n++){var i=this.lastTouches[n],a=Math.abs(t-i.x),o=Math.abs(r-i.y);if(a<=25&&o<=25)return!0}return!1}y(de,z,{handler:function(e,t,r){var n=r.pointerType==k,i=r.pointerType==B;if(!(i&&r.sourceCapabilities&&r.sourceCapabilities.firesTouchEvents)){if(n)pe.call(this,t,r);else if(i&&me.call(this,r))return;this.callback(e,t,r)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});var ge=L(s.style,"touchAction"),ye=ge!==i,ve="compute",be="auto",_e="manipulation",xe="none",we="pan-x",Se="pan-y",Me=function(){if(!ye)return!1;var e={},r=t.CSS&&t.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach((function(n){e[n]=!r||t.CSS.supports("touch-action",n)})),e}();function Te(e,t){this.manager=e,this.set(t)}Te.prototype={set:function(e){e==ve&&(e=this.compute()),ye&&this.manager.element.style&&Me[e]&&(this.manager.element.style[ge]=e),this.actions=e.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var e=[];return p(this.manager.recognizers,(function(t){b(t.options.enable,[t])&&(e=e.concat(t.getTouchAction()))})),function(e){if(M(e,xe))return xe;var t=M(e,we),r=M(e,Se);if(t&&r)return xe;if(t||r)return t?we:Se;if(M(e,_e))return _e;return be}(e.join(" "))},preventDefaults:function(e){var t=e.srcEvent,r=e.offsetDirection;if(this.manager.session.prevented)t.preventDefault();else{var n=this.actions,i=M(n,xe)&&!Me.none,a=M(n,Se)&&!Me["pan-y"],o=M(n,we)&&!Me["pan-x"];if(i){var s=1===e.pointers.length,l=e.distance<2,c=e.deltaTime<250;if(s&&l&&c)return}if(!o||!a)return i||a&&6&r||o&&r&N?this.preventSrc(t):void 0}},preventSrc:function(e){this.manager.session.prevented=!0,e.preventDefault()}};var Ae=32;function Ee(e){this.options=a({},this.defaults,e||{}),this.id=D++,this.manager=null,this.options.enable=_(this.options.enable,!0),this.state=1,this.simultaneous={},this.requireFail=[]}function Ce(e){return 16&e?"cancel":8&e?"end":4&e?"move":2&e?"start":""}function Le(e){return 16==e?"down":8==e?"up":2==e?"left":4==e?"right":""}function De(e,t){var r=t.manager;return r?r.get(e):e}function Re(){Ee.apply(this,arguments)}function Pe(){Re.apply(this,arguments),this.pX=null,this.pY=null}function Oe(){Re.apply(this,arguments)}function Ie(){Ee.apply(this,arguments),this._timer=null,this._input=null}function ke(){Re.apply(this,arguments)}function Be(){Re.apply(this,arguments)}function Ne(){Ee.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}function Fe(e,t){return(t=t||{}).recognizers=_(t.recognizers,Fe.defaults.preset),new Ue(e,t)}Ee.prototype={defaults:{},set:function(e){return a(this.options,e),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(e){if(d(e,"recognizeWith",this))return this;var t=this.simultaneous;return t[(e=De(e,this)).id]||(t[e.id]=e,e.recognizeWith(this)),this},dropRecognizeWith:function(e){return d(e,"dropRecognizeWith",this)||(e=De(e,this),delete this.simultaneous[e.id]),this},requireFailure:function(e){if(d(e,"requireFailure",this))return this;var t=this.requireFail;return-1===A(t,e=De(e,this))&&(t.push(e),e.requireFailure(this)),this},dropRequireFailure:function(e){if(d(e,"dropRequireFailure",this))return this;e=De(e,this);var t=A(this.requireFail,e);return t>-1&&this.requireFail.splice(t,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(e){return!!this.simultaneous[e.id]},emit:function(e){var t=this,r=this.state;function n(r){t.manager.emit(r,e)}r<8&&n(t.options.event+Ce(r)),n(t.options.event),e.additionalEvent&&n(e.additionalEvent),r>=8&&n(t.options.event+Ce(r))},tryEmit:function(e){if(this.canEmit())return this.emit(e);this.state=Ae},canEmit:function(){for(var e=0;e<this.requireFail.length;){if(!(33&this.requireFail[e].state))return!1;e++}return!0},recognize:function(e){var t=a({},e);if(!b(this.options.enable,[this,t]))return this.reset(),void(this.state=Ae);56&this.state&&(this.state=1),this.state=this.process(t),30&this.state&&this.tryEmit(t)},process:function(e){},getTouchAction:function(){},reset:function(){}},y(Re,Ee,{defaults:{pointers:1},attrTest:function(e){var t=this.options.pointers;return 0===t||e.pointers.length===t},process:function(e){var t=this.state,r=e.eventType,n=6&t,i=this.attrTest(e);return n&&(8&r||!i)?16|t:n||i?4&r?8|t:2&t?4|t:2:Ae}}),y(Pe,Re,{defaults:{event:"pan",threshold:10,pointers:1,direction:30},getTouchAction:function(){var e=this.options.direction,t=[];return 6&e&&t.push(Se),e&N&&t.push(we),t},directionTest:function(e){var t=this.options,r=!0,n=e.distance,i=e.direction,a=e.deltaX,o=e.deltaY;return i&t.direction||(6&t.direction?(i=0===a?1:a<0?2:4,r=a!=this.pX,n=Math.abs(e.deltaX)):(i=0===o?1:o<0?8:16,r=o!=this.pY,n=Math.abs(e.deltaY))),e.direction=i,r&&n>t.threshold&&i&t.direction},attrTest:function(e){return Re.prototype.attrTest.call(this,e)&&(2&this.state||!(2&this.state)&&this.directionTest(e))},emit:function(e){this.pX=e.deltaX,this.pY=e.deltaY;var t=Le(e.direction);t&&(e.additionalEvent=this.options.event+t),this._super.emit.call(this,e)}}),y(Oe,Re,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[xe]},attrTest:function(e){return this._super.attrTest.call(this,e)&&(Math.abs(e.scale-1)>this.options.threshold||2&this.state)},emit:function(e){if(1!==e.scale){var t=e.scale<1?"in":"out";e.additionalEvent=this.options.event+t}this._super.emit.call(this,e)}}),y(Ie,Ee,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[be]},process:function(e){var t=this.options,r=e.pointers.length===t.pointers,n=e.distance<t.threshold,i=e.deltaTime>t.time;if(this._input=e,!n||!r||12&e.eventType&&!i)this.reset();else if(1&e.eventType)this.reset(),this._timer=u((function(){this.state=8,this.tryEmit()}),t.time,this);else if(4&e.eventType)return 8;return Ae},reset:function(){clearTimeout(this._timer)},emit:function(e){8===this.state&&(e&&4&e.eventType?this.manager.emit(this.options.event+"up",e):(this._input.timeStamp=h(),this.manager.emit(this.options.event,this._input)))}}),y(ke,Re,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[xe]},attrTest:function(e){return this._super.attrTest.call(this,e)&&(Math.abs(e.rotation)>this.options.threshold||2&this.state)}}),y(Be,Re,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:30,pointers:1},getTouchAction:function(){return Pe.prototype.getTouchAction.call(this)},attrTest:function(e){var t,r=this.options.direction;return 30&r?t=e.overallVelocity:6&r?t=e.overallVelocityX:r&N&&(t=e.overallVelocityY),this._super.attrTest.call(this,e)&&r&e.offsetDirection&&e.distance>this.options.threshold&&e.maxPointers==this.options.pointers&&c(t)>this.options.velocity&&4&e.eventType},emit:function(e){var t=Le(e.offsetDirection);t&&this.manager.emit(this.options.event+t,e),this.manager.emit(this.options.event,e)}}),y(Ne,Ee,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[_e]},process:function(e){var t=this.options,r=e.pointers.length===t.pointers,n=e.distance<t.threshold,i=e.deltaTime<t.time;if(this.reset(),1&e.eventType&&0===this.count)return this.failTimeout();if(n&&i&&r){if(4!=e.eventType)return this.failTimeout();var a=!this.pTime||e.timeStamp-this.pTime<t.interval,o=!this.pCenter||Y(this.pCenter,e.center)<t.posThreshold;if(this.pTime=e.timeStamp,this.pCenter=e.center,o&&a?this.count+=1:this.count=1,this._input=e,0===this.count%t.taps)return this.hasRequireFailures()?(this._timer=u((function(){this.state=8,this.tryEmit()}),t.interval,this),2):8}return Ae},failTimeout:function(){return this._timer=u((function(){this.state=Ae}),this.options.interval,this),Ae},reset:function(){clearTimeout(this._timer)},emit:function(){8==this.state&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}}),Fe.VERSION="2.0.8",Fe.defaults={domEvents:!1,touchAction:ve,enable:!0,inputTarget:null,inputClass:null,preset:[[ke,{enable:!1}],[Oe,{enable:!1},["rotate"]],[Be,{direction:6}],[Pe,{direction:6},["swipe"]],[Ne],[Ne,{event:"doubletap",taps:2},["tap"]],[Ie]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};function Ue(e,t){var r;this.options=a({},Fe.defaults,t||{}),this.options.inputTarget=this.options.inputTarget||e,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=new((r=this).options.inputClass||(O?re:I?he:P?de:J))(r,H),this.touchAction=new Te(this,this.options.touchAction),ze(this,!0),p(this.options.recognizers,(function(e){var t=this.add(new e[0](e[1]));e[2]&&t.recognizeWith(e[2]),e[3]&&t.requireFailure(e[3])}),this)}function ze(e,t){var r,n=e.element;n.style&&(p(e.options.cssProps,(function(i,a){r=L(n.style,a),t?(e.oldCssProps[r]=n.style[r],n.style[r]=i):n.style[r]=e.oldCssProps[r]||""})),t||(e.oldCssProps={}))}Ue.prototype={set:function(e){return a(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this},stop:function(e){this.session.stopped=e?2:1},recognize:function(e){var t=this.session;if(!t.stopped){var r;this.touchAction.preventDefaults(e);var n=this.recognizers,i=t.curRecognizer;(!i||i&&8&i.state)&&(i=t.curRecognizer=null);for(var a=0;a<n.length;)r=n[a],2===t.stopped||i&&r!=i&&!r.canRecognizeWith(i)?r.reset():r.recognize(e),!i&&14&r.state&&(i=t.curRecognizer=r),a++}},get:function(e){if(e instanceof Ee)return e;for(var t=this.recognizers,r=0;r<t.length;r++)if(t[r].options.event==e)return t[r];return null},add:function(e){if(d(e,"add",this))return this;var t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e},remove:function(e){if(d(e,"remove",this))return this;if(e=this.get(e)){var t=this.recognizers,r=A(t,e);-1!==r&&(t.splice(r,1),this.touchAction.update())}return this},on:function(e,t){if(e!==i&&t!==i){var r=this.handlers;return p(T(e),(function(e){r[e]=r[e]||[],r[e].push(t)})),this}},off:function(e,t){if(e!==i){var r=this.handlers;return p(T(e),(function(e){t?r[e]&&r[e].splice(A(r[e],t),1):delete r[e]})),this}},emit:function(e,t){this.options.domEvents&&function(e,t){var n=r.createEvent("Event");n.initEvent(e,!0,!0),n.gesture=t,t.target.dispatchEvent(n)}(e,t);var n=this.handlers[e]&&this.handlers[e].slice();if(n&&n.length){t.type=e,t.preventDefault=function(){t.srcEvent.preventDefault()};for(var i=0;i<n.length;)n[i](t),i++}},destroy:function(){this.element&&ze(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}},a(Fe,{INPUT_START:1,INPUT_MOVE:2,INPUT_END:4,INPUT_CANCEL:8,STATE_POSSIBLE:1,STATE_BEGAN:2,STATE_CHANGED:4,STATE_ENDED:8,STATE_RECOGNIZED:8,STATE_CANCELLED:16,STATE_FAILED:Ae,DIRECTION_NONE:1,DIRECTION_LEFT:2,DIRECTION_RIGHT:4,DIRECTION_UP:8,DIRECTION_DOWN:16,DIRECTION_HORIZONTAL:6,DIRECTION_VERTICAL:N,DIRECTION_ALL:30,Manager:Ue,Input:z,TouchAction:Te,TouchInput:he,MouseInput:J,PointerEventInput:re,TouchMouseInput:de,SingleTouchInput:oe,Recognizer:Ee,AttrRecognizer:Re,Tap:Ne,Pan:Pe,Swipe:Be,Pinch:Oe,Rotate:ke,Press:Ie,on:x,off:w,each:p,merge:g,extend:m,assign:a,inherit:y,bindFn:v,prefixed:L}),(void 0!==t?t:"undefined"!=typeof self?self:{}).Hammer=Fe,e.exports?e.exports=Fe:t.Hammer=Fe}(window,document)}(hammer);var Hammer=hammer.exports;const MessageType$1={IFrameRequest:0,RequestQualityControl:1,MaxFpsRequest:2,AverageBitrateRequest:3,StartStreaming:4,StopStreaming:5,UIInteraction:50,Command:51,KeyDown:60,KeyUp:61,KeyPress:62,MouseEnter:70,MouseLeave:71,MouseDown:72,MouseUp:73,MouseMove:74,MouseWheel:75,TouchStart:80,TouchEnd:81,TouchMove:82},ToClientMessageType={QualityControlOwnership:0,Response:1,Command:2,FreezeFrame:3,UnfreezeFrame:4,VideoEncoderAvgQP:5},SpecialKeyCodes={BackSpace:8,Shift:16,Control:17,Alt:18,RightShift:253,RightControl:254,RightAlt:255},MouseButton={MainButton:0,AuxiliaryButton:1,SecondaryButton:2,FourthButton:3,FifthButton:4},MouseButtonsMask={PrimaryButton:1,SecondaryButton:2,AuxiliaryButton:4,FourthButton:8,FifthButton:16},MultiTouchState={PanValueX:0,PanValueY:0,PanOffsetX:0,PanOffsetY:0,PanSize:.06,OrbitValueX:0,OrbitValueY:0,OrbitOffsetX:0,OrbitOffsetY:0,OrbitSize:.06,ZoomValue:0,ZoomOffset:0,ZoomSize:1,DeltaTimeValue:5e3},ControlSchemeType={LockedMouse:0,HoveringMouse:1},VideoQualityType={High:0,Medium:1,Low:2};class StreamingPlayerState{videoQuality=VideoQualityType.High;videoQuantizationParameter="N/A";duration="N/A";VideoResolution="N/A";framerate="N/A";bitrate="N/A";packetsLost="N/A";framesDropped="N/A";latency="N/A"}class StreamingPlayer{webRtcPlayerObj=null;playerElement=null;canInputConsoleCommand=!1;_responseCallback=new Map;_controlScheme=ControlSchemeType.LockedMouse;_printInputs=!1;_printLog=!1;_queryInterval=0;_stateCallback=null;_ws=null;_videoEncoderQP="N/A";_lastPoint={x:0,y:0};_lastPanPoint={x:0,y:0};_lastOrbitPoint={x:0,y:0};_lastScale=0;_isTouch=!1;_useTCP=!0;constructor(e){this._controlScheme=e.controlScheme,this._printInputs=e.printInputs,this._printLog=e.printLog,this._queryInterval=e.stateQueryInterval,this._useTCP=e.useTCP}createVideoElement(e){const t=document.createElement("div");t.setAttribute("id","playerDiv"),this.playerElement=this._setupWebRtcPlayer(t,e),this.playerElement.tabIndex=0}startPlay(e){if(window.WebSocket=window.WebSocket||window.MozWebSocket,!window.WebSocket)return void alert("Your browser doesn't support WebSocket");let t=this;this._ws=new WebSocket(e),this._ws.onopen=e=>{switch(t._createWebRtcOffer(),t._registerKeyboardEvents(t.playerElement),t._registerInputs(t.playerElement),t._controlScheme){case ControlSchemeType.HoveringMouse:t._registerHoveringMouseEvents(t.playerElement);break;case ControlSchemeType.LockedMouse:t._registerLockedMouseEvents(t.playerElement);break;default:t._printLog&&logger.debug("ERROR: Unknown control scheme"),t._registerLockedMouseEvents(t.playerElement)}setInterval((()=>{"1"==this._ws.readyState&&t._ws.send(JSON.stringify({type:"ping"}))}),5e3)},this._ws.onmessage=function(e){if(e.data)if(t._printLog&&logger.debug(`<- SS: ${e.data}`),"UE4 stopped"!==e.data)try{var r=JSON.parse(e.data);"config"===r.type?logger.debug(r):"playerCount"===r.type?updateKickButton(r.count-1):"answer"===r.type?t._onWebRtcAnswer(r):"iceCandidate"===r.type?t._onWebRtcIce(r.candidate):logger.warn(`invalid SS message type: ${r.type}`)}catch(t){logger.warn(`unknown SS message : ${e.data}`)}else logger.error("WS error: UE4 stopped")},this._ws.onerror=function(e){logger.error(`WS error: ${JSON.stringify(e)}`)},this._ws.onclose=function(r){if(t._printLog&&logger.debug(`WS closed: ${JSON.stringify(r.code)} - ${r.reason}`),"forever"!==r.reason&&""!==r.reason)return setTimeout((()=>{t.startPlay(e)}),3e3),void(t._ws=void 0);t._destroyObject()}}emitUIInteraction(e){this._emitDescriptor(MessageType$1.UIInteraction,e)}emitCommand(e){this._emitDescriptor(MessageType$1.Command,e)}registerResponseEvent(e,t){this._responseCallback.set(e,t)}unRegisterResponseEvent(e){this._responseCallback.remove(e)}addStatusChangedListener(e){"function"==typeof e?this._stateCallback=e:logger.error("监听状态改变参数不正确，应传入函数")}removeStatusChangedListener(){this._stateCallback=null}destroy(){this._printLog&&logger.debug("开始销毁StreamingPlayer。"),this._ws?this._ws.close():this._destroyObject()}_destroyObject(){let e=this;this._stateCallback=void 0,this._responseCallback&&(this._responseCallback.clear(),this._responseCallback=void 0);let t=document.getElementById("playerDiv");t&&t.removeChild(e.webRtcPlayerObj.video),e.webRtcPlayerObj&&(e.webRtcPlayerObj.close(),e.webRtcPlayerObj=void 0)}_emitMouseMove(e,t,r,n){this._printInputs&&logger.debug(`x: ${e}, y:${t}, dX: ${r}, dY: ${n}`);let i=this._runNormalizeAndQuantizeUnsigned(e,t),a=this._runNormalizeAndQuantizeSigned(r,n);var o=new DataView(new ArrayBuffer(9));o.setUint8(0,MessageType$1.MouseMove),o.setUint16(1,i.x,!0),o.setUint16(3,i.y,!0),o.setInt16(5,a.x,!0),o.setInt16(7,a.y,!0),this._sendInputData(o.buffer),this._lastPoint.x=e,this._lastPoint.y=t}_emitMouseDown(e,t,r){this._printInputs&&logger.debug(`mouse button ${e} down at (${t}, ${r})`);let n=this._runNormalizeAndQuantizeUnsigned(t,r);var i=new DataView(new ArrayBuffer(6));i.setUint8(0,MessageType$1.MouseDown),i.setUint8(1,e),i.setUint16(2,n.x,!0),i.setUint16(4,n.y,!0),this._sendInputData(i.buffer),this._lastPoint.x=t,this._lastPoint.y=r}_emitMouseUp(e,t,r){this._printInputs&&logger.debug(`mouse button ${e} up at (${t}, ${r})`);let n=this._runNormalizeAndQuantizeUnsigned(t,r);var i=new DataView(new ArrayBuffer(6));i.setUint8(0,MessageType$1.MouseUp),i.setUint8(1,e),i.setUint16(2,n.x,!0),i.setUint16(4,n.y,!0),this._sendInputData(i.buffer),this._lastPoint.x=t,this._lastPoint.y=r}_emitMouseWheel(e,t,r){this._printInputs&&logger.debug(`mouse wheel with delta ${e} at (${t}, ${r})`);let n=this._runNormalizeAndQuantizeUnsigned(t,r);var i=new DataView(new ArrayBuffer(7));i.setUint8(0,MessageType$1.MouseWheel),i.setInt16(1,e,!0),i.setUint16(3,n.x,!0),i.setUint16(5,n.y,!0),this._sendInputData(i.buffer),this._lastPoint.x=n.x,this._lastPoint.y=n.y}_setupWebRtcPlayer(e,t){let r=this;return this.webRtcPlayerObj=new WebRtcPlayer({peerConnectionOptions:t,useTCP:r._useTCP}),e.appendChild(this.webRtcPlayerObj.video),this.webRtcPlayerObj.onWebRtcOffer=function(e){if(r._ws&&1===r._ws.readyState){let t=JSON.stringify(e);r._printLog&&logger.debug(`-> SS: offer:\n${t}`),r._ws.send(t)}},this.webRtcPlayerObj.onWebRtcCandidate=function(e){r._ws&&1===r._ws.readyState&&(r._printLog&&logger.debug(`-> SS: iceCandidate\n${JSON.stringify(e,void 0,4)}`),r._ws.send(JSON.stringify({type:"iceCandidate",candidate:e})))},this.webRtcPlayerObj.onVideoInitialised=function(){r._ws&&r._ws.readyState},this.webRtcPlayerObj.onDataChannelConnected=function(){r._ws&&1===r._ws.readyState&&r._printLog&&logger.debug("WebRTC connected, waiting for video")},this.webRtcPlayerObj.onDataChannelMessage=function(e){var t=new Uint8Array(e);if(t[0]===ToClientMessageType.Response){let t=new TextDecoder("utf-16").decode(e.slice(1));if(r._responseCallback)for(let e of r._responseCallback.values())e({detail:t})}else if(t[0]===ToClientMessageType.Command){let t=new TextDecoder("utf-16").decode(e.slice(1));r._printLog&&logger.debug(t);let n=JSON.parse(t);"onScreenKeyboard"===n.command&&showOnScreenKeyboard(n)}else t[0]===ToClientMessageType.FreezeFrame?(freezeFrame.size=new DataView(t.slice(1,5).buffer).getInt32(0,!0),freezeFrame.jpeg=t.slice(5),freezeFrame.jpeg.length<freezeFrame.size?(r._printLog&&logger.debug(`received first chunk of freeze frame: ${freezeFrame.jpeg.length}/${freezeFrame.size}`),freezeFrame.receiving=!0):(r._printLog&&logger.debug(`received complete freeze frame: ${freezeFrame.jpeg.length}/${freezeFrame.size}`),showFreezeFrame())):t[0]===ToClientMessageType.UnfreezeFrame?invalidateFreezeFrameOverlay():t[0]===ToClientMessageType.VideoEncoderAvgQP?(r._videoEncoderQP=new TextDecoder("utf-16").decode(e.slice(1)),r._printLog&&logger.debug(`received VideoEncoderAvgQP ${r._videoEncoderQP}`)):logger.error(`unrecognized data received, packet ID ${t[0]}`)},this.webRtcPlayerObj.video}_createWebRtcOffer(){let e=this;this.webRtcPlayerObj?(e._printLog&&logger.debug("Creating offer"),this.webRtcPlayerObj.createOffer()):logger.error("WebRTC player not setup, cannot create offer")}_onWebRtcAnswer(e){let t=this;this.webRtcPlayerObj.receiveAnswer(e),this.webRtcPlayerObj.onAggregatedStats=e=>{let r=new Intl.NumberFormat(window.navigator.language,{maximumFractionDigits:0}),n=new Intl.NumberFormat(window.navigator.language,{maximumFractionDigits:0,minimumIntegerDigits:2}),i=(e.timestamp-e.timestampStart)/1e3,a=[],o=[60,60];for(let e=0;e<o.length;e++)a.push(i%o[e]),i/=o[e];a.push(i);let s=a[0],l=Math.floor(a[1]),c=Math.floor([a[2]]);let h=new StreamingPlayerState;t._videoEncoderQP>35?h.videoQuality=VideoQualityType.Low:t._videoEncoderQP>26&&(h.videoQuality=VideoQualityType.Medium),h.videoQuantizationParameter=t._videoEncoderQP,h.duration=`${n.format(c)}:${n.format(l)}:${n.format(s)}`,h.VideoResolution=""+(e.hasOwnProperty("frameWidth")&&e.frameWidth&&e.hasOwnProperty("frameHeight")&&e.frameHeight?e.frameWidth+"x"+e.frameHeight:"N/A"),h.framerate=`${e.hasOwnProperty("framerate")?r.format(e.framerate):"N/A"}`,h.bitrate=`${e.hasOwnProperty("bitrate")?r.format(e.bitrate):"N/A"}`,h.packetsLost=`${e.hasOwnProperty("packetsLost")?r.format(e.packetsLost):"N/A"}`,h.framesDropped=`${e.hasOwnProperty("framesDropped")?r.format(e.framesDropped):"N/A"}`,h.latency=`${e.hasOwnProperty("currentRoundTripTime")?r.format(1e3*e.currentRoundTripTime):"N/A"}`,t._stateCallback&&"function"==typeof t._stateCallback&&this._queryInterval>0&&t._stateCallback(h)},this.webRtcPlayerObj.aggregateStats(1e3*this._queryInterval==0?6e4:1e3*this._queryInterval)}_onWebRtcIce(e){this.webRtcPlayerObj&&this.webRtcPlayerObj.handleCandidateFromServer(e)}_emitDescriptor(e,t){let r=JSON.stringify(t),n=new DataView(new ArrayBuffer(3+2*r.length)),i=0;n.setUint8(i,e),i++,n.setUint16(i,r.length,!0),i+=2;for(let e=0;e<r.length;e++)n.setUint16(i,r.charCodeAt(e),!0),i+=2;this._sendInputData(n.buffer)}_sendInputData(e){this.webRtcPlayerObj?this.webRtcPlayerObj.send(e):logger.error("Cannot sent data!")}_registerKeyboardEvents(e){let t=this;e.onkeydown=function(e){t._printInputs&&logger.debug(`key down ${e.code}, repeat = ${e.repeat}`),"F11"!=e.code&&t._sendInputData(new Uint8Array([MessageType$1.KeyDown,t._getKeyCode(e),e.repeat]).buffer),e.code===SpecialKeyCodes.BackSpace&&t.playerElement.onkeypress({charCode:SpecialKeyCodes.BackSpace}),t.canInputConsoleCommand||e.preventDefault()},e.onkeyup=function(e){t._printInputs&&logger.debug(`key up ${e.keyCode}`),"F11"!=e.code&&t._sendInputData(new Uint8Array([MessageType$1.KeyUp,t._getKeyCode(e)]).buffer),t.canInputConsoleCommand||e.preventDefault()},e.onkeypress=function(e){if(t._printInputs&&logger.debug(`key press ${e.charCode}`),"F11"!=e.code){let r=new DataView(new ArrayBuffer(3));r.setUint8(0,MessageType$1.KeyPress),r.setUint16(1,e.charCode,!0),t._sendInputData(r.buffer)}t.canInputConsoleCommand||e.preventDefault()}}_isKeyCodeBrowserKey(e){return e>=112&&e<=123||9===e}_getKeyCode(e){return e.keyCode===SpecialKeyCodes.Shift&&"ShiftRight"===e.code?SpecialKeyCodes.RightShift:e.keyCode===SpecialKeyCodes.Control&&"ControlRight"===e.code?SpecialKeyCodes.RightControl:e.keyCode===SpecialKeyCodes.Alt&&"AltRight"===e.code?SpecialKeyCodes.RightAlt:e.keyCode}_registerHoveringMouseEvents(e){let t=this;e.onmousemove=function(e){t._isTouch?t._emitMouseMove(e.offsetX,e.offsetY,e.offsetX-t._lastPoint.x,e.offsetY-t._lastPoint.y):t._emitMouseMove(e.offsetX,e.offsetY,e.movementX,e.movementY),t._isTouch=!1,e.preventDefault()},e.onmousedown=function(e){t._emitMouseDown(e.button,e.offsetX,e.offsetY)},e.onmouseup=function(e){t._emitMouseUp(e.button,e.offsetX,e.offsetY)},e.oncontextmenu=function(e){t._emitMouseUp(e.button,e.offsetX,e.offsetY),e.preventDefault()},"onmousewheel"in e?e.onmousewheel=function(e){t._emitMouseWheel(e.wheelDelta,e.offsetX,e.offsetY),e.preventDefault()}:e.addEventListener("DOMMouseScroll",(function(e){t._emitMouseWheel(-120*e.detail,e.offsetX,e.offsetY),e.preventDefault()}),!1),e.pressMouseButtons=function(e){t._pressMouseButtons(e.buttons,e.offsetX,e.offsetY)},e.releaseMouseButtons=function(e){t._releaseMouseButtons(e.buttons,e.offsetX,e.offsetY)}}_releaseMouseButtons(e,t,r){e&MouseButtonsMask.PrimaryButton&&this._emitMouseUp(MouseButton.MainButton,t,r),e&MouseButtonsMask.SecondaryButton&&this._emitMouseUp(MouseButton.SecondaryButton,t,r),e&MouseButtonsMask.AuxiliaryButton&&this._emitMouseUp(MouseButton.AuxiliaryButton,t,r),e&MouseButtonsMask.FourthButton&&this._emitMouseUp(MouseButton.FourthButton,t,r),e&MouseButtonsMask.FifthButton&&this._emitMouseUp(MouseButton.FifthButton,t,r)}_pressMouseButtons(e,t,r){e&MouseButtonsMask.PrimaryButton&&this._emitMouseDown(MouseButton.MainButton,t,r),e&MouseButtonsMask.SecondaryButton&&this._emitMouseDown(MouseButton.SecondaryButton,t,r),e&MouseButtonsMask.AuxiliaryButton&&this._emitMouseDown(MouseButton.AuxiliaryButton,t,r),e&MouseButtonsMask.FourthButton&&this._emitMouseDown(MouseButton.FourthButton,t,r),e&MouseButtonsMask.FifthButton&&this._emitMouseDown(MouseButton.FifthButton,t,r)}_registerLockedMouseEvents(e){let t=this,r=e.width/2,n=e.height/2;function i(){document.pointerLockElement===e||document.mozPointerLockElement===e?(t._printLog&&logger.debug("Pointer locked"),document.addEventListener("mousemove",a,!1)):(t._printLog&&logger.debug("The pointer lock status is now unlocked"),document.removeEventListener("mousemove",a,!1))}function a(i){r+=i.movementX,n+=i.movementY,r>e.width&&(r-=e.width),n>e.height&&(n-=e.height),r<0&&(r=e.width+r),n<0&&(n=e.height-n),t._emitMouseMove(r,n,i.movementX,i.movementY)}e.requestPointerLock=e.requestPointerLock||e.mozRequestPointerLock,document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock,e.onclick=function(){e.requestPointerLock()},document.addEventListener("pointerlockchange",i,!1),document.addEventListener("mozpointerlockchange",i,!1),e.onmousedown=function(e){t._emitMouseDown(e.button,r,n)},e.onmouseup=function(e){t._emitMouseUp(e.button,r,n)},e.onmousewheel=function(e){t._emitMouseWheel(e.wheelDelta,r,n)},e.pressMouseButtons=function(e){t._pressMouseButtons(e.buttons,r,n)},e.releaseMouseButtons=function(e){t._releaseMouseButtons(e.buttons,r,n)}}_registerMouseEnterAndLeaveEvents(e){let t=this;e.onmouseenter=function(r){t._printInputs&&logger.debug("mouse enter");let n=new DataView(new ArrayBuffer(1));n.setUint8(0,MessageType$1.MouseEnter),t._sendInputData(n.buffer),e.pressMouseButtons(r)},e.onmouseleave=function(r){t._printInputs&&logger.debug("mouse leave");let n=new DataView(new ArrayBuffer(1));n.setUint8(0,MessageType$1.MouseLeave),t._sendInputData(n.buffer),e.releaseMouseButtons(r)}}_registerInputs(e){e&&(this._registerMouseEnterAndLeaveEvents(e),this._registerHammerEvents(e))}_registerHammerEvents(e){e.addEventListener("touchmove",(function(e){e.preventDefault()}),{passive:!1});let t=this,r=new Hammer(e);r.get("pan").set({enable:!0,direction:Hammer.DIRECTION_ALL}),r.on("tap",(e=>{"mouse"!==e.pointerType&&(this._printInputs&&logger.debug("单指点击操作！",e),t._lastPanPoint.x=0,t._lastPanPoint.y=0,t._lastOrbitPoint.x=0,t._lastOrbitPoint.y=0,t._lastScale=0,t._isTouch=!0)})),r.on("pan",(e=>{if("mouse"!==e.pointerType&&1===e.pointers.length){if(this._printInputs&&logger.debug("单指平移，场景平移（pan） ev：",e),e.isFirst)return t._lastPanPoint.x=e.center.x,t._lastPanPoint.y=e.center.y,void(t._printInputs&&logger.debug("pan start1",this._lastPanPoint));if(0==t._lastPanPoint.x&&0==t._lastPanPoint.y)return t._lastPanPoint.x=e.center.x,t._lastPanPoint.y=e.center.y,void(t._printInputs&&logger.debug("pan start2",this._lastPanPoint));if(e.isFinal)this._lastPanPoint.x=0,this._lastPanPoint.y=0,this._printInputs&&logger.debug("pan stop",this._lastPanPoint);else{var r={kx:t.playerElement.clientWidth/1920,ky:t.playerElement.clientHeight/1080};this._lastOrbitPoint.x=0,this._lastOrbitPoint.y=0,this._lastScale=0;const n={mouseAndPanelMove:!0,params:{Type:"pan",DeltaX:(e.center.x-t._lastPanPoint.x)*r.kx*MultiTouchState.PanSize,DeltaY:-(e.center.y-t._lastPanPoint.y)*r.ky*MultiTouchState.PanSize}};if(n.params.DeltaX>20||n.params.DeltaX<-20||n.params.DeltaY>20||n.params.DeltaY<-20)return void(t._printInputs&&logger.debug("pan 变换量过大 不处理",n));t._printInputs&&logger.debug("pan emit",n),t.emitUIInteraction(n),t._lastPanPoint.x=e.center.x,t._lastPanPoint.y=e.center.y}}})),r.on("hammer.input",(e=>{if("mouse"!==e.pointerType)if(2!==e.pointers.length){if(e.pointers.length>2){if(this._printInputs&&logger.debug("多指平移，场景旋转（orbit） ev：",e),e.isFirst)return t._lastOrbitPoint.x=e.center.x,t._lastOrbitPoint.y=e.center.y,void(t._printInputs&&logger.debug("orbit start",_lastOrbitPoint));if(0==t._lastOrbitPoint.x&&0==t._lastOrbitPoint.y)return t._lastOrbitPoint.x=e.center.x,t._lastOrbitPoint.y=e.center.y,void(t._printInputs&&logger.debug("orbit start2",this._lastOrbitPoint));if(e.isFinal)this._lastOrbitPoint.x=0,this._lastOrbitPoint.y=0,this._printInputs&&logger.debug("orbit stop",this._lastOrbitPoint);else{var r={kx:t.playerElement.clientWidth/1920,ky:t.playerElement.clientHeight/1080};this._lastPanPoint.x=0,this._lastPanPoint.y=0,this._lastScale=0;const n={mouseAndPanelMove:!0,params:{Type:"orbit",DeltaX:(e.center.x-t._lastOrbitPoint.x)*r.kx*MultiTouchState.OrbitSize,DeltaY:-(e.center.y-t._lastOrbitPoint.y)*r.ky*MultiTouchState.OrbitSize}};if(n.params.DeltaX>20||n.params.DeltaX<-20||n.params.DeltaY>20||n.params.DeltaY<-20)return void(t._printInputs&&logger.debug("orbit 变换量过大 不处理",n));t._printInputs&&logger.debug("orbit emit",n),t.emitUIInteraction(n),t._lastOrbitPoint.x=e.center.x,t._lastOrbitPoint.y=e.center.y}}}else{if(this._printInputs&&logger.debug("两指缩放，场景缩放（zoom） ev：",e),e.isFirst)return t._lastScale=1,void(t._printInputs&&logger.debug("zoom start",e));if(0===t._lastScale)return t._lastScale=1,void(t._printInputs&&logger.debug("zoom start 2",e));if(e.isFinal)this._printInputs&&logger.debug("zoom stop",e);else{t._lastPanPoint.x=0,t._lastPanPoint.y=0,t._lastOrbitPoint.x=0,t._lastOrbitPoint.y=0;const r={mouseAndPanelMove:!0,params:{Type:"pushPull",DeltaX:0,DeltaY:1===e.scale?0:e.scale*MultiTouchState.ZoomSize-1}};if(r.params.DeltaY>5||r.params.DeltaY<-5)return void(t._printInputs&&logger.debug("zoom 变换量过大 不处理",r));this._lastScale=e.scale,t.emitUIInteraction(r),t._printInputs&&logger.debug("zoom emit",r)}}}))}_runNormalizeAndQuantizeUnsigned(e,t){let r=this.playerElement.parentElement,n=this.playerElement,i=r.clientHeight/r.clientWidth,a=n.videoHeight/n.videoWidth;if(i>a){let n=i/a;return this._normalizeAndQuantizeUnsignedWithHPAR(r,n,e,t)}{let n=a/i;return this._normalizeAndQuantizeUnsignedWithLPAR(r,n,e,t)}}_runNormalizeAndQuantizeSigned(e,t){let r=this.playerElement.parentElement,n=this.playerElement,i=r.clientHeight/r.clientWidth,a=n.videoHeight/n.videoWidth;if(i>a){let n=i/a;return this._normalizeAndQuantizeSignedWithHPAR(r,n,e,t)}{let n=a/i;return this._normalizeAndQuantizeSignedWithLPAR(r,n,e,t)}}_normalizeAndQuantizeUnsignedWithHPAR(e,t,r,n){let i=r/e.clientWidth,a=t*(n/e.clientHeight-.5)+.5;return i<0||i>1||a<0||a>1?{inRange:!1,x:65535,y:65535}:{inRange:!0,x:65536*i,y:65536*a}}_normalizeAndQuantizeSignedWithHPAR(e,t,r,n){return{x:32767*(r/(.5*e.clientWidth)),y:32767*(t*n/(.5*e.clientHeight))}}_normalizeAndQuantizeUnsignedWithLPAR(e,t,r,n){let i=t*(r/e.clientWidth-.5)+.5,a=n/e.clientHeight;return i<0||i>1||a<0||a>1?{inRange:!1,x:65535,y:65535}:{inRange:!0,x:65536*i,y:65536*a}}_normalizeAndQuantizeSignedWithLPAR(e,t,r,n){return{x:32767*(t*r/(.5*e.clientWidth)),y:32767*(n/(.5*e.clientHeight))}}}let Util={isFunction:e=>"function"==typeof e,isString:e=>"string"==typeof e,isStringNotEmpty:e=>"string"==typeof e&&""!==e,guid:()=>{function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},randomString:e=>{e=e||32;for(var t="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",r=t.length,n="",i=0;i<e;i++)n+=t.charAt(Math.floor(Math.random()*r));return n},fetchJSON:(e,t,r,n)=>{switch(t.toLowerCase()){case"get":case"delete":case"head":case"post":case"put":break;default:t="GET"}return new Promise((function(i,a){let o=new XMLHttpRequest;if(o.onreadystatechange=function(){4==o.readyState&&(200==o.status||204==o.status||304==o.status?i(o.responseText):a(new Error(o.statusText)))},o.open(t,e,!0),r instanceof Array)for(let e of r)o.setRequestHeader(e.key,e.value);o.send(JSON.stringify(n))}))},Mercator2LonLat:e=>{var t={},r=e.x/20037508.3427892*180,n=e.y/20037508.3427892*180;return n=180/Math.PI*(2*Math.atan(Math.exp(n*Math.PI/180))-Math.PI/2),t.x=r,t.y=n,t}};Util.throttle=(e,t=300)=>{let r=0;return function(){(new Date).getTime()-r>t&&(e.call(this),r=(new Date).getTime())}};var eventMap={onServiceConnected:{},onSceneInit:{backtrack:["name","default"]},onSceneChanged:{backtrack:["name","default"]},onSceneLoaded:{backtrack:["name","default"]},onResolutionChange:{backtrack:["width","height"]},onBrowserMinimize:{},onBrowserClose:{},onStateChanged:{backtrack:["name","default"]},onStateTick:{},onCameraRoamingStart:{backtrack:["name","default"]},onCameraRoamingEnd:{},onCameraToMoveStart:{},onCameraToMoveEnd:{},onFocusChinaMapStart:{},onFocusChinaMapEnd:{},onFocustProvinceStart:{backtrack:["name"]},onFocustProvinceEnd:{backtrack:["name"]},onProvinceHover:{backtrack:["name"]},onProvinceUnhover:{backtrack:["name"]},onProvinceClick:{backtrack:["name"]},onRectOverlaySelectionResult:{backtrack:["type","data"]},onCircleOverlaySelectionResult:{backtrack:["type","data"]},onPolygonOverlaySelectionResult:{backtrack:["type","data"]},onClickOverlayResult:{backtrack:["type","id","ids","selected"]},onClickOverlayTypeResult:{backtrack:["type","selected","data"]},onFocusLandmarkStart:{backtrack:["id"]},onFocusLandmarkEnd:{backtrack:["id"]},onFocusAllLandmarkStart:{},onFocusAllLandmarkEnd:{},onLandmarkHover:{backtrack:["id"]},onLandmarkUnhover:{backtrack:["id"]},onLandmarkClick:{backtrack:["id","selected","label"]},onFocusPathStart:{backtrack:["id"]},onFocusPathEnd:{backtrack:["id"]},onFocusAllPathStart:{},onFocusAllPathEnd:{},onPathHover:{backtrack:["id","coord"]},onPathUnhover:{backtrack:["id"]},onPathClick:{backtrack:["id","selected","coord"]},onFocusAreaStart:{backtrack:["id"]},onFocusAreaEnd:{backtrack:["id"]},onFocusAllAreaStart:{},onFocusAllAreaEnd:{},onAreaHover:{backtrack:["id","coord"]},onAreaUnhover:{backtrack:["id"]},onAreaClick:{backtrack:["id","selected","coord"]},onFocusCircularAreaStart:{backtrack:["id"]},onFocusCircularAreaEnd:{backtrack:["id"]},onFocusAllCircularAreaStart:{},onFocusAllCircularAreaEnd:{},onCircularAreaHover:{backtrack:["id","coord"]},onCircularAreaUnhover:{backtrack:["id"]},onCircularAreaClick:{backtrack:["id","selected","coord"]},onFocus3DTileStart:{backtrack:["id"]},onFocus3DTileEnd:{backtrack:["id"]},onFocusAll3DTileStart:{},onFocusAll3DTileEnd:{},on3DTileHover:{backtrack:["id","coord"]},on3DTileUnhover:{backtrack:["id"]},on3DTileClick:{backtrack:["id","selected","coord"]},onFocusGISMapStart:{backtrack:["id"]},onFocusGISMapEnd:{backtrack:["id"]},onFocusAllGISMapStart:{},onFocusAllGISMapEnd:{},onGISMapHover:{backtrack:["id","coord"]},onGISMapUnhover:{backtrack:["id"]},onGISMapClick:{backtrack:["id","selected","coord"]},onFocusLandmarkLayerStart:{backtrack:["idLayer"]},onFocusLandmarkLayerEnd:{backtrack:["idLayer"]},onFocusAllLandmarkLayerStart:{},onFocusAllLandmarkLayerEnd:{},onFocusLandmarkLayerObjStart:{backtrack:["idObj","idLayer"]},onFocusLandmarkLayerObjEnd:{backtrack:["idObj","idLayer"]},onFocusLandmarkLayerLegendStart:{backtrack:["legend","idLayer"]},onFocusLandmarkLayerLegendEnd:{backtrack:["legend","idLayer"]},onLandmarkLayerHover:{backtrack:["idObj","idLayer"]},onLandmarkLayerUnhover:{backtrack:["idObj","idLayer"]},onLandmarkLayerClick:{backtrack:["idObj","idLayer","selected","type","label"]},onFocus3DColumnLayerStart:{backtrack:["idLayer"]},onFocus3DColumnLayerEnd:{backtrack:["idLayer"]},onFocusAll3DColumnLayerStart:{},onFocusAll3DColumnLayerEnd:{},on3DColumnLayerHover:{backtrack:["idObj","idLayer","coord"]},on3DColumnLayerUnhover:{backtrack:["idLayer","idLayer"]},on3DColumnLayerClick:{backtrack:["idObj","idLayer","selected","coord"]},onFocus3DGridLayerStart:{backtrack:["idLayer"]},onFocus3DGridLayerEnd:{backtrack:["idLayer"]},onFocusAll3DGridLayerStart:{},onFocusAll3DGridLayerEnd:{},on3DGridLayerHover:{backtrack:["idObj","idLayer","coord"]},on3DGridLayerUnhover:{backtrack:["idObj","idLayer"]},on3DGridLayerClick:{backtrack:["idObj","idLayer","selected","coord"]},onFocusHeatmapLayerStart:{backtrack:["idLayer"]},onFocusHeatmapLayerEnd:{backtrack:["idLayer"]},onFocusAllHeatmapLayerStart:{},onFocusAllHeatmapLayerEnd:{},onHeatmapLayerHover:{backtrack:["idLayer","coord"]},onHeatmapLayerUnhover:{backtrack:["idLayer"]},onHeatmapLayerClick:{backtrack:["idLayer","selected","coord"]},onFocusBubbleLayerStart:{backtrack:["idLayer"]},onFocusBubbleLayerEnd:{backtrack:["idLayer"]},onFocusAllBubbleLayerStart:{},onFocusAllBubbleLayerEnd:{},onFocusBubbleLayerObjStart:{backtrack:["idObj","idLayer"]},onFocusBubbleLayerObjEnd:{backtrack:["idObj","idLayer"]},onFocusBubbleLayerLegendStart:{backtrack:["idLayer","legend"]},onFocusBubbleLayerLegendEnd:{backtrack:["idLayer","legend"]},onBubbleLayerHover:{backtrack:["idObj","idLayer"]},onBubbleLayerUnhover:{backtrack:["idObj","idLayer"]},onBubbleLayerClick:{backtrack:["idObj","idLayer","selected","type"]},onFocusEventLayerStart:{backtrack:["idLayer"]},onFocusEventLayerEnd:{backtrack:["idLayer"]},onFocusAllEventLayerStart:{},onFocusAllEventLayerEnd:{},onFocusEventLayerObjStart:{backtrack:["idObj","idLayer"]},onFocusEventLayerObjEnd:{backtrack:["idObj","idLayer"]},onFocusEventLayerLegendStart:{backtrack:["idLayer","legend"]},onFocusEventLayerLegendEnd:{backtrack:["idLayer","legend"]},onEventLayerHover:{backtrack:["idObj","idLayer"]},onEventLayerUnhover:{backtrack:["idObj","idLayer"]},onEventLayerClick:{backtrack:["idObj","idLayer","selected"]},onFocusTrailLayerStart:{backtrack:["idLayer"]},onFocusTrailLayerEnd:{backtrack:["idLayer"]},onFocusAllTrailLayerStart:{},onFocusAllTrailLayerEnd:{},onFocusTrailLayerObjStart:{backtrack:["idObj","idLayer"]},onFocusTrailLayerObjEnd:{backtrack:["idObj","idLayer"]},onFocusTrailLayerLegendStart:{backtrack:["idLayer","legend"]},onFocusTrailLayerLegendEnd:{backtrack:["idLayer","legend"]},onTrailLayerHover:{backtrack:["idObj","idLayer"]},onTrailLayerUnhover:{backtrack:["idObj","idLayer"]},onTrailLayerClick:{backtrack:["idObj","idLayer","selected","type","label"]},onFocusTrackLayerStart:{backtrack:["idLayer"]},onFocusTrackLayerEnd:{backtrack:["idLayer"]},onFocusAllTrackLayerStart:{},onFocusAllTrackLayerEnd:{},onFocusTrackLayerObjStart:{backtrack:["idObj","idLayer"]},onFocusTrackLayerObjEnd:{backtrack:["idObj","idLayer"]},onFocusTrackLayerLegendStart:{backtrack:["idLayer","legend"]},onFocusTrackLayerLegendEnd:{backtrack:["idLayer","legend"]},onTrackLayerHover:{backtrack:["idObj","idLayer"]},onTrackLayerUnhover:{backtrack:["idObj","idLayer"]},onTrackLayerClick:{backtrack:["idObj","idLayer","selected"]},onFocusODLineLayerStart:{backtrack:["idLayer"]},onFocusODLineLayerEnd:{backtrack:["idLayer"]},onFocusAllODLineLayerStart:{},onFocusAllODLineLayerEnd:{},onFocusODLineLayerobjStart:{backtrack:["idObj","idLayer"]},onFocusODLineLayerObjEnd:{backtrack:["idObj","idLayer"]},onFocusODLineLayerLegendStart:{backtrack:["idLayer","legend"]},onFocusODLineLayerLegendEnd:{backtrack:["idLayer","legend"]},onODLineLayerHover:{backtrack:["idObj","idLayer"]},onODLineLayerUnhover:{backtrack:["idObj","idLayer"]},onODLineLayerClick:{backtrack:["idObj","idLayer","selected","type"]},onFocusTypeAreaLayerStart:{backtrack:["idLayer"]},onFocusTypeAreaLayerEnd:{backtrack:["idLayer"]},onFocusAllTypeAreaLayerStart:{},onFocusAllTypeAreaLayerEnd:{},onFocusTypeAreaStart:{backtrack:["nameArea","idLayer"]},onFocusTypeAreaEnd:{backtrack:["nameArea","idLayer"]},onFocusTypeAreaLayerLegendStart:{backtrack:["idLayer","legend"]},onFocusTypeAreaLayerLegendEnd:{backtrack:["idLayer","legend"]},onFocusLayerLegendStart:{backtrack:["idLayer","legend"]},onFocusLayerLegendEnd:{backtrack:["idLayer","legend"]},onTypeAreaLayerHover:{backtrack:["nameArea","idLayer","coord"]},onTypeAreaLayerUnhover:{backtrack:["nameArea","idLayer"]},onTypeAreaLayerClick:{backtrack:["nameArea","idLayer","selected","coord"]},onFocusColorAreaLayerStart:{backtrack:["idLayer"]},onFocusColorAreaLayerEnd:{backtrack:["idLayer"]},onFocusAllColorAreaLayerStart:{},onFocusAllColorAreaLayerEnd:{},onFocusColorAreaStart:{backtrack:["nameArea","idLayer"]},onFocusColorAreaEnd:{backtrack:["nameArea","idLayer"]},onColorAreaLayerHover:{backtrack:["nameArea","idLayer","coord"]},onColorAreaLayerUnhover:{backtrack:["nameArea","idLayer"]},onColorAreaLayerClick:{backtrack:["nameArea","idLayer","selected","coord"]},onFocusRoadPtHeatLayerStart:{backtrack:["idLayer"]},onFocusRoadPtHeatLayerEnd:{backtrack:["idLayer"]},onFocusAllRoadPtHeatLayerStart:{},onFocusAllRoadPtHeatLayerEnd:{},onRoadPtHeatLayerHover:{backtrack:["idLayer","coord"]},onRoadPtHeatLayerUnhover:{backtrack:["idLayer"]},onRoadPtHeatLayerClick:{backtrack:["idLayer","selected"]},onFocusRoadSgHeatLayerStart:{backtrack:["idLayer"]},onFocusRoadSgHeatLayerEnd:{backtrack:["idLayer"]},onFocusAllRoadSgHeatLayerStart:{},onFocusAllRoadSgHeatLayerEnd:{},onFocusRoadSgHeatStart:{backtrack:["nameSegment","idLayer"]},onFocusRoadSgHeatEnd:{backtrack:["nameSegment","idLayer"]},onRoadSgHeatLayerHover:{backtrack:["nameSegment","idLayer","coord"]},onRoadSgHeatLayerUnhover:{backtrack:["nameSegment","idLayer"]},onRoadSgHeatLayerClick:{backtrack:["nameSegment","idLayer","selected","coord"]},onFocusModelStart:{backtrack:["id"]},onFocusModelEnd:{backtrack:["id"]},onFocusAllModelStart:{},onFocusAllModelEnd:{},onModelHover:{backtrack:["id"]},onModelUnhover:{backtrack:["id"]},onModelClick:{backtrack:["id","selected","meta","userData"]},onRectModelSelectionResult:{backtrack:["type","data"]},onCircleModelSelectionResult:{backtrack:["type","data"]},onPolygonModelSelectionResult:{backtrack:["type","data"]},onClickModelResult:{backtrack:["type","id","selected"]},onClickModelTypeResult:{backtrack:["type","selected","data"]},onFocusBuildingStart:{backtrack:["id"]},onFocusBuildingEnd:{backtrack:["id"]},onFocusAllBuildingStart:{},onFocusAllBuildingEnd:{},onFocusFloorStart:{backtrack:["floor","idBuilding"]},onFocusFloorEnd:{backtrack:["id","idBuilding"]},onFocusRoomStart:{backtrack:["nameRoom","floor","idBuilding"]},onFocusRoomEnd:{backtrack:["nameRoom","floor","idBuilding"]},onBuildingHover:{backtrack:["id"]},onBuildingUnhover:{backtrack:["id"]},onBuildingClick:{backtrack:["id","selected"]},onFloorHover:{backtrack:["floor","idBuilding"]},onFloorUnhover:{backtrack:["floor","idBuilding"]},onFloorClick:{backtrack:["floor","idBuilding","selected"]},onRoomHover:{backtrack:["nameRoom","floor","idBuilding"]},onRoomUnhover:{backtrack:["nameRoom","floor","idBuilding"]},onRoomClick:{backtrack:["nameRoom","floor","idBuilding","selected"]},onFocus3DMarkerStart:{backtrack:["id"]},onFocus3DMarkerEnd:{backtrack:["id"]},onFocusAll3DMarkerStart:{},onFocusAll3DMarkerEnd:{},on3DMarkerHover:{backtrack:["id"]},on3DMarkerUnhover:{backtrack:["id"]},on3DMarkerClick:{backtrack:["id","selected"]},onAggLandmarkLayerClick:{backtrack:["idLayer","selected","data"]},onFocusAggLandmarkLayerStart:{backtrack:["idLayer"]},onFocusAggLandmarkLayerEnd:{backtrack:["idLayer"]},onFocusAggLandmarkLayerObjStart:{backtrack:["idObj","idLayer"]},onFocusAggLandmarkLayerObjEnd:{backtrack:["idObj","idLayer"]},onAggLandmarkLayerHover:{backtrack:["idObj","idLayer"]},onAggLandmarkLayerUnhover:{backtrack:["idObj","idLayer"]},onSceneClick:{backtrack:["data"]},onFocusModelLandmarkLayerStart:{backtrack:["idLayer"]},onFocusModelLandmarkLayerEnd:{backtrack:["idLayer"]},onFocusAllModelLandmarkLayerStart:{},onFocusAllModelLandmarkLayerEnd:{},onFocusModelLandmarkLayerObjStart:{backtrack:["idObj","idLayer"]},onFocusModelLandmarkLayerObjEnd:{backtrack:["idObj","idLayer"]},onModelLandmarkLayerHover:{backtrack:["idObj","idLayer"]},onModelLandmarkLayerUnhover:{backtrack:["idObj","idLayer"]},onFocusModelTrailLayerStart:{backtrack:["idLayer"]},onFocusModelTrailLayerEnd:{backtrack:["idLayer"]},onFocusAllModelTrailLayerStart:{},onFocusAllModelTrailLayerEnd:{},onFocusModelTrailLayerObjStart:{backtrack:["idObj","idLayer"]},onFocusModelTrailLayerObjEnd:{backtrack:["idObj","idLayer"]},onFocusModelTrailLayerLegendStart:{backtrack:["idLayer","legend"]},onFocusModelTrailLayerLegendEnd:{backtrack:["idLayer","legend"]},onUeSceneClick:{backtrack:["coord","coordZ"]},onModelTrailLayerClick:{backtrack:["idObj","idLayer","selected"]},onModelTrailLayerHover:{backtrack:["idObj","idLayer"]},onModelTrailLayerUnhover:{backtrack:["idObj","idLayer"]},onModelTrailLayerTempClick:{backtrack:["id","idLayer","selected"]},subscribeServerMessage:{},onAgg3DColumnLayerClick:{backtrack:["idLayer","selected","data"]},onAgg3DColumnLayerHover:{backtrack:["idObj","idLayer"]},onAgg3DColumnLayerUnhover:{backtrack:["idObj","idLayer"]},onFocusAgg3DColumnLayerStart:{backtrack:["idLayer"]},onFocusAgg3DColumnLayerEnd:{backtrack:["idLayer"]},onFocusAgg3DColumnLayerObjStart:{backtrack:["idObj","idLayer"]},onFocusAgg3DColumnLayerObjEnd:{backtrack:["idObj","idLayer"]},onModelLandmarkLayerClick:{backtrack:["idObj","idLayer","selected"]},onScaleAxisDrag:{},onRotationAxisDrag:{},onArticulationStart:{backtrack:["id"]},onArticulationEnd:{backtrack:["id"]},onAnimationStart:{backtrack:["id"]},onAnimationEnd:{backtrack:["id"]},onCameraMove:{backtrack:["coordType","coordTypeZ","centerCoord","coordZ","distance","pitch","heading"]},onTransformAxisDrag:{backtrack:["idObj","idLayer","overlayType","coordType","data"]},onTransformAxisDragStart:{backtrack:["idObj","idLayer","overlayType","coordType","data"]},onTransformAxisDragEnd:{backtrack:["idObj","idLayer","overlayType","coordType","data"]}};for(const e in eventMap)if(Object.hasOwnProperty.call(eventMap,e)){const t=eventMap[e];t.backtrack||(t.backtrack=[]),t.callback=null,t.function=(e,r)=>{t.callback=r}}function styleInject(e,t){void 0===t&&(t={});var r=t.insertAt;if(e&&"undefined"!=typeof document){var n=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css","top"===r&&n.firstChild?n.insertBefore(i,n.firstChild):n.appendChild(i),i.styleSheet?i.styleSheet.cssText=e:i.appendChild(document.createTextNode(e))}}var css_248z=".avw-loader {\r\n  box-sizing: border-box;\r\n  display: flex;\r\n  flex: 0 1 auto;\r\n  flex-direction: column;\r\n  flex-grow: 1;\r\n  flex-shrink: 0;\r\n  flex-basis: 25%;\r\n  align-items: center;\r\n  justify-content: center;\r\n}\r\n\r\n@-webkit-keyframes line-scale {\r\n  0% {\r\n    -webkit-transform: scaley(1);\r\n    transform: scaley(1);\r\n  }\r\n\r\n  50% {\r\n    -webkit-transform: scaley(0.4);\r\n    transform: scaley(0.4);\r\n  }\r\n\r\n  100% {\r\n    -webkit-transform: scaley(1);\r\n    transform: scaley(1);\r\n  }\r\n}\r\n@keyframes line-scale {\r\n  0% {\r\n    -webkit-transform: scaley(1);\r\n    transform: scaley(1);\r\n  }\r\n\r\n  50% {\r\n    -webkit-transform: scaley(0.4);\r\n    transform: scaley(0.4);\r\n  }\r\n\r\n  100% {\r\n    -webkit-transform: scaley(1);\r\n    transform: scaley(1);\r\n  }\r\n}\r\n\r\n.line-scale > div:nth-child(1) {\r\n  -webkit-animation: line-scale 1s 0.1s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n  animation: line-scale 1s 0.1s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n}\r\n.line-scale > div:nth-child(2) {\r\n  -webkit-animation: line-scale 1s 0.2s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n  animation: line-scale 1s 0.2s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n}\r\n.line-scale > div:nth-child(3) {\r\n  -webkit-animation: line-scale 1s 0.3s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n  animation: line-scale 1s 0.3s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n}\r\n.line-scale > div:nth-child(4) {\r\n  -webkit-animation: line-scale 1s 0.4s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n  animation: line-scale 1s 0.4s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n}\r\n.line-scale > div:nth-child(5) {\r\n  -webkit-animation: line-scale 1s 0.5s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n  animation: line-scale 1s 0.5s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n}\r\n.line-scale > div {\r\n  background-color: #fff;\r\n  width: 4px;\r\n  height: 35px;\r\n  border-radius: 2px;\r\n  margin: 2px;\r\n  -webkit-animation-fill-mode: both;\r\n  animation-fill-mode: both;\r\n  display: inline-block;\r\n}\r\n.line-scale > span {\r\n  color: #fff;\r\n  position: absolute;\r\n  top: calc(50% + 40px);\r\n  left: 50%;\r\n  transform: translate(-50%, -50%);\r\n}\r\n";styleInject(css_248z);class ProgressBar{constructor(e){this._progress=.01,this._dom=document.createElement("div"),this._dom.style.position="relative",this._dom.style.width="100%",this._dom.style.height="100%",this._dom.style.backgroundColor="#00000099",this._dom.className="avw-loader",this._loadingDom=document.createElement("div"),this._loadingDom.className="loader-inner line-scale",this._loadingDom.appendChild(document.createElement("div")),this._loadingDom.appendChild(document.createElement("div")),this._loadingDom.appendChild(document.createElement("div")),this._loadingDom.appendChild(document.createElement("div")),this._loadingDom.appendChild(document.createElement("div"));var t=document.createElement("span");t.innerText=e.text?e.text:"",this._loadingDom.appendChild(t),this._dom.appendChild(this._loadingDom),this._container=e.container||document.body,this._container.insertBefore(this._dom,this._container.firstChild)}get progress(){return this._progress}set progress(e){NaN!==(e=Number(e))&&(e>=1&&(e=1),e<.01&&(e=.01),this._progress=e)}destroy(){this._container.removeChild(this._dom)}hide(){}show(){}}var __extends$3=(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),extendStatics,HttpError=function(e){function t(t,r){var n=this,i=this.constructor.prototype;return(n=e.call(this,t)||this).statusCode=r,n.__proto__=i,n}return __extends$3(t,e),t}(Error),TimeoutError=function(e){function t(t){void 0===t&&(t="A timeout occurred.");var r=this,n=this.constructor.prototype;return(r=e.call(this,t)||this).__proto__=n,r}return __extends$3(t,e),t}(Error),AbortError=function(e){function t(t){void 0===t&&(t="An abort occurred.");var r=this,n=this.constructor.prototype;return(r=e.call(this,t)||this).__proto__=n,r}return __extends$3(t,e),t}(Error),__assign$7=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},HttpResponse=function(e,t,r){this.statusCode=e,this.statusText=t,this.content=r},HttpClient=function(){function e(){}return e.prototype.get=function(e,t){return this.send(__assign$7({},t,{method:"GET",url:e}))},e.prototype.post=function(e,t){return this.send(__assign$7({},t,{method:"POST",url:e}))},e.prototype.delete=function(e,t){return this.send(__assign$7({},t,{method:"DELETE",url:e}))},e.prototype.getCookieString=function(e){return""},e}(),LogLevel;!function(e){e[e.Trace=0]="Trace",e[e.Debug=1]="Debug",e[e.Information=2]="Information",e[e.Warning=3]="Warning",e[e.Error=4]="Error",e[e.Critical=5]="Critical",e[e.None=6]="None"}(LogLevel||(LogLevel={}));var NullLogger=function(){function e(){}return e.prototype.log=function(e,t){},e.instance=new e,e}(),__assign$6=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__awaiter$6=function(e,t,r,n){return new(r||(r=Promise))((function(i,a){function o(e){try{l(n.next(e))}catch(e){a(e)}}function s(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){e.done?i(e.value):new r((function(t){t(e.value)})).then(o,s)}l((n=n.apply(e,t||[])).next())}))},__generator$6=function(e,t){var r,n,i,a,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&a[0]?n.return:a[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,a[1])).done)return i;switch(n=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,n=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],n=0}finally{r=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},VERSION="5.0.5",Arg=function(){function e(){}return e.isRequired=function(e,t){if(null==e)throw new Error("The '"+t+"' argument is required.")},e.isNotEmpty=function(e,t){if(!e||e.match(/^\s*$/))throw new Error("The '"+t+"' argument should not be empty.")},e.isIn=function(e,t,r){if(!(e in t))throw new Error("Unknown "+r+" value: "+e+".")},e}(),Platform=function(){function e(){}return Object.defineProperty(e,"isBrowser",{get:function(){return"object"==typeof window},enumerable:!0,configurable:!0}),Object.defineProperty(e,"isWebWorker",{get:function(){return"object"==typeof self&&"importScripts"in self},enumerable:!0,configurable:!0}),Object.defineProperty(e,"isNode",{get:function(){return!this.isBrowser&&!this.isWebWorker},enumerable:!0,configurable:!0}),e}();function getDataDetail(e,t){var r="";return isArrayBuffer(e)?(r="Binary data of length "+e.byteLength,t&&(r+=". Content: '"+formatArrayBuffer(e)+"'")):"string"==typeof e&&(r="String data of length "+e.length,t&&(r+=". Content: '"+e+"'")),r}function formatArrayBuffer(e){var t=new Uint8Array(e),r="";return t.forEach((function(e){r+="0x"+(e<16?"0":"")+e.toString(16)+" "})),r.substr(0,r.length-1)}function isArrayBuffer(e){return e&&"undefined"!=typeof ArrayBuffer&&(e instanceof ArrayBuffer||e.constructor&&"ArrayBuffer"===e.constructor.name)}function sendMessage(e,t,r,n,i,a,o,s,l){return __awaiter$6(this,void 0,void 0,(function(){var c,h,u,d,p,f,m,g;return __generator$6(this,(function(y){switch(y.label){case 0:return h={},i?[4,i()]:[3,2];case 1:(u=y.sent())&&((c={}).Authorization="Bearer "+u,h=c),y.label=2;case 2:return d=getUserAgentHeader(),p=d[0],f=d[1],h[p]=f,e.log(LogLevel.Trace,"("+t+" transport) sending data. "+getDataDetail(a,o)+"."),m=isArrayBuffer(a)?"arraybuffer":"text",[4,r.post(n,{content:a,headers:__assign$6({},h,l),responseType:m,withCredentials:s})];case 3:return g=y.sent(),e.log(LogLevel.Trace,"("+t+" transport) request complete. Response status: "+g.statusCode+"."),[2]}}))}))}function createLogger(e){return void 0===e?new ConsoleLogger(LogLevel.Information):null===e?NullLogger.instance:e.log?e:new ConsoleLogger(e)}var SubjectSubscription=function(){function e(e,t){this.subject=e,this.observer=t}return e.prototype.dispose=function(){var e=this.subject.observers.indexOf(this.observer);e>-1&&this.subject.observers.splice(e,1),0===this.subject.observers.length&&this.subject.cancelCallback&&this.subject.cancelCallback().catch((function(e){}))},e}(),ConsoleLogger=function(){function e(e){this.minimumLogLevel=e,this.outputConsole=console}return e.prototype.log=function(e,t){if(e>=this.minimumLogLevel)switch(e){case LogLevel.Critical:case LogLevel.Error:this.outputConsole.error("["+(new Date).toISOString()+"] "+LogLevel[e]+": "+t);break;case LogLevel.Warning:this.outputConsole.warn("["+(new Date).toISOString()+"] "+LogLevel[e]+": "+t);break;case LogLevel.Information:this.outputConsole.info("["+(new Date).toISOString()+"] "+LogLevel[e]+": "+t);break;default:this.outputConsole.log("["+(new Date).toISOString()+"] "+LogLevel[e]+": "+t)}},e}();function getUserAgentHeader(){var e="X-SignalR-User-Agent";return Platform.isNode&&(e="User-Agent"),[e,constructUserAgent(VERSION,getOsName(),getRuntime(),getRuntimeVersion())]}function constructUserAgent(e,t,r,n){var i="Microsoft SignalR/",a=e.split(".");return i+=a[0]+"."+a[1],i+=" ("+e+"; ",i+=t&&""!==t?t+"; ":"Unknown OS; ",i+=""+r,i+=n?"; "+n:"; Unknown Runtime Version",i+=")"}function getOsName(){if(!Platform.isNode)return"";switch(process.platform){case"win32":return"Windows NT";case"darwin":return"macOS";case"linux":return"Linux";default:return process.platform}}function getRuntimeVersion(){if(Platform.isNode)return process.versions.node}function getRuntime(){return Platform.isNode?"NodeJS":"Browser"}var __extends$2=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),__assign$5=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__awaiter$5=function(e,t,r,n){return new(r||(r=Promise))((function(i,a){function o(e){try{l(n.next(e))}catch(e){a(e)}}function s(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){e.done?i(e.value):new r((function(t){t(e.value)})).then(o,s)}l((n=n.apply(e,t||[])).next())}))},__generator$5=function(e,t){var r,n,i,a,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&a[0]?n.return:a[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,a[1])).done)return i;switch(n=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,n=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],n=0}finally{r=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},FetchHttpClient=function(e){function t(t){var r=e.call(this)||this;if(r.logger=t,"undefined"==typeof fetch){var n="function"==typeof __webpack_require__?__non_webpack_require__:require;r.jar=new(n("tough-cookie").CookieJar),r.fetchType=n("node-fetch"),r.fetchType=n("fetch-cookie")(r.fetchType,r.jar),r.abortControllerType=n("abort-controller")}else r.fetchType=fetch.bind(self),r.abortControllerType=AbortController;return r}return __extends$2(t,e),t.prototype.send=function(e){return __awaiter$5(this,void 0,void 0,(function(){var t,r,n,i,a,o,s,l=this;return __generator$5(this,(function(c){switch(c.label){case 0:if(e.abortSignal&&e.abortSignal.aborted)throw new AbortError;if(!e.method)throw new Error("No method defined.");if(!e.url)throw new Error("No url defined.");t=new this.abortControllerType,e.abortSignal&&(e.abortSignal.onabort=function(){t.abort(),r=new AbortError}),n=null,e.timeout&&(i=e.timeout,n=setTimeout((function(){t.abort(),l.logger.log(LogLevel.Warning,"Timeout from HTTP request."),r=new TimeoutError}),i)),c.label=1;case 1:return c.trys.push([1,3,4,5]),[4,this.fetchType(e.url,{body:e.content,cache:"no-cache",credentials:!0===e.withCredentials?"include":"same-origin",headers:__assign$5({"Content-Type":"text/plain;charset=UTF-8","X-Requested-With":"XMLHttpRequest"},e.headers),method:e.method,mode:"cors",redirect:"manual",signal:t.signal})];case 2:return a=c.sent(),[3,5];case 3:if(o=c.sent(),r)throw r;throw this.logger.log(LogLevel.Warning,"Error from HTTP request. "+o+"."),o;case 4:return n&&clearTimeout(n),e.abortSignal&&(e.abortSignal.onabort=null),[7];case 5:if(!a.ok)throw new HttpError(a.statusText,a.status);return[4,deserializeContent(a,e.responseType)];case 6:return s=c.sent(),[2,new HttpResponse(a.status,a.statusText,s)]}}))}))},t.prototype.getCookieString=function(e){var t="";return Platform.isNode&&this.jar&&this.jar.getCookies(e,(function(e,r){return t=r.join("; ")})),t},t}(HttpClient);function deserializeContent(e,t){var r;switch(t){case"arraybuffer":r=e.arrayBuffer();break;case"text":r=e.text();break;case"blob":case"document":case"json":throw new Error(t+" is not supported.");default:r=e.text()}return r}var __extends$1=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),XhrHttpClient=function(e){function t(t){var r=e.call(this)||this;return r.logger=t,r}return __extends$1(t,e),t.prototype.send=function(e){var t=this;return e.abortSignal&&e.abortSignal.aborted?Promise.reject(new AbortError):e.method?e.url?new Promise((function(r,n){var i=new XMLHttpRequest;i.open(e.method,e.url,!0),i.withCredentials=void 0===e.withCredentials||e.withCredentials,i.setRequestHeader("X-Requested-With","XMLHttpRequest"),i.setRequestHeader("Content-Type","text/plain;charset=UTF-8");var a=e.headers;a&&Object.keys(a).forEach((function(e){i.setRequestHeader(e,a[e])})),e.responseType&&(i.responseType=e.responseType),e.abortSignal&&(e.abortSignal.onabort=function(){i.abort(),n(new AbortError)}),e.timeout&&(i.timeout=e.timeout),i.onload=function(){e.abortSignal&&(e.abortSignal.onabort=null),i.status>=200&&i.status<300?r(new HttpResponse(i.status,i.statusText,i.response||i.responseText)):n(new HttpError(i.statusText,i.status))},i.onerror=function(){t.logger.log(LogLevel.Warning,"Error from HTTP request. "+i.status+": "+i.statusText+"."),n(new HttpError(i.statusText,i.status))},i.ontimeout=function(){t.logger.log(LogLevel.Warning,"Timeout from HTTP request."),n(new TimeoutError)},i.send(e.content||"")})):Promise.reject(new Error("No url defined.")):Promise.reject(new Error("No method defined."))},t}(HttpClient),__extends=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),DefaultHttpClient=function(e){function t(t){var r=e.call(this)||this;if("undefined"!=typeof fetch||Platform.isNode)r.httpClient=new FetchHttpClient(t);else{if("undefined"==typeof XMLHttpRequest)throw new Error("No usable HttpClient found.");r.httpClient=new XhrHttpClient(t)}return r}return __extends(t,e),t.prototype.send=function(e){return e.abortSignal&&e.abortSignal.aborted?Promise.reject(new AbortError):e.method?e.url?this.httpClient.send(e):Promise.reject(new Error("No url defined.")):Promise.reject(new Error("No method defined."))},t.prototype.getCookieString=function(e){return this.httpClient.getCookieString(e)},t}(HttpClient),TextMessageFormat=function(){function e(){}return e.write=function(t){return""+t+e.RecordSeparator},e.parse=function(t){if(t[t.length-1]!==e.RecordSeparator)throw new Error("Message is incomplete.");var r=t.split(e.RecordSeparator);return r.pop(),r},e.RecordSeparatorCode=30,e.RecordSeparator=String.fromCharCode(e.RecordSeparatorCode),e}(),HandshakeProtocol=function(){function e(){}return e.prototype.writeHandshakeRequest=function(e){return TextMessageFormat.write(JSON.stringify(e))},e.prototype.parseHandshakeResponse=function(e){var t,r;if(isArrayBuffer(e)||"undefined"!=typeof Buffer&&e instanceof Buffer){var n=new Uint8Array(e);if(-1===(a=n.indexOf(TextMessageFormat.RecordSeparatorCode)))throw new Error("Message is incomplete.");var i=a+1;t=String.fromCharCode.apply(null,n.slice(0,i)),r=n.byteLength>i?n.slice(i).buffer:null}else{var a,o=e;if(-1===(a=o.indexOf(TextMessageFormat.RecordSeparator)))throw new Error("Message is incomplete.");i=a+1;t=o.substring(0,i),r=o.length>i?o.substring(i):null}var s=TextMessageFormat.parse(t),l=JSON.parse(s[0]);if(l.type)throw new Error("Expected a handshake response from the server.");return[r,l]},e}(),MessageType;!function(e){e[e.Invocation=1]="Invocation",e[e.StreamItem=2]="StreamItem",e[e.Completion=3]="Completion",e[e.StreamInvocation=4]="StreamInvocation",e[e.CancelInvocation=5]="CancelInvocation",e[e.Ping=6]="Ping",e[e.Close=7]="Close"}(MessageType||(MessageType={}));var Subject=function(){function e(){this.observers=[]}return e.prototype.next=function(e){for(var t=0,r=this.observers;t<r.length;t++){r[t].next(e)}},e.prototype.error=function(e){for(var t=0,r=this.observers;t<r.length;t++){var n=r[t];n.error&&n.error(e)}},e.prototype.complete=function(){for(var e=0,t=this.observers;e<t.length;e++){var r=t[e];r.complete&&r.complete()}},e.prototype.subscribe=function(e){return this.observers.push(e),new SubjectSubscription(this,e)},e}(),__awaiter$4=function(e,t,r,n){return new(r||(r=Promise))((function(i,a){function o(e){try{l(n.next(e))}catch(e){a(e)}}function s(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){e.done?i(e.value):new r((function(t){t(e.value)})).then(o,s)}l((n=n.apply(e,t||[])).next())}))},__generator$4=function(e,t){var r,n,i,a,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&a[0]?n.return:a[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,a[1])).done)return i;switch(n=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,n=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],n=0}finally{r=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},DEFAULT_TIMEOUT_IN_MS=3e4,DEFAULT_PING_INTERVAL_IN_MS=15e3,HubConnectionState;!function(e){e.Disconnected="Disconnected",e.Connecting="Connecting",e.Connected="Connected",e.Disconnecting="Disconnecting",e.Reconnecting="Reconnecting"}(HubConnectionState||(HubConnectionState={}));var HubConnection=function(){function e(e,t,r,n){var i=this;Arg.isRequired(e,"connection"),Arg.isRequired(t,"logger"),Arg.isRequired(r,"protocol"),this.serverTimeoutInMilliseconds=DEFAULT_TIMEOUT_IN_MS,this.keepAliveIntervalInMilliseconds=DEFAULT_PING_INTERVAL_IN_MS,this.logger=t,this.protocol=r,this.connection=e,this.reconnectPolicy=n,this.handshakeProtocol=new HandshakeProtocol,this.connection.onreceive=function(e){return i.processIncomingData(e)},this.connection.onclose=function(e){return i.connectionClosed(e)},this.callbacks={},this.methods={},this.closedCallbacks=[],this.reconnectingCallbacks=[],this.reconnectedCallbacks=[],this.invocationId=0,this.receivedHandshakeResponse=!1,this.connectionState=HubConnectionState.Disconnected,this.connectionStarted=!1,this.cachedPingMessage=this.protocol.writeMessage({type:MessageType.Ping})}return e.create=function(t,r,n,i){return new e(t,r,n,i)},Object.defineProperty(e.prototype,"state",{get:function(){return this.connectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"connectionId",{get:function(){return this.connection&&this.connection.connectionId||null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"baseUrl",{get:function(){return this.connection.baseUrl||""},set:function(e){if(this.connectionState!==HubConnectionState.Disconnected&&this.connectionState!==HubConnectionState.Reconnecting)throw new Error("The HubConnection must be in the Disconnected or Reconnecting state to change the url.");if(!e)throw new Error("The HubConnection url must be a valid url.");this.connection.baseUrl=e},enumerable:!0,configurable:!0}),e.prototype.start=function(){return this.startPromise=this.startWithStateTransitions(),this.startPromise},e.prototype.startWithStateTransitions=function(){return __awaiter$4(this,void 0,void 0,(function(){var e;return __generator$4(this,(function(t){switch(t.label){case 0:if(this.connectionState!==HubConnectionState.Disconnected)return[2,Promise.reject(new Error("Cannot start a HubConnection that is not in the 'Disconnected' state."))];this.connectionState=HubConnectionState.Connecting,this.logger.log(LogLevel.Debug,"Starting HubConnection."),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.startInternal()];case 2:return t.sent(),this.connectionState=HubConnectionState.Connected,this.connectionStarted=!0,this.logger.log(LogLevel.Debug,"HubConnection connected successfully."),[3,4];case 3:return e=t.sent(),this.connectionState=HubConnectionState.Disconnected,this.logger.log(LogLevel.Debug,"HubConnection failed to start successfully because of error '"+e+"'."),[2,Promise.reject(e)];case 4:return[2]}}))}))},e.prototype.startInternal=function(){return __awaiter$4(this,void 0,void 0,(function(){var e,t,r,n=this;return __generator$4(this,(function(i){switch(i.label){case 0:return this.stopDuringStartError=void 0,this.receivedHandshakeResponse=!1,e=new Promise((function(e,t){n.handshakeResolver=e,n.handshakeRejecter=t})),[4,this.connection.start(this.protocol.transferFormat)];case 1:i.sent(),i.label=2;case 2:return i.trys.push([2,5,,7]),t={protocol:this.protocol.name,version:this.protocol.version},this.logger.log(LogLevel.Debug,"Sending handshake request."),[4,this.sendMessage(this.handshakeProtocol.writeHandshakeRequest(t))];case 3:return i.sent(),this.logger.log(LogLevel.Information,"Using HubProtocol '"+this.protocol.name+"'."),this.cleanupTimeout(),this.resetTimeoutPeriod(),this.resetKeepAliveInterval(),[4,e];case 4:if(i.sent(),this.stopDuringStartError)throw this.stopDuringStartError;return[3,7];case 5:return r=i.sent(),this.logger.log(LogLevel.Debug,"Hub handshake failed with error '"+r+"' during start(). Stopping HubConnection."),this.cleanupTimeout(),this.cleanupPingTimer(),[4,this.connection.stop(r)];case 6:throw i.sent(),r;case 7:return[2]}}))}))},e.prototype.stop=function(){return __awaiter$4(this,void 0,void 0,(function(){var e;return __generator$4(this,(function(t){switch(t.label){case 0:return e=this.startPromise,this.stopPromise=this.stopInternal(),[4,this.stopPromise];case 1:t.sent(),t.label=2;case 2:return t.trys.push([2,4,,5]),[4,e];case 3:case 4:return t.sent(),[3,5];case 5:return[2]}}))}))},e.prototype.stopInternal=function(e){return this.connectionState===HubConnectionState.Disconnected?(this.logger.log(LogLevel.Debug,"Call to HubConnection.stop("+e+") ignored because it is already in the disconnected state."),Promise.resolve()):this.connectionState===HubConnectionState.Disconnecting?(this.logger.log(LogLevel.Debug,"Call to HttpConnection.stop("+e+") ignored because the connection is already in the disconnecting state."),this.stopPromise):(this.connectionState=HubConnectionState.Disconnecting,this.logger.log(LogLevel.Debug,"Stopping HubConnection."),this.reconnectDelayHandle?(this.logger.log(LogLevel.Debug,"Connection stopped during reconnect delay. Done reconnecting."),clearTimeout(this.reconnectDelayHandle),this.reconnectDelayHandle=void 0,this.completeClose(),Promise.resolve()):(this.cleanupTimeout(),this.cleanupPingTimer(),this.stopDuringStartError=e||new Error("The connection was stopped before the hub handshake could complete."),this.connection.stop(e)))},e.prototype.stream=function(e){for(var t=this,r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];var i,a=this.replaceStreamingParams(r),o=a[0],s=a[1],l=this.createStreamInvocation(e,r,s),c=new Subject;return c.cancelCallback=function(){var e=t.createCancelInvocation(l.invocationId);return delete t.callbacks[l.invocationId],i.then((function(){return t.sendWithProtocol(e)}))},this.callbacks[l.invocationId]=function(e,t){t?c.error(t):e&&(e.type===MessageType.Completion?e.error?c.error(new Error(e.error)):c.complete():c.next(e.item))},i=this.sendWithProtocol(l).catch((function(e){c.error(e),delete t.callbacks[l.invocationId]})),this.launchStreams(o,i),c},e.prototype.sendMessage=function(e){return this.resetKeepAliveInterval(),this.connection.send(e)},e.prototype.sendWithProtocol=function(e){return this.sendMessage(this.protocol.writeMessage(e))},e.prototype.send=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var n=this.replaceStreamingParams(t),i=n[0],a=n[1],o=this.sendWithProtocol(this.createInvocation(e,t,!0,a));return this.launchStreams(i,o),o},e.prototype.invoke=function(e){for(var t=this,r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];var i=this.replaceStreamingParams(r),a=i[0],o=i[1],s=this.createInvocation(e,r,!1,o),l=new Promise((function(e,r){t.callbacks[s.invocationId]=function(t,n){n?r(n):t&&(t.type===MessageType.Completion?t.error?r(new Error(t.error)):e(t.result):r(new Error("Unexpected message type: "+t.type)))};var n=t.sendWithProtocol(s).catch((function(e){r(e),delete t.callbacks[s.invocationId]}));t.launchStreams(a,n)}));return l},e.prototype.on=function(e,t){e&&t&&(e=e.toLowerCase(),this.methods[e]||(this.methods[e]=[]),-1===this.methods[e].indexOf(t)&&this.methods[e].push(t))},e.prototype.off=function(e,t){if(e){e=e.toLowerCase();var r=this.methods[e];if(r)if(t){var n=r.indexOf(t);-1!==n&&(r.splice(n,1),0===r.length&&delete this.methods[e])}else delete this.methods[e]}},e.prototype.onclose=function(e){e&&this.closedCallbacks.push(e)},e.prototype.onreconnecting=function(e){e&&this.reconnectingCallbacks.push(e)},e.prototype.onreconnected=function(e){e&&this.reconnectedCallbacks.push(e)},e.prototype.processIncomingData=function(e){if(this.cleanupTimeout(),this.receivedHandshakeResponse||(e=this.processHandshakeResponse(e),this.receivedHandshakeResponse=!0),e)for(var t=0,r=this.protocol.parseMessages(e,this.logger);t<r.length;t++){var n=r[t];switch(n.type){case MessageType.Invocation:this.invokeClientMethod(n);break;case MessageType.StreamItem:case MessageType.Completion:var i=this.callbacks[n.invocationId];i&&(n.type===MessageType.Completion&&delete this.callbacks[n.invocationId],i(n));break;case MessageType.Ping:break;case MessageType.Close:this.logger.log(LogLevel.Information,"Close message received from server.");var a=n.error?new Error("Server returned an error on close: "+n.error):void 0;!0===n.allowReconnect?this.connection.stop(a):this.stopPromise=this.stopInternal(a);break;default:this.logger.log(LogLevel.Warning,"Invalid message type: "+n.type+".")}}this.resetTimeoutPeriod()},e.prototype.processHandshakeResponse=function(e){var t,r,n;try{n=(t=this.handshakeProtocol.parseHandshakeResponse(e))[0],r=t[1]}catch(e){var i="Error parsing handshake response: "+e;this.logger.log(LogLevel.Error,i);var a=new Error(i);throw this.handshakeRejecter(a),a}if(r.error){i="Server returned handshake error: "+r.error;this.logger.log(LogLevel.Error,i);a=new Error(i);throw this.handshakeRejecter(a),a}return this.logger.log(LogLevel.Debug,"Server handshake complete."),this.handshakeResolver(),n},e.prototype.resetKeepAliveInterval=function(){var e=this;this.connection.features.inherentKeepAlive||(this.cleanupPingTimer(),this.pingServerHandle=setTimeout((function(){return __awaiter$4(e,void 0,void 0,(function(){return __generator$4(this,(function(e){switch(e.label){case 0:if(this.connectionState!==HubConnectionState.Connected)return[3,4];e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.sendMessage(this.cachedPingMessage)];case 2:return e.sent(),[3,4];case 3:return e.sent(),this.cleanupPingTimer(),[3,4];case 4:return[2]}}))}))}),this.keepAliveIntervalInMilliseconds))},e.prototype.resetTimeoutPeriod=function(){var e=this;this.connection.features&&this.connection.features.inherentKeepAlive||(this.timeoutHandle=setTimeout((function(){return e.serverTimeout()}),this.serverTimeoutInMilliseconds))},e.prototype.serverTimeout=function(){this.connection.stop(new Error("Server timeout elapsed without receiving a message from the server."))},e.prototype.invokeClientMethod=function(e){var t=this,r=this.methods[e.target.toLowerCase()];if(r){try{r.forEach((function(r){return r.apply(t,e.arguments)}))}catch(t){this.logger.log(LogLevel.Error,"A callback for the method "+e.target.toLowerCase()+" threw error '"+t+"'.")}if(e.invocationId){var n="Server requested a response, which is not supported in this version of the client.";this.logger.log(LogLevel.Error,n),this.stopPromise=this.stopInternal(new Error(n))}}else this.logger.log(LogLevel.Warning,"No client method with the name '"+e.target+"' found.")},e.prototype.connectionClosed=function(e){this.logger.log(LogLevel.Debug,"HubConnection.connectionClosed("+e+") called while in state "+this.connectionState+"."),this.stopDuringStartError=this.stopDuringStartError||e||new Error("The underlying connection was closed before the hub handshake could complete."),this.handshakeResolver&&this.handshakeResolver(),this.cancelCallbacksWithError(e||new Error("Invocation canceled due to the underlying connection being closed.")),this.cleanupTimeout(),this.cleanupPingTimer(),this.connectionState===HubConnectionState.Disconnecting?this.completeClose(e):this.connectionState===HubConnectionState.Connected&&this.reconnectPolicy?this.reconnect(e):this.connectionState===HubConnectionState.Connected&&this.completeClose(e)},e.prototype.completeClose=function(e){var t=this;if(this.connectionStarted){this.connectionState=HubConnectionState.Disconnected,this.connectionStarted=!1;try{this.closedCallbacks.forEach((function(r){return r.apply(t,[e])}))}catch(t){this.logger.log(LogLevel.Error,"An onclose callback called with error '"+e+"' threw error '"+t+"'.")}}},e.prototype.reconnect=function(e){return __awaiter$4(this,void 0,void 0,(function(){var t,r,n,i,a,o=this;return __generator$4(this,(function(s){switch(s.label){case 0:if(t=Date.now(),r=0,n=void 0!==e?e:new Error("Attempting to reconnect due to a unknown error."),null===(i=this.getNextRetryDelay(r++,0,n)))return this.logger.log(LogLevel.Debug,"Connection not reconnecting because the IRetryPolicy returned null on the first reconnect attempt."),this.completeClose(e),[2];if(this.connectionState=HubConnectionState.Reconnecting,e?this.logger.log(LogLevel.Information,"Connection reconnecting because of error '"+e+"'."):this.logger.log(LogLevel.Information,"Connection reconnecting."),this.onreconnecting){try{this.reconnectingCallbacks.forEach((function(t){return t.apply(o,[e])}))}catch(t){this.logger.log(LogLevel.Error,"An onreconnecting callback called with error '"+e+"' threw error '"+t+"'.")}if(this.connectionState!==HubConnectionState.Reconnecting)return this.logger.log(LogLevel.Debug,"Connection left the reconnecting state in onreconnecting callback. Done reconnecting."),[2]}s.label=1;case 1:return null===i?[3,7]:(this.logger.log(LogLevel.Information,"Reconnect attempt number "+r+" will start in "+i+" ms."),[4,new Promise((function(e){o.reconnectDelayHandle=setTimeout(e,i)}))]);case 2:if(s.sent(),this.reconnectDelayHandle=void 0,this.connectionState!==HubConnectionState.Reconnecting)return this.logger.log(LogLevel.Debug,"Connection left the reconnecting state during reconnect delay. Done reconnecting."),[2];s.label=3;case 3:return s.trys.push([3,5,,6]),[4,this.startInternal()];case 4:if(s.sent(),this.connectionState=HubConnectionState.Connected,this.logger.log(LogLevel.Information,"HubConnection reconnected successfully."),this.onreconnected)try{this.reconnectedCallbacks.forEach((function(e){return e.apply(o,[o.connection.connectionId])}))}catch(e){this.logger.log(LogLevel.Error,"An onreconnected callback called with connectionId '"+this.connection.connectionId+"; threw error '"+e+"'.")}return[2];case 5:return a=s.sent(),this.logger.log(LogLevel.Information,"Reconnect attempt failed because of error '"+a+"'."),this.connectionState!==HubConnectionState.Reconnecting?(this.logger.log(LogLevel.Debug,"Connection left the reconnecting state during reconnect attempt. Done reconnecting."),[2]):(n=a instanceof Error?a:new Error(a.toString()),i=this.getNextRetryDelay(r++,Date.now()-t,n),[3,6]);case 6:return[3,1];case 7:return this.logger.log(LogLevel.Information,"Reconnect retries have been exhausted after "+(Date.now()-t)+" ms and "+r+" failed attempts. Connection disconnecting."),this.completeClose(),[2]}}))}))},e.prototype.getNextRetryDelay=function(e,t,r){try{return this.reconnectPolicy.nextRetryDelayInMilliseconds({elapsedMilliseconds:t,previousRetryCount:e,retryReason:r})}catch(r){return this.logger.log(LogLevel.Error,"IRetryPolicy.nextRetryDelayInMilliseconds("+e+", "+t+") threw error '"+r+"'."),null}},e.prototype.cancelCallbacksWithError=function(e){var t=this.callbacks;this.callbacks={},Object.keys(t).forEach((function(r){(0,t[r])(null,e)}))},e.prototype.cleanupPingTimer=function(){this.pingServerHandle&&clearTimeout(this.pingServerHandle)},e.prototype.cleanupTimeout=function(){this.timeoutHandle&&clearTimeout(this.timeoutHandle)},e.prototype.createInvocation=function(e,t,r,n){if(r)return 0!==n.length?{arguments:t,streamIds:n,target:e,type:MessageType.Invocation}:{arguments:t,target:e,type:MessageType.Invocation};var i=this.invocationId;return this.invocationId++,0!==n.length?{arguments:t,invocationId:i.toString(),streamIds:n,target:e,type:MessageType.Invocation}:{arguments:t,invocationId:i.toString(),target:e,type:MessageType.Invocation}},e.prototype.launchStreams=function(e,t){var r=this;if(0!==e.length){t||(t=Promise.resolve());var n=function(n){e[n].subscribe({complete:function(){t=t.then((function(){return r.sendWithProtocol(r.createCompletionMessage(n))}))},error:function(e){var i;i=e instanceof Error?e.message:e&&e.toString?e.toString():"Unknown error",t=t.then((function(){return r.sendWithProtocol(r.createCompletionMessage(n,i))}))},next:function(e){t=t.then((function(){return r.sendWithProtocol(r.createStreamItemMessage(n,e))}))}})};for(var i in e)n(i)}},e.prototype.replaceStreamingParams=function(e){for(var t=[],r=[],n=0;n<e.length;n++){var i=e[n];if(this.isObservable(i)){var a=this.invocationId;this.invocationId++,t[a]=i,r.push(a.toString()),e.splice(n,1)}}return[t,r]},e.prototype.isObservable=function(e){return e&&e.subscribe&&"function"==typeof e.subscribe},e.prototype.createStreamInvocation=function(e,t,r){var n=this.invocationId;return this.invocationId++,0!==r.length?{arguments:t,invocationId:n.toString(),streamIds:r,target:e,type:MessageType.StreamInvocation}:{arguments:t,invocationId:n.toString(),target:e,type:MessageType.StreamInvocation}},e.prototype.createCancelInvocation=function(e){return{invocationId:e,type:MessageType.CancelInvocation}},e.prototype.createStreamItemMessage=function(e,t){return{invocationId:e,item:t,type:MessageType.StreamItem}},e.prototype.createCompletionMessage=function(e,t,r){return t?{error:t,invocationId:e,type:MessageType.Completion}:{invocationId:e,result:r,type:MessageType.Completion}},e}(),DEFAULT_RETRY_DELAYS_IN_MILLISECONDS=[0,2e3,1e4,3e4,null],DefaultReconnectPolicy=function(){function e(e){this.retryDelays=void 0!==e?e.concat([null]):DEFAULT_RETRY_DELAYS_IN_MILLISECONDS}return e.prototype.nextRetryDelayInMilliseconds=function(e){return this.retryDelays[e.previousRetryCount]},e}(),HttpTransportType,TransferFormat;!function(e){e[e.None=0]="None",e[e.WebSockets=1]="WebSockets",e[e.ServerSentEvents=2]="ServerSentEvents",e[e.LongPolling=4]="LongPolling"}(HttpTransportType||(HttpTransportType={})),function(e){e[e.Text=1]="Text",e[e.Binary=2]="Binary"}(TransferFormat||(TransferFormat={}));var AbortController$1=function(){function e(){this.isAborted=!1,this.onabort=null}return e.prototype.abort=function(){this.isAborted||(this.isAborted=!0,this.onabort&&this.onabort())},Object.defineProperty(e.prototype,"signal",{get:function(){return this},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"aborted",{get:function(){return this.isAborted},enumerable:!0,configurable:!0}),e}(),__assign$4=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__awaiter$3=function(e,t,r,n){return new(r||(r=Promise))((function(i,a){function o(e){try{l(n.next(e))}catch(e){a(e)}}function s(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){e.done?i(e.value):new r((function(t){t(e.value)})).then(o,s)}l((n=n.apply(e,t||[])).next())}))},__generator$3=function(e,t){var r,n,i,a,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&a[0]?n.return:a[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,a[1])).done)return i;switch(n=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,n=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],n=0}finally{r=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},LongPollingTransport=function(){function e(e,t,r,n,i,a){this.httpClient=e,this.accessTokenFactory=t,this.logger=r,this.pollAbort=new AbortController$1,this.logMessageContent=n,this.withCredentials=i,this.headers=a,this.running=!1,this.onreceive=null,this.onclose=null}return Object.defineProperty(e.prototype,"pollAborted",{get:function(){return this.pollAbort.aborted},enumerable:!0,configurable:!0}),e.prototype.connect=function(e,t){return __awaiter$3(this,void 0,void 0,(function(){var r,n,i,a,o,s,l,c,h;return __generator$3(this,(function(u){switch(u.label){case 0:if(Arg.isRequired(e,"url"),Arg.isRequired(t,"transferFormat"),Arg.isIn(t,TransferFormat,"transferFormat"),this.url=e,this.logger.log(LogLevel.Trace,"(LongPolling transport) Connecting."),t===TransferFormat.Binary&&"undefined"!=typeof XMLHttpRequest&&"string"!=typeof(new XMLHttpRequest).responseType)throw new Error("Binary protocols over XmlHttpRequest not implementing advanced features are not supported.");return n=getUserAgentHeader(),i=n[0],a=n[1],o=__assign$4(((r={})[i]=a,r),this.headers),s={abortSignal:this.pollAbort.signal,headers:o,timeout:1e5,withCredentials:this.withCredentials},t===TransferFormat.Binary&&(s.responseType="arraybuffer"),[4,this.getAccessToken()];case 1:return l=u.sent(),this.updateHeaderToken(s,l),c=e+"&_="+Date.now(),this.logger.log(LogLevel.Trace,"(LongPolling transport) polling: "+c+"."),[4,this.httpClient.get(c,s)];case 2:return 200!==(h=u.sent()).statusCode?(this.logger.log(LogLevel.Error,"(LongPolling transport) Unexpected response code: "+h.statusCode+"."),this.closeError=new HttpError(h.statusText||"",h.statusCode),this.running=!1):this.running=!0,this.receiving=this.poll(this.url,s),[2]}}))}))},e.prototype.getAccessToken=function(){return __awaiter$3(this,void 0,void 0,(function(){return __generator$3(this,(function(e){switch(e.label){case 0:return this.accessTokenFactory?[4,this.accessTokenFactory()]:[3,2];case 1:return[2,e.sent()];case 2:return[2,null]}}))}))},e.prototype.updateHeaderToken=function(e,t){e.headers||(e.headers={}),t?e.headers.Authorization="Bearer "+t:e.headers.Authorization&&delete e.headers.Authorization},e.prototype.poll=function(e,t){return __awaiter$3(this,void 0,void 0,(function(){var r,n,i,a;return __generator$3(this,(function(o){switch(o.label){case 0:o.trys.push([0,,8,9]),o.label=1;case 1:return this.running?[4,this.getAccessToken()]:[3,7];case 2:r=o.sent(),this.updateHeaderToken(t,r),o.label=3;case 3:return o.trys.push([3,5,,6]),n=e+"&_="+Date.now(),this.logger.log(LogLevel.Trace,"(LongPolling transport) polling: "+n+"."),[4,this.httpClient.get(n,t)];case 4:return 204===(i=o.sent()).statusCode?(this.logger.log(LogLevel.Information,"(LongPolling transport) Poll terminated by server."),this.running=!1):200!==i.statusCode?(this.logger.log(LogLevel.Error,"(LongPolling transport) Unexpected response code: "+i.statusCode+"."),this.closeError=new HttpError(i.statusText||"",i.statusCode),this.running=!1):i.content?(this.logger.log(LogLevel.Trace,"(LongPolling transport) data received. "+getDataDetail(i.content,this.logMessageContent)+"."),this.onreceive&&this.onreceive(i.content)):this.logger.log(LogLevel.Trace,"(LongPolling transport) Poll timed out, reissuing."),[3,6];case 5:return a=o.sent(),this.running?a instanceof TimeoutError?this.logger.log(LogLevel.Trace,"(LongPolling transport) Poll timed out, reissuing."):(this.closeError=a,this.running=!1):this.logger.log(LogLevel.Trace,"(LongPolling transport) Poll errored after shutdown: "+a.message),[3,6];case 6:return[3,1];case 7:return[3,9];case 8:return this.logger.log(LogLevel.Trace,"(LongPolling transport) Polling complete."),this.pollAborted||this.raiseOnClose(),[7];case 9:return[2]}}))}))},e.prototype.send=function(e){return __awaiter$3(this,void 0,void 0,(function(){return __generator$3(this,(function(t){return this.running?[2,sendMessage(this.logger,"LongPolling",this.httpClient,this.url,this.accessTokenFactory,e,this.logMessageContent,this.withCredentials,this.headers)]:[2,Promise.reject(new Error("Cannot send until the transport is connected"))]}))}))},e.prototype.stop=function(){return __awaiter$3(this,void 0,void 0,(function(){var e,t,r,n,i,a;return __generator$3(this,(function(o){switch(o.label){case 0:this.logger.log(LogLevel.Trace,"(LongPolling transport) Stopping polling."),this.running=!1,this.pollAbort.abort(),o.label=1;case 1:return o.trys.push([1,,5,6]),[4,this.receiving];case 2:return o.sent(),this.logger.log(LogLevel.Trace,"(LongPolling transport) sending DELETE request to "+this.url+"."),e={},t=getUserAgentHeader(),r=t[0],n=t[1],e[r]=n,i={headers:__assign$4({},e,this.headers),withCredentials:this.withCredentials},[4,this.getAccessToken()];case 3:return a=o.sent(),this.updateHeaderToken(i,a),[4,this.httpClient.delete(this.url,i)];case 4:return o.sent(),this.logger.log(LogLevel.Trace,"(LongPolling transport) DELETE request sent."),[3,6];case 5:return this.logger.log(LogLevel.Trace,"(LongPolling transport) Stop finished."),this.raiseOnClose(),[7];case 6:return[2]}}))}))},e.prototype.raiseOnClose=function(){if(this.onclose){var e="(LongPolling transport) Firing onclose event.";this.closeError&&(e+=" Error: "+this.closeError),this.logger.log(LogLevel.Trace,e),this.onclose(this.closeError)}},e}(),__assign$3=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__awaiter$2=function(e,t,r,n){return new(r||(r=Promise))((function(i,a){function o(e){try{l(n.next(e))}catch(e){a(e)}}function s(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){e.done?i(e.value):new r((function(t){t(e.value)})).then(o,s)}l((n=n.apply(e,t||[])).next())}))},__generator$2=function(e,t){var r,n,i,a,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&a[0]?n.return:a[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,a[1])).done)return i;switch(n=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,n=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],n=0}finally{r=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},ServerSentEventsTransport=function(){function e(e,t,r,n,i,a,o){this.httpClient=e,this.accessTokenFactory=t,this.logger=r,this.logMessageContent=n,this.withCredentials=a,this.eventSourceConstructor=i,this.headers=o,this.onreceive=null,this.onclose=null}return e.prototype.connect=function(e,t){return __awaiter$2(this,void 0,void 0,(function(){var r,n=this;return __generator$2(this,(function(i){switch(i.label){case 0:return Arg.isRequired(e,"url"),Arg.isRequired(t,"transferFormat"),Arg.isIn(t,TransferFormat,"transferFormat"),this.logger.log(LogLevel.Trace,"(SSE transport) Connecting."),this.url=e,this.accessTokenFactory?[4,this.accessTokenFactory()]:[3,2];case 1:(r=i.sent())&&(e+=(e.indexOf("?")<0?"?":"&")+"access_token="+encodeURIComponent(r)),i.label=2;case 2:return[2,new Promise((function(r,i){var a=!1;if(t===TransferFormat.Text){var o;if(Platform.isBrowser||Platform.isWebWorker)o=new n.eventSourceConstructor(e,{withCredentials:n.withCredentials});else{var s=n.httpClient.getCookieString(e),l={};l.Cookie=s;var c=getUserAgentHeader(),h=c[0],u=c[1];l[h]=u,o=new n.eventSourceConstructor(e,{withCredentials:n.withCredentials,headers:__assign$3({},l,n.headers)})}try{o.onmessage=function(e){if(n.onreceive)try{n.logger.log(LogLevel.Trace,"(SSE transport) data received. "+getDataDetail(e.data,n.logMessageContent)+"."),n.onreceive(e.data)}catch(e){return void n.close(e)}},o.onerror=function(e){var t=new Error(e.data||"Error occurred");a?n.close(t):i(t)},o.onopen=function(){n.logger.log(LogLevel.Information,"SSE connected to "+n.url),n.eventSource=o,a=!0,r()}}catch(e){return void i(e)}}else i(new Error("The Server-Sent Events transport only supports the 'Text' transfer format"))}))]}}))}))},e.prototype.send=function(e){return __awaiter$2(this,void 0,void 0,(function(){return __generator$2(this,(function(t){return this.eventSource?[2,sendMessage(this.logger,"SSE",this.httpClient,this.url,this.accessTokenFactory,e,this.logMessageContent,this.withCredentials,this.headers)]:[2,Promise.reject(new Error("Cannot send until the transport is connected"))]}))}))},e.prototype.stop=function(){return this.close(),Promise.resolve()},e.prototype.close=function(e){this.eventSource&&(this.eventSource.close(),this.eventSource=void 0,this.onclose&&this.onclose(e))},e}(),__assign$2=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__awaiter$1=function(e,t,r,n){return new(r||(r=Promise))((function(i,a){function o(e){try{l(n.next(e))}catch(e){a(e)}}function s(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){e.done?i(e.value):new r((function(t){t(e.value)})).then(o,s)}l((n=n.apply(e,t||[])).next())}))},__generator$1=function(e,t){var r,n,i,a,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&a[0]?n.return:a[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,a[1])).done)return i;switch(n=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,n=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],n=0}finally{r=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},WebSocketTransport=function(){function e(e,t,r,n,i,a){this.logger=r,this.accessTokenFactory=t,this.logMessageContent=n,this.webSocketConstructor=i,this.httpClient=e,this.onreceive=null,this.onclose=null,this.headers=a}return e.prototype.connect=function(e,t){return __awaiter$1(this,void 0,void 0,(function(){var r,n=this;return __generator$1(this,(function(i){switch(i.label){case 0:return Arg.isRequired(e,"url"),Arg.isRequired(t,"transferFormat"),Arg.isIn(t,TransferFormat,"transferFormat"),this.logger.log(LogLevel.Trace,"(WebSockets transport) Connecting."),this.accessTokenFactory?[4,this.accessTokenFactory()]:[3,2];case 1:(r=i.sent())&&(e+=(e.indexOf("?")<0?"?":"&")+"access_token="+encodeURIComponent(r)),i.label=2;case 2:return[2,new Promise((function(r,i){var a;e=e.replace(/^http/,"ws");var o=n.httpClient.getCookieString(e),s=!1;if(Platform.isNode){var l={},c=getUserAgentHeader(),h=c[0],u=c[1];l[h]=u,o&&(l.Cookie=""+o),a=new n.webSocketConstructor(e,void 0,{headers:__assign$2({},l,n.headers)})}a||(a=new n.webSocketConstructor(e)),t===TransferFormat.Binary&&(a.binaryType="arraybuffer"),a.onopen=function(t){n.logger.log(LogLevel.Information,"WebSocket connected to "+e+"."),n.webSocket=a,s=!0,r()},a.onerror=function(e){var t=null;t="undefined"!=typeof ErrorEvent&&e instanceof ErrorEvent?e.error:new Error("There was an error with the transport."),i(t)},a.onmessage=function(e){if(n.logger.log(LogLevel.Trace,"(WebSockets transport) data received. "+getDataDetail(e.data,n.logMessageContent)+"."),n.onreceive)try{n.onreceive(e.data)}catch(e){return void n.close(e)}},a.onclose=function(e){if(s)n.close(e);else{var t=null;t="undefined"!=typeof ErrorEvent&&e instanceof ErrorEvent?e.error:new Error("There was an error with the transport."),i(t)}}}))]}}))}))},e.prototype.send=function(e){return this.webSocket&&this.webSocket.readyState===this.webSocketConstructor.OPEN?(this.logger.log(LogLevel.Trace,"(WebSockets transport) sending data. "+getDataDetail(e,this.logMessageContent)+"."),this.webSocket.send(e),Promise.resolve()):Promise.reject("WebSocket is not in the OPEN state")},e.prototype.stop=function(){return this.webSocket&&this.close(void 0),Promise.resolve()},e.prototype.close=function(e){this.webSocket&&(this.webSocket.onclose=function(){},this.webSocket.onmessage=function(){},this.webSocket.onerror=function(){},this.webSocket.close(),this.webSocket=void 0),this.logger.log(LogLevel.Trace,"(WebSockets transport) socket closed."),this.onclose&&(!this.isCloseEvent(e)||!1!==e.wasClean&&1e3===e.code?e instanceof Error?this.onclose(e):this.onclose():this.onclose(new Error("WebSocket closed with status code: "+e.code+" ("+e.reason+").")))},e.prototype.isCloseEvent=function(e){return e&&"boolean"==typeof e.wasClean&&"number"==typeof e.code},e}(),__assign$1=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__awaiter=function(e,t,r,n){return new(r||(r=Promise))((function(i,a){function o(e){try{l(n.next(e))}catch(e){a(e)}}function s(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){e.done?i(e.value):new r((function(t){t(e.value)})).then(o,s)}l((n=n.apply(e,t||[])).next())}))},__generator=function(e,t){var r,n,i,a,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&a[0]?n.return:a[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,a[1])).done)return i;switch(n=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,n=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],n=0}finally{r=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},MAX_REDIRECTS=100,HttpConnection=function(){function e(e,t){if(void 0===t&&(t={}),this.features={},this.negotiateVersion=1,Arg.isRequired(e,"url"),this.logger=createLogger(t.logger),this.baseUrl=this.resolveUrl(e),(t=t||{}).logMessageContent=void 0!==t.logMessageContent&&t.logMessageContent,"boolean"!=typeof t.withCredentials&&void 0!==t.withCredentials)throw new Error("withCredentials option was not a 'boolean' or 'undefined' value");t.withCredentials=void 0===t.withCredentials||t.withCredentials;var r=null,n=null;if(Platform.isNode&&"undefined"!=typeof require){var i="function"==typeof __webpack_require__?__non_webpack_require__:require;r=i("ws"),n=i("eventsource")}Platform.isNode||"undefined"==typeof WebSocket||t.WebSocket?Platform.isNode&&!t.WebSocket&&r&&(t.WebSocket=r):t.WebSocket=WebSocket,Platform.isNode||"undefined"==typeof EventSource||t.EventSource?Platform.isNode&&!t.EventSource&&void 0!==n&&(t.EventSource=n):t.EventSource=EventSource,this.httpClient=t.httpClient||new DefaultHttpClient(this.logger),this.connectionState="Disconnected",this.connectionStarted=!1,this.options=t,this.onreceive=null,this.onclose=null}return e.prototype.start=function(e){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:return e=e||TransferFormat.Binary,Arg.isIn(e,TransferFormat,"transferFormat"),this.logger.log(LogLevel.Debug,"Starting connection with transfer format '"+TransferFormat[e]+"'."),"Disconnected"!==this.connectionState?[2,Promise.reject(new Error("Cannot start an HttpConnection that is not in the 'Disconnected' state."))]:(this.connectionState="Connecting",this.startInternalPromise=this.startInternal(e),[4,this.startInternalPromise]);case 1:return r.sent(),"Disconnecting"!==this.connectionState?[3,3]:(t="Failed to start the HttpConnection before stop() was called.",this.logger.log(LogLevel.Error,t),[4,this.stopPromise]);case 2:return r.sent(),[2,Promise.reject(new Error(t))];case 3:if("Connected"!==this.connectionState)return t="HttpConnection.startInternal completed gracefully but didn't enter the connection into the connected state!",this.logger.log(LogLevel.Error,t),[2,Promise.reject(new Error(t))];r.label=4;case 4:return this.connectionStarted=!0,[2]}}))}))},e.prototype.send=function(e){return"Connected"!==this.connectionState?Promise.reject(new Error("Cannot send data if the connection is not in the 'Connected' State.")):(this.sendQueue||(this.sendQueue=new TransportSendQueue(this.transport)),this.sendQueue.send(e))},e.prototype.stop=function(e){return __awaiter(this,void 0,void 0,(function(){var t=this;return __generator(this,(function(r){switch(r.label){case 0:return"Disconnected"===this.connectionState?(this.logger.log(LogLevel.Debug,"Call to HttpConnection.stop("+e+") ignored because the connection is already in the disconnected state."),[2,Promise.resolve()]):"Disconnecting"===this.connectionState?(this.logger.log(LogLevel.Debug,"Call to HttpConnection.stop("+e+") ignored because the connection is already in the disconnecting state."),[2,this.stopPromise]):(this.connectionState="Disconnecting",this.stopPromise=new Promise((function(e){t.stopPromiseResolver=e})),[4,this.stopInternal(e)]);case 1:return r.sent(),[4,this.stopPromise];case 2:return r.sent(),[2]}}))}))},e.prototype.stopInternal=function(e){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:this.stopError=e,r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.startInternalPromise];case 2:case 3:return r.sent(),[3,4];case 4:if(!this.transport)return[3,9];r.label=5;case 5:return r.trys.push([5,7,,8]),[4,this.transport.stop()];case 6:return r.sent(),[3,8];case 7:return t=r.sent(),this.logger.log(LogLevel.Error,"HttpConnection.transport.stop() threw error '"+t+"'."),this.stopConnection(),[3,8];case 8:return this.transport=void 0,[3,10];case 9:this.logger.log(LogLevel.Debug,"HttpConnection.transport is undefined in HttpConnection.stop() because start() failed."),this.stopConnection(),r.label=10;case 10:return[2]}}))}))},e.prototype.startInternal=function(e){return __awaiter(this,void 0,void 0,(function(){var t,r,n,i,a,o;return __generator(this,(function(s){switch(s.label){case 0:t=this.baseUrl,this.accessTokenFactory=this.options.accessTokenFactory,s.label=1;case 1:return s.trys.push([1,12,,13]),this.options.skipNegotiation?this.options.transport!==HttpTransportType.WebSockets?[3,3]:(this.transport=this.constructTransport(HttpTransportType.WebSockets),[4,this.startTransport(t,e)]):[3,5];case 2:return s.sent(),[3,4];case 3:throw new Error("Negotiation can only be skipped when using the WebSocket transport directly.");case 4:return[3,11];case 5:r=null,n=0,i=function(){var e;return __generator(this,(function(i){switch(i.label){case 0:return[4,a.getNegotiationResponse(t)];case 1:if(r=i.sent(),"Disconnecting"===a.connectionState||"Disconnected"===a.connectionState)throw new Error("The connection was stopped during negotiation.");if(r.error)throw new Error(r.error);if(r.ProtocolVersion)throw new Error("Detected a connection attempt to an ASP.NET SignalR Server. This client only supports connecting to an ASP.NET Core SignalR Server. See https://aka.ms/signalr-core-differences for details.");return r.url&&(t=r.url),r.accessToken&&(e=r.accessToken,a.accessTokenFactory=function(){return e}),n++,[2]}}))},a=this,s.label=6;case 6:return[5,i()];case 7:s.sent(),s.label=8;case 8:if(r.url&&n<MAX_REDIRECTS)return[3,6];s.label=9;case 9:if(n===MAX_REDIRECTS&&r.url)throw new Error("Negotiate redirection limit exceeded.");return[4,this.createTransport(t,this.options.transport,r,e)];case 10:s.sent(),s.label=11;case 11:return this.transport instanceof LongPollingTransport&&(this.features.inherentKeepAlive=!0),"Connecting"===this.connectionState&&(this.logger.log(LogLevel.Debug,"The HttpConnection connected successfully."),this.connectionState="Connected"),[3,13];case 12:return o=s.sent(),this.logger.log(LogLevel.Error,"Failed to start the connection: "+o),this.connectionState="Disconnected",this.transport=void 0,[2,Promise.reject(o)];case 13:return[2]}}))}))},e.prototype.getNegotiationResponse=function(e){return __awaiter(this,void 0,void 0,(function(){var t,r,n,i,a,o,s,l,c;return __generator(this,(function(h){switch(h.label){case 0:return t={},this.accessTokenFactory?[4,this.accessTokenFactory()]:[3,2];case 1:(r=h.sent())&&(t.Authorization="Bearer "+r),h.label=2;case 2:n=getUserAgentHeader(),i=n[0],a=n[1],t[i]=a,o=this.resolveNegotiateUrl(e),this.logger.log(LogLevel.Debug,"Sending negotiation request: "+o+"."),h.label=3;case 3:return h.trys.push([3,5,,6]),[4,this.httpClient.post(o,{content:"",headers:__assign$1({},t,this.options.headers),withCredentials:this.options.withCredentials})];case 4:return 200!==(s=h.sent()).statusCode?[2,Promise.reject(new Error("Unexpected status code returned from negotiate '"+s.statusCode+"'"))]:((!(l=JSON.parse(s.content)).negotiateVersion||l.negotiateVersion<1)&&(l.connectionToken=l.connectionId),[2,l]);case 5:return c=h.sent(),this.logger.log(LogLevel.Error,"Failed to complete negotiation with the server: "+c),[2,Promise.reject(c)];case 6:return[2]}}))}))},e.prototype.createConnectUrl=function(e,t){return t?e+(-1===e.indexOf("?")?"?":"&")+"id="+t:e},e.prototype.createTransport=function(e,t,r,n){return __awaiter(this,void 0,void 0,(function(){var i,a,o,s,l,c,h,u,d,p,f;return __generator(this,(function(m){switch(m.label){case 0:return i=this.createConnectUrl(e,r.connectionToken),this.isITransport(t)?(this.logger.log(LogLevel.Debug,"Connection was provided an instance of ITransport, using that directly."),this.transport=t,[4,this.startTransport(i,n)]):[3,2];case 1:return m.sent(),this.connectionId=r.connectionId,[2];case 2:a=[],o=r.availableTransports||[],s=r,l=0,c=o,m.label=3;case 3:return l<c.length?(h=c[l],(u=this.resolveTransportOrError(h,t,n))instanceof Error?(a.push(h.transport+" failed: "+u),[3,12]):[3,4]):[3,13];case 4:if(!this.isITransport(u))return[3,12];if(this.transport=u,s)return[3,9];m.label=5;case 5:return m.trys.push([5,7,,8]),[4,this.getNegotiationResponse(e)];case 6:return s=m.sent(),[3,8];case 7:return d=m.sent(),[2,Promise.reject(d)];case 8:i=this.createConnectUrl(e,s.connectionToken),m.label=9;case 9:return m.trys.push([9,11,,12]),[4,this.startTransport(i,n)];case 10:return m.sent(),this.connectionId=s.connectionId,[2];case 11:return p=m.sent(),this.logger.log(LogLevel.Error,"Failed to start the transport '"+h.transport+"': "+p),s=void 0,a.push(h.transport+" failed: "+p),"Connecting"!==this.connectionState?(f="Failed to select transport before stop() was called.",this.logger.log(LogLevel.Debug,f),[2,Promise.reject(new Error(f))]):[3,12];case 12:return l++,[3,3];case 13:return a.length>0?[2,Promise.reject(new Error("Unable to connect to the server with any of the available transports. "+a.join(" ")))]:[2,Promise.reject(new Error("None of the transports supported by the client are supported by the server."))]}}))}))},e.prototype.constructTransport=function(e){switch(e){case HttpTransportType.WebSockets:if(!this.options.WebSocket)throw new Error("'WebSocket' is not supported in your environment.");return new WebSocketTransport(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1,this.options.WebSocket,this.options.headers||{});case HttpTransportType.ServerSentEvents:if(!this.options.EventSource)throw new Error("'EventSource' is not supported in your environment.");return new ServerSentEventsTransport(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1,this.options.EventSource,this.options.withCredentials,this.options.headers||{});case HttpTransportType.LongPolling:return new LongPollingTransport(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1,this.options.withCredentials,this.options.headers||{});default:throw new Error("Unknown transport: "+e+".")}},e.prototype.startTransport=function(e,t){var r=this;return this.transport.onreceive=this.onreceive,this.transport.onclose=function(e){return r.stopConnection(e)},this.transport.connect(e,t)},e.prototype.resolveTransportOrError=function(e,t,r){var n=HttpTransportType[e.transport];if(null==n)return this.logger.log(LogLevel.Debug,"Skipping transport '"+e.transport+"' because it is not supported by this client."),new Error("Skipping transport '"+e.transport+"' because it is not supported by this client.");if(!transportMatches(t,n))return this.logger.log(LogLevel.Debug,"Skipping transport '"+HttpTransportType[n]+"' because it was disabled by the client."),new Error("'"+HttpTransportType[n]+"' is disabled by the client.");if(!(e.transferFormats.map((function(e){return TransferFormat[e]})).indexOf(r)>=0))return this.logger.log(LogLevel.Debug,"Skipping transport '"+HttpTransportType[n]+"' because it does not support the requested transfer format '"+TransferFormat[r]+"'."),new Error("'"+HttpTransportType[n]+"' does not support "+TransferFormat[r]+".");if(n===HttpTransportType.WebSockets&&!this.options.WebSocket||n===HttpTransportType.ServerSentEvents&&!this.options.EventSource)return this.logger.log(LogLevel.Debug,"Skipping transport '"+HttpTransportType[n]+"' because it is not supported in your environment.'"),new Error("'"+HttpTransportType[n]+"' is not supported in your environment.");this.logger.log(LogLevel.Debug,"Selecting transport '"+HttpTransportType[n]+"'.");try{return this.constructTransport(n)}catch(e){return e}},e.prototype.isITransport=function(e){return e&&"object"==typeof e&&"connect"in e},e.prototype.stopConnection=function(e){var t=this;if(this.logger.log(LogLevel.Debug,"HttpConnection.stopConnection("+e+") called while in state "+this.connectionState+"."),this.transport=void 0,e=this.stopError||e,this.stopError=void 0,"Disconnected"!==this.connectionState){if("Connecting"===this.connectionState)throw this.logger.log(LogLevel.Warning,"Call to HttpConnection.stopConnection("+e+") was ignored because the connection is still in the connecting state."),new Error("HttpConnection.stopConnection("+e+") was called while the connection is still in the connecting state.");if("Disconnecting"===this.connectionState&&this.stopPromiseResolver(),e?this.logger.log(LogLevel.Error,"Connection disconnected with error '"+e+"'."):this.logger.log(LogLevel.Information,"Connection disconnected."),this.sendQueue&&(this.sendQueue.stop().catch((function(e){t.logger.log(LogLevel.Error,"TransportSendQueue.stop() threw error '"+e+"'.")})),this.sendQueue=void 0),this.connectionId=void 0,this.connectionState="Disconnected",this.connectionStarted){this.connectionStarted=!1;try{this.onclose&&this.onclose(e)}catch(t){this.logger.log(LogLevel.Error,"HttpConnection.onclose("+e+") threw error '"+t+"'.")}}}else this.logger.log(LogLevel.Debug,"Call to HttpConnection.stopConnection("+e+") was ignored because the connection is already in the disconnected state.")},e.prototype.resolveUrl=function(e){if(0===e.lastIndexOf("https://",0)||0===e.lastIndexOf("http://",0))return e;if(!Platform.isBrowser||!window.document)throw new Error("Cannot resolve '"+e+"'.");var t=window.document.createElement("a");return t.href=e,this.logger.log(LogLevel.Information,"Normalizing '"+e+"' to '"+t.href+"'."),t.href},e.prototype.resolveNegotiateUrl=function(e){var t=e.indexOf("?"),r=e.substring(0,-1===t?e.length:t);return"/"!==r[r.length-1]&&(r+="/"),r+="negotiate",-1===(r+=-1===t?"":e.substring(t)).indexOf("negotiateVersion")&&(r+=-1===t?"?":"&",r+="negotiateVersion="+this.negotiateVersion),r},e}();function transportMatches(e,t){return!e||0!=(t&e)}var TransportSendQueue=function(){function e(e){this.transport=e,this.buffer=[],this.executing=!0,this.sendBufferedData=new PromiseSource,this.transportResult=new PromiseSource,this.sendLoopPromise=this.sendLoop()}return e.prototype.send=function(e){return this.bufferData(e),this.transportResult||(this.transportResult=new PromiseSource),this.transportResult.promise},e.prototype.stop=function(){return this.executing=!1,this.sendBufferedData.resolve(),this.sendLoopPromise},e.prototype.bufferData=function(e){if(this.buffer.length&&typeof this.buffer[0]!=typeof e)throw new Error("Expected data to be of type "+typeof this.buffer+" but was of type "+typeof e);this.buffer.push(e),this.sendBufferedData.resolve()},e.prototype.sendLoop=function(){return __awaiter(this,void 0,void 0,(function(){var t,r,n;return __generator(this,(function(i){switch(i.label){case 0:return[4,this.sendBufferedData.promise];case 1:if(i.sent(),!this.executing)return this.transportResult&&this.transportResult.reject("Connection stopped."),[3,6];this.sendBufferedData=new PromiseSource,t=this.transportResult,this.transportResult=void 0,r="string"==typeof this.buffer[0]?this.buffer.join(""):e.concatBuffers(this.buffer),this.buffer.length=0,i.label=2;case 2:return i.trys.push([2,4,,5]),[4,this.transport.send(r)];case 3:return i.sent(),t.resolve(),[3,5];case 4:return n=i.sent(),t.reject(n),[3,5];case 5:return[3,0];case 6:return[2]}}))}))},e.concatBuffers=function(e){for(var t=e.map((function(e){return e.byteLength})).reduce((function(e,t){return e+t})),r=new Uint8Array(t),n=0,i=0,a=e;i<a.length;i++){var o=a[i];r.set(new Uint8Array(o),n),n+=o.byteLength}return r.buffer},e}(),PromiseSource=function(){function e(){var e=this;this.promise=new Promise((function(t,r){var n;return n=[t,r],e.resolver=n[0],e.rejecter=n[1],n}))}return e.prototype.resolve=function(){this.resolver()},e.prototype.reject=function(e){this.rejecter(e)},e}(),JSON_HUB_PROTOCOL_NAME="json",JsonHubProtocol=function(){function e(){this.name=JSON_HUB_PROTOCOL_NAME,this.version=1,this.transferFormat=TransferFormat.Text}return e.prototype.parseMessages=function(e,t){if("string"!=typeof e)throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!e)return[];null===t&&(t=NullLogger.instance);for(var r=[],n=0,i=TextMessageFormat.parse(e);n<i.length;n++){var a=i[n],o=JSON.parse(a);if("number"!=typeof o.type)throw new Error("Invalid payload.");switch(o.type){case MessageType.Invocation:this.isInvocationMessage(o);break;case MessageType.StreamItem:this.isStreamItemMessage(o);break;case MessageType.Completion:this.isCompletionMessage(o);break;case MessageType.Ping:case MessageType.Close:break;default:t.log(LogLevel.Information,"Unknown message type '"+o.type+"' ignored.");continue}r.push(o)}return r},e.prototype.writeMessage=function(e){return TextMessageFormat.write(JSON.stringify(e))},e.prototype.isInvocationMessage=function(e){this.assertNotEmptyString(e.target,"Invalid payload for Invocation message."),void 0!==e.invocationId&&this.assertNotEmptyString(e.invocationId,"Invalid payload for Invocation message.")},e.prototype.isStreamItemMessage=function(e){if(this.assertNotEmptyString(e.invocationId,"Invalid payload for StreamItem message."),void 0===e.item)throw new Error("Invalid payload for StreamItem message.")},e.prototype.isCompletionMessage=function(e){if(e.result&&e.error)throw new Error("Invalid payload for Completion message.");!e.result&&e.error&&this.assertNotEmptyString(e.error,"Invalid payload for Completion message."),this.assertNotEmptyString(e.invocationId,"Invalid payload for Completion message.")},e.prototype.assertNotEmptyString=function(e,t){if("string"!=typeof e||""===e)throw new Error(t)},e}(),__assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},LogLevelNameMapping={trace:LogLevel.Trace,debug:LogLevel.Debug,info:LogLevel.Information,information:LogLevel.Information,warn:LogLevel.Warning,warning:LogLevel.Warning,error:LogLevel.Error,critical:LogLevel.Critical,none:LogLevel.None};function parseLogLevel(e){var t=LogLevelNameMapping[e.toLowerCase()];if(void 0!==t)return t;throw new Error("Unknown log level: "+e)}var HubConnectionBuilder=function(){function e(){}return e.prototype.configureLogging=function(e){if(Arg.isRequired(e,"logging"),isLogger(e))this.logger=e;else if("string"==typeof e){var t=parseLogLevel(e);this.logger=new ConsoleLogger(t)}else this.logger=new ConsoleLogger(e);return this},e.prototype.withUrl=function(e,t){return Arg.isRequired(e,"url"),Arg.isNotEmpty(e,"url"),this.url=e,this.httpConnectionOptions=__assign({},this.httpConnectionOptions,"object"==typeof t?t:{transport:t}),this},e.prototype.withHubProtocol=function(e){return Arg.isRequired(e,"protocol"),this.protocol=e,this},e.prototype.withAutomaticReconnect=function(e){if(this.reconnectPolicy)throw new Error("A reconnectPolicy has already been set.");return e?Array.isArray(e)?this.reconnectPolicy=new DefaultReconnectPolicy(e):this.reconnectPolicy=e:this.reconnectPolicy=new DefaultReconnectPolicy,this},e.prototype.build=function(){var e=this.httpConnectionOptions||{};if(void 0===e.logger&&(e.logger=this.logger),!this.url)throw new Error("The 'HubConnectionBuilder.withUrl' method must be called before building the connection.");var t=new HttpConnection(this.url,e);return HubConnection.create(t,this.logger||NullLogger.instance,this.protocol||new JsonHubProtocol,this.reconnectPolicy)},e}();function isLogger(e){return void 0!==e.log}class Logger{constructor(){this._mode=!1,this.debug=()=>{},this.info=()=>{},this.warn=()=>{},this.error=()=>{},this.setLogMode(!1)}setLogMode(e){this._mode=e,this._mode?(this.debug=console.log.bind(console),this.info=console.log.bind(console),this.warn=console.warn.bind(console),this.error=console.error.bind(console)):(this.debug=()=>{},this.info=()=>{},this.warn=console.warn.bind(console),this.error=console.error.bind(console))}}class HTMLToolTipParams{id="";container="";divId="";showCloseButton=!0;toolTipWidth=0;toolTipHeight=0;toolTipLeftOffset=0;toolTipBottomOffset=0;updateDelay=200}class HTMLToolTip{constructor(e){this.htmlToolTipParams=e,this.onClose=null,this.id=e.id,this._show=!1,this._close=!1,this._timeoutArray=[]}addToScreen(){const e=document.getElementById(this.htmlToolTipParams.divId);if(!e)return"不存在该divId";this._parentElement=e.parentElement,this._parentElement.removeChild(e),e.style.position="absolute",e.style.display="none",e.style.width=`${this.htmlToolTipParams.toolTipWidth}px`,e.style.height=`${this.htmlToolTipParams.toolTipHeight}px`,this.tooltipElement=e,this.htmlToolTipParams.showCloseButton&&this._addCloseButton(),this.htmlToolTipParams.container.appendChild(e)}updatePosition(e,t){const r=this,n=setTimeout((()=>{r._checkBoundary(e,t),r.tooltipElement.style.top=t-r.htmlToolTipParams.toolTipHeight-r.htmlToolTipParams.toolTipBottomOffset+"px",r.tooltipElement.style.left=`${e+r.htmlToolTipParams.toolTipLeftOffset}px`,r.tooltipElement.style.display=r._show?"block":"none",r._timeoutArray.shift()}),r.htmlToolTipParams.updateDelay);this._timeoutArray.push(n)}updateVisible(e){e?this.hideTooltip():this.showTooltip()}showTooltip(){this._close=!1}hideTooltip(){this._close=!0}removeTooltip(){this._closeButton&&this.tooltipElement.removeChild(this._closeButton);for(const e of this._timeoutArray)window.clearTimeout(e);this._timeoutArray=[],this.tooltipElement.parentElement?.removeChild(this.tooltipElement),this.tooltipElement.style.display="none"}_addCloseButton(){const e=document.createElement("button");e.style.background="none",e.style.border="0px",e.style.position="absolute",e.style.left="100%",e.style.transform="translate(-100%, -100%)",e.style.cursor="pointer",e.style.fontSize="18px",e.style.lineHeight="18px",e.innerText="X";let t=this;e.onclick=()=>{t.removeTooltip(),t._close=!0,t.onClose&&"function"==typeof t.onClose&&t.onClose(t.htmlToolTipParams.id)},this.tooltipElement.appendChild(e),this._closeButton=e}_checkBoundary(e,t){if(this._close)return void(this._show=!1);const r=document.getElementById("streamingVideo"),n=parseFloat(r.style.width),i=parseFloat(r.style.height);this._show=!(e>n+9||e<-9||t<-9||t>i+9)}}const _OVERLAY_LANDMARK="landmark",_OVERLAY_PATH="path",_OVERLAY_AREA="area",_OVERLAY_CIRCULAR_AREA="circulararea",_OVERLAY_3D_TILE="3dtile",_OVERLAY_GISMAP="gismap",_OVERLAY_LANDMARK_LAYER="landmarklayer",_OVERLAY_3D_COLUMN_LAYER="3dcolumnlayer",_OVERLAY_3D_GRID_LAYER="3dgridlayer",_OVERLAY_HEATMAP_LAYER="heatmaplayer",_OVERLAY_BUBBLE_LAYER="bubblelayer",_OVERLAY_EVENTBUBBLE_LAYER="eventbubblelayer",_OVERLAY_TRAIL_LAYER="traillayer",_OVERLAY_POINT_TRAIL_LAYER="pointtraillayer",_OVERLAY_ODLINE_LAYER="odlinelayer",_OVERLAY_TYPE_AREA_LAYER="typearealayer",_OVERLAY_COLOR_AREA_LAYER="colorarealayer",_OVERLAY_ROAD_PT_HEAT_LAYER="roadptheatlayer",_OVERLAY_ROAD_SG_HEAT_LAYER="roadsgheatlayer",_OVERLAY_3D_MARKER="3dmarker",_OVERLAY_AGGLANDMARKLAYER="agglandmarklayer",_OVERLAY_AGGBUBBLELAYER="aggbubblelayer",_OVERLAY_AGGEVENTBUBBLELAYER="aggeventbubblelayer",_OVERLAY_AGGHEATMAPLAYER="aggheatmaplayer",_OVERLAY_AGG3DCOLUMNLAYER="agg3dcolumnlayer",_OVERLAY_AGG3DGRIDLAYER="agg3dgridlayer",_OVERLAY_MODELTRAILLAYER="modeltraillayer",_OVERLAY_MODELTRAILLAYERTEMP="modeltraillayertemp",_OVERLAY_MODELLANDMARKLAYER="modellandmarklayer",_OVERLAY_MODELLANDMARKLAYERTEMP="modellandmarklayertemp",overlays$1={};overlays$1[_OVERLAY_LANDMARK]="landmark",overlays$1[_OVERLAY_PATH]="path",overlays$1[_OVERLAY_AREA]="area",overlays$1[_OVERLAY_CIRCULAR_AREA]="circulararea",overlays$1[_OVERLAY_3D_TILE]="3dtile",overlays$1[_OVERLAY_GISMAP]="gismap",overlays$1[_OVERLAY_LANDMARK_LAYER]="landmarklayer",overlays$1[_OVERLAY_3D_COLUMN_LAYER]="3dcolumnlayer",overlays$1[_OVERLAY_3D_GRID_LAYER]="3dgridlayer",overlays$1[_OVERLAY_HEATMAP_LAYER]="heatmaplayer",overlays$1[_OVERLAY_BUBBLE_LAYER]="bubblelayer",overlays$1[_OVERLAY_EVENTBUBBLE_LAYER]="eventbubblelayer",overlays$1[_OVERLAY_TRAIL_LAYER]="traillayer",overlays$1[_OVERLAY_POINT_TRAIL_LAYER]="pointtraillayer",overlays$1[_OVERLAY_ODLINE_LAYER]="odlinelayer",overlays$1[_OVERLAY_TYPE_AREA_LAYER]="typearealayer",overlays$1[_OVERLAY_COLOR_AREA_LAYER]="colorarealayer",overlays$1[_OVERLAY_ROAD_PT_HEAT_LAYER]="roadptheatlayer",overlays$1[_OVERLAY_ROAD_SG_HEAT_LAYER]="roadsgheatlayer",overlays$1[_OVERLAY_3D_MARKER]="3dmarker",overlays$1[_OVERLAY_AGGLANDMARKLAYER]="agglandmarklayer",overlays$1[_OVERLAY_AGGBUBBLELAYER]="aggbubblelayer",overlays$1[_OVERLAY_AGGEVENTBUBBLELAYER]="aggeventbubblelayer",overlays$1[_OVERLAY_AGGHEATMAPLAYER]="aggheatmaplayer",overlays$1[_OVERLAY_AGG3DCOLUMNLAYER]="agg3dcolumnlayer",overlays$1[_OVERLAY_AGG3DGRIDLAYER]="agg3dgridlayer",overlays$1[_OVERLAY_MODELTRAILLAYER]="modeltraillayer",overlays$1[_OVERLAY_MODELTRAILLAYERTEMP]="modeltraillayertemp",overlays$1[_OVERLAY_MODELLANDMARKLAYER]="modellandmarklayer",overlays$1[_OVERLAY_MODELLANDMARKLAYERTEMP]="modellandmarklayertemp";const weathers={Sunny:"晴天",Cloudy:"晴间少云",PartlyCloudy:"晴间多云",Overcast:"阴天",LightRain:"小雨",ModerateRain:"中雨",HeavyRain:"大雨",LightSnow:"小雪",ModerateSnow:"中雪",HeavySnow:"大雪",Foggy:"雾天",Dust:"扬尘",Haze:"雾霾"},circleTypes={rect:"屏幕矩形",circle:"地表圆形",polygon:"地表多边形"},clickTypes={click:"点击选中",hover:"悬停选中"},states={pause:"暂停",continue:"继续",stop:"停止，回到初始状态"},loopModes={none:"不循环",round:"往返",repeat:"从头循环"},pathDirections={path:"沿路径调整模型方向",self:"模型自己原本方向不变"},_3DMarkerType={Radar01:"Radar01",Revolve01:"Revolve01",Revolve02:"Revolve02",Revolve03:"Revolve03",Revolve04:"Revolve04",Revolve05:"Revolve05",Revolve06:"Revolve06",Revolve07:"Revolve07",Spread01:"Spread01",Spread02:"Spread02",Spread03:"Spread03",Spread04:"Spread04",Spread05:"Spread05",Spread06:"Spread06",Spread07:"Spread07",Spread08:"Spread08",Spread09:"Spread09",Spread10:"Spread10",Spread11:"Spread11",Spread12:"Spread12",Spread13:"Spread13",Spread14:"Spread14",Spread15:"Spread15",Spread16:"Spread16",Spread17:"Spread17",Square01:"Square01"},pathTypes={Arrow01:"Arrow01",Arrow02:"Arrow02",Arrow03:"Arrow03",Arrow04:"Arrow04",Arrow05:"Arrow05",Arrow06:"Arrow06",Segment01:"Segment01",Segment02:"Segment02",Segment03:"Segment03",Segment04:"Segment04",Segment05:"Segment05",Segment06:"Segment06"},areaTypes={Arrow01:"Arrow01",Gradient01:"Gradient01",Gradient02:"Gradient02",Gradient03:"Gradient03",Grid01:"Grid01",Grid02:"Grid02",Grid03:"Grid03",Grid04:"Grid04",Grid05:"Grid05",Segment01:"Segment01",Segment02:"Segment02",Segment03:"Segment03"},areaFillAreaTypes={none:"none",Gradient01:"Gradient01",Gradient02:"Gradient02",Grid01:"Grid01",Grid02:"Grid02",Segment01:"Segment01",Segment02:"Segment02"};class TGStreaming3Renderer{constructor(){this.callbackMap=new Map,this.tooltipMap=new Map,this.tooltipDivMap=new Map,this.deleteTipMap=new Map,this.deleteTempTipMap=new Map,this.tooltipCallback=new Map,this.tempTipMap=new Map,this.channelId="default";for(let e in eventMap)this[e]=eventMap[e].function}init({url:e,token:t,container:r,isShareToken:n,resolution:i,events:a,showDefaultLoading:o,editMode:s,useTCP:l},c){this.streamingPlayer=new StreamingPlayer({controlScheme:1,printInputs:!1,printLog:!1,stateQueryInterval:1,useTCP:l}),this.callback=c,this.resolution=i,this.isShareToken=n,this.serverUrl=e,"/"==this.serverUrl[this.serverUrl.length-1]&&(this.serverUrl=this.serverUrl.substr(0,this.serverUrl.length-1)),this.token=t,this.conversationId=Util.guid(),r.style.position="relative",r.style.overflow="none",this.container=r,this.aggServerUrl=this.serverUrl+"/DataServer",this.logger=new Logger,this.editMode=s,this.streamingEngineVer="无渲染引擎版本信息",this.hasPreheatReset=void 0,this.clientStatus={},window.logger=this.logger,logger.debug(this.aggServerUrl),this.createElementBox(),this.useTCP=l,this.initServerSocket(),o&&(this.progressBar=new ProgressBar({container:this.elementParent,text:"Loading..."})),this.events=a,this.streamingPlayer.addStatusChangedListener((e=>{this.streamingPlayerState=e})),"function"==typeof this.callback&&this.callback({result:1,message:"成功。"})}getServerPath(e,t){var r=this.isShareToken;return Util.fetchJSON(e+`/RenderUnit/GetChannelPreviewInfo?connectionId=${this.connectionId}&isSharePreview=${r}&token=${t}`,"get")}createStreaming3(e){var t=this;this.apiData=e,this.timeOut=null,null!=t.resolution&&2==t.resolution.length||(window.onresize=function(){t.timeOut&&clearTimeout(t.timeOut),t.timeOut=setTimeout((()=>{t.setResolutionSDK(t.apiData)}),30)});var r=this.container;if(r){if(r.style.position="relative",!r)return logger.warn(`模型加载出错。无效的容器名称（${r}）。`),void(onFinish&&onFinish(0));window.streamingDOM&&(window.streamingDOM.remove(),window.streamingDOM=null),this.streamingPlayer.createVideoElement(e.data.rtcPeerConnection),window.streamingDOM=this.streamingPlayer.playerElement,this.eventListenerFromUE();let n=document.createElement("div");return n.setAttribute("id","innerContainer"),n.appendChild(window.streamingDOM),this.container.appendChild(n),this.url=this.signallingWsUrl,window.streamingDOM.emitDescriptor=e=>{t.streamingPlayer.emitUIInteraction(e)},streamingDOM.muted=!0,streamingDOM.autoplay=!0,this.streamingPlayer.startPlay(this.url),window.streamingDOM.oncanplay=function(){logger.debug("准备就绪"),t.setResolutionSDK(t.apiData),t.initScene({editMode:t.editMode}),t.progressBar&&t.progressBar.destroy(),t.progressBar=null,t.createStatusBox(),t.createSceneInfoBox();t.executeCommand("getAppInfo",{},t._getAppInfoUECallback),t.executeCommand("videoConnected",{},(e=>t.logger.info("通知UE场景串流成功完成",e)))},window.streamingDOM.addEventListener("playing",(e=>{window.streamingDOM.focus()})),window.streamingDOM.addEventListener("error",(e=>{window.streamingDOM.pause()})),window.addEventListener("keydown",(e=>{"KeyB"===e.code&&e.altKey&&e.ctrlKey&&(t.isDebugMode?(t.isDebugMode=!1,logger.debug("关闭debug模式"),t.hiddenDebugWindow(),t.streamingPlayer.canInputConsoleCommand=!1,e.preventDefault()):(t.isDebugMode=!0,logger.debug("开启debug模式"),t.showDebugWindow(),t.streamingPlayer.canInputConsoleCommand=!0,e.preventDefault()))})),void(this.streamingPlayer.webRtcPlayerObj.onDataChannelConnected=function(){t.apiData.data.needReset&&!0===t.apiData.data.needReset&&t.preheatReset(t.apiData,!1),t.serverSocket.invoke("GetChannelId").then((e=>{t.channelId=e,t.logger.info(`channelId:${e}`),t.getClientStatusInner()})).catch((e=>{t.logger.error("获取通道Id失败",e),t.clientStatus={error:"获取通道Id失败"}}))})}}setSize(e){if(null==this.resolution||2!=this.resolution.length||this.isShareToken)this.setResolutionSDK(this.apiData);else{var t=e.codeRate,r=e.frameRate;this.setResolutionInnerMethod({width:e.width,height:e.height,rateMax:t,fpsMax:r})}}setResolutionSDK(e){var t=e.data,r=this.container;t.stretch;var n=this.isShareToken,i=t.resolutionX,a=t.resolutionY;this.maxWidth=i,this.maxHeight=a;var o=t.codeRate;this.rateMax=o;var s=t.frameRate;this.fpsMax=s;var l=this.surpassMaxResolution(i,a);if(null==this.resolution||2!=this.resolution.length)if(n){this.setResolutionInnerMethod({width:i,height:a,rateMax:o,fpsMax:s}),streamingDOM.style.width="100%";var c=r.clientWidth/i,h=r.clientHeight/a,u=Math.min(c,h);streamingDOM.style.width=i*u+"px",streamingDOM.style.height=a*u+"px",streamingDOM.parentElement.style.width="100%",streamingDOM.parentElement.style.width=i*u+"px",streamingDOM.parentElement.style.height=a*u+"px",streamingDOM.style.position="absolute",streamingDOM.style.left="50%",streamingDOM.style.top="50%",streamingDOM.style.transform="translateX(-50%) translateY(-50%)",streamingDOM.style.outline=0,streamingDOM.parentElement.style.position="absolute",streamingDOM.parentElement.style.left="50%",streamingDOM.parentElement.style.top="50%",streamingDOM.parentElement.style.transform="translateX(-50%) translateY(-50%)",streamingDOM.parentElement.style.outline=0}else if("allIn"==l)this.setResolutionInnerMethod({width:r.clientWidth,height:r.clientHeight,rateMax:o,fpsMax:s}),streamingDOM.style.position="unset",streamingDOM.style.left="unset",streamingDOM.style.top="unset",streamingDOM.style.transform="unset",streamingDOM.style.outline=0,streamingDOM.parentElement.style.position="unset",streamingDOM.parentElement.style.left="unset",streamingDOM.parentElement.style.top="unset",streamingDOM.parentElement.style.transform="unset",streamingDOM.parentElement.style.outline=0;else{streamingDOM.style.width="100%";c=r.clientWidth/i,h=r.clientHeight/a;let e=i*(u=Math.min(c,h))+"px",t=a*u+"px";this.setResolutionInnerMethod({width:e,height:t,rateMax:o,fpsMax:s}),streamingDOM.style.width=i*u+"px",streamingDOM.style.height=a*u+"px",streamingDOM.parentElement.style.width="100%",streamingDOM.parentElement.style.width=i*u+"px",streamingDOM.parentElement.style.height=a*u+"px",streamingDOM.style.position="absolute",streamingDOM.style.left="50%",streamingDOM.style.top="50%",streamingDOM.style.transform="translateX(-50%) translateY(-50%)",streamingDOM.style.outline=0,streamingDOM.parentElement.style.position="absolute",streamingDOM.parentElement.style.left="50%",streamingDOM.parentElement.style.top="50%",streamingDOM.parentElement.style.transform="translateX(-50%) translateY(-50%)",streamingDOM.parentElement.style.outline=0}else this.setResolutionInnerMethod({width:this.resolution[0]>3840?3840:this.resolution[0],height:this.resolution[1]>2160?2160:this.resolution[1],rateMax:o,fpsMax:s})}surpassMaxResolution(e,t){var r=this.container,n=r.clientWidth,i=r.clientHeight;return n<=e&&i<=t?"allIn":n>=e&&i>=t?"all":n>=e?"w":"h"}time_dis(e,t){var r=Date.parse(new Date(t)),n=Date.parse(new Date(e));if(n<r)return!1;var i=n-r,a=i%864e5,o=a%36e5;return Math.floor(i/864e5)+"天"+Math.floor(a/36e5)+"小时"+Math.floor(o/6e4)+"分"+o%6e4/1e3+"秒"}eventListenerFromUE(){var e=this;this.streamingPlayer.registerResponseEvent("message",(async t=>{let r=JSON.parse(t.detail);if(!t||""==t.detail)try{JSON.parse(t.detail)}catch(e){return void logger.debug("返回值结构不合格！")}if(r.eventName&&"onHTMLTipObjectPositionChanged"===r.eventName)this._updateHTMLToolTipsPosition(r.args.screenPositions,e.tooltipMap,e.tooltipDivMap);else if(r.eventName&&null!=eventMap[r.eventName]){let t={result:r.result,message:r.message};if(eventMap[r.eventName].backtrack.forEach((e=>{t[e]=r.args[e]})),null!=eventMap[r.eventName].callback&&eventMap[r.eventName].callback(t),e.events[r.eventName])for(let n of e.events[r.eventName])n(t)}else{var n=this.callbackMap.get(r.method);if(this.tooltipCallback.has(r.callbackId)){if(0==r.params.result){const e=this.tooltipCallback.get(r.callbackId);e.removeTooltip(),this.tooltipMap.delete(e.id),this.tooltipDivMap.delete(e.id)}this.tooltipCallback.delete(r.callbackId)}if("getScenesInfo"===r.method){r.params.customIcons=r.params.customIcons.map((e=>({name:e,url:""})));try{let t=await Util.fetchJSON(`${e.serverUrl}/Streaming/GetProjectCustomIcons/${e.token}`,"get");if(t=JSON.parse(t),0===t.status)for(const e of t.data){const t=r.params.customIcons.find((t=>t.name===e.name));t&&(t.url=e.url)}else e.logger.error("读取图标地址失败！",t.message)}catch(t){e.logger.error("读取图标地址失败！",t)}}if("removeOverlayTip"===r.method||"removeModelTip"===r.method)for(const[t,n]of e.deleteTipMap.entries())if(n===r.callbackId){if(0===r.params.result)break;if(e.deleteTempTipMap.has(r.callbackId)){e.deleteTempTipMap.delete(r.callbackId);break}return void e.deleteTempTipMap.set(r.callbackId,"")}if(n&&"function"==typeof n.get(r.callbackId)){let e=this;n.get(r.callbackId)(r.params,e)}}}))}createElementBox(){var e=document.createElement("div");e.className="elementOver",e.style.position="absolute",e.style.height="100%",e.style.width="100%",e.style.top=0,e.style.left=0,e.style.pointerEvents="none",e.style.zIndex=50;var t=document.createElement("div");t.className="elementParent",t.style.position="absolute",t.style.height="100%",t.style.width="100%",t.style.top=0,t.style.left=0,t.style.pointerEvents="none",t.style.zIndex=100;var r=document.createElement("div");r.className="messageBox",r.style.maxHeight="300px",r.style.maxWidth="600px",r.style.position="absolute",r.style.left="50%",r.style.top="50%",r.style.fontSize="25px",r.style.transform="translate(-50%, -50%)",r.style.textShadow="0 0 1px #fff",this.elementParent=t,this.elementOver=e,this.messageBox=r,this.container.appendChild(t),this.container.appendChild(e),this.elementParent.appendChild(r)}createStatusBox(){let e=document.createElement("div");e.setAttribute("id","debugDiv"),e.style.position="absolute",e.style.top=0,e.style.left="100%",e.style.color="lawngreen",e.style.background="black",e.style.padding="15px",e.style.width="fit-content",e.style.pointerEvents="none",e.style.fontSize="10px",e.style.transform="translate(-100%, 0%)",e.style.textAlign="left",e.style.display="none",this.container.appendChild(e)}createSceneInfoBox(){let e=document.createElement("div");e.setAttribute("id","debugDiv"),e.style.position="absolute",e.style.minWidth="543px",e.style.maxWidth="80%",e.style.padding="0px 10px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.bottom="20px",e.style.borderRadius="8px",e.style.backgroundColor="rgba(0,0,0,0.5)",e.style.lineHeight="32px",e.style.fontSize="14px",e.style.color="rgb(204,204,204)",this.container.appendChild(e)}removeStatusBox(){this.hiddenDebugWindow();let e=document.getElementById("debugDiv");e&&(this.container.removeChild(e),e=void 0,this.isDebugMode=!1)}showDebugWindow(){let e=document.getElementById("debugDiv");e.style.display="block",e&&this.streamingPlayer.addStatusChangedListener((t=>{let r="",n="";switch(t.videoQuality){case VideoQualityType.High:n="High";break;case VideoQualityType.Medium:n="Medium";break;case VideoQualityType.Low:n="Low";break;default:n="N/A"}r+=`<div>连接质量：${n}</div>`,r+=`<div>视频质量参数：${t.videoQuantizationParameter}</div>`,r+=`<div>视频运行时长：${t.duration}</div>`,r+=`<div>视频分辨率：${t.VideoResolution}</div>`,r+=`<div>视频帧率：${t.framerate}</div>`,r+=`<div>视频比特率(kbps)：${t.bitrate}</div>`,r+=`<div>视频丢包：${t.packetsLost}</div>`,r+=`<div>视频丢帧：${t.framesDropped}</div>`,r+=`<div>视频延迟(ms)：${t.latency}</div>`,e.innerHTML=r}))}hiddenDebugWindow(){let e=document.getElementById("debugDiv");e&&(e.style.display="none",this.streamingPlayer.removeStatusChangedListener())}setMessage(e,t){let r=this;null!=t&&logger.debug(`错误码：code-${t}`),this.progressBar&&(this.progressBar.destroy(),this.progressBar=null);let n={type:"message",code:t,message:e};if(null==eventMap.subscribeServerMessage.callback)if(r.events.subscribeServerMessage.length>0)for(let e of r.events.subscribeServerMessage)e(n);else this.messageBox.innerHTML="",this.messageBox.innerText=e,this.elementOver.style.backgroundColor="black",this.elementOver.style.opacity="80%";else if(eventMap.subscribeServerMessage.callback(n),r.events.subscribeServerMessage)for(let e of r.events.subscribeServerMessage)e(n)}initServerSocket(){var e=this.serverUrl.indexOf("https")>-1?"wss:":"ws:",t=this;this.serverSocket=(new HubConnectionBuilder).withUrl(this.serverUrl+"/SdkHub").configureLogging(LogLevel.Error).withAutomaticReconnect([0,2e3,5e3,1e4]).build(),this.serverSocket.onreconnecting((e=>{t.progressBar=new ProgressBar({container:this.elementParent,text:"Loading..."})})),this.serverSocket.onreconnected((e=>{t.progressBar.destroy(),t.progressBar=null,t.serverSocket.invoke("ReConnection",{OldConnectionId:t.connectionId}).catch((e=>t.logger.error("上报重连信息出错",e))),t.connectionId=t.serverSocket.connectionId,t.logger.info("流渲染服务重连成功。")})),this.serverSocket.onclose((e=>{t.reinit&&!0===t.reinit?t.reinit=!1:(t.progressBar&&(t.progressBar.destroy(),t.progressBar=null),t.setMessage("流渲染服务异常，请联系相关负责人"))})),this.serverSocket.start().then((r=>{if(logger.debug("服务器socket连接成功！",r),t.events.onServiceConnected)for(let e of t.events.onServiceConnected)e();t.connectionId=t.serverSocket.connectionId,t.getServerPath(t.serverUrl,t.token).then((r=>{r=JSON.parse(r);var n=t.serverUrl.split(":");100==r.status?(n.length>=3?t.signallingWsUrl=e+n[1]+":"+n[2]+r.data.signallingUrl:t.signallingWsUrl=e+n[1]+r.data.signallingUrl,t.createStreaming3(r)):101==r.status?t.serverSocket.on("EnterStreamingPreview",(i=>{n.length>=3?t.signallingWsUrl=e+n[1]+":"+n[2]+i.previewUrl:t.signallingWsUrl=e+n[1]+i.previewUrl,t.createStreaming3(r)})):t.setMessage(r.message,r.status)})).catch((e=>{logger.debug(e),"Forbidden"===e.message?t.setMessage("该资源禁止访问！",403):t.setMessage("请求出现异常！")}))})).catch((function(e){logger.debug(e)})),this.subscribeSignalRMessage(),window.onbeforeunload=()=>{t.preheatReset(t.apiData,!0);let e={token:this.token,isMaster:!1,state:2,type:""};this.serverSocket.invoke("ReportChannelState",e)}}setCloseMessage(e){var t=document.createElement("div");t.className="elementParent",t.style.position="absolute",t.style.height="100%",t.style.width="100%",t.style.top=0,t.style.left=0,t.style.pointerEvents="none",t.style.zIndex=100;var r=document.createElement("div");r.className="messageBoxClose",r.style.maxHeight="300px",r.style.maxWidth="600px",r.style.position="absolute",r.style.left="50%",r.style.top="50%",r.style.fontSize="25px",r.style.transform="translate(-50%, -50%)",r.style.textShadow="0 0 1px #fff",this.elementParent=t,this.messageBoxClose=r,this.container.appendChild(t),this.elementParent.appendChild(r),this.messageBoxClose.innerHTML="",this.messageBoxClose.innerText=e}subscribeSignalRMessage(){let e=this;this.serverSocket.on("StopChannelVisiting",(t=>{e.destroy(),e.setCloseMessage(t.message)})),this.serverSocket.on("ShowMessage",(t=>{e.setMessage(t.message,t.code)})),this.serverSocket.on("PreheatFailed",(t=>{e.setMessage(t.message,t.code)})),this.serverSocket.on("ApplicationExit",(t=>{e.setMessage(t.message,t.code),setTimeout((()=>{e.setMessage(""),e.destroy(),e.reinit=!0,e.init({url:e.serverUrl,token:e.token,container:e.container,isShareToken:e.isShareToken,showDefaultLoading:!0,events:e.events,editMode:e.editMode,useTCP:e.useTCP})}),3e3)})),this.serverSocket.on("Restart",(t=>{e.setMessage(""),e.destroy(),e.reinit=!0,e.init({url:e.serverUrl,token:e.token,container:e.container,isShareToken:e.isShareToken,showDefaultLoading:!0,events:e.events,editMode:e.editMode,useTCP:e.useTCP})})),this.serverSocket.on("UpdateMasterToken",(t=>{e.setMessage("场景访问Token被更新，请联系相关负责人获取新的Token"),e.destroy()})),this.serverSocket.on("PreheatStateChangeMessage",(t=>{e.apiData.data.isPreheat=t.isPreheat,this.logger.info("接收到PreheatStateChangeMessage",e.apiData)})),this.serverSocket.on("PreheatResetChangeMessage",(t=>{e.apiData.data.preHeatReset=t.preheatReset,this.logger.info("接收到PreheatResetChangeMessage",e.apiData)}))}sendServerSocketMess(e,t,r,n){t?this.serverSocket.invoke(e,t).then((function(e){void 0!==r&&r(1,e)})).catch((function(e){void 0!==r&&r(0,e)})):this.serverSocket.invoke(e).then((function(e){void 0!==r&&r(1,e)})).catch((function(e){void 0!==r&&r(0,e)}))}takeEvent(e,t){"message"==e&&(this.takeMessageEvent=t)}async preheatReset(e,t){if((!this.hasPreheatReset||1!=t)&&(!0===t&&(this.hasPreheatReset=!0),this.logger.info("进入预热重置逻辑！"),e.data.isPreheat&&e.data.preHeatReset&&!0===e.data.isPreheat&&!0===e.data.preHeatReset)){let e={};if(this.executeCommand("restoreSceneInitalState",e,(e=>{this.logger.info("restoreSceneInitalState backup ",e)})),this.logger.info("预热重置逻辑完成"),t&&this.serverSocket&&"Connected"===this.serverSocket.state)try{await this.serverSocket.invoke("PreheatResetFinish",this.connectionId)}catch(e){this.logger.warn("PreheatResetFinish 未完成",e)}}}getClientStatusInner(){if(this.channelId){let e=this;try{Util.fetchJSON(this.serverUrl+`/Streaming/GetClientStatus/${this.channelId}`,"get").then((t=>{var r=JSON.parse(t);if(e.logger.info("getClientStatusInner",r.data),0==r.status&&r.data)if(r.data.clientStatus)try{e.clientStatus=JSON.parse(r.data.clientStatus)}catch(t){e.clientStatus={error:"getClientStatus 方法出错 clientStatus 不是Json结构类型"}}else e.clientStatus={};else e.clientStatus={error:"getClientStatus 方法出错"+message}}))}catch(t){e.clientStatus={error:"getClientStatus 方法出错"},e.logger.error("getClientStatus 方法出错！",t)}}}async saveClientStatusInner(e){if(this.channelId){let r={channelId:this.channelId,clientStatus:JSON.stringify(e)};var t=await Util.fetchJSON(`${this.serverUrl}/Streaming/SaveClientStatus`,"post",[{key:"Content-Type",value:"application/json"}],r);return JSON.parse(t)}return null}destroy(){this.preheatReset(this.apiData,!0),window.streamingDOM&&(this.streamingPlayer.removeStatusChangedListener(),this.streamingPlayer.destroy(),window.streamingDOM.remove(),this.messageBox.remove(),this.elementOver.remove()),this.container.innerHTML="",this.removeStatusBox(),this.serverSocket&&(this.serverSocket.stop(),this.serverSocket=null),this._updateHTMLToolTipsPosition([],this.tooltipMap,this.tooltipDivMap),logger.debug("TGUE4StreamingRenderer.destroy()")}focusChinaMap(e,t){this.executeCommand("focusChinaMap",e,t)}focusProvince(e,t){this.executeCommand("focusProvince",e,t)}addLandmark(e,t){this.executeCommand("addLandmark",e,t)}updateLandmarkCoord(e,t){this.executeCommand("updateLandmarkCoord",e,t)}updateLandmarkStyle(e,t){this.executeCommand("updateLandmarkStyle",e,t)}selectLandmark(e,t){this.executeCommand("selectLandmark",e,t)}deselectLandmark(e,t){this.executeCommand("deselectLandmark",e,t)}clearLandmarkSelection(e,t){this.executeCommand("clearLandmarkSelection",e,t)}setCamera(e,t){e.duration<=0?t&&t({result:0,message:"失败，飞行时间无效。"}):this.executeCommand("setCamera",e,t)}getCameraInfo(e,t){this.executeCommand("getCameraInfo",e,t)}setCameraOrbit(e,t){this.executeCommand("setCameraOrbit",e,t)}setOverlayVisibility(e,t){this.checkOverlayTypeExist(e.overlayType)?this.executeCommand("setOverlayVisibility",e,t):this.returnOverlayTypeError(t)}removeOverlay(e,t){if(!this.checkOverlayTypeExist(e.overlayType))return void this.returnOverlayTypeError(t);this.executeCommand("removeOverlay",e,t);let r=this;Util.fetchJSON(`${this.aggServerUrl}/RemoveLayersRecord`,"post",[{key:"Content-Type",value:"application/json"}],e).catch((e=>{r.logger.error("删除图层记录失败",e)}))}clearOverlay(e,t){this.executeCommand("clearOverlay",e,t)}clearOverlayType(e,t){let r=e.overlayType.toLowerCase();if("all"!=r&&!overlays$1[r])return void(t&&t({result:0,message:"失败，覆盖物类型错误。"}));this.executeCommand("clearOverlayType",e,t);let n=this;Util.fetchJSON(`${this.aggServerUrl}/RemoveLayersRecord`,"post",[{key:"Content-Type",value:"application/json"}],e).catch((e=>{n.logger.error("删除图层记录失败",e)}))}addPath(e,t){pathTypes[e.type]?this.executeCommand("addPath",e,t):t&&t({result:0,message:"失败，路线样式类别不存在。"})}updatePathCoord(e,t){this.executeCommand("updatePathCoord",e,t)}updatePathStyle(e,t){pathTypes[e.type]?this.executeCommand("updatePathStyle",e,t):t&&t({result:0,message:"失败，路线样式类别不存在。"})}addLandmarkLayer(e,t){this.executeCommand("addLandmarkLayer",e,t)}addLandmarkLayerLegend(e,t){this.executeCommand("addLandmarkLayerLegend",e,t)}removeLandmarkLayerLegend(e,t){this.executeCommand("removeLandmarkLayerLegend",e,t)}updateLandmarkLayerStyle(e,t){this.executeCommand("updateLandmarkLayerStyle",e,t)}updateLandmarkLayerCoord(e,t){this.executeCommand("updateLandmarkLayerCoord",e,t)}add3DColumnLayer(e,t){if("number"!=typeof e.columnAlpha||e.columnAlpha<0||e.columnAlpha>1)t&&t({result:0,message:"columnAlpha 属性值错误。"});else if(e.columnType&&"cube"!=e.columnType&&"cylinder"!=e.columnType)t&&t({result:0,message:"columnType  柱体外观类别 属性值错误。"});else if(e.columnPaint&&"solid"!=e.columnPaint&&"linear"!=e.columnPaint&&"legend"!=e.columnPaint)t&&t({result:0,message:"columnPaint  柱体样式类别 属性值错误。"});else{var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");if(r.ok){var n=this.checkMinMaxValue(e.columnMinHeight,e.columnMaxHeight,"columnMinHeight","columnMaxHeight");n.ok?this.executeCommand("add3DColumnLayer",e,t):t&&t(n.data)}else t&&t(r.data)}}update3DColumnLayerCoord(e,t){this.executeCommand("update3DColumnLayerCoord",e,t)}update3DColumnLayerStyle(e,t){if("number"!=typeof e.columnAlpha||e.columnAlpha<0||e.columnAlpha>1)t&&t({result:0,message:"columnAlpha 属性值错误。"});else if(e.columnType&&"cube"!=e.columnType&&"cylinder"!=e.columnType)t&&t({result:0,message:"columnType  柱体外观类别 属性值错误。"});else if(e.columnPaint&&"solid"!=e.columnPaint&&"linear"!=e.columnPaint&&"legend"!=e.columnPaint)t&&t({result:0,message:"columnPaint  柱体样式类别 属性值错误。"});else{var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");if(r.ok){var n=this.checkMinMaxValue(e.columnMinHeight,e.columnMaxHeight,"columnMinHeight","columnMaxHeight");n.ok?this.executeCommand("update3DColumnLayerStyle",e,t):t&&t(n.data)}else t&&t(r.data)}}add3DGridLayer(e,t){if("number"!=typeof e.gridAlpha||e.gridAlpha<0||e.gridAlpha>1)t&&t({result:0,message:"gridAlpha 属性值错误。"});else if(e.gridType&&"grid"!=e.gridType&&"dot"!=e.gridType)t&&t({result:0,message:"gridType  栅格外观类别 属性值错误。"});else{var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");r.ok?this.executeCommand("add3DGridLayer",e,t):t&&t(r.data)}}update3DGridLayerCoord(e,t){this.executeCommand("update3DGridLayerCoord",e,t)}update3DGridLayerStyle(e,t){if("number"!=typeof e.gridAlpha||e.gridAlpha<0||e.gridAlpha>1)t&&t({result:0,message:"gridAlpha 属性值错误。"});else if(e.gridType&&"grid"!=e.gridType&&"dot"!=e.gridType)t&&t({result:0,message:"gridType  栅格外观类别 属性值错误。"});else{var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");r.ok?this.executeCommand("update3DGridLayerStyle",e,t):t&&t(r.data)}}addAreaLayer(e,t){areaTypes[e.type]?areaFillAreaTypes[e.fillArea]?this.executeCommand("addAreaLayer",e,t):t&&t({result:0,message:"失败，区域填充样式类型错误。"}):t&&t({result:0,message:"失败，区域边界样式类型错误。"})}updateAreaLayerCoord(e,t){this.executeCommand("updateAreaLayerCoord",e,t)}updateAreaLayerStyle(e,t){areaTypes[e.type]?areaFillAreaTypes[e.fillArea]?this.executeCommand("updateAreaLayerStyle",e,t):t&&t({result:0,message:"失败，区域填充样式类型错误。"}):t&&t({result:0,message:"失败，区域边界样式类型错误。"})}addCircularAreaLayer(e,t){areaTypes[e.type]?areaFillAreaTypes[e.fillArea]?this.executeCommand("addCircularAreaLayer",e,t):t&&t({result:0,message:"失败，区域填充样式类型错误。"}):t&&t({result:0,message:"失败，区域边界样式类型错误。"})}updateCircularAreaLayerCoord(e,t){this.executeCommand("updateCircularAreaLayerCoord",e,t)}updateCircularAreaLayerStyle(e,t){areaTypes[e.type]?areaFillAreaTypes[e.fillArea]?this.executeCommand("updateCircularAreaLayerStyle",e,t):t&&t({result:0,message:"失败，区域填充样式类型错误。"}):t&&t({result:0,message:"失败，区域边界样式类型错误。"})}setEnvTime(e,t){if(e.envTime){var r=e.envTime.split(/:|：| |-|\//);if(null==r[0]||r[0]>=24)return void(t&&t({result:0,message:`时间 ${e.envTime} 格式错误。`}));if(null==r[1]||r[1]>=60)return void(t&&t({result:0,message:`时间 ${e.envTime} 格式错误。`}));e.envTime=r.join(":")}this.executeCommand("setEnvTime",e,t)}setEnvWeather(e,t){weathers[e.envWeather]?this.executeCommand("setEnvWeather",e,t):t&&t({result:0,message:`失败，天气 ${e.envWeather} 暂不支持。`})}addBubbleLayer(e,t){var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");if(r.ok){var n=this.checkMinMaxValue(e.radiusMin,e.radiusMax,"radiusMin","radiusMax");n.ok?this.executeCommand("addBubbleLayer",e,t):t&&t(n.data)}else t&&t(r.data)}async addTrailLayer(e,t){let r=await this.serverSocket.invoke("GetAggregationServiceAddress");e.trailServer=r.data,e.channelId=this.channelId,this.executeCommand("addTrailLayer",e,t)}deletePath(e,t){this.executeCommand("deletePath",e,t)}addODLineLayer(e,t){if("number"!=typeof e.lineSpeed||e.lineSpeed<0)t&&t({result:0,message:"lineSpeed 属性值错误。"});else if(e.curvature>1||e.curvature<0)t&&t({result:0,message:"curvature 属性值错误。"});else{var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");if(r.ok){var n=this.checkMinMaxValue(e.bubbleRadiusMin,e.bubbleRadiusMax,"bubbleRadiusMin","bubbleRadiusMax");if(n.ok){var i=this.checkMinMaxValue(e.lineWidthMin,e.lineWidthMax,"lineWidthMin","lineWidthMax");i.ok?this.executeCommand("addODLineLayer",e,t):t&&t(i.data)}else t&&t(n.data)}else t&&t(r.data)}}updateODLineLayerCoord(e,t){this.executeCommand("updateODLineLayerCoord",e,t)}updateODLineLayerStyle(e,t){if("number"!=typeof e.lineSpeed||e.lineSpeed<0)t&&t({result:0,message:"lineSpeed 属性值错误。"});else if(e.curvature>1||e.curvature<0)t&&t({result:0,message:"curvature 属性值错误。"});else{var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");if(r.ok){var n=this.checkMinMaxValue(e.bubbleRadiusMin,e.bubbleRadiusMax,"bubbleRadiusMin","bubbleRadiusMax");if(n.ok){var i=this.checkMinMaxValue(e.lineWidthMin,e.lineWidthMax,"lineWidthMin","lineWidthMax");i.ok?this.executeCommand("updateODLineLayerStyle",e,t):t&&t(i.data)}else t&&t(n.data)}else t&&t(r.data)}}updateTrailLayerCoord(e,t){this.executeCommand("updateTrailLayerCoord",e,t)}updateTrailLayerStyle(e,t){this.executeCommand("updateTrailLayerStyle",e,t)}updateBubbleLayerCoord(e,t){this.executeCommand("updateBubbleLayerCoord",e,t)}updateBubbleLayerStyle(e,t){var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");if(r.ok){var n=this.checkMinMaxValue(e.radiusMin,e.radiusMax,"radiusMin","radiusMax");n.ok?this.executeCommand("updateBubbleLayerStyle",e,t):t&&t(n.data)}else t&&t(r.data)}addCircularArea(e,t){this.executeCommand("addCircularArea",e,t)}updateCircularAreaCoord(e,t){this.executeCommand("updateCircularAreaCoord",e,t)}updateCircularAreaStyle(e,t){this.executeCommand("updateCircularAreaStyle",e,t)}add3DMarker(e,t){_3DMarkerType[e.type]?this.executeCommand("add3DMarker",e,t):t&&t({result:0,message:`失败，特效样式类别 ${e.type} 不存在。`})}update3DMarkerCoord(e,t){this.executeCommand("update3DMarkerCoord",e,t)}update3DMarkerStyle(e,t){_3DMarkerType[e.type]?this.executeCommand("update3DMarkerStyle",e,t):t&&t({result:0,message:`失败，特效样式类别 ${e.type} 不存在。`})}getStates(e,t){this.executeCommand("getStates",e,t)}switchState(e,t){this.executeCommand("switchState",e,t)}restrictCamera(e,t){if(e.limitPitch){if(e.limitPitch.length<2)return void(t&&t({result:0,message:"失败，摄像机镜头垂直俯仰角数组结构出错。"}));if("number"!=typeof e.limitPitch[0]||e.limitPitch[0]<1||"number"!=typeof e.limitPitch[1]||e.limitPitch[1]>89)return void(t&&t({result:0,message:"失败，摄像机镜头垂直俯仰角范围在 1~89。"}))}if(e.limitPitch){if(e.limitYaw.length<2)return void(t&&t({result:0,message:"失败，摄像机镜头水平摇摆角数组结构出错。"}));if("number"!=typeof e.limitYaw[0]||e.limitYaw[0]<0||"number"!=typeof e.limitYaw[1]||e.limitYaw[1]>359)return void(t&&t({result:0,message:"失败，摄像机镜头水平摇摆角范围在 0~359。"}))}if(e.limitCoordZ){if(e.limitCoordZ.length<2)return void(t&&t({result:0,message:"失败，摄像机镜头坐标高度限制数组结构出错。"}));if("number"!=typeof e.limitCoordZ[0]||"number"!=typeof e.limitCoordZ[1])return void(t&&t({result:0,message:"失败，摄像机镜头坐标高度限制非数字。"}))}if(e.limitDistance){if(e.limitDistance.length<2)return void(t&&t({result:0,message:"失败，摄像机镜头距离限制数组结构出错。"}));if("number"!=typeof e.limitDistance[0]||"number"!=typeof e.limitDistance[1])return void(t&&t({result:0,message:"失败，摄像机镜头距离限制非数字。"}))}this.executeCommand("restrictCamera",e,t)}setCameraRestrictionState(e,t){this.executeCommand("setCameraRestrictionState",e,t)}roamingCamera(e,t){this.executeCommand("roamingCamera",e,t)}setCameraRoamingState(e,t){this.executeCommand("setCameraRoamingState",e,t)}pathingCamera(e,t){this.executeCommand("pathingCamera",e,t)}setCameraPathingState(e,t){this.executeCommand("setCameraPathingState",e,t)}focusById(e,t){this.checkOverlayTypeExist(e.overlayType)?this.executeCommand("focusById",e,t):this.returnOverlayTypeError(t)}focusByType(e,t){this.checkOverlayTypeExist(e.overlayType)?this.executeCommand("focusByType",e,t):this.returnOverlayTypeError(t)}focusBuilding(e,t){this.executeCommand("focusBuilding",e,t)}focusFloor(e,t){this.executeCommand("focusFloor",e,t)}focusRoom(e,t){this.executeCommand("focusRoom",e,t)}setCompass(e,t){this.executeCommand("setCompass",e,t)}addWatermark(e,t){this.executeCommand("addWatermark",e,t)}removeWatermark(e,t){this.executeCommand("removeWatermark",e,t)}switchChinaMap(e,t){this.executeCommand("switchChinaMap",e,t)}highlightProvince(e,t){this.executeCommand("highlightProvince",e,t)}setProvinceNameVisible(e,t){this.executeCommand("setProvinceNameVisible",e,t)}setOverlaySelectState(e,t){this.executeCommand("setOverlaySelectState",e,t)}clickOverlay(e,t){this.executeCommand("clickOverlay",e,t)}getLandmarkScreenRange(e,t){this.executeCommand("getLandmarkScreenRange",e,t)}addPathShp(e,t){this.executeCommand("addPathShp",e,t)}addArea(e,t){this.executeCommand("addArea",e,t)}updateAreaCoord(e,t){this.executeCommand("updateAreaCoord",e,t)}updateAreaStyle(e,t){this.executeCommand("updateAreaStyle",e,t)}addAreaShp(e,t){this.executeCommand("addAreaShp",e,t)}add3DTile(e,t){this.executeCommand("add3DTile",e,t)}update3DTile(e,t){this.executeCommand("update3DTile",e,t)}update3DTileStyle(e,t){this.executeCommand("update3DTileStyle",e,t)}addGISMap(e,t){this.executeCommand("addGISMap",e,t)}updateGISMap(e,t){this.executeCommand("updateGISMap",e,t)}updateGISMapStyle(e,t){this.executeCommand("updateGISMapStyle",e,t)}setBaseCenter(e,t){this.executeCommand("setBaseCenter",e,t)}setDefaultBaseCenter(e,t){this.executeCommand("setDefaultBaseCenter",e,t)}resetDefaultBaseCenter(e,t){this.executeCommand("resetDefaultBaseCenter",e,t)}updateHeatMapLayerCoord(e,t){this.executeCommand("updateHeatMapLayerCoord",e,t)}updateHeatMapLayerStyle(e,t){if("number"!=typeof e.alpha||e.alpha<0||e.alpha>1)t&&t({result:0,message:"失败，alpha 属性值错误。"});else if("default"==e.type||"dot"==e.type){var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");r.ok?this.executeCommand("updateHeatMapLayerStyle",e,t):t&&t(r.data)}else t&&t({result:0,message:"失败，type 属性值错误。"})}addTypeAreaLayer(e,t){"number"!=typeof e.alpha||e.alpha<0||e.alpha>1?t&&t({result:0,message:"失败，alpha 属性值错误。"}):this.executeCommand("addTypeAreaLayer",e,t)}updateTypeAreaLayerCoord(e,t){this.executeCommand("updateTypeAreaLayerCoord",e,t)}updateTypeAreaLayerStyle(e,t){"number"!=typeof e.alpha||e.alpha<0||e.alpha>1?t&&t({result:0,message:"失败，alpha 属性值错误。"}):this.executeCommand("updateTypeAreaLayerStyle",e,t)}updateTypeAreaLayerArea(e,t){this.executeCommand("updateTypeAreaLayerArea",e,t)}addColorAreaLayer(e,t){if("number"!=typeof e.alpha||e.alpha<0||e.alpha>1)t&&t({result:0,message:"失败，alpha 属性值错误。"});else{var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");r.ok?this.executeCommand("addColorAreaLayer",e,t):t&&t(r.data)}}updateColorAreaLayerCoord(e,t){this.executeCommand("updateColorAreaLayerCoord",e,t)}updateColorAreaLayerStyle(e,t){if("number"!=typeof e.alpha||e.alpha<0||e.alpha>1)t&&t({result:0,message:"失败，alpha 属性值错误。"});else{var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");r.ok?this.executeCommand("updateColorAreaLayerStyle",e,t):t&&t(r.data)}}updateColorAreaLayerArea(e,t){this.executeCommand("updateColorAreaLayerArea",e,t)}addRoadPtHeatLayer(e,t){var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");r.ok?this.executeCommand("addRoadPtHeatLayer",e,t):t&&t(r.data)}updateRoadPtHeatLayerCoord(e,t){this.executeCommand("updateRoadPtHeatLayerCoord",e,t)}updateRoadPtHeatLayerStyle(e,t){var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");r.ok?this.executeCommand("updateRoadPtHeatLayerStyle",e,t):t&&t(r.data)}async addRoadSgHeatLayerCoord(e,t){if("number"!=typeof e.alpha||e.alpha<0||e.alpha>1)return void(t&&t({result:0,message:"失败，alpha 属性值错误。"}));var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");if(!r.ok)return void(t&&t(r.data));let n=await this.serverSocket.invoke("GetAggregationServiceAddress");e.dataServer=n.data,e.channelId=this.channelId;let i=this;if(e.lineDataId)try{let r=await Util.fetchJSON(`${i.aggServerUrl}/RecordLayers`,"post",[{key:"Content-Type",value:"application/json"}],{channelId:i.channelId,id:e.lineDataId,layerId:e.id,layerType:"roadSgHeatLayer"});if(r=JSON.parse(r),111===r.code)return void t({result:0,message:`数据服务中不包含id为${e.lineDataId}的数据`})}catch(e){this.logger.error("记录图层失败",e)}this.executeCommand("addRoadSgHeatLayerCoord",e,t)}updateRoadSgHeatLayerCoord(e,t){this.executeCommand("updateRoadSgHeatLayerCoord",e,t)}updateRoadSgHeatLayerStyle(e,t){if("number"!=typeof e.alpha||e.alpha<0||e.alpha>1)t&&t({result:0,message:"失败，alpha 属性值错误。"});else{var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");r.ok?this.executeCommand("updateRoadSgHeatLayerStyle",e,t):t&&t(r.data)}}updateRoadSgHeatLayerSegment(e,t){this.executeCommand("updateRoadSgHeatLayerSegment",e,t)}addEventBubbleLayer(e,t){var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");if(r.ok){var n=this.checkMinMaxValue(e.radiusMin,e.radiusMax,"radiusMin","radiusMax");n.ok?this.executeCommand("addEventBubbleLayer",e,t):t&&t(n.data)}else t&&t(r.data)}updateEventBubbleLayerCoord(e,t){this.executeCommand("updateEventBubbleLayerCoord",e,t)}updateEventBubbleLayerStyle(e,t){var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");if(r.ok){var n=this.checkMinMaxValue(e.radiusMin,e.radiusMax,"radiusMin","radiusMax");n.ok?this.executeCommand("updateEventBubbleLayerStyle",e,t):t&&t(n.data)}else t&&t(r.data)}addPointTrackLayer(e,t){this.executeCommand("addPointTrackLayer",e,t)}updatePointTrackLayerCoord(e,t){this.executeCommand("updatePointTrackLayerCoord",e,t)}updatePointTrackLayerStyle(e,t){this.executeCommand("updatePointTrackLayerStyle",e,t)}getSceneObjects(e,t){this.executeCommand("getSceneObjects",e,t)}addModel(e,t){this.executeCommand("addModel",e,t)}removeModel(e,t){this.executeCommand("removeModel",e,t)}getModelType(e,t){this.executeCommand("getModelType",e,t)}setModelTransform(e,t){this.executeCommand("setModelTransform",e,t)}setModelOpacity(e,t){this.executeCommand("setModelOpacity",e,t)}setModelVisibility(e,t){this.executeCommand("setModelVisibility",e,t)}setModelStyle(e,t){this.executeCommand("setModelStyle",e,t)}getModelsByType(e,t){this.executeCommand("getModelsByType",e,t)}setModelCoord(e,t){this.executeCommand("setModelCoord",e,t)}getModelArticulation(e,t){this.executeCommand("getModelArticulation",e,t)}setModelArticulation(e,t){this.executeCommand("setModelArticulation",e,t)}getModelAnimation(e,t){this.executeCommand("getModelAnimation",e,t)}setModelAnimation(e,t){this.executeCommand("setModelAnimation",e,t)}playModelAnimation(e,t){this.executeCommand("playModelAnimation",e,t)}addModelTip(e,t){const r=this.buildCommandCallbackId();if(e.divId){const t=this._checkCanAddHTMLTip(`${e.id}`,e.divId);if(t)return t;this.tempTipMap.set(`${e.id}`,{divId:e.divId,isShowClose:e.isShowClose,size:e.size,offset:e.offset,callbackId:r})}this.executeCommand("addModelTip",e,t,r)}rotatingModel(e,t){e.durationX<0||e.durationY<0||e.durationZ<0?t&&t({result:0,message:"旋转周期应为非负数。"}):"clockwise"!=e.directionX&&"counterclockwise"!=e.directionX||"clockwise"!=e.directionY&&"counterclockwise"!=e.directionY||"clockwise"!=e.directionZ&&"counterclockwise"!=e.directionZ?t&&t({result:0,message:"旋转方向只能为 clockwise（顺时针方向） 或 counterclockwise（逆时针方向）"}):this.executeCommand("rotatingModel",e,t)}setModelRotationState(e,t){states[e.state]?this.executeCommand("setModelRotationState",e,t):t&&t({result:0,message:`失败，持续旋转状态 ${e.state} 暂不支持。`})}blinkingModel(e,t){e.duration<=0?t&&t({result:0,message:"闪烁周期应为正数。"}):"default"==e.type?this.executeCommand("blinkingModel",e,t):t&&t({result:0,message:"闪烁风格目前只支持default"})}setModelBlinkState(e,t){states[e.state]?this.executeCommand("setModelBlinkState",e,t):t&&t({result:0,message:`失败，持续闪烁状态 ${e.state} 暂不支持。`})}movingModel(e,t){loopModes[e.loopMode]?this.executeCommand("movingModel",e,t):t&&t({result:0,message:`失败，循环模式 ${e.loopMode} 不支持。`})}setModelMoveState(e,t){states[e.state]?this.executeCommand("setModelMoveState",e,t):t&&t({result:0,message:`失败，持续移动状态 ${e.state} 暂不支持。`})}pathingModel(e,t){loopModes[e.loopMode]?pathDirections[e.direction]?this.executeCommand("pathingModel",e,t):t&&t({result:0,message:`失败，沿路径调整方向 ${e.direction} 不支持。`}):t&&t({result:0,message:`失败，循环模式 ${e.loopMode} 不支持。`})}setModelPathingState(e,t){states[e.state]?this.executeCommand("setModelPathingState",e,t):t&&t({result:0,message:`失败，持续移动状态 ${e.state} 暂不支持。`})}showBuildingFloor(e,t){null==e.animation||1==e.animation?this.executeCommand("showBuildingFloor",e,t):t&&t({result:0,message:"失败，animation 属性值错误。"})}resetBuildingFloor(e,t){null==e.animation||1==e.animation?this.executeCommand("resetBuildingFloor",e,t):t&&t({result:0,message:"失败，animation 属性值错误。"})}highlightBuilding(e,t){"style1"==e.type||"none"==e.type?this.executeCommand("highlightBuilding",e,t):t&&t({result:0,message:"高亮风格目前只支持style1"})}highlightFloor(e,t){"style1"==e.type||"none"==e.type?this.executeCommand("highlightFloor",e,t):t&&t({result:0,message:"高亮风格目前只支持style1"})}highlightRoom(e,t){"style1"==e.type||"none"==e.type?this.executeCommand("highlightRoom",e,t):t&&t({result:0,message:"高亮风格目前只支持style1"})}getBuildings(e,t){this.executeCommand("getBuildings",e,t)}addSection(e,t){this.executeCommand("addSection",e,t)}removeSection(e,t){this.executeCommand("removeSection",e,t)}updateSection(e,t){this.executeCommand("updateSection",e,t)}setSectionState(e,t){this.executeCommand("setSectionState",e,t)}setFirework(e,t){this.executeCommand("setFirework",e,t)}rotateCamera(e,t){e.duration<=0?t&&t({result:0,message:"失败，飞行时间无效。"}):this.executeCommand("rotateCamera",e,t)}getLandmarkScreenPosition(e,t){this.executeCommand("getLandmarkScreenPosition",e,t)}setResolutionInnerMethod(e,t){if(e.rateMax&&(e.rateMax=1024*e.rateMax),e.width=parseInt(e.width)>3840?3840:e.width,e.height=parseInt(e.height)>2160?2160:e.height,streamingDOM.style.width=e.width+"px",streamingDOM.style.height=e.height+"px",streamingDOM.parentElement.style.width=e.width+"px",streamingDOM.parentElement.style.height=e.height+"px",this.executeCommand("setResolution",e,t),this.events.onResolutionChange)for(let e of this.events.onResolutionChange)e({width:streamingDOM.style.width,height:streamingDOM.style.height})}setResolution(e,t){if(e.width&&("number"!=typeof e.width||e.width<0))t&&t({result:0,message:"失败，width 属性值错误。"});else if(e.height&&("number"!=typeof e.height||e.height<0))t&&t({result:0,message:"失败，height 属性值错误。"});else if(e.rateMax&&("number"!=typeof e.rateMax||e.rateMax<0))t&&t({result:0,message:"失败，rateMax 属性值错误。"});else if(e.fpsMax&&("number"!=typeof e.fpsMax||e.fpsMax<0))t&&t({result:0,message:"失败，fpsMax 属性值错误。"});else if(e.width&&e.height&&(e.width>this.maxWidth||e.height>this.maxHeight))t&&t({result:0,message:"失败，分辨率宽高超过该场景最大分辨率。"});else if(this.isShareToken)t&&t({result:0,message:"失败，共享模式不支持设置分辨率。"});else if(e.rateMax&&(e.rateMax=1024*e.rateMax),streamingDOM.style.width=e.width+"px",streamingDOM.style.height=e.height+"px",streamingDOM.parentElement.style.width=e.width+"px",streamingDOM.parentElement.style.height=e.height+"px",this.executeCommand("setResolution",e,t),this.events.onResolutionChange)for(let e of this.events.onResolutionChange)e({width:streamingDOM.style.width,height:streamingDOM.style.height})}focusByLayer(e,t){this.checkOverlayTypeExist(e.layerType)?this.executeCommand("focusByLayer",e,t):this.returnOverlayTypeError(t)}focusByLegend(e,t){if(!this.checkOverlayTypeExist(e.layerType))return void this.returnOverlayTypeError(t);let r=e.layerType.toLowerCase();r===_OVERLAY_LANDMARK_LAYER||r===_OVERLAY_BUBBLE_LAYER||r===_OVERLAY_TRAIL_LAYER||r===_OVERLAY_ODLINE_LAYER||r===_OVERLAY_TYPE_AREA_LAYER?this.executeCommand("focusByLegend",e,t):t&&t({result:0,message:"失败，覆盖物类型没有图例。"})}focusModel(e,t){this.executeCommand("focusModel",e,t)}getBaseCenter(e,t){this.executeCommand("getBaseCenter",e,t)}getDefaultBaseCenter(e,t){this.executeCommand("getDefaultBaseCenter",e,t)}setLogMode(e,t){"boolean"==typeof e.mode?logger&&(logger.setLogMode(e.mode),t({result:1,message:`日志模式设置成功! 当前mode ${e.mode} 。`})):t({result:0,message:"参数不合法 参数 mode 为布尔值"})}setOverlayTypeVisibility(e,t){this.checkOverlayTypeExist(e.overlayType)?this.executeCommand("setOverlayTypeVisibility",e,t):this.returnOverlayTypeError(t)}getOverlaysByType(e,t){this.checkOverlayTypeExist(e.overlayType)?this.executeCommand("getOverlaysByType",e,t):this.returnOverlayTypeError(t)}getOverlaysByLayer(e,t){this.executeCommand("getOverlaysByLayer",e,t)}selectOverlay(e,t){this.checkOverlayTypeExist(e.overlayType)?this.executeCommand("selectOverlay",e,t):this.returnOverlayTypeError(t)}endSelectOverlay(e,t){this.executeCommand("endSelectOverlay",e,t)}pickOverlay(e,t){this.checkOverlayTypeExist(e.overlayType)?clickTypes[e.type]?this.executeCommand("pickOverlay",e,t):t&&t({result:0,message:"失败，单选模式错误。"}):this.returnOverlayTypeError(t)}endPickOverlay(e,t){this.checkOverlayTypeExist(e.overlayType)?!e.type||""==e.type||clickTypes[e.type]?this.executeCommand("endPickOverlay",e,t):t&&t({result:0,message:"失败，单选模式错误。"}):this.returnOverlayTypeError(t)}clickOverlayType(e,t){this.checkOverlayTypeExist(e.overlayType)?this.executeCommand("clickOverlayType",e,t):this.returnOverlayTypeError(t)}clearOverlaySelected(e,t){this.executeCommand("clearOverlaySelected",e,t)}addTrackLayer(e,t){this.executeCommand("addTrackLayer",e,t)}updateTrackLayerCoord(e,t){this.executeCommand("updateTrackLayerCoord",e,t)}updateTrackLayerStyle(e,t){this.executeCommand("updateTrackLayerStyle",e,t)}selectModel(e,t){circleTypes[e.type]?this.executeCommand("selectModel",e,t):t&&t({result:0,message:`失败，框选模式 ${e.type} 无效。`})}endSelectModel(e,t){this.executeCommand("endSelectModel",e,t)}pickModel(e,t){clickTypes[e.type]?this.executeCommand("pickModel",e,t):t&&t({result:0,message:`失败，单选模式 ${e.type} 不匹配。`})}endPickModel(e,t){this.executeCommand("endPickModel",e,t)}clickModel(e,t){this.executeCommand("clickModel",e,t)}clickModelType(e,t){this.executeCommand("clickModelType",e,t)}clearModelSelected(e,t){this.executeCommand("clearModelSelected",e,t)}addOverlayTip(e,t){if(!this.checkOverlayTypeExist(e.overlayType))return void this.returnOverlayTypeError(t);const r=this.buildCommandCallbackId();if(e.divId){const t=this._checkCanAddHTMLTip(`${e.id}#${e.overlayType}`,e.divId);if(t)return t;this.tempTipMap.set(`${e.id}#${e.overlayType}`,{divId:e.divId,isShowClose:e.isShowClose,size:e.size,offset:e.offset,callbackId:r})}this.executeCommand("addOverlayTip",e,t,r)}checkApi(e){var t=[],r=this;e.forEach((e=>{null==r[e]&&t.push(e)})),logger.debug(t)}addHeatMapLayer(e,t){if("number"!=typeof e.alpha||e.alpha<0||e.alpha>1)t&&t({result:0,message:"失败，alpha 属性值错误。"});else if("default"==e.type||"dot"==e.type){var r=this.checkMinMaxValue(e.valueMin,e.valueMax,"valueMin","valueMax");r.ok?this.executeCommand("addHeatMapLayer",e,t):t&&t(r.data)}else t&&t({result:0,message:"失败，type 属性值错误。"})}playAnimation(e,t){this.executeCommand("playAnimation",e,t)}switchScene(e,t){this.executeCommand("switchScene",e,t)}focusModelByType(e,t){this.executeCommand("focusModelByType",e,t)}removeOverlayTip(e,t){if(!this.checkOverlayTypeExist(e.overlayType))return void this.returnOverlayTypeError(t);const r=this.buildCommandCallbackId();this.tooltipMap.has(`${e.id}#${e.overlayType}`)&&this.deleteTipMap.set(`${e.id}#${e.overlayType}`,r),this.executeCommand("removeOverlayTip",e,t,r)}removeModelTip(e,t){const r=this.buildCommandCallbackId();this.tooltipMap.has(e.id)&&this.deleteTipMap.set(e.id,r),this.executeCommand("removeModelTip",e,t,r)}updateAggLandmarkLayerCoord(e,t){var r=this;if(!streamingDOM)return;let n={id:e.id,isAppend:e.isAppend,conversationId:r.conversationId,data:e.data};Util.fetchJSON(`${r.aggServerUrl}/UpdateAggLandmarkLayerCoord`,"post",[{key:"Content-Type",value:"application/json"}],n).then((n=>{logger.debug(n);let i={id:e.id,conversationId:r.conversationId};i.callbackId=Util.guid();let a=this.callbackMap.get("updateAggLandmarkLayerCoord");a||(this.callbackMap.set("updateAggLandmarkLayerCoord",new Map),a=this.callbackMap.get("updateAggLandmarkLayerCoord")),a.set(i.callbackId,t);var o={updateAggLandmarkLayerCoord:!0,params:i};streamingDOM.emitDescriptor(o)})).catch((e=>{r.logger.debug(e)}))}addAggData(e,t){if(!streamingDOM)return;let r=this;e.aggRadius&&(e.radius=e.aggRadius),Util.fetchJSON(`${r.aggServerUrl}/V3.1/AddAggData`,"post",[{key:"Content-Type",value:"application/json"}],e).then((e=>{let r={result:1,message:"添加数据成功。"};1!==(e=JSON.parse(e)).code&&(r.result=0,r.message=`添加数据失败(${e.message})！`),t(r)})).catch((e=>{r.logger.error(e),t({result:0,message:"添加数据失败！"})}))}addPointData(e,t){if(!streamingDOM)return;let r=this;e.channelId=this.channelId,Util.fetchJSON(`${r.aggServerUrl}/AddPointData`,"post",[{key:"Content-Type",value:"application/json"}],e).then((e=>{let n={result:1,message:"添加数据成功。"};1!==(e=JSON.parse(e)).code?(n.result=0,n.message=`添加数据失败(${e.message})！`):r.executeCommand("updateLayerData",{data:e.layers}),t(n)})).catch((e=>{r.logger.error(e),t({result:0,message:"添加数据失败！"})}))}async addAggLandmarkLayer(e,t){let r=await this.serverSocket.invoke("GetAggregationServiceAddress");if(e.aggServer=r.data,e.channelId=this.channelId,e.aggMaxMapLevel<0||e.aggMaxMapLevel>20)return void(t&&t({result:0,message:"失败，aggMaxMapLevel 属性值错误。"}));let n=this;try{let r=await Util.fetchJSON(`${n.aggServerUrl}/RecordLayers`,"post",[{key:"Content-Type",value:"application/json"}],{channelId:n.channelId,id:e.aggDataId,layerId:e.id,layerType:"aggLandmarkLayer",aggRadius:e.aggRadius,aggType:e.aggType});if(r=JSON.parse(r),111===r.code)return void t({result:0,message:`数据服务中不包含id为${e.aggDataId}的数据`})}catch(e){this.logger.error("记录图层失败",e)}this.executeCommand("addAggLandmarkLayer",e,t)}async addAgg3DColumnLayer(e,t){let r=await this.serverSocket.invoke("GetAggregationServiceAddress");if(e.aggServer=r.data,e.channelId=this.channelId,e.aggMaxMapLevel<0||e.aggMaxMapLevel>20)return void(t&&t({result:0,message:"失败，aggMaxMapLevel 属性值错误。"}));let n=this;try{let r=await Util.fetchJSON(`${n.aggServerUrl}/RecordLayers`,"post",[{key:"Content-Type",value:"application/json"}],{channelId:n.channelId,id:e.aggDataId,layerId:e.id,layerType:"agg3DColumnLayer",aggRadius:e.aggRadius,aggType:e.aggType});if(r=JSON.parse(r),111===r.code)return void t({result:0,message:`数据服务中不包含id为${e.aggDataId}的数据`})}catch(e){this.logger.error("记录图层失败",e)}this.executeCommand("addAgg3DColumnLayer",e,t)}async addAggBubbleLayer(e,t){let r=await this.serverSocket.invoke("GetAggregationServiceAddress");if(e.aggServer=r.data,e.channelId=this.channelId,e.aggMaxMapLevel<0||e.aggMaxMapLevel>20)return void(t&&t({result:0,message:"失败，aggMaxMapLevel 属性值错误。"}));let n=this;try{let r=await Util.fetchJSON(`${n.aggServerUrl}/RecordLayers`,"post",[{key:"Content-Type",value:"application/json"}],{channelId:n.channelId,id:e.aggDataId,layerId:e.id,layerType:"aggBubbleLayer",aggRadius:e.aggRadius,aggType:e.aggType});if(r=JSON.parse(r),111===r.code)return void t({result:0,message:`数据服务中不包含id为${e.aggDataId}的数据`})}catch(e){this.logger.error("记录图层失败",e)}this.executeCommand("addAggBubbleLayer",e,t)}async addAgg3DGridLayer(e,t){let r=await this.serverSocket.invoke("GetAggregationServiceAddress");if(e.aggServer=r.data,e.channelId=this.channelId,e.aggMaxMapLevel<0||e.aggMaxMapLevel>20)return void(t&&t({result:0,message:"失败，aggMaxMapLevel 属性值错误。"}));let n=this;try{let r=await Util.fetchJSON(`${n.aggServerUrl}/RecordLayers`,"post",[{key:"Content-Type",value:"application/json"}],{channelId:n.channelId,id:e.aggDataId,layerId:e.id,layerType:"agg3DGridLayer",aggRadius:e.aggRadius,aggType:e.aggType});if(r=JSON.parse(r),111===r.code)return void t({result:0,message:`数据服务中不包含id为${e.aggDataId}的数据`})}catch(e){this.logger.error("记录图层失败",e)}this.executeCommand("addAgg3DGridLayer",e,t)}updateAggData(e,t){if(!streamingDOM)return;let r=this;Util.fetchJSON(`${r.aggServerUrl}/V3.1/UpdateAggData`,"post",[{key:"Content-Type",value:"application/json"}],e).then((e=>{let r={result:1,message:"更新数据成功。"};1!==(e=JSON.parse(e)).code&&(r.result=0,r.message=`更新数据失败(${e.message})！`),t(r)})).catch((e=>{r.logger.error(e),t({result:0,message:"更新数据失败！"})}))}updatePointData(e,t){if(!streamingDOM)return;let r=this;e.channelId=this.channelId,Util.fetchJSON(`${r.aggServerUrl}/UpdatePointData`,"post",[{key:"Content-Type",value:"application/json"}],e).then((e=>{let n={result:1,message:"更新数据成功。"};1!==(e=JSON.parse(e)).code?(n.result=0,n.message=`更新数据失败(${e.message})！`):r.executeCommand("updateLayerData",{data:e.layers}),t(n)})).catch((e=>{r.logger.error(e),t({result:0,message:"更新数据失败！"})}))}updateAggLandmarkLayerStyle(e,t){this.executeCommand("updateAggLandmarkLayerStyle",e,t)}updateAgg3DColumnLayerStyle(e,t){this.executeCommand("updateAgg3DColumnLayerStyle",e,t)}updateAggBubbleLayerStyle(e,t){this.executeCommand("updateAggBubbleLayerStyle",e,t)}updateAgg3DGridLayerStyle(e,t){this.executeCommand("updateAgg3DGridLayerStyle",e,t)}countAggData(e,t){if(!streamingDOM)return;let r=this;Util.fetchJSON(`${r.aggServerUrl}/V3.1/CountAggData/${e.id}`,"get").then((e=>{let r={result:1,message:"成功。",count:(e=JSON.parse(e)).data};1!==e.code&&(r.result=0,r.message=`查询失败(${e.message})！`),t(r)})).catch((e=>{r.logger.error(e),t({result:0,message:"查询失败"})}))}countPointData(e,t){if(!streamingDOM)return;let r=this;Util.fetchJSON(`${r.aggServerUrl}/CountPointData/${e.id}/${this.channelId}`,"get").then((e=>{let r={result:1,message:"成功。",count:(e=JSON.parse(e)).data};1!==e.code&&(r.result=0,r.message=`查询失败(${e.message})！`),t(r)})).catch((e=>{r.logger.error(e),t({result:0,message:"查询失败"})}))}searchDataByPoint(e,t){if(!streamingDOM)return;let r=this;e.channelId=this.channelId,Util.fetchJSON(`${r.aggServerUrl}/SearchDataByPoint`,"post",[{key:"Content-Type",value:"application/json"}],e).then((e=>{let r={result:1,message:"成功。"};1!==(e=JSON.parse(e)).code?(r.result=0,r.message=`查询数据失败(${e.message})！`):r.datas=e.data,t(r)})).catch((e=>{r.logger.error(e),t({result:0,message:"查询数据失败"})}))}searchDataByArea(e,t){if(!streamingDOM)return;let r=this;e.channelId=this.channelId,Util.fetchJSON(`${r.aggServerUrl}/SearchDataByArea`,"post",[{key:"Content-Type",value:"application/json"}],e).then((e=>{let r={result:1,message:"成功。"};1!==(e=JSON.parse(e)).code?(r.result=0,r.message=`查询数据失败(${e.message})！`):r.datas=e.data,t(r)})).catch((e=>{r.logger.error(e),t({result:0,message:"查询数据失败"})}))}searchDataByPath(e,t){if(!streamingDOM)return;let r=this;e.channelId=this.channelId,Util.fetchJSON(`${r.aggServerUrl}/SearchDataByPath`,"post",[{key:"Content-Type",value:"application/json"}],e).then((e=>{let r={result:1,message:"成功。"};1!==(e=JSON.parse(e)).code?(r.result=0,r.message=`查询数据失败(${e.message})！`):r.datas=e.data,t(r)})).catch((e=>{r.logger.error(e),t({result:0,message:"查询数据失败"})}))}removeAggData(e,t){if(!streamingDOM)return;let r=this;Util.fetchJSON(`${r.aggServerUrl}/V3.1/RemoveAggData`,"post",[{key:"Content-Type",value:"application/json"}],e).then((e=>{let r={result:1,message:"删除成功。"};1!==(e=JSON.parse(e)).code&&(r.result=0,r.message=`删除数据失败(${e.message})！`),t(r)})).catch((e=>{r.logger.error(e),t({result:0,message:"删除数据失败！"})}))}removePointData(e,t){if(!streamingDOM)return;let r=this;Util.fetchJSON(`${r.aggServerUrl}/V3.1/RemovePointData`,"post",[{key:"Content-Type",value:"application/json"}],e).then((e=>{let r={result:1,message:"删除成功。"};1!==(e=JSON.parse(e)).code&&(r.result=0,r.message=`删除数据失败(${e.message})！`),t(r)})).catch((e=>{r.logger.error(e),t({result:0,message:"删除数据失败！"})}))}removeData(e,t){if(!streamingDOM)return;let r=this;e.channelId=this.channelId,Util.fetchJSON(`${r.aggServerUrl}/RemoveData`,"post",[{key:"Content-Type",value:"application/json"}],e).then((e=>{let n={result:1,message:"删除成功。"};1!==(e=JSON.parse(e)).code?(n.result=0,n.message=`删除数据失败(${e.message})！`):r.executeCommand("updateLayerData",{data:e.layers}),t(n)})).catch((e=>{r.logger.error(e),t({result:0,message:"删除数据失败！"})}))}removeAllAggData(e,t){if(!streamingDOM)return;let r=this;Util.fetchJSON(`${r.aggServerUrl}/V3.1/RemoveAllAggData/${e.id}`,"delete").then((e=>{let r={result:1,message:"成功。"};1!==(e=JSON.parse(e)).code&&(r.result=0,r.message=`删除失败(${e.message})！`),t(r)})).catch((e=>{r.logger.error(e),t({result:0,message:"删除失败"})}))}removeAllPointData(e,t){if(!streamingDOM)return;let r=this;Util.fetchJSON(`${r.aggServerUrl}/V3.1/RemoveAllPointData/${e.id}`,"delete").then((e=>{let r={result:1,message:"成功。"};1!==(e=JSON.parse(e)).code&&(r.result=0,r.message=`删除失败(${e.message})！`),t(r)})).catch((e=>{r.logger.error(e),t({result:0,message:"删除失败"})}))}removeAllData(e,t){if(!streamingDOM)return;let r=this;Util.fetchJSON(`${r.aggServerUrl}/RemoveAllData/${e.id}/${this.channelId}`,"delete").then((e=>{let n={result:1,message:"成功。"};1!==(e=JSON.parse(e)).code?(n.result=0,n.message=`删除失败(${e.message})！`):r.executeCommand("updateLayerData",{data:e.layers}),t(n)})).catch((e=>{r.logger.error(e),t({result:0,message:"删除失败"})}))}async addModelTrailLayer(e,t){let r=await this.serverSocket.invoke("GetAggregationServiceAddress");e.modelTrailServer=r.data,e.channelId=this.channelId,this.executeCommand("addModelTrailLayer",e,t)}updateModelTrailLayerCoord(e,t){this.executeCommand("updateModelTrailLayerCoord",e,t)}updateModelTrailLayerStyle(e,t){this.executeCommand("updateModelTrailLayerStyle",e,t)}async addModelTrailLayerTemp(e,t){let r=await this.serverSocket.invoke("GetAggregationServiceAddress");e.modelTrailServer=r.data,this.executeCommand("addModelTrailLayerTemp",e,t)}updateModelTrailLayerTempCoord(e,t){this.executeCommand("updateModelTrailLayerTempCoord",e,t)}updateModelTrailLayerTempStyle(e,t){this.executeCommand("updateModelTrailLayerTempStyle",e,t)}addModelTrailData(e,t){var r=this;streamingDOM&&Util.fetchJSON(`${r.aggServerUrl}/TrailData/UpdateModelTrailData`,"post",[{key:"Content-Type",value:"application/json"}],e).then((e=>{r.logger.debug(e),t({result:e.data,message:e.message})})).catch((e=>{r.logger.debug(e)}))}removeModelTrailData(e,t){var r=this;streamingDOM&&Util.fetchJSON(`${r.aggServerUrl}/TrailData/RemoveTrailData/${e.id}`,"delete").then((e=>{r.logger.debug(e),t({result:e.data,message:e.message})})).catch((e=>{r.logger.debug(e)}))}removeModelTrailCoord(e,t){this.executeCommand("removeModelTrailCoord",e,t)}followCamera(e,t){this.executeCommand("followCamera",e,t)}stopCameraFollow(e,t){this.executeCommand("stopCameraFollow",e,t)}getScenesInfo(e,t){this.executeCommand("getScenesInfo",e,t)}async addModelLandmarkLayer(e,t){let r=await this.serverSocket.invoke("GetAggregationServiceAddress");e.dataServer=r.data,e.channelId=this.channelId;let n=this;if(e.modelLandmarkDataId)try{let r=await Util.fetchJSON(`${n.aggServerUrl}/RecordLayers`,"post",[{key:"Content-Type",value:"application/json"}],{channelId:n.channelId,id:e.modelLandmarkDataId,layerId:e.id,layerType:"modelLandmarkLayer"});if(r=JSON.parse(r),111===r.code)return void t({result:0,message:`数据服务中不包含id为${e.modelLandmarkDataId}的数据`})}catch(e){this.logger.error("记录图层失败",e)}this.executeCommand("addModelLandmarkLayer",e,t)}updateModelLandmarkLayerCoord(e,t){this.executeCommand("updateModelLandmarkLayerCoord",e,t)}updateModelLandmarkLayerStyle(e,t){this.executeCommand("updateModelLandmarkLayerStyle",e,t)}addModelLandmarkLayerTemp(e,t){this.executeCommand("addModelLandmarkLayerTemp",e,t)}updateModelLandmarkLayerTempCoord(e,t){this.executeCommand("updateModelLandmarkLayerTempCoord",e,t)}updateModelLandmarkLayerTempStyle(e,t){this.executeCommand("updateModelLandmarkLayerTempStyle",e,t)}setSceneEffect(e,t){e.lightPower&&("number"!=typeof e.lightPower||e.lightPower<=0||e.lightPower>10)?t&&t({result:0,message:"lightPower 属性值错误。 值域范围 0.0-10.0"}):(this.updateTipDelay=e.divTipMovingDelay??200,this.executeCommand("setSceneEffect",e,t))}getAppInfo(e,t){if(t){if(!streamingDOM)return void t({result:0,message:"未完成初始化。"});var r=0,n=0;this.streamingPlayerState&&(r=this.streamingPlayerState.VideoResolution.split("x")[0],n=this.streamingPlayerState.VideoResolution.split("x")[1]);let e="无流渲染服务版本信息";this.apiData.data&&this.apiData.data.version&&(e=this.apiData.data.version),t({result:1,message:"成功。",tgApiSdkVer:"3.2",tgApiDocUrl:"http://www.tuguan.net/doc/tg-api/",streamingSdkVer:"3.2.1",streamingServerVer:e,streamingEngineVer:this.streamingEngineVer,streamingWidthMax:this.apiData.data.resolutionX,streamingHeightMax:this.apiData.data.resolutionY,streamingRateMax:1024*this.apiData.data.codeRate,streamingFpsMax:this.apiData.data.frameRate,clientWidth:r,clientHeight:n})}}_getAppInfoUECallback(e,t){t.logger.info(e),e&&e.streamingEngineVer?t.streamingEngineVer=e.streamingEngineVer:t.streamingEngineVer="无渲染引擎版本信息"}initScene(e,t){this.executeCommand("initScene",e,t)}getOverlaysOrder(e,t){this.executeCommand("getOverlaysOrder",e,t)}moveOverlayForward(e,t){this.executeCommand("moveOverlayForward",e,t)}moveOverlayBackward(e,t){this.executeCommand("moveOverlayBackward",e,t)}setModelTransform2(e,t){this.executeCommand("setModelTransform2",e,t)}setCameraFollowingState(e,t){this.executeCommand("setCameraFollowingState",e,t)}setCommand(e,t){this.executeCommand("setCommand",e,t)}getClientStatus(e,t){if(t){if(this.clientStatus&&this.clientStatus.error){return void t({result:0,message:this.clientStatus.error})}t({result:1,message:"成功。",clientStatus:this.clientStatus})}}async saveClientStatus(e,t){if(t){if(!e.clientStatus){return void t({result:0,message:"失败，未设置clientStatus"})}try{var r=await this.saveClientStatusInner(e.clientStatus);if(!r){return t({result:0,message:"失败，saveClientStatus 出错!"}),void this.logger.error("失败，saveClientStatus 出错!")}if(0==r.status){t({result:1,message:"成功。"})}else{t({result:0,message:r.message})}}catch(e){t({result:0,message:"失败，saveClientStatus 出错!"+e}),this.logger.error("失败，saveClientStatus 出错!",e)}}}addLineData(e,t){if(!streamingDOM)return;let r=this;e.channelId=this.channelId,Util.fetchJSON(`${r.aggServerUrl}/RoadLineData/AddLineData`,"post",[{key:"Content-Type",value:"application/json"}],e).then((e=>{let n={result:1,message:"添加数据成功。"};1!==(e=JSON.parse(e)).code?(n.result=0,n.message=`添加数据失败(${e.message})！`):r.executeCommand("updateLayerData",{data:e.layers}),t(n)})).catch((e=>{r.logger.error(e),t({result:0,message:"添加数据失败！"})}))}updateLineData(e,t){if(!streamingDOM)return;let r=this;e.channelId=this.channelId,Util.fetchJSON(`${r.aggServerUrl}/RoadLineData/UpdateLineData`,"post",[{key:"Content-Type",value:"application/json"}],e).then((e=>{let n={result:1,message:"更新数据成功。"};1!==(e=JSON.parse(e)).code?(n.result=0,n.message=`更新数据失败(${e.message})！`):r.executeCommand("updateLayerData",{data:e.layers}),t(n)})).catch((e=>{r.logger.error(e),t({result:0,message:"更新数据失败！"})}))}updateLineDataAttribute(e,t){if(!streamingDOM)return;let r=this;e.channelId=this.channelId,Util.fetchJSON(`${r.aggServerUrl}/RoadLineData/UpdateLineDataAttribute`,"post",[{key:"Content-Type",value:"application/json"}],e).then((e=>{let n={result:1,message:"更新数据成功。"};1!==(e=JSON.parse(e)).code?(n.result=0,n.message=`更新数据失败(${e.message})！`):r.executeCommand("updateLayerData",{data:e.layers}),t(n)})).catch((e=>{r.logger.error(e),t({result:0,message:"更新数据失败！"})}))}queryLineData(e,t){if(!streamingDOM)return;let r=this;e.channelId=this.channelId,Util.fetchJSON(`${r.aggServerUrl}/RoadLineData/QueryLineData`,"post",[{key:"Content-Type",value:"application/json"}],e).then((e=>{let r={result:1,message:"查询数据成功。"};1!==(e=JSON.parse(e)).code?(r.result=0,r.message=`查询数据失败(${e.message})！`):(r.id=e.id,r.attribute=e.attribute,r.data=e.data),t(r)})).catch((e=>{r.logger.error(e),t({result:0,message:"查询数据失败！"})}))}countLineData(e,t){if(!streamingDOM)return;let r=this;e.channelId=this.channelId,Util.fetchJSON(`${r.aggServerUrl}/RoadLineData/CountLineData`,"post",[{key:"Content-Type",value:"application/json"}],e).then((e=>{let r={result:1,message:"成功。"};1!==(e=JSON.parse(e)).code?(r.result=0,r.message=`查询失败(${e.message})！`):(r.pathCount=e.data.lineCount,r.pointCount=e.data.pointCount,r.data=e.data.data),t(r)})).catch((e=>{r.logger.error(e),t({result:0,message:"查询失败"})}))}queryPointData(e,t){if(!streamingDOM)return;let r=this;e.channelId=this.channelId,Util.fetchJSON(`${r.aggServerUrl}/QueryPointData`,"post",[{key:"Content-Type",value:"application/json"}],e).then((e=>{let r={result:1,message:"查询数据成功。"};1!==(e=JSON.parse(e)).code?(r.result=0,r.message=`查询数据失败(${e.message})！`):(r.id=e.id,r.attribute=e.attribute,r.data=e.data),t(r)})).catch((e=>{r.logger.error(e),t({result:0,message:"查询数据失败！"})}))}showObjectAxis(e,t){this.executeCommand("showObjectAxis",e,t)}setModelMaterial(e,t){this.executeCommand("setModelMaterial",e,t)}executeCommand(e,t,r,n){this.checkStreamingDOM();let i=n||this.buildCommandCallbackId();this.storeCommandCallbackIdToMap(e,i,r);let a=this.buildCommand(e,t,i);this.checkMaxByteLength(e,a,r)&&this.sendCommandToUE(a)}checkStreamingDOM(){if(!streamingDOM)throw new ReferenceError("Not Find StreamingDOM")}buildCommandCallbackId(){return Util.guid()}storeCommandCallbackIdToMap(e,t,r){let n=this.callbackMap.get(e);n||(this.callbackMap.set(e,new Map),n=this.callbackMap.get(e)),n.set(t,r)}buildCommand(e,t,r){let n={params:t};return n[e]=!0,n.params.callbackId=r,n}sendCommandToUE(e){streamingDOM.emitDescriptor(e)}checkOverlayTypeExist(e){let t=e.toLowerCase();return void 0!==overlays$1[t]}returnOverlayTypeError(e){e&&e({result:0,message:"失败，覆盖物类型错误。"})}checkMinMaxValue(e,t,r,n){var i={};if(e&&t){if("number"!=typeof e)return i.ok=!1,i.data={result:0,message:`${r} 非数值类型 `},i;if("number"!=typeof t)return i.ok=!1,i.data={result:0,message:`${n} 非数值类型 `},i;if(e>t)return i.ok=!1,i.data={result:0,message:`数值不合法 ${r} 的值大于 ${n} 的值 `},i}return i.ok=!0,i}checkMaxByteLength(e,t,r){let n=2*JSON.stringify(t).length+3;if(this.logger.info(`${e} 总byte长度 ${n}`),n>131072){var i=`${e} 消息总长度 ${n/1024}kb 超出最大支持长度 128kb 无法发送！`;return this.logger.error(i),r&&r({result:0,message:"失败。"+i}),!1}return!0}_addHTMLToolTip(e,t,r,n,i,a){let o=this;if(this.tooltipMap||(this.tooltipMap=new Map,this.tooltipDivMap=new Map),this.tooltipMap.has(e))return{result:0,message:"失败，该对象已存在Tip。"};if([...this.tooltipDivMap.values()].includes(t))return{result:0,message:"失败，该divId已被使用。"};const s=new HTMLToolTipParams;s.id=e,s.container=this.container,s.divId=t,s.showCloseButton=r,s.toolTipWidth=n[0],s.toolTipHeight=n[1],s.toolTipLeftOffset=i[0],s.toolTipBottomOffset=i[1],this.updateTipDelay&&(s.updateDelay=this.updateTipDelay);const l=new HTMLToolTip(s),c=l.addToScreen();if(c)return this.logger.error("添加HTML标牌失败",c),{result:0,message:c};this.tooltipMap.set(e,l),this.tooltipDivMap.set(e,t),this.tooltipCallback.set(a,l),l.onClose=e=>{o._removeHTMLTooltip(e)}}_updateHTMLToolTipsPosition(e,t,r){let n=this;const i=[];for(const r of e)if(!t.has(r.id)){const e=this.tempTipMap.get(r.id);this._addHTMLToolTip(r.id,e.divId,e.isShowClose,e.size,e.offset,e.callbackId),this.tempTipMap.delete(r.id)}for(const[n,a]of t){const t=e.find((e=>e.id===n));t?(a.updateVisible(t.isHide),a.updatePosition(t.position[0],t.position[1])):(a.removeTooltip(),r.delete(n),i.push(n))}i.forEach((e=>{t.delete(e);const r=n.deleteTipMap.get(e);if(r){if(!n.deleteTempTipMap.has(r))return void n.deleteTempTipMap.set(r,"");if(n.deleteTipMap.delete(e),n.deleteTempTipMap.delete(r),e.includes("#")){const e=n.callbackMap.get("removeOverlayTip");e&&"function"==typeof e.get(r)&&e.get(r)({result:1,message:"成功"},n)}else{const e=n.callbackMap.get("removeModelTip");e&&"function"==typeof e.get(r)&&e.get(r)({result:1,message:"成功"},n)}}}))}_removeHTMLTooltip(e){if(this.tooltipMap.delete(e),this.tooltipDivMap.delete(e),e.includes("#")){const t=e.split("#");this.removeOverlayTip({id:t[0],overlayType:t[1]})}else this.removeModelTip({id:e})}_checkCanAddHTMLTip(e,t){if(this.tooltipMap||(this.tooltipMap=new Map,this.tooltipDivMap=new Map),this.tooltipMap.has(e))return{result:0,message:"失败，该对象已存在Tip。"};if([...this.tooltipDivMap.values()].includes(t))return{result:0,message:"失败，该divId已被使用。"};const r=document.getElementById(t);if(!r)return{result:0,message:"不存在该divId"};r.style.display="none"}}class Camera$1{constructor(e){this.behavior=e.behavior||0,this.distance=e.distance||"",this.posture=e.posture||"",this.target=e.target||""}}var util={randomString:function(e){e=e||32;for(var t="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",r=t.length,n="",i=0;i<e;i++)n+=t.charAt(Math.floor(Math.random()*r));return n},colorToRGBAObject:e=>"string"!=typeof(e=""+e)?{r:1,g:1,b:1,a:1}:("#"===e.charAt(0)&&(e=e.substring(1)),3===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),4===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]),/^[0-9a-fA-F]{6}$/.test(e)?{r:parseInt(e.substr(0,2),16)/255,g:parseInt(e.substr(2,2),16)/255,b:parseInt(e.substr(4,2),16)/255,a:1}:/^[0-9a-fA-F]{8}$/.test(e)?{r:parseInt(e.substr(0,2),16)/255,g:parseInt(e.substr(2,2),16)/255,b:parseInt(e.substr(4,2),16)/255,a:parseInt(e.substr(6,2),16)/255}:void 0),colorToRGBAString:e=>"string"!=typeof(e=""+e)?"rgba (1, 1, 1, 1)":("#"===e.charAt(0)&&(e=e.substring(1)),3===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),4===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]),/^[0-9a-fA-F]{6}$/.test(e)?`rgba (${parseInt(e.substr(0,2),16)/255}, ${parseInt(e.substr(2,2),16)/255}, ${parseInt(e.substr(4,2),16)/255}, 1)`:/^[0-9a-fA-F]{8}$/.test(e)?`rgba (${parseInt(e.substr(0,2),16)/255}, ${parseInt(e.substr(2,2),16)/255}, ${parseInt(e.substr(4,2),16)/255}, ${parseInt(e.substr(6,2),16)/255})`:void 0),randomRGBAObject:()=>({r:Math.random(),g:Math.random(),b:Math.random(),a:.5+.5*Math.random()}),randomRGBAString:()=>`rgba (${Math.random()}, ${Math.random()}, ${Math.random()}, ${.5+.5*Math.random()})`,addDegrees:(e,t)=>e&&t&&e.lon&&e.lat&&t.lon&&t.lat?{lon:e.lon+t.lon,lat:e.lat+t.lat,alt:e.alt?t.alt?e.alt+t.alt:e.alt:t.alt?t.alt:0}:{lon:0,lat:0,alt:0},unifyCoordinates(e,t){if(t){switch("surface"===e.type.toLowerCase()&&(e.type="Surface"),"ecef"===e.type.toLowerCase()&&(e.type="ECEF"),"planarglobal"===e.type.toLowerCase()&&(e.type="PlanarGlobal"),"planarlocal"===e.type.toLowerCase()&&(e.type="PlanarLocal"),"default"===e.type.toLowerCase()&&(e.type="default"),e.type.toLowerCase()){case"surface":let r=t({X:e.lon,Y:e.lat,Z:e.alt},"Surface");e.x=r.x,e.y=0-r.z,e.z=0-r.y}return e}},fetchJSON(e,t,r,n){switch(t.toLowerCase()){case"get":case"delete":case"post":case"put":break;default:t="GET"}return new Promise((function(i,a){let o=new XMLHttpRequest;if(o.onreadystatechange=function(){4==o.readyState&&(200==o.status||204==o.status?i(o.responseText):a(new Error(o.statusText)))},o.open(t,e,!1),r instanceof Array)for(let e of r)o.setRequestHeader(e.key,e.value);o.send(JSON.stringify(n))}))},getRgbaNum(e="rgba(255,255,255,0)",t){let r=e.match(/(\d(\.\d+)?)+/g);return r[t]?parseFloat(r[t]):0},syntheticImage:async(e="",t="#FFFFFF",r="")=>new Promise(((n,i)=>{(""==e&&""==r||""==r)&&n("");let a=new Image,o=new Image,s=document.createElement("canvas"),l=s.getContext("2d");""!=e?(a.onload=()=>{s.width=a.width,s.height=a.height,l.drawImage(a,0,0,s.width,s.height);let e,c=l.getImageData(0,0,s.width,s.height);e=t.indexOf("#")>-1?util.colorToRGBAObject(t):{r:util.getRgbaNum(t,0),g:util.getRgbaNum(t,1),b:util.getRgbaNum(t,2),a:util.getRgbaNum(t,3)};for(let r=0;r<c.data.length;r+=4)c.data[r+3]>0&&(c.data[r]=e.r,c.data[r+1]=e.g,c.data[r+2]=e.b,t.indexOf("rgba")>-1&&(c.data[r+3]=255*e.a));l.clearRect(0,0,s.width,s.height),l.putImageData(c,0,0),o.onload=()=>{l.drawImage(o,s.width/5,s.height/5,3*s.width/5,3*s.height/5),n(s.toDataURL())},o.onerror=()=>{i("img load error")},o.src=r},a.onerror=()=>{i("backgroundImg load error")},a.src=e):(o.onload=()=>{s.width=48,s.height=48,l.drawImage(o,s.width/5,s.height/5,3*s.width/5,3*s.height/5),n(s.toDataURL())},o.onerror=()=>{i("img load error")},o.src=r)}))};class Drawable{constructor(e,t){return this.children=[],this.context=e.context||"",this.instance=e.instance||"",this.option=e.option||"",this.name=e.name||util.randomString(8),this.parent=e.parent||"",this.tags=e.tags||[],this.type=e.type||"",this.zLevel="number"==typeof e.zLevel?e.zLevel:0,this._x=0,this._y=0,this._z=0,t&&t(1),this}addChild(e){return this.children.push(e),this}convertLLAToXYZ(e,t,r){if(e&&"lla"===e.type.toLowerCase())if(t){let t=this.context.convertLLAToXYZ({x:e.lon+Number(r.lonOffset?r.lonOffset:0),y:e.lat+Number(r.latOffset?r.latOffset:0),z:e.alt+Number(r.altOffset?r.altOffset:0)});e.x=t.x,e.y=t.y,e.z=t.z}else{let t=this.context.convertLLAToXYZ({x:e.lon,y:e.lat,z:e.alt});e.x=t.x,e.y=t.y,e.z=t.z}return e}generateLableCanvas(e,t,r,n,i,a,o){let s=document.createElement("canvas"),l=s.getContext("2d");var c=8*t,h="";n&&(h="italic");var u="";return r&&(u="bold"),l.font=`${h} ${u} ${c}px ${e}`,l.textAlign="center",l.textBaseline="middle",s.width=l.measureText(o).width+c,s.height=2*c,l.fillStyle=i,l.fillRect(0,0,s.width,s.height),l.font=`${h} ${u} ${c}px ${e}`,l.fillStyle=a,l.textAlign="center",l.textBaseline="middle",l.fillText(o,s.width/2,s.height/2),s}getChildren(){return this.children}getFullName(){return`${this.parent}/${this.name}/${this.type}`}getXyz(){return{x:this._x,y:this._y,z:this._z}}hasChild(){return this.children.length>0}saveXyz(e){return this._x=e.x,this._y=e.y,this._z=e.z,this}updateZLevel(e){let t=!1;return"function"==typeof this.context.updateDrawableRenderOrder&&(t=this.context.updateDrawableRenderOrder(this.getFullName(),e),t&&(this.zLevel=e)),t}toString(){return this.toString()}}class Layer$1{constructor(e,t){this.tags=e.tags||[],this.name=e.name||"",this.type=e.type||"",this.zLevel="number"==typeof e.zLevel?e.zLevel:0,this._drawables=[],t&&t(1)}action(e,t){return t&&t(1),this}addDrawable(e,t){return e.name&&""!==e.name||(e.name=util.randomString(8)),this.getDrawable(e.name)?(t&&t(0,`已存在同名绘制物（${e.name}) `),this):(e.parent=this.name,this._drawables.push(e),t&&t(1,"成功"),this)}clearDrawables(e){return this._drawables=[],e&&e(1,"成功"),this}getDrawable(e){for(let t of this._drawables)if(t.name.toString()===e.toString())return t}getDrawablePosition(e){if("instanced"===this.type.toLowerCase()&&1===this._drawables.length){for(let t of this._drawables[0].points)if(t.name.toString()===e.toString())return t}else for(let t of this._drawables)if(t.name.toString()===e.toString())return t}getDrawables(){return this._drawables}hide(){return this}removeDrawable(e,t){for(let r=0;r<this._drawables.length;r++)if(this._drawables[r].name===e)return this._drawables.splice(r,1),t&&t(1),this;return t&&t(0,`未找到名为 ${e} 的绘制物`),this}resetAction(){return callback&&callback(1),this}show(){return this}updateZLevel(e){let t=!1;for(let r=0;r<this._drawables.length;r++)t=t||!this._drawables[r].updateZLevel(e);return t||(this.zLevel=e),!t}tag(e,t){return this.tags.push(""),this}toJson(){return JSON.stringify(this._drawables)}toString(){return""}}class Position{constructor(e){this.alt=0,this.lat=0,this.lon=0,this.type=e&&"lla"===e.toLowerCase()?e:"xyz",this.x=0,this.y=0,this.z=0}set(e,t,r){switch(this.type.toLowerCase()){case"lla":this.lon=Number(e),this.lat=Number(t),this.alt=Number(r);break;default:this.x=Number(e),this.y=Number(t),this.z=Number(r)}return this}toString(){return JSON.stringify(this)}}Position.Zero=function(e){return new Position(e)};const REVISION="126",MOUSE={LEFT:0,MIDDLE:1,RIGHT:2,ROTATE:0,DOLLY:1,PAN:2},TOUCH={ROTATE:0,PAN:1,DOLLY_PAN:2,DOLLY_ROTATE:3},CullFaceNone=0,CullFaceBack=1,CullFaceFront=2,CullFaceFrontBack=3,BasicShadowMap=0,PCFShadowMap=1,PCFSoftShadowMap=2,VSMShadowMap=3,FrontSide=0,BackSide=1,DoubleSide=2,FlatShading=1,SmoothShading=2,NoBlending=0,NormalBlending=1,AdditiveBlending=2,SubtractiveBlending=3,MultiplyBlending=4,CustomBlending=5,AddEquation=100,SubtractEquation=101,ReverseSubtractEquation=102,MinEquation=103,MaxEquation=104,ZeroFactor=200,OneFactor=201,SrcColorFactor=202,OneMinusSrcColorFactor=203,SrcAlphaFactor=204,OneMinusSrcAlphaFactor=205,DstAlphaFactor=206,OneMinusDstAlphaFactor=207,DstColorFactor=208,OneMinusDstColorFactor=209,SrcAlphaSaturateFactor=210,NeverDepth=0,AlwaysDepth=1,LessDepth=2,LessEqualDepth=3,EqualDepth=4,GreaterEqualDepth=5,GreaterDepth=6,NotEqualDepth=7,MultiplyOperation=0,MixOperation=1,AddOperation=2,NoToneMapping=0,LinearToneMapping=1,ReinhardToneMapping=2,CineonToneMapping=3,ACESFilmicToneMapping=4,CustomToneMapping=5,UVMapping=300,CubeReflectionMapping=301,CubeRefractionMapping=302,EquirectangularReflectionMapping=303,EquirectangularRefractionMapping=304,CubeUVReflectionMapping=306,CubeUVRefractionMapping=307,RepeatWrapping=1e3,ClampToEdgeWrapping=1001,MirroredRepeatWrapping=1002,NearestFilter=1003,NearestMipmapNearestFilter=1004,NearestMipMapNearestFilter=1004,NearestMipmapLinearFilter=1005,NearestMipMapLinearFilter=1005,LinearFilter=1006,LinearMipmapNearestFilter=1007,LinearMipMapNearestFilter=1007,LinearMipmapLinearFilter=1008,LinearMipMapLinearFilter=1008,UnsignedByteType=1009,ByteType=1010,ShortType=1011,UnsignedShortType=1012,IntType=1013,UnsignedIntType=1014,FloatType=1015,HalfFloatType=1016,UnsignedShort4444Type=1017,UnsignedShort5551Type=1018,UnsignedShort565Type=1019,UnsignedInt248Type=1020,AlphaFormat=1021,RGBFormat=1022,RGBAFormat=1023,LuminanceFormat=1024,LuminanceAlphaFormat=1025,RGBEFormat=RGBAFormat,DepthFormat=1026,DepthStencilFormat=1027,RedFormat=1028,RedIntegerFormat=1029,RGFormat=1030,RGIntegerFormat=1031,RGBIntegerFormat=1032,RGBAIntegerFormat=1033,RGB_S3TC_DXT1_Format=33776,RGBA_S3TC_DXT1_Format=33777,RGBA_S3TC_DXT3_Format=33778,RGBA_S3TC_DXT5_Format=33779,RGB_PVRTC_4BPPV1_Format=35840,RGB_PVRTC_2BPPV1_Format=35841,RGBA_PVRTC_4BPPV1_Format=35842,RGBA_PVRTC_2BPPV1_Format=35843,RGB_ETC1_Format=36196,RGB_ETC2_Format=37492,RGBA_ETC2_EAC_Format=37496,RGBA_ASTC_4x4_Format=37808,RGBA_ASTC_5x4_Format=37809,RGBA_ASTC_5x5_Format=37810,RGBA_ASTC_6x5_Format=37811,RGBA_ASTC_6x6_Format=37812,RGBA_ASTC_8x5_Format=37813,RGBA_ASTC_8x6_Format=37814,RGBA_ASTC_8x8_Format=37815,RGBA_ASTC_10x5_Format=37816,RGBA_ASTC_10x6_Format=37817,RGBA_ASTC_10x8_Format=37818,RGBA_ASTC_10x10_Format=37819,RGBA_ASTC_12x10_Format=37820,RGBA_ASTC_12x12_Format=37821,RGBA_BPTC_Format=36492,SRGB8_ALPHA8_ASTC_4x4_Format=37840,SRGB8_ALPHA8_ASTC_5x4_Format=37841,SRGB8_ALPHA8_ASTC_5x5_Format=37842,SRGB8_ALPHA8_ASTC_6x5_Format=37843,SRGB8_ALPHA8_ASTC_6x6_Format=37844,SRGB8_ALPHA8_ASTC_8x5_Format=37845,SRGB8_ALPHA8_ASTC_8x6_Format=37846,SRGB8_ALPHA8_ASTC_8x8_Format=37847,SRGB8_ALPHA8_ASTC_10x5_Format=37848,SRGB8_ALPHA8_ASTC_10x6_Format=37849,SRGB8_ALPHA8_ASTC_10x8_Format=37850,SRGB8_ALPHA8_ASTC_10x10_Format=37851,SRGB8_ALPHA8_ASTC_12x10_Format=37852,SRGB8_ALPHA8_ASTC_12x12_Format=37853,LoopOnce=2200,LoopRepeat=2201,LoopPingPong=2202,InterpolateDiscrete=2300,InterpolateLinear=2301,InterpolateSmooth=2302,ZeroCurvatureEnding=2400,ZeroSlopeEnding=2401,WrapAroundEnding=2402,NormalAnimationBlendMode=2500,AdditiveAnimationBlendMode=2501,TrianglesDrawMode=0,TriangleStripDrawMode=1,TriangleFanDrawMode=2,LinearEncoding=3e3,sRGBEncoding=3001,GammaEncoding=3007,RGBEEncoding=3002,LogLuvEncoding=3003,RGBM7Encoding=3004,RGBM16Encoding=3005,RGBDEncoding=3006,BasicDepthPacking=3200,RGBADepthPacking=3201,TangentSpaceNormalMap=0,ObjectSpaceNormalMap=1,ZeroStencilOp=0,KeepStencilOp=7680,ReplaceStencilOp=7681,IncrementStencilOp=7682,DecrementStencilOp=7683,IncrementWrapStencilOp=34055,DecrementWrapStencilOp=34056,InvertStencilOp=5386,NeverStencilFunc=512,LessStencilFunc=513,EqualStencilFunc=514,LessEqualStencilFunc=515,GreaterStencilFunc=516,NotEqualStencilFunc=517,GreaterEqualStencilFunc=518,AlwaysStencilFunc=519,StaticDrawUsage=35044,DynamicDrawUsage=35048,StreamDrawUsage=35040,StaticReadUsage=35045,DynamicReadUsage=35049,StreamReadUsage=35041,StaticCopyUsage=35046,DynamicCopyUsage=35050,StreamCopyUsage=35042,GLSL1="100",GLSL3="300 es";function EventDispatcher(){}Object.assign(EventDispatcher.prototype,{addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});const r=this._listeners;void 0===r[e]&&(r[e]=[]),-1===r[e].indexOf(t)&&r[e].push(t)},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;const r=this._listeners;return void 0!==r[e]&&-1!==r[e].indexOf(t)},removeEventListener:function(e,t){if(void 0===this._listeners)return;const r=this._listeners[e];if(void 0!==r){const e=r.indexOf(t);-1!==e&&r.splice(e,1)}},dispatchEvent:function(e){if(void 0===this._listeners)return;const t=this._listeners[e.type];if(void 0!==t){e.target=this;const r=t.slice(0);for(let t=0,n=r.length;t<n;t++)r[t].call(this,e)}}});const _lut$1=[];for(let e=0;e<256;e++)_lut$1[e]=(e<16?"0":"")+e.toString(16);let _seed=1234567;const MathUtils={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,r=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return(_lut$1[255&e]+_lut$1[e>>8&255]+_lut$1[e>>16&255]+_lut$1[e>>24&255]+"-"+_lut$1[255&t]+_lut$1[t>>8&255]+"-"+_lut$1[t>>16&15|64]+_lut$1[t>>24&255]+"-"+_lut$1[63&r|128]+_lut$1[r>>8&255]+"-"+_lut$1[r>>16&255]+_lut$1[r>>24&255]+_lut$1[255&n]+_lut$1[n>>8&255]+_lut$1[n>>16&255]+_lut$1[n>>24&255]).toUpperCase()},clamp:function(e,t,r){return Math.max(t,Math.min(r,e))},euclideanModulo:function(e,t){return(e%t+t)%t},mapLinear:function(e,t,r,n,i){return n+(e-t)*(i-n)/(r-t)},lerp:function(e,t,r){return(1-r)*e+r*t},damp:function(e,t,r,n){return MathUtils.lerp(e,t,1-Math.exp(-r*n))},pingpong:function(e,t=1){return t-Math.abs(MathUtils.euclideanModulo(e,2*t)-t)},smoothstep:function(e,t,r){return e<=t?0:e>=r?1:(e=(e-t)/(r-t))*e*(3-2*e)},smootherstep:function(e,t,r){return e<=t?0:e>=r?1:(e=(e-t)/(r-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},seededRandom:function(e){return void 0!==e&&(_seed=e%2147483647),_seed=16807*_seed%2147483647,(_seed-1)/2147483646},degToRad:function(e){return e*MathUtils.DEG2RAD},radToDeg:function(e){return e*MathUtils.RAD2DEG},isPowerOfTwo:function(e){return 0==(e&e-1)&&0!==e},ceilPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},floorPowerOfTwo:function(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))},setQuaternionFromProperEuler:function(e,t,r,n,i){const a=Math.cos,o=Math.sin,s=a(r/2),l=o(r/2),c=a((t+n)/2),h=o((t+n)/2),u=a((t-n)/2),d=o((t-n)/2),p=a((n-t)/2),f=o((n-t)/2);switch(i){case"XYX":e.set(s*h,l*u,l*d,s*c);break;case"YZY":e.set(l*d,s*h,l*u,s*c);break;case"ZXZ":e.set(l*u,l*d,s*h,s*c);break;case"XZX":e.set(s*h,l*f,l*p,s*c);break;case"YXY":e.set(l*p,s*h,l*f,s*c);break;case"ZYZ":e.set(l*f,l*p,s*h,s*c);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+i)}}};class Vector2{constructor(e=0,t=0){this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e,t){return void 0!==t?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this)}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e,t){return void 0!==t?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this)}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,r=this.y,n=e.elements;return this.x=n[0]*t+n[3]*r+n[6],this.y=n[1]*t+n[4]*r+n[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this}clampLength(e,t){const r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,r=this.y-e.y;return t*t+r*r}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,r){return this.x=e.x+(t.x-e.x)*r,this.y=e.y+(t.y-e.y)*r,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t,r){return void 0!==r&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const r=Math.cos(t),n=Math.sin(t),i=this.x-e.x,a=this.y-e.y;return this.x=i*r-a*n+e.x,this.y=i*n+a*r+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}}Vector2.prototype.isVector2=!0;class Matrix3{constructor(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}set(e,t,r,n,i,a,o,s,l){const c=this.elements;return c[0]=e,c[1]=n,c[2]=o,c[3]=t,c[4]=i,c[5]=s,c[6]=r,c[7]=a,c[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,r=e.elements;return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],this}extractBasis(e,t,r){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),r.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const r=e.elements,n=t.elements,i=this.elements,a=r[0],o=r[3],s=r[6],l=r[1],c=r[4],h=r[7],u=r[2],d=r[5],p=r[8],f=n[0],m=n[3],g=n[6],y=n[1],v=n[4],b=n[7],_=n[2],x=n[5],w=n[8];return i[0]=a*f+o*y+s*_,i[3]=a*m+o*v+s*x,i[6]=a*g+o*b+s*w,i[1]=l*f+c*y+h*_,i[4]=l*m+c*v+h*x,i[7]=l*g+c*b+h*w,i[2]=u*f+d*y+p*_,i[5]=u*m+d*v+p*x,i[8]=u*g+d*b+p*w,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],r=e[1],n=e[2],i=e[3],a=e[4],o=e[5],s=e[6],l=e[7],c=e[8];return t*a*c-t*o*l-r*i*c+r*o*s+n*i*l-n*a*s}invert(){const e=this.elements,t=e[0],r=e[1],n=e[2],i=e[3],a=e[4],o=e[5],s=e[6],l=e[7],c=e[8],h=c*a-o*l,u=o*s-c*i,d=l*i-a*s,p=t*h+r*u+n*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const f=1/p;return e[0]=h*f,e[1]=(n*l-c*r)*f,e[2]=(o*r-n*a)*f,e[3]=u*f,e[4]=(c*t-n*s)*f,e[5]=(n*i-o*t)*f,e[6]=d*f,e[7]=(r*s-l*t)*f,e[8]=(a*t-r*i)*f,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,r,n,i,a,o){const s=Math.cos(i),l=Math.sin(i);return this.set(r*s,r*l,-r*(s*a+l*o)+a+e,-n*l,n*s,-n*(-l*a+s*o)+o+t,0,0,1),this}scale(e,t){const r=this.elements;return r[0]*=e,r[3]*=e,r[6]*=e,r[1]*=t,r[4]*=t,r[7]*=t,this}rotate(e){const t=Math.cos(e),r=Math.sin(e),n=this.elements,i=n[0],a=n[3],o=n[6],s=n[1],l=n[4],c=n[7];return n[0]=t*i+r*s,n[3]=t*a+r*l,n[6]=t*o+r*c,n[1]=-r*i+t*s,n[4]=-r*a+t*l,n[7]=-r*o+t*c,this}translate(e,t){const r=this.elements;return r[0]+=e*r[2],r[3]+=e*r[5],r[6]+=e*r[8],r[1]+=t*r[2],r[4]+=t*r[5],r[7]+=t*r[8],this}equals(e){const t=this.elements,r=e.elements;for(let e=0;e<9;e++)if(t[e]!==r[e])return!1;return!0}fromArray(e,t=0){for(let r=0;r<9;r++)this.elements[r]=e[r+t];return this}toArray(e=[],t=0){const r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e}clone(){return(new this.constructor).fromArray(this.elements)}}let _canvas;Matrix3.prototype.isMatrix3=!0;const ImageUtils={getDataURL:function(e){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let t;if(e instanceof HTMLCanvasElement)t=e;else{void 0===_canvas&&(_canvas=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")),_canvas.width=e.width,_canvas.height=e.height;const r=_canvas.getContext("2d");e instanceof ImageData?r.putImageData(e,0,0):r.drawImage(e,0,0,e.width,e.height),t=_canvas}return t.width>2048||t.height>2048?t.toDataURL("image/jpeg",.6):t.toDataURL("image/png")}};let textureId=0;class Texture$1 extends EventDispatcher{constructor(e=Texture$1.DEFAULT_IMAGE,t=Texture$1.DEFAULT_MAPPING,r=ClampToEdgeWrapping,n=ClampToEdgeWrapping,i=LinearFilter,a=LinearMipmapLinearFilter,o=RGBAFormat,s=UnsignedByteType,l=1,c=LinearEncoding){super(),Object.defineProperty(this,"id",{value:textureId++}),this.uuid=MathUtils.generateUUID(),this.name="",this.image=e,this.mipmaps=[],this.mapping=t,this.wrapS=r,this.wrapT=n,this.magFilter=i,this.minFilter=a,this.anisotropy=l,this.format=o,this.internalFormat=null,this.type=s,this.offset=new Vector2(0,0),this.repeat=new Vector2(1,1),this.center=new Vector2(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new Matrix3,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=c,this.version=0,this.onUpdate=null}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(e){return this.name=e.name,this.image=e.image,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.encoding=e.encoding,this}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];const r={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,type:this.type,encoding:this.encoding,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};if(void 0!==this.image){const n=this.image;if(void 0===n.uuid&&(n.uuid=MathUtils.generateUUID()),!t&&void 0===e.images[n.uuid]){let t;if(Array.isArray(n)){t=[];for(let e=0,r=n.length;e<r;e++)n[e].isDataTexture?t.push(serializeImage(n[e].image)):t.push(serializeImage(n[e]))}else t=serializeImage(n);e.images[n.uuid]={uuid:n.uuid,url:t}}r.image=n.uuid}return t||(e.textures[this.uuid]=r),r}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(this.mapping!==UVMapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case RepeatWrapping:e.x=e.x-Math.floor(e.x);break;case ClampToEdgeWrapping:e.x=e.x<0?0:1;break;case MirroredRepeatWrapping:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case RepeatWrapping:e.y=e.y-Math.floor(e.y);break;case ClampToEdgeWrapping:e.y=e.y<0?0:1;break;case MirroredRepeatWrapping:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&this.version++}}function serializeImage(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?ImageUtils.getDataURL(e):e.data?{data:Array.prototype.slice.call(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}Texture$1.DEFAULT_IMAGE=void 0,Texture$1.DEFAULT_MAPPING=UVMapping,Texture$1.prototype.isTexture=!0;class Vector4{constructor(e=0,t=0,r=0,n=1){this.x=e,this.y=t,this.z=r,this.w=n}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,r,n){return this.x=e,this.y=t,this.z=r,this.w=n,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e,t){return void 0!==t?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e,t){return void 0!==t?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,r=this.y,n=this.z,i=this.w,a=e.elements;return this.x=a[0]*t+a[4]*r+a[8]*n+a[12]*i,this.y=a[1]*t+a[5]*r+a[9]*n+a[13]*i,this.z=a[2]*t+a[6]*r+a[10]*n+a[14]*i,this.w=a[3]*t+a[7]*r+a[11]*n+a[15]*i,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,r,n,i;const a=.01,o=.1,s=e.elements,l=s[0],c=s[4],h=s[8],u=s[1],d=s[5],p=s[9],f=s[2],m=s[6],g=s[10];if(Math.abs(c-u)<a&&Math.abs(h-f)<a&&Math.abs(p-m)<a){if(Math.abs(c+u)<o&&Math.abs(h+f)<o&&Math.abs(p+m)<o&&Math.abs(l+d+g-3)<o)return this.set(1,0,0,0),this;t=Math.PI;const e=(l+1)/2,s=(d+1)/2,y=(g+1)/2,v=(c+u)/4,b=(h+f)/4,_=(p+m)/4;return e>s&&e>y?e<a?(r=0,n=.707106781,i=.707106781):(r=Math.sqrt(e),n=v/r,i=b/r):s>y?s<a?(r=.707106781,n=0,i=.707106781):(n=Math.sqrt(s),r=v/n,i=_/n):y<a?(r=.707106781,n=.707106781,i=0):(i=Math.sqrt(y),r=b/i,n=_/i),this.set(r,n,i,t),this}let y=Math.sqrt((m-p)*(m-p)+(h-f)*(h-f)+(u-c)*(u-c));return Math.abs(y)<.001&&(y=1),this.x=(m-p)/y,this.y=(h-f)/y,this.z=(u-c)/y,this.w=Math.acos((l+d+g-1)/2),this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this.w=Math.max(e,Math.min(t,this.w)),this}clampLength(e,t){const r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,r){return this.x=e.x+(t.x-e.x)*r,this.y=e.y+(t.y-e.y)*r,this.z=e.z+(t.z-e.z)*r,this.w=e.w+(t.w-e.w)*r,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t,r){return void 0!==r&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}}Vector4.prototype.isVector4=!0;class WebGLRenderTarget extends EventDispatcher{constructor(e,t,r){super(),this.width=e,this.height=t,this.depth=1,this.scissor=new Vector4(0,0,e,t),this.scissorTest=!1,this.viewport=new Vector4(0,0,e,t),r=r||{},this.texture=new Texture$1(void 0,r.mapping,r.wrapS,r.wrapT,r.magFilter,r.minFilter,r.format,r.type,r.anisotropy,r.encoding),this.texture.image={},this.texture.image.width=e,this.texture.image.height=t,this.texture.image.depth=1,this.texture.generateMipmaps=void 0!==r.generateMipmaps&&r.generateMipmaps,this.texture.minFilter=void 0!==r.minFilter?r.minFilter:LinearFilter,this.depthBuffer=void 0===r.depthBuffer||r.depthBuffer,this.stencilBuffer=void 0!==r.stencilBuffer&&r.stencilBuffer,this.depthTexture=void 0!==r.depthTexture?r.depthTexture:null}setTexture(e){e.image={width:this.width,height:this.height,depth:this.depth},this.texture=e}setSize(e,t,r=1){this.width===e&&this.height===t&&this.depth===r||(this.width=e,this.height=t,this.depth=r,this.texture.image.width=e,this.texture.image.height=t,this.texture.image.depth=r,this.dispose()),this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return(new this.constructor).copy(this)}copy(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this.viewport.copy(e.viewport),this.texture=e.texture.clone(),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.depthTexture=e.depthTexture,this}dispose(){this.dispatchEvent({type:"dispose"})}}WebGLRenderTarget.prototype.isWebGLRenderTarget=!0;class WebGLMultisampleRenderTarget extends WebGLRenderTarget{constructor(e,t,r){super(e,t,r),this.samples=4}copy(e){return super.copy.call(this,e),this.samples=e.samples,this}}WebGLMultisampleRenderTarget.prototype.isWebGLMultisampleRenderTarget=!0;class Quaternion{constructor(e=0,t=0,r=0,n=1){this._x=e,this._y=t,this._z=r,this._w=n}static slerp(e,t,r,n){return r.copy(e).slerp(t,n)}static slerpFlat(e,t,r,n,i,a,o){let s=r[n+0],l=r[n+1],c=r[n+2],h=r[n+3];const u=i[a+0],d=i[a+1],p=i[a+2],f=i[a+3];if(0===o)return e[t+0]=s,e[t+1]=l,e[t+2]=c,void(e[t+3]=h);if(1===o)return e[t+0]=u,e[t+1]=d,e[t+2]=p,void(e[t+3]=f);if(h!==f||s!==u||l!==d||c!==p){let e=1-o;const t=s*u+l*d+c*p+h*f,r=t>=0?1:-1,n=1-t*t;if(n>Number.EPSILON){const i=Math.sqrt(n),a=Math.atan2(i,t*r);e=Math.sin(e*a)/i,o=Math.sin(o*a)/i}const i=o*r;if(s=s*e+u*i,l=l*e+d*i,c=c*e+p*i,h=h*e+f*i,e===1-o){const e=1/Math.sqrt(s*s+l*l+c*c+h*h);s*=e,l*=e,c*=e,h*=e}}e[t]=s,e[t+1]=l,e[t+2]=c,e[t+3]=h}static multiplyQuaternionsFlat(e,t,r,n,i,a){const o=r[n],s=r[n+1],l=r[n+2],c=r[n+3],h=i[a],u=i[a+1],d=i[a+2],p=i[a+3];return e[t]=o*p+c*h+s*d-l*u,e[t+1]=s*p+c*u+l*h-o*d,e[t+2]=l*p+c*d+o*u-s*h,e[t+3]=c*p-o*h-s*u-l*d,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,r,n){return this._x=e,this._y=t,this._z=r,this._w=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t){if(!e||!e.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");const r=e._x,n=e._y,i=e._z,a=e._order,o=Math.cos,s=Math.sin,l=o(r/2),c=o(n/2),h=o(i/2),u=s(r/2),d=s(n/2),p=s(i/2);switch(a){case"XYZ":this._x=u*c*h+l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h-u*d*p;break;case"YXZ":this._x=u*c*h+l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h+u*d*p;break;case"ZXY":this._x=u*c*h-l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h-u*d*p;break;case"ZYX":this._x=u*c*h-l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h+u*d*p;break;case"YZX":this._x=u*c*h+l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h-u*d*p;break;case"XZY":this._x=u*c*h-l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h+u*d*p;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+a)}return!1!==t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const r=t/2,n=Math.sin(r);return this._x=e.x*n,this._y=e.y*n,this._z=e.z*n,this._w=Math.cos(r),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,r=t[0],n=t[4],i=t[8],a=t[1],o=t[5],s=t[9],l=t[2],c=t[6],h=t[10],u=r+o+h;if(u>0){const e=.5/Math.sqrt(u+1);this._w=.25/e,this._x=(c-s)*e,this._y=(i-l)*e,this._z=(a-n)*e}else if(r>o&&r>h){const e=2*Math.sqrt(1+r-o-h);this._w=(c-s)/e,this._x=.25*e,this._y=(n+a)/e,this._z=(i+l)/e}else if(o>h){const e=2*Math.sqrt(1+o-r-h);this._w=(i-l)/e,this._x=(n+a)/e,this._y=.25*e,this._z=(s+c)/e}else{const e=2*Math.sqrt(1+h-r-o);this._w=(a-n)/e,this._x=(i+l)/e,this._y=(s+c)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let r=e.dot(t)+1;return r<1e-6?(r=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=r):(this._x=0,this._y=-e.z,this._z=e.y,this._w=r)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=r),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(MathUtils.clamp(this.dot(e),-1,1)))}rotateTowards(e,t){const r=this.angleTo(e);if(0===r)return this;const n=Math.min(1,t/r);return this.slerp(e,n),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e,t){return void 0!==t?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const r=e._x,n=e._y,i=e._z,a=e._w,o=t._x,s=t._y,l=t._z,c=t._w;return this._x=r*c+a*o+n*l-i*s,this._y=n*c+a*s+i*o-r*l,this._z=i*c+a*l+r*s-n*o,this._w=a*c-r*o-n*s-i*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);const r=this._x,n=this._y,i=this._z,a=this._w;let o=a*e._w+r*e._x+n*e._y+i*e._z;if(o<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,o=-o):this.copy(e),o>=1)return this._w=a,this._x=r,this._y=n,this._z=i,this;const s=1-o*o;if(s<=Number.EPSILON){const e=1-t;return this._w=e*a+t*this._w,this._x=e*r+t*this._x,this._y=e*n+t*this._y,this._z=e*i+t*this._z,this.normalize(),this._onChangeCallback(),this}const l=Math.sqrt(s),c=Math.atan2(l,o),h=Math.sin((1-t)*c)/l,u=Math.sin(t*c)/l;return this._w=a*h+this._w*u,this._x=r*h+this._x*u,this._y=n*h+this._y*u,this._z=i*h+this._z*u,this._onChangeCallback(),this}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}}Quaternion.prototype.isQuaternion=!0;class Vector3{constructor(e=0,t=0,r=0){this.x=e,this.y=t,this.z=r}set(e,t,r){return void 0===r&&(r=this.z),this.x=e,this.y=t,this.z=r,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e,t){return void 0!==t?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e,t){return void 0!==t?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e,t){return void 0!==t?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return e&&e.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(_quaternion.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(_quaternion.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,r=this.y,n=this.z,i=e.elements;return this.x=i[0]*t+i[3]*r+i[6]*n,this.y=i[1]*t+i[4]*r+i[7]*n,this.z=i[2]*t+i[5]*r+i[8]*n,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,r=this.y,n=this.z,i=e.elements,a=1/(i[3]*t+i[7]*r+i[11]*n+i[15]);return this.x=(i[0]*t+i[4]*r+i[8]*n+i[12])*a,this.y=(i[1]*t+i[5]*r+i[9]*n+i[13])*a,this.z=(i[2]*t+i[6]*r+i[10]*n+i[14])*a,this}applyQuaternion(e){const t=this.x,r=this.y,n=this.z,i=e.x,a=e.y,o=e.z,s=e.w,l=s*t+a*n-o*r,c=s*r+o*t-i*n,h=s*n+i*r-a*t,u=-i*t-a*r-o*n;return this.x=l*s+u*-i+c*-o-h*-a,this.y=c*s+u*-a+h*-i-l*-o,this.z=h*s+u*-o+l*-a-c*-i,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,r=this.y,n=this.z,i=e.elements;return this.x=i[0]*t+i[4]*r+i[8]*n,this.y=i[1]*t+i[5]*r+i[9]*n,this.z=i[2]*t+i[6]*r+i[10]*n,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){const r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,r){return this.x=e.x+(t.x-e.x)*r,this.y=e.y+(t.y-e.y)*r,this.z=e.z+(t.z-e.z)*r,this}cross(e,t){return void 0!==t?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t)):this.crossVectors(this,e)}crossVectors(e,t){const r=e.x,n=e.y,i=e.z,a=t.x,o=t.y,s=t.z;return this.x=n*s-i*o,this.y=i*a-r*s,this.z=r*o-n*a,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const r=e.dot(this)/t;return this.copy(e).multiplyScalar(r)}projectOnPlane(e){return _vector.copy(this).projectOnVector(e),this.sub(_vector)}reflect(e){return this.sub(_vector.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const r=this.dot(e)/t;return Math.acos(MathUtils.clamp(r,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,r=this.y-e.y,n=this.z-e.z;return t*t+r*r+n*n}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,r){const n=Math.sin(t)*e;return this.x=n*Math.sin(r),this.y=Math.cos(t)*e,this.z=n*Math.cos(r),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,r){return this.x=e*Math.sin(t),this.y=r,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),r=this.setFromMatrixColumn(e,1).length(),n=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=r,this.z=n,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t,r){return void 0!==r&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}}Vector3.prototype.isVector3=!0;const _vector=new Vector3,_quaternion=new Quaternion;class Box3{constructor(e=new Vector3(1/0,1/0,1/0),t=new Vector3(-1/0,-1/0,-1/0)){this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){let t=1/0,r=1/0,n=1/0,i=-1/0,a=-1/0,o=-1/0;for(let s=0,l=e.length;s<l;s+=3){const l=e[s],c=e[s+1],h=e[s+2];l<t&&(t=l),c<r&&(r=c),h<n&&(n=h),l>i&&(i=l),c>a&&(a=c),h>o&&(o=h)}return this.min.set(t,r,n),this.max.set(i,a,o),this}setFromBufferAttribute(e){let t=1/0,r=1/0,n=1/0,i=-1/0,a=-1/0,o=-1/0;for(let s=0,l=e.count;s<l;s++){const l=e.getX(s),c=e.getY(s),h=e.getZ(s);l<t&&(t=l),c<r&&(r=c),h<n&&(n=h),l>i&&(i=l),c>a&&(a=c),h>o&&(o=h)}return this.min.set(t,r,n),this.max.set(i,a,o),this}setFromPoints(e){this.makeEmpty();for(let t=0,r=e.length;t<r;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const r=_vector$1.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(r),this.max.copy(e).add(r),this}setFromObject(e){return this.makeEmpty(),this.expandByObject(e)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return void 0===e&&(console.warn("THREE.Box3: .getCenter() target is now required"),e=new Vector3),this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return void 0===e&&(console.warn("THREE.Box3: .getSize() target is now required"),e=new Vector3),this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e){e.updateWorldMatrix(!1,!1);const t=e.geometry;void 0!==t&&(null===t.boundingBox&&t.computeBoundingBox(),_box.copy(t.boundingBox),_box.applyMatrix4(e.matrixWorld),this.union(_box));const r=e.children;for(let e=0,t=r.length;e<t;e++)this.expandByObject(r[e]);return this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return void 0===t&&(console.warn("THREE.Box3: .getParameter() target is now required"),t=new Vector3),t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}intersectsSphere(e){return this.clampPoint(e.center,_vector$1),_vector$1.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,r;return e.normal.x>0?(t=e.normal.x*this.min.x,r=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,r=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,r+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,r+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,r+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,r+=e.normal.z*this.min.z),t<=-e.constant&&r>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(_center),_extents.subVectors(this.max,_center),_v0.subVectors(e.a,_center),_v1.subVectors(e.b,_center),_v2.subVectors(e.c,_center),_f0.subVectors(_v1,_v0),_f1.subVectors(_v2,_v1),_f2.subVectors(_v0,_v2);let t=[0,-_f0.z,_f0.y,0,-_f1.z,_f1.y,0,-_f2.z,_f2.y,_f0.z,0,-_f0.x,_f1.z,0,-_f1.x,_f2.z,0,-_f2.x,-_f0.y,_f0.x,0,-_f1.y,_f1.x,0,-_f2.y,_f2.x,0];return!!satForAxes(t,_v0,_v1,_v2,_extents)&&(t=[1,0,0,0,1,0,0,0,1],!!satForAxes(t,_v0,_v1,_v2,_extents)&&(_triangleNormal.crossVectors(_f0,_f1),t=[_triangleNormal.x,_triangleNormal.y,_triangleNormal.z],satForAxes(t,_v0,_v1,_v2,_extents)))}clampPoint(e,t){return void 0===t&&(console.warn("THREE.Box3: .clampPoint() target is now required"),t=new Vector3),t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return _vector$1.copy(e).clamp(this.min,this.max).sub(e).length()}getBoundingSphere(e){return void 0===e&&console.error("THREE.Box3: .getBoundingSphere() target is now required"),this.getCenter(e.center),e.radius=.5*this.getSize(_vector$1).length(),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(_points[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),_points[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),_points[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),_points[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),_points[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),_points[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),_points[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),_points[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(_points)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}Box3.prototype.isBox3=!0;const _points=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3],_vector$1=new Vector3,_box=new Box3,_v0=new Vector3,_v1=new Vector3,_v2=new Vector3,_f0=new Vector3,_f1=new Vector3,_f2=new Vector3,_center=new Vector3,_extents=new Vector3,_triangleNormal=new Vector3,_testAxis=new Vector3;function satForAxes(e,t,r,n,i){for(let a=0,o=e.length-3;a<=o;a+=3){_testAxis.fromArray(e,a);const o=i.x*Math.abs(_testAxis.x)+i.y*Math.abs(_testAxis.y)+i.z*Math.abs(_testAxis.z),s=t.dot(_testAxis),l=r.dot(_testAxis),c=n.dot(_testAxis);if(Math.max(-Math.max(s,l,c),Math.min(s,l,c))>o)return!1}return!0}const _box$1=new Box3;class Sphere{constructor(e=new Vector3,t=-1){this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const r=this.center;void 0!==t?r.copy(t):_box$1.setFromPoints(e).getCenter(r);let n=0;for(let t=0,i=e.length;t<i;t++)n=Math.max(n,r.distanceToSquared(e[t]));return this.radius=Math.sqrt(n),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const r=this.center.distanceToSquared(e);return void 0===t&&(console.warn("THREE.Sphere: .clampPoint() target is now required"),t=new Vector3),t.copy(e),r>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return void 0===e&&(console.warn("THREE.Sphere: .getBoundingBox() target is now required"),e=new Box3),this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return(new this.constructor).copy(this)}}const _vector$2=new Vector3,_segCenter=new Vector3,_segDir=new Vector3,_diff=new Vector3,_edge1=new Vector3,_edge2=new Vector3,_normal=new Vector3;class Ray{constructor(e=new Vector3,t=new Vector3(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return void 0===t&&(console.warn("THREE.Ray: .at() target is now required"),t=new Vector3),t.copy(this.direction).multiplyScalar(e).add(this.origin)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,_vector$2)),this}closestPointToPoint(e,t){void 0===t&&(console.warn("THREE.Ray: .closestPointToPoint() target is now required"),t=new Vector3),t.subVectors(e,this.origin);const r=t.dot(this.direction);return r<0?t.copy(this.origin):t.copy(this.direction).multiplyScalar(r).add(this.origin)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=_vector$2.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(_vector$2.copy(this.direction).multiplyScalar(t).add(this.origin),_vector$2.distanceToSquared(e))}distanceSqToSegment(e,t,r,n){_segCenter.copy(e).add(t).multiplyScalar(.5),_segDir.copy(t).sub(e).normalize(),_diff.copy(this.origin).sub(_segCenter);const i=.5*e.distanceTo(t),a=-this.direction.dot(_segDir),o=_diff.dot(this.direction),s=-_diff.dot(_segDir),l=_diff.lengthSq(),c=Math.abs(1-a*a);let h,u,d,p;if(c>0)if(h=a*s-o,u=a*o-s,p=i*c,h>=0)if(u>=-p)if(u<=p){const e=1/c;h*=e,u*=e,d=h*(h+a*u+2*o)+u*(a*h+u+2*s)+l}else u=i,h=Math.max(0,-(a*u+o)),d=-h*h+u*(u+2*s)+l;else u=-i,h=Math.max(0,-(a*u+o)),d=-h*h+u*(u+2*s)+l;else u<=-p?(h=Math.max(0,-(-a*i+o)),u=h>0?-i:Math.min(Math.max(-i,-s),i),d=-h*h+u*(u+2*s)+l):u<=p?(h=0,u=Math.min(Math.max(-i,-s),i),d=u*(u+2*s)+l):(h=Math.max(0,-(a*i+o)),u=h>0?i:Math.min(Math.max(-i,-s),i),d=-h*h+u*(u+2*s)+l);else u=a>0?-i:i,h=Math.max(0,-(a*u+o)),d=-h*h+u*(u+2*s)+l;return r&&r.copy(this.direction).multiplyScalar(h).add(this.origin),n&&n.copy(_segDir).multiplyScalar(u).add(_segCenter),d}intersectSphere(e,t){_vector$2.subVectors(e.center,this.origin);const r=_vector$2.dot(this.direction),n=_vector$2.dot(_vector$2)-r*r,i=e.radius*e.radius;if(n>i)return null;const a=Math.sqrt(i-n),o=r-a,s=r+a;return o<0&&s<0?null:o<0?this.at(s,t):this.at(o,t)}intersectsSphere(e){return this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;const r=-(this.origin.dot(e.normal)+e.constant)/t;return r>=0?r:null}intersectPlane(e,t){const r=this.distanceToPlane(e);return null===r?null:this.at(r,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);if(0===t)return!0;return e.normal.dot(this.direction)*t<0}intersectBox(e,t){let r,n,i,a,o,s;const l=1/this.direction.x,c=1/this.direction.y,h=1/this.direction.z,u=this.origin;return l>=0?(r=(e.min.x-u.x)*l,n=(e.max.x-u.x)*l):(r=(e.max.x-u.x)*l,n=(e.min.x-u.x)*l),c>=0?(i=(e.min.y-u.y)*c,a=(e.max.y-u.y)*c):(i=(e.max.y-u.y)*c,a=(e.min.y-u.y)*c),r>a||i>n?null:((i>r||r!=r)&&(r=i),(a<n||n!=n)&&(n=a),h>=0?(o=(e.min.z-u.z)*h,s=(e.max.z-u.z)*h):(o=(e.max.z-u.z)*h,s=(e.min.z-u.z)*h),r>s||o>n?null:((o>r||r!=r)&&(r=o),(s<n||n!=n)&&(n=s),n<0?null:this.at(r>=0?r:n,t)))}intersectsBox(e){return null!==this.intersectBox(e,_vector$2)}intersectTriangle(e,t,r,n,i){_edge1.subVectors(t,e),_edge2.subVectors(r,e),_normal.crossVectors(_edge1,_edge2);let a,o=this.direction.dot(_normal);if(o>0){if(n)return null;a=1}else{if(!(o<0))return null;a=-1,o=-o}_diff.subVectors(this.origin,e);const s=a*this.direction.dot(_edge2.crossVectors(_diff,_edge2));if(s<0)return null;const l=a*this.direction.dot(_edge1.cross(_diff));if(l<0)return null;if(s+l>o)return null;const c=-a*_diff.dot(_normal);return c<0?null:this.at(c/o,i)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class Matrix4{constructor(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}set(e,t,r,n,i,a,o,s,l,c,h,u,d,p,f,m){const g=this.elements;return g[0]=e,g[4]=t,g[8]=r,g[12]=n,g[1]=i,g[5]=a,g[9]=o,g[13]=s,g[2]=l,g[6]=c,g[10]=h,g[14]=u,g[3]=d,g[7]=p,g[11]=f,g[15]=m,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Matrix4).fromArray(this.elements)}copy(e){const t=this.elements,r=e.elements;return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],t[9]=r[9],t[10]=r[10],t[11]=r[11],t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15],this}copyPosition(e){const t=this.elements,r=e.elements;return t[12]=r[12],t[13]=r[13],t[14]=r[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,r){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),r.setFromMatrixColumn(this,2),this}makeBasis(e,t,r){return this.set(e.x,t.x,r.x,0,e.y,t.y,r.y,0,e.z,t.z,r.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,r=e.elements,n=1/_v1$1.setFromMatrixColumn(e,0).length(),i=1/_v1$1.setFromMatrixColumn(e,1).length(),a=1/_v1$1.setFromMatrixColumn(e,2).length();return t[0]=r[0]*n,t[1]=r[1]*n,t[2]=r[2]*n,t[3]=0,t[4]=r[4]*i,t[5]=r[5]*i,t[6]=r[6]*i,t[7]=0,t[8]=r[8]*a,t[9]=r[9]*a,t[10]=r[10]*a,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){e&&e.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");const t=this.elements,r=e.x,n=e.y,i=e.z,a=Math.cos(r),o=Math.sin(r),s=Math.cos(n),l=Math.sin(n),c=Math.cos(i),h=Math.sin(i);if("XYZ"===e.order){const e=a*c,r=a*h,n=o*c,i=o*h;t[0]=s*c,t[4]=-s*h,t[8]=l,t[1]=r+n*l,t[5]=e-i*l,t[9]=-o*s,t[2]=i-e*l,t[6]=n+r*l,t[10]=a*s}else if("YXZ"===e.order){const e=s*c,r=s*h,n=l*c,i=l*h;t[0]=e+i*o,t[4]=n*o-r,t[8]=a*l,t[1]=a*h,t[5]=a*c,t[9]=-o,t[2]=r*o-n,t[6]=i+e*o,t[10]=a*s}else if("ZXY"===e.order){const e=s*c,r=s*h,n=l*c,i=l*h;t[0]=e-i*o,t[4]=-a*h,t[8]=n+r*o,t[1]=r+n*o,t[5]=a*c,t[9]=i-e*o,t[2]=-a*l,t[6]=o,t[10]=a*s}else if("ZYX"===e.order){const e=a*c,r=a*h,n=o*c,i=o*h;t[0]=s*c,t[4]=n*l-r,t[8]=e*l+i,t[1]=s*h,t[5]=i*l+e,t[9]=r*l-n,t[2]=-l,t[6]=o*s,t[10]=a*s}else if("YZX"===e.order){const e=a*s,r=a*l,n=o*s,i=o*l;t[0]=s*c,t[4]=i-e*h,t[8]=n*h+r,t[1]=h,t[5]=a*c,t[9]=-o*c,t[2]=-l*c,t[6]=r*h+n,t[10]=e-i*h}else if("XZY"===e.order){const e=a*s,r=a*l,n=o*s,i=o*l;t[0]=s*c,t[4]=-h,t[8]=l*c,t[1]=e*h+i,t[5]=a*c,t[9]=r*h-n,t[2]=n*h-r,t[6]=o*c,t[10]=i*h+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(_zero,e,_one)}lookAt(e,t,r){const n=this.elements;return _z.subVectors(e,t),0===_z.lengthSq()&&(_z.z=1),_z.normalize(),_x.crossVectors(r,_z),0===_x.lengthSq()&&(1===Math.abs(r.z)?_z.x+=1e-4:_z.z+=1e-4,_z.normalize(),_x.crossVectors(r,_z)),_x.normalize(),_y.crossVectors(_z,_x),n[0]=_x.x,n[4]=_y.x,n[8]=_z.x,n[1]=_x.y,n[5]=_y.y,n[9]=_z.y,n[2]=_x.z,n[6]=_y.z,n[10]=_z.z,this}multiply(e,t){return void 0!==t?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const r=e.elements,n=t.elements,i=this.elements,a=r[0],o=r[4],s=r[8],l=r[12],c=r[1],h=r[5],u=r[9],d=r[13],p=r[2],f=r[6],m=r[10],g=r[14],y=r[3],v=r[7],b=r[11],_=r[15],x=n[0],w=n[4],S=n[8],M=n[12],T=n[1],A=n[5],E=n[9],C=n[13],L=n[2],D=n[6],R=n[10],P=n[14],O=n[3],I=n[7],k=n[11],B=n[15];return i[0]=a*x+o*T+s*L+l*O,i[4]=a*w+o*A+s*D+l*I,i[8]=a*S+o*E+s*R+l*k,i[12]=a*M+o*C+s*P+l*B,i[1]=c*x+h*T+u*L+d*O,i[5]=c*w+h*A+u*D+d*I,i[9]=c*S+h*E+u*R+d*k,i[13]=c*M+h*C+u*P+d*B,i[2]=p*x+f*T+m*L+g*O,i[6]=p*w+f*A+m*D+g*I,i[10]=p*S+f*E+m*R+g*k,i[14]=p*M+f*C+m*P+g*B,i[3]=y*x+v*T+b*L+_*O,i[7]=y*w+v*A+b*D+_*I,i[11]=y*S+v*E+b*R+_*k,i[15]=y*M+v*C+b*P+_*B,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],r=e[4],n=e[8],i=e[12],a=e[1],o=e[5],s=e[9],l=e[13],c=e[2],h=e[6],u=e[10],d=e[14];return e[3]*(+i*s*h-n*l*h-i*o*u+r*l*u+n*o*d-r*s*d)+e[7]*(+t*s*d-t*l*u+i*a*u-n*a*d+n*l*c-i*s*c)+e[11]*(+t*l*h-t*o*d-i*a*h+r*a*d+i*o*c-r*l*c)+e[15]*(-n*o*c-t*s*h+t*o*u+n*a*h-r*a*u+r*s*c)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,r){const n=this.elements;return e.isVector3?(n[12]=e.x,n[13]=e.y,n[14]=e.z):(n[12]=e,n[13]=t,n[14]=r),this}invert(){const e=this.elements,t=e[0],r=e[1],n=e[2],i=e[3],a=e[4],o=e[5],s=e[6],l=e[7],c=e[8],h=e[9],u=e[10],d=e[11],p=e[12],f=e[13],m=e[14],g=e[15],y=h*m*l-f*u*l+f*s*d-o*m*d-h*s*g+o*u*g,v=p*u*l-c*m*l-p*s*d+a*m*d+c*s*g-a*u*g,b=c*f*l-p*h*l+p*o*d-a*f*d-c*o*g+a*h*g,_=p*h*s-c*f*s-p*o*u+a*f*u+c*o*m-a*h*m,x=t*y+r*v+n*b+i*_;if(0===x)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const w=1/x;return e[0]=y*w,e[1]=(f*u*i-h*m*i-f*n*d+r*m*d+h*n*g-r*u*g)*w,e[2]=(o*m*i-f*s*i+f*n*l-r*m*l-o*n*g+r*s*g)*w,e[3]=(h*s*i-o*u*i-h*n*l+r*u*l+o*n*d-r*s*d)*w,e[4]=v*w,e[5]=(c*m*i-p*u*i+p*n*d-t*m*d-c*n*g+t*u*g)*w,e[6]=(p*s*i-a*m*i-p*n*l+t*m*l+a*n*g-t*s*g)*w,e[7]=(a*u*i-c*s*i+c*n*l-t*u*l-a*n*d+t*s*d)*w,e[8]=b*w,e[9]=(p*h*i-c*f*i-p*r*d+t*f*d+c*r*g-t*h*g)*w,e[10]=(a*f*i-p*o*i+p*r*l-t*f*l-a*r*g+t*o*g)*w,e[11]=(c*o*i-a*h*i-c*r*l+t*h*l+a*r*d-t*o*d)*w,e[12]=_*w,e[13]=(c*f*n-p*h*n+p*r*u-t*f*u-c*r*m+t*h*m)*w,e[14]=(p*o*n-a*f*n-p*r*s+t*f*s+a*r*m-t*o*m)*w,e[15]=(a*h*n-c*o*n+c*r*s-t*h*s-a*r*u+t*o*u)*w,this}scale(e){const t=this.elements,r=e.x,n=e.y,i=e.z;return t[0]*=r,t[4]*=n,t[8]*=i,t[1]*=r,t[5]*=n,t[9]*=i,t[2]*=r,t[6]*=n,t[10]*=i,t[3]*=r,t[7]*=n,t[11]*=i,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],r=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],n=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,r,n))}makeTranslation(e,t,r){return this.set(1,0,0,e,0,1,0,t,0,0,1,r,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),r=Math.sin(e);return this.set(1,0,0,0,0,t,-r,0,0,r,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),r=Math.sin(e);return this.set(t,0,r,0,0,1,0,0,-r,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),r=Math.sin(e);return this.set(t,-r,0,0,r,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const r=Math.cos(t),n=Math.sin(t),i=1-r,a=e.x,o=e.y,s=e.z,l=i*a,c=i*o;return this.set(l*a+r,l*o-n*s,l*s+n*o,0,l*o+n*s,c*o+r,c*s-n*a,0,l*s-n*o,c*s+n*a,i*s*s+r,0,0,0,0,1),this}makeScale(e,t,r){return this.set(e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1),this}makeShear(e,t,r){return this.set(1,t,r,0,e,1,r,0,e,t,1,0,0,0,0,1),this}compose(e,t,r){const n=this.elements,i=t._x,a=t._y,o=t._z,s=t._w,l=i+i,c=a+a,h=o+o,u=i*l,d=i*c,p=i*h,f=a*c,m=a*h,g=o*h,y=s*l,v=s*c,b=s*h,_=r.x,x=r.y,w=r.z;return n[0]=(1-(f+g))*_,n[1]=(d+b)*_,n[2]=(p-v)*_,n[3]=0,n[4]=(d-b)*x,n[5]=(1-(u+g))*x,n[6]=(m+y)*x,n[7]=0,n[8]=(p+v)*w,n[9]=(m-y)*w,n[10]=(1-(u+f))*w,n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1,this}decompose(e,t,r){const n=this.elements;let i=_v1$1.set(n[0],n[1],n[2]).length();const a=_v1$1.set(n[4],n[5],n[6]).length(),o=_v1$1.set(n[8],n[9],n[10]).length();this.determinant()<0&&(i=-i),e.x=n[12],e.y=n[13],e.z=n[14],_m1.copy(this);const s=1/i,l=1/a,c=1/o;return _m1.elements[0]*=s,_m1.elements[1]*=s,_m1.elements[2]*=s,_m1.elements[4]*=l,_m1.elements[5]*=l,_m1.elements[6]*=l,_m1.elements[8]*=c,_m1.elements[9]*=c,_m1.elements[10]*=c,t.setFromRotationMatrix(_m1),r.x=i,r.y=a,r.z=o,this}makePerspective(e,t,r,n,i,a){void 0===a&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");const o=this.elements,s=2*i/(t-e),l=2*i/(r-n),c=(t+e)/(t-e),h=(r+n)/(r-n),u=-(a+i)/(a-i),d=-2*a*i/(a-i);return o[0]=s,o[4]=0,o[8]=c,o[12]=0,o[1]=0,o[5]=l,o[9]=h,o[13]=0,o[2]=0,o[6]=0,o[10]=u,o[14]=d,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(e,t,r,n,i,a){const o=this.elements,s=1/(t-e),l=1/(r-n),c=1/(a-i),h=(t+e)*s,u=(r+n)*l,d=(a+i)*c;return o[0]=2*s,o[4]=0,o[8]=0,o[12]=-h,o[1]=0,o[5]=2*l,o[9]=0,o[13]=-u,o[2]=0,o[6]=0,o[10]=-2*c,o[14]=-d,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(e){const t=this.elements,r=e.elements;for(let e=0;e<16;e++)if(t[e]!==r[e])return!1;return!0}fromArray(e,t=0){for(let r=0;r<16;r++)this.elements[r]=e[r+t];return this}toArray(e=[],t=0){const r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e[t+9]=r[9],e[t+10]=r[10],e[t+11]=r[11],e[t+12]=r[12],e[t+13]=r[13],e[t+14]=r[14],e[t+15]=r[15],e}}Matrix4.prototype.isMatrix4=!0;const _v1$1=new Vector3,_m1=new Matrix4,_zero=new Vector3(0,0,0),_one=new Vector3(1,1,1),_x=new Vector3,_y=new Vector3,_z=new Vector3,_matrix=new Matrix4,_quaternion$1=new Quaternion;class Euler{constructor(e=0,t=0,r=0,n=Euler.DefaultOrder){this._x=e,this._y=t,this._z=r,this._order=n}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,r,n){return this._x=e,this._y=t,this._z=r,this._order=n||this._order,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t,r){const n=MathUtils.clamp,i=e.elements,a=i[0],o=i[4],s=i[8],l=i[1],c=i[5],h=i[9],u=i[2],d=i[6],p=i[10];switch(t=t||this._order){case"XYZ":this._y=Math.asin(n(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(-h,p),this._z=Math.atan2(-o,a)):(this._x=Math.atan2(d,c),this._z=0);break;case"YXZ":this._x=Math.asin(-n(h,-1,1)),Math.abs(h)<.9999999?(this._y=Math.atan2(s,p),this._z=Math.atan2(l,c)):(this._y=Math.atan2(-u,a),this._z=0);break;case"ZXY":this._x=Math.asin(n(d,-1,1)),Math.abs(d)<.9999999?(this._y=Math.atan2(-u,p),this._z=Math.atan2(-o,c)):(this._y=0,this._z=Math.atan2(l,a));break;case"ZYX":this._y=Math.asin(-n(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(d,p),this._z=Math.atan2(l,a)):(this._x=0,this._z=Math.atan2(-o,c));break;case"YZX":this._z=Math.asin(n(l,-1,1)),Math.abs(l)<.9999999?(this._x=Math.atan2(-h,c),this._y=Math.atan2(-u,a)):(this._x=0,this._y=Math.atan2(s,p));break;case"XZY":this._z=Math.asin(-n(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(d,c),this._y=Math.atan2(s,a)):(this._x=Math.atan2(-h,p),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,!1!==r&&this._onChangeCallback(),this}setFromQuaternion(e,t,r){return _matrix.makeRotationFromQuaternion(e),this.setFromRotationMatrix(_matrix,t,r)}setFromVector3(e,t){return this.set(e.x,e.y,e.z,t||this._order)}reorder(e){return _quaternion$1.setFromEuler(this),this.setFromQuaternion(_quaternion$1,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}toVector3(e){return e?e.set(this._x,this._y,this._z):new Vector3(this._x,this._y,this._z)}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}}Euler.prototype.isEuler=!0,Euler.DefaultOrder="XYZ",Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];class Layers{constructor(){this.mask=1}set(e){this.mask=1<<e|0}enable(e){this.mask|=1<<e|0}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e|0}disable(e){this.mask&=~(1<<e|0)}disableAll(){this.mask=0}test(e){return 0!=(this.mask&e.mask)}}let _object3DId=0;const _v1$2=new Vector3,_q1=new Quaternion,_m1$1=new Matrix4,_target=new Vector3,_position=new Vector3,_scale=new Vector3,_quaternion$2=new Quaternion,_xAxis=new Vector3(1,0,0),_yAxis=new Vector3(0,1,0),_zAxis=new Vector3(0,0,1),_addedEvent={type:"added"},_removedEvent={type:"removed"};function Object3D(){Object.defineProperty(this,"id",{value:_object3DId++}),this.uuid=MathUtils.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Object3D.DefaultUp.clone();const e=new Vector3,t=new Euler,r=new Quaternion,n=new Vector3(1,1,1);t._onChange((function(){r.setFromEuler(t,!1)})),r._onChange((function(){t.setFromQuaternion(r,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:r},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new Matrix4},normalMatrix:{value:new Matrix3}}),this.matrix=new Matrix4,this.matrixWorld=new Matrix4,this.matrixAutoUpdate=Object3D.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new Layers,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}Object3D.DefaultUp=new Vector3(0,1,0),Object3D.DefaultMatrixAutoUpdate=!0,Object3D.prototype=Object.assign(Object.create(EventDispatcher.prototype),{constructor:Object3D,isObject3D:!0,onBeforeRender:function(){},onAfterRender:function(){},applyMatrix4:function(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)},applyQuaternion:function(e){return this.quaternion.premultiply(e),this},setRotationFromAxisAngle:function(e,t){this.quaternion.setFromAxisAngle(e,t)},setRotationFromEuler:function(e){this.quaternion.setFromEuler(e,!0)},setRotationFromMatrix:function(e){this.quaternion.setFromRotationMatrix(e)},setRotationFromQuaternion:function(e){this.quaternion.copy(e)},rotateOnAxis:function(e,t){return _q1.setFromAxisAngle(e,t),this.quaternion.multiply(_q1),this},rotateOnWorldAxis:function(e,t){return _q1.setFromAxisAngle(e,t),this.quaternion.premultiply(_q1),this},rotateX:function(e){return this.rotateOnAxis(_xAxis,e)},rotateY:function(e){return this.rotateOnAxis(_yAxis,e)},rotateZ:function(e){return this.rotateOnAxis(_zAxis,e)},translateOnAxis:function(e,t){return _v1$2.copy(e).applyQuaternion(this.quaternion),this.position.add(_v1$2.multiplyScalar(t)),this},translateX:function(e){return this.translateOnAxis(_xAxis,e)},translateY:function(e){return this.translateOnAxis(_yAxis,e)},translateZ:function(e){return this.translateOnAxis(_zAxis,e)},localToWorld:function(e){return e.applyMatrix4(this.matrixWorld)},worldToLocal:function(e){return e.applyMatrix4(_m1$1.copy(this.matrixWorld).invert())},lookAt:function(e,t,r){e.isVector3?_target.copy(e):_target.set(e,t,r);const n=this.parent;this.updateWorldMatrix(!0,!1),_position.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?_m1$1.lookAt(_position,_target,this.up):_m1$1.lookAt(_target,_position,this.up),this.quaternion.setFromRotationMatrix(_m1$1),n&&(_m1$1.extractRotation(n.matrixWorld),_q1.setFromRotationMatrix(_m1$1),this.quaternion.premultiply(_q1.invert()))},add:function(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,this.children.push(e),e.dispatchEvent(_addedEvent)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)},remove:function(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(_removedEvent)),this},clear:function(){for(let e=0;e<this.children.length;e++){const t=this.children[e];t.parent=null,t.dispatchEvent(_removedEvent)}return this.children.length=0,this},attach:function(e){return this.updateWorldMatrix(!0,!1),_m1$1.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),_m1$1.multiply(e.parent.matrixWorld)),e.applyMatrix4(_m1$1),this.add(e),e.updateWorldMatrix(!1,!0),this},getObjectById:function(e){return this.getObjectByProperty("id",e)},getObjectByName:function(e){return this.getObjectByProperty("name",e)},getObjectByProperty:function(e,t){if(this[e]===t)return this;for(let r=0,n=this.children.length;r<n;r++){const n=this.children[r].getObjectByProperty(e,t);if(void 0!==n)return n}},getWorldPosition:function(e){return void 0===e&&(console.warn("THREE.Object3D: .getWorldPosition() target is now required"),e=new Vector3),this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:function(e){return void 0===e&&(console.warn("THREE.Object3D: .getWorldQuaternion() target is now required"),e=new Quaternion),this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(_position,e,_scale),e},getWorldScale:function(e){return void 0===e&&(console.warn("THREE.Object3D: .getWorldScale() target is now required"),e=new Vector3),this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(_position,_quaternion$2,e),e},getWorldDirection:function(e){void 0===e&&(console.warn("THREE.Object3D: .getWorldDirection() target is now required"),e=new Vector3),this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()},raycast:function(){},traverse:function(e){e(this);const t=this.children;for(let r=0,n=t.length;r<n;r++)t[r].traverse(e)},traverseVisible:function(e){if(!1===this.visible)return;e(this);const t=this.children;for(let r=0,n=t.length;r<n;r++)t[r].traverseVisible(e)},traverseAncestors:function(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let r=0,n=t.length;r<n;r++)t[r].updateMatrixWorld(e)},updateWorldMatrix:function(e,t){const r=this.parent;if(!0===e&&null!==r&&r.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===t){const e=this.children;for(let t=0,r=e.length;t<r;t++)e[t].updateWorldMatrix(!1,!0)}},toJSON:function(e){const t=void 0===e||"string"==typeof e,r={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{}},r.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});const n={};function i(t,r){return void 0===t[r.uuid]&&(t[r.uuid]=r.toJSON(e)),r.uuid}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),this.isInstancedMesh&&(n.type="InstancedMesh",n.count=this.count,n.instanceMatrix=this.instanceMatrix.toJSON()),this.isMesh||this.isLine||this.isPoints){n.geometry=i(e.geometries,this.geometry);const t=this.geometry.parameters;if(void 0!==t&&void 0!==t.shapes){const r=t.shapes;if(Array.isArray(r))for(let t=0,n=r.length;t<n;t++){const n=r[t];i(e.shapes,n)}else i(e.shapes,r)}}if(this.isSkinnedMesh&&(n.bindMode=this.bindMode,n.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(i(e.skeletons,this.skeleton),n.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const t=[];for(let r=0,n=this.material.length;r<n;r++)t.push(i(e.materials,this.material[r]));n.material=t}else n.material=i(e.materials,this.material);if(this.children.length>0){n.children=[];for(let t=0;t<this.children.length;t++)n.children.push(this.children[t].toJSON(e).object)}if(this.animations.length>0){n.animations=[];for(let t=0;t<this.animations.length;t++){const r=this.animations[t];n.animations.push(i(e.animations,r))}}if(t){const t=a(e.geometries),n=a(e.materials),i=a(e.textures),o=a(e.images),s=a(e.shapes),l=a(e.skeletons),c=a(e.animations);t.length>0&&(r.geometries=t),n.length>0&&(r.materials=n),i.length>0&&(r.textures=i),o.length>0&&(r.images=o),s.length>0&&(r.shapes=s),l.length>0&&(r.skeletons=l),c.length>0&&(r.animations=c)}return r.object=n,r;function a(e){const t=[];for(const r in e){const n=e[r];delete n.metadata,t.push(n)}return t}},clone:function(e){return(new this.constructor).copy(this,e)},copy:function(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let t=0;t<e.children.length;t++){const r=e.children[t];this.add(r.clone())}return this}});const _vector1=new Vector3,_vector2=new Vector3,_normalMatrix=new Matrix3;class Plane{constructor(e=new Vector3(1,0,0),t=0){this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,r,n){return this.normal.set(e,t,r),this.constant=n,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,r){const n=_vector1.subVectors(r,t).cross(_vector2.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(n,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return void 0===t&&(console.warn("THREE.Plane: .projectPoint() target is now required"),t=new Vector3),t.copy(this.normal).multiplyScalar(-this.distanceToPoint(e)).add(e)}intersectLine(e,t){void 0===t&&(console.warn("THREE.Plane: .intersectLine() target is now required"),t=new Vector3);const r=e.delta(_vector1),n=this.normal.dot(r);if(0===n)return 0===this.distanceToPoint(e.start)?t.copy(e.start):void 0;const i=-(e.start.dot(this.normal)+this.constant)/n;return i<0||i>1?void 0:t.copy(r).multiplyScalar(i).add(e.start)}intersectsLine(e){const t=this.distanceToPoint(e.start),r=this.distanceToPoint(e.end);return t<0&&r>0||r<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return void 0===e&&(console.warn("THREE.Plane: .coplanarPoint() target is now required"),e=new Vector3),e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const r=t||_normalMatrix.getNormalMatrix(e),n=this.coplanarPoint(_vector1).applyMatrix4(e),i=this.normal.applyMatrix3(r).normalize();return this.constant=-n.dot(i),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new this.constructor).copy(this)}}Plane.prototype.isPlane=!0;const _v0$1=new Vector3,_v1$3=new Vector3,_v2$1=new Vector3,_v3=new Vector3,_vab=new Vector3,_vac=new Vector3,_vbc=new Vector3,_vap=new Vector3,_vbp=new Vector3,_vcp=new Vector3;class Triangle{constructor(e=new Vector3,t=new Vector3,r=new Vector3){this.a=e,this.b=t,this.c=r}static getNormal(e,t,r,n){void 0===n&&(console.warn("THREE.Triangle: .getNormal() target is now required"),n=new Vector3),n.subVectors(r,t),_v0$1.subVectors(e,t),n.cross(_v0$1);const i=n.lengthSq();return i>0?n.multiplyScalar(1/Math.sqrt(i)):n.set(0,0,0)}static getBarycoord(e,t,r,n,i){_v0$1.subVectors(n,t),_v1$3.subVectors(r,t),_v2$1.subVectors(e,t);const a=_v0$1.dot(_v0$1),o=_v0$1.dot(_v1$3),s=_v0$1.dot(_v2$1),l=_v1$3.dot(_v1$3),c=_v1$3.dot(_v2$1),h=a*l-o*o;if(void 0===i&&(console.warn("THREE.Triangle: .getBarycoord() target is now required"),i=new Vector3),0===h)return i.set(-2,-1,-1);const u=1/h,d=(l*s-o*c)*u,p=(a*c-o*s)*u;return i.set(1-d-p,p,d)}static containsPoint(e,t,r,n){return this.getBarycoord(e,t,r,n,_v3),_v3.x>=0&&_v3.y>=0&&_v3.x+_v3.y<=1}static getUV(e,t,r,n,i,a,o,s){return this.getBarycoord(e,t,r,n,_v3),s.set(0,0),s.addScaledVector(i,_v3.x),s.addScaledVector(a,_v3.y),s.addScaledVector(o,_v3.z),s}static isFrontFacing(e,t,r,n){return _v0$1.subVectors(r,t),_v1$3.subVectors(e,t),_v0$1.cross(_v1$3).dot(n)<0}set(e,t,r){return this.a.copy(e),this.b.copy(t),this.c.copy(r),this}setFromPointsAndIndices(e,t,r,n){return this.a.copy(e[t]),this.b.copy(e[r]),this.c.copy(e[n]),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return _v0$1.subVectors(this.c,this.b),_v1$3.subVectors(this.a,this.b),.5*_v0$1.cross(_v1$3).length()}getMidpoint(e){return void 0===e&&(console.warn("THREE.Triangle: .getMidpoint() target is now required"),e=new Vector3),e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return Triangle.getNormal(this.a,this.b,this.c,e)}getPlane(e){return void 0===e&&(console.warn("THREE.Triangle: .getPlane() target is now required"),e=new Plane),e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return Triangle.getBarycoord(e,this.a,this.b,this.c,t)}getUV(e,t,r,n,i){return Triangle.getUV(e,this.a,this.b,this.c,t,r,n,i)}containsPoint(e){return Triangle.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return Triangle.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){void 0===t&&(console.warn("THREE.Triangle: .closestPointToPoint() target is now required"),t=new Vector3);const r=this.a,n=this.b,i=this.c;let a,o;_vab.subVectors(n,r),_vac.subVectors(i,r),_vap.subVectors(e,r);const s=_vab.dot(_vap),l=_vac.dot(_vap);if(s<=0&&l<=0)return t.copy(r);_vbp.subVectors(e,n);const c=_vab.dot(_vbp),h=_vac.dot(_vbp);if(c>=0&&h<=c)return t.copy(n);const u=s*h-c*l;if(u<=0&&s>=0&&c<=0)return a=s/(s-c),t.copy(r).addScaledVector(_vab,a);_vcp.subVectors(e,i);const d=_vab.dot(_vcp),p=_vac.dot(_vcp);if(p>=0&&d<=p)return t.copy(i);const f=d*l-s*p;if(f<=0&&l>=0&&p<=0)return o=l/(l-p),t.copy(r).addScaledVector(_vac,o);const m=c*p-d*h;if(m<=0&&h-c>=0&&d-p>=0)return _vbc.subVectors(i,n),o=(h-c)/(h-c+(d-p)),t.copy(n).addScaledVector(_vbc,o);const g=1/(m+f+u);return a=f*g,o=u*g,t.copy(r).addScaledVector(_vab,a).addScaledVector(_vac,o)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}let materialId=0;function Material$1(){Object.defineProperty(this,"id",{value:materialId++}),this.uuid=MathUtils.generateUUID(),this.name="",this.type="Material",this.fog=!0,this.blending=NormalBlending,this.side=FrontSide,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.blendSrc=SrcAlphaFactor,this.blendDst=OneMinusSrcAlphaFactor,this.blendEquation=AddEquation,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=LessEqualDepth,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=AlwaysStencilFunc,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=KeepStencilOp,this.stencilZFail=KeepStencilOp,this.stencilZPass=KeepStencilOp,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaTest=0,this.premultipliedAlpha=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0}Material$1.prototype=Object.assign(Object.create(EventDispatcher.prototype),{constructor:Material$1,isMaterial:!0,onBeforeCompile:function(){},customProgramCacheKey:function(){return this.onBeforeCompile.toString()},setValues:function(e){if(void 0!==e)for(const t in e){const r=e[t];if(void 0===r){console.warn("THREE.Material: '"+t+"' parameter is undefined.");continue}if("shading"===t){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=r===FlatShading;continue}const n=this[t];void 0!==n?n&&n.isColor?n.set(r):n&&n.isVector3&&r&&r.isVector3?n.copy(r):this[t]=r:console.warn("THREE."+this.type+": '"+t+"' is not a property of this material.")}},toJSON:function(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});const r={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};function n(e){const t=[];for(const r in e){const n=e[r];delete n.metadata,t.push(n)}return t}if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),this.color&&this.color.isColor&&(r.color=this.color.getHex()),void 0!==this.roughness&&(r.roughness=this.roughness),void 0!==this.metalness&&(r.metalness=this.metalness),this.sheen&&this.sheen.isColor&&(r.sheen=this.sheen.getHex()),this.emissive&&this.emissive.isColor&&(r.emissive=this.emissive.getHex()),this.emissiveIntensity&&1!==this.emissiveIntensity&&(r.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(r.specular=this.specular.getHex()),void 0!==this.shininess&&(r.shininess=this.shininess),void 0!==this.clearcoat&&(r.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(r.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(r.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(r.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(r.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,r.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.map&&this.map.isTexture&&(r.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(r.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(r.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(r.lightMap=this.lightMap.toJSON(e).uuid,r.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(r.aoMap=this.aoMap.toJSON(e).uuid,r.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(r.bumpMap=this.bumpMap.toJSON(e).uuid,r.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(r.normalMap=this.normalMap.toJSON(e).uuid,r.normalMapType=this.normalMapType,r.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(r.displacementMap=this.displacementMap.toJSON(e).uuid,r.displacementScale=this.displacementScale,r.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(r.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(r.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(r.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(r.specularMap=this.specularMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(r.envMap=this.envMap.toJSON(e).uuid,r.reflectivity=this.reflectivity,r.refractionRatio=this.refractionRatio,void 0!==this.combine&&(r.combine=this.combine),void 0!==this.envMapIntensity&&(r.envMapIntensity=this.envMapIntensity)),this.gradientMap&&this.gradientMap.isTexture&&(r.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.size&&(r.size=this.size),void 0!==this.sizeAttenuation&&(r.sizeAttenuation=this.sizeAttenuation),this.blending!==NormalBlending&&(r.blending=this.blending),this.side!==FrontSide&&(r.side=this.side),this.vertexColors&&(r.vertexColors=!0),this.opacity<1&&(r.opacity=this.opacity),!0===this.transparent&&(r.transparent=this.transparent),r.depthFunc=this.depthFunc,r.depthTest=this.depthTest,r.depthWrite=this.depthWrite,r.stencilWrite=this.stencilWrite,r.stencilWriteMask=this.stencilWriteMask,r.stencilFunc=this.stencilFunc,r.stencilRef=this.stencilRef,r.stencilFuncMask=this.stencilFuncMask,r.stencilFail=this.stencilFail,r.stencilZFail=this.stencilZFail,r.stencilZPass=this.stencilZPass,this.rotation&&0!==this.rotation&&(r.rotation=this.rotation),!0===this.polygonOffset&&(r.polygonOffset=!0),0!==this.polygonOffsetFactor&&(r.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(r.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth&&1!==this.linewidth&&(r.linewidth=this.linewidth),void 0!==this.dashSize&&(r.dashSize=this.dashSize),void 0!==this.gapSize&&(r.gapSize=this.gapSize),void 0!==this.scale&&(r.scale=this.scale),!0===this.dithering&&(r.dithering=!0),this.alphaTest>0&&(r.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(r.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(r.wireframe=this.wireframe),this.wireframeLinewidth>1&&(r.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(r.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(r.wireframeLinejoin=this.wireframeLinejoin),!0===this.morphTargets&&(r.morphTargets=!0),!0===this.morphNormals&&(r.morphNormals=!0),!0===this.skinning&&(r.skinning=!0),!0===this.flatShading&&(r.flatShading=this.flatShading),!1===this.visible&&(r.visible=!1),!1===this.toneMapped&&(r.toneMapped=!1),"{}"!==JSON.stringify(this.userData)&&(r.userData=this.userData),t){const t=n(e.textures),i=n(e.images);t.length>0&&(r.textures=t),i.length>0&&(r.images=i)}return r},clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.name=e.name,this.fog=e.fog,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let r=null;if(null!==t){const e=t.length;r=new Array(e);for(let n=0;n!==e;++n)r[n]=t[n].clone()}return this.clippingPlanes=r,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.premultipliedAlpha=e.premultipliedAlpha,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Object.defineProperty(Material$1.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}});const _colorKeywords={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},_hslA={h:0,s:0,l:0},_hslB={h:0,s:0,l:0};function hue2rgb(e,t,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+6*(t-e)*r:r<.5?t:r<2/3?e+6*(t-e)*(2/3-r):e}function SRGBToLinear(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function LinearToSRGB(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}class Color{constructor(e,t,r){return void 0===t&&void 0===r?this.set(e):this.setRGB(e,t,r)}set(e){return e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e),this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this}setRGB(e,t,r){return this.r=e,this.g=t,this.b=r,this}setHSL(e,t,r){if(e=MathUtils.euclideanModulo(e,1),t=MathUtils.clamp(t,0,1),r=MathUtils.clamp(r,0,1),0===t)this.r=this.g=this.b=r;else{const n=r<=.5?r*(1+t):r+t-r*t,i=2*r-n;this.r=hue2rgb(i,n,e+1/3),this.g=hue2rgb(i,n,e),this.b=hue2rgb(i,n,e-1/3)}return this}setStyle(e){function t(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}let r;if(r=/^((?:rgb|hsl)a?)\(([^\)]*)\)/.exec(e)){let e;const n=r[1],i=r[2];switch(n){case"rgb":case"rgba":if(e=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(i))return this.r=Math.min(255,parseInt(e[1],10))/255,this.g=Math.min(255,parseInt(e[2],10))/255,this.b=Math.min(255,parseInt(e[3],10))/255,t(e[4]),this;if(e=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(i))return this.r=Math.min(100,parseInt(e[1],10))/100,this.g=Math.min(100,parseInt(e[2],10))/100,this.b=Math.min(100,parseInt(e[3],10))/100,t(e[4]),this;break;case"hsl":case"hsla":if(e=/^\s*(\d*\.?\d+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(i)){const r=parseFloat(e[1])/360,n=parseInt(e[2],10)/100,i=parseInt(e[3],10)/100;return t(e[4]),this.setHSL(r,n,i)}}}else if(r=/^\#([A-Fa-f\d]+)$/.exec(e)){const e=r[1],t=e.length;if(3===t)return this.r=parseInt(e.charAt(0)+e.charAt(0),16)/255,this.g=parseInt(e.charAt(1)+e.charAt(1),16)/255,this.b=parseInt(e.charAt(2)+e.charAt(2),16)/255,this;if(6===t)return this.r=parseInt(e.charAt(0)+e.charAt(1),16)/255,this.g=parseInt(e.charAt(2)+e.charAt(3),16)/255,this.b=parseInt(e.charAt(4)+e.charAt(5),16)/255,this}return e&&e.length>0?this.setColorName(e):this}setColorName(e){const t=_colorKeywords[e];return void 0!==t?this.setHex(t):console.warn("THREE.Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyGammaToLinear(e,t=2){return this.r=Math.pow(e.r,t),this.g=Math.pow(e.g,t),this.b=Math.pow(e.b,t),this}copyLinearToGamma(e,t=2){const r=t>0?1/t:1;return this.r=Math.pow(e.r,r),this.g=Math.pow(e.g,r),this.b=Math.pow(e.b,r),this}convertGammaToLinear(e){return this.copyGammaToLinear(this,e),this}convertLinearToGamma(e){return this.copyLinearToGamma(this,e),this}copySRGBToLinear(e){return this.r=SRGBToLinear(e.r),this.g=SRGBToLinear(e.g),this.b=SRGBToLinear(e.b),this}copyLinearToSRGB(e){return this.r=LinearToSRGB(e.r),this.g=LinearToSRGB(e.g),this.b=LinearToSRGB(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0}getHexString(){return("000000"+this.getHex().toString(16)).slice(-6)}getHSL(e){void 0===e&&(console.warn("THREE.Color: .getHSL() target is now required"),e={h:0,s:0,l:0});const t=this.r,r=this.g,n=this.b,i=Math.max(t,r,n),a=Math.min(t,r,n);let o,s;const l=(a+i)/2;if(a===i)o=0,s=0;else{const e=i-a;switch(s=l<=.5?e/(i+a):e/(2-i-a),i){case t:o=(r-n)/e+(r<n?6:0);break;case r:o=(n-t)/e+2;break;case n:o=(t-r)/e+4}o/=6}return e.h=o,e.s=s,e.l=l,e}getStyle(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"}offsetHSL(e,t,r){return this.getHSL(_hslA),_hslA.h+=e,_hslA.s+=t,_hslA.l+=r,this.setHSL(_hslA.h,_hslA.s,_hslA.l),this}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,r){return this.r=e.r+(t.r-e.r)*r,this.g=e.g+(t.g-e.g)*r,this.b=e.b+(t.b-e.b)*r,this}lerpHSL(e,t){this.getHSL(_hslA),e.getHSL(_hslB);const r=MathUtils.lerp(_hslA.h,_hslB.h,t),n=MathUtils.lerp(_hslA.s,_hslB.s,t),i=MathUtils.lerp(_hslA.l,_hslB.l,t);return this.setHSL(r,n,i),this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),!0===e.normalized&&(this.r/=255,this.g/=255,this.b/=255),this}toJSON(){return this.getHex()}}Color.NAMES=_colorKeywords,Color.prototype.isColor=!0,Color.prototype.r=1,Color.prototype.g=1,Color.prototype.b=1;class MeshBasicMaterial extends Material$1{constructor(e){super(),this.type="MeshBasicMaterial",this.color=new Color(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this}}MeshBasicMaterial.prototype.isMeshBasicMaterial=!0;const _vector$3=new Vector3,_vector2$1=new Vector2;function BufferAttribute(e,t,r){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=!0===r,this.usage=StaticDrawUsage,this.updateRange={offset:0,count:-1},this.version=0}function Int8BufferAttribute(e,t,r){BufferAttribute.call(this,new Int8Array(e),t,r)}function Uint8BufferAttribute(e,t,r){BufferAttribute.call(this,new Uint8Array(e),t,r)}function Uint8ClampedBufferAttribute(e,t,r){BufferAttribute.call(this,new Uint8ClampedArray(e),t,r)}function Int16BufferAttribute(e,t,r){BufferAttribute.call(this,new Int16Array(e),t,r)}function Uint16BufferAttribute(e,t,r){BufferAttribute.call(this,new Uint16Array(e),t,r)}function Int32BufferAttribute(e,t,r){BufferAttribute.call(this,new Int32Array(e),t,r)}function Uint32BufferAttribute(e,t,r){BufferAttribute.call(this,new Uint32Array(e),t,r)}function Float16BufferAttribute(e,t,r){BufferAttribute.call(this,new Uint16Array(e),t,r)}function Float32BufferAttribute(e,t,r){BufferAttribute.call(this,new Float32Array(e),t,r)}function Float64BufferAttribute(e,t,r){BufferAttribute.call(this,new Float64Array(e),t,r)}function arrayMax(e){if(0===e.length)return-1/0;let t=e[0];for(let r=1,n=e.length;r<n;++r)e[r]>t&&(t=e[r]);return t}Object.defineProperty(BufferAttribute.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(BufferAttribute.prototype,{isBufferAttribute:!0,onUploadCallback:function(){},setUsage:function(e){return this.usage=e,this},copy:function(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this},copyAt:function(e,t,r){e*=this.itemSize,r*=t.itemSize;for(let n=0,i=this.itemSize;n<i;n++)this.array[e+n]=t.array[r+n];return this},copyArray:function(e){return this.array.set(e),this},copyColorsArray:function(e){const t=this.array;let r=0;for(let n=0,i=e.length;n<i;n++){let i=e[n];void 0===i&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",n),i=new Color),t[r++]=i.r,t[r++]=i.g,t[r++]=i.b}return this},copyVector2sArray:function(e){const t=this.array;let r=0;for(let n=0,i=e.length;n<i;n++){let i=e[n];void 0===i&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",n),i=new Vector2),t[r++]=i.x,t[r++]=i.y}return this},copyVector3sArray:function(e){const t=this.array;let r=0;for(let n=0,i=e.length;n<i;n++){let i=e[n];void 0===i&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",n),i=new Vector3),t[r++]=i.x,t[r++]=i.y,t[r++]=i.z}return this},copyVector4sArray:function(e){const t=this.array;let r=0;for(let n=0,i=e.length;n<i;n++){let i=e[n];void 0===i&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",n),i=new Vector4),t[r++]=i.x,t[r++]=i.y,t[r++]=i.z,t[r++]=i.w}return this},applyMatrix3:function(e){if(2===this.itemSize)for(let t=0,r=this.count;t<r;t++)_vector2$1.fromBufferAttribute(this,t),_vector2$1.applyMatrix3(e),this.setXY(t,_vector2$1.x,_vector2$1.y);else if(3===this.itemSize)for(let t=0,r=this.count;t<r;t++)_vector$3.fromBufferAttribute(this,t),_vector$3.applyMatrix3(e),this.setXYZ(t,_vector$3.x,_vector$3.y,_vector$3.z);return this},applyMatrix4:function(e){for(let t=0,r=this.count;t<r;t++)_vector$3.x=this.getX(t),_vector$3.y=this.getY(t),_vector$3.z=this.getZ(t),_vector$3.applyMatrix4(e),this.setXYZ(t,_vector$3.x,_vector$3.y,_vector$3.z);return this},applyNormalMatrix:function(e){for(let t=0,r=this.count;t<r;t++)_vector$3.x=this.getX(t),_vector$3.y=this.getY(t),_vector$3.z=this.getZ(t),_vector$3.applyNormalMatrix(e),this.setXYZ(t,_vector$3.x,_vector$3.y,_vector$3.z);return this},transformDirection:function(e){for(let t=0,r=this.count;t<r;t++)_vector$3.x=this.getX(t),_vector$3.y=this.getY(t),_vector$3.z=this.getZ(t),_vector$3.transformDirection(e),this.setXYZ(t,_vector$3.x,_vector$3.y,_vector$3.z);return this},set:function(e,t=0){return this.array.set(e,t),this},getX:function(e){return this.array[e*this.itemSize]},setX:function(e,t){return this.array[e*this.itemSize]=t,this},getY:function(e){return this.array[e*this.itemSize+1]},setY:function(e,t){return this.array[e*this.itemSize+1]=t,this},getZ:function(e){return this.array[e*this.itemSize+2]},setZ:function(e,t){return this.array[e*this.itemSize+2]=t,this},getW:function(e){return this.array[e*this.itemSize+3]},setW:function(e,t){return this.array[e*this.itemSize+3]=t,this},setXY:function(e,t,r){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this},setXYZ:function(e,t,r,n){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this.array[e+2]=n,this},setXYZW:function(e,t,r,n,i){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this.array[e+2]=n,this.array[e+3]=i,this},onUpload:function(e){return this.onUploadCallback=e,this},clone:function(){return new this.constructor(this.array,this.itemSize).copy(this)},toJSON:function(){return{itemSize:this.itemSize,type:this.array.constructor.name,array:Array.prototype.slice.call(this.array),normalized:this.normalized}}}),Int8BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Int8BufferAttribute.prototype.constructor=Int8BufferAttribute,Uint8BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Uint8BufferAttribute.prototype.constructor=Uint8BufferAttribute,Uint8ClampedBufferAttribute.prototype=Object.create(BufferAttribute.prototype),Uint8ClampedBufferAttribute.prototype.constructor=Uint8ClampedBufferAttribute,Int16BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Int16BufferAttribute.prototype.constructor=Int16BufferAttribute,Uint16BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Uint16BufferAttribute.prototype.constructor=Uint16BufferAttribute,Int32BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Int32BufferAttribute.prototype.constructor=Int32BufferAttribute,Uint32BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Uint32BufferAttribute.prototype.constructor=Uint32BufferAttribute,Float16BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Float16BufferAttribute.prototype.constructor=Float16BufferAttribute,Float16BufferAttribute.prototype.isFloat16BufferAttribute=!0,Float32BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Float32BufferAttribute.prototype.constructor=Float32BufferAttribute,Float64BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Float64BufferAttribute.prototype.constructor=Float64BufferAttribute;const TYPED_ARRAYS={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:Uint8ClampedArray,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};function getTypedArray(e,t){return new TYPED_ARRAYS[e](t)}let _id=0;const _m1$2=new Matrix4,_obj=new Object3D,_offset=new Vector3,_box$2=new Box3,_boxMorphTargets=new Box3,_vector$4=new Vector3;function BufferGeometry(){Object.defineProperty(this,"id",{value:_id++}),this.uuid=MathUtils.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}BufferGeometry.prototype=Object.assign(Object.create(EventDispatcher.prototype),{constructor:BufferGeometry,isBufferGeometry:!0,getIndex:function(){return this.index},setIndex:function(e){return Array.isArray(e)?this.index=new(arrayMax(e)>65535?Uint32BufferAttribute:Uint16BufferAttribute)(e,1):this.index=e,this},getAttribute:function(e){return this.attributes[e]},setAttribute:function(e,t){return this.attributes[e]=t,this},deleteAttribute:function(e){return delete this.attributes[e],this},hasAttribute:function(e){return void 0!==this.attributes[e]},addGroup:function(e,t,r=0){this.groups.push({start:e,count:t,materialIndex:r})},clearGroups:function(){this.groups=[]},setDrawRange:function(e,t){this.drawRange.start=e,this.drawRange.count=t},applyMatrix4:function(e){const t=this.attributes.position;void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0);const r=this.attributes.normal;if(void 0!==r){const t=(new Matrix3).getNormalMatrix(e);r.applyNormalMatrix(t),r.needsUpdate=!0}const n=this.attributes.tangent;return void 0!==n&&(n.transformDirection(e),n.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},rotateX:function(e){return _m1$2.makeRotationX(e),this.applyMatrix4(_m1$2),this},rotateY:function(e){return _m1$2.makeRotationY(e),this.applyMatrix4(_m1$2),this},rotateZ:function(e){return _m1$2.makeRotationZ(e),this.applyMatrix4(_m1$2),this},translate:function(e,t,r){return _m1$2.makeTranslation(e,t,r),this.applyMatrix4(_m1$2),this},scale:function(e,t,r){return _m1$2.makeScale(e,t,r),this.applyMatrix4(_m1$2),this},lookAt:function(e){return _obj.lookAt(e),_obj.updateMatrix(),this.applyMatrix4(_obj.matrix),this},center:function(){return this.computeBoundingBox(),this.boundingBox.getCenter(_offset).negate(),this.translate(_offset.x,_offset.y,_offset.z),this},setFromPoints:function(e){const t=[];for(let r=0,n=e.length;r<n;r++){const n=e[r];t.push(n.x,n.y,n.z||0)}return this.setAttribute("position",new Float32BufferAttribute(t,3)),this},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new Box3);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingBox.set(new Vector3(-1/0,-1/0,-1/0),new Vector3(1/0,1/0,1/0));if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),t)for(let e=0,r=t.length;e<r;e++){const r=t[e];_box$2.setFromBufferAttribute(r),this.morphTargetsRelative?(_vector$4.addVectors(this.boundingBox.min,_box$2.min),this.boundingBox.expandByPoint(_vector$4),_vector$4.addVectors(this.boundingBox.max,_box$2.max),this.boundingBox.expandByPoint(_vector$4)):(this.boundingBox.expandByPoint(_box$2.min),this.boundingBox.expandByPoint(_box$2.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new Sphere);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingSphere.set(new Vector3,1/0);if(e){const r=this.boundingSphere.center;if(_box$2.setFromBufferAttribute(e),t)for(let e=0,r=t.length;e<r;e++){const r=t[e];_boxMorphTargets.setFromBufferAttribute(r),this.morphTargetsRelative?(_vector$4.addVectors(_box$2.min,_boxMorphTargets.min),_box$2.expandByPoint(_vector$4),_vector$4.addVectors(_box$2.max,_boxMorphTargets.max),_box$2.expandByPoint(_vector$4)):(_box$2.expandByPoint(_boxMorphTargets.min),_box$2.expandByPoint(_boxMorphTargets.max))}_box$2.getCenter(r);let n=0;for(let t=0,i=e.count;t<i;t++)_vector$4.fromBufferAttribute(e,t),n=Math.max(n,r.distanceToSquared(_vector$4));if(t)for(let i=0,a=t.length;i<a;i++){const a=t[i],o=this.morphTargetsRelative;for(let t=0,i=a.count;t<i;t++)_vector$4.fromBufferAttribute(a,t),o&&(_offset.fromBufferAttribute(e,t),_vector$4.add(_offset)),n=Math.max(n,r.distanceToSquared(_vector$4))}this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}},computeFaceNormals:function(){},computeTangents:function(){const e=this.index,t=this.attributes;if(null===e||void 0===t.position||void 0===t.normal||void 0===t.uv)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const r=e.array,n=t.position.array,i=t.normal.array,a=t.uv.array,o=n.length/3;void 0===t.tangent&&this.setAttribute("tangent",new BufferAttribute(new Float32Array(4*o),4));const s=t.tangent.array,l=[],c=[];for(let e=0;e<o;e++)l[e]=new Vector3,c[e]=new Vector3;const h=new Vector3,u=new Vector3,d=new Vector3,p=new Vector2,f=new Vector2,m=new Vector2,g=new Vector3,y=new Vector3;function v(e,t,r){h.fromArray(n,3*e),u.fromArray(n,3*t),d.fromArray(n,3*r),p.fromArray(a,2*e),f.fromArray(a,2*t),m.fromArray(a,2*r),u.sub(h),d.sub(h),f.sub(p),m.sub(p);const i=1/(f.x*m.y-m.x*f.y);isFinite(i)&&(g.copy(u).multiplyScalar(m.y).addScaledVector(d,-f.y).multiplyScalar(i),y.copy(d).multiplyScalar(f.x).addScaledVector(u,-m.x).multiplyScalar(i),l[e].add(g),l[t].add(g),l[r].add(g),c[e].add(y),c[t].add(y),c[r].add(y))}let b=this.groups;0===b.length&&(b=[{start:0,count:r.length}]);for(let e=0,t=b.length;e<t;++e){const t=b[e],n=t.start;for(let e=n,i=n+t.count;e<i;e+=3)v(r[e+0],r[e+1],r[e+2])}const _=new Vector3,x=new Vector3,w=new Vector3,S=new Vector3;function M(e){w.fromArray(i,3*e),S.copy(w);const t=l[e];_.copy(t),_.sub(w.multiplyScalar(w.dot(t))).normalize(),x.crossVectors(S,t);const r=x.dot(c[e])<0?-1:1;s[4*e]=_.x,s[4*e+1]=_.y,s[4*e+2]=_.z,s[4*e+3]=r}for(let e=0,t=b.length;e<t;++e){const t=b[e],n=t.start;for(let e=n,i=n+t.count;e<i;e+=3)M(r[e+0]),M(r[e+1]),M(r[e+2])}},computeVertexNormals:function(){const e=this.index,t=this.getAttribute("position");if(void 0!==t){let r=this.getAttribute("normal");if(void 0===r)r=new BufferAttribute(new Float32Array(3*t.count),3),this.setAttribute("normal",r);else for(let e=0,t=r.count;e<t;e++)r.setXYZ(e,0,0,0);const n=new Vector3,i=new Vector3,a=new Vector3,o=new Vector3,s=new Vector3,l=new Vector3,c=new Vector3,h=new Vector3;if(e)for(let u=0,d=e.count;u<d;u+=3){const d=e.getX(u+0),p=e.getX(u+1),f=e.getX(u+2);n.fromBufferAttribute(t,d),i.fromBufferAttribute(t,p),a.fromBufferAttribute(t,f),c.subVectors(a,i),h.subVectors(n,i),c.cross(h),o.fromBufferAttribute(r,d),s.fromBufferAttribute(r,p),l.fromBufferAttribute(r,f),o.add(c),s.add(c),l.add(c),r.setXYZ(d,o.x,o.y,o.z),r.setXYZ(p,s.x,s.y,s.z),r.setXYZ(f,l.x,l.y,l.z)}else for(let e=0,o=t.count;e<o;e+=3)n.fromBufferAttribute(t,e+0),i.fromBufferAttribute(t,e+1),a.fromBufferAttribute(t,e+2),c.subVectors(a,i),h.subVectors(n,i),c.cross(h),r.setXYZ(e+0,c.x,c.y,c.z),r.setXYZ(e+1,c.x,c.y,c.z),r.setXYZ(e+2,c.x,c.y,c.z);this.normalizeNormals(),r.needsUpdate=!0}},merge:function(e,t){if(!e||!e.isBufferGeometry)return void console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",e);void 0===t&&(t=0,console.warn("THREE.BufferGeometry.merge(): Overwriting original geometry, starting at offset=0. Use BufferGeometryUtils.mergeBufferGeometries() for lossless merge."));const r=this.attributes;for(const n in r){if(void 0===e.attributes[n])continue;const i=r[n].array,a=e.attributes[n],o=a.array,s=a.itemSize*t,l=Math.min(o.length,i.length-s);for(let e=0,t=s;e<l;e++,t++)i[t]=o[e]}return this},normalizeNormals:function(){const e=this.attributes.normal;for(let t=0,r=e.count;t<r;t++)_vector$4.fromBufferAttribute(e,t),_vector$4.normalize(),e.setXYZ(t,_vector$4.x,_vector$4.y,_vector$4.z)},toNonIndexed:function(){function e(e,t){const r=e.array,n=e.itemSize,i=e.normalized,a=new r.constructor(t.length*n);let o=0,s=0;for(let e=0,i=t.length;e<i;e++){o=t[e]*n;for(let e=0;e<n;e++)a[s++]=r[o++]}return new BufferAttribute(a,n,i)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const t=new BufferGeometry,r=this.index.array,n=this.attributes;for(const i in n){const a=e(n[i],r);t.setAttribute(i,a)}const i=this.morphAttributes;for(const n in i){const a=[],o=i[n];for(let t=0,n=o.length;t<n;t++){const n=e(o[t],r);a.push(n)}t.morphAttributes[n]=a}t.morphTargetsRelative=this.morphTargetsRelative;const a=this.groups;for(let e=0,r=a.length;e<r;e++){const r=a[e];t.addGroup(r.start,r.count,r.materialIndex)}return t},toJSON:function(){const e={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){const t=this.parameters;for(const r in t)void 0!==t[r]&&(e[r]=t[r]);return e}e.data={attributes:{}};const t=this.index;null!==t&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const r=this.attributes;for(const t in r){const n=r[t],i=n.toJSON(e.data);""!==n.name&&(i.name=n.name),e.data.attributes[t]=i}const n={};let i=!1;for(const t in this.morphAttributes){const r=this.morphAttributes[t],a=[];for(let t=0,n=r.length;t<n;t++){const n=r[t],i=n.toJSON(e.data);""!==n.name&&(i.name=n.name),a.push(i)}a.length>0&&(n[t]=a,i=!0)}i&&(e.data.morphAttributes=n,e.data.morphTargetsRelative=this.morphTargetsRelative);const a=this.groups;a.length>0&&(e.data.groups=JSON.parse(JSON.stringify(a)));const o=this.boundingSphere;return null!==o&&(e.data.boundingSphere={center:o.center.toArray(),radius:o.radius}),e},clone:function(){return(new BufferGeometry).copy(this)},copy:function(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const r=e.index;null!==r&&this.setIndex(r.clone(t));const n=e.attributes;for(const e in n){const r=n[e];this.setAttribute(e,r.clone(t))}const i=e.morphAttributes;for(const e in i){const r=[],n=i[e];for(let e=0,i=n.length;e<i;e++)r.push(n[e].clone(t));this.morphAttributes[e]=r}this.morphTargetsRelative=e.morphTargetsRelative;const a=e.groups;for(let e=0,t=a.length;e<t;e++){const t=a[e];this.addGroup(t.start,t.count,t.materialIndex)}const o=e.boundingBox;null!==o&&(this.boundingBox=o.clone());const s=e.boundingSphere;return null!==s&&(this.boundingSphere=s.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this},dispose:function(){this.dispatchEvent({type:"dispose"})}});const _inverseMatrix=new Matrix4,_ray=new Ray,_sphere=new Sphere,_vA=new Vector3,_vB=new Vector3,_vC=new Vector3,_tempA=new Vector3,_tempB=new Vector3,_tempC=new Vector3,_morphA=new Vector3,_morphB=new Vector3,_morphC=new Vector3,_uvA=new Vector2,_uvB=new Vector2,_uvC=new Vector2,_intersectionPoint=new Vector3,_intersectionPointWorld=new Vector3;function Mesh(e=new BufferGeometry,t=new MeshBasicMaterial){Object3D.call(this),this.type="Mesh",this.geometry=e,this.material=t,this.updateMorphTargets()}function checkIntersection(e,t,r,n,i,a,o,s){let l;if(l=t.side===BackSide?n.intersectTriangle(o,a,i,!0,s):n.intersectTriangle(i,a,o,t.side!==DoubleSide,s),null===l)return null;_intersectionPointWorld.copy(s),_intersectionPointWorld.applyMatrix4(e.matrixWorld);const c=r.ray.origin.distanceTo(_intersectionPointWorld);return c<r.near||c>r.far?null:{distance:c,point:_intersectionPointWorld.clone(),object:e}}function checkBufferGeometryIntersection(e,t,r,n,i,a,o,s,l,c,h,u){_vA.fromBufferAttribute(i,c),_vB.fromBufferAttribute(i,h),_vC.fromBufferAttribute(i,u);const d=e.morphTargetInfluences;if(t.morphTargets&&a&&d){_morphA.set(0,0,0),_morphB.set(0,0,0),_morphC.set(0,0,0);for(let e=0,t=a.length;e<t;e++){const t=d[e],r=a[e];0!==t&&(_tempA.fromBufferAttribute(r,c),_tempB.fromBufferAttribute(r,h),_tempC.fromBufferAttribute(r,u),o?(_morphA.addScaledVector(_tempA,t),_morphB.addScaledVector(_tempB,t),_morphC.addScaledVector(_tempC,t)):(_morphA.addScaledVector(_tempA.sub(_vA),t),_morphB.addScaledVector(_tempB.sub(_vB),t),_morphC.addScaledVector(_tempC.sub(_vC),t)))}_vA.add(_morphA),_vB.add(_morphB),_vC.add(_morphC)}e.isSkinnedMesh&&t.skinning&&(e.boneTransform(c,_vA),e.boneTransform(h,_vB),e.boneTransform(u,_vC));const p=checkIntersection(e,t,r,n,_vA,_vB,_vC,_intersectionPoint);if(p){s&&(_uvA.fromBufferAttribute(s,c),_uvB.fromBufferAttribute(s,h),_uvC.fromBufferAttribute(s,u),p.uv=Triangle.getUV(_intersectionPoint,_vA,_vB,_vC,_uvA,_uvB,_uvC,new Vector2)),l&&(_uvA.fromBufferAttribute(l,c),_uvB.fromBufferAttribute(l,h),_uvC.fromBufferAttribute(l,u),p.uv2=Triangle.getUV(_intersectionPoint,_vA,_vB,_vC,_uvA,_uvB,_uvC,new Vector2));const e={a:c,b:h,c:u,normal:new Vector3,materialIndex:0};Triangle.getNormal(_vA,_vB,_vC,e.normal),p.face=e}return p}Mesh.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Mesh,isMesh:!0,copy:function(e){return Object3D.prototype.copy.call(this,e),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=e.material,this.geometry=e.geometry,this},updateMorphTargets:function(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,r=Object.keys(t);if(r.length>0){const e=t[r[0]];if(void 0!==e){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,r=e.length;t<r;t++){const r=e[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[r]=t}}}}else{const t=e.morphTargets;void 0!==t&&t.length>0&&console.error("THREE.Mesh.updateMorphTargets() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}},raycast:function(e,t){const r=this.geometry,n=this.material,i=this.matrixWorld;if(void 0===n)return;if(null===r.boundingSphere&&r.computeBoundingSphere(),_sphere.copy(r.boundingSphere),_sphere.applyMatrix4(i),!1===e.ray.intersectsSphere(_sphere))return;if(_inverseMatrix.copy(i).invert(),_ray.copy(e.ray).applyMatrix4(_inverseMatrix),null!==r.boundingBox&&!1===_ray.intersectsBox(r.boundingBox))return;let a;if(r.isBufferGeometry){const i=r.index,o=r.attributes.position,s=r.morphAttributes.position,l=r.morphTargetsRelative,c=r.attributes.uv,h=r.attributes.uv2,u=r.groups,d=r.drawRange;if(null!==i)if(Array.isArray(n))for(let r=0,p=u.length;r<p;r++){const p=u[r],f=n[p.materialIndex];for(let r=Math.max(p.start,d.start),n=Math.min(p.start+p.count,d.start+d.count);r<n;r+=3){const n=i.getX(r),u=i.getX(r+1),d=i.getX(r+2);a=checkBufferGeometryIntersection(this,f,e,_ray,o,s,l,c,h,n,u,d),a&&(a.faceIndex=Math.floor(r/3),a.face.materialIndex=p.materialIndex,t.push(a))}}else{for(let r=Math.max(0,d.start),u=Math.min(i.count,d.start+d.count);r<u;r+=3){const u=i.getX(r),d=i.getX(r+1),p=i.getX(r+2);a=checkBufferGeometryIntersection(this,n,e,_ray,o,s,l,c,h,u,d,p),a&&(a.faceIndex=Math.floor(r/3),t.push(a))}}else if(void 0!==o)if(Array.isArray(n))for(let r=0,i=u.length;r<i;r++){const i=u[r],p=n[i.materialIndex];for(let r=Math.max(i.start,d.start),n=Math.min(i.start+i.count,d.start+d.count);r<n;r+=3){a=checkBufferGeometryIntersection(this,p,e,_ray,o,s,l,c,h,r,r+1,r+2),a&&(a.faceIndex=Math.floor(r/3),a.face.materialIndex=i.materialIndex,t.push(a))}}else{for(let r=Math.max(0,d.start),i=Math.min(o.count,d.start+d.count);r<i;r+=3){a=checkBufferGeometryIntersection(this,n,e,_ray,o,s,l,c,h,r,r+1,r+2),a&&(a.faceIndex=Math.floor(r/3),t.push(a))}}}else r.isGeometry&&console.error("THREE.Mesh.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}});class BoxGeometry extends BufferGeometry{constructor(e=1,t=1,r=1,n=1,i=1,a=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:r,widthSegments:n,heightSegments:i,depthSegments:a};const o=this;n=Math.floor(n),i=Math.floor(i),a=Math.floor(a);const s=[],l=[],c=[],h=[];let u=0,d=0;function p(e,t,r,n,i,a,p,f,m,g,y){const v=a/m,b=p/g,_=a/2,x=p/2,w=f/2,S=m+1,M=g+1;let T=0,A=0;const E=new Vector3;for(let a=0;a<M;a++){const o=a*b-x;for(let s=0;s<S;s++){const u=s*v-_;E[e]=u*n,E[t]=o*i,E[r]=w,l.push(E.x,E.y,E.z),E[e]=0,E[t]=0,E[r]=f>0?1:-1,c.push(E.x,E.y,E.z),h.push(s/m),h.push(1-a/g),T+=1}}for(let e=0;e<g;e++)for(let t=0;t<m;t++){const r=u+t+S*e,n=u+t+S*(e+1),i=u+(t+1)+S*(e+1),a=u+(t+1)+S*e;s.push(r,n,a),s.push(n,i,a),A+=6}o.addGroup(d,A,y),d+=A,u+=T}p("z","y","x",-1,-1,r,t,e,a,i,0),p("z","y","x",1,-1,r,t,-e,a,i,1),p("x","z","y",1,1,e,r,t,n,a,2),p("x","z","y",1,-1,e,r,-t,n,a,3),p("x","y","z",1,-1,e,t,r,n,i,4),p("x","y","z",-1,-1,e,t,-r,n,i,5),this.setIndex(s),this.setAttribute("position",new Float32BufferAttribute(l,3)),this.setAttribute("normal",new Float32BufferAttribute(c,3)),this.setAttribute("uv",new Float32BufferAttribute(h,2))}}function cloneUniforms(e){const t={};for(const r in e){t[r]={};for(const n in e[r]){const i=e[r][n];i&&(i.isColor||i.isMatrix3||i.isMatrix4||i.isVector2||i.isVector3||i.isVector4||i.isTexture||i.isQuaternion)?t[r][n]=i.clone():Array.isArray(i)?t[r][n]=i.slice():t[r][n]=i}}return t}function mergeUniforms(e){const t={};for(let r=0;r<e.length;r++){const n=cloneUniforms(e[r]);for(const e in n)t[e]=n[e]}return t}const UniformsUtils={clone:cloneUniforms,merge:mergeUniforms};var default_vertex="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",default_fragment="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}";function ShaderMaterial(e){Material$1.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader=default_vertex,this.fragmentShader=default_fragment,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&(void 0!==e.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e))}function Camera$1$1(){Object3D.call(this),this.type="Camera",this.matrixWorldInverse=new Matrix4,this.projectionMatrix=new Matrix4,this.projectionMatrixInverse=new Matrix4}function PerspectiveCamera(e=50,t=1,r=.1,n=2e3){Camera$1$1.call(this),this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=r,this.far=n,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}ShaderMaterial.prototype=Object.create(Material$1.prototype),ShaderMaterial.prototype.constructor=ShaderMaterial,ShaderMaterial.prototype.isShaderMaterial=!0,ShaderMaterial.prototype.copy=function(e){return Material$1.prototype.copy.call(this,e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=cloneUniforms(e.uniforms),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.lights=e.lights,this.clipping=e.clipping,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this},ShaderMaterial.prototype.toJSON=function(e){const t=Material$1.prototype.toJSON.call(this,e);t.glslVersion=this.glslVersion,t.uniforms={};for(const r in this.uniforms){const n=this.uniforms[r].value;n&&n.isTexture?t.uniforms[r]={type:"t",value:n.toJSON(e).uuid}:n&&n.isColor?t.uniforms[r]={type:"c",value:n.getHex()}:n&&n.isVector2?t.uniforms[r]={type:"v2",value:n.toArray()}:n&&n.isVector3?t.uniforms[r]={type:"v3",value:n.toArray()}:n&&n.isVector4?t.uniforms[r]={type:"v4",value:n.toArray()}:n&&n.isMatrix3?t.uniforms[r]={type:"m3",value:n.toArray()}:n&&n.isMatrix4?t.uniforms[r]={type:"m4",value:n.toArray()}:t.uniforms[r]={value:n}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader;const r={};for(const e in this.extensions)!0===this.extensions[e]&&(r[e]=!0);return Object.keys(r).length>0&&(t.extensions=r),t},Camera$1$1.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Camera$1$1,isCamera:!0,copy:function(e,t){return Object3D.prototype.copy.call(this,e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this},getWorldDirection:function(e){void 0===e&&(console.warn("THREE.Camera: .getWorldDirection() target is now required"),e=new Vector3),this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(-t[8],-t[9],-t[10]).normalize()},updateMatrixWorld:function(e){Object3D.prototype.updateMatrixWorld.call(this,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()},updateWorldMatrix:function(e,t){Object3D.prototype.updateWorldMatrix.call(this,e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()},clone:function(){return(new this.constructor).copy(this)}}),PerspectiveCamera.prototype=Object.assign(Object.create(Camera$1$1.prototype),{constructor:PerspectiveCamera,isPerspectiveCamera:!0,copy:function(e,t){return Camera$1$1.prototype.copy.call(this,e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this},setFocalLength:function(e){const t=.5*this.getFilmHeight()/e;this.fov=2*MathUtils.RAD2DEG*Math.atan(t),this.updateProjectionMatrix()},getFocalLength:function(){const e=Math.tan(.5*MathUtils.DEG2RAD*this.fov);return.5*this.getFilmHeight()/e},getEffectiveFOV:function(){return 2*MathUtils.RAD2DEG*Math.atan(Math.tan(.5*MathUtils.DEG2RAD*this.fov)/this.zoom)},getFilmWidth:function(){return this.filmGauge*Math.min(this.aspect,1)},getFilmHeight:function(){return this.filmGauge/Math.max(this.aspect,1)},setViewOffset:function(e,t,r,n,i,a){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=r,this.view.offsetY=n,this.view.width=i,this.view.height=a,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){const e=this.near;let t=e*Math.tan(.5*MathUtils.DEG2RAD*this.fov)/this.zoom,r=2*t,n=this.aspect*r,i=-.5*n;const a=this.view;if(null!==this.view&&this.view.enabled){const e=a.fullWidth,o=a.fullHeight;i+=a.offsetX*n/e,t-=a.offsetY*r/o,n*=a.width/e,r*=a.height/o}const o=this.filmOffset;0!==o&&(i+=e*o/this.getFilmWidth()),this.projectionMatrix.makePerspective(i,i+n,t,t-r,e,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()},toJSON:function(e){const t=Object3D.prototype.toJSON.call(this,e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}});const fov=90,aspect=1;class CubeCamera extends Object3D{constructor(e,t,r){if(super(),this.type="CubeCamera",!0!==r.isWebGLCubeRenderTarget)return void console.error("THREE.CubeCamera: The constructor now expects an instance of WebGLCubeRenderTarget as third parameter.");this.renderTarget=r;const n=new PerspectiveCamera(fov,aspect,e,t);n.layers=this.layers,n.up.set(0,-1,0),n.lookAt(new Vector3(1,0,0)),this.add(n);const i=new PerspectiveCamera(fov,aspect,e,t);i.layers=this.layers,i.up.set(0,-1,0),i.lookAt(new Vector3(-1,0,0)),this.add(i);const a=new PerspectiveCamera(fov,aspect,e,t);a.layers=this.layers,a.up.set(0,0,1),a.lookAt(new Vector3(0,1,0)),this.add(a);const o=new PerspectiveCamera(fov,aspect,e,t);o.layers=this.layers,o.up.set(0,0,-1),o.lookAt(new Vector3(0,-1,0)),this.add(o);const s=new PerspectiveCamera(fov,aspect,e,t);s.layers=this.layers,s.up.set(0,-1,0),s.lookAt(new Vector3(0,0,1)),this.add(s);const l=new PerspectiveCamera(fov,aspect,e,t);l.layers=this.layers,l.up.set(0,-1,0),l.lookAt(new Vector3(0,0,-1)),this.add(l)}update(e,t){null===this.parent&&this.updateMatrixWorld();const r=this.renderTarget,[n,i,a,o,s,l]=this.children,c=e.xr.enabled,h=e.getRenderTarget();e.xr.enabled=!1;const u=r.texture.generateMipmaps;r.texture.generateMipmaps=!1,e.setRenderTarget(r,0),e.render(t,n),e.setRenderTarget(r,1),e.render(t,i),e.setRenderTarget(r,2),e.render(t,a),e.setRenderTarget(r,3),e.render(t,o),e.setRenderTarget(r,4),e.render(t,s),r.texture.generateMipmaps=u,e.setRenderTarget(r,5),e.render(t,l),e.setRenderTarget(h),e.xr.enabled=c}}class CubeTexture extends Texture$1{constructor(e,t,r,n,i,a,o,s,l,c){super(e=void 0!==e?e:[],t=void 0!==t?t:CubeReflectionMapping,r,n,i,a,o=void 0!==o?o:RGBFormat,s,l,c),this._needsFlipEnvMap=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}CubeTexture.prototype.isCubeTexture=!0;class WebGLCubeRenderTarget extends WebGLRenderTarget{constructor(e,t,r){Number.isInteger(t)&&(console.warn("THREE.WebGLCubeRenderTarget: constructor signature is now WebGLCubeRenderTarget( size, options )"),t=r),super(e,e,t),t=t||{},this.texture=new CubeTexture(void 0,t.mapping,t.wrapS,t.wrapT,t.magFilter,t.minFilter,t.format,t.type,t.anisotropy,t.encoding),this.texture.generateMipmaps=void 0!==t.generateMipmaps&&t.generateMipmaps,this.texture.minFilter=void 0!==t.minFilter?t.minFilter:LinearFilter,this.texture._needsFlipEnvMap=!1}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.format=RGBAFormat,this.texture.encoding=t.encoding,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const r={uniforms:{tEquirect:{value:null}},vertexShader:"\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t"},n=new BoxGeometry(5,5,5),i=new ShaderMaterial({name:"CubemapFromEquirect",uniforms:cloneUniforms(r.uniforms),vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,side:BackSide,blending:NoBlending});i.uniforms.tEquirect.value=t;const a=new Mesh(n,i),o=t.minFilter;t.minFilter===LinearMipmapLinearFilter&&(t.minFilter=LinearFilter);return new CubeCamera(1,10,this).update(e,a),t.minFilter=o,a.geometry.dispose(),a.material.dispose(),this}clear(e,t,r,n){const i=e.getRenderTarget();for(let i=0;i<6;i++)e.setRenderTarget(this,i),e.clear(t,r,n);e.setRenderTarget(i)}}WebGLCubeRenderTarget.prototype.isWebGLCubeRenderTarget=!0;class DataTexture extends Texture$1{constructor(e,t,r,n,i,a,o,s,l,c,h,u){super(null,a,o,s,l,c,n,i,h,u),this.image={data:e||null,width:t||1,height:r||1},this.magFilter=void 0!==l?l:NearestFilter,this.minFilter=void 0!==c?c:NearestFilter,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}}DataTexture.prototype.isDataTexture=!0;const _sphere$1=new Sphere,_vector$5=new Vector3;class Frustum{constructor(e=new Plane,t=new Plane,r=new Plane,n=new Plane,i=new Plane,a=new Plane){this.planes=[e,t,r,n,i,a]}set(e,t,r,n,i,a){const o=this.planes;return o[0].copy(e),o[1].copy(t),o[2].copy(r),o[3].copy(n),o[4].copy(i),o[5].copy(a),this}copy(e){const t=this.planes;for(let r=0;r<6;r++)t[r].copy(e.planes[r]);return this}setFromProjectionMatrix(e){const t=this.planes,r=e.elements,n=r[0],i=r[1],a=r[2],o=r[3],s=r[4],l=r[5],c=r[6],h=r[7],u=r[8],d=r[9],p=r[10],f=r[11],m=r[12],g=r[13],y=r[14],v=r[15];return t[0].setComponents(o-n,h-s,f-u,v-m).normalize(),t[1].setComponents(o+n,h+s,f+u,v+m).normalize(),t[2].setComponents(o+i,h+l,f+d,v+g).normalize(),t[3].setComponents(o-i,h-l,f-d,v-g).normalize(),t[4].setComponents(o-a,h-c,f-p,v-y).normalize(),t[5].setComponents(o+a,h+c,f+p,v+y).normalize(),this}intersectsObject(e){const t=e.geometry;return null===t.boundingSphere&&t.computeBoundingSphere(),_sphere$1.copy(t.boundingSphere).applyMatrix4(e.matrixWorld),this.intersectsSphere(_sphere$1)}intersectsSprite(e){return _sphere$1.center.set(0,0,0),_sphere$1.radius=.7071067811865476,_sphere$1.applyMatrix4(e.matrixWorld),this.intersectsSphere(_sphere$1)}intersectsSphere(e){const t=this.planes,r=e.center,n=-e.radius;for(let e=0;e<6;e++){if(t[e].distanceToPoint(r)<n)return!1}return!0}intersectsBox(e){const t=this.planes;for(let r=0;r<6;r++){const n=t[r];if(_vector$5.x=n.normal.x>0?e.max.x:e.min.x,_vector$5.y=n.normal.y>0?e.max.y:e.min.y,_vector$5.z=n.normal.z>0?e.max.z:e.min.z,n.distanceToPoint(_vector$5)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let r=0;r<6;r++)if(t[r].distanceToPoint(e)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}function WebGLAnimation(){let e=null,t=!1,r=null,n=null;function i(t,a){r(t,a),n=e.requestAnimationFrame(i)}return{start:function(){!0!==t&&null!==r&&(n=e.requestAnimationFrame(i),t=!0)},stop:function(){e.cancelAnimationFrame(n),t=!1},setAnimationLoop:function(e){r=e},setContext:function(t){e=t}}}function WebGLAttributes(e,t){const r=t.isWebGL2,n=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),n.get(e)},remove:function(t){t.isInterleavedBufferAttribute&&(t=t.data);const r=n.get(t);r&&(e.deleteBuffer(r.buffer),n.delete(t))},update:function(t,i){if(t.isGLBufferAttribute){const e=n.get(t);return void((!e||e.version<t.version)&&n.set(t,{buffer:t.buffer,type:t.type,bytesPerElement:t.elementSize,version:t.version}))}t.isInterleavedBufferAttribute&&(t=t.data);const a=n.get(t);void 0===a?n.set(t,function(t,n){const i=t.array,a=t.usage,o=e.createBuffer();e.bindBuffer(n,o),e.bufferData(n,i,a),t.onUploadCallback();let s=5126;return i instanceof Float32Array?s=5126:i instanceof Float64Array?console.warn("THREE.WebGLAttributes: Unsupported data buffer format: Float64Array."):i instanceof Uint16Array?t.isFloat16BufferAttribute?r?s=5131:console.warn("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2."):s=5123:i instanceof Int16Array?s=5122:i instanceof Uint32Array?s=5125:i instanceof Int32Array?s=5124:i instanceof Int8Array?s=5120:i instanceof Uint8Array&&(s=5121),{buffer:o,type:s,bytesPerElement:i.BYTES_PER_ELEMENT,version:t.version}}(t,i)):a.version<t.version&&(!function(t,n,i){const a=n.array,o=n.updateRange;e.bindBuffer(i,t),-1===o.count?e.bufferSubData(i,0,a):(r?e.bufferSubData(i,o.offset*a.BYTES_PER_ELEMENT,a,o.offset,o.count):e.bufferSubData(i,o.offset*a.BYTES_PER_ELEMENT,a.subarray(o.offset,o.offset+o.count)),o.count=-1)}(a.buffer,t,i),a.version=t.version)}}}class PlaneGeometry extends BufferGeometry{constructor(e=1,t=1,r=1,n=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:r,heightSegments:n};const i=e/2,a=t/2,o=Math.floor(r),s=Math.floor(n),l=o+1,c=s+1,h=e/o,u=t/s,d=[],p=[],f=[],m=[];for(let e=0;e<c;e++){const t=e*u-a;for(let r=0;r<l;r++){const n=r*h-i;p.push(n,-t,0),f.push(0,0,1),m.push(r/o),m.push(1-e/s)}}for(let e=0;e<s;e++)for(let t=0;t<o;t++){const r=t+l*e,n=t+l*(e+1),i=t+1+l*(e+1),a=t+1+l*e;d.push(r,n,a),d.push(n,i,a)}this.setIndex(d),this.setAttribute("position",new Float32BufferAttribute(p,3)),this.setAttribute("normal",new Float32BufferAttribute(f,3)),this.setAttribute("uv",new Float32BufferAttribute(m,2))}}var alphamap_fragment="#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).g;\n#endif",alphamap_pars_fragment="#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment="#ifdef ALPHATEST\n\tif ( diffuseColor.a < ALPHATEST ) discard;\n#endif",aomap_fragment="#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n\t#endif\n#endif",aomap_pars_fragment="#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex="vec3 transformed = vec3( position );",beginnormal_vertex="vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs="vec2 integrateSpecularBRDF( const in float dotNV, const in float roughness ) {\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\treturn vec2( -1.04, 1.04 ) * a004 + r.zw;\n}\nfloat punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\tif( cutoffDistance > 0.0 ) {\n\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t}\n\treturn distanceFalloff;\n#else\n\tif( cutoffDistance > 0.0 && decayExponent > 0.0 ) {\n\t\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\t}\n\treturn 1.0;\n#endif\n}\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n}\nvec3 F_Schlick_RoughnessDependent( const in vec3 F0, const in float dotNV, const in float roughness ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotNV - 6.98316 ) * dotNV );\n\tvec3 Fr = max( vec3( 1.0 - roughness ), F0 ) - F0;\n\treturn Fr * fresnel + F0;\n}\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\treturn 1.0 / ( gl * gv );\n}\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float roughness ) {\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( incidentLight.direction + viewDir );\n\tfloat dotNL = saturate( dot( normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\tfloat D = D_GGX( alpha, dotNH );\n\treturn F * ( G * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\nvec3 BRDF_Specular_GGX_Environment( const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tvec2 brdf = integrateSpecularBRDF( dotNV, roughness );\n\treturn specularColor * brdf.x + brdf.y;\n}\nvoid BRDF_Specular_Multiscattering_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tvec3 F = F_Schlick_RoughnessDependent( specularColor, dotNV, roughness );\n\tvec2 brdf = integrateSpecularBRDF( dotNV, roughness );\n\tvec3 FssEss = F * brdf.x + brdf.y;\n\tfloat Ess = brdf.x + brdf.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = specularColor + ( 1.0 - specularColor ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\nfloat G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n}\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie(float roughness, float NoH) {\n\tfloat invAlpha = 1.0 / roughness;\n\tfloat cos2h = NoH * NoH;\n\tfloat sin2h = max(1.0 - cos2h, 0.0078125);\treturn (2.0 + invAlpha) * pow(sin2h, invAlpha * 0.5) / (2.0 * PI);\n}\nfloat V_Neubelt(float NoV, float NoL) {\n\treturn saturate(1.0 / (4.0 * (NoL + NoV - NoL * NoV)));\n}\nvec3 BRDF_Specular_Sheen( const in float roughness, const in vec3 L, const in GeometricContext geometry, vec3 specularColor ) {\n\tvec3 N = geometry.normal;\n\tvec3 V = geometry.viewDir;\n\tvec3 H = normalize( V + L );\n\tfloat dotNH = saturate( dot( N, H ) );\n\treturn specularColor * D_Charlie( roughness, dotNH ) * V_Neubelt( dot(N, V), dot(N, L) );\n}\n#endif",bumpmap_pars_fragment="#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\t\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );\n\t\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment="#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\tplane = clippingPlanes[ i ];\n\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t#pragma unroll_loop_end\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\tif ( clipped ) discard;\n\t#endif\n#endif",clipping_planes_pars_fragment="#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex="#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex="#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment="#ifdef USE_COLOR\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment="#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif",color_pars_vertex="#if defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex="#if defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor.xyz *= color.xyz;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif",common="#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement(a) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract(sin(sn) * c);\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat max3( vec3 v ) { return max( max( v.x, v.y ), v.z ); }\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n#ifdef CLEARCOAT\n\tvec3 clearcoatNormal;\n#endif\n};\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\tfloat distance = dot( planeNormal, point - pointOnPlane );\n\treturn - distance * planeNormal + point;\n}\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn sign( dot( point - pointOnPlane, planeNormal ) );\n}\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat linearToRelativeLuminance( const in vec3 color ) {\n\tvec3 weights = vec3( 0.2126, 0.7152, 0.0722 );\n\treturn dot( weights, color.rgb );\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}",cube_uv_reflection_fragment="#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_maxMipLevel 8.0\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_maxTileSize 256.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\tfloat texelSize = 1.0 / ( 3.0 * cubeUV_maxTileSize );\n\t\tvec2 uv = getUV( direction, face ) * ( faceSize - 1.0 );\n\t\tvec2 f = fract( uv );\n\t\tuv += 0.5 - f;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tif ( mipInt < cubeUV_maxMipLevel ) {\n\t\t\tuv.y += 2.0 * cubeUV_maxTileSize;\n\t\t}\n\t\tuv.y += filterInt * 2.0 * cubeUV_minTileSize;\n\t\tuv.x += 3.0 * max( 0.0, cubeUV_maxTileSize - 2.0 * faceSize );\n\t\tuv *= texelSize;\n\t\tvec3 tl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.x += texelSize;\n\t\tvec3 tr = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.y += texelSize;\n\t\tvec3 br = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.x -= texelSize;\n\t\tvec3 bl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tvec3 tm = mix( tl, tr, f.x );\n\t\tvec3 bm = mix( bl, br, f.x );\n\t\treturn mix( tm, bm, f.y );\n\t}\n\t#define r0 1.0\n\t#define v0 0.339\n\t#define m0 - 2.0\n\t#define r1 0.8\n\t#define v1 0.276\n\t#define m1 - 1.0\n\t#define r4 0.4\n\t#define v4 0.046\n\t#define m4 2.0\n\t#define r5 0.305\n\t#define v5 0.016\n\t#define m5 3.0\n\t#define r6 0.21\n\t#define v6 0.0038\n\t#define m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= r1 ) {\n\t\t\tmip = ( r0 - roughness ) * ( m1 - m0 ) / ( r0 - r1 ) + m0;\n\t\t} else if ( roughness >= r4 ) {\n\t\t\tmip = ( r1 - roughness ) * ( m4 - m1 ) / ( r1 - r4 ) + m1;\n\t\t} else if ( roughness >= r5 ) {\n\t\t\tmip = ( r4 - roughness ) * ( m5 - m4 ) / ( r4 - r5 ) + m4;\n\t\t} else if ( roughness >= r6 ) {\n\t\t\tmip = ( r5 - roughness ) * ( m6 - m5 ) / ( r5 - r6 ) + m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), m0, cubeUV_maxMipLevel );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex="vec3 transformedNormal = objectNormal;\n#ifdef USE_INSTANCING\n\tmat3 m = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n\ttransformedNormal = m * transformedNormal;\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex="#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex="#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment="#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment="#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",encodings_fragment="gl_FragColor = linearToOutputTexel( gl_FragColor );",encodings_pars_fragment="\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.rgb, vec3( gammaFactor ) ), value.a );\n}\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.rgb, vec3( 1.0 / gammaFactor ) ), value.a );\n}\nvec4 sRGBToLinear( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}\nvec4 RGBEToLinear( in vec4 value ) {\n\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\nvec4 LinearToRGBE( in vec4 value ) {\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n}\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * value.a * maxRange, 1.0 );\n}\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.r, max( value.g, value.b ) );\n\tfloat M = clamp( maxRGB / maxRange, 0.0, 1.0 );\n\tM = ceil( M * 255.0 ) / 255.0;\n\treturn vec4( value.rgb / ( M * maxRange ), M );\n}\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\n}\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.r, max( value.g, value.b ) );\n\tfloat D = max( maxRange / maxRGB, 1.0 );\n\tD = clamp( floor( D ) / 255.0, 0.0, 1.0 );\n\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\n}\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\nvec4 LinearToLogLuv( in vec4 value ) {\n\tvec3 Xp_Y_XYZp = cLogLuvM * value.rgb;\n\tXp_Y_XYZp = max( Xp_Y_XYZp, vec3( 1e-6, 1e-6, 1e-6 ) );\n\tvec4 vResult;\n\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\n\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\n\tvResult.w = fract( Le );\n\tvResult.z = ( Le - ( floor( vResult.w * 255.0 ) ) / 255.0 ) / 255.0;\n\treturn vResult;\n}\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\nvec4 LogLuvToLinear( in vec4 value ) {\n\tfloat Le = value.z * 255.0 + value.w;\n\tvec3 Xp_Y_XYZp;\n\tXp_Y_XYZp.y = exp2( ( Le - 127.0 ) / 2.0 );\n\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\n\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\n\tvec3 vRGB = cLogLuvInverseM * Xp_Y_XYZp.rgb;\n\treturn vec4( max( vRGB, 0.0 ), 1.0 );\n}",envmap_fragment="#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 envColor = textureCubeUV( envMap, reflectVec, 0.0 );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifndef ENVMAP_TYPE_CUBE_UV\n\t\tenvColor = envMapTexelToLinear( envColor );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment="#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\tuniform int maxMipLevel;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment="#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex="#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) ||defined( PHONG )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_vertex="#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex="#ifdef USE_FOG\n\tfogDepth = - mvPosition.z;\n#endif",fog_pars_vertex="#ifdef USE_FOG\n\tvarying float fogDepth;\n#endif",fog_fragment="#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * fogDepth * fogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment="#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float fogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment="#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn texture2D( gradientMap, coord ).rgb;\n\t#else\n\t\treturn ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );\n\t#endif\n}",lightmap_fragment="#ifdef USE_LIGHTMAP\n\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\treflectedLight.indirectDiffuse += PI * lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n#endif",lightmap_pars_fragment="#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_vertex="vec3 diffuse = vec3( 1.0 );\nGeometricContext geometry;\ngeometry.position = mvPosition.xyz;\ngeometry.normal = normalize( transformedNormal );\ngeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( -mvPosition.xyz );\nGeometricContext backGeometry;\nbackGeometry.position = geometry.position;\nbackGeometry.normal = -geometry.normal;\nbackGeometry.viewDir = geometry.viewDir;\nvLightFront = vec3( 0.0 );\nvIndirectFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\n\tvLightBack = vec3( 0.0 );\n\tvIndirectBack = vec3( 0.0 );\n#endif\nIncidentLight directLight;\nfloat dotNL;\nvec3 directLightColor_Diffuse;\nvIndirectFront += getAmbientLightIrradiance( ambientLightColor );\nvIndirectFront += getLightProbeIrradiance( lightProbe, geometry );\n#ifdef DOUBLE_SIDED\n\tvIndirectBack += getAmbientLightIrradiance( ambientLightColor );\n\tvIndirectBack += getLightProbeIrradiance( lightProbe, backGeometry );\n#endif\n#if NUM_POINT_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tgetPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tgetSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_DIR_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tgetDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\tvIndirectFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvIndirectBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif",lights_pars_begin="uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\nuniform vec3 lightProbe[ 9 ];\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in GeometricContext geometry ) {\n\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treturn irradiance;\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tdirectLight.color = directionalLight.color;\n\t\tdirectLight.direction = directionalLight.direction;\n\t\tdirectLight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tdirectLight.color = pointLight.color;\n\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\t\tif ( angleCos > spotLight.coneCos ) {\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\t\tdirectLight.color = spotLight.color;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\t\t} else {\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {\n\t\tfloat dotNL = dot( geometry.normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tirradiance *= PI;\n\t\t#endif\n\t\treturn irradiance;\n\t}\n#endif",envmap_physical_pars_fragment="#if defined( USE_ENVMAP )\n\t#ifdef ENVMAP_MODE_REFRACTION\n\t\tuniform float refractionRatio;\n\t#endif\n\tvec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {\n\t\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );\n\t\t#else\n\t\t\tvec4 envMapColor = vec4( 0.0 );\n\t\t#endif\n\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t}\n\tfloat getSpecularMIPLevel( const in float roughness, const in int maxMIPLevel ) {\n\t\tfloat maxMIPLevelScalar = float( maxMIPLevel );\n\t\tfloat sigma = PI * roughness * roughness / ( 1.0 + roughness );\n\t\tfloat desiredMIPLevel = maxMIPLevelScalar + log2( sigma );\n\t\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\t}\n\tvec3 getLightProbeIndirectRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in int maxMIPLevel ) {\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( -viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( -viewDir, normal, refractionRatio );\n\t\t#endif\n\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\tfloat specularMIPLevel = getSpecularMIPLevel( roughness, maxMIPLevel );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );\n\t\t#endif\n\t\treturn envMapColor.rgb * envMapIntensity;\n\t}\n#endif",lights_toon_fragment="ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment="varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon\n#define Material_LightProbeLOD( material )\t(0)",lights_phong_fragment="BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment="varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong\n#define Material_LightProbeLOD( material )\t(0)",lights_physical_fragment="PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.specularRoughness = max( roughnessFactor, 0.0525 );material.specularRoughness += geometryRoughness;\nmaterial.specularRoughness = min( material.specularRoughness, 1.0 );\n#ifdef REFLECTIVITY\n\tmaterial.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n#endif\n#ifdef CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheen;\n#endif",lights_physical_pars_fragment="struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat specularRoughness;\n\tvec3 specularColor;\n#ifdef CLEARCOAT\n\tfloat clearcoat;\n\tfloat clearcoatRoughness;\n#endif\n#ifdef USE_SHEEN\n\tvec3 sheenColor;\n#endif\n};\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\nfloat clearcoatDHRApprox( const in float roughness, const in float dotNL ) {\n\treturn DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.specularRoughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\t#ifdef CLEARCOAT\n\t\tfloat ccDotNL = saturate( dot( geometry.clearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = ccDotNL * directLight.color;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tccIrradiance *= PI;\n\t\t#endif\n\t\tfloat clearcoatDHR = material.clearcoat * clearcoatDHRApprox( material.clearcoatRoughness, ccDotNL );\n\t\treflectedLight.directSpecular += ccIrradiance * material.clearcoat * BRDF_Specular_GGX( directLight, geometry.viewDir, geometry.clearcoatNormal, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearcoatRoughness );\n\t#else\n\t\tfloat clearcoatDHR = 0.0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\treflectedLight.directSpecular += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Specular_Sheen(\n\t\t\tmaterial.specularRoughness,\n\t\t\tdirectLight.direction,\n\t\t\tgeometry,\n\t\t\tmaterial.sheenColor\n\t\t);\n\t#else\n\t\treflectedLight.directSpecular += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry.viewDir, geometry.normal, material.specularColor, material.specularRoughness);\n\t#endif\n\treflectedLight.directDiffuse += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef CLEARCOAT\n\t\tfloat ccDotNV = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular += clearcoatRadiance * material.clearcoat * BRDF_Specular_GGX_Environment( geometry.viewDir, geometry.clearcoatNormal, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearcoatRoughness );\n\t\tfloat ccDotNL = ccDotNV;\n\t\tfloat clearcoatDHR = material.clearcoat * clearcoatDHRApprox( material.clearcoatRoughness, ccDotNL );\n\t#else\n\t\tfloat clearcoatDHR = 0.0;\n\t#endif\n\tfloat clearcoatInv = 1.0 - clearcoatDHR;\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\tBRDF_Specular_Multiscattering_Environment( geometry, material.specularColor, material.specularRoughness, singleScattering, multiScattering );\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - ( singleScattering + multiScattering ) );\n\treflectedLight.indirectSpecular += clearcoatInv * radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin="\nGeometricContext geometry;\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\n#ifdef CLEARCOAT\n\tgeometry.clearcoatNormal = clearcoatNormal;\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\tirradiance += getLightProbeIrradiance( lightProbe, geometry );\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps="#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\t\tvec3 lightMapIrradiance = lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tlightMapIrradiance *= PI;\n\t\t#endif\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getLightProbeIndirectIrradiance( geometry, maxMipLevel );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\tradiance += getLightProbeIndirectRadiance( geometry.viewDir, geometry.normal, material.specularRoughness, maxMipLevel );\n\t#ifdef CLEARCOAT\n\t\tclearcoatRadiance += getLightProbeIndirectRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness, maxMipLevel );\n\t#endif\n#endif",lights_fragment_end="#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometry, material, reflectedLight );\n#endif",logdepthbuf_fragment="#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment="#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex="#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t\tvarying float vIsPerspective;\n\t#else\n\t\tuniform float logDepthBufFC;\n\t#endif\n#endif",logdepthbuf_vertex="#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n\t#else\n\t\tif ( isPerspectiveMatrix( projectionMatrix ) ) {\n\t\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\t\tgl_Position.z *= gl_Position.w;\n\t\t}\n\t#endif\n#endif",map_fragment="#ifdef USE_MAP\n\tvec4 texelColor = texture2D( map, vUv );\n\ttexelColor = mapTexelToLinear( texelColor );\n\tdiffuseColor *= texelColor;\n#endif",map_pars_fragment="#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment="#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n#endif\n#ifdef USE_MAP\n\tvec4 mapTexel = texture2D( map, uv );\n\tdiffuseColor *= mapTexelToLinear( mapTexel );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment="#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\tuniform mat3 uvTransform;\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment="float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment="#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphnormal_vertex="#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\n\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\n\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\n\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\n#endif",morphtarget_pars_vertex="#ifdef USE_MORPHTARGETS\n\tuniform float morphTargetBaseInfluence;\n\t#ifndef USE_MORPHNORMALS\n\t\tuniform float morphTargetInfluences[ 8 ];\n\t#else\n\t\tuniform float morphTargetInfluences[ 4 ];\n\t#endif\n#endif",morphtarget_vertex="#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\n\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\n\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\n\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\n\t#ifndef USE_MORPHNORMALS\n\t\ttransformed += morphTarget4 * morphTargetInfluences[ 4 ];\n\t\ttransformed += morphTarget5 * morphTargetInfluences[ 5 ];\n\t\ttransformed += morphTarget6 * morphTargetInfluences[ 6 ];\n\t\ttransformed += morphTarget7 * morphTargetInfluences[ 7 ];\n\t#endif\n#endif",normal_fragment_begin="float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n#ifdef FLAT_SHADED\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\t#ifdef USE_TANGENT\n\t\tvec3 tangent = normalize( vTangent );\n\t\tvec3 bitangent = normalize( vBitangent );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\ttangent = tangent * faceDirection;\n\t\t\tbitangent = bitangent * faceDirection;\n\t\t#endif\n\t\t#if defined( TANGENTSPACE_NORMALMAP ) || defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tmat3 vTBN = mat3( tangent, bitangent, normal );\n\t\t#endif\n\t#endif\n#endif\nvec3 geometryNormal = normal;",normal_fragment_maps="#ifdef OBJECTSPACE_NORMALMAP\n\tnormal = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( TANGENTSPACE_NORMALMAP )\n\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\t#ifdef USE_TANGENT\n\t\tnormal = normalize( vTBN * mapN );\n\t#else\n\t\tnormal = perturbNormal2Arb( -vViewPosition, normal, mapN, faceDirection );\n\t#endif\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd(), faceDirection );\n#endif",normalmap_pars_fragment="#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( TANGENTSPACE_NORMALMAP ) || defined ( USE_CLEARCOAT_NORMALMAP ) )\n\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec3 mapN, float faceDirection ) {\n\t\tvec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );\n\t\tvec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );\n\t\tvec2 st0 = dFdx( vUv.st );\n\t\tvec2 st1 = dFdy( vUv.st );\n\t\tvec3 N = surf_norm;\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : faceDirection * inversesqrt( det );\n\t\treturn normalize( T * ( mapN.x * scale ) + B * ( mapN.y * scale ) + N * mapN.z );\n\t}\n#endif",clearcoat_normal_fragment_begin="#ifdef CLEARCOAT\n\tvec3 clearcoatNormal = geometryNormal;\n#endif",clearcoat_normal_fragment_maps="#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\t#ifdef USE_TANGENT\n\t\tclearcoatNormal = normalize( vTBN * clearcoatMapN );\n\t#else\n\t\tclearcoatNormal = perturbNormal2Arb( - vViewPosition, clearcoatNormal, clearcoatMapN, faceDirection );\n\t#endif\n#endif",clearcoat_pars_fragment="#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif",packing="vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nvec4 pack2HalfToRGBA( vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ));\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w);\n}\nvec2 unpackRGBATo2Half( vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n\treturn linearClipZ * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn (( near + viewZ ) * far ) / (( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\n}",premultiplied_alpha_fragment="#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex="vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment="#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment="#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment="float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment="#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment="#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\t\tbool frustumTest = all( frustumTestVec );\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ), \n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ), \n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif",shadowmap_pars_vertex="#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex="#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0 || NUM_SPOT_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0\n\t\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\tvec4 shadowWorldPosition;\n\t#endif\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n#endif",shadowmask_pars_fragment="float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex="#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex="#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\t#ifdef BONE_TEXTURE\n\t\tuniform highp sampler2D boneTexture;\n\t\tuniform int boneTextureSize;\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tfloat j = i * 4.0;\n\t\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\t\ty = dy * ( y + 0.5 );\n\t\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\t\treturn bone;\n\t\t}\n\t#else\n\t\tuniform mat4 boneMatrices[ MAX_BONES ];\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tmat4 bone = boneMatrices[ int(i) ];\n\t\t\treturn bone;\n\t\t}\n\t#endif\n#endif",skinning_vertex="#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex="#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment="float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment="#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment="#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment="#ifndef saturate\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn toneMappingExposure * color;\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmissionmap_fragment="#ifdef USE_TRANSMISSIONMAP\n\ttotalTransmission *= texture2D( transmissionMap, vUv ).r;\n#endif",transmissionmap_pars_fragment="#ifdef USE_TRANSMISSIONMAP\n\tuniform sampler2D transmissionMap;\n#endif",uv_pars_fragment="#if ( defined( USE_UV ) && ! defined( UVS_VERTEX_ONLY ) )\n\tvarying vec2 vUv;\n#endif",uv_pars_vertex="#ifdef USE_UV\n\t#ifdef UVS_VERTEX_ONLY\n\t\tvec2 vUv;\n\t#else\n\t\tvarying vec2 vUv;\n\t#endif\n\tuniform mat3 uvTransform;\n#endif",uv_vertex="#ifdef USE_UV\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n#endif",uv2_pars_fragment="#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvarying vec2 vUv2;\n#endif",uv2_pars_vertex="#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n\tuniform mat3 uv2Transform;\n#endif",uv2_vertex="#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvUv2 = ( uv2Transform * vec3( uv2, 1 ) ).xy;\n#endif",worldpos_vertex="#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_frag="uniform sampler2D t2D;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\tgl_FragColor = mapTexelToLinear( texColor );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",background_vert="varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",cube_frag="#include <envmap_common_pars_fragment>\nuniform float opacity;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\tvec3 vReflect = vWorldDirection;\n\t#include <envmap_fragment>\n\tgl_FragColor = envColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",cube_vert="varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",depth_frag="#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#endif\n}",depth_vert="#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",distanceRGBA_frag="#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",distanceRGBA_vert="#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",equirect_frag="uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tvec4 texColor = texture2D( tEquirect, sampleUV );\n\tgl_FragColor = mapTexelToLinear( texColor );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",equirect_vert="varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",linedashed_frag="uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",linedashed_vert="uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag="uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\n\t\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\t\treflectedLight.indirectDiffuse += lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshbasic_vert="#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_ENVMAP\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag="uniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <emissivemap_fragment>\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.indirectDiffuse += ( gl_FrontFacing ) ? vIndirectFront : vIndirectBack;\n\t#else\n\t\treflectedLight.indirectDiffuse += vIndirectFront;\n\t#endif\n\t#include <lightmap_fragment>\n\treflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\t#else\n\t\treflectedLight.directDiffuse = vLightFront;\n\t#endif\n\treflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert="#define LAMBERT\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <lights_lambert_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshmatcap_frag="#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t\tmatcapColor = matcapTexelToLinear( matcapColor );\n\t#else\n\t\tvec4 matcapColor = vec4( 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert="#define MATCAP\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#ifndef FLAT_SHADED\n\t\tvNormal = normalize( transformedNormal );\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshtoon_frag="#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert="#define TOON\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag="#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphong_vert="#define PHONG\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphysical_frag="#define STANDARD\n#ifdef PHYSICAL\n\t#define REFLECTIVITY\n\t#define CLEARCOAT\n\t#define TRANSMISSION\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef TRANSMISSION\n\tuniform float transmission;\n#endif\n#ifdef REFLECTIVITY\n\tuniform float reflectivity;\n#endif\n#ifdef CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheen;\n#endif\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <transmissionmap_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#ifdef TRANSMISSION\n\t\tfloat totalTransmission = transmission;\n\t#endif\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <transmissionmap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#ifdef TRANSMISSION\n\t\tdiffuseColor.a *= mix( saturate( 1. - totalTransmission + linearToRelativeLuminance( reflectedLight.directSpecular + reflectedLight.indirectSpecular ) ), 1.0, metalness );\n\t#endif\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert="#define STANDARD\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",normal_frag="#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n}",normal_vert="#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",points_frag="uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",points_vert="uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",shadow_frag="uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",shadow_vert="#include <common>\n#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",sprite_frag="uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",sprite_vert="uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}";const ShaderChunk={alphamap_fragment:alphamap_fragment,alphamap_pars_fragment:alphamap_pars_fragment,alphatest_fragment:alphatest_fragment,aomap_fragment:aomap_fragment,aomap_pars_fragment:aomap_pars_fragment,begin_vertex:begin_vertex,beginnormal_vertex:beginnormal_vertex,bsdfs:bsdfs,bumpmap_pars_fragment:bumpmap_pars_fragment,clipping_planes_fragment:clipping_planes_fragment,clipping_planes_pars_fragment:clipping_planes_pars_fragment,clipping_planes_pars_vertex:clipping_planes_pars_vertex,clipping_planes_vertex:clipping_planes_vertex,color_fragment:color_fragment,color_pars_fragment:color_pars_fragment,color_pars_vertex:color_pars_vertex,color_vertex:color_vertex,common:common,cube_uv_reflection_fragment:cube_uv_reflection_fragment,defaultnormal_vertex:defaultnormal_vertex,displacementmap_pars_vertex:displacementmap_pars_vertex,displacementmap_vertex:displacementmap_vertex,emissivemap_fragment:emissivemap_fragment,emissivemap_pars_fragment:emissivemap_pars_fragment,encodings_fragment:encodings_fragment,encodings_pars_fragment:encodings_pars_fragment,envmap_fragment:envmap_fragment,envmap_common_pars_fragment:envmap_common_pars_fragment,envmap_pars_fragment:envmap_pars_fragment,envmap_pars_vertex:envmap_pars_vertex,envmap_physical_pars_fragment:envmap_physical_pars_fragment,envmap_vertex:envmap_vertex,fog_vertex:fog_vertex,fog_pars_vertex:fog_pars_vertex,fog_fragment:fog_fragment,fog_pars_fragment:fog_pars_fragment,gradientmap_pars_fragment:gradientmap_pars_fragment,lightmap_fragment:lightmap_fragment,lightmap_pars_fragment:lightmap_pars_fragment,lights_lambert_vertex:lights_lambert_vertex,lights_pars_begin:lights_pars_begin,lights_toon_fragment:lights_toon_fragment,lights_toon_pars_fragment:lights_toon_pars_fragment,lights_phong_fragment:lights_phong_fragment,lights_phong_pars_fragment:lights_phong_pars_fragment,lights_physical_fragment:lights_physical_fragment,lights_physical_pars_fragment:lights_physical_pars_fragment,lights_fragment_begin:lights_fragment_begin,lights_fragment_maps:lights_fragment_maps,lights_fragment_end:lights_fragment_end,logdepthbuf_fragment:logdepthbuf_fragment,logdepthbuf_pars_fragment:logdepthbuf_pars_fragment,logdepthbuf_pars_vertex:logdepthbuf_pars_vertex,logdepthbuf_vertex:logdepthbuf_vertex,map_fragment:map_fragment,map_pars_fragment:map_pars_fragment,map_particle_fragment:map_particle_fragment,map_particle_pars_fragment:map_particle_pars_fragment,metalnessmap_fragment:metalnessmap_fragment,metalnessmap_pars_fragment:metalnessmap_pars_fragment,morphnormal_vertex:morphnormal_vertex,morphtarget_pars_vertex:morphtarget_pars_vertex,morphtarget_vertex:morphtarget_vertex,normal_fragment_begin:normal_fragment_begin,normal_fragment_maps:normal_fragment_maps,normalmap_pars_fragment:normalmap_pars_fragment,clearcoat_normal_fragment_begin:clearcoat_normal_fragment_begin,clearcoat_normal_fragment_maps:clearcoat_normal_fragment_maps,clearcoat_pars_fragment:clearcoat_pars_fragment,packing:packing,premultiplied_alpha_fragment:premultiplied_alpha_fragment,project_vertex:project_vertex,dithering_fragment:dithering_fragment,dithering_pars_fragment:dithering_pars_fragment,roughnessmap_fragment:roughnessmap_fragment,roughnessmap_pars_fragment:roughnessmap_pars_fragment,shadowmap_pars_fragment:shadowmap_pars_fragment,shadowmap_pars_vertex:shadowmap_pars_vertex,shadowmap_vertex:shadowmap_vertex,shadowmask_pars_fragment:shadowmask_pars_fragment,skinbase_vertex:skinbase_vertex,skinning_pars_vertex:skinning_pars_vertex,skinning_vertex:skinning_vertex,skinnormal_vertex:skinnormal_vertex,specularmap_fragment:specularmap_fragment,specularmap_pars_fragment:specularmap_pars_fragment,tonemapping_fragment:tonemapping_fragment,tonemapping_pars_fragment:tonemapping_pars_fragment,transmissionmap_fragment:transmissionmap_fragment,transmissionmap_pars_fragment:transmissionmap_pars_fragment,uv_pars_fragment:uv_pars_fragment,uv_pars_vertex:uv_pars_vertex,uv_vertex:uv_vertex,uv2_pars_fragment:uv2_pars_fragment,uv2_pars_vertex:uv2_pars_vertex,uv2_vertex:uv2_vertex,worldpos_vertex:worldpos_vertex,background_frag:background_frag,background_vert:background_vert,cube_frag:cube_frag,cube_vert:cube_vert,depth_frag:depth_frag,depth_vert:depth_vert,distanceRGBA_frag:distanceRGBA_frag,distanceRGBA_vert:distanceRGBA_vert,equirect_frag:equirect_frag,equirect_vert:equirect_vert,linedashed_frag:linedashed_frag,linedashed_vert:linedashed_vert,meshbasic_frag:meshbasic_frag,meshbasic_vert:meshbasic_vert,meshlambert_frag:meshlambert_frag,meshlambert_vert:meshlambert_vert,meshmatcap_frag:meshmatcap_frag,meshmatcap_vert:meshmatcap_vert,meshtoon_frag:meshtoon_frag,meshtoon_vert:meshtoon_vert,meshphong_frag:meshphong_frag,meshphong_vert:meshphong_vert,meshphysical_frag:meshphysical_frag,meshphysical_vert:meshphysical_vert,normal_frag:normal_frag,normal_vert:normal_vert,points_frag:points_frag,points_vert:points_vert,shadow_frag:shadow_frag,shadow_vert:shadow_vert,sprite_frag:sprite_frag,sprite_vert:sprite_vert},UniformsLib={common:{diffuse:{value:new Color(15658734)},opacity:{value:1},map:{value:null},uvTransform:{value:new Matrix3},uv2Transform:{value:new Matrix3},alphaMap:{value:null}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98},maxMipLevel:{value:0}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new Vector2(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Color(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new Color(15658734)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},uvTransform:{value:new Matrix3}},sprite:{diffuse:{value:new Color(15658734)},opacity:{value:1},center:{value:new Vector2(.5,.5)},rotation:{value:0},map:{value:null},alphaMap:{value:null},uvTransform:{value:new Matrix3}}},ShaderLib={basic:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.specularmap,UniformsLib.envmap,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.fog]),vertexShader:ShaderChunk.meshbasic_vert,fragmentShader:ShaderChunk.meshbasic_frag},lambert:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.specularmap,UniformsLib.envmap,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.emissivemap,UniformsLib.fog,UniformsLib.lights,{emissive:{value:new Color(0)}}]),vertexShader:ShaderChunk.meshlambert_vert,fragmentShader:ShaderChunk.meshlambert_frag},phong:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.specularmap,UniformsLib.envmap,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.emissivemap,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,UniformsLib.fog,UniformsLib.lights,{emissive:{value:new Color(0)},specular:{value:new Color(1118481)},shininess:{value:30}}]),vertexShader:ShaderChunk.meshphong_vert,fragmentShader:ShaderChunk.meshphong_frag},standard:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.envmap,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.emissivemap,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,UniformsLib.roughnessmap,UniformsLib.metalnessmap,UniformsLib.fog,UniformsLib.lights,{emissive:{value:new Color(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:ShaderChunk.meshphysical_vert,fragmentShader:ShaderChunk.meshphysical_frag},toon:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.emissivemap,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,UniformsLib.gradientmap,UniformsLib.fog,UniformsLib.lights,{emissive:{value:new Color(0)}}]),vertexShader:ShaderChunk.meshtoon_vert,fragmentShader:ShaderChunk.meshtoon_frag},matcap:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,UniformsLib.fog,{matcap:{value:null}}]),vertexShader:ShaderChunk.meshmatcap_vert,fragmentShader:ShaderChunk.meshmatcap_frag},points:{uniforms:mergeUniforms([UniformsLib.points,UniformsLib.fog]),vertexShader:ShaderChunk.points_vert,fragmentShader:ShaderChunk.points_frag},dashed:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:ShaderChunk.linedashed_vert,fragmentShader:ShaderChunk.linedashed_frag},depth:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.displacementmap]),vertexShader:ShaderChunk.depth_vert,fragmentShader:ShaderChunk.depth_frag},normal:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,{opacity:{value:1}}]),vertexShader:ShaderChunk.normal_vert,fragmentShader:ShaderChunk.normal_frag},sprite:{uniforms:mergeUniforms([UniformsLib.sprite,UniformsLib.fog]),vertexShader:ShaderChunk.sprite_vert,fragmentShader:ShaderChunk.sprite_frag},background:{uniforms:{uvTransform:{value:new Matrix3},t2D:{value:null}},vertexShader:ShaderChunk.background_vert,fragmentShader:ShaderChunk.background_frag},cube:{uniforms:mergeUniforms([UniformsLib.envmap,{opacity:{value:1}}]),vertexShader:ShaderChunk.cube_vert,fragmentShader:ShaderChunk.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:ShaderChunk.equirect_vert,fragmentShader:ShaderChunk.equirect_frag},distanceRGBA:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.displacementmap,{referencePosition:{value:new Vector3},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:ShaderChunk.distanceRGBA_vert,fragmentShader:ShaderChunk.distanceRGBA_frag},shadow:{uniforms:mergeUniforms([UniformsLib.lights,UniformsLib.fog,{color:{value:new Color(0)},opacity:{value:1}}]),vertexShader:ShaderChunk.shadow_vert,fragmentShader:ShaderChunk.shadow_frag}};function WebGLBackground(e,t,r,n,i){const a=new Color(0);let o,s,l=0,c=null,h=0,u=null;function d(e,t){r.buffers.color.setClear(e.r,e.g,e.b,t,i)}return{getClearColor:function(){return a},setClearColor:function(e,t=1){a.set(e),l=t,d(a,l)},getClearAlpha:function(){return l},setClearAlpha:function(e){l=e,d(a,l)},render:function(r,i,p,f){let m=!0===i.isScene?i.background:null;m&&m.isTexture&&(m=t.get(m));const g=e.xr,y=g.getSession&&g.getSession();y&&"additive"===y.environmentBlendMode&&(m=null),null===m?d(a,l):m&&m.isColor&&(d(m,1),f=!0),(e.autoClear||f)&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),m&&(m.isCubeTexture||m.isWebGLCubeRenderTarget||m.mapping===CubeUVReflectionMapping)?(void 0===s&&(s=new Mesh(new BoxGeometry(1,1,1),new ShaderMaterial({name:"BackgroundCubeMaterial",uniforms:cloneUniforms(ShaderLib.cube.uniforms),vertexShader:ShaderLib.cube.vertexShader,fragmentShader:ShaderLib.cube.fragmentShader,side:BackSide,depthTest:!1,depthWrite:!1,fog:!1})),s.geometry.deleteAttribute("normal"),s.geometry.deleteAttribute("uv"),s.onBeforeRender=function(e,t,r){this.matrixWorld.copyPosition(r.matrixWorld)},Object.defineProperty(s.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),n.update(s)),m.isWebGLCubeRenderTarget&&(m=m.texture),s.material.uniforms.envMap.value=m,s.material.uniforms.flipEnvMap.value=m.isCubeTexture&&m._needsFlipEnvMap?-1:1,c===m&&h===m.version&&u===e.toneMapping||(s.material.needsUpdate=!0,c=m,h=m.version,u=e.toneMapping),r.unshift(s,s.geometry,s.material,0,0,null)):m&&m.isTexture&&(void 0===o&&(o=new Mesh(new PlaneGeometry(2,2),new ShaderMaterial({name:"BackgroundMaterial",uniforms:cloneUniforms(ShaderLib.background.uniforms),vertexShader:ShaderLib.background.vertexShader,fragmentShader:ShaderLib.background.fragmentShader,side:FrontSide,depthTest:!1,depthWrite:!1,fog:!1})),o.geometry.deleteAttribute("normal"),Object.defineProperty(o.material,"map",{get:function(){return this.uniforms.t2D.value}}),n.update(o)),o.material.uniforms.t2D.value=m,!0===m.matrixAutoUpdate&&m.updateMatrix(),o.material.uniforms.uvTransform.value.copy(m.matrix),c===m&&h===m.version&&u===e.toneMapping||(o.material.needsUpdate=!0,c=m,h=m.version,u=e.toneMapping),r.unshift(o,o.geometry,o.material,0,0,null))}}}function WebGLBindingStates(e,t,r,n){const i=e.getParameter(34921),a=n.isWebGL2?null:t.get("OES_vertex_array_object"),o=n.isWebGL2||null!==a,s={},l=d(null);let c=l;function h(t){return n.isWebGL2?e.bindVertexArray(t):a.bindVertexArrayOES(t)}function u(t){return n.isWebGL2?e.deleteVertexArray(t):a.deleteVertexArrayOES(t)}function d(e){const t=[],r=[],n=[];for(let e=0;e<i;e++)t[e]=0,r[e]=0,n[e]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:t,enabledAttributes:r,attributeDivisors:n,object:e,attributes:{},index:null}}function p(){const e=c.newAttributes;for(let t=0,r=e.length;t<r;t++)e[t]=0}function f(e){m(e,0)}function m(r,i){const a=c.newAttributes,o=c.enabledAttributes,s=c.attributeDivisors;if(a[r]=1,0===o[r]&&(e.enableVertexAttribArray(r),o[r]=1),s[r]!==i){(n.isWebGL2?e:t.get("ANGLE_instanced_arrays"))[n.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](r,i),s[r]=i}}function g(){const t=c.newAttributes,r=c.enabledAttributes;for(let n=0,i=r.length;n<i;n++)r[n]!==t[n]&&(e.disableVertexAttribArray(n),r[n]=0)}function y(t,r,i,a,o,s){!0!==n.isWebGL2||5124!==i&&5125!==i?e.vertexAttribPointer(t,r,i,a,o,s):e.vertexAttribIPointer(t,r,i,o,s)}function v(){b(),c!==l&&(c=l,h(c.object))}function b(){l.geometry=null,l.program=null,l.wireframe=!1}return{setup:function(i,l,u,v,b){let _=!1;if(o){const t=function(t,r,i){const o=!0===i.wireframe;let l=s[t.id];void 0===l&&(l={},s[t.id]=l);let c=l[r.id];void 0===c&&(c={},l[r.id]=c);let h=c[o];void 0===h&&(h=d(n.isWebGL2?e.createVertexArray():a.createVertexArrayOES()),c[o]=h);return h}(v,u,l);c!==t&&(c=t,h(c.object)),_=function(e,t){const r=c.attributes,n=e.attributes;let i=0;for(const e in n){const t=r[e],a=n[e];if(void 0===t)return!0;if(t.attribute!==a)return!0;if(t.data!==a.data)return!0;i++}return c.attributesNum!==i||c.index!==t}(v,b),_&&function(e,t){const r={},n=e.attributes;let i=0;for(const e in n){const t=n[e],a={};a.attribute=t,t.data&&(a.data=t.data),r[e]=a,i++}c.attributes=r,c.attributesNum=i,c.index=t}(v,b)}else{const e=!0===l.wireframe;c.geometry===v.id&&c.program===u.id&&c.wireframe===e||(c.geometry=v.id,c.program=u.id,c.wireframe=e,_=!0)}!0===i.isInstancedMesh&&(_=!0),null!==b&&r.update(b,34963),_&&(!function(i,a,o,s){if(!1===n.isWebGL2&&(i.isInstancedMesh||s.isInstancedBufferGeometry)&&null===t.get("ANGLE_instanced_arrays"))return;p();const l=s.attributes,c=o.getAttributes(),h=a.defaultAttributeValues;for(const t in c){const n=c[t];if(n>=0){const a=l[t];if(void 0!==a){const t=a.normalized,i=a.itemSize,o=r.get(a);if(void 0===o)continue;const l=o.buffer,c=o.type,h=o.bytesPerElement;if(a.isInterleavedBufferAttribute){const r=a.data,o=r.stride,u=a.offset;r&&r.isInstancedInterleavedBuffer?(m(n,r.meshPerAttribute),void 0===s._maxInstanceCount&&(s._maxInstanceCount=r.meshPerAttribute*r.count)):f(n),e.bindBuffer(34962,l),y(n,i,c,t,o*h,u*h)}else a.isInstancedBufferAttribute?(m(n,a.meshPerAttribute),void 0===s._maxInstanceCount&&(s._maxInstanceCount=a.meshPerAttribute*a.count)):f(n),e.bindBuffer(34962,l),y(n,i,c,t,0,0)}else if("instanceMatrix"===t){const t=r.get(i.instanceMatrix);if(void 0===t)continue;const a=t.buffer,o=t.type;m(n+0,1),m(n+1,1),m(n+2,1),m(n+3,1),e.bindBuffer(34962,a),e.vertexAttribPointer(n+0,4,o,!1,64,0),e.vertexAttribPointer(n+1,4,o,!1,64,16),e.vertexAttribPointer(n+2,4,o,!1,64,32),e.vertexAttribPointer(n+3,4,o,!1,64,48)}else if("instanceColor"===t){const t=r.get(i.instanceColor);if(void 0===t)continue;const a=t.buffer,o=t.type;m(n,1),e.bindBuffer(34962,a),e.vertexAttribPointer(n,3,o,!1,12,0)}else if(void 0!==h){const r=h[t];if(void 0!==r)switch(r.length){case 2:e.vertexAttrib2fv(n,r);break;case 3:e.vertexAttrib3fv(n,r);break;case 4:e.vertexAttrib4fv(n,r);break;default:e.vertexAttrib1fv(n,r)}}}}g()}(i,l,u,v),null!==b&&e.bindBuffer(34963,r.get(b).buffer))},reset:v,resetDefaultState:b,dispose:function(){v();for(const e in s){const t=s[e];for(const e in t){const r=t[e];for(const e in r)u(r[e].object),delete r[e];delete t[e]}delete s[e]}},releaseStatesOfGeometry:function(e){if(void 0===s[e.id])return;const t=s[e.id];for(const e in t){const r=t[e];for(const e in r)u(r[e].object),delete r[e];delete t[e]}delete s[e.id]},releaseStatesOfProgram:function(e){for(const t in s){const r=s[t];if(void 0===r[e.id])continue;const n=r[e.id];for(const e in n)u(n[e].object),delete n[e];delete r[e.id]}},initAttributes:p,enableAttribute:f,disableUnusedAttributes:g}}function WebGLBufferRenderer(e,t,r,n){const i=n.isWebGL2;let a;this.setMode=function(e){a=e},this.render=function(t,n){e.drawArrays(a,t,n),r.update(n,a,1)},this.renderInstances=function(n,o,s){if(0===s)return;let l,c;if(i)l=e,c="drawArraysInstanced";else if(l=t.get("ANGLE_instanced_arrays"),c="drawArraysInstancedANGLE",null===l)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");l[c](a,n,o,s),r.update(o,a,s)}}function WebGLCapabilities(e,t,r){let n;function i(t){if("highp"===t){if(e.getShaderPrecisionFormat(35633,36338).precision>0&&e.getShaderPrecisionFormat(35632,36338).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(35633,36337).precision>0&&e.getShaderPrecisionFormat(35632,36337).precision>0?"mediump":"lowp"}const a="undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext||"undefined"!=typeof WebGL2ComputeRenderingContext&&e instanceof WebGL2ComputeRenderingContext;let o=void 0!==r.precision?r.precision:"highp";const s=i(o);s!==o&&(console.warn("THREE.WebGLRenderer:",o,"not supported, using",s,"instead."),o=s);const l=!0===r.logarithmicDepthBuffer,c=e.getParameter(34930),h=e.getParameter(35660),u=e.getParameter(3379),d=e.getParameter(34076),p=e.getParameter(34921),f=e.getParameter(36347),m=e.getParameter(36348),g=e.getParameter(36349),y=h>0,v=a||t.has("OES_texture_float");return{isWebGL2:a,getMaxAnisotropy:function(){if(void 0!==n)return n;if(!0===t.has("EXT_texture_filter_anisotropic")){const r=t.get("EXT_texture_filter_anisotropic");n=e.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else n=0;return n},getMaxPrecision:i,precision:o,logarithmicDepthBuffer:l,maxTextures:c,maxVertexTextures:h,maxTextureSize:u,maxCubemapSize:d,maxAttributes:p,maxVertexUniforms:f,maxVaryings:m,maxFragmentUniforms:g,vertexTextures:y,floatFragmentTextures:v,floatVertexTextures:y&&v,maxSamples:a?e.getParameter(36183):0}}function WebGLClipping(e){const t=this;let r=null,n=0,i=!1,a=!1;const o=new Plane,s=new Matrix3,l={value:null,needsUpdate:!1};function c(){l.value!==r&&(l.value=r,l.needsUpdate=n>0),t.numPlanes=n,t.numIntersection=0}function h(e,r,n,i){const a=null!==e?e.length:0;let c=null;if(0!==a){if(c=l.value,!0!==i||null===c){const t=n+4*a,i=r.matrixWorldInverse;s.getNormalMatrix(i),(null===c||c.length<t)&&(c=new Float32Array(t));for(let t=0,r=n;t!==a;++t,r+=4)o.copy(e[t]).applyMatrix4(i,s),o.normal.toArray(c,r),c[r+3]=o.constant}l.value=c,l.needsUpdate=!0}return t.numPlanes=a,t.numIntersection=0,c}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(e,t,a){const o=0!==e.length||t||0!==n||i;return i=t,r=h(e,a,0),n=e.length,o},this.beginShadows=function(){a=!0,h(null)},this.endShadows=function(){a=!1,c()},this.setState=function(t,o,s){const u=t.clippingPlanes,d=t.clipIntersection,p=t.clipShadows,f=e.get(t);if(!i||null===u||0===u.length||a&&!p)a?h(null):c();else{const e=a?0:n,t=4*e;let i=f.clippingState||null;l.value=i,i=h(u,o,t,s);for(let e=0;e!==t;++e)i[e]=r[e];f.clippingState=i,this.numIntersection=d?this.numPlanes:0,this.numPlanes+=e}}}function WebGLCubeMaps(e){let t=new WeakMap;function r(e,t){return t===EquirectangularReflectionMapping?e.mapping=CubeReflectionMapping:t===EquirectangularRefractionMapping&&(e.mapping=CubeRefractionMapping),e}function n(e){const r=e.target;r.removeEventListener("dispose",n);const i=t.get(r);void 0!==i&&(t.delete(r),i.dispose())}return{get:function(i){if(i&&i.isTexture){const a=i.mapping;if(a===EquirectangularReflectionMapping||a===EquirectangularRefractionMapping){if(t.has(i)){return r(t.get(i).texture,i.mapping)}{const a=i.image;if(a&&a.height>0){const o=e.getRenderTarget(),s=new WebGLCubeRenderTarget(a.height/2);return s.fromEquirectangularTexture(e,i),t.set(i,s),e.setRenderTarget(o),i.addEventListener("dispose",n),r(s.texture,i.mapping)}return null}}}return i},dispose:function(){t=new WeakMap}}}function WebGLExtensions(e){const t={};function r(r){if(void 0!==t[r])return t[r];let n;switch(r){case"WEBGL_depth_texture":n=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":n=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:n=e.getExtension(r)}return t[r]=n,n}return{has:function(e){return null!==r(e)},init:function(e){e.isWebGL2?r("EXT_color_buffer_float"):(r("WEBGL_depth_texture"),r("OES_texture_float"),r("OES_texture_half_float"),r("OES_texture_half_float_linear"),r("OES_standard_derivatives"),r("OES_element_index_uint"),r("OES_vertex_array_object"),r("ANGLE_instanced_arrays")),r("OES_texture_float_linear"),r("EXT_color_buffer_half_float")},get:function(e){const t=r(e);return null===t&&console.warn("THREE.WebGLRenderer: "+e+" extension not supported."),t}}}function WebGLGeometries(e,t,r,n){const i={},a=new WeakMap;function o(e){const s=e.target;null!==s.index&&t.remove(s.index);for(const e in s.attributes)t.remove(s.attributes[e]);s.removeEventListener("dispose",o),delete i[s.id];const l=a.get(s);l&&(t.remove(l),a.delete(s)),n.releaseStatesOfGeometry(s),!0===s.isInstancedBufferGeometry&&delete s._maxInstanceCount,r.memory.geometries--}function s(e){const r=[],n=e.index,i=e.attributes.position;let o=0;if(null!==n){const e=n.array;o=n.version;for(let t=0,n=e.length;t<n;t+=3){const n=e[t+0],i=e[t+1],a=e[t+2];r.push(n,i,i,a,a,n)}}else{const e=i.array;o=i.version;for(let t=0,n=e.length/3-1;t<n;t+=3){const e=t+0,n=t+1,i=t+2;r.push(e,n,n,i,i,e)}}const s=new(arrayMax(r)>65535?Uint32BufferAttribute:Uint16BufferAttribute)(r,1);s.version=o;const l=a.get(e);l&&t.remove(l),a.set(e,s)}return{get:function(e,t){return!0===i[t.id]||(t.addEventListener("dispose",o),i[t.id]=!0,r.memory.geometries++),t},update:function(e){const r=e.attributes;for(const e in r)t.update(r[e],34962);const n=e.morphAttributes;for(const e in n){const r=n[e];for(let e=0,n=r.length;e<n;e++)t.update(r[e],34962)}},getWireframeAttribute:function(e){const t=a.get(e);if(t){const r=e.index;null!==r&&t.version<r.version&&s(e)}else s(e);return a.get(e)}}}function WebGLIndexedBufferRenderer(e,t,r,n){const i=n.isWebGL2;let a,o,s;this.setMode=function(e){a=e},this.setIndex=function(e){o=e.type,s=e.bytesPerElement},this.render=function(t,n){e.drawElements(a,n,o,t*s),r.update(n,a,1)},this.renderInstances=function(n,l,c){if(0===c)return;let h,u;if(i)h=e,u="drawElementsInstanced";else if(h=t.get("ANGLE_instanced_arrays"),u="drawElementsInstancedANGLE",null===h)return void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");h[u](a,l,o,n*s,c),r.update(l,a,c)}}function WebGLInfo(e){const t={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:t,programs:null,autoReset:!0,reset:function(){t.frame++,t.calls=0,t.triangles=0,t.points=0,t.lines=0},update:function(e,r,n){switch(t.calls++,r){case 4:t.triangles+=n*(e/3);break;case 1:t.lines+=n*(e/2);break;case 3:t.lines+=n*(e-1);break;case 2:t.lines+=n*e;break;case 0:t.points+=n*e;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",r)}}}}function numericalSort(e,t){return e[0]-t[0]}function absNumericalSort(e,t){return Math.abs(t[1])-Math.abs(e[1])}function WebGLMorphtargets(e){const t={},r=new Float32Array(8),n=[];for(let e=0;e<8;e++)n[e]=[e,0];return{update:function(i,a,o,s){const l=i.morphTargetInfluences,c=void 0===l?0:l.length;let h=t[a.id];if(void 0===h){h=[];for(let e=0;e<c;e++)h[e]=[e,0];t[a.id]=h}for(let e=0;e<c;e++){const t=h[e];t[0]=e,t[1]=l[e]}h.sort(absNumericalSort);for(let e=0;e<8;e++)e<c&&h[e][1]?(n[e][0]=h[e][0],n[e][1]=h[e][1]):(n[e][0]=Number.MAX_SAFE_INTEGER,n[e][1]=0);n.sort(numericalSort);const u=o.morphTargets&&a.morphAttributes.position,d=o.morphNormals&&a.morphAttributes.normal;let p=0;for(let e=0;e<8;e++){const t=n[e],i=t[0],o=t[1];i!==Number.MAX_SAFE_INTEGER&&o?(u&&a.getAttribute("morphTarget"+e)!==u[i]&&a.setAttribute("morphTarget"+e,u[i]),d&&a.getAttribute("morphNormal"+e)!==d[i]&&a.setAttribute("morphNormal"+e,d[i]),r[e]=o,p+=o):(u&&!0===a.hasAttribute("morphTarget"+e)&&a.deleteAttribute("morphTarget"+e),d&&!0===a.hasAttribute("morphNormal"+e)&&a.deleteAttribute("morphNormal"+e),r[e]=0)}const f=a.morphTargetsRelative?1:1-p;s.getUniforms().setValue(e,"morphTargetBaseInfluence",f),s.getUniforms().setValue(e,"morphTargetInfluences",r)}}}function WebGLObjects(e,t,r,n){let i=new WeakMap;function a(e){const t=e.target;t.removeEventListener("dispose",a),r.remove(t.instanceMatrix),null!==t.instanceColor&&r.remove(t.instanceColor)}return{update:function(e){const o=n.render.frame,s=e.geometry,l=t.get(e,s);return i.get(l)!==o&&(t.update(l),i.set(l,o)),e.isInstancedMesh&&(!1===e.hasEventListener("dispose",a)&&e.addEventListener("dispose",a),r.update(e.instanceMatrix,34962),null!==e.instanceColor&&r.update(e.instanceColor,34962)),l},dispose:function(){i=new WeakMap}}}ShaderLib.physical={uniforms:mergeUniforms([ShaderLib.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatNormalScale:{value:new Vector2(1,1)},clearcoatNormalMap:{value:null},sheen:{value:new Color(0)},transmission:{value:0},transmissionMap:{value:null}}]),vertexShader:ShaderChunk.meshphysical_vert,fragmentShader:ShaderChunk.meshphysical_frag};class DataTexture2DArray extends Texture$1{constructor(e=null,t=1,r=1,n=1){super(null),this.image={data:e,width:t,height:r,depth:n},this.magFilter=NearestFilter,this.minFilter=NearestFilter,this.wrapR=ClampToEdgeWrapping,this.generateMipmaps=!1,this.flipY=!1,this.needsUpdate=!0}}DataTexture2DArray.prototype.isDataTexture2DArray=!0;class DataTexture3D extends Texture$1{constructor(e=null,t=1,r=1,n=1){super(null),this.image={data:e,width:t,height:r,depth:n},this.magFilter=NearestFilter,this.minFilter=NearestFilter,this.wrapR=ClampToEdgeWrapping,this.generateMipmaps=!1,this.flipY=!1,this.needsUpdate=!0}}DataTexture3D.prototype.isDataTexture3D=!0;const emptyTexture=new Texture$1,emptyTexture2dArray=new DataTexture2DArray,emptyTexture3d=new DataTexture3D,emptyCubeTexture=new CubeTexture,arrayCacheF32=[],arrayCacheI32=[],mat4array=new Float32Array(16),mat3array=new Float32Array(9),mat2array=new Float32Array(4);function flatten(e,t,r){const n=e[0];if(n<=0||n>0)return e;const i=t*r;let a=arrayCacheF32[i];if(void 0===a&&(a=new Float32Array(i),arrayCacheF32[i]=a),0!==t){n.toArray(a,0);for(let n=1,i=0;n!==t;++n)i+=r,e[n].toArray(a,i)}return a}function arraysEqual(e,t){if(e.length!==t.length)return!1;for(let r=0,n=e.length;r<n;r++)if(e[r]!==t[r])return!1;return!0}function copyArray(e,t){for(let r=0,n=t.length;r<n;r++)e[r]=t[r]}function allocTexUnits(e,t){let r=arrayCacheI32[t];void 0===r&&(r=new Int32Array(t),arrayCacheI32[t]=r);for(let n=0;n!==t;++n)r[n]=e.allocateTextureUnit();return r}function setValueV1f(e,t){const r=this.cache;r[0]!==t&&(e.uniform1f(this.addr,t),r[0]=t)}function setValueV2f(e,t){const r=this.cache;if(void 0!==t.x)r[0]===t.x&&r[1]===t.y||(e.uniform2f(this.addr,t.x,t.y),r[0]=t.x,r[1]=t.y);else{if(arraysEqual(r,t))return;e.uniform2fv(this.addr,t),copyArray(r,t)}}function setValueV3f(e,t){const r=this.cache;if(void 0!==t.x)r[0]===t.x&&r[1]===t.y&&r[2]===t.z||(e.uniform3f(this.addr,t.x,t.y,t.z),r[0]=t.x,r[1]=t.y,r[2]=t.z);else if(void 0!==t.r)r[0]===t.r&&r[1]===t.g&&r[2]===t.b||(e.uniform3f(this.addr,t.r,t.g,t.b),r[0]=t.r,r[1]=t.g,r[2]=t.b);else{if(arraysEqual(r,t))return;e.uniform3fv(this.addr,t),copyArray(r,t)}}function setValueV4f(e,t){const r=this.cache;if(void 0!==t.x)r[0]===t.x&&r[1]===t.y&&r[2]===t.z&&r[3]===t.w||(e.uniform4f(this.addr,t.x,t.y,t.z,t.w),r[0]=t.x,r[1]=t.y,r[2]=t.z,r[3]=t.w);else{if(arraysEqual(r,t))return;e.uniform4fv(this.addr,t),copyArray(r,t)}}function setValueM2(e,t){const r=this.cache,n=t.elements;if(void 0===n){if(arraysEqual(r,t))return;e.uniformMatrix2fv(this.addr,!1,t),copyArray(r,t)}else{if(arraysEqual(r,n))return;mat2array.set(n),e.uniformMatrix2fv(this.addr,!1,mat2array),copyArray(r,n)}}function setValueM3(e,t){const r=this.cache,n=t.elements;if(void 0===n){if(arraysEqual(r,t))return;e.uniformMatrix3fv(this.addr,!1,t),copyArray(r,t)}else{if(arraysEqual(r,n))return;mat3array.set(n),e.uniformMatrix3fv(this.addr,!1,mat3array),copyArray(r,n)}}function setValueM4(e,t){const r=this.cache,n=t.elements;if(void 0===n){if(arraysEqual(r,t))return;e.uniformMatrix4fv(this.addr,!1,t),copyArray(r,t)}else{if(arraysEqual(r,n))return;mat4array.set(n),e.uniformMatrix4fv(this.addr,!1,mat4array),copyArray(r,n)}}function setValueT1(e,t,r){const n=this.cache,i=r.allocateTextureUnit();n[0]!==i&&(e.uniform1i(this.addr,i),n[0]=i),r.safeSetTexture2D(t||emptyTexture,i)}function setValueT2DArray1(e,t,r){const n=this.cache,i=r.allocateTextureUnit();n[0]!==i&&(e.uniform1i(this.addr,i),n[0]=i),r.setTexture2DArray(t||emptyTexture2dArray,i)}function setValueT3D1(e,t,r){const n=this.cache,i=r.allocateTextureUnit();n[0]!==i&&(e.uniform1i(this.addr,i),n[0]=i),r.setTexture3D(t||emptyTexture3d,i)}function setValueT6(e,t,r){const n=this.cache,i=r.allocateTextureUnit();n[0]!==i&&(e.uniform1i(this.addr,i),n[0]=i),r.safeSetTextureCube(t||emptyCubeTexture,i)}function setValueV1i(e,t){const r=this.cache;r[0]!==t&&(e.uniform1i(this.addr,t),r[0]=t)}function setValueV2i(e,t){const r=this.cache;arraysEqual(r,t)||(e.uniform2iv(this.addr,t),copyArray(r,t))}function setValueV3i(e,t){const r=this.cache;arraysEqual(r,t)||(e.uniform3iv(this.addr,t),copyArray(r,t))}function setValueV4i(e,t){const r=this.cache;arraysEqual(r,t)||(e.uniform4iv(this.addr,t),copyArray(r,t))}function setValueV1ui(e,t){const r=this.cache;r[0]!==t&&(e.uniform1ui(this.addr,t),r[0]=t)}function getSingularSetter(e){switch(e){case 5126:return setValueV1f;case 35664:return setValueV2f;case 35665:return setValueV3f;case 35666:return setValueV4f;case 35674:return setValueM2;case 35675:return setValueM3;case 35676:return setValueM4;case 5124:case 35670:return setValueV1i;case 35667:case 35671:return setValueV2i;case 35668:case 35672:return setValueV3i;case 35669:case 35673:return setValueV4i;case 5125:return setValueV1ui;case 35678:case 36198:case 36298:case 36306:case 35682:return setValueT1;case 35679:case 36299:case 36307:return setValueT3D1;case 35680:case 36300:case 36308:case 36293:return setValueT6;case 36289:case 36303:case 36311:case 36292:return setValueT2DArray1}}function setValueV1fArray(e,t){e.uniform1fv(this.addr,t)}function setValueV1iArray(e,t){e.uniform1iv(this.addr,t)}function setValueV2iArray(e,t){e.uniform2iv(this.addr,t)}function setValueV3iArray(e,t){e.uniform3iv(this.addr,t)}function setValueV4iArray(e,t){e.uniform4iv(this.addr,t)}function setValueV2fArray(e,t){const r=flatten(t,this.size,2);e.uniform2fv(this.addr,r)}function setValueV3fArray(e,t){const r=flatten(t,this.size,3);e.uniform3fv(this.addr,r)}function setValueV4fArray(e,t){const r=flatten(t,this.size,4);e.uniform4fv(this.addr,r)}function setValueM2Array(e,t){const r=flatten(t,this.size,4);e.uniformMatrix2fv(this.addr,!1,r)}function setValueM3Array(e,t){const r=flatten(t,this.size,9);e.uniformMatrix3fv(this.addr,!1,r)}function setValueM4Array(e,t){const r=flatten(t,this.size,16);e.uniformMatrix4fv(this.addr,!1,r)}function setValueT1Array(e,t,r){const n=t.length,i=allocTexUnits(r,n);e.uniform1iv(this.addr,i);for(let e=0;e!==n;++e)r.safeSetTexture2D(t[e]||emptyTexture,i[e])}function setValueT6Array(e,t,r){const n=t.length,i=allocTexUnits(r,n);e.uniform1iv(this.addr,i);for(let e=0;e!==n;++e)r.safeSetTextureCube(t[e]||emptyCubeTexture,i[e])}function getPureArraySetter(e){switch(e){case 5126:return setValueV1fArray;case 35664:return setValueV2fArray;case 35665:return setValueV3fArray;case 35666:return setValueV4fArray;case 35674:return setValueM2Array;case 35675:return setValueM3Array;case 35676:return setValueM4Array;case 5124:case 35670:return setValueV1iArray;case 35667:case 35671:return setValueV2iArray;case 35668:case 35672:return setValueV3iArray;case 35669:case 35673:return setValueV4iArray;case 35678:case 36198:case 36298:case 36306:case 35682:return setValueT1Array;case 35680:case 36300:case 36308:case 36293:return setValueT6Array}}function SingleUniform(e,t,r){this.id=e,this.addr=r,this.cache=[],this.setValue=getSingularSetter(t.type)}function PureArrayUniform(e,t,r){this.id=e,this.addr=r,this.cache=[],this.size=t.size,this.setValue=getPureArraySetter(t.type)}function StructuredUniform(e){this.id=e,this.seq=[],this.map={}}PureArrayUniform.prototype.updateCache=function(e){const t=this.cache;e instanceof Float32Array&&t.length!==e.length&&(this.cache=new Float32Array(e.length)),copyArray(t,e)},StructuredUniform.prototype.setValue=function(e,t,r){const n=this.seq;for(let i=0,a=n.length;i!==a;++i){const a=n[i];a.setValue(e,t[a.id],r)}};const RePathPart=/(\w+)(\])?(\[|\.)?/g;function addUniform(e,t){e.seq.push(t),e.map[t.id]=t}function parseUniform(e,t,r){const n=e.name,i=n.length;for(RePathPart.lastIndex=0;;){const a=RePathPart.exec(n),o=RePathPart.lastIndex;let s=a[1];const l="]"===a[2],c=a[3];if(l&&(s|=0),void 0===c||"["===c&&o+2===i){addUniform(r,void 0===c?new SingleUniform(s,e,t):new PureArrayUniform(s,e,t));break}{let e=r.map[s];void 0===e&&(e=new StructuredUniform(s),addUniform(r,e)),r=e}}}function WebGLUniforms(e,t){this.seq=[],this.map={};const r=e.getProgramParameter(t,35718);for(let n=0;n<r;++n){const r=e.getActiveUniform(t,n);parseUniform(r,e.getUniformLocation(t,r.name),this)}}function WebGLShader(e,t,r){const n=e.createShader(t);return e.shaderSource(n,r),e.compileShader(n),n}WebGLUniforms.prototype.setValue=function(e,t,r,n){const i=this.map[t];void 0!==i&&i.setValue(e,r,n)},WebGLUniforms.prototype.setOptional=function(e,t,r){const n=t[r];void 0!==n&&this.setValue(e,r,n)},WebGLUniforms.upload=function(e,t,r,n){for(let i=0,a=t.length;i!==a;++i){const a=t[i],o=r[a.id];!1!==o.needsUpdate&&a.setValue(e,o.value,n)}},WebGLUniforms.seqWithValue=function(e,t){const r=[];for(let n=0,i=e.length;n!==i;++n){const i=e[n];i.id in t&&r.push(i)}return r};let programIdCount=0;function addLineNumbers(e){const t=e.split("\n");for(let e=0;e<t.length;e++)t[e]=e+1+": "+t[e];return t.join("\n")}function getEncodingComponents(e){switch(e){case LinearEncoding:return["Linear","( value )"];case sRGBEncoding:return["sRGB","( value )"];case RGBEEncoding:return["RGBE","( value )"];case RGBM7Encoding:return["RGBM","( value, 7.0 )"];case RGBM16Encoding:return["RGBM","( value, 16.0 )"];case RGBDEncoding:return["RGBD","( value, 256.0 )"];case GammaEncoding:return["Gamma","( value, float( GAMMA_FACTOR ) )"];case LogLuvEncoding:return["LogLuv","( value )"];default:return console.warn("THREE.WebGLProgram: Unsupported encoding:",e),["Linear","( value )"]}}function getShaderErrors(e,t,r){const n=e.getShaderParameter(t,35713),i=e.getShaderInfoLog(t).trim();if(n&&""===i)return"";return"THREE.WebGLShader: gl.getShaderInfoLog() "+r+"\n"+i+addLineNumbers(e.getShaderSource(t))}function getTexelDecodingFunction(e,t){const r=getEncodingComponents(t);return"vec4 "+e+"( vec4 value ) { return "+r[0]+"ToLinear"+r[1]+"; }"}function getTexelEncodingFunction(e,t){const r=getEncodingComponents(t);return"vec4 "+e+"( vec4 value ) { return LinearTo"+r[0]+r[1]+"; }"}function getToneMappingFunction(e,t){let r;switch(t){case LinearToneMapping:r="Linear";break;case ReinhardToneMapping:r="Reinhard";break;case CineonToneMapping:r="OptimizedCineon";break;case ACESFilmicToneMapping:r="ACESFilmic";break;case CustomToneMapping:r="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",t),r="Linear"}return"vec3 "+e+"( vec3 color ) { return "+r+"ToneMapping( color ); }"}function generateExtensions(e){return[e.extensionDerivatives||e.envMapCubeUV||e.bumpMap||e.tangentSpaceNormalMap||e.clearcoatNormalMap||e.flatShading||"physical"===e.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(e.extensionFragDepth||e.logarithmicDepthBuffer)&&e.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",e.extensionDrawBuffers&&e.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(e.extensionShaderTextureLOD||e.envMap)&&e.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(filterEmptyLine).join("\n")}function generateDefines(e){const t=[];for(const r in e){const n=e[r];!1!==n&&t.push("#define "+r+" "+n)}return t.join("\n")}function fetchAttributeLocations(e,t){const r={},n=e.getProgramParameter(t,35721);for(let i=0;i<n;i++){const n=e.getActiveAttrib(t,i).name;r[n]=e.getAttribLocation(t,n)}return r}function filterEmptyLine(e){return""!==e}function replaceLightNums(e,t){return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,t.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS/g,t.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,t.numPointLightShadows)}function replaceClippingPlaneNums(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,t.numClippingPlanes-t.numClipIntersection)}const includePattern=/^[ \t]*#include +<([\w\d./]+)>/gm;function resolveIncludes(e){return e.replace(includePattern,includeReplacer)}function includeReplacer(e,t){const r=ShaderChunk[t];if(void 0===r)throw new Error("Can not resolve #include <"+t+">");return resolveIncludes(r)}const deprecatedUnrollLoopPattern=/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,unrollLoopPattern=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function unrollLoops(e){return e.replace(unrollLoopPattern,loopReplacer).replace(deprecatedUnrollLoopPattern,deprecatedLoopReplacer)}function deprecatedLoopReplacer(e,t,r,n){return console.warn("WebGLProgram: #pragma unroll_loop shader syntax is deprecated. Please use #pragma unroll_loop_start syntax instead."),loopReplacer(e,t,r,n)}function loopReplacer(e,t,r,n){let i="";for(let e=parseInt(t);e<parseInt(r);e++)i+=n.replace(/\[\s*i\s*\]/g,"[ "+e+" ]").replace(/UNROLLED_LOOP_INDEX/g,e);return i}function generatePrecision(e){let t="precision "+e.precision+" float;\nprecision "+e.precision+" int;";return"highp"===e.precision?t+="\n#define HIGH_PRECISION":"mediump"===e.precision?t+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(t+="\n#define LOW_PRECISION"),t}function generateShadowMapTypeDefine(e){let t="SHADOWMAP_TYPE_BASIC";return e.shadowMapType===PCFShadowMap?t="SHADOWMAP_TYPE_PCF":e.shadowMapType===PCFSoftShadowMap?t="SHADOWMAP_TYPE_PCF_SOFT":e.shadowMapType===VSMShadowMap&&(t="SHADOWMAP_TYPE_VSM"),t}function generateEnvMapTypeDefine(e){let t="ENVMAP_TYPE_CUBE";if(e.envMap)switch(e.envMapMode){case CubeReflectionMapping:case CubeRefractionMapping:t="ENVMAP_TYPE_CUBE";break;case CubeUVReflectionMapping:case CubeUVRefractionMapping:t="ENVMAP_TYPE_CUBE_UV"}return t}function generateEnvMapModeDefine(e){let t="ENVMAP_MODE_REFLECTION";if(e.envMap)switch(e.envMapMode){case CubeRefractionMapping:case CubeUVRefractionMapping:t="ENVMAP_MODE_REFRACTION"}return t}function generateEnvMapBlendingDefine(e){let t="ENVMAP_BLENDING_NONE";if(e.envMap)switch(e.combine){case MultiplyOperation:t="ENVMAP_BLENDING_MULTIPLY";break;case MixOperation:t="ENVMAP_BLENDING_MIX";break;case AddOperation:t="ENVMAP_BLENDING_ADD"}return t}function WebGLProgram(e,t,r,n){const i=e.getContext(),a=r.defines;let o=r.vertexShader,s=r.fragmentShader;const l=generateShadowMapTypeDefine(r),c=generateEnvMapTypeDefine(r),h=generateEnvMapModeDefine(r),u=generateEnvMapBlendingDefine(r),d=e.gammaFactor>0?e.gammaFactor:1,p=r.isWebGL2?"":generateExtensions(r),f=generateDefines(a),m=i.createProgram();let g,y,v=r.glslVersion?"#version "+r.glslVersion+"\n":"";r.isRawShaderMaterial?(g=[f].filter(filterEmptyLine).join("\n"),g.length>0&&(g+="\n"),y=[p,f].filter(filterEmptyLine).join("\n"),y.length>0&&(y+="\n")):(g=[generatePrecision(r),"#define SHADER_NAME "+r.shaderName,f,r.instancing?"#define USE_INSTANCING":"",r.instancingColor?"#define USE_INSTANCING_COLOR":"",r.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+d,"#define MAX_BONES "+r.maxBones,r.useFog&&r.fog?"#define USE_FOG":"",r.useFog&&r.fogExp2?"#define FOG_EXP2":"",r.map?"#define USE_MAP":"",r.envMap?"#define USE_ENVMAP":"",r.envMap?"#define "+h:"",r.lightMap?"#define USE_LIGHTMAP":"",r.aoMap?"#define USE_AOMAP":"",r.emissiveMap?"#define USE_EMISSIVEMAP":"",r.bumpMap?"#define USE_BUMPMAP":"",r.normalMap?"#define USE_NORMALMAP":"",r.normalMap&&r.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",r.normalMap&&r.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",r.clearcoatMap?"#define USE_CLEARCOATMAP":"",r.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",r.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",r.displacementMap&&r.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",r.specularMap?"#define USE_SPECULARMAP":"",r.roughnessMap?"#define USE_ROUGHNESSMAP":"",r.metalnessMap?"#define USE_METALNESSMAP":"",r.alphaMap?"#define USE_ALPHAMAP":"",r.transmissionMap?"#define USE_TRANSMISSIONMAP":"",r.vertexTangents?"#define USE_TANGENT":"",r.vertexColors?"#define USE_COLOR":"",r.vertexUvs?"#define USE_UV":"",r.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",r.flatShading?"#define FLAT_SHADED":"",r.skinning?"#define USE_SKINNING":"",r.useVertexTexture?"#define BONE_TEXTURE":"",r.morphTargets?"#define USE_MORPHTARGETS":"",r.morphNormals&&!1===r.flatShading?"#define USE_MORPHNORMALS":"",r.doubleSided?"#define DOUBLE_SIDED":"",r.flipSided?"#define FLIP_SIDED":"",r.shadowMapEnabled?"#define USE_SHADOWMAP":"",r.shadowMapEnabled?"#define "+l:"",r.sizeAttenuation?"#define USE_SIZEATTENUATION":"",r.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",r.logarithmicDepthBuffer&&r.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#ifdef USE_COLOR","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(filterEmptyLine).join("\n"),y=[p,generatePrecision(r),"#define SHADER_NAME "+r.shaderName,f,r.alphaTest?"#define ALPHATEST "+r.alphaTest+(r.alphaTest%1?"":".0"):"","#define GAMMA_FACTOR "+d,r.useFog&&r.fog?"#define USE_FOG":"",r.useFog&&r.fogExp2?"#define FOG_EXP2":"",r.map?"#define USE_MAP":"",r.matcap?"#define USE_MATCAP":"",r.envMap?"#define USE_ENVMAP":"",r.envMap?"#define "+c:"",r.envMap?"#define "+h:"",r.envMap?"#define "+u:"",r.lightMap?"#define USE_LIGHTMAP":"",r.aoMap?"#define USE_AOMAP":"",r.emissiveMap?"#define USE_EMISSIVEMAP":"",r.bumpMap?"#define USE_BUMPMAP":"",r.normalMap?"#define USE_NORMALMAP":"",r.normalMap&&r.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",r.normalMap&&r.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",r.clearcoatMap?"#define USE_CLEARCOATMAP":"",r.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",r.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",r.specularMap?"#define USE_SPECULARMAP":"",r.roughnessMap?"#define USE_ROUGHNESSMAP":"",r.metalnessMap?"#define USE_METALNESSMAP":"",r.alphaMap?"#define USE_ALPHAMAP":"",r.sheen?"#define USE_SHEEN":"",r.transmissionMap?"#define USE_TRANSMISSIONMAP":"",r.vertexTangents?"#define USE_TANGENT":"",r.vertexColors||r.instancingColor?"#define USE_COLOR":"",r.vertexUvs?"#define USE_UV":"",r.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",r.gradientMap?"#define USE_GRADIENTMAP":"",r.flatShading?"#define FLAT_SHADED":"",r.doubleSided?"#define DOUBLE_SIDED":"",r.flipSided?"#define FLIP_SIDED":"",r.shadowMapEnabled?"#define USE_SHADOWMAP":"",r.shadowMapEnabled?"#define "+l:"",r.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",r.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",r.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",r.logarithmicDepthBuffer&&r.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"",(r.extensionShaderTextureLOD||r.envMap)&&r.rendererExtensionShaderTextureLod?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",r.toneMapping!==NoToneMapping?"#define TONE_MAPPING":"",r.toneMapping!==NoToneMapping?ShaderChunk.tonemapping_pars_fragment:"",r.toneMapping!==NoToneMapping?getToneMappingFunction("toneMapping",r.toneMapping):"",r.dithering?"#define DITHERING":"",ShaderChunk.encodings_pars_fragment,r.map?getTexelDecodingFunction("mapTexelToLinear",r.mapEncoding):"",r.matcap?getTexelDecodingFunction("matcapTexelToLinear",r.matcapEncoding):"",r.envMap?getTexelDecodingFunction("envMapTexelToLinear",r.envMapEncoding):"",r.emissiveMap?getTexelDecodingFunction("emissiveMapTexelToLinear",r.emissiveMapEncoding):"",r.lightMap?getTexelDecodingFunction("lightMapTexelToLinear",r.lightMapEncoding):"",getTexelEncodingFunction("linearToOutputTexel",r.outputEncoding),r.depthPacking?"#define DEPTH_PACKING "+r.depthPacking:"","\n"].filter(filterEmptyLine).join("\n")),o=resolveIncludes(o),o=replaceLightNums(o,r),o=replaceClippingPlaneNums(o,r),s=resolveIncludes(s),s=replaceLightNums(s,r),s=replaceClippingPlaneNums(s,r),o=unrollLoops(o),s=unrollLoops(s),r.isWebGL2&&!0!==r.isRawShaderMaterial&&(v="#version 300 es\n",g=["#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+g,y=["#define varying in",r.glslVersion===GLSL3?"":"out highp vec4 pc_fragColor;",r.glslVersion===GLSL3?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+y);const b=v+y+s,_=WebGLShader(i,35633,v+g+o),x=WebGLShader(i,35632,b);if(i.attachShader(m,_),i.attachShader(m,x),void 0!==r.index0AttributeName?i.bindAttribLocation(m,0,r.index0AttributeName):!0===r.morphTargets&&i.bindAttribLocation(m,0,"position"),i.linkProgram(m),e.debug.checkShaderErrors){const e=i.getProgramInfoLog(m).trim(),t=i.getShaderInfoLog(_).trim(),r=i.getShaderInfoLog(x).trim();let n=!0,a=!0;if(!1===i.getProgramParameter(m,35714)){n=!1;const t=getShaderErrors(i,_,"vertex"),r=getShaderErrors(i,x,"fragment");console.error("THREE.WebGLProgram: shader error: ",i.getError(),"35715",i.getProgramParameter(m,35715),"gl.getProgramInfoLog",e,t,r)}else""!==e?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",e):""!==t&&""!==r||(a=!1);a&&(this.diagnostics={runnable:n,programLog:e,vertexShader:{log:t,prefix:g},fragmentShader:{log:r,prefix:y}})}let w,S;return i.deleteShader(_),i.deleteShader(x),this.getUniforms=function(){return void 0===w&&(w=new WebGLUniforms(i,m)),w},this.getAttributes=function(){return void 0===S&&(S=fetchAttributeLocations(i,m)),S},this.destroy=function(){n.releaseStatesOfProgram(this),i.deleteProgram(m),this.program=void 0},this.name=r.shaderName,this.id=programIdCount++,this.cacheKey=t,this.usedTimes=1,this.program=m,this.vertexShader=_,this.fragmentShader=x,this}function WebGLPrograms(e,t,r,n,i,a){const o=[],s=n.isWebGL2,l=n.logarithmicDepthBuffer,c=n.floatVertexTextures,h=n.maxVertexUniforms,u=n.vertexTextures;let d=n.precision;const p={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"},f=["precision","isWebGL2","supportsVertexTextures","outputEncoding","instancing","instancingColor","map","mapEncoding","matcap","matcapEncoding","envMap","envMapMode","envMapEncoding","envMapCubeUV","lightMap","lightMapEncoding","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","objectSpaceNormalMap","tangentSpaceNormalMap","clearcoatMap","clearcoatRoughnessMap","clearcoatNormalMap","displacementMap","specularMap","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","vertexTangents","vertexUvs","uvsVertexOnly","fog","useFog","fogExp2","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","numDirLightShadows","numPointLightShadows","numSpotLightShadows","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering","sheen","transmissionMap"];function m(e){let t;return e&&e.isTexture?t=e.encoding:e&&e.isWebGLRenderTarget?(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),t=e.texture.encoding):t=LinearEncoding,t}return{getParameters:function(i,o,f,g,y){const v=g.fog,b=i.isMeshStandardMaterial?g.environment:null,_=t.get(i.envMap||b),x=p[i.type],w=y.isSkinnedMesh?function(e){const t=e.skeleton.bones;if(c)return 1024;{const e=h,r=Math.floor((e-20)/4),n=Math.min(r,t.length);return n<t.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+t.length+" bones. This GPU supports "+n+"."),0):n}}(y):0;let S,M;if(null!==i.precision&&(d=n.getMaxPrecision(i.precision),d!==i.precision&&console.warn("THREE.WebGLProgram.getParameters:",i.precision,"not supported, using",d,"instead.")),x){const e=ShaderLib[x];S=e.vertexShader,M=e.fragmentShader}else S=i.vertexShader,M=i.fragmentShader;const T=e.getRenderTarget();return{isWebGL2:s,shaderID:x,shaderName:i.type,vertexShader:S,fragmentShader:M,defines:i.defines,isRawShaderMaterial:!0===i.isRawShaderMaterial,glslVersion:i.glslVersion,precision:d,instancing:!0===y.isInstancedMesh,instancingColor:!0===y.isInstancedMesh&&null!==y.instanceColor,supportsVertexTextures:u,outputEncoding:null!==T?m(T.texture):e.outputEncoding,map:!!i.map,mapEncoding:m(i.map),matcap:!!i.matcap,matcapEncoding:m(i.matcap),envMap:!!_,envMapMode:_&&_.mapping,envMapEncoding:m(_),envMapCubeUV:!!_&&(_.mapping===CubeUVReflectionMapping||_.mapping===CubeUVRefractionMapping),lightMap:!!i.lightMap,lightMapEncoding:m(i.lightMap),aoMap:!!i.aoMap,emissiveMap:!!i.emissiveMap,emissiveMapEncoding:m(i.emissiveMap),bumpMap:!!i.bumpMap,normalMap:!!i.normalMap,objectSpaceNormalMap:i.normalMapType===ObjectSpaceNormalMap,tangentSpaceNormalMap:i.normalMapType===TangentSpaceNormalMap,clearcoatMap:!!i.clearcoatMap,clearcoatRoughnessMap:!!i.clearcoatRoughnessMap,clearcoatNormalMap:!!i.clearcoatNormalMap,displacementMap:!!i.displacementMap,roughnessMap:!!i.roughnessMap,metalnessMap:!!i.metalnessMap,specularMap:!!i.specularMap,alphaMap:!!i.alphaMap,gradientMap:!!i.gradientMap,sheen:!!i.sheen,transmissionMap:!!i.transmissionMap,combine:i.combine,vertexTangents:i.normalMap&&i.vertexTangents,vertexColors:i.vertexColors,vertexUvs:!!(i.map||i.bumpMap||i.normalMap||i.specularMap||i.alphaMap||i.emissiveMap||i.roughnessMap||i.metalnessMap||i.clearcoatMap||i.clearcoatRoughnessMap||i.clearcoatNormalMap||i.displacementMap||i.transmissionMap),uvsVertexOnly:!(i.map||i.bumpMap||i.normalMap||i.specularMap||i.alphaMap||i.emissiveMap||i.roughnessMap||i.metalnessMap||i.clearcoatNormalMap||i.transmissionMap||!i.displacementMap),fog:!!v,useFog:i.fog,fogExp2:v&&v.isFogExp2,flatShading:!!i.flatShading,sizeAttenuation:i.sizeAttenuation,logarithmicDepthBuffer:l,skinning:i.skinning&&w>0,maxBones:w,useVertexTexture:c,morphTargets:i.morphTargets,morphNormals:i.morphNormals,maxMorphTargets:e.maxMorphTargets,maxMorphNormals:e.maxMorphNormals,numDirLights:o.directional.length,numPointLights:o.point.length,numSpotLights:o.spot.length,numRectAreaLights:o.rectArea.length,numHemiLights:o.hemi.length,numDirLightShadows:o.directionalShadowMap.length,numPointLightShadows:o.pointShadowMap.length,numSpotLightShadows:o.spotShadowMap.length,numClippingPlanes:a.numPlanes,numClipIntersection:a.numIntersection,dithering:i.dithering,shadowMapEnabled:e.shadowMap.enabled&&f.length>0,shadowMapType:e.shadowMap.type,toneMapping:i.toneMapped?e.toneMapping:NoToneMapping,physicallyCorrectLights:e.physicallyCorrectLights,premultipliedAlpha:i.premultipliedAlpha,alphaTest:i.alphaTest,doubleSided:i.side===DoubleSide,flipSided:i.side===BackSide,depthPacking:void 0!==i.depthPacking&&i.depthPacking,index0AttributeName:i.index0AttributeName,extensionDerivatives:i.extensions&&i.extensions.derivatives,extensionFragDepth:i.extensions&&i.extensions.fragDepth,extensionDrawBuffers:i.extensions&&i.extensions.drawBuffers,extensionShaderTextureLOD:i.extensions&&i.extensions.shaderTextureLOD,rendererExtensionFragDepth:s||r.has("EXT_frag_depth"),rendererExtensionDrawBuffers:s||r.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:s||r.has("EXT_shader_texture_lod"),customProgramCacheKey:i.customProgramCacheKey()}},getProgramCacheKey:function(t){const r=[];if(t.shaderID?r.push(t.shaderID):(r.push(t.fragmentShader),r.push(t.vertexShader)),void 0!==t.defines)for(const e in t.defines)r.push(e),r.push(t.defines[e]);if(!1===t.isRawShaderMaterial){for(let e=0;e<f.length;e++)r.push(t[f[e]]);r.push(e.outputEncoding),r.push(e.gammaFactor)}return r.push(t.customProgramCacheKey),r.join()},getUniforms:function(e){const t=p[e.type];let r;if(t){const e=ShaderLib[t];r=UniformsUtils.clone(e.uniforms)}else r=e.uniforms;return r},acquireProgram:function(t,r){let n;for(let e=0,t=o.length;e<t;e++){const t=o[e];if(t.cacheKey===r){n=t,++n.usedTimes;break}}return void 0===n&&(n=new WebGLProgram(e,r,t,i),o.push(n)),n},releaseProgram:function(e){if(0==--e.usedTimes){const t=o.indexOf(e);o[t]=o[o.length-1],o.pop(),e.destroy()}},programs:o}}function WebGLProperties(){let e=new WeakMap;return{get:function(t){let r=e.get(t);return void 0===r&&(r={},e.set(t,r)),r},remove:function(t){e.delete(t)},update:function(t,r,n){e.get(t)[r]=n},dispose:function(){e=new WeakMap}}}function painterSortStable(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.program!==t.program?e.program.id-t.program.id:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function reversePainterSortStable(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function WebGLRenderList(e){const t=[];let r=0;const n=[],i=[],a={id:-1};function o(n,i,o,s,l,c){let h=t[r];const u=e.get(o);return void 0===h?(h={id:n.id,object:n,geometry:i,material:o,program:u.program||a,groupOrder:s,renderOrder:n.renderOrder,z:l,group:c},t[r]=h):(h.id=n.id,h.object=n,h.geometry=i,h.material=o,h.program=u.program||a,h.groupOrder=s,h.renderOrder=n.renderOrder,h.z=l,h.group=c),r++,h}return{opaque:n,transparent:i,init:function(){r=0,n.length=0,i.length=0},push:function(e,t,r,a,s,l){const c=o(e,t,r,a,s,l);(!0===r.transparent?i:n).push(c)},unshift:function(e,t,r,a,s,l){const c=o(e,t,r,a,s,l);(!0===r.transparent?i:n).unshift(c)},finish:function(){for(let e=r,n=t.length;e<n;e++){const r=t[e];if(null===r.id)break;r.id=null,r.object=null,r.geometry=null,r.material=null,r.program=null,r.group=null}},sort:function(e,t){n.length>1&&n.sort(e||painterSortStable),i.length>1&&i.sort(t||reversePainterSortStable)}}}function WebGLRenderLists(e){let t=new WeakMap;return{get:function(r,n){let i;return!1===t.has(r)?(i=new WebGLRenderList(e),t.set(r,[i])):n>=t.get(r).length?(i=new WebGLRenderList(e),t.get(r).push(i)):i=t.get(r)[n],i},dispose:function(){t=new WeakMap}}}function UniformsCache(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let r;switch(t.type){case"DirectionalLight":r={direction:new Vector3,color:new Color};break;case"SpotLight":r={position:new Vector3,direction:new Vector3,color:new Color,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":r={position:new Vector3,color:new Color,distance:0,decay:0};break;case"HemisphereLight":r={direction:new Vector3,skyColor:new Color,groundColor:new Color};break;case"RectAreaLight":r={color:new Color,position:new Vector3,halfWidth:new Vector3,halfHeight:new Vector3}}return e[t.id]=r,r}}}function ShadowUniformsCache(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let r;switch(t.type){case"DirectionalLight":case"SpotLight":r={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Vector2};break;case"PointLight":r={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Vector2,shadowCameraNear:1,shadowCameraFar:1e3}}return e[t.id]=r,r}}}let nextVersion=0;function shadowCastingLightsFirst(e,t){return(t.castShadow?1:0)-(e.castShadow?1:0)}function WebGLLights(e,t){const r=new UniformsCache,n=ShadowUniformsCache(),i={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadow:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]};for(let e=0;e<9;e++)i.probe.push(new Vector3);const a=new Vector3,o=new Matrix4,s=new Matrix4;return{setup:function(a){let o=0,s=0,l=0;for(let e=0;e<9;e++)i.probe[e].set(0,0,0);let c=0,h=0,u=0,d=0,p=0,f=0,m=0,g=0;a.sort(shadowCastingLightsFirst);for(let e=0,t=a.length;e<t;e++){const t=a[e],y=t.color,v=t.intensity,b=t.distance,_=t.shadow&&t.shadow.map?t.shadow.map.texture:null;if(t.isAmbientLight)o+=y.r*v,s+=y.g*v,l+=y.b*v;else if(t.isLightProbe)for(let e=0;e<9;e++)i.probe[e].addScaledVector(t.sh.coefficients[e],v);else if(t.isDirectionalLight){const e=r.get(t);if(e.color.copy(t.color).multiplyScalar(t.intensity),t.castShadow){const e=t.shadow,r=n.get(t);r.shadowBias=e.bias,r.shadowNormalBias=e.normalBias,r.shadowRadius=e.radius,r.shadowMapSize=e.mapSize,i.directionalShadow[c]=r,i.directionalShadowMap[c]=_,i.directionalShadowMatrix[c]=t.shadow.matrix,f++}i.directional[c]=e,c++}else if(t.isSpotLight){const e=r.get(t);if(e.position.setFromMatrixPosition(t.matrixWorld),e.color.copy(y).multiplyScalar(v),e.distance=b,e.coneCos=Math.cos(t.angle),e.penumbraCos=Math.cos(t.angle*(1-t.penumbra)),e.decay=t.decay,t.castShadow){const e=t.shadow,r=n.get(t);r.shadowBias=e.bias,r.shadowNormalBias=e.normalBias,r.shadowRadius=e.radius,r.shadowMapSize=e.mapSize,i.spotShadow[u]=r,i.spotShadowMap[u]=_,i.spotShadowMatrix[u]=t.shadow.matrix,g++}i.spot[u]=e,u++}else if(t.isRectAreaLight){const e=r.get(t);e.color.copy(y).multiplyScalar(v),e.halfWidth.set(.5*t.width,0,0),e.halfHeight.set(0,.5*t.height,0),i.rectArea[d]=e,d++}else if(t.isPointLight){const e=r.get(t);if(e.color.copy(t.color).multiplyScalar(t.intensity),e.distance=t.distance,e.decay=t.decay,t.castShadow){const e=t.shadow,r=n.get(t);r.shadowBias=e.bias,r.shadowNormalBias=e.normalBias,r.shadowRadius=e.radius,r.shadowMapSize=e.mapSize,r.shadowCameraNear=e.camera.near,r.shadowCameraFar=e.camera.far,i.pointShadow[h]=r,i.pointShadowMap[h]=_,i.pointShadowMatrix[h]=t.shadow.matrix,m++}i.point[h]=e,h++}else if(t.isHemisphereLight){const e=r.get(t);e.skyColor.copy(t.color).multiplyScalar(v),e.groundColor.copy(t.groundColor).multiplyScalar(v),i.hemi[p]=e,p++}}d>0&&(t.isWebGL2||!0===e.has("OES_texture_float_linear")?(i.rectAreaLTC1=UniformsLib.LTC_FLOAT_1,i.rectAreaLTC2=UniformsLib.LTC_FLOAT_2):!0===e.has("OES_texture_half_float_linear")?(i.rectAreaLTC1=UniformsLib.LTC_HALF_1,i.rectAreaLTC2=UniformsLib.LTC_HALF_2):console.error("THREE.WebGLRenderer: Unable to use RectAreaLight. Missing WebGL extensions.")),i.ambient[0]=o,i.ambient[1]=s,i.ambient[2]=l;const y=i.hash;y.directionalLength===c&&y.pointLength===h&&y.spotLength===u&&y.rectAreaLength===d&&y.hemiLength===p&&y.numDirectionalShadows===f&&y.numPointShadows===m&&y.numSpotShadows===g||(i.directional.length=c,i.spot.length=u,i.rectArea.length=d,i.point.length=h,i.hemi.length=p,i.directionalShadow.length=f,i.directionalShadowMap.length=f,i.pointShadow.length=m,i.pointShadowMap.length=m,i.spotShadow.length=g,i.spotShadowMap.length=g,i.directionalShadowMatrix.length=f,i.pointShadowMatrix.length=m,i.spotShadowMatrix.length=g,y.directionalLength=c,y.pointLength=h,y.spotLength=u,y.rectAreaLength=d,y.hemiLength=p,y.numDirectionalShadows=f,y.numPointShadows=m,y.numSpotShadows=g,i.version=nextVersion++)},setupView:function(e,t){let r=0,n=0,l=0,c=0,h=0;const u=t.matrixWorldInverse;for(let t=0,d=e.length;t<d;t++){const d=e[t];if(d.isDirectionalLight){const e=i.directional[r];e.direction.setFromMatrixPosition(d.matrixWorld),a.setFromMatrixPosition(d.target.matrixWorld),e.direction.sub(a),e.direction.transformDirection(u),r++}else if(d.isSpotLight){const e=i.spot[l];e.position.setFromMatrixPosition(d.matrixWorld),e.position.applyMatrix4(u),e.direction.setFromMatrixPosition(d.matrixWorld),a.setFromMatrixPosition(d.target.matrixWorld),e.direction.sub(a),e.direction.transformDirection(u),l++}else if(d.isRectAreaLight){const e=i.rectArea[c];e.position.setFromMatrixPosition(d.matrixWorld),e.position.applyMatrix4(u),s.identity(),o.copy(d.matrixWorld),o.premultiply(u),s.extractRotation(o),e.halfWidth.set(.5*d.width,0,0),e.halfHeight.set(0,.5*d.height,0),e.halfWidth.applyMatrix4(s),e.halfHeight.applyMatrix4(s),c++}else if(d.isPointLight){const e=i.point[n];e.position.setFromMatrixPosition(d.matrixWorld),e.position.applyMatrix4(u),n++}else if(d.isHemisphereLight){const e=i.hemi[h];e.direction.setFromMatrixPosition(d.matrixWorld),e.direction.transformDirection(u),e.direction.normalize(),h++}}},state:i}}function WebGLRenderState(e,t){const r=new WebGLLights(e,t),n=[],i=[];return{init:function(){n.length=0,i.length=0},state:{lightsArray:n,shadowsArray:i,lights:r},setupLights:function(){r.setup(n)},setupLightsView:function(e){r.setupView(n,e)},pushLight:function(e){n.push(e)},pushShadow:function(e){i.push(e)}}}function WebGLRenderStates(e,t){let r=new WeakMap;return{get:function(n,i=0){let a;return!1===r.has(n)?(a=new WebGLRenderState(e,t),r.set(n,[a])):i>=r.get(n).length?(a=new WebGLRenderState(e,t),r.get(n).push(a)):a=r.get(n)[i],a},dispose:function(){r=new WeakMap}}}class MeshDepthMaterial extends Material$1{constructor(e){super(),this.type="MeshDepthMaterial",this.depthPacking=BasicDepthPacking,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}MeshDepthMaterial.prototype.isMeshDepthMaterial=!0;class MeshDistanceMaterial extends Material$1{constructor(e){super(),this.type="MeshDistanceMaterial",this.referencePosition=new Vector3,this.nearDistance=1,this.farDistance=1e3,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.fog=!1,this.setValues(e)}copy(e){return super.copy(e),this.referencePosition.copy(e.referencePosition),this.nearDistance=e.nearDistance,this.farDistance=e.farDistance,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}MeshDistanceMaterial.prototype.isMeshDistanceMaterial=!0;var vsm_frag="uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy ) / resolution ) );\n\tfor ( float i = -1.0; i < 1.0 ; i += SAMPLE_RATE) {\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( i, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, i ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean * HALF_SAMPLE_RATE;\n\tsquared_mean = squared_mean * HALF_SAMPLE_RATE;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}",vsm_vert="void main() {\n\tgl_Position = vec4( position, 1.0 );\n}";function WebGLShadowMap(e,t,r){let n=new Frustum;const i=new Vector2,a=new Vector2,o=new Vector4,s=[],l=[],c={},h={0:BackSide,1:FrontSide,2:DoubleSide},u=new ShaderMaterial({defines:{SAMPLE_RATE:2/8,HALF_SAMPLE_RATE:1/8},uniforms:{shadow_pass:{value:null},resolution:{value:new Vector2},radius:{value:4}},vertexShader:vsm_vert,fragmentShader:vsm_frag}),d=u.clone();d.defines.HORIZONTAL_PASS=1;const p=new BufferGeometry;p.setAttribute("position",new BufferAttribute(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const f=new Mesh(p,u),m=this;function g(r,n){const i=t.update(f);u.uniforms.shadow_pass.value=r.map.texture,u.uniforms.resolution.value=r.mapSize,u.uniforms.radius.value=r.radius,e.setRenderTarget(r.mapPass),e.clear(),e.renderBufferDirect(n,null,i,u,f,null),d.uniforms.shadow_pass.value=r.mapPass.texture,d.uniforms.resolution.value=r.mapSize,d.uniforms.radius.value=r.radius,e.setRenderTarget(r.map),e.clear(),e.renderBufferDirect(n,null,i,d,f,null)}function y(e,t,r){const n=e<<0|t<<1|r<<2;let i=s[n];return void 0===i&&(i=new MeshDepthMaterial({depthPacking:RGBADepthPacking,morphTargets:e,skinning:t}),s[n]=i),i}function v(e,t,r){const n=e<<0|t<<1|r<<2;let i=l[n];return void 0===i&&(i=new MeshDistanceMaterial({morphTargets:e,skinning:t}),l[n]=i),i}function b(t,r,n,i,a,o,s){let l=null,u=y,d=t.customDepthMaterial;if(!0===i.isPointLight&&(u=v,d=t.customDistanceMaterial),void 0===d){let e=!1;!0===n.morphTargets&&(e=r.morphAttributes&&r.morphAttributes.position&&r.morphAttributes.position.length>0);let i=!1;!0===t.isSkinnedMesh&&(!0===n.skinning?i=!0:console.warn("THREE.WebGLShadowMap: THREE.SkinnedMesh with material.skinning set to false:",t));l=u(e,i,!0===t.isInstancedMesh)}else l=d;if(e.localClippingEnabled&&!0===n.clipShadows&&0!==n.clippingPlanes.length){const e=l.uuid,t=n.uuid;let r=c[e];void 0===r&&(r={},c[e]=r);let i=r[t];void 0===i&&(i=l.clone(),r[t]=i),l=i}return l.visible=n.visible,l.wireframe=n.wireframe,l.side=s===VSMShadowMap?null!==n.shadowSide?n.shadowSide:n.side:null!==n.shadowSide?n.shadowSide:h[n.side],l.clipShadows=n.clipShadows,l.clippingPlanes=n.clippingPlanes,l.clipIntersection=n.clipIntersection,l.wireframeLinewidth=n.wireframeLinewidth,l.linewidth=n.linewidth,!0===i.isPointLight&&!0===l.isMeshDistanceMaterial&&(l.referencePosition.setFromMatrixPosition(i.matrixWorld),l.nearDistance=a,l.farDistance=o),l}function _(r,i,a,o,s){if(!1===r.visible)return;if(r.layers.test(i.layers)&&(r.isMesh||r.isLine||r.isPoints)&&(r.castShadow||r.receiveShadow&&s===VSMShadowMap)&&(!r.frustumCulled||n.intersectsObject(r))){r.modelViewMatrix.multiplyMatrices(a.matrixWorldInverse,r.matrixWorld);const n=t.update(r),i=r.material;if(Array.isArray(i)){const t=n.groups;for(let l=0,c=t.length;l<c;l++){const c=t[l],h=i[c.materialIndex];if(h&&h.visible){const t=b(r,n,h,o,a.near,a.far,s);e.renderBufferDirect(a,null,n,t,r,c)}}}else if(i.visible){const t=b(r,n,i,o,a.near,a.far,s);e.renderBufferDirect(a,null,n,t,r,null)}}const l=r.children;for(let e=0,t=l.length;e<t;e++)_(l[e],i,a,o,s)}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=PCFShadowMap,this.render=function(t,s,l){if(!1===m.enabled)return;if(!1===m.autoUpdate&&!1===m.needsUpdate)return;if(0===t.length)return;const c=e.getRenderTarget(),h=e.getActiveCubeFace(),u=e.getActiveMipmapLevel(),d=e.state;d.setBlending(NoBlending),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);for(let c=0,h=t.length;c<h;c++){const h=t[c],u=h.shadow;if(void 0===u){console.warn("THREE.WebGLShadowMap:",h,"has no shadow.");continue}if(!1===u.autoUpdate&&!1===u.needsUpdate)continue;i.copy(u.mapSize);const p=u.getFrameExtents();if(i.multiply(p),a.copy(u.mapSize),(i.x>r||i.y>r)&&(i.x>r&&(a.x=Math.floor(r/p.x),i.x=a.x*p.x,u.mapSize.x=a.x),i.y>r&&(a.y=Math.floor(r/p.y),i.y=a.y*p.y,u.mapSize.y=a.y)),null===u.map&&!u.isPointLightShadow&&this.type===VSMShadowMap){const e={minFilter:LinearFilter,magFilter:LinearFilter,format:RGBAFormat};u.map=new WebGLRenderTarget(i.x,i.y,e),u.map.texture.name=h.name+".shadowMap",u.mapPass=new WebGLRenderTarget(i.x,i.y,e),u.camera.updateProjectionMatrix()}if(null===u.map){const e={minFilter:NearestFilter,magFilter:NearestFilter,format:RGBAFormat};u.map=new WebGLRenderTarget(i.x,i.y,e),u.map.texture.name=h.name+".shadowMap",u.camera.updateProjectionMatrix()}e.setRenderTarget(u.map),e.clear();const f=u.getViewportCount();for(let e=0;e<f;e++){const t=u.getViewport(e);o.set(a.x*t.x,a.y*t.y,a.x*t.z,a.y*t.w),d.viewport(o),u.updateMatrices(h,e),n=u.getFrustum(),_(s,l,u.camera,h,this.type)}u.isPointLightShadow||this.type!==VSMShadowMap||g(u,l),u.needsUpdate=!1}m.needsUpdate=!1,e.setRenderTarget(c,h,u)}}function WebGLState(e,t,r){const n=r.isWebGL2;const i=new function(){let t=!1;const r=new Vector4;let n=null;const i=new Vector4(0,0,0,0);return{setMask:function(r){n===r||t||(e.colorMask(r,r,r,r),n=r)},setLocked:function(e){t=e},setClear:function(t,n,a,o,s){!0===s&&(t*=o,n*=o,a*=o),r.set(t,n,a,o),!1===i.equals(r)&&(e.clearColor(t,n,a,o),i.copy(r))},reset:function(){t=!1,n=null,i.set(-1,0,0,0)}}},a=new function(){let t=!1,r=null,n=null,i=null;return{setTest:function(e){e?O(2929):I(2929)},setMask:function(n){r===n||t||(e.depthMask(n),r=n)},setFunc:function(t){if(n!==t){if(t)switch(t){case NeverDepth:e.depthFunc(512);break;case AlwaysDepth:e.depthFunc(519);break;case LessDepth:e.depthFunc(513);break;case LessEqualDepth:e.depthFunc(515);break;case EqualDepth:e.depthFunc(514);break;case GreaterEqualDepth:e.depthFunc(518);break;case GreaterDepth:e.depthFunc(516);break;case NotEqualDepth:e.depthFunc(517);break;default:e.depthFunc(515)}else e.depthFunc(515);n=t}},setLocked:function(e){t=e},setClear:function(t){i!==t&&(e.clearDepth(t),i=t)},reset:function(){t=!1,r=null,n=null,i=null}}},o=new function(){let t=!1,r=null,n=null,i=null,a=null,o=null,s=null,l=null,c=null;return{setTest:function(e){t||(e?O(2960):I(2960))},setMask:function(n){r===n||t||(e.stencilMask(n),r=n)},setFunc:function(t,r,o){n===t&&i===r&&a===o||(e.stencilFunc(t,r,o),n=t,i=r,a=o)},setOp:function(t,r,n){o===t&&s===r&&l===n||(e.stencilOp(t,r,n),o=t,s=r,l=n)},setLocked:function(e){t=e},setClear:function(t){c!==t&&(e.clearStencil(t),c=t)},reset:function(){t=!1,r=null,n=null,i=null,a=null,o=null,s=null,l=null,c=null}}};let s={},l=null,c=!1,h=null,u=null,d=null,p=null,f=null,m=null,g=null,y=!1,v=null,b=null,_=null,x=null,w=null;const S=e.getParameter(35661);let M=!1,T=0;const A=e.getParameter(7938);-1!==A.indexOf("WebGL")?(T=parseFloat(/^WebGL (\d)/.exec(A)[1]),M=T>=1):-1!==A.indexOf("OpenGL ES")&&(T=parseFloat(/^OpenGL ES (\d)/.exec(A)[1]),M=T>=2);let E=null,C={};const L=new Vector4,D=new Vector4;function R(t,r,n){const i=new Uint8Array(4),a=e.createTexture();e.bindTexture(t,a),e.texParameteri(t,10241,9728),e.texParameteri(t,10240,9728);for(let t=0;t<n;t++)e.texImage2D(r+t,0,6408,1,1,0,6408,5121,i);return a}const P={};function O(t){!0!==s[t]&&(e.enable(t),s[t]=!0)}function I(t){!1!==s[t]&&(e.disable(t),s[t]=!1)}P[3553]=R(3553,3553,1),P[34067]=R(34067,34069,6),i.setClear(0,0,0,1),a.setClear(1),o.setClear(0),O(2929),a.setFunc(LessEqualDepth),F(!1),U(CullFaceBack),O(2884),N(NoBlending);const k={[AddEquation]:32774,[SubtractEquation]:32778,[ReverseSubtractEquation]:32779};if(n)k[MinEquation]=32775,k[MaxEquation]=32776;else{const e=t.get("EXT_blend_minmax");null!==e&&(k[MinEquation]=e.MIN_EXT,k[MaxEquation]=e.MAX_EXT)}const B={[ZeroFactor]:0,[OneFactor]:1,[SrcColorFactor]:768,[SrcAlphaFactor]:770,[SrcAlphaSaturateFactor]:776,[DstColorFactor]:774,[DstAlphaFactor]:772,[OneMinusSrcColorFactor]:769,[OneMinusSrcAlphaFactor]:771,[OneMinusDstColorFactor]:775,[OneMinusDstAlphaFactor]:773};function N(t,r,n,i,a,o,s,l){if(t!==NoBlending){if(!1===c&&(O(3042),c=!0),t===CustomBlending)a=a||r,o=o||n,s=s||i,r===u&&a===f||(e.blendEquationSeparate(k[r],k[a]),u=r,f=a),n===d&&i===p&&o===m&&s===g||(e.blendFuncSeparate(B[n],B[i],B[o],B[s]),d=n,p=i,m=o,g=s),h=t,y=null;else if(t!==h||l!==y){if(u===AddEquation&&f===AddEquation||(e.blendEquation(32774),u=AddEquation,f=AddEquation),l)switch(t){case NormalBlending:e.blendFuncSeparate(1,771,1,771);break;case AdditiveBlending:e.blendFunc(1,1);break;case SubtractiveBlending:e.blendFuncSeparate(0,0,769,771);break;case MultiplyBlending:e.blendFuncSeparate(0,768,0,770);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}else switch(t){case NormalBlending:e.blendFuncSeparate(770,771,1,771);break;case AdditiveBlending:e.blendFunc(770,1);break;case SubtractiveBlending:e.blendFunc(0,769);break;case MultiplyBlending:e.blendFunc(0,768);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}d=null,p=null,m=null,g=null,h=t,y=l}}else!0===c&&(I(3042),c=!1)}function F(t){v!==t&&(t?e.frontFace(2304):e.frontFace(2305),v=t)}function U(t){t!==CullFaceNone?(O(2884),t!==b&&(t===CullFaceBack?e.cullFace(1029):t===CullFaceFront?e.cullFace(1028):e.cullFace(1032))):I(2884),b=t}function z(t,r,n){t?(O(32823),x===r&&w===n||(e.polygonOffset(r,n),x=r,w=n)):I(32823)}function H(t){void 0===t&&(t=33984+S-1),E!==t&&(e.activeTexture(t),E=t)}return{buffers:{color:i,depth:a,stencil:o},enable:O,disable:I,useProgram:function(t){return l!==t&&(e.useProgram(t),l=t,!0)},setBlending:N,setMaterial:function(e,t){e.side===DoubleSide?I(2884):O(2884);let r=e.side===BackSide;t&&(r=!r),F(r),e.blending===NormalBlending&&!1===e.transparent?N(NoBlending):N(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha),a.setFunc(e.depthFunc),a.setTest(e.depthTest),a.setMask(e.depthWrite),i.setMask(e.colorWrite);const n=e.stencilWrite;o.setTest(n),n&&(o.setMask(e.stencilWriteMask),o.setFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),o.setOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),z(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits)},setFlipSided:F,setCullFace:U,setLineWidth:function(t){t!==_&&(M&&e.lineWidth(t),_=t)},setPolygonOffset:z,setScissorTest:function(e){e?O(3089):I(3089)},activeTexture:H,bindTexture:function(t,r){null===E&&H();let n=C[E];void 0===n&&(n={type:void 0,texture:void 0},C[E]=n),n.type===t&&n.texture===r||(e.bindTexture(t,r||P[t]),n.type=t,n.texture=r)},unbindTexture:function(){const t=C[E];void 0!==t&&void 0!==t.type&&(e.bindTexture(t.type,null),t.type=void 0,t.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage2D:function(){try{e.texImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage3D:function(){try{e.texImage3D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},scissor:function(t){!1===L.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),L.copy(t))},viewport:function(t){!1===D.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),D.copy(t))},reset:function(){e.disable(3042),e.disable(2884),e.disable(2929),e.disable(32823),e.disable(3089),e.disable(2960),e.blendEquation(32774),e.blendFunc(1,0),e.blendFuncSeparate(1,0,1,0),e.colorMask(!0,!0,!0,!0),e.clearColor(0,0,0,0),e.depthMask(!0),e.depthFunc(513),e.clearDepth(1),e.stencilMask(4294967295),e.stencilFunc(519,0,4294967295),e.stencilOp(7680,7680,7680),e.clearStencil(0),e.cullFace(1029),e.frontFace(2305),e.polygonOffset(0,0),e.activeTexture(33984),e.useProgram(null),e.lineWidth(1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.viewport(0,0,e.canvas.width,e.canvas.height),s={},E=null,C={},l=null,c=!1,h=null,u=null,d=null,p=null,f=null,m=null,g=null,y=!1,v=null,b=null,_=null,x=null,w=null,i.reset(),a.reset(),o.reset()}}}function WebGLTextures(e,t,r,n,i,a,o){const s=i.isWebGL2,l=i.maxTextures,c=i.maxCubemapSize,h=i.maxTextureSize,u=i.maxSamples,d=new WeakMap;let p,f=!1;try{f="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(e){}function m(e,t){return f?new OffscreenCanvas(e,t):document.createElementNS("http://www.w3.org/1999/xhtml","canvas")}function g(e,t,r,n){let i=1;if((e.width>n||e.height>n)&&(i=n/Math.max(e.width,e.height)),i<1||!0===t){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const n=t?MathUtils.floorPowerOfTwo:Math.floor,a=n(i*e.width),o=n(i*e.height);void 0===p&&(p=m(a,o));const s=r?m(a,o):p;s.width=a,s.height=o;return s.getContext("2d").drawImage(e,0,0,a,o),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+e.width+"x"+e.height+") to ("+a+"x"+o+")."),s}return"data"in e&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+e.width+"x"+e.height+")."),e}return e}function y(e){return MathUtils.isPowerOfTwo(e.width)&&MathUtils.isPowerOfTwo(e.height)}function v(e,t){return e.generateMipmaps&&t&&e.minFilter!==NearestFilter&&e.minFilter!==LinearFilter}function b(t,r,i,a){e.generateMipmap(t);n.get(r).__maxMipLevel=Math.log2(Math.max(i,a))}function _(r,n,i){if(!1===s)return n;if(null!==r){if(void 0!==e[r])return e[r];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+r+"'")}let a=n;return 6403===n&&(5126===i&&(a=33326),5131===i&&(a=33325),5121===i&&(a=33321)),6407===n&&(5126===i&&(a=34837),5131===i&&(a=34843),5121===i&&(a=32849)),6408===n&&(5126===i&&(a=34836),5131===i&&(a=34842),5121===i&&(a=32856)),33325!==a&&33326!==a&&34842!==a&&34836!==a||t.get("EXT_color_buffer_float"),a}function x(e){return e===NearestFilter||e===NearestMipmapNearestFilter||e===NearestMipmapLinearFilter?9728:9729}function w(t){const r=t.target;r.removeEventListener("dispose",w),function(t){const r=n.get(t);if(void 0===r.__webglInit)return;e.deleteTexture(r.__webglTexture),n.remove(t)}(r),r.isVideoTexture&&d.delete(r),o.memory.textures--}function S(t){const r=t.target;r.removeEventListener("dispose",S),function(t){const r=t.texture,i=n.get(t),a=n.get(r);if(!t)return;void 0!==a.__webglTexture&&e.deleteTexture(a.__webglTexture);t.depthTexture&&t.depthTexture.dispose();if(t.isWebGLCubeRenderTarget)for(let t=0;t<6;t++)e.deleteFramebuffer(i.__webglFramebuffer[t]),i.__webglDepthbuffer&&e.deleteRenderbuffer(i.__webglDepthbuffer[t]);else e.deleteFramebuffer(i.__webglFramebuffer),i.__webglDepthbuffer&&e.deleteRenderbuffer(i.__webglDepthbuffer),i.__webglMultisampledFramebuffer&&e.deleteFramebuffer(i.__webglMultisampledFramebuffer),i.__webglColorRenderbuffer&&e.deleteRenderbuffer(i.__webglColorRenderbuffer),i.__webglDepthRenderbuffer&&e.deleteRenderbuffer(i.__webglDepthRenderbuffer);n.remove(r),n.remove(t)}(r),o.memory.textures--}let M=0;function T(e,t){const i=n.get(e);if(e.isVideoTexture&&function(e){const t=o.render.frame;d.get(e)!==t&&(d.set(e,t),e.update())}(e),e.version>0&&i.__version!==e.version){const r=e.image;if(void 0===r)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined");else{if(!1!==r.complete)return void R(i,e,t);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}r.activeTexture(33984+t),r.bindTexture(3553,i.__webglTexture)}function A(t,i){const o=n.get(t);t.version>0&&o.__version!==t.version?function(t,n,i){if(6!==n.image.length)return;D(t,n),r.activeTexture(33984+i),r.bindTexture(34067,t.__webglTexture),e.pixelStorei(37440,n.flipY),e.pixelStorei(37441,n.premultiplyAlpha),e.pixelStorei(3317,n.unpackAlignment),e.pixelStorei(37443,0);const o=n&&(n.isCompressedTexture||n.image[0].isCompressedTexture),l=n.image[0]&&n.image[0].isDataTexture,h=[];for(let e=0;e<6;e++)h[e]=o||l?l?n.image[e].image:n.image[e]:g(n.image[e],!1,!0,c);const u=h[0],d=y(u)||s,p=a.convert(n.format),f=a.convert(n.type),m=_(n.internalFormat,p,f);let x;if(L(34067,n,d),o){for(let e=0;e<6;e++){x=h[e].mipmaps;for(let t=0;t<x.length;t++){const i=x[t];n.format!==RGBAFormat&&n.format!==RGBFormat?null!==p?r.compressedTexImage2D(34069+e,t,m,i.width,i.height,0,i.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):r.texImage2D(34069+e,t,m,i.width,i.height,0,p,f,i.data)}}t.__maxMipLevel=x.length-1}else{x=n.mipmaps;for(let e=0;e<6;e++)if(l){r.texImage2D(34069+e,0,m,h[e].width,h[e].height,0,p,f,h[e].data);for(let t=0;t<x.length;t++){const n=x[t].image[e].image;r.texImage2D(34069+e,t+1,m,n.width,n.height,0,p,f,n.data)}}else{r.texImage2D(34069+e,0,m,p,f,h[e]);for(let t=0;t<x.length;t++){const n=x[t];r.texImage2D(34069+e,t+1,m,p,f,n.image[e])}}t.__maxMipLevel=x.length}v(n,d)&&b(34067,n,u.width,u.height);t.__version=n.version,n.onUpdate&&n.onUpdate(n)}(o,t,i):(r.activeTexture(33984+i),r.bindTexture(34067,o.__webglTexture))}const E={[RepeatWrapping]:10497,[ClampToEdgeWrapping]:33071,[MirroredRepeatWrapping]:33648},C={[NearestFilter]:9728,[NearestMipmapNearestFilter]:9984,[NearestMipmapLinearFilter]:9986,[LinearFilter]:9729,[LinearMipmapNearestFilter]:9985,[LinearMipmapLinearFilter]:9987};function L(r,a,o){if(o?(e.texParameteri(r,10242,E[a.wrapS]),e.texParameteri(r,10243,E[a.wrapT]),32879!==r&&35866!==r||e.texParameteri(r,32882,E[a.wrapR]),e.texParameteri(r,10240,C[a.magFilter]),e.texParameteri(r,10241,C[a.minFilter])):(e.texParameteri(r,10242,33071),e.texParameteri(r,10243,33071),32879!==r&&35866!==r||e.texParameteri(r,32882,33071),a.wrapS===ClampToEdgeWrapping&&a.wrapT===ClampToEdgeWrapping||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),e.texParameteri(r,10240,x(a.magFilter)),e.texParameteri(r,10241,x(a.minFilter)),a.minFilter!==NearestFilter&&a.minFilter!==LinearFilter&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.")),!0===t.has("EXT_texture_filter_anisotropic")){const o=t.get("EXT_texture_filter_anisotropic");if(a.type===FloatType&&!1===t.has("OES_texture_float_linear"))return;if(!1===s&&a.type===HalfFloatType&&!1===t.has("OES_texture_half_float_linear"))return;(a.anisotropy>1||n.get(a).__currentAnisotropy)&&(e.texParameterf(r,o.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(a.anisotropy,i.getMaxAnisotropy())),n.get(a).__currentAnisotropy=a.anisotropy)}}function D(t,r){void 0===t.__webglInit&&(t.__webglInit=!0,r.addEventListener("dispose",w),t.__webglTexture=e.createTexture(),o.memory.textures++)}function R(t,n,i){let o=3553;n.isDataTexture2DArray&&(o=35866),n.isDataTexture3D&&(o=32879),D(t,n),r.activeTexture(33984+i),r.bindTexture(o,t.__webglTexture),e.pixelStorei(37440,n.flipY),e.pixelStorei(37441,n.premultiplyAlpha),e.pixelStorei(3317,n.unpackAlignment),e.pixelStorei(37443,0);const l=function(e){return!s&&(e.wrapS!==ClampToEdgeWrapping||e.wrapT!==ClampToEdgeWrapping||e.minFilter!==NearestFilter&&e.minFilter!==LinearFilter)}(n)&&!1===y(n.image),c=g(n.image,l,!1,h),u=y(c)||s,d=a.convert(n.format);let p,f=a.convert(n.type),m=_(n.internalFormat,d,f);L(o,n,u);const x=n.mipmaps;if(n.isDepthTexture)m=6402,s?m=n.type===FloatType?36012:n.type===UnsignedIntType?33190:n.type===UnsignedInt248Type?35056:33189:n.type===FloatType&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),n.format===DepthFormat&&6402===m&&n.type!==UnsignedShortType&&n.type!==UnsignedIntType&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),n.type=UnsignedShortType,f=a.convert(n.type)),n.format===DepthStencilFormat&&6402===m&&(m=34041,n.type!==UnsignedInt248Type&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),n.type=UnsignedInt248Type,f=a.convert(n.type))),r.texImage2D(3553,0,m,c.width,c.height,0,d,f,null);else if(n.isDataTexture)if(x.length>0&&u){for(let e=0,t=x.length;e<t;e++)p=x[e],r.texImage2D(3553,e,m,p.width,p.height,0,d,f,p.data);n.generateMipmaps=!1,t.__maxMipLevel=x.length-1}else r.texImage2D(3553,0,m,c.width,c.height,0,d,f,c.data),t.__maxMipLevel=0;else if(n.isCompressedTexture){for(let e=0,t=x.length;e<t;e++)p=x[e],n.format!==RGBAFormat&&n.format!==RGBFormat?null!==d?r.compressedTexImage2D(3553,e,m,p.width,p.height,0,p.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):r.texImage2D(3553,e,m,p.width,p.height,0,d,f,p.data);t.__maxMipLevel=x.length-1}else if(n.isDataTexture2DArray)r.texImage3D(35866,0,m,c.width,c.height,c.depth,0,d,f,c.data),t.__maxMipLevel=0;else if(n.isDataTexture3D)r.texImage3D(32879,0,m,c.width,c.height,c.depth,0,d,f,c.data),t.__maxMipLevel=0;else if(x.length>0&&u){for(let e=0,t=x.length;e<t;e++)p=x[e],r.texImage2D(3553,e,m,d,f,p);n.generateMipmaps=!1,t.__maxMipLevel=x.length-1}else r.texImage2D(3553,0,m,d,f,c),t.__maxMipLevel=0;v(n,u)&&b(o,n,c.width,c.height),t.__version=n.version,n.onUpdate&&n.onUpdate(n)}function P(t,i,o,s){const l=i.texture,c=a.convert(l.format),h=a.convert(l.type),u=_(l.internalFormat,c,h);32879===s||35866===s?r.texImage3D(s,0,u,i.width,i.height,i.depth,0,c,h,null):r.texImage2D(s,0,u,i.width,i.height,0,c,h,null),e.bindFramebuffer(36160,t),e.framebufferTexture2D(36160,o,s,n.get(l).__webglTexture,0),e.bindFramebuffer(36160,null)}function O(t,r,n){if(e.bindRenderbuffer(36161,t),r.depthBuffer&&!r.stencilBuffer){let i=33189;if(n){const t=r.depthTexture;t&&t.isDepthTexture&&(t.type===FloatType?i=36012:t.type===UnsignedIntType&&(i=33190));const n=k(r);e.renderbufferStorageMultisample(36161,n,i,r.width,r.height)}else e.renderbufferStorage(36161,i,r.width,r.height);e.framebufferRenderbuffer(36160,36096,36161,t)}else if(r.depthBuffer&&r.stencilBuffer){if(n){const t=k(r);e.renderbufferStorageMultisample(36161,t,35056,r.width,r.height)}else e.renderbufferStorage(36161,34041,r.width,r.height);e.framebufferRenderbuffer(36160,33306,36161,t)}else{const t=r.texture,i=a.convert(t.format),o=a.convert(t.type),s=_(t.internalFormat,i,o);if(n){const t=k(r);e.renderbufferStorageMultisample(36161,t,s,r.width,r.height)}else e.renderbufferStorage(36161,s,r.width,r.height)}e.bindRenderbuffer(36161,null)}function I(t){const r=n.get(t),i=!0===t.isWebGLCubeRenderTarget;if(t.depthTexture){if(i)throw new Error("target.depthTexture not supported in Cube render targets");!function(t,r){if(r&&r.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(e.bindFramebuffer(36160,t),!r.depthTexture||!r.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");n.get(r.depthTexture).__webglTexture&&r.depthTexture.image.width===r.width&&r.depthTexture.image.height===r.height||(r.depthTexture.image.width=r.width,r.depthTexture.image.height=r.height,r.depthTexture.needsUpdate=!0),T(r.depthTexture,0);const i=n.get(r.depthTexture).__webglTexture;if(r.depthTexture.format===DepthFormat)e.framebufferTexture2D(36160,36096,3553,i,0);else{if(r.depthTexture.format!==DepthStencilFormat)throw new Error("Unknown depthTexture format");e.framebufferTexture2D(36160,33306,3553,i,0)}}(r.__webglFramebuffer,t)}else if(i){r.__webglDepthbuffer=[];for(let n=0;n<6;n++)e.bindFramebuffer(36160,r.__webglFramebuffer[n]),r.__webglDepthbuffer[n]=e.createRenderbuffer(),O(r.__webglDepthbuffer[n],t,!1)}else e.bindFramebuffer(36160,r.__webglFramebuffer),r.__webglDepthbuffer=e.createRenderbuffer(),O(r.__webglDepthbuffer,t,!1);e.bindFramebuffer(36160,null)}function k(e){return s&&e.isWebGLMultisampleRenderTarget?Math.min(u,e.samples):0}let B=!1,N=!1;this.allocateTextureUnit=function(){const e=M;return e>=l&&console.warn("THREE.WebGLTextures: Trying to use "+e+" texture units while this GPU supports only "+l),M+=1,e},this.resetTextureUnits=function(){M=0},this.setTexture2D=T,this.setTexture2DArray=function(e,t){const i=n.get(e);e.version>0&&i.__version!==e.version?R(i,e,t):(r.activeTexture(33984+t),r.bindTexture(35866,i.__webglTexture))},this.setTexture3D=function(e,t){const i=n.get(e);e.version>0&&i.__version!==e.version?R(i,e,t):(r.activeTexture(33984+t),r.bindTexture(32879,i.__webglTexture))},this.setTextureCube=A,this.setupRenderTarget=function(t){const i=t.texture,l=n.get(t),c=n.get(i);t.addEventListener("dispose",S),c.__webglTexture=e.createTexture(),o.memory.textures++;const h=!0===t.isWebGLCubeRenderTarget,u=!0===t.isWebGLMultisampleRenderTarget,d=i.isDataTexture3D||i.isDataTexture2DArray,p=y(t)||s;if(!s||i.format!==RGBFormat||i.type!==FloatType&&i.type!==HalfFloatType||(i.format=RGBAFormat,console.warn("THREE.WebGLRenderer: Rendering to textures with RGB format is not supported. Using RGBA format instead.")),h){l.__webglFramebuffer=[];for(let t=0;t<6;t++)l.__webglFramebuffer[t]=e.createFramebuffer()}else if(l.__webglFramebuffer=e.createFramebuffer(),u)if(s){l.__webglMultisampledFramebuffer=e.createFramebuffer(),l.__webglColorRenderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(36161,l.__webglColorRenderbuffer);const r=a.convert(i.format),n=a.convert(i.type),o=_(i.internalFormat,r,n),s=k(t);e.renderbufferStorageMultisample(36161,s,o,t.width,t.height),e.bindFramebuffer(36160,l.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(36160,36064,36161,l.__webglColorRenderbuffer),e.bindRenderbuffer(36161,null),t.depthBuffer&&(l.__webglDepthRenderbuffer=e.createRenderbuffer(),O(l.__webglDepthRenderbuffer,t,!0)),e.bindFramebuffer(36160,null)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.");if(h){r.bindTexture(34067,c.__webglTexture),L(34067,i,p);for(let e=0;e<6;e++)P(l.__webglFramebuffer[e],t,36064,34069+e);v(i,p)&&b(34067,i,t.width,t.height),r.bindTexture(34067,null)}else{let e=3553;if(d)if(s){e=i.isDataTexture3D?32879:35866}else console.warn("THREE.DataTexture3D and THREE.DataTexture2DArray only supported with WebGL2.");r.bindTexture(e,c.__webglTexture),L(e,i,p),P(l.__webglFramebuffer,t,36064,e),v(i,p)&&b(3553,i,t.width,t.height),r.bindTexture(3553,null)}t.depthBuffer&&I(t)},this.updateRenderTargetMipmap=function(e){const t=e.texture;if(v(t,y(e)||s)){const i=e.isWebGLCubeRenderTarget?34067:3553,a=n.get(t).__webglTexture;r.bindTexture(i,a),b(i,t,e.width,e.height),r.bindTexture(i,null)}},this.updateMultisampleRenderTarget=function(t){if(t.isWebGLMultisampleRenderTarget)if(s){const r=n.get(t);e.bindFramebuffer(36008,r.__webglMultisampledFramebuffer),e.bindFramebuffer(36009,r.__webglFramebuffer);const i=t.width,a=t.height;let o=16384;t.depthBuffer&&(o|=256),t.stencilBuffer&&(o|=1024),e.blitFramebuffer(0,0,i,a,0,0,i,a,o,9728),e.bindFramebuffer(36160,r.__webglMultisampledFramebuffer)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.")},this.safeSetTexture2D=function(e,t){e&&e.isWebGLRenderTarget&&(!1===B&&(console.warn("THREE.WebGLTextures.safeSetTexture2D: don't use render targets as textures. Use their .texture property instead."),B=!0),e=e.texture),T(e,t)},this.safeSetTextureCube=function(e,t){e&&e.isWebGLCubeRenderTarget&&(!1===N&&(console.warn("THREE.WebGLTextures.safeSetTextureCube: don't use cube render targets as textures. Use their .texture property instead."),N=!0),e=e.texture),A(e,t)}}function WebGLUtils(e,t,r){const n=r.isWebGL2;return{convert:function(e){let r;if(e===UnsignedByteType)return 5121;if(e===UnsignedShort4444Type)return 32819;if(e===UnsignedShort5551Type)return 32820;if(e===UnsignedShort565Type)return 33635;if(e===ByteType)return 5120;if(e===ShortType)return 5122;if(e===UnsignedShortType)return 5123;if(e===IntType)return 5124;if(e===UnsignedIntType)return 5125;if(e===FloatType)return 5126;if(e===HalfFloatType)return n?5131:(r=t.get("OES_texture_half_float"),null!==r?r.HALF_FLOAT_OES:null);if(e===AlphaFormat)return 6406;if(e===RGBFormat)return 6407;if(e===RGBAFormat)return 6408;if(e===LuminanceFormat)return 6409;if(e===LuminanceAlphaFormat)return 6410;if(e===DepthFormat)return 6402;if(e===DepthStencilFormat)return 34041;if(e===RedFormat)return 6403;if(e===RedIntegerFormat)return 36244;if(e===RGFormat)return 33319;if(e===RGIntegerFormat)return 33320;if(e===RGBIntegerFormat)return 36248;if(e===RGBAIntegerFormat)return 36249;if(e===RGB_S3TC_DXT1_Format||e===RGBA_S3TC_DXT1_Format||e===RGBA_S3TC_DXT3_Format||e===RGBA_S3TC_DXT5_Format){if(r=t.get("WEBGL_compressed_texture_s3tc"),null===r)return null;if(e===RGB_S3TC_DXT1_Format)return r.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===RGBA_S3TC_DXT1_Format)return r.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===RGBA_S3TC_DXT3_Format)return r.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===RGBA_S3TC_DXT5_Format)return r.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(e===RGB_PVRTC_4BPPV1_Format||e===RGB_PVRTC_2BPPV1_Format||e===RGBA_PVRTC_4BPPV1_Format||e===RGBA_PVRTC_2BPPV1_Format){if(r=t.get("WEBGL_compressed_texture_pvrtc"),null===r)return null;if(e===RGB_PVRTC_4BPPV1_Format)return r.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===RGB_PVRTC_2BPPV1_Format)return r.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===RGBA_PVRTC_4BPPV1_Format)return r.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===RGBA_PVRTC_2BPPV1_Format)return r.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(e===RGB_ETC1_Format)return r=t.get("WEBGL_compressed_texture_etc1"),null!==r?r.COMPRESSED_RGB_ETC1_WEBGL:null;if((e===RGB_ETC2_Format||e===RGBA_ETC2_EAC_Format)&&(r=t.get("WEBGL_compressed_texture_etc"),null!==r)){if(e===RGB_ETC2_Format)return r.COMPRESSED_RGB8_ETC2;if(e===RGBA_ETC2_EAC_Format)return r.COMPRESSED_RGBA8_ETC2_EAC}return e===RGBA_ASTC_4x4_Format||e===RGBA_ASTC_5x4_Format||e===RGBA_ASTC_5x5_Format||e===RGBA_ASTC_6x5_Format||e===RGBA_ASTC_6x6_Format||e===RGBA_ASTC_8x5_Format||e===RGBA_ASTC_8x6_Format||e===RGBA_ASTC_8x8_Format||e===RGBA_ASTC_10x5_Format||e===RGBA_ASTC_10x6_Format||e===RGBA_ASTC_10x8_Format||e===RGBA_ASTC_10x10_Format||e===RGBA_ASTC_12x10_Format||e===RGBA_ASTC_12x12_Format||e===SRGB8_ALPHA8_ASTC_4x4_Format||e===SRGB8_ALPHA8_ASTC_5x4_Format||e===SRGB8_ALPHA8_ASTC_5x5_Format||e===SRGB8_ALPHA8_ASTC_6x5_Format||e===SRGB8_ALPHA8_ASTC_6x6_Format||e===SRGB8_ALPHA8_ASTC_8x5_Format||e===SRGB8_ALPHA8_ASTC_8x6_Format||e===SRGB8_ALPHA8_ASTC_8x8_Format||e===SRGB8_ALPHA8_ASTC_10x5_Format||e===SRGB8_ALPHA8_ASTC_10x6_Format||e===SRGB8_ALPHA8_ASTC_10x8_Format||e===SRGB8_ALPHA8_ASTC_10x10_Format||e===SRGB8_ALPHA8_ASTC_12x10_Format||e===SRGB8_ALPHA8_ASTC_12x12_Format?(r=t.get("WEBGL_compressed_texture_astc"),null!==r?e:null):e===RGBA_BPTC_Format?(r=t.get("EXT_texture_compression_bptc"),null!==r?e:null):e===UnsignedInt248Type?n?34042:(r=t.get("WEBGL_depth_texture"),null!==r?r.UNSIGNED_INT_24_8_WEBGL:null):void 0}}}function ArrayCamera(e=[]){PerspectiveCamera.call(this),this.cameras=e}ArrayCamera.prototype=Object.assign(Object.create(PerspectiveCamera.prototype),{constructor:ArrayCamera,isArrayCamera:!0});class Group extends Object3D{constructor(){super(),this.type="Group"}}function WebXRController(){this._targetRay=null,this._grip=null,this._hand=null}function WebXRManager(e,t){const r=this;let n=null,i=1,a=null,o="local-floor",s=null;const l=[],c=new Map,h=new PerspectiveCamera;h.layers.enable(1),h.viewport=new Vector4;const u=new PerspectiveCamera;u.layers.enable(2),u.viewport=new Vector4;const d=[h,u],p=new ArrayCamera;p.layers.enable(1),p.layers.enable(2);let f=null,m=null;function g(e){const t=c.get(e.inputSource);t&&t.dispatchEvent({type:e.type,data:e.inputSource})}function y(){c.forEach((function(e,t){e.disconnect(t)})),c.clear(),f=null,m=null,e.setFramebuffer(null),e.setRenderTarget(e.getRenderTarget()),S.stop(),r.isPresenting=!1,r.dispatchEvent({type:"sessionend"})}function v(e){const t=n.inputSources;for(let e=0;e<l.length;e++)c.set(t[e],l[e]);for(let t=0;t<e.removed.length;t++){const r=e.removed[t],n=c.get(r);n&&(n.dispatchEvent({type:"disconnected",data:r}),c.delete(r))}for(let t=0;t<e.added.length;t++){const r=e.added[t],n=c.get(r);n&&n.dispatchEvent({type:"connected",data:r})}}this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let t=l[e];return void 0===t&&(t=new WebXRController,l[e]=t),t.getTargetRaySpace()},this.getControllerGrip=function(e){let t=l[e];return void 0===t&&(t=new WebXRController,l[e]=t),t.getGripSpace()},this.getHand=function(e){let t=l[e];return void 0===t&&(t=new WebXRController,l[e]=t),t.getHandSpace()},this.setFramebufferScaleFactor=function(e){i=e,!0===r.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(e){o=e,!0===r.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return a},this.getSession=function(){return n},this.setSession=async function(e){if(n=e,null!==n){n.addEventListener("select",g),n.addEventListener("selectstart",g),n.addEventListener("selectend",g),n.addEventListener("squeeze",g),n.addEventListener("squeezestart",g),n.addEventListener("squeezeend",g),n.addEventListener("end",y),n.addEventListener("inputsourceschange",v);const e=t.getContextAttributes();!0!==e.xrCompatible&&await t.makeXRCompatible();const s={antialias:e.antialias,alpha:e.alpha,depth:e.depth,stencil:e.stencil,framebufferScaleFactor:i},l=new XRWebGLLayer(n,t,s);n.updateRenderState({baseLayer:l}),a=await n.requestReferenceSpace(o),S.setContext(n),S.start(),r.isPresenting=!0,r.dispatchEvent({type:"sessionstart"})}};const b=new Vector3,_=new Vector3;function x(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}this.getCamera=function(e){p.near=u.near=h.near=e.near,p.far=u.far=h.far=e.far,f===p.near&&m===p.far||(n.updateRenderState({depthNear:p.near,depthFar:p.far}),f=p.near,m=p.far);const t=e.parent,r=p.cameras;x(p,t);for(let e=0;e<r.length;e++)x(r[e],t);e.matrixWorld.copy(p.matrixWorld),e.matrix.copy(p.matrix),e.matrix.decompose(e.position,e.quaternion,e.scale);const i=e.children;for(let e=0,t=i.length;e<t;e++)i[e].updateMatrixWorld(!0);return 2===r.length?function(e,t,r){b.setFromMatrixPosition(t.matrixWorld),_.setFromMatrixPosition(r.matrixWorld);const n=b.distanceTo(_),i=t.projectionMatrix.elements,a=r.projectionMatrix.elements,o=i[14]/(i[10]-1),s=i[14]/(i[10]+1),l=(i[9]+1)/i[5],c=(i[9]-1)/i[5],h=(i[8]-1)/i[0],u=(a[8]+1)/a[0],d=o*h,p=o*u,f=n/(-h+u),m=f*-h;t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(m),e.translateZ(f),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert();const g=o+f,y=s+f,v=d-m,x=p+(n-m),w=l*s/y*g,S=c*s/y*g;e.projectionMatrix.makePerspective(v,x,w,S,g,y)}(p,h,u):p.projectionMatrix.copy(h.projectionMatrix),p};let w=null;const S=new WebGLAnimation;S.setAnimationLoop((function(t,r){if(s=r.getViewerPose(a),null!==s){const t=s.views,r=n.renderState.baseLayer;e.setFramebuffer(r.framebuffer);let i=!1;t.length!==p.cameras.length&&(p.cameras.length=0,i=!0);for(let e=0;e<t.length;e++){const n=t[e],a=r.getViewport(n),o=d[e];o.matrix.fromArray(n.transform.matrix),o.projectionMatrix.fromArray(n.projectionMatrix),o.viewport.set(a.x,a.y,a.width,a.height),0===e&&p.matrix.copy(o.matrix),!0===i&&p.cameras.push(o)}}const i=n.inputSources;for(let e=0;e<l.length;e++){const t=l[e],n=i[e];t.update(n,r,a)}w&&w(t,r)})),this.setAnimationLoop=function(e){w=e},this.dispose=function(){}}function WebGLMaterials(e){function t(t,r){t.opacity.value=r.opacity,r.color&&t.diffuse.value.copy(r.color),r.emissive&&t.emissive.value.copy(r.emissive).multiplyScalar(r.emissiveIntensity),r.map&&(t.map.value=r.map),r.alphaMap&&(t.alphaMap.value=r.alphaMap),r.specularMap&&(t.specularMap.value=r.specularMap);const n=e.get(r).envMap;if(n){t.envMap.value=n,t.flipEnvMap.value=n.isCubeTexture&&n._needsFlipEnvMap?-1:1,t.reflectivity.value=r.reflectivity,t.refractionRatio.value=r.refractionRatio;const i=e.get(n).__maxMipLevel;void 0!==i&&(t.maxMipLevel.value=i)}let i,a;r.lightMap&&(t.lightMap.value=r.lightMap,t.lightMapIntensity.value=r.lightMapIntensity),r.aoMap&&(t.aoMap.value=r.aoMap,t.aoMapIntensity.value=r.aoMapIntensity),r.map?i=r.map:r.specularMap?i=r.specularMap:r.displacementMap?i=r.displacementMap:r.normalMap?i=r.normalMap:r.bumpMap?i=r.bumpMap:r.roughnessMap?i=r.roughnessMap:r.metalnessMap?i=r.metalnessMap:r.alphaMap?i=r.alphaMap:r.emissiveMap?i=r.emissiveMap:r.clearcoatMap?i=r.clearcoatMap:r.clearcoatNormalMap?i=r.clearcoatNormalMap:r.clearcoatRoughnessMap&&(i=r.clearcoatRoughnessMap),void 0!==i&&(i.isWebGLRenderTarget&&(i=i.texture),!0===i.matrixAutoUpdate&&i.updateMatrix(),t.uvTransform.value.copy(i.matrix)),r.aoMap?a=r.aoMap:r.lightMap&&(a=r.lightMap),void 0!==a&&(a.isWebGLRenderTarget&&(a=a.texture),!0===a.matrixAutoUpdate&&a.updateMatrix(),t.uv2Transform.value.copy(a.matrix))}function r(t,r){t.roughness.value=r.roughness,t.metalness.value=r.metalness,r.roughnessMap&&(t.roughnessMap.value=r.roughnessMap),r.metalnessMap&&(t.metalnessMap.value=r.metalnessMap),r.emissiveMap&&(t.emissiveMap.value=r.emissiveMap),r.bumpMap&&(t.bumpMap.value=r.bumpMap,t.bumpScale.value=r.bumpScale,r.side===BackSide&&(t.bumpScale.value*=-1)),r.normalMap&&(t.normalMap.value=r.normalMap,t.normalScale.value.copy(r.normalScale),r.side===BackSide&&t.normalScale.value.negate()),r.displacementMap&&(t.displacementMap.value=r.displacementMap,t.displacementScale.value=r.displacementScale,t.displacementBias.value=r.displacementBias);e.get(r).envMap&&(t.envMapIntensity.value=r.envMapIntensity)}return{refreshFogUniforms:function(e,t){e.fogColor.value.copy(t.color),t.isFog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t.isFogExp2&&(e.fogDensity.value=t.density)},refreshMaterialUniforms:function(e,n,i,a){n.isMeshBasicMaterial?t(e,n):n.isMeshLambertMaterial?(t(e,n),function(e,t){t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap)}(e,n)):n.isMeshToonMaterial?(t(e,n),function(e,t){t.gradientMap&&(e.gradientMap.value=t.gradientMap);t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap);t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,t.side===BackSide&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),t.side===BackSide&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshPhongMaterial?(t(e,n),function(e,t){e.specular.value.copy(t.specular),e.shininess.value=Math.max(t.shininess,1e-4),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap);t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,t.side===BackSide&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),t.side===BackSide&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshStandardMaterial?(t(e,n),n.isMeshPhysicalMaterial?function(e,t){r(e,t),e.reflectivity.value=t.reflectivity,e.clearcoat.value=t.clearcoat,e.clearcoatRoughness.value=t.clearcoatRoughness,t.sheen&&e.sheen.value.copy(t.sheen);t.clearcoatMap&&(e.clearcoatMap.value=t.clearcoatMap);t.clearcoatRoughnessMap&&(e.clearcoatRoughnessMap.value=t.clearcoatRoughnessMap);t.clearcoatNormalMap&&(e.clearcoatNormalScale.value.copy(t.clearcoatNormalScale),e.clearcoatNormalMap.value=t.clearcoatNormalMap,t.side===BackSide&&e.clearcoatNormalScale.value.negate());e.transmission.value=t.transmission,t.transmissionMap&&(e.transmissionMap.value=t.transmissionMap)}(e,n):r(e,n)):n.isMeshMatcapMaterial?(t(e,n),function(e,t){t.matcap&&(e.matcap.value=t.matcap);t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,t.side===BackSide&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),t.side===BackSide&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshDepthMaterial?(t(e,n),function(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshDistanceMaterial?(t(e,n),function(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias);e.referencePosition.value.copy(t.referencePosition),e.nearDistance.value=t.nearDistance,e.farDistance.value=t.farDistance}(e,n)):n.isMeshNormalMaterial?(t(e,n),function(e,t){t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,t.side===BackSide&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),t.side===BackSide&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isLineBasicMaterial?(function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity}(e,n),n.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(e,n)):n.isPointsMaterial?function(e,t,r,n){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.size.value=t.size*r,e.scale.value=.5*n,t.map&&(e.map.value=t.map);t.alphaMap&&(e.alphaMap.value=t.alphaMap);let i;t.map?i=t.map:t.alphaMap&&(i=t.alphaMap);void 0!==i&&(!0===i.matrixAutoUpdate&&i.updateMatrix(),e.uvTransform.value.copy(i.matrix))}(e,n,i,a):n.isSpriteMaterial?function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.rotation.value=t.rotation,t.map&&(e.map.value=t.map);t.alphaMap&&(e.alphaMap.value=t.alphaMap);let r;t.map?r=t.map:t.alphaMap&&(r=t.alphaMap);void 0!==r&&(!0===r.matrixAutoUpdate&&r.updateMatrix(),e.uvTransform.value.copy(r.matrix))}(e,n):n.isShadowMaterial?(e.color.value.copy(n.color),e.opacity.value=n.opacity):n.isShaderMaterial&&(n.uniformsNeedUpdate=!1)}}}function createCanvasElement(){const e=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return e.style.display="block",e}function WebGLRenderer(e){const t=void 0!==(e=e||{}).canvas?e.canvas:createCanvasElement(),r=void 0!==e.context?e.context:null,n=void 0!==e.alpha&&e.alpha,i=void 0===e.depth||e.depth,a=void 0===e.stencil||e.stencil,o=void 0!==e.antialias&&e.antialias,s=void 0===e.premultipliedAlpha||e.premultipliedAlpha,l=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,c=void 0!==e.powerPreference?e.powerPreference:"default",h=void 0!==e.failIfMajorPerformanceCaveat&&e.failIfMajorPerformanceCaveat;let u=null,d=null;const p=[],f=[];this.domElement=t,this.debug={checkShaderErrors:!0},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.outputEncoding=LinearEncoding,this.physicallyCorrectLights=!1,this.toneMapping=NoToneMapping,this.toneMappingExposure=1,this.maxMorphTargets=8,this.maxMorphNormals=4;const m=this;let g=!1,y=null,v=0,b=0,_=null,x=null,w=-1,S=null;const M=new Vector4,T=new Vector4;let A=null,E=t.width,C=t.height,L=1,D=null,R=null;const P=new Vector4(0,0,E,C),O=new Vector4(0,0,E,C);let I=!1;const k=new Frustum;let B=!1,N=!1;const F=new Matrix4,U=new Vector3,z={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function H(){return null===_?L:1}let G,V,j,W,Y,X,$,Z,q,J,Q,K,ee,te,re,ne,ie,ae,oe,se,le,ce=r;function he(e,r){for(let n=0;n<e.length;n++){const i=e[n],a=t.getContext(i,r);if(null!==a)return a}return null}try{const e={alpha:n,depth:i,stencil:a,antialias:o,premultipliedAlpha:s,preserveDrawingBuffer:l,powerPreference:c,failIfMajorPerformanceCaveat:h};if(t.addEventListener("webglcontextlost",fe,!1),t.addEventListener("webglcontextrestored",me,!1),null===ce){const t=["webgl2","webgl","experimental-webgl"];if(!0===m.isWebGL1Renderer&&t.shift(),ce=he(t,e),null===ce)throw he(t)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}void 0===ce.getShaderPrecisionFormat&&(ce.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(e){throw console.error("THREE.WebGLRenderer: "+e.message),e}function ue(){G=new WebGLExtensions(ce),V=new WebGLCapabilities(ce,G,e),G.init(V),se=new WebGLUtils(ce,G,V),j=new WebGLState(ce,G,V),j.scissor(T.copy(O).multiplyScalar(L).floor()),j.viewport(M.copy(P).multiplyScalar(L).floor()),W=new WebGLInfo(ce),Y=new WebGLProperties,X=new WebGLTextures(ce,G,j,Y,V,se,W),$=new WebGLCubeMaps(m),Z=new WebGLAttributes(ce,V),le=new WebGLBindingStates(ce,G,Z,V),q=new WebGLGeometries(ce,Z,W,le),J=new WebGLObjects(ce,q,Z,W),ie=new WebGLMorphtargets(ce),re=new WebGLClipping(Y),Q=new WebGLPrograms(m,$,G,V,le,re),K=new WebGLMaterials(Y),ee=new WebGLRenderLists(Y),te=new WebGLRenderStates(G,V),ne=new WebGLBackground(m,$,j,J,s),ae=new WebGLBufferRenderer(ce,G,W,V),oe=new WebGLIndexedBufferRenderer(ce,G,W,V),W.programs=Q.programs,m.capabilities=V,m.extensions=G,m.properties=Y,m.renderLists=ee,m.state=j,m.info=W}ue();const de=new WebXRManager(m,ce);this.xr=de;const pe=new WebGLShadowMap(m,J,V.maxTextureSize);function fe(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),g=!0}function me(){console.log("THREE.WebGLRenderer: Context Restored."),g=!1,ue()}function ge(e){const t=e.target;t.removeEventListener("dispose",ge),function(e){ye(e),Y.remove(e)}(t)}function ye(e){const t=Y.get(e).program;void 0!==t&&Q.releaseProgram(t)}this.shadowMap=pe,this.getContext=function(){return ce},this.getContextAttributes=function(){return ce.getContextAttributes()},this.forceContextLoss=function(){const e=G.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){const e=G.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return L},this.setPixelRatio=function(e){void 0!==e&&(L=e,this.setSize(E,C,!1))},this.getSize=function(e){return void 0===e&&(console.warn("WebGLRenderer: .getsize() now requires a Vector2 as an argument"),e=new Vector2),e.set(E,C)},this.setSize=function(e,r,n){de.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(E=e,C=r,t.width=Math.floor(e*L),t.height=Math.floor(r*L),!1!==n&&(t.style.width=e+"px",t.style.height=r+"px"),this.setViewport(0,0,e,r))},this.getDrawingBufferSize=function(e){return void 0===e&&(console.warn("WebGLRenderer: .getdrawingBufferSize() now requires a Vector2 as an argument"),e=new Vector2),e.set(E*L,C*L).floor()},this.setDrawingBufferSize=function(e,r,n){E=e,C=r,L=n,t.width=Math.floor(e*n),t.height=Math.floor(r*n),this.setViewport(0,0,e,r)},this.getCurrentViewport=function(e){return void 0===e&&(console.warn("WebGLRenderer: .getCurrentViewport() now requires a Vector4 as an argument"),e=new Vector4),e.copy(M)},this.getViewport=function(e){return e.copy(P)},this.setViewport=function(e,t,r,n){e.isVector4?P.set(e.x,e.y,e.z,e.w):P.set(e,t,r,n),j.viewport(M.copy(P).multiplyScalar(L).floor())},this.getScissor=function(e){return e.copy(O)},this.setScissor=function(e,t,r,n){e.isVector4?O.set(e.x,e.y,e.z,e.w):O.set(e,t,r,n),j.scissor(T.copy(O).multiplyScalar(L).floor())},this.getScissorTest=function(){return I},this.setScissorTest=function(e){j.setScissorTest(I=e)},this.setOpaqueSort=function(e){D=e},this.setTransparentSort=function(e){R=e},this.getClearColor=function(e){return void 0===e&&(console.warn("WebGLRenderer: .getClearColor() now requires a Color as an argument"),e=new Color),e.copy(ne.getClearColor())},this.setClearColor=function(){ne.setClearColor.apply(ne,arguments)},this.getClearAlpha=function(){return ne.getClearAlpha()},this.setClearAlpha=function(){ne.setClearAlpha.apply(ne,arguments)},this.clear=function(e,t,r){let n=0;(void 0===e||e)&&(n|=16384),(void 0===t||t)&&(n|=256),(void 0===r||r)&&(n|=1024),ce.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",fe,!1),t.removeEventListener("webglcontextrestored",me,!1),ee.dispose(),te.dispose(),Y.dispose(),$.dispose(),J.dispose(),le.dispose(),de.dispose(),be.stop()},this.renderBufferImmediate=function(e,t){le.initAttributes();const r=Y.get(e);e.hasPositions&&!r.position&&(r.position=ce.createBuffer()),e.hasNormals&&!r.normal&&(r.normal=ce.createBuffer()),e.hasUvs&&!r.uv&&(r.uv=ce.createBuffer()),e.hasColors&&!r.color&&(r.color=ce.createBuffer());const n=t.getAttributes();e.hasPositions&&(ce.bindBuffer(34962,r.position),ce.bufferData(34962,e.positionArray,35048),le.enableAttribute(n.position),ce.vertexAttribPointer(n.position,3,5126,!1,0,0)),e.hasNormals&&(ce.bindBuffer(34962,r.normal),ce.bufferData(34962,e.normalArray,35048),le.enableAttribute(n.normal),ce.vertexAttribPointer(n.normal,3,5126,!1,0,0)),e.hasUvs&&(ce.bindBuffer(34962,r.uv),ce.bufferData(34962,e.uvArray,35048),le.enableAttribute(n.uv),ce.vertexAttribPointer(n.uv,2,5126,!1,0,0)),e.hasColors&&(ce.bindBuffer(34962,r.color),ce.bufferData(34962,e.colorArray,35048),le.enableAttribute(n.color),ce.vertexAttribPointer(n.color,3,5126,!1,0,0)),le.disableUnusedAttributes(),ce.drawArrays(4,0,e.count),e.count=0},this.renderBufferDirect=function(e,t,r,n,i,a){null===t&&(t=z);const o=i.isMesh&&i.matrixWorld.determinant()<0,s=Me(e,t,n,i);j.setMaterial(n,o);let l=r.index;const c=r.attributes.position;if(null===l){if(void 0===c||0===c.count)return}else if(0===l.count)return;let h,u=1;!0===n.wireframe&&(l=q.getWireframeAttribute(r),u=2),(n.morphTargets||n.morphNormals)&&ie.update(i,r,n,s),le.setup(i,n,s,r,l);let d=ae;null!==l&&(h=Z.get(l),d=oe,d.setIndex(h));const p=null!==l?l.count:c.count,f=r.drawRange.start*u,m=r.drawRange.count*u,g=null!==a?a.start*u:0,y=null!==a?a.count*u:1/0,v=Math.max(f,g),b=Math.min(p,f+m,g+y)-1,_=Math.max(0,b-v+1);if(0!==_){if(i.isMesh)!0===n.wireframe?(j.setLineWidth(n.wireframeLinewidth*H()),d.setMode(1)):d.setMode(4);else if(i.isLine){let e=n.linewidth;void 0===e&&(e=1),j.setLineWidth(e*H()),i.isLineSegments?d.setMode(1):i.isLineLoop?d.setMode(2):d.setMode(3)}else i.isPoints?d.setMode(0):i.isSprite&&d.setMode(4);if(i.isInstancedMesh)d.renderInstances(v,_,i.count);else if(r.isInstancedBufferGeometry){const e=Math.min(r.instanceCount,r._maxInstanceCount);d.renderInstances(v,_,e)}else d.render(v,_)}},this.compile=function(e,t){d=te.get(e),d.init(),e.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&(d.pushLight(e),e.castShadow&&d.pushShadow(e))})),d.setupLights();const r=new WeakMap;e.traverse((function(t){const n=t.material;if(n)if(Array.isArray(n))for(let i=0;i<n.length;i++){const a=n[i];!1===r.has(a)&&(Se(a,e,t),r.set(a))}else!1===r.has(n)&&(Se(n,e,t),r.set(n))}))};let ve=null;const be=new WebGLAnimation;function _e(e,t,r,n){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)r=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)d.pushLight(e),e.castShadow&&d.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||k.intersectsSprite(e)){n&&U.setFromMatrixPosition(e.matrixWorld).applyMatrix4(F);const t=J.update(e),i=e.material;i.visible&&u.push(e,t,i,r,U.z,null)}}else if(e.isImmediateRenderObject)n&&U.setFromMatrixPosition(e.matrixWorld).applyMatrix4(F),u.push(e,null,e.material,r,U.z,null);else if((e.isMesh||e.isLine||e.isPoints)&&(e.isSkinnedMesh&&e.skeleton.frame!==W.render.frame&&(e.skeleton.update(),e.skeleton.frame=W.render.frame),!e.frustumCulled||k.intersectsObject(e))){n&&U.setFromMatrixPosition(e.matrixWorld).applyMatrix4(F);const t=J.update(e),i=e.material;if(Array.isArray(i)){const n=t.groups;for(let a=0,o=n.length;a<o;a++){const o=n[a],s=i[o.materialIndex];s&&s.visible&&u.push(e,t,s,r,U.z,o)}}else i.visible&&u.push(e,t,i,r,U.z,null)}const i=e.children;for(let e=0,a=i.length;e<a;e++)_e(i[e],t,r,n)}function xe(e,t,r){const n=!0===t.isScene?t.overrideMaterial:null;for(let i=0,a=e.length;i<a;i++){const a=e[i],o=a.object,s=a.geometry,l=null===n?a.material:n,c=a.group;if(r.isArrayCamera){const e=r.cameras;for(let r=0,n=e.length;r<n;r++){const n=e[r];o.layers.test(n.layers)&&(j.viewport(M.copy(n.viewport)),d.setupLightsView(n),we(o,t,n,s,l,c))}}else we(o,t,r,s,l,c)}}function we(e,t,r,n,i,a){if(e.onBeforeRender(m,t,r,n,i,a),e.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),e.isImmediateRenderObject){const n=Me(r,t,i,e);j.setMaterial(i),le.reset(),function(e,t){e.render((function(e){m.renderBufferImmediate(e,t)}))}(e,n)}else m.renderBufferDirect(r,t,n,i,e,a);e.onAfterRender(m,t,r,n,i,a)}function Se(e,t,r){!0!==t.isScene&&(t=z);const n=Y.get(e),i=d.state.lights,a=d.state.shadowsArray,o=i.state.version,s=Q.getParameters(e,i.state,a,t,r),l=Q.getProgramCacheKey(s);let c=n.program,h=!0;if(n.environment=e.isMeshStandardMaterial?t.environment:null,n.fog=t.fog,n.envMap=$.get(e.envMap||n.environment),void 0===c)e.addEventListener("dispose",ge);else if(c.cacheKey!==l)ye(e);else if(n.lightsStateVersion!==o)h=!1;else{if(void 0!==s.shaderID)return;h=!1}h&&(s.uniforms=Q.getUniforms(e),e.onBeforeCompile(s,m),c=Q.acquireProgram(s,l),n.program=c,n.uniforms=s.uniforms,n.outputEncoding=s.outputEncoding);const u=n.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(n.numClippingPlanes=re.numPlanes,n.numIntersection=re.numIntersection,u.clippingPlanes=re.uniform),n.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),n.lightsStateVersion=o,n.needsLights&&(u.ambientLightColor.value=i.state.ambient,u.lightProbe.value=i.state.probe,u.directionalLights.value=i.state.directional,u.directionalLightShadows.value=i.state.directionalShadow,u.spotLights.value=i.state.spot,u.spotLightShadows.value=i.state.spotShadow,u.rectAreaLights.value=i.state.rectArea,u.ltc_1.value=i.state.rectAreaLTC1,u.ltc_2.value=i.state.rectAreaLTC2,u.pointLights.value=i.state.point,u.pointLightShadows.value=i.state.pointShadow,u.hemisphereLights.value=i.state.hemi,u.directionalShadowMap.value=i.state.directionalShadowMap,u.directionalShadowMatrix.value=i.state.directionalShadowMatrix,u.spotShadowMap.value=i.state.spotShadowMap,u.spotShadowMatrix.value=i.state.spotShadowMatrix,u.pointShadowMap.value=i.state.pointShadowMap,u.pointShadowMatrix.value=i.state.pointShadowMatrix);const p=n.program.getUniforms(),f=WebGLUniforms.seqWithValue(p.seq,u);n.uniformsList=f}function Me(e,t,r,n){!0!==t.isScene&&(t=z),X.resetTextureUnits();const i=t.fog,a=r.isMeshStandardMaterial?t.environment:null,o=null===_?m.outputEncoding:_.texture.encoding,s=$.get(r.envMap||a),l=Y.get(r),c=d.state.lights;if(!0===B&&(!0===N||e!==S)){const t=e===S&&r.id===w;re.setState(r,e,t)}r.version===l.__version?r.fog&&l.fog!==i||l.environment!==a||l.needsLights&&l.lightsStateVersion!==c.state.version?Se(r,t,n):void 0===l.numClippingPlanes||l.numClippingPlanes===re.numPlanes&&l.numIntersection===re.numIntersection?(l.outputEncoding!==o||l.envMap!==s)&&Se(r,t,n):Se(r,t,n):(Se(r,t,n),l.__version=r.version);let h=!1,u=!1,p=!1;const f=l.program,g=f.getUniforms(),y=l.uniforms;if(j.useProgram(f.program)&&(h=!0,u=!0,p=!0),r.id!==w&&(w=r.id,u=!0),h||S!==e){if(g.setValue(ce,"projectionMatrix",e.projectionMatrix),V.logarithmicDepthBuffer&&g.setValue(ce,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),S!==e&&(S=e,u=!0,p=!0),r.isShaderMaterial||r.isMeshPhongMaterial||r.isMeshToonMaterial||r.isMeshStandardMaterial||r.envMap){const t=g.map.cameraPosition;void 0!==t&&t.setValue(ce,U.setFromMatrixPosition(e.matrixWorld))}(r.isMeshPhongMaterial||r.isMeshToonMaterial||r.isMeshLambertMaterial||r.isMeshBasicMaterial||r.isMeshStandardMaterial||r.isShaderMaterial)&&g.setValue(ce,"isOrthographic",!0===e.isOrthographicCamera),(r.isMeshPhongMaterial||r.isMeshToonMaterial||r.isMeshLambertMaterial||r.isMeshBasicMaterial||r.isMeshStandardMaterial||r.isShaderMaterial||r.isShadowMaterial||r.skinning)&&g.setValue(ce,"viewMatrix",e.matrixWorldInverse)}if(r.skinning){g.setOptional(ce,n,"bindMatrix"),g.setOptional(ce,n,"bindMatrixInverse");const e=n.skeleton;if(e){const t=e.bones;if(V.floatVertexTextures){if(null===e.boneTexture){let r=Math.sqrt(4*t.length);r=MathUtils.ceilPowerOfTwo(r),r=Math.max(r,4);const n=new Float32Array(r*r*4);n.set(e.boneMatrices);const i=new DataTexture(n,r,r,RGBAFormat,FloatType);e.boneMatrices=n,e.boneTexture=i,e.boneTextureSize=r}g.setValue(ce,"boneTexture",e.boneTexture,X),g.setValue(ce,"boneTextureSize",e.boneTextureSize)}else g.setOptional(ce,e,"boneMatrices")}}var v,b;return(u||l.receiveShadow!==n.receiveShadow)&&(l.receiveShadow=n.receiveShadow,g.setValue(ce,"receiveShadow",n.receiveShadow)),u&&(g.setValue(ce,"toneMappingExposure",m.toneMappingExposure),l.needsLights&&(b=p,(v=y).ambientLightColor.needsUpdate=b,v.lightProbe.needsUpdate=b,v.directionalLights.needsUpdate=b,v.directionalLightShadows.needsUpdate=b,v.pointLights.needsUpdate=b,v.pointLightShadows.needsUpdate=b,v.spotLights.needsUpdate=b,v.spotLightShadows.needsUpdate=b,v.rectAreaLights.needsUpdate=b,v.hemisphereLights.needsUpdate=b),i&&r.fog&&K.refreshFogUniforms(y,i),K.refreshMaterialUniforms(y,r,L,C),WebGLUniforms.upload(ce,l.uniformsList,y,X)),r.isShaderMaterial&&!0===r.uniformsNeedUpdate&&(WebGLUniforms.upload(ce,l.uniformsList,y,X),r.uniformsNeedUpdate=!1),r.isSpriteMaterial&&g.setValue(ce,"center",n.center),g.setValue(ce,"modelViewMatrix",n.modelViewMatrix),g.setValue(ce,"normalMatrix",n.normalMatrix),g.setValue(ce,"modelMatrix",n.matrixWorld),f}be.setAnimationLoop((function(e){de.isPresenting||ve&&ve(e)})),"undefined"!=typeof window&&be.setContext(window),this.setAnimationLoop=function(e){ve=e,de.setAnimationLoop(e),null===e?be.stop():be.start()},this.render=function(e,t){let r,n;if(void 0!==arguments[2]&&(console.warn("THREE.WebGLRenderer.render(): the renderTarget argument has been removed. Use .setRenderTarget() instead."),r=arguments[2]),void 0!==arguments[3]&&(console.warn("THREE.WebGLRenderer.render(): the forceClear argument has been removed. Use .clear() instead."),n=arguments[3]),void 0!==t&&!0!==t.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===g)return;le.resetDefaultState(),w=-1,S=null,!0===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),!0===de.enabled&&!0===de.isPresenting&&(t=de.getCamera(t)),!0===e.isScene&&e.onBeforeRender(m,e,t,r||_),d=te.get(e,f.length),d.init(),f.push(d),F.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),k.setFromProjectionMatrix(F),N=this.localClippingEnabled,B=re.init(this.clippingPlanes,N,t),u=ee.get(e,p.length),u.init(),p.push(u),_e(e,t,0,m.sortObjects),u.finish(),!0===m.sortObjects&&u.sort(D,R),!0===B&&re.beginShadows();const i=d.state.shadowsArray;pe.render(i,e,t),d.setupLights(),d.setupLightsView(t),!0===B&&re.endShadows(),!0===this.info.autoReset&&this.info.reset(),void 0!==r&&this.setRenderTarget(r),ne.render(u,e,t,n);const a=u.opaque,o=u.transparent;a.length>0&&xe(a,e,t),o.length>0&&xe(o,e,t),!0===e.isScene&&e.onAfterRender(m,e,t),null!==_&&(X.updateRenderTargetMipmap(_),X.updateMultisampleRenderTarget(_)),j.buffers.depth.setTest(!0),j.buffers.depth.setMask(!0),j.buffers.color.setMask(!0),j.setPolygonOffset(!1),f.pop(),d=f.length>0?f[f.length-1]:null,p.pop(),u=p.length>0?p[p.length-1]:null},this.setFramebuffer=function(e){y!==e&&null===_&&ce.bindFramebuffer(36160,e),y=e},this.getActiveCubeFace=function(){return v},this.getActiveMipmapLevel=function(){return b},this.getRenderTarget=function(){return _},this.setRenderTarget=function(e,t=0,r=0){_=e,v=t,b=r,e&&void 0===Y.get(e).__webglFramebuffer&&X.setupRenderTarget(e);let n=y,i=!1,a=!1;if(e){const r=e.texture;(r.isDataTexture3D||r.isDataTexture2DArray)&&(a=!0);const o=Y.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(n=o[t],i=!0):n=e.isWebGLMultisampleRenderTarget?Y.get(e).__webglMultisampledFramebuffer:o,M.copy(e.viewport),T.copy(e.scissor),A=e.scissorTest}else M.copy(P).multiplyScalar(L).floor(),T.copy(O).multiplyScalar(L).floor(),A=I;if(x!==n&&(ce.bindFramebuffer(36160,n),x=n),j.viewport(M),j.scissor(T),j.setScissorTest(A),i){const n=Y.get(e.texture);ce.framebufferTexture2D(36160,36064,34069+t,n.__webglTexture,r)}else if(a){const n=Y.get(e.texture),i=t||0;ce.framebufferTextureLayer(36160,36064,n.__webglTexture,r||0,i)}},this.readRenderTargetPixels=function(e,t,r,n,i,a,o){if(!e||!e.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let s=Y.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==o&&(s=s[o]),s){let o=!1;s!==x&&(ce.bindFramebuffer(36160,s),o=!0);try{const s=e.texture,l=s.format,c=s.type;if(l!==RGBAFormat&&se.convert(l)!==ce.getParameter(35739))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");const h=c===HalfFloatType&&(G.has("EXT_color_buffer_half_float")||V.isWebGL2&&G.has("EXT_color_buffer_float"));if(!(c===UnsignedByteType||se.convert(c)===ce.getParameter(35738)||c===FloatType&&(V.isWebGL2||G.has("OES_texture_float")||G.has("WEBGL_color_buffer_float"))||h))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");36053===ce.checkFramebufferStatus(36160)?t>=0&&t<=e.width-n&&r>=0&&r<=e.height-i&&ce.readPixels(t,r,n,i,se.convert(l),se.convert(c),a):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{o&&ce.bindFramebuffer(36160,x)}}},this.copyFramebufferToTexture=function(e,t,r=0){const n=Math.pow(2,-r),i=Math.floor(t.image.width*n),a=Math.floor(t.image.height*n),o=se.convert(t.format);X.setTexture2D(t,0),ce.copyTexImage2D(3553,r,o,e.x,e.y,i,a,0),j.unbindTexture()},this.copyTextureToTexture=function(e,t,r,n=0){const i=t.image.width,a=t.image.height,o=se.convert(r.format),s=se.convert(r.type);X.setTexture2D(r,0),ce.pixelStorei(37440,r.flipY),ce.pixelStorei(37441,r.premultiplyAlpha),ce.pixelStorei(3317,r.unpackAlignment),t.isDataTexture?ce.texSubImage2D(3553,n,e.x,e.y,i,a,o,s,t.image.data):t.isCompressedTexture?ce.compressedTexSubImage2D(3553,n,e.x,e.y,t.mipmaps[0].width,t.mipmaps[0].height,o,t.mipmaps[0].data):ce.texSubImage2D(3553,n,e.x,e.y,o,s,t.image),0===n&&r.generateMipmaps&&ce.generateMipmap(3553),j.unbindTexture()},this.copyTextureToTexture3D=function(e,t,r,n,i=0){if(m.isWebGL1Renderer)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: can only be used with WebGL2.");const{width:a,height:o,data:s}=r.image,l=se.convert(n.format),c=se.convert(n.type);let h;if(n.isDataTexture3D)X.setTexture3D(n,0),h=32879;else{if(!n.isDataTexture2DArray)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: only supports THREE.DataTexture3D and THREE.DataTexture2DArray.");X.setTexture2DArray(n,0),h=35866}ce.pixelStorei(37440,n.flipY),ce.pixelStorei(37441,n.premultiplyAlpha),ce.pixelStorei(3317,n.unpackAlignment);const u=ce.getParameter(3314),d=ce.getParameter(32878),p=ce.getParameter(3316),f=ce.getParameter(3315),g=ce.getParameter(32877);ce.pixelStorei(3314,a),ce.pixelStorei(32878,o),ce.pixelStorei(3316,e.min.x),ce.pixelStorei(3315,e.min.y),ce.pixelStorei(32877,e.min.z),ce.texSubImage3D(h,i,t.x,t.y,t.z,e.max.x-e.min.x+1,e.max.y-e.min.y+1,e.max.z-e.min.z+1,l,c,s),ce.pixelStorei(3314,u),ce.pixelStorei(32878,d),ce.pixelStorei(3316,p),ce.pixelStorei(3315,f),ce.pixelStorei(32877,g),0===i&&n.generateMipmaps&&ce.generateMipmap(h),j.unbindTexture()},this.initTexture=function(e){X.setTexture2D(e,0),j.unbindTexture()},this.resetState=function(){j.reset(),le.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}Group.prototype.isGroup=!0,Object.assign(WebXRController.prototype,{constructor:WebXRController,getHandSpace:function(){return null===this._hand&&(this._hand=new Group,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand},getTargetRaySpace:function(){return null===this._targetRay&&(this._targetRay=new Group,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1),this._targetRay},getGripSpace:function(){return null===this._grip&&(this._grip=new Group,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1),this._grip},dispatchEvent:function(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this},disconnect:function(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this},update:function(e,t,r){let n=null,i=null,a=null;const o=this._targetRay,s=this._grip,l=this._hand;if(e&&"visible-blurred"!==t.session.visibilityState)if(l&&e.hand){a=!0;for(const n of e.hand.values()){const e=t.getJointPose(n,r);if(void 0===l.joints[n.jointName]){const e=new Group;e.matrixAutoUpdate=!1,e.visible=!1,l.joints[n.jointName]=e,l.add(e)}const i=l.joints[n.jointName];null!==e&&(i.matrix.fromArray(e.transform.matrix),i.matrix.decompose(i.position,i.rotation,i.scale),i.jointRadius=e.radius),i.visible=null!==e}const n=l.joints["index-finger-tip"],i=l.joints["thumb-tip"],o=n.position.distanceTo(i.position),s=.02,c=.005;l.inputState.pinching&&o>s+c?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!l.inputState.pinching&&o<=s-c&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==o&&(n=t.getPose(e.targetRaySpace,r),null!==n&&(o.matrix.fromArray(n.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale))),null!==s&&e.gripSpace&&(i=t.getPose(e.gripSpace,r),null!==i&&(s.matrix.fromArray(i.transform.matrix),s.matrix.decompose(s.position,s.rotation,s.scale)));return null!==o&&(o.visible=null!==n),null!==s&&(s.visible=null!==i),null!==l&&(l.visible=null!==a),this}}),Object.assign(WebXRManager.prototype,EventDispatcher.prototype);class WebGL1Renderer extends WebGLRenderer{}WebGL1Renderer.prototype.isWebGL1Renderer=!0;class FogExp2{constructor(e,t){this.name="",this.color=new Color(e),this.density=void 0!==t?t:25e-5}clone(){return new FogExp2(this.color,this.density)}toJSON(){return{type:"FogExp2",color:this.color.getHex(),density:this.density}}}FogExp2.prototype.isFogExp2=!0;class Fog{constructor(e,t,r){this.name="",this.color=new Color(e),this.near=void 0!==t?t:1,this.far=void 0!==r?r:1e3}clone(){return new Fog(this.color,this.near,this.far)}toJSON(){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}}}Fog.prototype.isFog=!0;class Scene extends Object3D{constructor(){super(),this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.autoUpdate=e.autoUpdate,this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return null!==this.background&&(t.object.background=this.background.toJSON(e)),null!==this.environment&&(t.object.environment=this.environment.toJSON(e)),null!==this.fog&&(t.object.fog=this.fog.toJSON()),t}}function InterleavedBuffer(e,t){this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.usage=StaticDrawUsage,this.updateRange={offset:0,count:-1},this.version=0,this.uuid=MathUtils.generateUUID()}Scene.prototype.isScene=!0,Object.defineProperty(InterleavedBuffer.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(InterleavedBuffer.prototype,{isInterleavedBuffer:!0,onUploadCallback:function(){},setUsage:function(e){return this.usage=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this},copyAt:function(e,t,r){e*=this.stride,r*=t.stride;for(let n=0,i=this.stride;n<i;n++)this.array[e+n]=t.array[r+n];return this},set:function(e,t=0){return this.array.set(e,t),this},clone:function(e){void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=MathUtils.generateUUID()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const t=new InterleavedBuffer(new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),this.stride);return t.setUsage(this.usage),t},onUpload:function(e){return this.onUploadCallback=e,this},toJSON:function(e){return void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=MathUtils.generateUUID()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=Array.prototype.slice.call(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}});const _vector$6=new Vector3;function InterleavedBufferAttribute(e,t,r,n){this.name="",this.data=e,this.itemSize=t,this.offset=r,this.normalized=!0===n}Object.defineProperties(InterleavedBufferAttribute.prototype,{count:{get:function(){return this.data.count}},array:{get:function(){return this.data.array}},needsUpdate:{set:function(e){this.data.needsUpdate=e}}}),Object.assign(InterleavedBufferAttribute.prototype,{isInterleavedBufferAttribute:!0,applyMatrix4:function(e){for(let t=0,r=this.data.count;t<r;t++)_vector$6.x=this.getX(t),_vector$6.y=this.getY(t),_vector$6.z=this.getZ(t),_vector$6.applyMatrix4(e),this.setXYZ(t,_vector$6.x,_vector$6.y,_vector$6.z);return this},setX:function(e,t){return this.data.array[e*this.data.stride+this.offset]=t,this},setY:function(e,t){return this.data.array[e*this.data.stride+this.offset+1]=t,this},setZ:function(e,t){return this.data.array[e*this.data.stride+this.offset+2]=t,this},setW:function(e,t){return this.data.array[e*this.data.stride+this.offset+3]=t,this},getX:function(e){return this.data.array[e*this.data.stride+this.offset]},getY:function(e){return this.data.array[e*this.data.stride+this.offset+1]},getZ:function(e){return this.data.array[e*this.data.stride+this.offset+2]},getW:function(e){return this.data.array[e*this.data.stride+this.offset+3]},setXY:function(e,t,r){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this},setXYZ:function(e,t,r,n){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this.data.array[e+2]=n,this},setXYZW:function(e,t,r,n,i){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this.data.array[e+2]=n,this.data.array[e+3]=i,this},clone:function(e){if(void 0===e){console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interlaved buffer attribute will deinterleave buffer data.");const e=[];for(let t=0;t<this.count;t++){const r=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[r+t])}return new BufferAttribute(new this.array.constructor(e),this.itemSize,this.normalized)}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.clone(e)),new InterleavedBufferAttribute(e.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)},toJSON:function(e){if(void 0===e){console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interlaved buffer attribute will deinterleave buffer data.");const e=[];for(let t=0;t<this.count;t++){const r=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[r+t])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:e,normalized:this.normalized}}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}});class SpriteMaterial extends Material$1{constructor(e){super(),this.type="SpriteMaterial",this.color=new Color(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.rotation=e.rotation,this.sizeAttenuation=e.sizeAttenuation,this}}let _geometry;SpriteMaterial.prototype.isSpriteMaterial=!0;const _intersectPoint=new Vector3,_worldScale=new Vector3,_mvPosition=new Vector3,_alignedPosition=new Vector2,_rotatedPosition=new Vector2,_viewWorldMatrix=new Matrix4,_vA$1=new Vector3,_vB$1=new Vector3,_vC$1=new Vector3,_uvA$1=new Vector2,_uvB$1=new Vector2,_uvC$1=new Vector2;class Sprite extends Object3D{constructor(e){if(super(),this.type="Sprite",void 0===_geometry){_geometry=new BufferGeometry;const e=new InterleavedBuffer(new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),5);_geometry.setIndex([0,1,2,0,2,3]),_geometry.setAttribute("position",new InterleavedBufferAttribute(e,3,0,!1)),_geometry.setAttribute("uv",new InterleavedBufferAttribute(e,2,3,!1))}this.geometry=_geometry,this.material=void 0!==e?e:new SpriteMaterial,this.center=new Vector2(.5,.5)}raycast(e,t){null===e.camera&&console.error('THREE.Sprite: "Raycaster.camera" needs to be set in order to raycast against sprites.'),_worldScale.setFromMatrixScale(this.matrixWorld),_viewWorldMatrix.copy(e.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(e.camera.matrixWorldInverse,this.matrixWorld),_mvPosition.setFromMatrixPosition(this.modelViewMatrix),e.camera.isPerspectiveCamera&&!1===this.material.sizeAttenuation&&_worldScale.multiplyScalar(-_mvPosition.z);const r=this.material.rotation;let n,i;0!==r&&(i=Math.cos(r),n=Math.sin(r));const a=this.center;transformVertex(_vA$1.set(-.5,-.5,0),_mvPosition,a,_worldScale,n,i),transformVertex(_vB$1.set(.5,-.5,0),_mvPosition,a,_worldScale,n,i),transformVertex(_vC$1.set(.5,.5,0),_mvPosition,a,_worldScale,n,i),_uvA$1.set(0,0),_uvB$1.set(1,0),_uvC$1.set(1,1);let o=e.ray.intersectTriangle(_vA$1,_vB$1,_vC$1,!1,_intersectPoint);if(null===o&&(transformVertex(_vB$1.set(-.5,.5,0),_mvPosition,a,_worldScale,n,i),_uvB$1.set(0,1),o=e.ray.intersectTriangle(_vA$1,_vC$1,_vB$1,!1,_intersectPoint),null===o))return;const s=e.ray.origin.distanceTo(_intersectPoint);s<e.near||s>e.far||t.push({distance:s,point:_intersectPoint.clone(),uv:Triangle.getUV(_intersectPoint,_vA$1,_vB$1,_vC$1,_uvA$1,_uvB$1,_uvC$1,new Vector2),face:null,object:this})}copy(e){return super.copy(e),void 0!==e.center&&this.center.copy(e.center),this.material=e.material,this}}function transformVertex(e,t,r,n,i,a){_alignedPosition.subVectors(e,r).addScalar(.5).multiply(n),void 0!==i?(_rotatedPosition.x=a*_alignedPosition.x-i*_alignedPosition.y,_rotatedPosition.y=i*_alignedPosition.x+a*_alignedPosition.y):_rotatedPosition.copy(_alignedPosition),e.copy(t),e.x+=_rotatedPosition.x,e.y+=_rotatedPosition.y,e.applyMatrix4(_viewWorldMatrix)}Sprite.prototype.isSprite=!0;const _v1$4=new Vector3,_v2$2=new Vector3;class LOD extends Object3D{constructor(){super(),this._currentLevel=0,this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]},isLOD:{value:!0}}),this.autoUpdate=!0}copy(e){super.copy(e,!1);const t=e.levels;for(let e=0,r=t.length;e<r;e++){const r=t[e];this.addLevel(r.object.clone(),r.distance)}return this.autoUpdate=e.autoUpdate,this}addLevel(e,t=0){t=Math.abs(t);const r=this.levels;let n;for(n=0;n<r.length&&!(t<r[n].distance);n++);return r.splice(n,0,{distance:t,object:e}),this.add(e),this}getCurrentLevel(){return this._currentLevel}getObjectForDistance(e){const t=this.levels;if(t.length>0){let r,n;for(r=1,n=t.length;r<n&&!(e<t[r].distance);r++);return t[r-1].object}return null}raycast(e,t){if(this.levels.length>0){_v1$4.setFromMatrixPosition(this.matrixWorld);const r=e.ray.origin.distanceTo(_v1$4);this.getObjectForDistance(r).raycast(e,t)}}update(e){const t=this.levels;if(t.length>1){_v1$4.setFromMatrixPosition(e.matrixWorld),_v2$2.setFromMatrixPosition(this.matrixWorld);const r=_v1$4.distanceTo(_v2$2)/e.zoom;let n,i;for(t[0].object.visible=!0,n=1,i=t.length;n<i&&r>=t[n].distance;n++)t[n-1].object.visible=!1,t[n].object.visible=!0;for(this._currentLevel=n-1;n<i;n++)t[n].object.visible=!1}}toJSON(e){const t=super.toJSON(e);!1===this.autoUpdate&&(t.object.autoUpdate=!1),t.object.levels=[];const r=this.levels;for(let e=0,n=r.length;e<n;e++){const n=r[e];t.object.levels.push({object:n.object.uuid,distance:n.distance})}return t}}const _basePosition=new Vector3,_skinIndex=new Vector4,_skinWeight=new Vector4,_vector$7=new Vector3,_matrix$1=new Matrix4;function SkinnedMesh(e,t){Mesh.call(this,e,t),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new Matrix4,this.bindMatrixInverse=new Matrix4}function Bone(){Object3D.call(this),this.type="Bone"}SkinnedMesh.prototype=Object.assign(Object.create(Mesh.prototype),{constructor:SkinnedMesh,isSkinnedMesh:!0,copy:function(e){return Mesh.prototype.copy.call(this,e),this.bindMode=e.bindMode,this.bindMatrix.copy(e.bindMatrix),this.bindMatrixInverse.copy(e.bindMatrixInverse),this.skeleton=e.skeleton,this},bind:function(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.copy(t).invert()},pose:function(){this.skeleton.pose()},normalizeSkinWeights:function(){const e=new Vector4,t=this.geometry.attributes.skinWeight;for(let r=0,n=t.count;r<n;r++){e.x=t.getX(r),e.y=t.getY(r),e.z=t.getZ(r),e.w=t.getW(r);const n=1/e.manhattanLength();n!==1/0?e.multiplyScalar(n):e.set(1,0,0,0),t.setXYZW(r,e.x,e.y,e.z,e.w)}},updateMatrixWorld:function(e){Mesh.prototype.updateMatrixWorld.call(this,e),"attached"===this.bindMode?this.bindMatrixInverse.copy(this.matrixWorld).invert():"detached"===this.bindMode?this.bindMatrixInverse.copy(this.bindMatrix).invert():console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)},boneTransform:function(e,t){const r=this.skeleton,n=this.geometry;_skinIndex.fromBufferAttribute(n.attributes.skinIndex,e),_skinWeight.fromBufferAttribute(n.attributes.skinWeight,e),_basePosition.fromBufferAttribute(n.attributes.position,e).applyMatrix4(this.bindMatrix),t.set(0,0,0);for(let e=0;e<4;e++){const n=_skinWeight.getComponent(e);if(0!==n){const i=_skinIndex.getComponent(e);_matrix$1.multiplyMatrices(r.bones[i].matrixWorld,r.boneInverses[i]),t.addScaledVector(_vector$7.copy(_basePosition).applyMatrix4(_matrix$1),n)}}return t.applyMatrix4(this.bindMatrixInverse)}}),Bone.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Bone,isBone:!0});const _offsetMatrix=new Matrix4,_identityMatrix=new Matrix4;class Skeleton{constructor(e=[],t=[]){this.uuid=MathUtils.generateUUID(),this.bones=e.slice(0),this.boneInverses=t,this.boneMatrices=null,this.boneTexture=null,this.boneTextureSize=0,this.frame=-1,this.init()}init(){const e=this.bones,t=this.boneInverses;if(this.boneMatrices=new Float32Array(16*e.length),0===t.length)this.calculateInverses();else if(e.length!==t.length){console.warn("THREE.Skeleton: Number of inverse bone matrices does not match amount of bones."),this.boneInverses=[];for(let e=0,t=this.bones.length;e<t;e++)this.boneInverses.push(new Matrix4)}}calculateInverses(){this.boneInverses.length=0;for(let e=0,t=this.bones.length;e<t;e++){const t=new Matrix4;this.bones[e]&&t.copy(this.bones[e].matrixWorld).invert(),this.boneInverses.push(t)}}pose(){for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&t.matrixWorld.copy(this.boneInverses[e]).invert()}for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&(t.parent&&t.parent.isBone?(t.matrix.copy(t.parent.matrixWorld).invert(),t.matrix.multiply(t.matrixWorld)):t.matrix.copy(t.matrixWorld),t.matrix.decompose(t.position,t.quaternion,t.scale))}}update(){const e=this.bones,t=this.boneInverses,r=this.boneMatrices,n=this.boneTexture;for(let n=0,i=e.length;n<i;n++){const i=e[n]?e[n].matrixWorld:_identityMatrix;_offsetMatrix.multiplyMatrices(i,t[n]),_offsetMatrix.toArray(r,16*n)}null!==n&&(n.needsUpdate=!0)}clone(){return new Skeleton(this.bones,this.boneInverses)}getBoneByName(e){for(let t=0,r=this.bones.length;t<r;t++){const r=this.bones[t];if(r.name===e)return r}}dispose(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(e,t){this.uuid=e.uuid;for(let r=0,n=e.bones.length;r<n;r++){const n=e.bones[r];let i=t[n];void 0===i&&(console.warn("THREE.Skeleton: No bone found with UUID:",n),i=new Bone),this.bones.push(i),this.boneInverses.push((new Matrix4).fromArray(e.boneInverses[r]))}return this.init(),this}toJSON(){const e={metadata:{version:4.5,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};e.uuid=this.uuid;const t=this.bones,r=this.boneInverses;for(let n=0,i=t.length;n<i;n++){const i=t[n];e.bones.push(i.uuid);const a=r[n];e.boneInverses.push(a.toArray())}return e}}const _instanceLocalMatrix=new Matrix4,_instanceWorldMatrix=new Matrix4,_instanceIntersects=[],_mesh=new Mesh;function InstancedMesh(e,t,r){Mesh.call(this,e,t),this.instanceMatrix=new BufferAttribute(new Float32Array(16*r),16),this.instanceColor=null,this.count=r,this.frustumCulled=!1}InstancedMesh.prototype=Object.assign(Object.create(Mesh.prototype),{constructor:InstancedMesh,isInstancedMesh:!0,copy:function(e){return Mesh.prototype.copy.call(this,e),this.instanceMatrix.copy(e.instanceMatrix),null!==e.instanceColor&&(this.instanceColor=e.instanceColor.clone()),this.count=e.count,this},getColorAt:function(e,t){t.fromArray(this.instanceColor.array,3*e)},getMatrixAt:function(e,t){t.fromArray(this.instanceMatrix.array,16*e)},raycast:function(e,t){const r=this.matrixWorld,n=this.count;if(_mesh.geometry=this.geometry,_mesh.material=this.material,void 0!==_mesh.material)for(let i=0;i<n;i++){this.getMatrixAt(i,_instanceLocalMatrix),_instanceWorldMatrix.multiplyMatrices(r,_instanceLocalMatrix),_mesh.matrixWorld=_instanceWorldMatrix,_mesh.raycast(e,_instanceIntersects);for(let e=0,r=_instanceIntersects.length;e<r;e++){const r=_instanceIntersects[e];r.instanceId=i,r.object=this,t.push(r)}_instanceIntersects.length=0}},setColorAt:function(e,t){null===this.instanceColor&&(this.instanceColor=new BufferAttribute(new Float32Array(3*this.count),3)),t.toArray(this.instanceColor.array,3*e)},setMatrixAt:function(e,t){t.toArray(this.instanceMatrix.array,16*e)},updateMorphTargets:function(){},dispose:function(){this.dispatchEvent({type:"dispose"})}});class LineBasicMaterial extends Material$1{constructor(e){super(),this.type="LineBasicMaterial",this.color=new Color(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.morphTargets=!1,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.morphTargets=e.morphTargets,this}}LineBasicMaterial.prototype.isLineBasicMaterial=!0;const _start=new Vector3,_end=new Vector3,_inverseMatrix$1=new Matrix4,_ray$1=new Ray,_sphere$2=new Sphere;function Line(e=new BufferGeometry,t=new LineBasicMaterial){Object3D.call(this),this.type="Line",this.geometry=e,this.material=t,this.updateMorphTargets()}Line.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Line,isLine:!0,copy:function(e){return Object3D.prototype.copy.call(this,e),this.material=e.material,this.geometry=e.geometry,this},computeLineDistances:function(){const e=this.geometry;if(e.isBufferGeometry)if(null===e.index){const t=e.attributes.position,r=[0];for(let e=1,n=t.count;e<n;e++)_start.fromBufferAttribute(t,e-1),_end.fromBufferAttribute(t,e),r[e]=r[e-1],r[e]+=_start.distanceTo(_end);e.setAttribute("lineDistance",new Float32BufferAttribute(r,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else e.isGeometry&&console.error("THREE.Line.computeLineDistances() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");return this},raycast:function(e,t){const r=this.geometry,n=this.matrixWorld,i=e.params.Line.threshold;if(null===r.boundingSphere&&r.computeBoundingSphere(),_sphere$2.copy(r.boundingSphere),_sphere$2.applyMatrix4(n),_sphere$2.radius+=i,!1===e.ray.intersectsSphere(_sphere$2))return;_inverseMatrix$1.copy(n).invert(),_ray$1.copy(e.ray).applyMatrix4(_inverseMatrix$1);const a=i/((this.scale.x+this.scale.y+this.scale.z)/3),o=a*a,s=new Vector3,l=new Vector3,c=new Vector3,h=new Vector3,u=this.isLineSegments?2:1;if(r.isBufferGeometry){const n=r.index,i=r.attributes.position;if(null!==n){const r=n.array;for(let n=0,a=r.length-1;n<a;n+=u){const a=r[n],u=r[n+1];s.fromBufferAttribute(i,a),l.fromBufferAttribute(i,u);if(_ray$1.distanceSqToSegment(s,l,h,c)>o)continue;h.applyMatrix4(this.matrixWorld);const d=e.ray.origin.distanceTo(h);d<e.near||d>e.far||t.push({distance:d,point:c.clone().applyMatrix4(this.matrixWorld),index:n,face:null,faceIndex:null,object:this})}}else for(let r=0,n=i.count-1;r<n;r+=u){s.fromBufferAttribute(i,r),l.fromBufferAttribute(i,r+1);if(_ray$1.distanceSqToSegment(s,l,h,c)>o)continue;h.applyMatrix4(this.matrixWorld);const n=e.ray.origin.distanceTo(h);n<e.near||n>e.far||t.push({distance:n,point:c.clone().applyMatrix4(this.matrixWorld),index:r,face:null,faceIndex:null,object:this})}}else r.isGeometry&&console.error("THREE.Line.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")},updateMorphTargets:function(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,r=Object.keys(t);if(r.length>0){const e=t[r[0]];if(void 0!==e){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,r=e.length;t<r;t++){const r=e[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[r]=t}}}}else{const t=e.morphTargets;void 0!==t&&t.length>0&&console.error("THREE.Line.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}});const _start$1=new Vector3,_end$1=new Vector3;function LineSegments(e,t){Line.call(this,e,t),this.type="LineSegments"}LineSegments.prototype=Object.assign(Object.create(Line.prototype),{constructor:LineSegments,isLineSegments:!0,computeLineDistances:function(){const e=this.geometry;if(e.isBufferGeometry)if(null===e.index){const t=e.attributes.position,r=[];for(let e=0,n=t.count;e<n;e+=2)_start$1.fromBufferAttribute(t,e),_end$1.fromBufferAttribute(t,e+1),r[e]=0===e?0:r[e-1],r[e+1]=r[e]+_start$1.distanceTo(_end$1);e.setAttribute("lineDistance",new Float32BufferAttribute(r,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else e.isGeometry&&console.error("THREE.LineSegments.computeLineDistances() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");return this}});class LineLoop extends Line{constructor(e,t){super(e,t),this.type="LineLoop"}}LineLoop.prototype.isLineLoop=!0;class PointsMaterial extends Material$1{constructor(e){super(),this.type="PointsMaterial",this.color=new Color(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.morphTargets=!1,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.morphTargets=e.morphTargets,this}}PointsMaterial.prototype.isPointsMaterial=!0;const _inverseMatrix$2=new Matrix4,_ray$2=new Ray,_sphere$3=new Sphere,_position$1=new Vector3;function Points(e=new BufferGeometry,t=new PointsMaterial){Object3D.call(this),this.type="Points",this.geometry=e,this.material=t,this.updateMorphTargets()}function testPoint(e,t,r,n,i,a,o){const s=_ray$2.distanceSqToPoint(e);if(s<r){const r=new Vector3;_ray$2.closestPointToPoint(e,r),r.applyMatrix4(n);const l=i.ray.origin.distanceTo(r);if(l<i.near||l>i.far)return;a.push({distance:l,distanceToRay:Math.sqrt(s),point:r,index:t,face:null,object:o})}}Points.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Points,isPoints:!0,copy:function(e){return Object3D.prototype.copy.call(this,e),this.material=e.material,this.geometry=e.geometry,this},raycast:function(e,t){const r=this.geometry,n=this.matrixWorld,i=e.params.Points.threshold;if(null===r.boundingSphere&&r.computeBoundingSphere(),_sphere$3.copy(r.boundingSphere),_sphere$3.applyMatrix4(n),_sphere$3.radius+=i,!1===e.ray.intersectsSphere(_sphere$3))return;_inverseMatrix$2.copy(n).invert(),_ray$2.copy(e.ray).applyMatrix4(_inverseMatrix$2);const a=i/((this.scale.x+this.scale.y+this.scale.z)/3),o=a*a;if(r.isBufferGeometry){const i=r.index,a=r.attributes.position;if(null!==i){const r=i.array;for(let i=0,s=r.length;i<s;i++){const s=r[i];_position$1.fromBufferAttribute(a,s),testPoint(_position$1,s,o,n,e,t,this)}}else for(let r=0,i=a.count;r<i;r++)_position$1.fromBufferAttribute(a,r),testPoint(_position$1,r,o,n,e,t,this)}else console.error("THREE.Points.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")},updateMorphTargets:function(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,r=Object.keys(t);if(r.length>0){const e=t[r[0]];if(void 0!==e){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,r=e.length;t<r;t++){const r=e[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[r]=t}}}}else{const t=e.morphTargets;void 0!==t&&t.length>0&&console.error("THREE.Points.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}});class VideoTexture extends Texture$1{constructor(e,t,r,n,i,a,o,s,l){super(e,t,r,n,i,a,o,s,l),this.format=void 0!==o?o:RGBFormat,this.minFilter=void 0!==a?a:LinearFilter,this.magFilter=void 0!==i?i:LinearFilter,this.generateMipmaps=!1;const c=this;"requestVideoFrameCallback"in e&&e.requestVideoFrameCallback((function t(){c.needsUpdate=!0,e.requestVideoFrameCallback(t)}))}clone(){return new this.constructor(this.image).copy(this)}update(){const e=this.image;!1==="requestVideoFrameCallback"in e&&e.readyState>=e.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}VideoTexture.prototype.isVideoTexture=!0;class CompressedTexture extends Texture$1{constructor(e,t,r,n,i,a,o,s,l,c,h,u){super(null,a,o,s,l,c,n,i,h,u),this.image={width:t,height:r},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}}CompressedTexture.prototype.isCompressedTexture=!0;class CanvasTexture extends Texture$1{constructor(e,t,r,n,i,a,o,s,l){super(e,t,r,n,i,a,o,s,l),this.needsUpdate=!0}}CanvasTexture.prototype.isCanvasTexture=!0;class DepthTexture extends Texture$1{constructor(e,t,r,n,i,a,o,s,l,c){if((c=void 0!==c?c:DepthFormat)!==DepthFormat&&c!==DepthStencilFormat)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===r&&c===DepthFormat&&(r=UnsignedShortType),void 0===r&&c===DepthStencilFormat&&(r=UnsignedInt248Type),super(null,n,i,a,o,s,c,r,l),this.image={width:e,height:t},this.magFilter=void 0!==o?o:NearestFilter,this.minFilter=void 0!==s?s:NearestFilter,this.flipY=!1,this.generateMipmaps=!1}}DepthTexture.prototype.isDepthTexture=!0;class CircleGeometry extends BufferGeometry{constructor(e=1,t=8,r=0,n=2*Math.PI){super(),this.type="CircleGeometry",this.parameters={radius:e,segments:t,thetaStart:r,thetaLength:n},t=Math.max(3,t);const i=[],a=[],o=[],s=[],l=new Vector3,c=new Vector2;a.push(0,0,0),o.push(0,0,1),s.push(.5,.5);for(let i=0,h=3;i<=t;i++,h+=3){const u=r+i/t*n;l.x=e*Math.cos(u),l.y=e*Math.sin(u),a.push(l.x,l.y,l.z),o.push(0,0,1),c.x=(a[h]/e+1)/2,c.y=(a[h+1]/e+1)/2,s.push(c.x,c.y)}for(let e=1;e<=t;e++)i.push(e,e+1,0);this.setIndex(i),this.setAttribute("position",new Float32BufferAttribute(a,3)),this.setAttribute("normal",new Float32BufferAttribute(o,3)),this.setAttribute("uv",new Float32BufferAttribute(s,2))}}class CylinderGeometry extends BufferGeometry{constructor(e=1,t=1,r=1,n=8,i=1,a=!1,o=0,s=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:r,radialSegments:n,heightSegments:i,openEnded:a,thetaStart:o,thetaLength:s};const l=this;n=Math.floor(n),i=Math.floor(i);const c=[],h=[],u=[],d=[];let p=0;const f=[],m=r/2;let g=0;function y(r){const i=p,a=new Vector2,f=new Vector3;let y=0;const v=!0===r?e:t,b=!0===r?1:-1;for(let e=1;e<=n;e++)h.push(0,m*b,0),u.push(0,b,0),d.push(.5,.5),p++;const _=p;for(let e=0;e<=n;e++){const t=e/n*s+o,r=Math.cos(t),i=Math.sin(t);f.x=v*i,f.y=m*b,f.z=v*r,h.push(f.x,f.y,f.z),u.push(0,b,0),a.x=.5*r+.5,a.y=.5*i*b+.5,d.push(a.x,a.y),p++}for(let e=0;e<n;e++){const t=i+e,n=_+e;!0===r?c.push(n,n+1,t):c.push(n+1,n,t),y+=3}l.addGroup(g,y,!0===r?1:2),g+=y}!function(){const a=new Vector3,y=new Vector3;let v=0;const b=(t-e)/r;for(let l=0;l<=i;l++){const c=[],g=l/i,v=g*(t-e)+e;for(let e=0;e<=n;e++){const t=e/n,i=t*s+o,l=Math.sin(i),f=Math.cos(i);y.x=v*l,y.y=-g*r+m,y.z=v*f,h.push(y.x,y.y,y.z),a.set(l,b,f).normalize(),u.push(a.x,a.y,a.z),d.push(t,1-g),c.push(p++)}f.push(c)}for(let e=0;e<n;e++)for(let t=0;t<i;t++){const r=f[t][e],n=f[t+1][e],i=f[t+1][e+1],a=f[t][e+1];c.push(r,n,a),c.push(n,i,a),v+=6}l.addGroup(g,v,0),g+=v}(),!1===a&&(e>0&&y(!0),t>0&&y(!1)),this.setIndex(c),this.setAttribute("position",new Float32BufferAttribute(h,3)),this.setAttribute("normal",new Float32BufferAttribute(u,3)),this.setAttribute("uv",new Float32BufferAttribute(d,2))}}class ConeGeometry extends CylinderGeometry{constructor(e=1,t=1,r=8,n=1,i=!1,a=0,o=2*Math.PI){super(0,e,t,r,n,i,a,o),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:r,heightSegments:n,openEnded:i,thetaStart:a,thetaLength:o}}}class PolyhedronGeometry extends BufferGeometry{constructor(e,t,r=1,n=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:r,detail:n};const i=[],a=[];function o(e,t,r,n){const i=n+1,a=[];for(let n=0;n<=i;n++){a[n]=[];const o=e.clone().lerp(r,n/i),s=t.clone().lerp(r,n/i),l=i-n;for(let e=0;e<=l;e++)a[n][e]=0===e&&n===i?o:o.clone().lerp(s,e/l)}for(let e=0;e<i;e++)for(let t=0;t<2*(i-e)-1;t++){const r=Math.floor(t/2);t%2==0?(s(a[e][r+1]),s(a[e+1][r]),s(a[e][r])):(s(a[e][r+1]),s(a[e+1][r+1]),s(a[e+1][r]))}}function s(e){i.push(e.x,e.y,e.z)}function l(t,r){const n=3*t;r.x=e[n+0],r.y=e[n+1],r.z=e[n+2]}function c(e,t,r,n){n<0&&1===e.x&&(a[t]=e.x-1),0===r.x&&0===r.z&&(a[t]=n/2/Math.PI+.5)}function h(e){return Math.atan2(e.z,-e.x)}!function(e){const r=new Vector3,n=new Vector3,i=new Vector3;for(let a=0;a<t.length;a+=3)l(t[a+0],r),l(t[a+1],n),l(t[a+2],i),o(r,n,i,e)}(n),function(e){const t=new Vector3;for(let r=0;r<i.length;r+=3)t.x=i[r+0],t.y=i[r+1],t.z=i[r+2],t.normalize().multiplyScalar(e),i[r+0]=t.x,i[r+1]=t.y,i[r+2]=t.z}(r),function(){const e=new Vector3;for(let r=0;r<i.length;r+=3){e.x=i[r+0],e.y=i[r+1],e.z=i[r+2];const n=h(e)/2/Math.PI+.5,o=(t=e,Math.atan2(-t.y,Math.sqrt(t.x*t.x+t.z*t.z))/Math.PI+.5);a.push(n,1-o)}var t;(function(){const e=new Vector3,t=new Vector3,r=new Vector3,n=new Vector3,o=new Vector2,s=new Vector2,l=new Vector2;for(let u=0,d=0;u<i.length;u+=9,d+=6){e.set(i[u+0],i[u+1],i[u+2]),t.set(i[u+3],i[u+4],i[u+5]),r.set(i[u+6],i[u+7],i[u+8]),o.set(a[d+0],a[d+1]),s.set(a[d+2],a[d+3]),l.set(a[d+4],a[d+5]),n.copy(e).add(t).add(r).divideScalar(3);const p=h(n);c(o,d+0,e,p),c(s,d+2,t,p),c(l,d+4,r,p)}})(),function(){for(let e=0;e<a.length;e+=6){const t=a[e+0],r=a[e+2],n=a[e+4],i=Math.max(t,r,n),o=Math.min(t,r,n);i>.9&&o<.1&&(t<.2&&(a[e+0]+=1),r<.2&&(a[e+2]+=1),n<.2&&(a[e+4]+=1))}}()}(),this.setAttribute("position",new Float32BufferAttribute(i,3)),this.setAttribute("normal",new Float32BufferAttribute(i.slice(),3)),this.setAttribute("uv",new Float32BufferAttribute(a,2)),0===n?this.computeVertexNormals():this.normalizeNormals()}}class DodecahedronGeometry extends PolyhedronGeometry{constructor(e=1,t=0){const r=(1+Math.sqrt(5))/2,n=1/r;super([-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-n,-r,0,-n,r,0,n,-r,0,n,r,-n,-r,0,-n,r,0,n,-r,0,n,r,0,-r,0,-n,r,0,-n,-r,0,n,r,0,n],[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],e,t),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t}}}const _v0$2=new Vector3,_v1$5=new Vector3,_normal$1=new Vector3,_triangle=new Triangle;class EdgesGeometry extends BufferGeometry{constructor(e,t){if(super(),this.type="EdgesGeometry",this.parameters={thresholdAngle:t},t=void 0!==t?t:1,!0===e.isGeometry)return void console.error("THREE.EdgesGeometry no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");const r=Math.pow(10,4),n=Math.cos(MathUtils.DEG2RAD*t),i=e.getIndex(),a=e.getAttribute("position"),o=i?i.count:a.count,s=[0,0,0],l=["a","b","c"],c=new Array(3),h={},u=[];for(let e=0;e<o;e+=3){i?(s[0]=i.getX(e),s[1]=i.getX(e+1),s[2]=i.getX(e+2)):(s[0]=e,s[1]=e+1,s[2]=e+2);const{a:t,b:o,c:d}=_triangle;if(t.fromBufferAttribute(a,s[0]),o.fromBufferAttribute(a,s[1]),d.fromBufferAttribute(a,s[2]),_triangle.getNormal(_normal$1),c[0]=`${Math.round(t.x*r)},${Math.round(t.y*r)},${Math.round(t.z*r)}`,c[1]=`${Math.round(o.x*r)},${Math.round(o.y*r)},${Math.round(o.z*r)}`,c[2]=`${Math.round(d.x*r)},${Math.round(d.y*r)},${Math.round(d.z*r)}`,c[0]!==c[1]&&c[1]!==c[2]&&c[2]!==c[0])for(let e=0;e<3;e++){const t=(e+1)%3,r=c[e],i=c[t],a=_triangle[l[e]],o=_triangle[l[t]],d=`${r}_${i}`,p=`${i}_${r}`;p in h&&h[p]?(_normal$1.dot(h[p].normal)<=n&&(u.push(a.x,a.y,a.z),u.push(o.x,o.y,o.z)),h[p]=null):d in h||(h[d]={index0:s[e],index1:s[t],normal:_normal$1.clone()})}}for(const e in h)if(h[e]){const{index0:t,index1:r}=h[e];_v0$2.fromBufferAttribute(a,t),_v1$5.fromBufferAttribute(a,r),u.push(_v0$2.x,_v0$2.y,_v0$2.z),u.push(_v1$5.x,_v1$5.y,_v1$5.z)}this.setAttribute("position",new Float32BufferAttribute(u,3))}}const Earcut={triangulate:function(e,t,r){r=r||2;const n=t&&t.length,i=n?t[0]*r:e.length;let a=linkedList(e,0,i,r,!0);const o=[];if(!a||a.next===a.prev)return o;let s,l,c,h,u,d,p;if(n&&(a=eliminateHoles(e,t,a,r)),e.length>80*r){s=c=e[0],l=h=e[1];for(let t=r;t<i;t+=r)u=e[t],d=e[t+1],u<s&&(s=u),d<l&&(l=d),u>c&&(c=u),d>h&&(h=d);p=Math.max(c-s,h-l),p=0!==p?1/p:0}return earcutLinked(a,o,r,s,l,p),o}};function linkedList(e,t,r,n,i){let a,o;if(i===signedArea(e,t,r,n)>0)for(a=t;a<r;a+=n)o=insertNode(a,e[a],e[a+1],o);else for(a=r-n;a>=t;a-=n)o=insertNode(a,e[a],e[a+1],o);return o&&equals(o,o.next)&&(removeNode(o),o=o.next),o}function filterPoints(e,t){if(!e)return e;t||(t=e);let r,n=e;do{if(r=!1,n.steiner||!equals(n,n.next)&&0!==area$1(n.prev,n,n.next))n=n.next;else{if(removeNode(n),n=t=n.prev,n===n.next)break;r=!0}}while(r||n!==t);return t}function earcutLinked(e,t,r,n,i,a,o){if(!e)return;!o&&a&&indexCurve(e,n,i,a);let s,l,c=e;for(;e.prev!==e.next;)if(s=e.prev,l=e.next,a?isEarHashed(e,n,i,a):isEar(e))t.push(s.i/r),t.push(e.i/r),t.push(l.i/r),removeNode(e),e=l.next,c=l.next;else if((e=l)===c){o?1===o?earcutLinked(e=cureLocalIntersections(filterPoints(e),t,r),t,r,n,i,a,2):2===o&&splitEarcut(e,t,r,n,i,a):earcutLinked(filterPoints(e),t,r,n,i,a,1);break}}function isEar(e){const t=e.prev,r=e,n=e.next;if(area$1(t,r,n)>=0)return!1;let i=e.next.next;for(;i!==e.prev;){if(pointInTriangle(t.x,t.y,r.x,r.y,n.x,n.y,i.x,i.y)&&area$1(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function isEarHashed(e,t,r,n){const i=e.prev,a=e,o=e.next;if(area$1(i,a,o)>=0)return!1;const s=i.x<a.x?i.x<o.x?i.x:o.x:a.x<o.x?a.x:o.x,l=i.y<a.y?i.y<o.y?i.y:o.y:a.y<o.y?a.y:o.y,c=i.x>a.x?i.x>o.x?i.x:o.x:a.x>o.x?a.x:o.x,h=i.y>a.y?i.y>o.y?i.y:o.y:a.y>o.y?a.y:o.y,u=zOrder(s,l,t,r,n),d=zOrder(c,h,t,r,n);let p=e.prevZ,f=e.nextZ;for(;p&&p.z>=u&&f&&f.z<=d;){if(p!==e.prev&&p!==e.next&&pointInTriangle(i.x,i.y,a.x,a.y,o.x,o.y,p.x,p.y)&&area$1(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,f!==e.prev&&f!==e.next&&pointInTriangle(i.x,i.y,a.x,a.y,o.x,o.y,f.x,f.y)&&area$1(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(;p&&p.z>=u;){if(p!==e.prev&&p!==e.next&&pointInTriangle(i.x,i.y,a.x,a.y,o.x,o.y,p.x,p.y)&&area$1(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;f&&f.z<=d;){if(f!==e.prev&&f!==e.next&&pointInTriangle(i.x,i.y,a.x,a.y,o.x,o.y,f.x,f.y)&&area$1(f.prev,f,f.next)>=0)return!1;f=f.nextZ}return!0}function cureLocalIntersections(e,t,r){let n=e;do{const i=n.prev,a=n.next.next;!equals(i,a)&&intersects(i,n,n.next,a)&&locallyInside(i,a)&&locallyInside(a,i)&&(t.push(i.i/r),t.push(n.i/r),t.push(a.i/r),removeNode(n),removeNode(n.next),n=e=a),n=n.next}while(n!==e);return filterPoints(n)}function splitEarcut(e,t,r,n,i,a){let o=e;do{let e=o.next.next;for(;e!==o.prev;){if(o.i!==e.i&&isValidDiagonal(o,e)){let s=splitPolygon(o,e);return o=filterPoints(o,o.next),s=filterPoints(s,s.next),earcutLinked(o,t,r,n,i,a),void earcutLinked(s,t,r,n,i,a)}e=e.next}o=o.next}while(o!==e)}function eliminateHoles(e,t,r,n){const i=[];let a,o,s,l,c;for(a=0,o=t.length;a<o;a++)s=t[a]*n,l=a<o-1?t[a+1]*n:e.length,c=linkedList(e,s,l,n,!1),c===c.next&&(c.steiner=!0),i.push(getLeftmost(c));for(i.sort(compareX),a=0;a<i.length;a++)eliminateHole(i[a],r),r=filterPoints(r,r.next);return r}function compareX(e,t){return e.x-t.x}function eliminateHole(e,t){if(t=findHoleBridge(e,t)){const r=splitPolygon(t,e);filterPoints(t,t.next),filterPoints(r,r.next)}}function findHoleBridge(e,t){let r=t;const n=e.x,i=e.y;let a,o=-1/0;do{if(i<=r.y&&i>=r.next.y&&r.next.y!==r.y){const e=r.x+(i-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(e<=n&&e>o){if(o=e,e===n){if(i===r.y)return r;if(i===r.next.y)return r.next}a=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!a)return null;if(n===o)return a;const s=a,l=a.x,c=a.y;let h,u=1/0;r=a;do{n>=r.x&&r.x>=l&&n!==r.x&&pointInTriangle(i<c?n:o,i,l,c,i<c?o:n,i,r.x,r.y)&&(h=Math.abs(i-r.y)/(n-r.x),locallyInside(r,e)&&(h<u||h===u&&(r.x>a.x||r.x===a.x&&sectorContainsSector(a,r)))&&(a=r,u=h)),r=r.next}while(r!==s);return a}function sectorContainsSector(e,t){return area$1(e.prev,e,t.prev)<0&&area$1(t.next,e,e.next)<0}function indexCurve(e,t,r,n){let i=e;do{null===i.z&&(i.z=zOrder(i.x,i.y,t,r,n)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==e);i.prevZ.nextZ=null,i.prevZ=null,sortLinked(i)}function sortLinked(e){let t,r,n,i,a,o,s,l,c=1;do{for(r=e,e=null,a=null,o=0;r;){for(o++,n=r,s=0,t=0;t<c&&(s++,n=n.nextZ,n);t++);for(l=c;s>0||l>0&&n;)0!==s&&(0===l||!n||r.z<=n.z)?(i=r,r=r.nextZ,s--):(i=n,n=n.nextZ,l--),a?a.nextZ=i:e=i,i.prevZ=a,a=i;r=n}a.nextZ=null,c*=2}while(o>1);return e}function zOrder(e,t,r,n,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function getLeftmost(e){let t=e,r=e;do{(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next}while(t!==e);return r}function pointInTriangle(e,t,r,n,i,a,o,s){return(i-o)*(t-s)-(e-o)*(a-s)>=0&&(e-o)*(n-s)-(r-o)*(t-s)>=0&&(r-o)*(a-s)-(i-o)*(n-s)>=0}function isValidDiagonal(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!intersectsPolygon(e,t)&&(locallyInside(e,t)&&locallyInside(t,e)&&middleInside(e,t)&&(area$1(e.prev,e,t.prev)||area$1(e,t.prev,t))||equals(e,t)&&area$1(e.prev,e,e.next)>0&&area$1(t.prev,t,t.next)>0)}function area$1(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function equals(e,t){return e.x===t.x&&e.y===t.y}function intersects(e,t,r,n){const i=sign(area$1(e,t,r)),a=sign(area$1(e,t,n)),o=sign(area$1(r,n,e)),s=sign(area$1(r,n,t));return i!==a&&o!==s||(!(0!==i||!onSegment(e,r,t))||(!(0!==a||!onSegment(e,n,t))||(!(0!==o||!onSegment(r,e,n))||!(0!==s||!onSegment(r,t,n)))))}function onSegment(e,t,r){return t.x<=Math.max(e.x,r.x)&&t.x>=Math.min(e.x,r.x)&&t.y<=Math.max(e.y,r.y)&&t.y>=Math.min(e.y,r.y)}function sign(e){return e>0?1:e<0?-1:0}function intersectsPolygon(e,t){let r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&intersects(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}function locallyInside(e,t){return area$1(e.prev,e,e.next)<0?area$1(e,t,e.next)>=0&&area$1(e,e.prev,t)>=0:area$1(e,t,e.prev)<0||area$1(e,e.next,t)<0}function middleInside(e,t){let r=e,n=!1;const i=(e.x+t.x)/2,a=(e.y+t.y)/2;do{r.y>a!=r.next.y>a&&r.next.y!==r.y&&i<(r.next.x-r.x)*(a-r.y)/(r.next.y-r.y)+r.x&&(n=!n),r=r.next}while(r!==e);return n}function splitPolygon(e,t){const r=new Node$1(e.i,e.x,e.y),n=new Node$1(t.i,t.x,t.y),i=e.next,a=t.prev;return e.next=t,t.prev=e,r.next=i,i.prev=r,n.next=r,r.prev=n,a.next=n,n.prev=a,n}function insertNode(e,t,r,n){const i=new Node$1(e,t,r);return n?(i.next=n.next,i.prev=n,n.next.prev=i,n.next=i):(i.prev=i,i.next=i),i}function removeNode(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function Node$1(e,t,r){this.i=e,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function signedArea(e,t,r,n){let i=0;for(let a=t,o=r-n;a<r;a+=n)i+=(e[o]-e[a])*(e[a+1]+e[o+1]),o=a;return i}const ShapeUtils={area:function(e){const t=e.length;let r=0;for(let n=t-1,i=0;i<t;n=i++)r+=e[n].x*e[i].y-e[i].x*e[n].y;return.5*r},isClockWise:function(e){return ShapeUtils.area(e)<0},triangulateShape:function(e,t){const r=[],n=[],i=[];removeDupEndPts(e),addContour(r,e);let a=e.length;t.forEach(removeDupEndPts);for(let e=0;e<t.length;e++)n.push(a),a+=t[e].length,addContour(r,t[e]);const o=Earcut.triangulate(r,n);for(let e=0;e<o.length;e+=3)i.push(o.slice(e,e+3));return i}};function removeDupEndPts(e){const t=e.length;t>2&&e[t-1].equals(e[0])&&e.pop()}function addContour(e,t){for(let r=0;r<t.length;r++)e.push(t[r].x),e.push(t[r].y)}class ExtrudeGeometry extends BufferGeometry{constructor(e,t){super(),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:t},e=Array.isArray(e)?e:[e];const r=this,n=[],i=[];for(let t=0,r=e.length;t<r;t++){a(e[t])}function a(e){const a=[],o=void 0!==t.curveSegments?t.curveSegments:12,s=void 0!==t.steps?t.steps:1;let l=void 0!==t.depth?t.depth:100,c=void 0===t.bevelEnabled||t.bevelEnabled,h=void 0!==t.bevelThickness?t.bevelThickness:6,u=void 0!==t.bevelSize?t.bevelSize:h-2,d=void 0!==t.bevelOffset?t.bevelOffset:0,p=void 0!==t.bevelSegments?t.bevelSegments:3;const f=t.extrudePath,m=void 0!==t.UVGenerator?t.UVGenerator:WorldUVGenerator;void 0!==t.amount&&(console.warn("THREE.ExtrudeBufferGeometry: amount has been renamed to depth."),l=t.amount);let g,y,v,b,_,x=!1;f&&(g=f.getSpacedPoints(s),x=!0,c=!1,y=f.computeFrenetFrames(s,!1),v=new Vector3,b=new Vector3,_=new Vector3),c||(p=0,h=0,u=0,d=0);const w=e.extractPoints(o);let S=w.shape;const M=w.holes;if(!ShapeUtils.isClockWise(S)){S=S.reverse();for(let e=0,t=M.length;e<t;e++){const t=M[e];ShapeUtils.isClockWise(t)&&(M[e]=t.reverse())}}const T=ShapeUtils.triangulateShape(S,M),A=S;for(let e=0,t=M.length;e<t;e++){const t=M[e];S=S.concat(t)}function E(e,t,r){return t||console.error("THREE.ExtrudeGeometry: vec does not exist"),t.clone().multiplyScalar(r).add(e)}const C=S.length,L=T.length;function D(e,t,r){let n,i,a;const o=e.x-t.x,s=e.y-t.y,l=r.x-e.x,c=r.y-e.y,h=o*o+s*s,u=o*c-s*l;if(Math.abs(u)>Number.EPSILON){const u=Math.sqrt(h),d=Math.sqrt(l*l+c*c),p=t.x-s/u,f=t.y+o/u,m=((r.x-c/d-p)*c-(r.y+l/d-f)*l)/(o*c-s*l);n=p+o*m-e.x,i=f+s*m-e.y;const g=n*n+i*i;if(g<=2)return new Vector2(n,i);a=Math.sqrt(g/2)}else{let e=!1;o>Number.EPSILON?l>Number.EPSILON&&(e=!0):o<-Number.EPSILON?l<-Number.EPSILON&&(e=!0):Math.sign(s)===Math.sign(c)&&(e=!0),e?(n=-s,i=o,a=Math.sqrt(h)):(n=o,i=s,a=Math.sqrt(h/2))}return new Vector2(n/a,i/a)}const R=[];for(let e=0,t=A.length,r=t-1,n=e+1;e<t;e++,r++,n++)r===t&&(r=0),n===t&&(n=0),R[e]=D(A[e],A[r],A[n]);const P=[];let O,I=R.concat();for(let e=0,t=M.length;e<t;e++){const t=M[e];O=[];for(let e=0,r=t.length,n=r-1,i=e+1;e<r;e++,n++,i++)n===r&&(n=0),i===r&&(i=0),O[e]=D(t[e],t[n],t[i]);P.push(O),I=I.concat(O)}for(let e=0;e<p;e++){const t=e/p,r=h*Math.cos(t*Math.PI/2),n=u*Math.sin(t*Math.PI/2)+d;for(let e=0,t=A.length;e<t;e++){const t=E(A[e],R[e],n);N(t.x,t.y,-r)}for(let e=0,t=M.length;e<t;e++){const t=M[e];O=P[e];for(let e=0,i=t.length;e<i;e++){const i=E(t[e],O[e],n);N(i.x,i.y,-r)}}}const k=u+d;for(let e=0;e<C;e++){const t=c?E(S[e],I[e],k):S[e];x?(b.copy(y.normals[0]).multiplyScalar(t.x),v.copy(y.binormals[0]).multiplyScalar(t.y),_.copy(g[0]).add(b).add(v),N(_.x,_.y,_.z)):N(t.x,t.y,0)}for(let e=1;e<=s;e++)for(let t=0;t<C;t++){const r=c?E(S[t],I[t],k):S[t];x?(b.copy(y.normals[e]).multiplyScalar(r.x),v.copy(y.binormals[e]).multiplyScalar(r.y),_.copy(g[e]).add(b).add(v),N(_.x,_.y,_.z)):N(r.x,r.y,l/s*e)}for(let e=p-1;e>=0;e--){const t=e/p,r=h*Math.cos(t*Math.PI/2),n=u*Math.sin(t*Math.PI/2)+d;for(let e=0,t=A.length;e<t;e++){const t=E(A[e],R[e],n);N(t.x,t.y,l+r)}for(let e=0,t=M.length;e<t;e++){const t=M[e];O=P[e];for(let e=0,i=t.length;e<i;e++){const i=E(t[e],O[e],n);x?N(i.x,i.y+g[s-1].y,g[s-1].x+r):N(i.x,i.y,l+r)}}}function B(e,t){let r=e.length;for(;--r>=0;){const n=r;let i=r-1;i<0&&(i=e.length-1);for(let e=0,r=s+2*p;e<r;e++){const r=C*e,a=C*(e+1);U(t+n+r,t+i+r,t+i+a,t+n+a)}}}function N(e,t,r){a.push(e),a.push(t),a.push(r)}function F(e,t,i){z(e),z(t),z(i);const a=n.length/3,o=m.generateTopUV(r,n,a-3,a-2,a-1);H(o[0]),H(o[1]),H(o[2])}function U(e,t,i,a){z(e),z(t),z(a),z(t),z(i),z(a);const o=n.length/3,s=m.generateSideWallUV(r,n,o-6,o-3,o-2,o-1);H(s[0]),H(s[1]),H(s[3]),H(s[1]),H(s[2]),H(s[3])}function z(e){n.push(a[3*e+0]),n.push(a[3*e+1]),n.push(a[3*e+2])}function H(e){i.push(e.x),i.push(e.y)}!function(){const e=n.length/3;if(c){let e=0,t=C*e;for(let e=0;e<L;e++){const r=T[e];F(r[2]+t,r[1]+t,r[0]+t)}e=s+2*p,t=C*e;for(let e=0;e<L;e++){const r=T[e];F(r[0]+t,r[1]+t,r[2]+t)}}else{for(let e=0;e<L;e++){const t=T[e];F(t[2],t[1],t[0])}for(let e=0;e<L;e++){const t=T[e];F(t[0]+C*s,t[1]+C*s,t[2]+C*s)}}r.addGroup(e,n.length/3-e,0)}(),function(){const e=n.length/3;let t=0;B(A,t),t+=A.length;for(let e=0,r=M.length;e<r;e++){const r=M[e];B(r,t),t+=r.length}r.addGroup(e,n.length/3-e,1)}()}this.setAttribute("position",new Float32BufferAttribute(n,3)),this.setAttribute("uv",new Float32BufferAttribute(i,2)),this.computeVertexNormals()}toJSON(){const e=BufferGeometry.prototype.toJSON.call(this);return toJSON(this.parameters.shapes,this.parameters.options,e)}}const WorldUVGenerator={generateTopUV:function(e,t,r,n,i){const a=t[3*r],o=t[3*r+1],s=t[3*n],l=t[3*n+1],c=t[3*i],h=t[3*i+1];return[new Vector2(a,o),new Vector2(s,l),new Vector2(c,h)]},generateSideWallUV:function(e,t,r,n,i,a){const o=t[3*r],s=t[3*r+1],l=t[3*r+2],c=t[3*n],h=t[3*n+1],u=t[3*n+2],d=t[3*i],p=t[3*i+1],f=t[3*i+2],m=t[3*a],g=t[3*a+1],y=t[3*a+2];return Math.abs(s-h)<.01?[new Vector2(o,1-l),new Vector2(c,1-u),new Vector2(d,1-f),new Vector2(m,1-y)]:[new Vector2(s,1-l),new Vector2(h,1-u),new Vector2(p,1-f),new Vector2(g,1-y)]}};function toJSON(e,t,r){if(r.shapes=[],Array.isArray(e))for(let t=0,n=e.length;t<n;t++){const n=e[t];r.shapes.push(n.uuid)}else r.shapes.push(e.uuid);return void 0!==t.extrudePath&&(r.options.extrudePath=t.extrudePath.toJSON()),r}class IcosahedronGeometry extends PolyhedronGeometry{constructor(e=1,t=0){const r=(1+Math.sqrt(5))/2;super([-1,r,0,1,r,0,-1,-r,0,1,-r,0,0,-1,r,0,1,r,0,-1,-r,0,1,-r,r,0,-1,r,0,1,-r,0,-1,-r,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,t),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t}}}class LatheGeometry extends BufferGeometry{constructor(e,t=12,r=0,n=2*Math.PI){super(),this.type="LatheGeometry",this.parameters={points:e,segments:t,phiStart:r,phiLength:n},t=Math.floor(t),n=MathUtils.clamp(n,0,2*Math.PI);const i=[],a=[],o=[],s=1/t,l=new Vector3,c=new Vector2;for(let i=0;i<=t;i++){const h=r+i*s*n,u=Math.sin(h),d=Math.cos(h);for(let r=0;r<=e.length-1;r++)l.x=e[r].x*u,l.y=e[r].y,l.z=e[r].x*d,a.push(l.x,l.y,l.z),c.x=i/t,c.y=r/(e.length-1),o.push(c.x,c.y)}for(let r=0;r<t;r++)for(let t=0;t<e.length-1;t++){const n=t+r*e.length,a=n,o=n+e.length,s=n+e.length+1,l=n+1;i.push(a,o,l),i.push(o,s,l)}if(this.setIndex(i),this.setAttribute("position",new Float32BufferAttribute(a,3)),this.setAttribute("uv",new Float32BufferAttribute(o,2)),this.computeVertexNormals(),n===2*Math.PI){const r=this.attributes.normal.array,n=new Vector3,i=new Vector3,a=new Vector3,o=t*e.length*3;for(let t=0,s=0;t<e.length;t++,s+=3)n.x=r[s+0],n.y=r[s+1],n.z=r[s+2],i.x=r[o+s+0],i.y=r[o+s+1],i.z=r[o+s+2],a.addVectors(n,i).normalize(),r[s+0]=r[o+s+0]=a.x,r[s+1]=r[o+s+1]=a.y,r[s+2]=r[o+s+2]=a.z}}}class OctahedronGeometry extends PolyhedronGeometry{constructor(e=1,t=0){super([1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],e,t),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t}}}function ParametricGeometry(e,t,r){BufferGeometry.call(this),this.type="ParametricGeometry",this.parameters={func:e,slices:t,stacks:r};const n=[],i=[],a=[],o=[],s=1e-5,l=new Vector3,c=new Vector3,h=new Vector3,u=new Vector3,d=new Vector3;e.length<3&&console.error("THREE.ParametricGeometry: Function must now modify a Vector3 as third parameter.");const p=t+1;for(let n=0;n<=r;n++){const p=n/r;for(let r=0;r<=t;r++){const n=r/t;e(n,p,c),i.push(c.x,c.y,c.z),n-s>=0?(e(n-s,p,h),u.subVectors(c,h)):(e(n+s,p,h),u.subVectors(h,c)),p-s>=0?(e(n,p-s,h),d.subVectors(c,h)):(e(n,p+s,h),d.subVectors(h,c)),l.crossVectors(u,d).normalize(),a.push(l.x,l.y,l.z),o.push(n,p)}}for(let e=0;e<r;e++)for(let r=0;r<t;r++){const t=e*p+r,i=e*p+r+1,a=(e+1)*p+r+1,o=(e+1)*p+r;n.push(t,i,o),n.push(i,a,o)}this.setIndex(n),this.setAttribute("position",new Float32BufferAttribute(i,3)),this.setAttribute("normal",new Float32BufferAttribute(a,3)),this.setAttribute("uv",new Float32BufferAttribute(o,2))}ParametricGeometry.prototype=Object.create(BufferGeometry.prototype),ParametricGeometry.prototype.constructor=ParametricGeometry;class RingGeometry extends BufferGeometry{constructor(e=.5,t=1,r=8,n=1,i=0,a=2*Math.PI){super(),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:r,phiSegments:n,thetaStart:i,thetaLength:a},r=Math.max(3,r);const o=[],s=[],l=[],c=[];let h=e;const u=(t-e)/(n=Math.max(1,n)),d=new Vector3,p=new Vector2;for(let e=0;e<=n;e++){for(let e=0;e<=r;e++){const n=i+e/r*a;d.x=h*Math.cos(n),d.y=h*Math.sin(n),s.push(d.x,d.y,d.z),l.push(0,0,1),p.x=(d.x/t+1)/2,p.y=(d.y/t+1)/2,c.push(p.x,p.y)}h+=u}for(let e=0;e<n;e++){const t=e*(r+1);for(let e=0;e<r;e++){const n=e+t,i=n,a=n+r+1,s=n+r+2,l=n+1;o.push(i,a,l),o.push(a,s,l)}}this.setIndex(o),this.setAttribute("position",new Float32BufferAttribute(s,3)),this.setAttribute("normal",new Float32BufferAttribute(l,3)),this.setAttribute("uv",new Float32BufferAttribute(c,2))}}class ShapeGeometry extends BufferGeometry{constructor(e,t=12){super(),this.type="ShapeGeometry",this.parameters={shapes:e,curveSegments:t};const r=[],n=[],i=[],a=[];let o=0,s=0;if(!1===Array.isArray(e))l(e);else for(let t=0;t<e.length;t++)l(e[t]),this.addGroup(o,s,t),o+=s,s=0;function l(e){const o=n.length/3,l=e.extractPoints(t);let c=l.shape;const h=l.holes;!1===ShapeUtils.isClockWise(c)&&(c=c.reverse());for(let e=0,t=h.length;e<t;e++){const t=h[e];!0===ShapeUtils.isClockWise(t)&&(h[e]=t.reverse())}const u=ShapeUtils.triangulateShape(c,h);for(let e=0,t=h.length;e<t;e++){const t=h[e];c=c.concat(t)}for(let e=0,t=c.length;e<t;e++){const t=c[e];n.push(t.x,t.y,0),i.push(0,0,1),a.push(t.x,t.y)}for(let e=0,t=u.length;e<t;e++){const t=u[e],n=t[0]+o,i=t[1]+o,a=t[2]+o;r.push(n,i,a),s+=3}}this.setIndex(r),this.setAttribute("position",new Float32BufferAttribute(n,3)),this.setAttribute("normal",new Float32BufferAttribute(i,3)),this.setAttribute("uv",new Float32BufferAttribute(a,2))}toJSON(){const e=BufferGeometry.prototype.toJSON.call(this);return toJSON$1(this.parameters.shapes,e)}}function toJSON$1(e,t){if(t.shapes=[],Array.isArray(e))for(let r=0,n=e.length;r<n;r++){const n=e[r];t.shapes.push(n.uuid)}else t.shapes.push(e.uuid);return t}class SphereGeometry extends BufferGeometry{constructor(e=1,t=8,r=6,n=0,i=2*Math.PI,a=0,o=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:r,phiStart:n,phiLength:i,thetaStart:a,thetaLength:o},t=Math.max(3,Math.floor(t)),r=Math.max(2,Math.floor(r));const s=Math.min(a+o,Math.PI);let l=0;const c=[],h=new Vector3,u=new Vector3,d=[],p=[],f=[],m=[];for(let d=0;d<=r;d++){const g=[],y=d/r;let v=0;0==d&&0==a?v=.5/t:d==r&&s==Math.PI&&(v=-.5/t);for(let r=0;r<=t;r++){const s=r/t;h.x=-e*Math.cos(n+s*i)*Math.sin(a+y*o),h.y=e*Math.cos(a+y*o),h.z=e*Math.sin(n+s*i)*Math.sin(a+y*o),p.push(h.x,h.y,h.z),u.copy(h).normalize(),f.push(u.x,u.y,u.z),m.push(s+v,1-y),g.push(l++)}c.push(g)}for(let e=0;e<r;e++)for(let n=0;n<t;n++){const t=c[e][n+1],i=c[e][n],o=c[e+1][n],l=c[e+1][n+1];(0!==e||a>0)&&d.push(t,i,l),(e!==r-1||s<Math.PI)&&d.push(i,o,l)}this.setIndex(d),this.setAttribute("position",new Float32BufferAttribute(p,3)),this.setAttribute("normal",new Float32BufferAttribute(f,3)),this.setAttribute("uv",new Float32BufferAttribute(m,2))}}class TetrahedronGeometry extends PolyhedronGeometry{constructor(e=1,t=0){super([1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],e,t),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t}}}class TextGeometry extends ExtrudeGeometry{constructor(e,t={}){const r=t.font;if(!r||!r.isFont)return console.error("THREE.TextGeometry: font parameter is not an instance of THREE.Font."),new BufferGeometry;const n=r.generateShapes(e,t.size);t.depth=void 0!==t.height?t.height:50,void 0===t.bevelThickness&&(t.bevelThickness=10),void 0===t.bevelSize&&(t.bevelSize=8),void 0===t.bevelEnabled&&(t.bevelEnabled=!1),super(n,t),this.type="TextGeometry"}}class TorusGeometry extends BufferGeometry{constructor(e=1,t=.4,r=8,n=6,i=2*Math.PI){super(),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:r,tubularSegments:n,arc:i},r=Math.floor(r),n=Math.floor(n);const a=[],o=[],s=[],l=[],c=new Vector3,h=new Vector3,u=new Vector3;for(let a=0;a<=r;a++)for(let d=0;d<=n;d++){const p=d/n*i,f=a/r*Math.PI*2;h.x=(e+t*Math.cos(f))*Math.cos(p),h.y=(e+t*Math.cos(f))*Math.sin(p),h.z=t*Math.sin(f),o.push(h.x,h.y,h.z),c.x=e*Math.cos(p),c.y=e*Math.sin(p),u.subVectors(h,c).normalize(),s.push(u.x,u.y,u.z),l.push(d/n),l.push(a/r)}for(let e=1;e<=r;e++)for(let t=1;t<=n;t++){const r=(n+1)*e+t-1,i=(n+1)*(e-1)+t-1,o=(n+1)*(e-1)+t,s=(n+1)*e+t;a.push(r,i,s),a.push(i,o,s)}this.setIndex(a),this.setAttribute("position",new Float32BufferAttribute(o,3)),this.setAttribute("normal",new Float32BufferAttribute(s,3)),this.setAttribute("uv",new Float32BufferAttribute(l,2))}}class TorusKnotGeometry extends BufferGeometry{constructor(e=1,t=.4,r=64,n=8,i=2,a=3){super(),this.type="TorusKnotGeometry",this.parameters={radius:e,tube:t,tubularSegments:r,radialSegments:n,p:i,q:a},r=Math.floor(r),n=Math.floor(n);const o=[],s=[],l=[],c=[],h=new Vector3,u=new Vector3,d=new Vector3,p=new Vector3,f=new Vector3,m=new Vector3,g=new Vector3;for(let o=0;o<=r;++o){const v=o/r*i*Math.PI*2;y(v,i,a,e,d),y(v+.01,i,a,e,p),m.subVectors(p,d),g.addVectors(p,d),f.crossVectors(m,g),g.crossVectors(f,m),f.normalize(),g.normalize();for(let e=0;e<=n;++e){const i=e/n*Math.PI*2,a=-t*Math.cos(i),p=t*Math.sin(i);h.x=d.x+(a*g.x+p*f.x),h.y=d.y+(a*g.y+p*f.y),h.z=d.z+(a*g.z+p*f.z),s.push(h.x,h.y,h.z),u.subVectors(h,d).normalize(),l.push(u.x,u.y,u.z),c.push(o/r),c.push(e/n)}}for(let e=1;e<=r;e++)for(let t=1;t<=n;t++){const r=(n+1)*(e-1)+(t-1),i=(n+1)*e+(t-1),a=(n+1)*e+t,s=(n+1)*(e-1)+t;o.push(r,i,s),o.push(i,a,s)}function y(e,t,r,n,i){const a=Math.cos(e),o=Math.sin(e),s=r/t*e,l=Math.cos(s);i.x=n*(2+l)*.5*a,i.y=n*(2+l)*o*.5,i.z=n*Math.sin(s)*.5}this.setIndex(o),this.setAttribute("position",new Float32BufferAttribute(s,3)),this.setAttribute("normal",new Float32BufferAttribute(l,3)),this.setAttribute("uv",new Float32BufferAttribute(c,2))}}class TubeGeometry extends BufferGeometry{constructor(e,t=64,r=1,n=8,i=!1){super(),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:r,radialSegments:n,closed:i};const a=e.computeFrenetFrames(t,i);this.tangents=a.tangents,this.normals=a.normals,this.binormals=a.binormals;const o=new Vector3,s=new Vector3,l=new Vector2;let c=new Vector3;const h=[],u=[],d=[],p=[];function f(i){c=e.getPointAt(i/t,c);const l=a.normals[i],d=a.binormals[i];for(let e=0;e<=n;e++){const t=e/n*Math.PI*2,i=Math.sin(t),a=-Math.cos(t);s.x=a*l.x+i*d.x,s.y=a*l.y+i*d.y,s.z=a*l.z+i*d.z,s.normalize(),u.push(s.x,s.y,s.z),o.x=c.x+r*s.x,o.y=c.y+r*s.y,o.z=c.z+r*s.z,h.push(o.x,o.y,o.z)}}!function(){for(let e=0;e<t;e++)f(e);f(!1===i?t:0),function(){for(let e=0;e<=t;e++)for(let r=0;r<=n;r++)l.x=e/t,l.y=r/n,d.push(l.x,l.y)}(),function(){for(let e=1;e<=t;e++)for(let t=1;t<=n;t++){const r=(n+1)*(e-1)+(t-1),i=(n+1)*e+(t-1),a=(n+1)*e+t,o=(n+1)*(e-1)+t;p.push(r,i,o),p.push(i,a,o)}}()}(),this.setIndex(p),this.setAttribute("position",new Float32BufferAttribute(h,3)),this.setAttribute("normal",new Float32BufferAttribute(u,3)),this.setAttribute("uv",new Float32BufferAttribute(d,2))}toJSON(){const e=BufferGeometry.prototype.toJSON.call(this);return e.path=this.parameters.path.toJSON(),e}}class WireframeGeometry extends BufferGeometry{constructor(e){if(super(),this.type="WireframeGeometry",!0===e.isGeometry)return void console.error("THREE.WireframeGeometry no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");const t=[],r=[0,0],n={},i=new Vector3;if(null!==e.index){const a=e.attributes.position,o=e.index;let s=e.groups;0===s.length&&(s=[{start:0,count:o.count,materialIndex:0}]);for(let e=0,t=s.length;e<t;++e){const t=s[e],i=t.start;for(let e=i,a=i+t.count;e<a;e+=3)for(let t=0;t<3;t++){const i=o.getX(e+t),a=o.getX(e+(t+1)%3);r[0]=Math.min(i,a),r[1]=Math.max(i,a);const s=r[0]+","+r[1];void 0===n[s]&&(n[s]={index1:r[0],index2:r[1]})}}for(const e in n){const r=n[e];i.fromBufferAttribute(a,r.index1),t.push(i.x,i.y,i.z),i.fromBufferAttribute(a,r.index2),t.push(i.x,i.y,i.z)}}else{const r=e.attributes.position;for(let e=0,n=r.count/3;e<n;e++)for(let n=0;n<3;n++){const a=3*e+n;i.fromBufferAttribute(r,a),t.push(i.x,i.y,i.z);const o=3*e+(n+1)%3;i.fromBufferAttribute(r,o),t.push(i.x,i.y,i.z)}}this.setAttribute("position",new Float32BufferAttribute(t,3))}}var Geometries=Object.freeze({__proto__:null,BoxGeometry:BoxGeometry,BoxBufferGeometry:BoxGeometry,CircleGeometry:CircleGeometry,CircleBufferGeometry:CircleGeometry,ConeGeometry:ConeGeometry,ConeBufferGeometry:ConeGeometry,CylinderGeometry:CylinderGeometry,CylinderBufferGeometry:CylinderGeometry,DodecahedronGeometry:DodecahedronGeometry,DodecahedronBufferGeometry:DodecahedronGeometry,EdgesGeometry:EdgesGeometry,ExtrudeGeometry:ExtrudeGeometry,ExtrudeBufferGeometry:ExtrudeGeometry,IcosahedronGeometry:IcosahedronGeometry,IcosahedronBufferGeometry:IcosahedronGeometry,LatheGeometry:LatheGeometry,LatheBufferGeometry:LatheGeometry,OctahedronGeometry:OctahedronGeometry,OctahedronBufferGeometry:OctahedronGeometry,ParametricGeometry:ParametricGeometry,ParametricBufferGeometry:ParametricGeometry,PlaneGeometry:PlaneGeometry,PlaneBufferGeometry:PlaneGeometry,PolyhedronGeometry:PolyhedronGeometry,PolyhedronBufferGeometry:PolyhedronGeometry,RingGeometry:RingGeometry,RingBufferGeometry:RingGeometry,ShapeGeometry:ShapeGeometry,ShapeBufferGeometry:ShapeGeometry,SphereGeometry:SphereGeometry,SphereBufferGeometry:SphereGeometry,TetrahedronGeometry:TetrahedronGeometry,TetrahedronBufferGeometry:TetrahedronGeometry,TextGeometry:TextGeometry,TextBufferGeometry:TextGeometry,TorusGeometry:TorusGeometry,TorusBufferGeometry:TorusGeometry,TorusKnotGeometry:TorusKnotGeometry,TorusKnotBufferGeometry:TorusKnotGeometry,TubeGeometry:TubeGeometry,TubeBufferGeometry:TubeGeometry,WireframeGeometry:WireframeGeometry});class ShadowMaterial extends Material$1{constructor(e){super(),this.type="ShadowMaterial",this.color=new Color(0),this.transparent=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this}}ShadowMaterial.prototype.isShadowMaterial=!0;class RawShaderMaterial extends ShaderMaterial{constructor(e){super(e),this.type="RawShaderMaterial"}}function MeshStandardMaterial(e){Material$1.call(this),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new Color(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=TangentSpaceNormalMap,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.flatShading=!1,this.vertexTangents=!1,this.setValues(e)}function MeshPhysicalMaterial(e){MeshStandardMaterial.call(this),this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.clearcoat=0,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new Vector2(1,1),this.clearcoatNormalMap=null,this.reflectivity=.5,Object.defineProperty(this,"ior",{get:function(){return(1+.4*this.reflectivity)/(1-.4*this.reflectivity)},set:function(e){this.reflectivity=MathUtils.clamp(2.5*(e-1)/(e+1),0,1)}}),this.sheen=null,this.transmission=0,this.transmissionMap=null,this.setValues(e)}RawShaderMaterial.prototype.isRawShaderMaterial=!0,MeshStandardMaterial.prototype=Object.create(Material$1.prototype),MeshStandardMaterial.prototype.constructor=MeshStandardMaterial,MeshStandardMaterial.prototype.isMeshStandardMaterial=!0,MeshStandardMaterial.prototype.copy=function(e){return Material$1.prototype.copy.call(this,e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapIntensity=e.envMapIntensity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.flatShading=e.flatShading,this.vertexTangents=e.vertexTangents,this},MeshPhysicalMaterial.prototype=Object.create(MeshStandardMaterial.prototype),MeshPhysicalMaterial.prototype.constructor=MeshPhysicalMaterial,MeshPhysicalMaterial.prototype.isMeshPhysicalMaterial=!0,MeshPhysicalMaterial.prototype.copy=function(e){return MeshStandardMaterial.prototype.copy.call(this,e),this.defines={STANDARD:"",PHYSICAL:""},this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.reflectivity=e.reflectivity,e.sheen?this.sheen=(this.sheen||new Color).copy(e.sheen):this.sheen=null,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this};class MeshPhongMaterial extends Material$1{constructor(e){super(),this.type="MeshPhongMaterial",this.color=new Color(16777215),this.specular=new Color(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=TangentSpaceNormalMap,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.flatShading=e.flatShading,this}}MeshPhongMaterial.prototype.isMeshPhongMaterial=!0;class MeshToonMaterial extends Material$1{constructor(e){super(),this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new Color(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=TangentSpaceNormalMap,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.gradientMap=e.gradientMap,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this}}MeshToonMaterial.prototype.isMeshToonMaterial=!0;class MeshNormalMaterial extends Material$1{constructor(e){super(),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=TangentSpaceNormalMap,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.flatShading=e.flatShading,this}}MeshNormalMaterial.prototype.isMeshNormalMaterial=!0;class MeshLambertMaterial extends Material$1{constructor(e){super(),this.type="MeshLambertMaterial",this.color=new Color(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this}}MeshLambertMaterial.prototype.isMeshLambertMaterial=!0;class MeshMatcapMaterial extends Material$1{constructor(e){super(),this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new Color(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=TangentSpaceNormalMap,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.defines={MATCAP:""},this.color.copy(e.color),this.matcap=e.matcap,this.map=e.map,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.flatShading=e.flatShading,this}}MeshMatcapMaterial.prototype.isMeshMatcapMaterial=!0;class LineDashedMaterial extends LineBasicMaterial{constructor(e){super(),this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(e)}copy(e){return super.copy(e),this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this}}LineDashedMaterial.prototype.isLineDashedMaterial=!0;var Materials=Object.freeze({__proto__:null,ShadowMaterial:ShadowMaterial,SpriteMaterial:SpriteMaterial,RawShaderMaterial:RawShaderMaterial,ShaderMaterial:ShaderMaterial,PointsMaterial:PointsMaterial,MeshPhysicalMaterial:MeshPhysicalMaterial,MeshStandardMaterial:MeshStandardMaterial,MeshPhongMaterial:MeshPhongMaterial,MeshToonMaterial:MeshToonMaterial,MeshNormalMaterial:MeshNormalMaterial,MeshLambertMaterial:MeshLambertMaterial,MeshDepthMaterial:MeshDepthMaterial,MeshDistanceMaterial:MeshDistanceMaterial,MeshBasicMaterial:MeshBasicMaterial,MeshMatcapMaterial:MeshMatcapMaterial,LineDashedMaterial:LineDashedMaterial,LineBasicMaterial:LineBasicMaterial,Material:Material$1});const AnimationUtils={arraySlice:function(e,t,r){return AnimationUtils.isTypedArray(e)?new e.constructor(e.subarray(t,void 0!==r?r:e.length)):e.slice(t,r)},convertArray:function(e,t,r){return!e||!r&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e)},isTypedArray:function(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)},getKeyframeOrder:function(e){const t=e.length,r=new Array(t);for(let e=0;e!==t;++e)r[e]=e;return r.sort((function(t,r){return e[t]-e[r]})),r},sortedArray:function(e,t,r){const n=e.length,i=new e.constructor(n);for(let a=0,o=0;o!==n;++a){const n=r[a]*t;for(let r=0;r!==t;++r)i[o++]=e[n+r]}return i},flattenJSON:function(e,t,r,n){let i=1,a=e[0];for(;void 0!==a&&void 0===a[n];)a=e[i++];if(void 0===a)return;let o=a[n];if(void 0!==o)if(Array.isArray(o))do{o=a[n],void 0!==o&&(t.push(a.time),r.push.apply(r,o)),a=e[i++]}while(void 0!==a);else if(void 0!==o.toArray)do{o=a[n],void 0!==o&&(t.push(a.time),o.toArray(r,r.length)),a=e[i++]}while(void 0!==a);else do{o=a[n],void 0!==o&&(t.push(a.time),r.push(o)),a=e[i++]}while(void 0!==a)},subclip:function(e,t,r,n,i=30){const a=e.clone();a.name=t;const o=[];for(let e=0;e<a.tracks.length;++e){const t=a.tracks[e],s=t.getValueSize(),l=[],c=[];for(let e=0;e<t.times.length;++e){const a=t.times[e]*i;if(!(a<r||a>=n)){l.push(t.times[e]);for(let r=0;r<s;++r)c.push(t.values[e*s+r])}}0!==l.length&&(t.times=AnimationUtils.convertArray(l,t.times.constructor),t.values=AnimationUtils.convertArray(c,t.values.constructor),o.push(t))}a.tracks=o;let s=1/0;for(let e=0;e<a.tracks.length;++e)s>a.tracks[e].times[0]&&(s=a.tracks[e].times[0]);for(let e=0;e<a.tracks.length;++e)a.tracks[e].shift(-1*s);return a.resetDuration(),a},makeClipAdditive:function(e,t=0,r=e,n=30){n<=0&&(n=30);const i=r.tracks.length,a=t/n;for(let t=0;t<i;++t){const n=r.tracks[t],i=n.ValueTypeName;if("bool"===i||"string"===i)continue;const o=e.tracks.find((function(e){return e.name===n.name&&e.ValueTypeName===i}));if(void 0===o)continue;let s=0;const l=n.getValueSize();n.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(s=l/3);let c=0;const h=o.getValueSize();o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(c=h/3);const u=n.times.length-1;let d;if(a<=n.times[0]){const e=s,t=l-s;d=AnimationUtils.arraySlice(n.values,e,t)}else if(a>=n.times[u]){const e=u*l+s,t=e+l-s;d=AnimationUtils.arraySlice(n.values,e,t)}else{const e=n.createInterpolant(),t=s,r=l-s;e.evaluate(a),d=AnimationUtils.arraySlice(e.resultBuffer,t,r)}if("quaternion"===i){(new Quaternion).fromArray(d).normalize().conjugate().toArray(d)}const p=o.times.length;for(let e=0;e<p;++e){const t=e*h+c;if("quaternion"===i)Quaternion.multiplyQuaternionsFlat(o.values,t,d,0,o.values,t);else{const e=h-2*c;for(let r=0;r<e;++r)o.values[t+r]-=d[r]}}}return e.blendMode=AdditiveAnimationBlendMode,e}};function Interpolant(e,t,r,n){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==n?n:new t.constructor(r),this.sampleValues=t,this.valueSize=r}function CubicInterpolant(e,t,r,n){Interpolant.call(this,e,t,r,n),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0}function LinearInterpolant(e,t,r,n){Interpolant.call(this,e,t,r,n)}function DiscreteInterpolant(e,t,r,n){Interpolant.call(this,e,t,r,n)}Object.assign(Interpolant.prototype,{evaluate:function(e){const t=this.parameterPositions;let r=this._cachedIndex,n=t[r],i=t[r-1];e:{t:{let a;r:{n:if(!(e<n)){for(let a=r+2;;){if(void 0===n){if(e<i)break n;return r=t.length,this._cachedIndex=r,this.afterEnd_(r-1,e,i)}if(r===a)break;if(i=n,n=t[++r],e<n)break t}a=t.length;break r}if(e>=i)break e;{const o=t[1];e<o&&(r=2,i=o);for(let a=r-2;;){if(void 0===i)return this._cachedIndex=0,this.beforeStart_(0,e,n);if(r===a)break;if(n=i,i=t[--r-1],e>=i)break t}a=r,r=0}}for(;r<a;){const n=r+a>>>1;e<t[n]?a=n:r=n+1}if(n=t[r],i=t[r-1],void 0===i)return this._cachedIndex=0,this.beforeStart_(0,e,n);if(void 0===n)return r=t.length,this._cachedIndex=r,this.afterEnd_(r-1,i,e)}this._cachedIndex=r,this.intervalChanged_(r,i,n)}return this.interpolate_(r,i,e,n)},settings:null,DefaultSettings_:{},getSettings_:function(){return this.settings||this.DefaultSettings_},copySampleValue_:function(e){const t=this.resultBuffer,r=this.sampleValues,n=this.valueSize,i=e*n;for(let e=0;e!==n;++e)t[e]=r[i+e];return t},interpolate_:function(){throw new Error("call to abstract method")},intervalChanged_:function(){}}),Object.assign(Interpolant.prototype,{beforeStart_:Interpolant.prototype.copySampleValue_,afterEnd_:Interpolant.prototype.copySampleValue_}),CubicInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:CubicInterpolant,DefaultSettings_:{endingStart:ZeroCurvatureEnding,endingEnd:ZeroCurvatureEnding},intervalChanged_:function(e,t,r){const n=this.parameterPositions;let i=e-2,a=e+1,o=n[i],s=n[a];if(void 0===o)switch(this.getSettings_().endingStart){case ZeroSlopeEnding:i=e,o=2*t-r;break;case WrapAroundEnding:i=n.length-2,o=t+n[i]-n[i+1];break;default:i=e,o=r}if(void 0===s)switch(this.getSettings_().endingEnd){case ZeroSlopeEnding:a=e,s=2*r-t;break;case WrapAroundEnding:a=1,s=r+n[1]-n[0];break;default:a=e-1,s=t}const l=.5*(r-t),c=this.valueSize;this._weightPrev=l/(t-o),this._weightNext=l/(s-r),this._offsetPrev=i*c,this._offsetNext=a*c},interpolate_:function(e,t,r,n){const i=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=e*o,l=s-o,c=this._offsetPrev,h=this._offsetNext,u=this._weightPrev,d=this._weightNext,p=(r-t)/(n-t),f=p*p,m=f*p,g=-u*m+2*u*f-u*p,y=(1+u)*m+(-1.5-2*u)*f+(-.5+u)*p+1,v=(-1-d)*m+(1.5+d)*f+.5*p,b=d*m-d*f;for(let e=0;e!==o;++e)i[e]=g*a[c+e]+y*a[l+e]+v*a[s+e]+b*a[h+e];return i}}),LinearInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:LinearInterpolant,interpolate_:function(e,t,r,n){const i=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=e*o,l=s-o,c=(r-t)/(n-t),h=1-c;for(let e=0;e!==o;++e)i[e]=a[l+e]*h+a[s+e]*c;return i}}),DiscreteInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:DiscreteInterpolant,interpolate_:function(e){return this.copySampleValue_(e-1)}});class KeyframeTrack{constructor(e,t,r,n){if(void 0===e)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===t||0===t.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+e);this.name=e,this.times=AnimationUtils.convertArray(t,this.TimeBufferType),this.values=AnimationUtils.convertArray(r,this.ValueBufferType),this.setInterpolation(n||this.DefaultInterpolation)}static toJSON(e){const t=e.constructor;let r;if(t.toJSON!==this.toJSON)r=t.toJSON(e);else{r={name:e.name,times:AnimationUtils.convertArray(e.times,Array),values:AnimationUtils.convertArray(e.values,Array)};const t=e.getInterpolation();t!==e.DefaultInterpolation&&(r.interpolation=t)}return r.type=e.ValueTypeName,r}InterpolantFactoryMethodDiscrete(e){return new DiscreteInterpolant(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodLinear(e){return new LinearInterpolant(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodSmooth(e){return new CubicInterpolant(this.times,this.values,this.getValueSize(),e)}setInterpolation(e){let t;switch(e){case InterpolateDiscrete:t=this.InterpolantFactoryMethodDiscrete;break;case InterpolateLinear:t=this.InterpolantFactoryMethodLinear;break;case InterpolateSmooth:t=this.InterpolantFactoryMethodSmooth}if(void 0===t){const t="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(t);this.setInterpolation(this.DefaultInterpolation)}return console.warn("THREE.KeyframeTrack:",t),this}return this.createInterpolant=t,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return InterpolateDiscrete;case this.InterpolantFactoryMethodLinear:return InterpolateLinear;case this.InterpolantFactoryMethodSmooth:return InterpolateSmooth}}getValueSize(){return this.values.length/this.times.length}shift(e){if(0!==e){const t=this.times;for(let r=0,n=t.length;r!==n;++r)t[r]+=e}return this}scale(e){if(1!==e){const t=this.times;for(let r=0,n=t.length;r!==n;++r)t[r]*=e}return this}trim(e,t){const r=this.times,n=r.length;let i=0,a=n-1;for(;i!==n&&r[i]<e;)++i;for(;-1!==a&&r[a]>t;)--a;if(++a,0!==i||a!==n){i>=a&&(a=Math.max(a,1),i=a-1);const e=this.getValueSize();this.times=AnimationUtils.arraySlice(r,i,a),this.values=AnimationUtils.arraySlice(this.values,i*e,a*e)}return this}validate(){let e=!0;const t=this.getValueSize();t-Math.floor(t)!=0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),e=!1);const r=this.times,n=this.values,i=r.length;0===i&&(console.error("THREE.KeyframeTrack: Track is empty.",this),e=!1);let a=null;for(let t=0;t!==i;t++){const n=r[t];if("number"==typeof n&&isNaN(n)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,t,n),e=!1;break}if(null!==a&&a>n){console.error("THREE.KeyframeTrack: Out of order keys.",this,t,n,a),e=!1;break}a=n}if(void 0!==n&&AnimationUtils.isTypedArray(n))for(let t=0,r=n.length;t!==r;++t){const r=n[t];if(isNaN(r)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,t,r),e=!1;break}}return e}optimize(){const e=AnimationUtils.arraySlice(this.times),t=AnimationUtils.arraySlice(this.values),r=this.getValueSize(),n=this.getInterpolation()===InterpolateSmooth,i=e.length-1;let a=1;for(let o=1;o<i;++o){let i=!1;const s=e[o];if(s!==e[o+1]&&(1!==o||s!==e[0]))if(n)i=!0;else{const e=o*r,n=e-r,a=e+r;for(let o=0;o!==r;++o){const r=t[e+o];if(r!==t[n+o]||r!==t[a+o]){i=!0;break}}}if(i){if(o!==a){e[a]=e[o];const n=o*r,i=a*r;for(let e=0;e!==r;++e)t[i+e]=t[n+e]}++a}}if(i>0){e[a]=e[i];for(let e=i*r,n=a*r,o=0;o!==r;++o)t[n+o]=t[e+o];++a}return a!==e.length?(this.times=AnimationUtils.arraySlice(e,0,a),this.values=AnimationUtils.arraySlice(t,0,a*r)):(this.times=e,this.values=t),this}clone(){const e=AnimationUtils.arraySlice(this.times,0),t=AnimationUtils.arraySlice(this.values,0),r=new(0,this.constructor)(this.name,e,t);return r.createInterpolant=this.createInterpolant,r}}KeyframeTrack.prototype.TimeBufferType=Float32Array,KeyframeTrack.prototype.ValueBufferType=Float32Array,KeyframeTrack.prototype.DefaultInterpolation=InterpolateLinear;class BooleanKeyframeTrack extends KeyframeTrack{}BooleanKeyframeTrack.prototype.ValueTypeName="bool",BooleanKeyframeTrack.prototype.ValueBufferType=Array,BooleanKeyframeTrack.prototype.DefaultInterpolation=InterpolateDiscrete,BooleanKeyframeTrack.prototype.InterpolantFactoryMethodLinear=void 0,BooleanKeyframeTrack.prototype.InterpolantFactoryMethodSmooth=void 0;class ColorKeyframeTrack extends KeyframeTrack{}ColorKeyframeTrack.prototype.ValueTypeName="color";class NumberKeyframeTrack extends KeyframeTrack{}function QuaternionLinearInterpolant(e,t,r,n){Interpolant.call(this,e,t,r,n)}NumberKeyframeTrack.prototype.ValueTypeName="number",QuaternionLinearInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:QuaternionLinearInterpolant,interpolate_:function(e,t,r,n){const i=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=(r-t)/(n-t);let l=e*o;for(let e=l+o;l!==e;l+=4)Quaternion.slerpFlat(i,0,a,l-o,a,l,s);return i}});class QuaternionKeyframeTrack extends KeyframeTrack{InterpolantFactoryMethodLinear(e){return new QuaternionLinearInterpolant(this.times,this.values,this.getValueSize(),e)}}QuaternionKeyframeTrack.prototype.ValueTypeName="quaternion",QuaternionKeyframeTrack.prototype.DefaultInterpolation=InterpolateLinear,QuaternionKeyframeTrack.prototype.InterpolantFactoryMethodSmooth=void 0;class StringKeyframeTrack extends KeyframeTrack{}StringKeyframeTrack.prototype.ValueTypeName="string",StringKeyframeTrack.prototype.ValueBufferType=Array,StringKeyframeTrack.prototype.DefaultInterpolation=InterpolateDiscrete,StringKeyframeTrack.prototype.InterpolantFactoryMethodLinear=void 0,StringKeyframeTrack.prototype.InterpolantFactoryMethodSmooth=void 0;class VectorKeyframeTrack extends KeyframeTrack{}VectorKeyframeTrack.prototype.ValueTypeName="vector";class AnimationClip{constructor(e,t=-1,r,n=NormalAnimationBlendMode){this.name=e,this.tracks=r,this.duration=t,this.blendMode=n,this.uuid=MathUtils.generateUUID(),this.duration<0&&this.resetDuration()}static parse(e){const t=[],r=e.tracks,n=1/(e.fps||1);for(let e=0,i=r.length;e!==i;++e)t.push(parseKeyframeTrack(r[e]).scale(n));const i=new this(e.name,e.duration,t,e.blendMode);return i.uuid=e.uuid,i}static toJSON(e){const t=[],r=e.tracks,n={name:e.name,duration:e.duration,tracks:t,uuid:e.uuid,blendMode:e.blendMode};for(let e=0,n=r.length;e!==n;++e)t.push(KeyframeTrack.toJSON(r[e]));return n}static CreateFromMorphTargetSequence(e,t,r,n){const i=t.length,a=[];for(let e=0;e<i;e++){let o=[],s=[];o.push((e+i-1)%i,e,(e+1)%i),s.push(0,1,0);const l=AnimationUtils.getKeyframeOrder(o);o=AnimationUtils.sortedArray(o,1,l),s=AnimationUtils.sortedArray(s,1,l),n||0!==o[0]||(o.push(i),s.push(s[0])),a.push(new NumberKeyframeTrack(".morphTargetInfluences["+t[e].name+"]",o,s).scale(1/r))}return new this(e,-1,a)}static findByName(e,t){let r=e;if(!Array.isArray(e)){const t=e;r=t.geometry&&t.geometry.animations||t.animations}for(let e=0;e<r.length;e++)if(r[e].name===t)return r[e];return null}static CreateClipsFromMorphTargetSequences(e,t,r){const n={},i=/^([\w-]*?)([\d]+)$/;for(let t=0,r=e.length;t<r;t++){const r=e[t],a=r.name.match(i);if(a&&a.length>1){const e=a[1];let t=n[e];t||(n[e]=t=[]),t.push(r)}}const a=[];for(const e in n)a.push(this.CreateFromMorphTargetSequence(e,n[e],t,r));return a}static parseAnimation(e,t){if(!e)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;const r=function(e,t,r,n,i){if(0!==r.length){const a=[],o=[];AnimationUtils.flattenJSON(r,a,o,n),0!==a.length&&i.push(new e(t,a,o))}},n=[],i=e.name||"default",a=e.fps||30,o=e.blendMode;let s=e.length||-1;const l=e.hierarchy||[];for(let e=0;e<l.length;e++){const i=l[e].keys;if(i&&0!==i.length)if(i[0].morphTargets){const e={};let t;for(t=0;t<i.length;t++)if(i[t].morphTargets)for(let r=0;r<i[t].morphTargets.length;r++)e[i[t].morphTargets[r]]=-1;for(const r in e){const e=[],a=[];for(let n=0;n!==i[t].morphTargets.length;++n){const n=i[t];e.push(n.time),a.push(n.morphTarget===r?1:0)}n.push(new NumberKeyframeTrack(".morphTargetInfluence["+r+"]",e,a))}s=e.length*(a||1)}else{const a=".bones["+t[e].name+"]";r(VectorKeyframeTrack,a+".position",i,"pos",n),r(QuaternionKeyframeTrack,a+".quaternion",i,"rot",n),r(VectorKeyframeTrack,a+".scale",i,"scl",n)}}if(0===n.length)return null;return new this(i,s,n,o)}resetDuration(){let e=0;for(let t=0,r=this.tracks.length;t!==r;++t){const r=this.tracks[t];e=Math.max(e,r.times[r.times.length-1])}return this.duration=e,this}trim(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this}validate(){let e=!0;for(let t=0;t<this.tracks.length;t++)e=e&&this.tracks[t].validate();return e}optimize(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}clone(){const e=[];for(let t=0;t<this.tracks.length;t++)e.push(this.tracks[t].clone());return new this.constructor(this.name,this.duration,e,this.blendMode)}toJSON(){return this.constructor.toJSON(this)}}function getTrackTypeForValueTypeName(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return NumberKeyframeTrack;case"vector":case"vector2":case"vector3":case"vector4":return VectorKeyframeTrack;case"color":return ColorKeyframeTrack;case"quaternion":return QuaternionKeyframeTrack;case"bool":case"boolean":return BooleanKeyframeTrack;case"string":return StringKeyframeTrack}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+e)}function parseKeyframeTrack(e){if(void 0===e.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const t=getTrackTypeForValueTypeName(e.type);if(void 0===e.times){const t=[],r=[];AnimationUtils.flattenJSON(e.keys,t,r,"value"),e.times=t,e.values=r}return void 0!==t.parse?t.parse(e):new t(e.name,e.times,e.values,e.interpolation)}const Cache={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};function LoadingManager(e,t,r){const n=this;let i,a=!1,o=0,s=0;const l=[];this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=r,this.itemStart=function(e){s++,!1===a&&void 0!==n.onStart&&n.onStart(e,o,s),a=!0},this.itemEnd=function(e){o++,void 0!==n.onProgress&&n.onProgress(e,o,s),o===s&&(a=!1,void 0!==n.onLoad&&n.onLoad())},this.itemError=function(e){void 0!==n.onError&&n.onError(e)},this.resolveURL=function(e){return i?i(e):e},this.setURLModifier=function(e){return i=e,this},this.addHandler=function(e,t){return l.push(e,t),this},this.removeHandler=function(e){const t=l.indexOf(e);return-1!==t&&l.splice(t,2),this},this.getHandler=function(e){for(let t=0,r=l.length;t<r;t+=2){const r=l[t],n=l[t+1];if(r.global&&(r.lastIndex=0),r.test(e))return n}return null}}const DefaultLoadingManager=new LoadingManager;function Loader(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}Object.assign(Loader.prototype,{load:function(){},loadAsync:function(e,t){const r=this;return new Promise((function(n,i){r.load(e,n,t,i)}))},parse:function(){},setCrossOrigin:function(e){return this.crossOrigin=e,this},setWithCredentials:function(e){return this.withCredentials=e,this},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},setRequestHeader:function(e){return this.requestHeader=e,this}});const loading={};function FileLoader(e){Loader.call(this,e)}FileLoader.prototype=Object.assign(Object.create(Loader.prototype),{constructor:FileLoader,load:function(e,t,r,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const i=this,a=Cache.get(e);if(void 0!==a)return i.manager.itemStart(e),setTimeout((function(){t&&t(a),i.manager.itemEnd(e)}),0),a;if(void 0!==loading[e])return void loading[e].push({onLoad:t,onProgress:r,onError:n});const o=e.match(/^data:(.*?)(;base64)?,(.*)$/);let s;if(o){const r=o[1],a=!!o[2];let s=o[3];s=decodeURIComponent(s),a&&(s=atob(s));try{let n;const a=(this.responseType||"").toLowerCase();switch(a){case"arraybuffer":case"blob":const e=new Uint8Array(s.length);for(let t=0;t<s.length;t++)e[t]=s.charCodeAt(t);n="blob"===a?new Blob([e.buffer],{type:r}):e.buffer;break;case"document":const t=new DOMParser;n=t.parseFromString(s,r);break;case"json":n=JSON.parse(s);break;default:n=s}setTimeout((function(){t&&t(n),i.manager.itemEnd(e)}),0)}catch(t){setTimeout((function(){n&&n(t),i.manager.itemError(e),i.manager.itemEnd(e)}),0)}}else{loading[e]=[],loading[e].push({onLoad:t,onProgress:r,onError:n}),s=new XMLHttpRequest,s.open("GET",e,!0),s.addEventListener("load",(function(t){const r=this.response,n=loading[e];if(delete loading[e],200===this.status||0===this.status){0===this.status&&console.warn("THREE.FileLoader: HTTP Status 0 received."),Cache.add(e,r);for(let e=0,t=n.length;e<t;e++){const t=n[e];t.onLoad&&t.onLoad(r)}i.manager.itemEnd(e)}else{for(let e=0,r=n.length;e<r;e++){const r=n[e];r.onError&&r.onError(t)}i.manager.itemError(e),i.manager.itemEnd(e)}}),!1),s.addEventListener("progress",(function(t){const r=loading[e];for(let e=0,n=r.length;e<n;e++){const n=r[e];n.onProgress&&n.onProgress(t)}}),!1),s.addEventListener("error",(function(t){const r=loading[e];delete loading[e];for(let e=0,n=r.length;e<n;e++){const n=r[e];n.onError&&n.onError(t)}i.manager.itemError(e),i.manager.itemEnd(e)}),!1),s.addEventListener("abort",(function(t){const r=loading[e];delete loading[e];for(let e=0,n=r.length;e<n;e++){const n=r[e];n.onError&&n.onError(t)}i.manager.itemError(e),i.manager.itemEnd(e)}),!1),void 0!==this.responseType&&(s.responseType=this.responseType),void 0!==this.withCredentials&&(s.withCredentials=this.withCredentials),s.overrideMimeType&&s.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain");for(const e in this.requestHeader)s.setRequestHeader(e,this.requestHeader[e]);s.send(null)}return i.manager.itemStart(e),s},setResponseType:function(e){return this.responseType=e,this},setMimeType:function(e){return this.mimeType=e,this}});class AnimationLoader extends Loader{constructor(e){super(e)}load(e,t,r,n){const i=this,a=new FileLoader(this.manager);a.setPath(this.path),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,(function(r){try{t(i.parse(JSON.parse(r)))}catch(t){n?n(t):console.error(t),i.manager.itemError(e)}}),r,n)}parse(e){const t=[];for(let r=0;r<e.length;r++){const n=AnimationClip.parse(e[r]);t.push(n)}return t}}function CompressedTextureLoader(e){Loader.call(this,e)}CompressedTextureLoader.prototype=Object.assign(Object.create(Loader.prototype),{constructor:CompressedTextureLoader,load:function(e,t,r,n){const i=this,a=[],o=new CompressedTexture,s=new FileLoader(this.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),s.setWithCredentials(i.withCredentials);let l=0;function c(c){s.load(e[c],(function(e){const r=i.parse(e,!0);a[c]={width:r.width,height:r.height,format:r.format,mipmaps:r.mipmaps},l+=1,6===l&&(1===r.mipmapCount&&(o.minFilter=LinearFilter),o.image=a,o.format=r.format,o.needsUpdate=!0,t&&t(o))}),r,n)}if(Array.isArray(e))for(let t=0,r=e.length;t<r;++t)c(t);else s.load(e,(function(e){const r=i.parse(e,!0);if(r.isCubemap){const e=r.mipmaps.length/r.mipmapCount;for(let t=0;t<e;t++){a[t]={mipmaps:[]};for(let e=0;e<r.mipmapCount;e++)a[t].mipmaps.push(r.mipmaps[t*r.mipmapCount+e]),a[t].format=r.format,a[t].width=r.width,a[t].height=r.height}o.image=a}else o.image.width=r.width,o.image.height=r.height,o.mipmaps=r.mipmaps;1===r.mipmapCount&&(o.minFilter=LinearFilter),o.format=r.format,o.needsUpdate=!0,t&&t(o)}),r,n);return o}});class ImageLoader extends Loader{constructor(e){super(e)}load(e,t,r,n){void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const i=this,a=Cache.get(e);if(void 0!==a)return i.manager.itemStart(e),setTimeout((function(){t&&t(a),i.manager.itemEnd(e)}),0),a;const o=document.createElementNS("http://www.w3.org/1999/xhtml","img");function s(){o.removeEventListener("load",s,!1),o.removeEventListener("error",l,!1),Cache.add(e,this),t&&t(this),i.manager.itemEnd(e)}function l(t){o.removeEventListener("load",s,!1),o.removeEventListener("error",l,!1),n&&n(t),i.manager.itemError(e),i.manager.itemEnd(e)}return o.addEventListener("load",s,!1),o.addEventListener("error",l,!1),"data:"!==e.substr(0,5)&&void 0!==this.crossOrigin&&(o.crossOrigin=this.crossOrigin),i.manager.itemStart(e),o.src=e,o}}class CubeTextureLoader extends Loader{constructor(e){super(e)}load(e,t,r,n){const i=new CubeTexture,a=new ImageLoader(this.manager);a.setCrossOrigin(this.crossOrigin),a.setPath(this.path);let o=0;function s(r){a.load(e[r],(function(e){i.images[r]=e,o++,6===o&&(i.needsUpdate=!0,t&&t(i))}),void 0,n)}for(let t=0;t<e.length;++t)s(t);return i}}function DataTextureLoader(e){Loader.call(this,e)}function TextureLoader(e){Loader.call(this,e)}function Curve(){this.type="Curve",this.arcLengthDivisions=200}DataTextureLoader.prototype=Object.assign(Object.create(Loader.prototype),{constructor:DataTextureLoader,load:function(e,t,r,n){const i=this,a=new DataTexture,o=new FileLoader(this.manager);return o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setPath(this.path),o.setWithCredentials(i.withCredentials),o.load(e,(function(e){const r=i.parse(e);r&&(void 0!==r.image?a.image=r.image:void 0!==r.data&&(a.image.width=r.width,a.image.height=r.height,a.image.data=r.data),a.wrapS=void 0!==r.wrapS?r.wrapS:ClampToEdgeWrapping,a.wrapT=void 0!==r.wrapT?r.wrapT:ClampToEdgeWrapping,a.magFilter=void 0!==r.magFilter?r.magFilter:LinearFilter,a.minFilter=void 0!==r.minFilter?r.minFilter:LinearFilter,a.anisotropy=void 0!==r.anisotropy?r.anisotropy:1,void 0!==r.encoding&&(a.encoding=r.encoding),void 0!==r.flipY&&(a.flipY=r.flipY),void 0!==r.format&&(a.format=r.format),void 0!==r.type&&(a.type=r.type),void 0!==r.mipmaps&&(a.mipmaps=r.mipmaps,a.minFilter=LinearMipmapLinearFilter),1===r.mipmapCount&&(a.minFilter=LinearFilter),a.needsUpdate=!0,t&&t(a,r))}),r,n),a}}),TextureLoader.prototype=Object.assign(Object.create(Loader.prototype),{constructor:TextureLoader,load:function(e,t,r,n){const i=new Texture$1,a=new ImageLoader(this.manager);return a.setCrossOrigin(this.crossOrigin),a.setPath(this.path),a.load(e,(function(r){i.image=r;const n=e.search(/\.jpe?g($|\?)/i)>0||0===e.search(/^data\:image\/jpeg/);i.format=n?RGBFormat:RGBAFormat,i.needsUpdate=!0,void 0!==t&&t(i)}),r,n),i}}),Object.assign(Curve.prototype,{getPoint:function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},getPointAt:function(e,t){const r=this.getUtoTmapping(e);return this.getPoint(r,t)},getPoints:function(e=5){const t=[];for(let r=0;r<=e;r++)t.push(this.getPoint(r/e));return t},getSpacedPoints:function(e=5){const t=[];for(let r=0;r<=e;r++)t.push(this.getPointAt(r/e));return t},getLength:function(){const e=this.getLengths();return e[e.length-1]},getLengths:function(e){if(void 0===e&&(e=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const t=[];let r,n=this.getPoint(0),i=0;t.push(0);for(let a=1;a<=e;a++)r=this.getPoint(a/e),i+=r.distanceTo(n),t.push(i),n=r;return this.cacheArcLengths=t,t},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(e,t){const r=this.getLengths();let n=0;const i=r.length;let a;a=t||e*r[i-1];let o,s=0,l=i-1;for(;s<=l;)if(n=Math.floor(s+(l-s)/2),o=r[n]-a,o<0)s=n+1;else{if(!(o>0)){l=n;break}l=n-1}if(n=l,r[n]===a)return n/(i-1);const c=r[n];return(n+(a-c)/(r[n+1]-c))/(i-1)},getTangent:function(e,t){const r=1e-4;let n=e-r,i=e+r;n<0&&(n=0),i>1&&(i=1);const a=this.getPoint(n),o=this.getPoint(i),s=t||(a.isVector2?new Vector2:new Vector3);return s.copy(o).sub(a).normalize(),s},getTangentAt:function(e,t){const r=this.getUtoTmapping(e);return this.getTangent(r,t)},computeFrenetFrames:function(e,t){const r=new Vector3,n=[],i=[],a=[],o=new Vector3,s=new Matrix4;for(let t=0;t<=e;t++){const r=t/e;n[t]=this.getTangentAt(r,new Vector3),n[t].normalize()}i[0]=new Vector3,a[0]=new Vector3;let l=Number.MAX_VALUE;const c=Math.abs(n[0].x),h=Math.abs(n[0].y),u=Math.abs(n[0].z);c<=l&&(l=c,r.set(1,0,0)),h<=l&&(l=h,r.set(0,1,0)),u<=l&&r.set(0,0,1),o.crossVectors(n[0],r).normalize(),i[0].crossVectors(n[0],o),a[0].crossVectors(n[0],i[0]);for(let t=1;t<=e;t++){if(i[t]=i[t-1].clone(),a[t]=a[t-1].clone(),o.crossVectors(n[t-1],n[t]),o.length()>Number.EPSILON){o.normalize();const e=Math.acos(MathUtils.clamp(n[t-1].dot(n[t]),-1,1));i[t].applyMatrix4(s.makeRotationAxis(o,e))}a[t].crossVectors(n[t],i[t])}if(!0===t){let t=Math.acos(MathUtils.clamp(i[0].dot(i[e]),-1,1));t/=e,n[0].dot(o.crossVectors(i[0],i[e]))>0&&(t=-t);for(let r=1;r<=e;r++)i[r].applyMatrix4(s.makeRotationAxis(n[r],t*r)),a[r].crossVectors(n[r],i[r])}return{tangents:n,normals:i,binormals:a}},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.arcLengthDivisions=e.arcLengthDivisions,this},toJSON:function(){const e={metadata:{version:4.5,type:"Curve",generator:"Curve.toJSON"}};return e.arcLengthDivisions=this.arcLengthDivisions,e.type=this.type,e},fromJSON:function(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}});class EllipseCurve extends Curve{constructor(e=0,t=0,r=1,n=1,i=0,a=2*Math.PI,o=!1,s=0){super(),this.type="EllipseCurve",this.aX=e,this.aY=t,this.xRadius=r,this.yRadius=n,this.aStartAngle=i,this.aEndAngle=a,this.aClockwise=o,this.aRotation=s}getPoint(e,t){const r=t||new Vector2,n=2*Math.PI;let i=this.aEndAngle-this.aStartAngle;const a=Math.abs(i)<Number.EPSILON;for(;i<0;)i+=n;for(;i>n;)i-=n;i<Number.EPSILON&&(i=a?0:n),!0!==this.aClockwise||a||(i===n?i=-n:i-=n);const o=this.aStartAngle+e*i;let s=this.aX+this.xRadius*Math.cos(o),l=this.aY+this.yRadius*Math.sin(o);if(0!==this.aRotation){const e=Math.cos(this.aRotation),t=Math.sin(this.aRotation),r=s-this.aX,n=l-this.aY;s=r*e-n*t+this.aX,l=r*t+n*e+this.aY}return r.set(s,l)}copy(e){return super.copy(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}toJSON(){const e=super.toJSON();return e.aX=this.aX,e.aY=this.aY,e.xRadius=this.xRadius,e.yRadius=this.yRadius,e.aStartAngle=this.aStartAngle,e.aEndAngle=this.aEndAngle,e.aClockwise=this.aClockwise,e.aRotation=this.aRotation,e}fromJSON(e){return super.fromJSON(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}}EllipseCurve.prototype.isEllipseCurve=!0;class ArcCurve extends EllipseCurve{constructor(e,t,r,n,i,a){super(e,t,r,r,n,i,a),this.type="ArcCurve"}}function CubicPoly(){let e=0,t=0,r=0,n=0;function i(i,a,o,s){e=i,t=o,r=-3*i+3*a-2*o-s,n=2*i-2*a+o+s}return{initCatmullRom:function(e,t,r,n,a){i(t,r,a*(r-e),a*(n-t))},initNonuniformCatmullRom:function(e,t,r,n,a,o,s){let l=(t-e)/a-(r-e)/(a+o)+(r-t)/o,c=(r-t)/o-(n-t)/(o+s)+(n-r)/s;l*=o,c*=o,i(t,r,l,c)},calc:function(i){const a=i*i;return e+t*i+r*a+n*(a*i)}}}ArcCurve.prototype.isArcCurve=!0;const tmp=new Vector3,px=new CubicPoly,py=new CubicPoly,pz=new CubicPoly;class CatmullRomCurve3 extends Curve{constructor(e=[],t=!1,r="centripetal",n=.5){super(),this.type="CatmullRomCurve3",this.points=e,this.closed=t,this.curveType=r,this.tension=n}getPoint(e,t=new Vector3){const r=t,n=this.points,i=n.length,a=(i-(this.closed?0:1))*e;let o,s,l=Math.floor(a),c=a-l;this.closed?l+=l>0?0:(Math.floor(Math.abs(l)/i)+1)*i:0===c&&l===i-1&&(l=i-2,c=1),this.closed||l>0?o=n[(l-1)%i]:(tmp.subVectors(n[0],n[1]).add(n[0]),o=tmp);const h=n[l%i],u=n[(l+1)%i];if(this.closed||l+2<i?s=n[(l+2)%i]:(tmp.subVectors(n[i-1],n[i-2]).add(n[i-1]),s=tmp),"centripetal"===this.curveType||"chordal"===this.curveType){const e="chordal"===this.curveType?.5:.25;let t=Math.pow(o.distanceToSquared(h),e),r=Math.pow(h.distanceToSquared(u),e),n=Math.pow(u.distanceToSquared(s),e);r<1e-4&&(r=1),t<1e-4&&(t=r),n<1e-4&&(n=r),px.initNonuniformCatmullRom(o.x,h.x,u.x,s.x,t,r,n),py.initNonuniformCatmullRom(o.y,h.y,u.y,s.y,t,r,n),pz.initNonuniformCatmullRom(o.z,h.z,u.z,s.z,t,r,n)}else"catmullrom"===this.curveType&&(px.initCatmullRom(o.x,h.x,u.x,s.x,this.tension),py.initCatmullRom(o.y,h.y,u.y,s.y,this.tension),pz.initCatmullRom(o.z,h.z,u.z,s.z,this.tension));return r.set(px.calc(c),py.calc(c),pz.calc(c)),r}copy(e){super.copy(e),this.points=[];for(let t=0,r=e.points.length;t<r;t++){const r=e.points[t];this.points.push(r.clone())}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,r=this.points.length;t<r;t++){const r=this.points[t];e.points.push(r.toArray())}return e.closed=this.closed,e.curveType=this.curveType,e.tension=this.tension,e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,r=e.points.length;t<r;t++){const r=e.points[t];this.points.push((new Vector3).fromArray(r))}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}}function CatmullRom(e,t,r,n,i){const a=.5*(n-t),o=.5*(i-r),s=e*e;return(2*r-2*n+a+o)*(e*s)+(-3*r+3*n-2*a-o)*s+a*e+r}function QuadraticBezierP0(e,t){const r=1-e;return r*r*t}function QuadraticBezierP1(e,t){return 2*(1-e)*e*t}function QuadraticBezierP2(e,t){return e*e*t}function QuadraticBezier(e,t,r,n){return QuadraticBezierP0(e,t)+QuadraticBezierP1(e,r)+QuadraticBezierP2(e,n)}function CubicBezierP0(e,t){const r=1-e;return r*r*r*t}function CubicBezierP1(e,t){const r=1-e;return 3*r*r*e*t}function CubicBezierP2(e,t){return 3*(1-e)*e*e*t}function CubicBezierP3(e,t){return e*e*e*t}function CubicBezier(e,t,r,n,i){return CubicBezierP0(e,t)+CubicBezierP1(e,r)+CubicBezierP2(e,n)+CubicBezierP3(e,i)}CatmullRomCurve3.prototype.isCatmullRomCurve3=!0;class CubicBezierCurve extends Curve{constructor(e=new Vector2,t=new Vector2,r=new Vector2,n=new Vector2){super(),this.type="CubicBezierCurve",this.v0=e,this.v1=t,this.v2=r,this.v3=n}getPoint(e,t=new Vector2){const r=t,n=this.v0,i=this.v1,a=this.v2,o=this.v3;return r.set(CubicBezier(e,n.x,i.x,a.x,o.x),CubicBezier(e,n.y,i.y,a.y,o.y)),r}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}CubicBezierCurve.prototype.isCubicBezierCurve=!0;class CubicBezierCurve3 extends Curve{constructor(e=new Vector3,t=new Vector3,r=new Vector3,n=new Vector3){super(),this.type="CubicBezierCurve3",this.v0=e,this.v1=t,this.v2=r,this.v3=n}getPoint(e,t=new Vector3){const r=t,n=this.v0,i=this.v1,a=this.v2,o=this.v3;return r.set(CubicBezier(e,n.x,i.x,a.x,o.x),CubicBezier(e,n.y,i.y,a.y,o.y),CubicBezier(e,n.z,i.z,a.z,o.z)),r}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}CubicBezierCurve3.prototype.isCubicBezierCurve3=!0;class LineCurve extends Curve{constructor(e=new Vector2,t=new Vector2){super(),this.type="LineCurve",this.v1=e,this.v2=t}getPoint(e,t=new Vector2){const r=t;return 1===e?r.copy(this.v2):(r.copy(this.v2).sub(this.v1),r.multiplyScalar(e).add(this.v1)),r}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t){const r=t||new Vector2;return r.copy(this.v2).sub(this.v1).normalize(),r}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}LineCurve.prototype.isLineCurve=!0;class LineCurve3 extends Curve{constructor(e=new Vector3,t=new Vector3){super(),this.type="LineCurve3",this.isLineCurve3=!0,this.v1=e,this.v2=t}getPoint(e,t=new Vector3){const r=t;return 1===e?r.copy(this.v2):(r.copy(this.v2).sub(this.v1),r.multiplyScalar(e).add(this.v1)),r}getPointAt(e,t){return this.getPoint(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class QuadraticBezierCurve extends Curve{constructor(e=new Vector2,t=new Vector2,r=new Vector2){super(),this.type="QuadraticBezierCurve",this.v0=e,this.v1=t,this.v2=r}getPoint(e,t=new Vector2){const r=t,n=this.v0,i=this.v1,a=this.v2;return r.set(QuadraticBezier(e,n.x,i.x,a.x),QuadraticBezier(e,n.y,i.y,a.y)),r}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}QuadraticBezierCurve.prototype.isQuadraticBezierCurve=!0;class QuadraticBezierCurve3 extends Curve{constructor(e=new Vector3,t=new Vector3,r=new Vector3){super(),this.type="QuadraticBezierCurve3",this.v0=e,this.v1=t,this.v2=r}getPoint(e,t=new Vector3){const r=t,n=this.v0,i=this.v1,a=this.v2;return r.set(QuadraticBezier(e,n.x,i.x,a.x),QuadraticBezier(e,n.y,i.y,a.y),QuadraticBezier(e,n.z,i.z,a.z)),r}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}QuadraticBezierCurve3.prototype.isQuadraticBezierCurve3=!0;class SplineCurve extends Curve{constructor(e=[]){super(),this.type="SplineCurve",this.points=e}getPoint(e,t=new Vector2){const r=t,n=this.points,i=(n.length-1)*e,a=Math.floor(i),o=i-a,s=n[0===a?a:a-1],l=n[a],c=n[a>n.length-2?n.length-1:a+1],h=n[a>n.length-3?n.length-1:a+2];return r.set(CatmullRom(o,s.x,l.x,c.x,h.x),CatmullRom(o,s.y,l.y,c.y,h.y)),r}copy(e){super.copy(e),this.points=[];for(let t=0,r=e.points.length;t<r;t++){const r=e.points[t];this.points.push(r.clone())}return this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,r=this.points.length;t<r;t++){const r=this.points[t];e.points.push(r.toArray())}return e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,r=e.points.length;t<r;t++){const r=e.points[t];this.points.push((new Vector2).fromArray(r))}return this}}SplineCurve.prototype.isSplineCurve=!0;var Curves=Object.freeze({__proto__:null,ArcCurve:ArcCurve,CatmullRomCurve3:CatmullRomCurve3,CubicBezierCurve:CubicBezierCurve,CubicBezierCurve3:CubicBezierCurve3,EllipseCurve:EllipseCurve,LineCurve:LineCurve,LineCurve3:LineCurve3,QuadraticBezierCurve:QuadraticBezierCurve,QuadraticBezierCurve3:QuadraticBezierCurve3,SplineCurve:SplineCurve});class CurvePath extends Curve{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(e){this.curves.push(e)}closePath(){const e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new LineCurve(t,e))}getPoint(e){const t=e*this.getLength(),r=this.getCurveLengths();let n=0;for(;n<r.length;){if(r[n]>=t){const e=r[n]-t,i=this.curves[n],a=i.getLength(),o=0===a?0:1-e/a;return i.getPointAt(o)}n++}return null}getLength(){const e=this.getCurveLengths();return e[e.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const e=[];let t=0;for(let r=0,n=this.curves.length;r<n;r++)t+=this.curves[r].getLength(),e.push(t);return this.cacheLengths=e,e}getSpacedPoints(e=40){const t=[];for(let r=0;r<=e;r++)t.push(this.getPoint(r/e));return this.autoClose&&t.push(t[0]),t}getPoints(e=12){const t=[];let r;for(let n=0,i=this.curves;n<i.length;n++){const a=i[n],o=a&&a.isEllipseCurve?2*e:a&&(a.isLineCurve||a.isLineCurve3)?1:a&&a.isSplineCurve?e*a.points.length:e,s=a.getPoints(o);for(let e=0;e<s.length;e++){const n=s[e];r&&r.equals(n)||(t.push(n),r=n)}}return this.autoClose&&t.length>1&&!t[t.length-1].equals(t[0])&&t.push(t[0]),t}copy(e){super.copy(e),this.curves=[];for(let t=0,r=e.curves.length;t<r;t++){const r=e.curves[t];this.curves.push(r.clone())}return this.autoClose=e.autoClose,this}toJSON(){const e=super.toJSON();e.autoClose=this.autoClose,e.curves=[];for(let t=0,r=this.curves.length;t<r;t++){const r=this.curves[t];e.curves.push(r.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.autoClose=e.autoClose,this.curves=[];for(let t=0,r=e.curves.length;t<r;t++){const r=e.curves[t];this.curves.push((new Curves[r.type]).fromJSON(r))}return this}}class Path$1 extends CurvePath{constructor(e){super(),this.type="Path",this.currentPoint=new Vector2,e&&this.setFromPoints(e)}setFromPoints(e){this.moveTo(e[0].x,e[0].y);for(let t=1,r=e.length;t<r;t++)this.lineTo(e[t].x,e[t].y);return this}moveTo(e,t){return this.currentPoint.set(e,t),this}lineTo(e,t){const r=new LineCurve(this.currentPoint.clone(),new Vector2(e,t));return this.curves.push(r),this.currentPoint.set(e,t),this}quadraticCurveTo(e,t,r,n){const i=new QuadraticBezierCurve(this.currentPoint.clone(),new Vector2(e,t),new Vector2(r,n));return this.curves.push(i),this.currentPoint.set(r,n),this}bezierCurveTo(e,t,r,n,i,a){const o=new CubicBezierCurve(this.currentPoint.clone(),new Vector2(e,t),new Vector2(r,n),new Vector2(i,a));return this.curves.push(o),this.currentPoint.set(i,a),this}splineThru(e){const t=[this.currentPoint.clone()].concat(e),r=new SplineCurve(t);return this.curves.push(r),this.currentPoint.copy(e[e.length-1]),this}arc(e,t,r,n,i,a){const o=this.currentPoint.x,s=this.currentPoint.y;return this.absarc(e+o,t+s,r,n,i,a),this}absarc(e,t,r,n,i,a){return this.absellipse(e,t,r,r,n,i,a),this}ellipse(e,t,r,n,i,a,o,s){const l=this.currentPoint.x,c=this.currentPoint.y;return this.absellipse(e+l,t+c,r,n,i,a,o,s),this}absellipse(e,t,r,n,i,a,o,s){const l=new EllipseCurve(e,t,r,n,i,a,o,s);if(this.curves.length>0){const e=l.getPoint(0);e.equals(this.currentPoint)||this.lineTo(e.x,e.y)}this.curves.push(l);const c=l.getPoint(1);return this.currentPoint.copy(c),this}copy(e){return super.copy(e),this.currentPoint.copy(e.currentPoint),this}toJSON(){const e=super.toJSON();return e.currentPoint=this.currentPoint.toArray(),e}fromJSON(e){return super.fromJSON(e),this.currentPoint.fromArray(e.currentPoint),this}}class Shape extends Path$1{constructor(e){super(e),this.uuid=MathUtils.generateUUID(),this.type="Shape",this.holes=[]}getPointsHoles(e){const t=[];for(let r=0,n=this.holes.length;r<n;r++)t[r]=this.holes[r].getPoints(e);return t}extractPoints(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}}copy(e){super.copy(e),this.holes=[];for(let t=0,r=e.holes.length;t<r;t++){const r=e.holes[t];this.holes.push(r.clone())}return this}toJSON(){const e=super.toJSON();e.uuid=this.uuid,e.holes=[];for(let t=0,r=this.holes.length;t<r;t++){const r=this.holes[t];e.holes.push(r.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.uuid=e.uuid,this.holes=[];for(let t=0,r=e.holes.length;t<r;t++){const r=e.holes[t];this.holes.push((new Path$1).fromJSON(r))}return this}}class Light extends Object3D{constructor(e,t=1){super(),this.type="Light",this.color=new Color(e),this.intensity=t}copy(e){return super.copy(e),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),t}}Light.prototype.isLight=!0;class HemisphereLight extends Light{constructor(e,t,r){super(e,r),this.type="HemisphereLight",this.position.copy(Object3D.DefaultUp),this.updateMatrix(),this.groundColor=new Color(t)}copy(e){return Light.prototype.copy.call(this,e),this.groundColor.copy(e.groundColor),this}}HemisphereLight.prototype.isHemisphereLight=!0;const _projScreenMatrix=new Matrix4,_lightPositionWorld=new Vector3,_lookTarget=new Vector3;class LightShadow{constructor(e){this.camera=e,this.bias=0,this.normalBias=0,this.radius=1,this.mapSize=new Vector2(512,512),this.map=null,this.mapPass=null,this.matrix=new Matrix4,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new Frustum,this._frameExtents=new Vector2(1,1),this._viewportCount=1,this._viewports=[new Vector4(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,r=this.matrix;_lightPositionWorld.setFromMatrixPosition(e.matrixWorld),t.position.copy(_lightPositionWorld),_lookTarget.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(_lookTarget),t.updateMatrixWorld(),_projScreenMatrix.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(_projScreenMatrix),r.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),r.multiply(t.projectionMatrix),r.multiply(t.matrixWorldInverse)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}copy(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const e={};return 0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class SpotLightShadow extends LightShadow{constructor(){super(new PerspectiveCamera(50,1,.5,500)),this.focus=1}updateMatrices(e){const t=this.camera,r=2*MathUtils.RAD2DEG*e.angle*this.focus,n=this.mapSize.width/this.mapSize.height,i=e.distance||t.far;r===t.fov&&n===t.aspect&&i===t.far||(t.fov=r,t.aspect=n,t.far=i,t.updateProjectionMatrix()),super.updateMatrices(e)}}SpotLightShadow.prototype.isSpotLightShadow=!0;class SpotLight extends Light{constructor(e,t,r=0,n=Math.PI/3,i=0,a=1){super(e,t),this.type="SpotLight",this.position.copy(Object3D.DefaultUp),this.updateMatrix(),this.target=new Object3D,this.distance=r,this.angle=n,this.penumbra=i,this.decay=a,this.shadow=new SpotLightShadow}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}copy(e){return super.copy(e),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}SpotLight.prototype.isSpotLight=!0;const _projScreenMatrix$1=new Matrix4,_lightPositionWorld$1=new Vector3,_lookTarget$1=new Vector3;class PointLightShadow extends LightShadow{constructor(){super(new PerspectiveCamera(90,1,.5,500)),this._frameExtents=new Vector2(4,2),this._viewportCount=6,this._viewports=[new Vector4(2,1,1,1),new Vector4(0,1,1,1),new Vector4(3,1,1,1),new Vector4(1,1,1,1),new Vector4(3,0,1,1),new Vector4(1,0,1,1)],this._cubeDirections=[new Vector3(1,0,0),new Vector3(-1,0,0),new Vector3(0,0,1),new Vector3(0,0,-1),new Vector3(0,1,0),new Vector3(0,-1,0)],this._cubeUps=[new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,0,1),new Vector3(0,0,-1)]}updateMatrices(e,t=0){const r=this.camera,n=this.matrix;_lightPositionWorld$1.setFromMatrixPosition(e.matrixWorld),r.position.copy(_lightPositionWorld$1),_lookTarget$1.copy(r.position),_lookTarget$1.add(this._cubeDirections[t]),r.up.copy(this._cubeUps[t]),r.lookAt(_lookTarget$1),r.updateMatrixWorld(),n.makeTranslation(-_lightPositionWorld$1.x,-_lightPositionWorld$1.y,-_lightPositionWorld$1.z),_projScreenMatrix$1.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),this._frustum.setFromProjectionMatrix(_projScreenMatrix$1)}}PointLightShadow.prototype.isPointLightShadow=!0;class PointLight extends Light{constructor(e,t,r=0,n=1){super(e,t),this.type="PointLight",this.distance=r,this.decay=n,this.shadow=new PointLightShadow}get power(){return 4*this.intensity*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}copy(e){return super.copy(e),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}PointLight.prototype.isPointLight=!0;class OrthographicCamera extends Camera$1$1{constructor(e=-1,t=1,r=1,n=-1,i=.1,a=2e3){super(),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=r,this.bottom=n,this.near=i,this.far=a,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,t,r,n,i,a){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=r,this.view.offsetY=n,this.view.width=i,this.view.height=a,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),r=(this.right+this.left)/2,n=(this.top+this.bottom)/2;let i=r-e,a=r+e,o=n+t,s=n-t;if(null!==this.view&&this.view.enabled){const e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;i+=e*this.view.offsetX,a=i+e*this.view.width,o-=t*this.view.offsetY,s=o-t*this.view.height}this.projectionMatrix.makeOrthographic(i,a,o,s,this.near,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=Object3D.prototype.toJSON.call(this,e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}OrthographicCamera.prototype.isOrthographicCamera=!0;class DirectionalLightShadow extends LightShadow{constructor(){super(new OrthographicCamera(-5,5,5,-5,.5,500))}}DirectionalLightShadow.prototype.isDirectionalLightShadow=!0;class DirectionalLight extends Light{constructor(e,t){super(e,t),this.type="DirectionalLight",this.position.copy(Object3D.DefaultUp),this.updateMatrix(),this.target=new Object3D,this.shadow=new DirectionalLightShadow}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}DirectionalLight.prototype.isDirectionalLight=!0;class AmbientLight extends Light{constructor(e,t){super(e,t),this.type="AmbientLight"}}AmbientLight.prototype.isAmbientLight=!0;class RectAreaLight extends Light{constructor(e,t,r=10,n=10){super(e,t),this.type="RectAreaLight",this.width=r,this.height=n}copy(e){return super.copy(e),this.width=e.width,this.height=e.height,this}toJSON(e){const t=super.toJSON(e);return t.object.width=this.width,t.object.height=this.height,t}}RectAreaLight.prototype.isRectAreaLight=!0;class SphericalHarmonics3{constructor(){this.coefficients=[];for(let e=0;e<9;e++)this.coefficients.push(new Vector3)}set(e){for(let t=0;t<9;t++)this.coefficients[t].copy(e[t]);return this}zero(){for(let e=0;e<9;e++)this.coefficients[e].set(0,0,0);return this}getAt(e,t){const r=e.x,n=e.y,i=e.z,a=this.coefficients;return t.copy(a[0]).multiplyScalar(.282095),t.addScaledVector(a[1],.488603*n),t.addScaledVector(a[2],.488603*i),t.addScaledVector(a[3],.488603*r),t.addScaledVector(a[4],r*n*1.092548),t.addScaledVector(a[5],n*i*1.092548),t.addScaledVector(a[6],.315392*(3*i*i-1)),t.addScaledVector(a[7],r*i*1.092548),t.addScaledVector(a[8],.546274*(r*r-n*n)),t}getIrradianceAt(e,t){const r=e.x,n=e.y,i=e.z,a=this.coefficients;return t.copy(a[0]).multiplyScalar(.886227),t.addScaledVector(a[1],1.023328*n),t.addScaledVector(a[2],1.023328*i),t.addScaledVector(a[3],1.023328*r),t.addScaledVector(a[4],.858086*r*n),t.addScaledVector(a[5],.858086*n*i),t.addScaledVector(a[6],.743125*i*i-.247708),t.addScaledVector(a[7],.858086*r*i),t.addScaledVector(a[8],.429043*(r*r-n*n)),t}add(e){for(let t=0;t<9;t++)this.coefficients[t].add(e.coefficients[t]);return this}addScaledSH(e,t){for(let r=0;r<9;r++)this.coefficients[r].addScaledVector(e.coefficients[r],t);return this}scale(e){for(let t=0;t<9;t++)this.coefficients[t].multiplyScalar(e);return this}lerp(e,t){for(let r=0;r<9;r++)this.coefficients[r].lerp(e.coefficients[r],t);return this}equals(e){for(let t=0;t<9;t++)if(!this.coefficients[t].equals(e.coefficients[t]))return!1;return!0}copy(e){return this.set(e.coefficients)}clone(){return(new this.constructor).copy(this)}fromArray(e,t=0){const r=this.coefficients;for(let n=0;n<9;n++)r[n].fromArray(e,t+3*n);return this}toArray(e=[],t=0){const r=this.coefficients;for(let n=0;n<9;n++)r[n].toArray(e,t+3*n);return e}static getBasisAt(e,t){const r=e.x,n=e.y,i=e.z;t[0]=.282095,t[1]=.488603*n,t[2]=.488603*i,t[3]=.488603*r,t[4]=1.092548*r*n,t[5]=1.092548*n*i,t[6]=.315392*(3*i*i-1),t[7]=1.092548*r*i,t[8]=.546274*(r*r-n*n)}}SphericalHarmonics3.prototype.isSphericalHarmonics3=!0;class LightProbe extends Light{constructor(e=new SphericalHarmonics3,t=1){super(void 0,t),this.sh=e}copy(e){return super.copy(e),this.sh.copy(e.sh),this}fromJSON(e){return this.intensity=e.intensity,this.sh.fromArray(e.sh),this}toJSON(e){const t=super.toJSON(e);return t.object.sh=this.sh.toArray(),t}}LightProbe.prototype.isLightProbe=!0;class MaterialLoader extends Loader{constructor(e){super(e),this.textures={}}load(e,t,r,n){const i=this,a=new FileLoader(i.manager);a.setPath(i.path),a.setRequestHeader(i.requestHeader),a.setWithCredentials(i.withCredentials),a.load(e,(function(r){try{t(i.parse(JSON.parse(r)))}catch(t){n?n(t):console.error(t),i.manager.itemError(e)}}),r,n)}parse(e){const t=this.textures;function r(e){return void 0===t[e]&&console.warn("THREE.MaterialLoader: Undefined texture",e),t[e]}const n=new Materials[e.type];if(void 0!==e.uuid&&(n.uuid=e.uuid),void 0!==e.name&&(n.name=e.name),void 0!==e.color&&void 0!==n.color&&n.color.setHex(e.color),void 0!==e.roughness&&(n.roughness=e.roughness),void 0!==e.metalness&&(n.metalness=e.metalness),void 0!==e.sheen&&(n.sheen=(new Color).setHex(e.sheen)),void 0!==e.emissive&&void 0!==n.emissive&&n.emissive.setHex(e.emissive),void 0!==e.specular&&void 0!==n.specular&&n.specular.setHex(e.specular),void 0!==e.shininess&&(n.shininess=e.shininess),void 0!==e.clearcoat&&(n.clearcoat=e.clearcoat),void 0!==e.clearcoatRoughness&&(n.clearcoatRoughness=e.clearcoatRoughness),void 0!==e.fog&&(n.fog=e.fog),void 0!==e.flatShading&&(n.flatShading=e.flatShading),void 0!==e.blending&&(n.blending=e.blending),void 0!==e.combine&&(n.combine=e.combine),void 0!==e.side&&(n.side=e.side),void 0!==e.opacity&&(n.opacity=e.opacity),void 0!==e.transparent&&(n.transparent=e.transparent),void 0!==e.alphaTest&&(n.alphaTest=e.alphaTest),void 0!==e.depthTest&&(n.depthTest=e.depthTest),void 0!==e.depthWrite&&(n.depthWrite=e.depthWrite),void 0!==e.colorWrite&&(n.colorWrite=e.colorWrite),void 0!==e.stencilWrite&&(n.stencilWrite=e.stencilWrite),void 0!==e.stencilWriteMask&&(n.stencilWriteMask=e.stencilWriteMask),void 0!==e.stencilFunc&&(n.stencilFunc=e.stencilFunc),void 0!==e.stencilRef&&(n.stencilRef=e.stencilRef),void 0!==e.stencilFuncMask&&(n.stencilFuncMask=e.stencilFuncMask),void 0!==e.stencilFail&&(n.stencilFail=e.stencilFail),void 0!==e.stencilZFail&&(n.stencilZFail=e.stencilZFail),void 0!==e.stencilZPass&&(n.stencilZPass=e.stencilZPass),void 0!==e.wireframe&&(n.wireframe=e.wireframe),void 0!==e.wireframeLinewidth&&(n.wireframeLinewidth=e.wireframeLinewidth),void 0!==e.wireframeLinecap&&(n.wireframeLinecap=e.wireframeLinecap),void 0!==e.wireframeLinejoin&&(n.wireframeLinejoin=e.wireframeLinejoin),void 0!==e.rotation&&(n.rotation=e.rotation),1!==e.linewidth&&(n.linewidth=e.linewidth),void 0!==e.dashSize&&(n.dashSize=e.dashSize),void 0!==e.gapSize&&(n.gapSize=e.gapSize),void 0!==e.scale&&(n.scale=e.scale),void 0!==e.polygonOffset&&(n.polygonOffset=e.polygonOffset),void 0!==e.polygonOffsetFactor&&(n.polygonOffsetFactor=e.polygonOffsetFactor),void 0!==e.polygonOffsetUnits&&(n.polygonOffsetUnits=e.polygonOffsetUnits),void 0!==e.skinning&&(n.skinning=e.skinning),void 0!==e.morphTargets&&(n.morphTargets=e.morphTargets),void 0!==e.morphNormals&&(n.morphNormals=e.morphNormals),void 0!==e.dithering&&(n.dithering=e.dithering),void 0!==e.vertexTangents&&(n.vertexTangents=e.vertexTangents),void 0!==e.visible&&(n.visible=e.visible),void 0!==e.toneMapped&&(n.toneMapped=e.toneMapped),void 0!==e.userData&&(n.userData=e.userData),void 0!==e.vertexColors&&("number"==typeof e.vertexColors?n.vertexColors=e.vertexColors>0:n.vertexColors=e.vertexColors),void 0!==e.uniforms)for(const t in e.uniforms){const i=e.uniforms[t];switch(n.uniforms[t]={},i.type){case"t":n.uniforms[t].value=r(i.value);break;case"c":n.uniforms[t].value=(new Color).setHex(i.value);break;case"v2":n.uniforms[t].value=(new Vector2).fromArray(i.value);break;case"v3":n.uniforms[t].value=(new Vector3).fromArray(i.value);break;case"v4":n.uniforms[t].value=(new Vector4).fromArray(i.value);break;case"m3":n.uniforms[t].value=(new Matrix3).fromArray(i.value);break;case"m4":n.uniforms[t].value=(new Matrix4).fromArray(i.value);break;default:n.uniforms[t].value=i.value}}if(void 0!==e.defines&&(n.defines=e.defines),void 0!==e.vertexShader&&(n.vertexShader=e.vertexShader),void 0!==e.fragmentShader&&(n.fragmentShader=e.fragmentShader),void 0!==e.extensions)for(const t in e.extensions)n.extensions[t]=e.extensions[t];if(void 0!==e.shading&&(n.flatShading=1===e.shading),void 0!==e.size&&(n.size=e.size),void 0!==e.sizeAttenuation&&(n.sizeAttenuation=e.sizeAttenuation),void 0!==e.map&&(n.map=r(e.map)),void 0!==e.matcap&&(n.matcap=r(e.matcap)),void 0!==e.alphaMap&&(n.alphaMap=r(e.alphaMap)),void 0!==e.bumpMap&&(n.bumpMap=r(e.bumpMap)),void 0!==e.bumpScale&&(n.bumpScale=e.bumpScale),void 0!==e.normalMap&&(n.normalMap=r(e.normalMap)),void 0!==e.normalMapType&&(n.normalMapType=e.normalMapType),void 0!==e.normalScale){let t=e.normalScale;!1===Array.isArray(t)&&(t=[t,t]),n.normalScale=(new Vector2).fromArray(t)}return void 0!==e.displacementMap&&(n.displacementMap=r(e.displacementMap)),void 0!==e.displacementScale&&(n.displacementScale=e.displacementScale),void 0!==e.displacementBias&&(n.displacementBias=e.displacementBias),void 0!==e.roughnessMap&&(n.roughnessMap=r(e.roughnessMap)),void 0!==e.metalnessMap&&(n.metalnessMap=r(e.metalnessMap)),void 0!==e.emissiveMap&&(n.emissiveMap=r(e.emissiveMap)),void 0!==e.emissiveIntensity&&(n.emissiveIntensity=e.emissiveIntensity),void 0!==e.specularMap&&(n.specularMap=r(e.specularMap)),void 0!==e.envMap&&(n.envMap=r(e.envMap)),void 0!==e.envMapIntensity&&(n.envMapIntensity=e.envMapIntensity),void 0!==e.reflectivity&&(n.reflectivity=e.reflectivity),void 0!==e.refractionRatio&&(n.refractionRatio=e.refractionRatio),void 0!==e.lightMap&&(n.lightMap=r(e.lightMap)),void 0!==e.lightMapIntensity&&(n.lightMapIntensity=e.lightMapIntensity),void 0!==e.aoMap&&(n.aoMap=r(e.aoMap)),void 0!==e.aoMapIntensity&&(n.aoMapIntensity=e.aoMapIntensity),void 0!==e.gradientMap&&(n.gradientMap=r(e.gradientMap)),void 0!==e.clearcoatMap&&(n.clearcoatMap=r(e.clearcoatMap)),void 0!==e.clearcoatRoughnessMap&&(n.clearcoatRoughnessMap=r(e.clearcoatRoughnessMap)),void 0!==e.clearcoatNormalMap&&(n.clearcoatNormalMap=r(e.clearcoatNormalMap)),void 0!==e.clearcoatNormalScale&&(n.clearcoatNormalScale=(new Vector2).fromArray(e.clearcoatNormalScale)),void 0!==e.transmission&&(n.transmission=e.transmission),void 0!==e.transmissionMap&&(n.transmissionMap=r(e.transmissionMap)),n}setTextures(e){return this.textures=e,this}}const LoaderUtils={decodeText:function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let t="";for(let r=0,n=e.length;r<n;r++)t+=String.fromCharCode(e[r]);try{return decodeURIComponent(escape(t))}catch(e){return t}},extractUrlBase:function(e){const t=e.lastIndexOf("/");return-1===t?"./":e.substr(0,t+1)}};function InstancedBufferGeometry(){BufferGeometry.call(this),this.type="InstancedBufferGeometry",this.instanceCount=1/0}function InstancedBufferAttribute(e,t,r,n){"number"==typeof r&&(n=r,r=!1,console.error("THREE.InstancedBufferAttribute: The constructor now expects normalized as the third argument.")),BufferAttribute.call(this,e,t,r),this.meshPerAttribute=n||1}InstancedBufferGeometry.prototype=Object.assign(Object.create(BufferGeometry.prototype),{constructor:InstancedBufferGeometry,isInstancedBufferGeometry:!0,copy:function(e){return BufferGeometry.prototype.copy.call(this,e),this.instanceCount=e.instanceCount,this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){const e=BufferGeometry.prototype.toJSON.call(this);return e.instanceCount=this.instanceCount,e.isInstancedBufferGeometry=!0,e}}),InstancedBufferAttribute.prototype=Object.assign(Object.create(BufferAttribute.prototype),{constructor:InstancedBufferAttribute,isInstancedBufferAttribute:!0,copy:function(e){return BufferAttribute.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this},toJSON:function(){const e=BufferAttribute.prototype.toJSON.call(this);return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}});class BufferGeometryLoader extends Loader{constructor(e){super(e)}load(e,t,r,n){const i=this,a=new FileLoader(i.manager);a.setPath(i.path),a.setRequestHeader(i.requestHeader),a.setWithCredentials(i.withCredentials),a.load(e,(function(r){try{t(i.parse(JSON.parse(r)))}catch(t){n?n(t):console.error(t),i.manager.itemError(e)}}),r,n)}parse(e){const t={},r={};function n(e,n){if(void 0!==t[n])return t[n];const i=e.interleavedBuffers[n],a=function(e,t){if(void 0!==r[t])return r[t];const n=e.arrayBuffers[t],i=new Uint32Array(n).buffer;return r[t]=i,i}(e,i.buffer),o=new InterleavedBuffer(getTypedArray(i.type,a),i.stride);return o.uuid=i.uuid,t[n]=o,o}const i=e.isInstancedBufferGeometry?new InstancedBufferGeometry:new BufferGeometry,a=e.data.index;if(void 0!==a){const e=getTypedArray(a.type,a.array);i.setIndex(new BufferAttribute(e,1))}const o=e.data.attributes;for(const t in o){const r=o[t];let a;if(r.isInterleavedBufferAttribute){a=new InterleavedBufferAttribute(n(e.data,r.data),r.itemSize,r.offset,r.normalized)}else{const e=getTypedArray(r.type,r.array);a=new(r.isInstancedBufferAttribute?InstancedBufferAttribute:BufferAttribute)(e,r.itemSize,r.normalized)}void 0!==r.name&&(a.name=r.name),i.setAttribute(t,a)}const s=e.data.morphAttributes;if(s)for(const t in s){const r=s[t],a=[];for(let t=0,i=r.length;t<i;t++){const i=r[t];let o;if(i.isInterleavedBufferAttribute){o=new InterleavedBufferAttribute(n(e.data,i.data),i.itemSize,i.offset,i.normalized)}else{o=new BufferAttribute(getTypedArray(i.type,i.array),i.itemSize,i.normalized)}void 0!==i.name&&(o.name=i.name),a.push(o)}i.morphAttributes[t]=a}e.data.morphTargetsRelative&&(i.morphTargetsRelative=!0);const l=e.data.groups||e.data.drawcalls||e.data.offsets;if(void 0!==l)for(let e=0,t=l.length;e!==t;++e){const t=l[e];i.addGroup(t.start,t.count,t.materialIndex)}const c=e.data.boundingSphere;if(void 0!==c){const e=new Vector3;void 0!==c.center&&e.fromArray(c.center),i.boundingSphere=new Sphere(e,c.radius)}return e.name&&(i.name=e.name),e.userData&&(i.userData=e.userData),i}}class ObjectLoader extends Loader{constructor(e){super(e)}load(e,t,r,n){const i=this,a=""===this.path?LoaderUtils.extractUrlBase(e):this.path;this.resourcePath=this.resourcePath||a;const o=new FileLoader(this.manager);o.setPath(this.path),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(function(r){let a=null;try{a=JSON.parse(r)}catch(t){return void 0!==n&&n(t),void console.error("THREE:ObjectLoader: Can't parse "+e+".",t.message)}const o=a.metadata;void 0!==o&&void 0!==o.type&&"geometry"!==o.type.toLowerCase()?i.parse(a,t):console.error("THREE.ObjectLoader: Can't load "+e)}),r,n)}parse(e,t){const r=this.parseAnimations(e.animations),n=this.parseShapes(e.shapes),i=this.parseGeometries(e.geometries,n),a=this.parseImages(e.images,(function(){void 0!==t&&t(l)})),o=this.parseTextures(e.textures,a),s=this.parseMaterials(e.materials,o),l=this.parseObject(e.object,i,s,r),c=this.parseSkeletons(e.skeletons,l);if(this.bindSkeletons(l,c),void 0!==t){let e=!1;for(const t in a)if(a[t]instanceof HTMLImageElement){e=!0;break}!1===e&&t(l)}return l}parseShapes(e){const t={};if(void 0!==e)for(let r=0,n=e.length;r<n;r++){const n=(new Shape).fromJSON(e[r]);t[n.uuid]=n}return t}parseSkeletons(e,t){const r={},n={};if(t.traverse((function(e){e.isBone&&(n[e.uuid]=e)})),void 0!==e)for(let t=0,i=e.length;t<i;t++){const i=(new Skeleton).fromJSON(e[t],n);r[i.uuid]=i}return r}parseGeometries(e,t){const r={};let n;if(void 0!==e){const i=new BufferGeometryLoader;for(let a=0,o=e.length;a<o;a++){let o;const s=e[a];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":o=new Geometries[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"BoxBufferGeometry":o=new Geometries[s.type](s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleGeometry":case"CircleBufferGeometry":o=new Geometries[s.type](s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":case"CylinderBufferGeometry":o=new Geometries[s.type](s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"ConeGeometry":case"ConeBufferGeometry":o=new Geometries[s.type](s.radius,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"SphereGeometry":case"SphereBufferGeometry":o=new Geometries[s.type](s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":case"DodecahedronBufferGeometry":case"IcosahedronGeometry":case"IcosahedronBufferGeometry":case"OctahedronGeometry":case"OctahedronBufferGeometry":case"TetrahedronGeometry":case"TetrahedronBufferGeometry":o=new Geometries[s.type](s.radius,s.detail);break;case"RingGeometry":case"RingBufferGeometry":o=new Geometries[s.type](s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":case"TorusBufferGeometry":o=new Geometries[s.type](s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":case"TorusKnotBufferGeometry":o=new Geometries[s.type](s.radius,s.tube,s.tubularSegments,s.radialSegments,s.p,s.q);break;case"TubeGeometry":case"TubeBufferGeometry":o=new Geometries[s.type]((new Curves[s.path.type]).fromJSON(s.path),s.tubularSegments,s.radius,s.radialSegments,s.closed);break;case"LatheGeometry":case"LatheBufferGeometry":o=new Geometries[s.type](s.points,s.segments,s.phiStart,s.phiLength);break;case"PolyhedronGeometry":case"PolyhedronBufferGeometry":o=new Geometries[s.type](s.vertices,s.indices,s.radius,s.details);break;case"ShapeGeometry":case"ShapeBufferGeometry":n=[];for(let e=0,r=s.shapes.length;e<r;e++){const r=t[s.shapes[e]];n.push(r)}o=new Geometries[s.type](n,s.curveSegments);break;case"ExtrudeGeometry":case"ExtrudeBufferGeometry":n=[];for(let e=0,r=s.shapes.length;e<r;e++){const r=t[s.shapes[e]];n.push(r)}const e=s.options.extrudePath;void 0!==e&&(s.options.extrudePath=(new Curves[e.type]).fromJSON(e)),o=new Geometries[s.type](n,s.options);break;case"BufferGeometry":case"InstancedBufferGeometry":o=i.parse(s);break;case"Geometry":console.error('THREE.ObjectLoader: Loading "Geometry" is not supported anymore.');break;default:console.warn('THREE.ObjectLoader: Unsupported geometry type "'+s.type+'"');continue}o.uuid=s.uuid,void 0!==s.name&&(o.name=s.name),!0===o.isBufferGeometry&&void 0!==s.userData&&(o.userData=s.userData),r[s.uuid]=o}}return r}parseMaterials(e,t){const r={},n={};if(void 0!==e){const i=new MaterialLoader;i.setTextures(t);for(let t=0,a=e.length;t<a;t++){const a=e[t];if("MultiMaterial"===a.type){const e=[];for(let t=0;t<a.materials.length;t++){const n=a.materials[t];void 0===r[n.uuid]&&(r[n.uuid]=i.parse(n)),e.push(r[n.uuid])}n[a.uuid]=e}else void 0===r[a.uuid]&&(r[a.uuid]=i.parse(a)),n[a.uuid]=r[a.uuid]}}return n}parseAnimations(e){const t={};if(void 0!==e)for(let r=0;r<e.length;r++){const n=e[r],i=AnimationClip.parse(n);t[i.uuid]=i}return t}parseImages(e,t){const r=this,n={};let i;function a(e){if("string"==typeof e){const t=e;return function(e){return r.manager.itemStart(e),i.load(e,(function(){r.manager.itemEnd(e)}),void 0,(function(){r.manager.itemError(e),r.manager.itemEnd(e)}))}(/^(\/\/)|([a-z]+:(\/\/)?)/i.test(t)?t:r.resourcePath+t)}return e.data?{data:getTypedArray(e.type,e.data),width:e.width,height:e.height}:null}if(void 0!==e&&e.length>0){const r=new LoadingManager(t);i=new ImageLoader(r),i.setCrossOrigin(this.crossOrigin);for(let t=0,r=e.length;t<r;t++){const r=e[t],i=r.url;if(Array.isArray(i)){n[r.uuid]=[];for(let e=0,t=i.length;e<t;e++){const t=a(i[e]);null!==t&&(t instanceof HTMLImageElement?n[r.uuid].push(t):n[r.uuid].push(new DataTexture(t.data,t.width,t.height)))}}else{const e=a(r.url);null!==e&&(n[r.uuid]=e)}}}return n}parseTextures(e,t){function r(e,t){return"number"==typeof e?e:(console.warn("THREE.ObjectLoader.parseTexture: Constant should be in numeric form.",e),t[e])}const n={};if(void 0!==e)for(let i=0,a=e.length;i<a;i++){const a=e[i];let o;void 0===a.image&&console.warn('THREE.ObjectLoader: No "image" specified for',a.uuid),void 0===t[a.image]&&console.warn("THREE.ObjectLoader: Undefined image",a.image);const s=t[a.image];Array.isArray(s)?(o=new CubeTexture(s),6===s.length&&(o.needsUpdate=!0)):(o=s&&s.data?new DataTexture(s.data,s.width,s.height):new Texture$1(s),s&&(o.needsUpdate=!0)),o.uuid=a.uuid,void 0!==a.name&&(o.name=a.name),void 0!==a.mapping&&(o.mapping=r(a.mapping,TEXTURE_MAPPING)),void 0!==a.offset&&o.offset.fromArray(a.offset),void 0!==a.repeat&&o.repeat.fromArray(a.repeat),void 0!==a.center&&o.center.fromArray(a.center),void 0!==a.rotation&&(o.rotation=a.rotation),void 0!==a.wrap&&(o.wrapS=r(a.wrap[0],TEXTURE_WRAPPING),o.wrapT=r(a.wrap[1],TEXTURE_WRAPPING)),void 0!==a.format&&(o.format=a.format),void 0!==a.type&&(o.type=a.type),void 0!==a.encoding&&(o.encoding=a.encoding),void 0!==a.minFilter&&(o.minFilter=r(a.minFilter,TEXTURE_FILTER)),void 0!==a.magFilter&&(o.magFilter=r(a.magFilter,TEXTURE_FILTER)),void 0!==a.anisotropy&&(o.anisotropy=a.anisotropy),void 0!==a.flipY&&(o.flipY=a.flipY),void 0!==a.premultiplyAlpha&&(o.premultiplyAlpha=a.premultiplyAlpha),void 0!==a.unpackAlignment&&(o.unpackAlignment=a.unpackAlignment),n[a.uuid]=o}return n}parseObject(e,t,r,n){let i,a,o;function s(e){return void 0===t[e]&&console.warn("THREE.ObjectLoader: Undefined geometry",e),t[e]}function l(e){if(void 0!==e){if(Array.isArray(e)){const t=[];for(let n=0,i=e.length;n<i;n++){const i=e[n];void 0===r[i]&&console.warn("THREE.ObjectLoader: Undefined material",i),t.push(r[i])}return t}return void 0===r[e]&&console.warn("THREE.ObjectLoader: Undefined material",e),r[e]}}switch(e.type){case"Scene":i=new Scene,void 0!==e.background&&Number.isInteger(e.background)&&(i.background=new Color(e.background)),void 0!==e.fog&&("Fog"===e.fog.type?i.fog=new Fog(e.fog.color,e.fog.near,e.fog.far):"FogExp2"===e.fog.type&&(i.fog=new FogExp2(e.fog.color,e.fog.density)));break;case"PerspectiveCamera":i=new PerspectiveCamera(e.fov,e.aspect,e.near,e.far),void 0!==e.focus&&(i.focus=e.focus),void 0!==e.zoom&&(i.zoom=e.zoom),void 0!==e.filmGauge&&(i.filmGauge=e.filmGauge),void 0!==e.filmOffset&&(i.filmOffset=e.filmOffset),void 0!==e.view&&(i.view=Object.assign({},e.view));break;case"OrthographicCamera":i=new OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far),void 0!==e.zoom&&(i.zoom=e.zoom),void 0!==e.view&&(i.view=Object.assign({},e.view));break;case"AmbientLight":i=new AmbientLight(e.color,e.intensity);break;case"DirectionalLight":i=new DirectionalLight(e.color,e.intensity);break;case"PointLight":i=new PointLight(e.color,e.intensity,e.distance,e.decay);break;case"RectAreaLight":i=new RectAreaLight(e.color,e.intensity,e.width,e.height);break;case"SpotLight":i=new SpotLight(e.color,e.intensity,e.distance,e.angle,e.penumbra,e.decay);break;case"HemisphereLight":i=new HemisphereLight(e.color,e.groundColor,e.intensity);break;case"LightProbe":i=(new LightProbe).fromJSON(e);break;case"SkinnedMesh":a=s(e.geometry),o=l(e.material),i=new SkinnedMesh(a,o),void 0!==e.bindMode&&(i.bindMode=e.bindMode),void 0!==e.bindMatrix&&i.bindMatrix.fromArray(e.bindMatrix),void 0!==e.skeleton&&(i.skeleton=e.skeleton);break;case"Mesh":a=s(e.geometry),o=l(e.material),i=new Mesh(a,o);break;case"InstancedMesh":a=s(e.geometry),o=l(e.material);const t=e.count,r=e.instanceMatrix;i=new InstancedMesh(a,o,t),i.instanceMatrix=new BufferAttribute(new Float32Array(r.array),16);break;case"LOD":i=new LOD;break;case"Line":i=new Line(s(e.geometry),l(e.material));break;case"LineLoop":i=new LineLoop(s(e.geometry),l(e.material));break;case"LineSegments":i=new LineSegments(s(e.geometry),l(e.material));break;case"PointCloud":case"Points":i=new Points(s(e.geometry),l(e.material));break;case"Sprite":i=new Sprite(l(e.material));break;case"Group":i=new Group;break;case"Bone":i=new Bone;break;default:i=new Object3D}if(i.uuid=e.uuid,void 0!==e.name&&(i.name=e.name),void 0!==e.matrix?(i.matrix.fromArray(e.matrix),void 0!==e.matrixAutoUpdate&&(i.matrixAutoUpdate=e.matrixAutoUpdate),i.matrixAutoUpdate&&i.matrix.decompose(i.position,i.quaternion,i.scale)):(void 0!==e.position&&i.position.fromArray(e.position),void 0!==e.rotation&&i.rotation.fromArray(e.rotation),void 0!==e.quaternion&&i.quaternion.fromArray(e.quaternion),void 0!==e.scale&&i.scale.fromArray(e.scale)),void 0!==e.castShadow&&(i.castShadow=e.castShadow),void 0!==e.receiveShadow&&(i.receiveShadow=e.receiveShadow),e.shadow&&(void 0!==e.shadow.bias&&(i.shadow.bias=e.shadow.bias),void 0!==e.shadow.normalBias&&(i.shadow.normalBias=e.shadow.normalBias),void 0!==e.shadow.radius&&(i.shadow.radius=e.shadow.radius),void 0!==e.shadow.mapSize&&i.shadow.mapSize.fromArray(e.shadow.mapSize),void 0!==e.shadow.camera&&(i.shadow.camera=this.parseObject(e.shadow.camera))),void 0!==e.visible&&(i.visible=e.visible),void 0!==e.frustumCulled&&(i.frustumCulled=e.frustumCulled),void 0!==e.renderOrder&&(i.renderOrder=e.renderOrder),void 0!==e.userData&&(i.userData=e.userData),void 0!==e.layers&&(i.layers.mask=e.layers),void 0!==e.children){const a=e.children;for(let e=0;e<a.length;e++)i.add(this.parseObject(a[e],t,r,n))}if(void 0!==e.animations){const t=e.animations;for(let e=0;e<t.length;e++){const r=t[e];i.animations.push(n[r])}}if("LOD"===e.type){void 0!==e.autoUpdate&&(i.autoUpdate=e.autoUpdate);const t=e.levels;for(let e=0;e<t.length;e++){const r=t[e],n=i.getObjectByProperty("uuid",r.object);void 0!==n&&i.addLevel(n,r.distance)}}return i}bindSkeletons(e,t){0!==Object.keys(t).length&&e.traverse((function(e){if(!0===e.isSkinnedMesh&&void 0!==e.skeleton){const r=t[e.skeleton];void 0===r?console.warn("THREE.ObjectLoader: No skeleton found with UUID:",e.skeleton):e.bind(r,e.bindMatrix)}}))}setTexturePath(e){return console.warn("THREE.ObjectLoader: .setTexturePath() has been renamed to .setResourcePath()."),this.setResourcePath(e)}}const TEXTURE_MAPPING={UVMapping:UVMapping,CubeReflectionMapping:CubeReflectionMapping,CubeRefractionMapping:CubeRefractionMapping,EquirectangularReflectionMapping:EquirectangularReflectionMapping,EquirectangularRefractionMapping:EquirectangularRefractionMapping,CubeUVReflectionMapping:CubeUVReflectionMapping,CubeUVRefractionMapping:CubeUVRefractionMapping},TEXTURE_WRAPPING={RepeatWrapping:RepeatWrapping,ClampToEdgeWrapping:ClampToEdgeWrapping,MirroredRepeatWrapping:MirroredRepeatWrapping},TEXTURE_FILTER={NearestFilter:NearestFilter,NearestMipmapNearestFilter:NearestMipmapNearestFilter,NearestMipmapLinearFilter:NearestMipmapLinearFilter,LinearFilter:LinearFilter,LinearMipmapNearestFilter:LinearMipmapNearestFilter,LinearMipmapLinearFilter:LinearMipmapLinearFilter};function ImageBitmapLoader(e){"undefined"==typeof createImageBitmap&&console.warn("THREE.ImageBitmapLoader: createImageBitmap() not supported."),"undefined"==typeof fetch&&console.warn("THREE.ImageBitmapLoader: fetch() not supported."),Loader.call(this,e),this.options={premultiplyAlpha:"none"}}ImageBitmapLoader.prototype=Object.assign(Object.create(Loader.prototype),{constructor:ImageBitmapLoader,isImageBitmapLoader:!0,setOptions:function(e){return this.options=e,this},load:function(e,t,r,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const i=this,a=Cache.get(e);if(void 0!==a)return i.manager.itemStart(e),setTimeout((function(){t&&t(a),i.manager.itemEnd(e)}),0),a;const o={};o.credentials="anonymous"===this.crossOrigin?"same-origin":"include",o.headers=this.requestHeader,fetch(e,o).then((function(e){return e.blob()})).then((function(e){return createImageBitmap(e,Object.assign(i.options,{colorSpaceConversion:"none"}))})).then((function(r){Cache.add(e,r),t&&t(r),i.manager.itemEnd(e)})).catch((function(t){n&&n(t),i.manager.itemError(e),i.manager.itemEnd(e)})),i.manager.itemStart(e)}});class ShapePath{constructor(){this.type="ShapePath",this.color=new Color,this.subPaths=[],this.currentPath=null}moveTo(e,t){return this.currentPath=new Path$1,this.subPaths.push(this.currentPath),this.currentPath.moveTo(e,t),this}lineTo(e,t){return this.currentPath.lineTo(e,t),this}quadraticCurveTo(e,t,r,n){return this.currentPath.quadraticCurveTo(e,t,r,n),this}bezierCurveTo(e,t,r,n,i,a){return this.currentPath.bezierCurveTo(e,t,r,n,i,a),this}splineThru(e){return this.currentPath.splineThru(e),this}toShapes(e,t){function r(e){const t=[];for(let r=0,n=e.length;r<n;r++){const n=e[r],i=new Shape;i.curves=n.curves,t.push(i)}return t}function n(e,t){const r=t.length;let n=!1;for(let i=r-1,a=0;a<r;i=a++){let r=t[i],o=t[a],s=o.x-r.x,l=o.y-r.y;if(Math.abs(l)>Number.EPSILON){if(l<0&&(r=t[a],s=-s,o=t[i],l=-l),e.y<r.y||e.y>o.y)continue;if(e.y===r.y){if(e.x===r.x)return!0}else{const t=l*(e.x-r.x)-s*(e.y-r.y);if(0===t)return!0;if(t<0)continue;n=!n}}else{if(e.y!==r.y)continue;if(o.x<=e.x&&e.x<=r.x||r.x<=e.x&&e.x<=o.x)return!0}}return n}const i=ShapeUtils.isClockWise,a=this.subPaths;if(0===a.length)return[];if(!0===t)return r(a);let o,s,l;const c=[];if(1===a.length)return s=a[0],l=new Shape,l.curves=s.curves,c.push(l),c;let h=!i(a[0].getPoints());h=e?!h:h;const u=[],d=[];let p,f,m=[],g=0;d[g]=void 0,m[g]=[];for(let t=0,r=a.length;t<r;t++)s=a[t],p=s.getPoints(),o=i(p),o=e?!o:o,o?(!h&&d[g]&&g++,d[g]={s:new Shape,p:p},d[g].s.curves=s.curves,h&&g++,m[g]=[]):m[g].push({h:s,p:p[0]});if(!d[0])return r(a);if(d.length>1){let e=!1;const t=[];for(let e=0,t=d.length;e<t;e++)u[e]=[];for(let r=0,i=d.length;r<i;r++){const i=m[r];for(let a=0;a<i.length;a++){const o=i[a];let s=!0;for(let i=0;i<d.length;i++)n(o.p,d[i].p)&&(r!==i&&t.push({froms:r,tos:i,hole:a}),s?(s=!1,u[i].push(o)):e=!0);s&&u[r].push(o)}}t.length>0&&(e||(m=u))}for(let e=0,t=d.length;e<t;e++){l=d[e].s,c.push(l),f=m[e];for(let e=0,t=f.length;e<t;e++)l.holes.push(f[e].h)}return c}}class Font{constructor(e){this.type="Font",this.data=e}generateShapes(e,t=100){const r=[],n=createPaths(e,t,this.data);for(let e=0,t=n.length;e<t;e++)Array.prototype.push.apply(r,n[e].toShapes());return r}}function createPaths(e,t,r){const n=Array.from(e),i=t/r.resolution,a=(r.boundingBox.yMax-r.boundingBox.yMin+r.underlineThickness)*i,o=[];let s=0,l=0;for(let e=0;e<n.length;e++){const t=n[e];if("\n"===t)s=0,l-=a;else{const e=createPath(t,i,s,l,r);s+=e.offsetX,o.push(e.path)}}return o}function createPath(e,t,r,n,i){const a=i.glyphs[e]||i.glyphs["?"];if(!a)return void console.error('THREE.Font: character "'+e+'" does not exists in font family '+i.familyName+".");const o=new ShapePath;let s,l,c,h,u,d,p,f;if(a.o){const e=a._cachedOutline||(a._cachedOutline=a.o.split(" "));for(let i=0,a=e.length;i<a;){switch(e[i++]){case"m":s=e[i++]*t+r,l=e[i++]*t+n,o.moveTo(s,l);break;case"l":s=e[i++]*t+r,l=e[i++]*t+n,o.lineTo(s,l);break;case"q":c=e[i++]*t+r,h=e[i++]*t+n,u=e[i++]*t+r,d=e[i++]*t+n,o.quadraticCurveTo(u,d,c,h);break;case"b":c=e[i++]*t+r,h=e[i++]*t+n,u=e[i++]*t+r,d=e[i++]*t+n,p=e[i++]*t+r,f=e[i++]*t+n,o.bezierCurveTo(u,d,p,f,c,h)}}}return{offsetX:a.ha*t,path:o}}Font.prototype.isFont=!0;class FontLoader extends Loader{constructor(e){super(e)}load(e,t,r,n){const i=this,a=new FileLoader(this.manager);a.setPath(this.path),a.setRequestHeader(this.requestHeader),a.setWithCredentials(i.withCredentials),a.load(e,(function(e){let r;try{r=JSON.parse(e)}catch(t){console.warn("THREE.FontLoader: typeface.js support is being deprecated. Use typeface.json instead."),r=JSON.parse(e.substring(65,e.length-2))}const n=i.parse(r);t&&t(n)}),r,n)}parse(e){return new Font(e)}}let _context$1;const AudioContext={getContext:function(){return void 0===_context$1&&(_context$1=new(window.AudioContext||window.webkitAudioContext)),_context$1},setContext:function(e){_context$1=e}};class AudioLoader extends Loader{constructor(e){super(e)}load(e,t,r,n){const i=this,a=new FileLoader(this.manager);a.setResponseType("arraybuffer"),a.setPath(this.path),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,(function(r){try{const e=r.slice(0);AudioContext.getContext().decodeAudioData(e,(function(e){t(e)}))}catch(t){n?n(t):console.error(t),i.manager.itemError(e)}}),r,n)}}class HemisphereLightProbe extends LightProbe{constructor(e,t,r=1){super(void 0,r);const n=(new Color).set(e),i=(new Color).set(t),a=new Vector3(n.r,n.g,n.b),o=new Vector3(i.r,i.g,i.b),s=Math.sqrt(Math.PI),l=s*Math.sqrt(.75);this.sh.coefficients[0].copy(a).add(o).multiplyScalar(s),this.sh.coefficients[1].copy(a).sub(o).multiplyScalar(l)}}HemisphereLightProbe.prototype.isHemisphereLightProbe=!0;class AmbientLightProbe extends LightProbe{constructor(e,t=1){super(void 0,t);const r=(new Color).set(e);this.sh.coefficients[0].set(r.r,r.g,r.b).multiplyScalar(2*Math.sqrt(Math.PI))}}AmbientLightProbe.prototype.isAmbientLightProbe=!0;const _eyeRight=new Matrix4,_eyeLeft=new Matrix4;class StereoCamera{constructor(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new PerspectiveCamera,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new PerspectiveCamera,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1,this._cache={focus:null,fov:null,aspect:null,near:null,far:null,zoom:null,eyeSep:null}}update(e){const t=this._cache;if(t.focus!==e.focus||t.fov!==e.fov||t.aspect!==e.aspect*this.aspect||t.near!==e.near||t.far!==e.far||t.zoom!==e.zoom||t.eyeSep!==this.eyeSep){t.focus=e.focus,t.fov=e.fov,t.aspect=e.aspect*this.aspect,t.near=e.near,t.far=e.far,t.zoom=e.zoom,t.eyeSep=this.eyeSep;const r=e.projectionMatrix.clone(),n=t.eyeSep/2,i=n*t.near/t.focus,a=t.near*Math.tan(MathUtils.DEG2RAD*t.fov*.5)/t.zoom;let o,s;_eyeLeft.elements[12]=-n,_eyeRight.elements[12]=n,o=-a*t.aspect+i,s=a*t.aspect+i,r.elements[0]=2*t.near/(s-o),r.elements[8]=(s+o)/(s-o),this.cameraL.projectionMatrix.copy(r),o=-a*t.aspect-i,s=a*t.aspect-i,r.elements[0]=2*t.near/(s-o),r.elements[8]=(s+o)/(s-o),this.cameraR.projectionMatrix.copy(r)}this.cameraL.matrixWorld.copy(e.matrixWorld).multiply(_eyeLeft),this.cameraR.matrixWorld.copy(e.matrixWorld).multiply(_eyeRight)}}class Clock{constructor(e){this.autoStart=void 0===e||e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const t=now();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}function now(){return("undefined"==typeof performance?Date:performance).now()}const _position$2=new Vector3,_quaternion$3=new Quaternion,_scale$1=new Vector3,_orientation=new Vector3;class AudioListener extends Object3D{constructor(){super(),this.type="AudioListener",this.context=AudioContext.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null,this.timeDelta=0,this._clock=new Clock}getInput(){return this.gain}removeFilter(){return null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null),this}getFilter(){return this.filter}setFilter(e){return null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=e,this.gain.connect(this.filter),this.filter.connect(this.context.destination),this}getMasterVolume(){return this.gain.gain.value}setMasterVolume(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this}updateMatrixWorld(e){super.updateMatrixWorld(e);const t=this.context.listener,r=this.up;if(this.timeDelta=this._clock.getDelta(),this.matrixWorld.decompose(_position$2,_quaternion$3,_scale$1),_orientation.set(0,0,-1).applyQuaternion(_quaternion$3),t.positionX){const e=this.context.currentTime+this.timeDelta;t.positionX.linearRampToValueAtTime(_position$2.x,e),t.positionY.linearRampToValueAtTime(_position$2.y,e),t.positionZ.linearRampToValueAtTime(_position$2.z,e),t.forwardX.linearRampToValueAtTime(_orientation.x,e),t.forwardY.linearRampToValueAtTime(_orientation.y,e),t.forwardZ.linearRampToValueAtTime(_orientation.z,e),t.upX.linearRampToValueAtTime(r.x,e),t.upY.linearRampToValueAtTime(r.y,e),t.upZ.linearRampToValueAtTime(r.z,e)}else t.setPosition(_position$2.x,_position$2.y,_position$2.z),t.setOrientation(_orientation.x,_orientation.y,_orientation.z,r.x,r.y,r.z)}}class Audio extends Object3D{constructor(e){super(),this.type="Audio",this.listener=e,this.context=e.context,this.gain=this.context.createGain(),this.gain.connect(e.getInput()),this.autoplay=!1,this.buffer=null,this.detune=0,this.loop=!1,this.loopStart=0,this.loopEnd=0,this.offset=0,this.duration=void 0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.source=null,this.sourceType="empty",this._startedAt=0,this._progress=0,this._connected=!1,this.filters=[]}getOutput(){return this.gain}setNodeSource(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this}setMediaElementSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(e),this.connect(),this}setMediaStreamSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaStreamNode",this.source=this.context.createMediaStreamSource(e),this.connect(),this}setBuffer(e){return this.buffer=e,this.sourceType="buffer",this.autoplay&&this.play(),this}play(e=0){if(!0===this.isPlaying)return void console.warn("THREE.Audio: Audio is already playing.");if(!1===this.hasPlaybackControl)return void console.warn("THREE.Audio: this Audio has no playback control.");this._startedAt=this.context.currentTime+e;const t=this.context.createBufferSource();return t.buffer=this.buffer,t.loop=this.loop,t.loopStart=this.loopStart,t.loopEnd=this.loopEnd,t.onended=this.onEnded.bind(this),t.start(this._startedAt,this._progress+this.offset,this.duration),this.isPlaying=!0,this.source=t,this.setDetune(this.detune),this.setPlaybackRate(this.playbackRate),this.connect()}pause(){if(!1!==this.hasPlaybackControl)return!0===this.isPlaying&&(this._progress+=Math.max(this.context.currentTime-this._startedAt,0)*this.playbackRate,!0===this.loop&&(this._progress=this._progress%(this.duration||this.buffer.duration)),this.source.stop(),this.source.onended=null,this.isPlaying=!1),this;console.warn("THREE.Audio: this Audio has no playback control.")}stop(){if(!1!==this.hasPlaybackControl)return this._progress=0,this.source.stop(),this.source.onended=null,this.isPlaying=!1,this;console.warn("THREE.Audio: this Audio has no playback control.")}connect(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(let e=1,t=this.filters.length;e<t;e++)this.filters[e-1].connect(this.filters[e]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this._connected=!0,this}disconnect(){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(let e=1,t=this.filters.length;e<t;e++)this.filters[e-1].disconnect(this.filters[e]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this._connected=!1,this}getFilters(){return this.filters}setFilters(e){return e||(e=[]),!0===this._connected?(this.disconnect(),this.filters=e.slice(),this.connect()):this.filters=e.slice(),this}setDetune(e){if(this.detune=e,void 0!==this.source.detune)return!0===this.isPlaying&&this.source.detune.setTargetAtTime(this.detune,this.context.currentTime,.01),this}getDetune(){return this.detune}getFilter(){return this.getFilters()[0]}setFilter(e){return this.setFilters(e?[e]:[])}setPlaybackRate(e){if(!1!==this.hasPlaybackControl)return this.playbackRate=e,!0===this.isPlaying&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01),this;console.warn("THREE.Audio: this Audio has no playback control.")}getPlaybackRate(){return this.playbackRate}onEnded(){this.isPlaying=!1}getLoop(){return!1===this.hasPlaybackControl?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.loop}setLoop(e){if(!1!==this.hasPlaybackControl)return this.loop=e,!0===this.isPlaying&&(this.source.loop=this.loop),this;console.warn("THREE.Audio: this Audio has no playback control.")}setLoopStart(e){return this.loopStart=e,this}setLoopEnd(e){return this.loopEnd=e,this}getVolume(){return this.gain.gain.value}setVolume(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this}}const _position$3=new Vector3,_quaternion$4=new Quaternion,_scale$2=new Vector3,_orientation$1=new Vector3;class PositionalAudio extends Audio{constructor(e){super(e),this.panner=this.context.createPanner(),this.panner.panningModel="HRTF",this.panner.connect(this.gain)}getOutput(){return this.panner}getRefDistance(){return this.panner.refDistance}setRefDistance(e){return this.panner.refDistance=e,this}getRolloffFactor(){return this.panner.rolloffFactor}setRolloffFactor(e){return this.panner.rolloffFactor=e,this}getDistanceModel(){return this.panner.distanceModel}setDistanceModel(e){return this.panner.distanceModel=e,this}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(e){return this.panner.maxDistance=e,this}setDirectionalCone(e,t,r){return this.panner.coneInnerAngle=e,this.panner.coneOuterAngle=t,this.panner.coneOuterGain=r,this}updateMatrixWorld(e){if(super.updateMatrixWorld(e),!0===this.hasPlaybackControl&&!1===this.isPlaying)return;this.matrixWorld.decompose(_position$3,_quaternion$4,_scale$2),_orientation$1.set(0,0,1).applyQuaternion(_quaternion$4);const t=this.panner;if(t.positionX){const e=this.context.currentTime+this.listener.timeDelta;t.positionX.linearRampToValueAtTime(_position$3.x,e),t.positionY.linearRampToValueAtTime(_position$3.y,e),t.positionZ.linearRampToValueAtTime(_position$3.z,e),t.orientationX.linearRampToValueAtTime(_orientation$1.x,e),t.orientationY.linearRampToValueAtTime(_orientation$1.y,e),t.orientationZ.linearRampToValueAtTime(_orientation$1.z,e)}else t.setPosition(_position$3.x,_position$3.y,_position$3.z),t.setOrientation(_orientation$1.x,_orientation$1.y,_orientation$1.z)}}class AudioAnalyser{constructor(e,t=2048){this.analyser=e.context.createAnalyser(),this.analyser.fftSize=t,this.data=new Uint8Array(this.analyser.frequencyBinCount),e.getOutput().connect(this.analyser)}getFrequencyData(){return this.analyser.getByteFrequencyData(this.data),this.data}getAverageFrequency(){let e=0;const t=this.getFrequencyData();for(let r=0;r<t.length;r++)e+=t[r];return e/t.length}}class PropertyMixer{constructor(e,t,r){let n,i,a;switch(this.binding=e,this.valueSize=r,t){case"quaternion":n=this._slerp,i=this._slerpAdditive,a=this._setAdditiveIdentityQuaternion,this.buffer=new Float64Array(6*r),this._workIndex=5;break;case"string":case"bool":n=this._select,i=this._select,a=this._setAdditiveIdentityOther,this.buffer=new Array(5*r);break;default:n=this._lerp,i=this._lerpAdditive,a=this._setAdditiveIdentityNumeric,this.buffer=new Float64Array(5*r)}this._mixBufferRegion=n,this._mixBufferRegionAdditive=i,this._setIdentity=a,this._origIndex=3,this._addIndex=4,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,this.useCount=0,this.referenceCount=0}accumulate(e,t){const r=this.buffer,n=this.valueSize,i=e*n+n;let a=this.cumulativeWeight;if(0===a){for(let e=0;e!==n;++e)r[i+e]=r[e];a=t}else{a+=t;const e=t/a;this._mixBufferRegion(r,i,0,e,n)}this.cumulativeWeight=a}accumulateAdditive(e){const t=this.buffer,r=this.valueSize,n=r*this._addIndex;0===this.cumulativeWeightAdditive&&this._setIdentity(),this._mixBufferRegionAdditive(t,n,0,e,r),this.cumulativeWeightAdditive+=e}apply(e){const t=this.valueSize,r=this.buffer,n=e*t+t,i=this.cumulativeWeight,a=this.cumulativeWeightAdditive,o=this.binding;if(this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,i<1){const e=t*this._origIndex;this._mixBufferRegion(r,n,e,1-i,t)}a>0&&this._mixBufferRegionAdditive(r,n,this._addIndex*t,1,t);for(let e=t,i=t+t;e!==i;++e)if(r[e]!==r[e+t]){o.setValue(r,n);break}}saveOriginalState(){const e=this.binding,t=this.buffer,r=this.valueSize,n=r*this._origIndex;e.getValue(t,n);for(let e=r,i=n;e!==i;++e)t[e]=t[n+e%r];this._setIdentity(),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0}restoreOriginalState(){const e=3*this.valueSize;this.binding.setValue(this.buffer,e)}_setAdditiveIdentityNumeric(){const e=this._addIndex*this.valueSize,t=e+this.valueSize;for(let r=e;r<t;r++)this.buffer[r]=0}_setAdditiveIdentityQuaternion(){this._setAdditiveIdentityNumeric(),this.buffer[this._addIndex*this.valueSize+3]=1}_setAdditiveIdentityOther(){const e=this._origIndex*this.valueSize,t=this._addIndex*this.valueSize;for(let r=0;r<this.valueSize;r++)this.buffer[t+r]=this.buffer[e+r]}_select(e,t,r,n,i){if(n>=.5)for(let n=0;n!==i;++n)e[t+n]=e[r+n]}_slerp(e,t,r,n){Quaternion.slerpFlat(e,t,e,t,e,r,n)}_slerpAdditive(e,t,r,n,i){const a=this._workIndex*i;Quaternion.multiplyQuaternionsFlat(e,a,e,t,e,r),Quaternion.slerpFlat(e,t,e,t,e,a,n)}_lerp(e,t,r,n,i){const a=1-n;for(let o=0;o!==i;++o){const i=t+o;e[i]=e[i]*a+e[r+o]*n}}_lerpAdditive(e,t,r,n,i){for(let a=0;a!==i;++a){const i=t+a;e[i]=e[i]+e[r+a]*n}}}const _RESERVED_CHARS_RE="\\[\\]\\.:\\/",_reservedRe=new RegExp("["+_RESERVED_CHARS_RE+"]","g"),_wordChar="[^"+_RESERVED_CHARS_RE+"]",_wordCharOrDot="[^"+_RESERVED_CHARS_RE.replace("\\.","")+"]",_directoryRe=/((?:WC+[\/:])*)/.source.replace("WC",_wordChar),_nodeRe=/(WCOD+)?/.source.replace("WCOD",_wordCharOrDot),_objectRe=/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",_wordChar),_propertyRe=/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",_wordChar),_trackRe=new RegExp("^"+_directoryRe+_nodeRe+_objectRe+_propertyRe+"$"),_supportedObjectNames=["material","materials","bones"];function Composite(e,t,r){const n=r||PropertyBinding.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,n)}function PropertyBinding(e,t,r){this.path=t,this.parsedPath=r||PropertyBinding.parseTrackName(t),this.node=PropertyBinding.findNode(e,this.parsedPath.nodeName)||e,this.rootNode=e}Object.assign(Composite.prototype,{getValue:function(e,t){this.bind();const r=this._targetGroup.nCachedObjects_,n=this._bindings[r];void 0!==n&&n.getValue(e,t)},setValue:function(e,t){const r=this._bindings;for(let n=this._targetGroup.nCachedObjects_,i=r.length;n!==i;++n)r[n].setValue(e,t)},bind:function(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,r=e.length;t!==r;++t)e[t].bind()},unbind:function(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,r=e.length;t!==r;++t)e[t].unbind()}}),Object.assign(PropertyBinding,{Composite:Composite,create:function(e,t,r){return e&&e.isAnimationObjectGroup?new PropertyBinding.Composite(e,t,r):new PropertyBinding(e,t,r)},sanitizeNodeName:function(e){return e.replace(/\s/g,"_").replace(_reservedRe,"")},parseTrackName:function(e){const t=_trackRe.exec(e);if(!t)throw new Error("PropertyBinding: Cannot parse trackName: "+e);const r={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},n=r.nodeName&&r.nodeName.lastIndexOf(".");if(void 0!==n&&-1!==n){const e=r.nodeName.substring(n+1);-1!==_supportedObjectNames.indexOf(e)&&(r.nodeName=r.nodeName.substring(0,n),r.objectName=e)}if(null===r.propertyName||0===r.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return r},findNode:function(e,t){if(!t||""===t||"."===t||-1===t||t===e.name||t===e.uuid)return e;if(e.skeleton){const r=e.skeleton.getBoneByName(t);if(void 0!==r)return r}if(e.children){const r=function(e){for(let n=0;n<e.length;n++){const i=e[n];if(i.name===t||i.uuid===t)return i;const a=r(i.children);if(a)return a}return null},n=r(e.children);if(n)return n}return null}}),Object.assign(PropertyBinding.prototype,{_getValue_unavailable:function(){},_setValue_unavailable:function(){},BindingType:{Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Versioning:{None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},GetterByBindingType:[function(e,t){e[t]=this.node[this.propertyName]},function(e,t){const r=this.resolvedProperty;for(let n=0,i=r.length;n!==i;++n)e[t++]=r[n]},function(e,t){e[t]=this.resolvedProperty[this.propertyIndex]},function(e,t){this.resolvedProperty.toArray(e,t)}],SetterByBindingTypeAndVersioning:[[function(e,t){this.targetObject[this.propertyName]=e[t]},function(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.needsUpdate=!0},function(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){const r=this.resolvedProperty;for(let n=0,i=r.length;n!==i;++n)r[n]=e[t++]},function(e,t){const r=this.resolvedProperty;for(let n=0,i=r.length;n!==i;++n)r[n]=e[t++];this.targetObject.needsUpdate=!0},function(e,t){const r=this.resolvedProperty;for(let n=0,i=r.length;n!==i;++n)r[n]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){this.resolvedProperty[this.propertyIndex]=e[t]},function(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0},function(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){this.resolvedProperty.fromArray(e,t)},function(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0},function(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}]],getValue:function(e,t){this.bind(),this.getValue(e,t)},setValue:function(e,t){this.bind(),this.setValue(e,t)},bind:function(){let e=this.node;const t=this.parsedPath,r=t.objectName,n=t.propertyName;let i=t.propertyIndex;if(e||(e=PropertyBinding.findNode(this.rootNode,t.nodeName)||this.rootNode,this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e)return void console.error("THREE.PropertyBinding: Trying to update node for track: "+this.path+" but it wasn't found.");if(r){let n=t.objectIndex;switch(r){case"materials":if(!e.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);e=e.material.materials;break;case"bones":if(!e.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);e=e.skeleton.bones;for(let t=0;t<e.length;t++)if(e[t].name===n){n=t;break}break;default:if(void 0===e[r])return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);e=e[r]}if(void 0!==n){if(void 0===e[n])return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,e);e=e[n]}}const a=e[n];if(void 0===a){const r=t.nodeName;return void console.error("THREE.PropertyBinding: Trying to update property for track: "+r+"."+n+" but it wasn't found.",e)}let o=this.Versioning.None;this.targetObject=e,void 0!==e.needsUpdate?o=this.Versioning.NeedsUpdate:void 0!==e.matrixWorldNeedsUpdate&&(o=this.Versioning.MatrixWorldNeedsUpdate);let s=this.BindingType.Direct;if(void 0!==i){if("morphTargetInfluences"===n){if(!e.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!e.geometry.isBufferGeometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences on THREE.Geometry. Use THREE.BufferGeometry instead.",this);if(!e.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);void 0!==e.morphTargetDictionary[i]&&(i=e.morphTargetDictionary[i])}s=this.BindingType.ArrayElement,this.resolvedProperty=a,this.propertyIndex=i}else void 0!==a.fromArray&&void 0!==a.toArray?(s=this.BindingType.HasFromToArray,this.resolvedProperty=a):Array.isArray(a)?(s=this.BindingType.EntireArray,this.resolvedProperty=a):this.propertyName=n;this.getValue=this.GetterByBindingType[s],this.setValue=this.SetterByBindingTypeAndVersioning[s][o]},unbind:function(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}),Object.assign(PropertyBinding.prototype,{_getValue_unbound:PropertyBinding.prototype.getValue,_setValue_unbound:PropertyBinding.prototype.setValue});class AnimationObjectGroup{constructor(){this.uuid=MathUtils.generateUUID(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;const e={};this._indicesByUUID=e;for(let t=0,r=arguments.length;t!==r;++t)e[arguments[t].uuid]=t;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};const t=this;this.stats={objects:{get total(){return t._objects.length},get inUse(){return this.total-t.nCachedObjects_}},get bindingsPerObject(){return t._bindings.length}}}add(){const e=this._objects,t=this._indicesByUUID,r=this._paths,n=this._parsedPaths,i=this._bindings,a=i.length;let o,s=e.length,l=this.nCachedObjects_;for(let c=0,h=arguments.length;c!==h;++c){const h=arguments[c],u=h.uuid;let d=t[u];if(void 0===d){d=s++,t[u]=d,e.push(h);for(let e=0,t=a;e!==t;++e)i[e].push(new PropertyBinding(h,r[e],n[e]))}else if(d<l){o=e[d];const s=--l,c=e[s];t[c.uuid]=d,e[d]=c,t[u]=s,e[s]=h;for(let e=0,t=a;e!==t;++e){const t=i[e],a=t[s];let o=t[d];t[d]=a,void 0===o&&(o=new PropertyBinding(h,r[e],n[e])),t[s]=o}}else e[d]!==o&&console.error("THREE.AnimationObjectGroup: Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes.")}this.nCachedObjects_=l}remove(){const e=this._objects,t=this._indicesByUUID,r=this._bindings,n=r.length;let i=this.nCachedObjects_;for(let a=0,o=arguments.length;a!==o;++a){const o=arguments[a],s=o.uuid,l=t[s];if(void 0!==l&&l>=i){const a=i++,c=e[a];t[c.uuid]=l,e[l]=c,t[s]=a,e[a]=o;for(let e=0,t=n;e!==t;++e){const t=r[e],n=t[a],i=t[l];t[l]=n,t[a]=i}}}this.nCachedObjects_=i}uncache(){const e=this._objects,t=this._indicesByUUID,r=this._bindings,n=r.length;let i=this.nCachedObjects_,a=e.length;for(let o=0,s=arguments.length;o!==s;++o){const s=arguments[o].uuid,l=t[s];if(void 0!==l)if(delete t[s],l<i){const o=--i,s=e[o],c=--a,h=e[c];t[s.uuid]=l,e[l]=s,t[h.uuid]=o,e[o]=h,e.pop();for(let e=0,t=n;e!==t;++e){const t=r[e],n=t[o],i=t[c];t[l]=n,t[o]=i,t.pop()}}else{const i=--a,o=e[i];i>0&&(t[o.uuid]=l),e[l]=o,e.pop();for(let e=0,t=n;e!==t;++e){const t=r[e];t[l]=t[i],t.pop()}}}this.nCachedObjects_=i}subscribe_(e,t){const r=this._bindingsIndicesByPath;let n=r[e];const i=this._bindings;if(void 0!==n)return i[n];const a=this._paths,o=this._parsedPaths,s=this._objects,l=s.length,c=this.nCachedObjects_,h=new Array(l);n=i.length,r[e]=n,a.push(e),o.push(t),i.push(h);for(let r=c,n=s.length;r!==n;++r){const n=s[r];h[r]=new PropertyBinding(n,e,t)}return h}unsubscribe_(e){const t=this._bindingsIndicesByPath,r=t[e];if(void 0!==r){const n=this._paths,i=this._parsedPaths,a=this._bindings,o=a.length-1,s=a[o];t[e[o]]=r,a[r]=s,a.pop(),i[r]=i[o],i.pop(),n[r]=n[o],n.pop()}}}AnimationObjectGroup.prototype.isAnimationObjectGroup=!0;class AnimationAction{constructor(e,t,r=null,n=t.blendMode){this._mixer=e,this._clip=t,this._localRoot=r,this.blendMode=n;const i=t.tracks,a=i.length,o=new Array(a),s={endingStart:ZeroCurvatureEnding,endingEnd:ZeroCurvatureEnding};for(let e=0;e!==a;++e){const t=i[e].createInterpolant(null);o[e]=t,t.settings=s}this._interpolantSettings=s,this._interpolants=o,this._propertyBindings=new Array(a),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=LoopRepeat,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}play(){return this._mixer._activateAction(this),this}stop(){return this._mixer._deactivateAction(this),this.reset()}reset(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()}isRunning(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)}isScheduled(){return this._mixer._isActiveAction(this)}startAt(e){return this._startTime=e,this}setLoop(e,t){return this.loop=e,this.repetitions=t,this}setEffectiveWeight(e){return this.weight=e,this._effectiveWeight=this.enabled?e:0,this.stopFading()}getEffectiveWeight(){return this._effectiveWeight}fadeIn(e){return this._scheduleFading(e,0,1)}fadeOut(e){return this._scheduleFading(e,1,0)}crossFadeFrom(e,t,r){if(e.fadeOut(t),this.fadeIn(t),r){const r=this._clip.duration,n=e._clip.duration,i=n/r,a=r/n;e.warp(1,i,t),this.warp(a,1,t)}return this}crossFadeTo(e,t,r){return e.crossFadeFrom(this,t,r)}stopFading(){const e=this._weightInterpolant;return null!==e&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}setEffectiveTimeScale(e){return this.timeScale=e,this._effectiveTimeScale=this.paused?0:e,this.stopWarping()}getEffectiveTimeScale(){return this._effectiveTimeScale}setDuration(e){return this.timeScale=this._clip.duration/e,this.stopWarping()}syncWith(e){return this.time=e.time,this.timeScale=e.timeScale,this.stopWarping()}halt(e){return this.warp(this._effectiveTimeScale,0,e)}warp(e,t,r){const n=this._mixer,i=n.time,a=this.timeScale;let o=this._timeScaleInterpolant;null===o&&(o=n._lendControlInterpolant(),this._timeScaleInterpolant=o);const s=o.parameterPositions,l=o.sampleValues;return s[0]=i,s[1]=i+r,l[0]=e/a,l[1]=t/a,this}stopWarping(){const e=this._timeScaleInterpolant;return null!==e&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}getMixer(){return this._mixer}getClip(){return this._clip}getRoot(){return this._localRoot||this._mixer._root}_update(e,t,r,n){if(!this.enabled)return void this._updateWeight(e);const i=this._startTime;if(null!==i){const n=(e-i)*r;if(n<0||0===r)return;this._startTime=null,t=r*n}t*=this._updateTimeScale(e);const a=this._updateTime(t),o=this._updateWeight(e);if(o>0){const e=this._interpolants,t=this._propertyBindings;switch(this.blendMode){case AdditiveAnimationBlendMode:for(let r=0,n=e.length;r!==n;++r)e[r].evaluate(a),t[r].accumulateAdditive(o);break;case NormalAnimationBlendMode:default:for(let r=0,i=e.length;r!==i;++r)e[r].evaluate(a),t[r].accumulate(n,o)}}}_updateWeight(e){let t=0;if(this.enabled){t=this.weight;const r=this._weightInterpolant;if(null!==r){const n=r.evaluate(e)[0];t*=n,e>r.parameterPositions[1]&&(this.stopFading(),0===n&&(this.enabled=!1))}}return this._effectiveWeight=t,t}_updateTimeScale(e){let t=0;if(!this.paused){t=this.timeScale;const r=this._timeScaleInterpolant;if(null!==r){t*=r.evaluate(e)[0],e>r.parameterPositions[1]&&(this.stopWarping(),0===t?this.paused=!0:this.timeScale=t)}}return this._effectiveTimeScale=t,t}_updateTime(e){const t=this._clip.duration,r=this.loop;let n=this.time+e,i=this._loopCount;const a=r===LoopPingPong;if(0===e)return-1===i?n:a&&1==(1&i)?t-n:n;if(r===LoopOnce){-1===i&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(n>=t)n=t;else{if(!(n<0)){this.time=n;break e}n=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=n,this._mixer.dispatchEvent({type:"finished",action:this,direction:e<0?-1:1})}}else{if(-1===i&&(e>=0?(i=0,this._setEndings(!0,0===this.repetitions,a)):this._setEndings(0===this.repetitions,!0,a)),n>=t||n<0){const r=Math.floor(n/t);n-=t*r,i+=Math.abs(r);const o=this.repetitions-i;if(o<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,n=e>0?t:0,this.time=n,this._mixer.dispatchEvent({type:"finished",action:this,direction:e>0?1:-1});else{if(1===o){const t=e<0;this._setEndings(t,!t,a)}else this._setEndings(!1,!1,a);this._loopCount=i,this.time=n,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:r})}}else this.time=n;if(a&&1==(1&i))return t-n}return n}_setEndings(e,t,r){const n=this._interpolantSettings;r?(n.endingStart=ZeroSlopeEnding,n.endingEnd=ZeroSlopeEnding):(n.endingStart=e?this.zeroSlopeAtStart?ZeroSlopeEnding:ZeroCurvatureEnding:WrapAroundEnding,n.endingEnd=t?this.zeroSlopeAtEnd?ZeroSlopeEnding:ZeroCurvatureEnding:WrapAroundEnding)}_scheduleFading(e,t,r){const n=this._mixer,i=n.time;let a=this._weightInterpolant;null===a&&(a=n._lendControlInterpolant(),this._weightInterpolant=a);const o=a.parameterPositions,s=a.sampleValues;return o[0]=i,s[0]=t,o[1]=i+e,s[1]=r,this}}class AnimationMixer extends EventDispatcher{constructor(e){super(),this._root=e,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}_bindAction(e,t){const r=e._localRoot||this._root,n=e._clip.tracks,i=n.length,a=e._propertyBindings,o=e._interpolants,s=r.uuid,l=this._bindingsByRootAndName;let c=l[s];void 0===c&&(c={},l[s]=c);for(let e=0;e!==i;++e){const i=n[e],l=i.name;let h=c[l];if(void 0!==h)a[e]=h;else{if(h=a[e],void 0!==h){null===h._cacheIndex&&(++h.referenceCount,this._addInactiveBinding(h,s,l));continue}const n=t&&t._propertyBindings[e].binding.parsedPath;h=new PropertyMixer(PropertyBinding.create(r,l,n),i.ValueTypeName,i.getValueSize()),++h.referenceCount,this._addInactiveBinding(h,s,l),a[e]=h}o[e].resultBuffer=h.buffer}}_activateAction(e){if(!this._isActiveAction(e)){if(null===e._cacheIndex){const t=(e._localRoot||this._root).uuid,r=e._clip.uuid,n=this._actionsByClip[r];this._bindAction(e,n&&n.knownActions[0]),this._addInactiveAction(e,r,t)}const t=e._propertyBindings;for(let e=0,r=t.length;e!==r;++e){const r=t[e];0==r.useCount++&&(this._lendBinding(r),r.saveOriginalState())}this._lendAction(e)}}_deactivateAction(e){if(this._isActiveAction(e)){const t=e._propertyBindings;for(let e=0,r=t.length;e!==r;++e){const r=t[e];0==--r.useCount&&(r.restoreOriginalState(),this._takeBackBinding(r))}this._takeBackAction(e)}}_initMemoryManager(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;const e=this;this.stats={actions:{get total(){return e._actions.length},get inUse(){return e._nActiveActions}},bindings:{get total(){return e._bindings.length},get inUse(){return e._nActiveBindings}},controlInterpolants:{get total(){return e._controlInterpolants.length},get inUse(){return e._nActiveControlInterpolants}}}}_isActiveAction(e){const t=e._cacheIndex;return null!==t&&t<this._nActiveActions}_addInactiveAction(e,t,r){const n=this._actions,i=this._actionsByClip;let a=i[t];if(void 0===a)a={knownActions:[e],actionByRoot:{}},e._byClipCacheIndex=0,i[t]=a;else{const t=a.knownActions;e._byClipCacheIndex=t.length,t.push(e)}e._cacheIndex=n.length,n.push(e),a.actionByRoot[r]=e}_removeInactiveAction(e){const t=this._actions,r=t[t.length-1],n=e._cacheIndex;r._cacheIndex=n,t[n]=r,t.pop(),e._cacheIndex=null;const i=e._clip.uuid,a=this._actionsByClip,o=a[i],s=o.knownActions,l=s[s.length-1],c=e._byClipCacheIndex;l._byClipCacheIndex=c,s[c]=l,s.pop(),e._byClipCacheIndex=null;delete o.actionByRoot[(e._localRoot||this._root).uuid],0===s.length&&delete a[i],this._removeInactiveBindingsForAction(e)}_removeInactiveBindingsForAction(e){const t=e._propertyBindings;for(let e=0,r=t.length;e!==r;++e){const r=t[e];0==--r.referenceCount&&this._removeInactiveBinding(r)}}_lendAction(e){const t=this._actions,r=e._cacheIndex,n=this._nActiveActions++,i=t[n];e._cacheIndex=n,t[n]=e,i._cacheIndex=r,t[r]=i}_takeBackAction(e){const t=this._actions,r=e._cacheIndex,n=--this._nActiveActions,i=t[n];e._cacheIndex=n,t[n]=e,i._cacheIndex=r,t[r]=i}_addInactiveBinding(e,t,r){const n=this._bindingsByRootAndName,i=this._bindings;let a=n[t];void 0===a&&(a={},n[t]=a),a[r]=e,e._cacheIndex=i.length,i.push(e)}_removeInactiveBinding(e){const t=this._bindings,r=e.binding,n=r.rootNode.uuid,i=r.path,a=this._bindingsByRootAndName,o=a[n],s=t[t.length-1],l=e._cacheIndex;s._cacheIndex=l,t[l]=s,t.pop(),delete o[i],0===Object.keys(o).length&&delete a[n]}_lendBinding(e){const t=this._bindings,r=e._cacheIndex,n=this._nActiveBindings++,i=t[n];e._cacheIndex=n,t[n]=e,i._cacheIndex=r,t[r]=i}_takeBackBinding(e){const t=this._bindings,r=e._cacheIndex,n=--this._nActiveBindings,i=t[n];e._cacheIndex=n,t[n]=e,i._cacheIndex=r,t[r]=i}_lendControlInterpolant(){const e=this._controlInterpolants,t=this._nActiveControlInterpolants++;let r=e[t];return void 0===r&&(r=new LinearInterpolant(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer),r.__cacheIndex=t,e[t]=r),r}_takeBackControlInterpolant(e){const t=this._controlInterpolants,r=e.__cacheIndex,n=--this._nActiveControlInterpolants,i=t[n];e.__cacheIndex=n,t[n]=e,i.__cacheIndex=r,t[r]=i}clipAction(e,t,r){const n=t||this._root,i=n.uuid;let a="string"==typeof e?AnimationClip.findByName(n,e):e;const o=null!==a?a.uuid:e,s=this._actionsByClip[o];let l=null;if(void 0===r&&(r=null!==a?a.blendMode:NormalAnimationBlendMode),void 0!==s){const e=s.actionByRoot[i];if(void 0!==e&&e.blendMode===r)return e;l=s.knownActions[0],null===a&&(a=l._clip)}if(null===a)return null;const c=new AnimationAction(this,a,t,r);return this._bindAction(c,l),this._addInactiveAction(c,o,i),c}existingAction(e,t){const r=t||this._root,n=r.uuid,i="string"==typeof e?AnimationClip.findByName(r,e):e,a=i?i.uuid:e,o=this._actionsByClip[a];return void 0!==o&&o.actionByRoot[n]||null}stopAllAction(){const e=this._actions;for(let t=this._nActiveActions-1;t>=0;--t)e[t].stop();return this}update(e){e*=this.timeScale;const t=this._actions,r=this._nActiveActions,n=this.time+=e,i=Math.sign(e),a=this._accuIndex^=1;for(let o=0;o!==r;++o){t[o]._update(n,e,i,a)}const o=this._bindings,s=this._nActiveBindings;for(let e=0;e!==s;++e)o[e].apply(a);return this}setTime(e){this.time=0;for(let e=0;e<this._actions.length;e++)this._actions[e].time=0;return this.update(e)}getRoot(){return this._root}uncacheClip(e){const t=this._actions,r=e.uuid,n=this._actionsByClip,i=n[r];if(void 0!==i){const e=i.knownActions;for(let r=0,n=e.length;r!==n;++r){const n=e[r];this._deactivateAction(n);const i=n._cacheIndex,a=t[t.length-1];n._cacheIndex=null,n._byClipCacheIndex=null,a._cacheIndex=i,t[i]=a,t.pop(),this._removeInactiveBindingsForAction(n)}delete n[r]}}uncacheRoot(e){const t=e.uuid,r=this._actionsByClip;for(const e in r){const n=r[e].actionByRoot[t];void 0!==n&&(this._deactivateAction(n),this._removeInactiveAction(n))}const n=this._bindingsByRootAndName[t];if(void 0!==n)for(const e in n){const t=n[e];t.restoreOriginalState(),this._removeInactiveBinding(t)}}uncacheAction(e,t){const r=this.existingAction(e,t);null!==r&&(this._deactivateAction(r),this._removeInactiveAction(r))}}AnimationMixer.prototype._controlInterpolantsResultBuffer=new Float32Array(1);class Uniform{constructor(e){"string"==typeof e&&(console.warn("THREE.Uniform: Type parameter is no longer needed."),e=arguments[1]),this.value=e}clone(){return new Uniform(void 0===this.value.clone?this.value:this.value.clone())}}function InstancedInterleavedBuffer(e,t,r){InterleavedBuffer.call(this,e,t),this.meshPerAttribute=r||1}function GLBufferAttribute(e,t,r,n,i){this.buffer=e,this.type=t,this.itemSize=r,this.elementSize=n,this.count=i,this.version=0}function Raycaster(e,t,r=0,n=1/0){this.ray=new Ray(e,t),this.near=r,this.far=n,this.camera=null,this.layers=new Layers,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}},Object.defineProperties(this.params,{PointCloud:{get:function(){return console.warn("THREE.Raycaster: params.PointCloud has been renamed to params.Points."),this.Points}}})}function ascSort(e,t){return e.distance-t.distance}function intersectObject(e,t,r,n){if(e.layers.test(t.layers)&&e.raycast(t,r),!0===n){const n=e.children;for(let e=0,i=n.length;e<i;e++)intersectObject(n[e],t,r,!0)}}InstancedInterleavedBuffer.prototype=Object.assign(Object.create(InterleavedBuffer.prototype),{constructor:InstancedInterleavedBuffer,isInstancedInterleavedBuffer:!0,copy:function(e){return InterleavedBuffer.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this},clone:function(e){const t=InterleavedBuffer.prototype.clone.call(this,e);return t.meshPerAttribute=this.meshPerAttribute,t},toJSON:function(e){const t=InterleavedBuffer.prototype.toJSON.call(this,e);return t.isInstancedInterleavedBuffer=!0,t.meshPerAttribute=this.meshPerAttribute,t}}),Object.defineProperty(GLBufferAttribute.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(GLBufferAttribute.prototype,{isGLBufferAttribute:!0,setBuffer:function(e){return this.buffer=e,this},setType:function(e,t){return this.type=e,this.elementSize=t,this},setItemSize:function(e){return this.itemSize=e,this},setCount:function(e){return this.count=e,this}}),Object.assign(Raycaster.prototype,{set:function(e,t){this.ray.set(e,t)},setFromCamera:function(e,t){t&&t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize(),this.camera=t):t&&t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld),this.camera=t):console.error("THREE.Raycaster: Unsupported camera type: "+t.type)},intersectObject:function(e,t=!1,r=[]){return intersectObject(e,this,r,t),r.sort(ascSort),r},intersectObjects:function(e,t=!1,r=[]){for(let n=0,i=e.length;n<i;n++)intersectObject(e[n],this,r,t);return r.sort(ascSort),r}});class Spherical{constructor(e=1,t=0,r=0){return this.radius=e,this.phi=t,this.theta=r,this}set(e,t,r){return this.radius=e,this.phi=t,this.theta=r,this}copy(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this}makeSafe(){const e=1e-6;return this.phi=Math.max(e,Math.min(Math.PI-e,this.phi)),this}setFromVector3(e){return this.setFromCartesianCoords(e.x,e.y,e.z)}setFromCartesianCoords(e,t,r){return this.radius=Math.sqrt(e*e+t*t+r*r),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e,r),this.phi=Math.acos(MathUtils.clamp(t/this.radius,-1,1))),this}clone(){return(new this.constructor).copy(this)}}class Cylindrical{constructor(e=1,t=0,r=0){return this.radius=e,this.theta=t,this.y=r,this}set(e,t,r){return this.radius=e,this.theta=t,this.y=r,this}copy(e){return this.radius=e.radius,this.theta=e.theta,this.y=e.y,this}setFromVector3(e){return this.setFromCartesianCoords(e.x,e.y,e.z)}setFromCartesianCoords(e,t,r){return this.radius=Math.sqrt(e*e+r*r),this.theta=Math.atan2(e,r),this.y=t,this}clone(){return(new this.constructor).copy(this)}}const _vector$8=new Vector2;class Box2{constructor(e=new Vector2(1/0,1/0),t=new Vector2(-1/0,-1/0)){this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromPoints(e){this.makeEmpty();for(let t=0,r=e.length;t<r;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const r=_vector$8.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(r),this.max.copy(e).add(r),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(e){return void 0===e&&(console.warn("THREE.Box2: .getCenter() target is now required"),e=new Vector2),this.isEmpty()?e.set(0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return void 0===e&&(console.warn("THREE.Box2: .getSize() target is now required"),e=new Vector2),this.isEmpty()?e.set(0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y}getParameter(e,t){return void 0===t&&(console.warn("THREE.Box2: .getParameter() target is now required"),t=new Vector2),t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)}clampPoint(e,t){return void 0===t&&(console.warn("THREE.Box2: .clampPoint() target is now required"),t=new Vector2),t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return _vector$8.copy(e).clamp(this.min,this.max).sub(e).length()}intersect(e){return this.min.max(e.min),this.max.min(e.max),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}Box2.prototype.isBox2=!0;const _startP=new Vector3,_startEnd=new Vector3;class Line3{constructor(e=new Vector3,t=new Vector3){this.start=e,this.end=t}set(e,t){return this.start.copy(e),this.end.copy(t),this}copy(e){return this.start.copy(e.start),this.end.copy(e.end),this}getCenter(e){return void 0===e&&(console.warn("THREE.Line3: .getCenter() target is now required"),e=new Vector3),e.addVectors(this.start,this.end).multiplyScalar(.5)}delta(e){return void 0===e&&(console.warn("THREE.Line3: .delta() target is now required"),e=new Vector3),e.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(e,t){return void 0===t&&(console.warn("THREE.Line3: .at() target is now required"),t=new Vector3),this.delta(t).multiplyScalar(e).add(this.start)}closestPointToPointParameter(e,t){_startP.subVectors(e,this.start),_startEnd.subVectors(this.end,this.start);const r=_startEnd.dot(_startEnd);let n=_startEnd.dot(_startP)/r;return t&&(n=MathUtils.clamp(n,0,1)),n}closestPointToPoint(e,t,r){const n=this.closestPointToPointParameter(e,t);return void 0===r&&(console.warn("THREE.Line3: .closestPointToPoint() target is now required"),r=new Vector3),this.delta(r).multiplyScalar(n).add(this.start)}applyMatrix4(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this}equals(e){return e.start.equals(this.start)&&e.end.equals(this.end)}clone(){return(new this.constructor).copy(this)}}function ImmediateRenderObject(e){Object3D.call(this),this.material=e,this.render=function(){},this.hasPositions=!1,this.hasNormals=!1,this.hasColors=!1,this.hasUvs=!1,this.positionArray=null,this.normalArray=null,this.colorArray=null,this.uvArray=null,this.count=0}ImmediateRenderObject.prototype=Object.create(Object3D.prototype),ImmediateRenderObject.prototype.constructor=ImmediateRenderObject,ImmediateRenderObject.prototype.isImmediateRenderObject=!0;const _vector$9=new Vector3;class SpotLightHelper extends Object3D{constructor(e,t){super(),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=t;const r=new BufferGeometry,n=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1];for(let e=0,t=1,r=32;e<r;e++,t++){const i=e/r*Math.PI*2,a=t/r*Math.PI*2;n.push(Math.cos(i),Math.sin(i),1,Math.cos(a),Math.sin(a),1)}r.setAttribute("position",new Float32BufferAttribute(n,3));const i=new LineBasicMaterial({fog:!1,toneMapped:!1});this.cone=new LineSegments(r,i),this.add(this.cone),this.update()}dispose(){this.cone.geometry.dispose(),this.cone.material.dispose()}update(){this.light.updateMatrixWorld();const e=this.light.distance?this.light.distance:1e3,t=e*Math.tan(this.light.angle);this.cone.scale.set(t,t,e),_vector$9.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(_vector$9),void 0!==this.color?this.cone.material.color.set(this.color):this.cone.material.color.copy(this.light.color)}}const _vector$a=new Vector3,_boneMatrix=new Matrix4,_matrixWorldInv=new Matrix4;class SkeletonHelper extends LineSegments{constructor(e){const t=getBoneList(e),r=new BufferGeometry,n=[],i=[],a=new Color(0,0,1),o=new Color(0,1,0);for(let e=0;e<t.length;e++){const r=t[e];r.parent&&r.parent.isBone&&(n.push(0,0,0),n.push(0,0,0),i.push(a.r,a.g,a.b),i.push(o.r,o.g,o.b))}r.setAttribute("position",new Float32BufferAttribute(n,3)),r.setAttribute("color",new Float32BufferAttribute(i,3));super(r,new LineBasicMaterial({vertexColors:!0,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.type="SkeletonHelper",this.isSkeletonHelper=!0,this.root=e,this.bones=t,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(e){const t=this.bones,r=this.geometry,n=r.getAttribute("position");_matrixWorldInv.copy(this.root.matrixWorld).invert();for(let e=0,r=0;e<t.length;e++){const i=t[e];i.parent&&i.parent.isBone&&(_boneMatrix.multiplyMatrices(_matrixWorldInv,i.matrixWorld),_vector$a.setFromMatrixPosition(_boneMatrix),n.setXYZ(r,_vector$a.x,_vector$a.y,_vector$a.z),_boneMatrix.multiplyMatrices(_matrixWorldInv,i.parent.matrixWorld),_vector$a.setFromMatrixPosition(_boneMatrix),n.setXYZ(r+1,_vector$a.x,_vector$a.y,_vector$a.z),r+=2)}r.getAttribute("position").needsUpdate=!0,super.updateMatrixWorld(e)}}function getBoneList(e){const t=[];e&&e.isBone&&t.push(e);for(let r=0;r<e.children.length;r++)t.push.apply(t,getBoneList(e.children[r]));return t}class PointLightHelper extends Mesh{constructor(e,t,r){super(new SphereGeometry(t,4,2),new MeshBasicMaterial({wireframe:!0,fog:!1,toneMapped:!1})),this.light=e,this.light.updateMatrixWorld(),this.color=r,this.type="PointLightHelper",this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1,this.update()}dispose(){this.geometry.dispose(),this.material.dispose()}update(){void 0!==this.color?this.material.color.set(this.color):this.material.color.copy(this.light.color)}}const _vector$b=new Vector3,_color1=new Color,_color2=new Color;class HemisphereLightHelper extends Object3D{constructor(e,t,r){super(),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=r;const n=new OctahedronGeometry(t);n.rotateY(.5*Math.PI),this.material=new MeshBasicMaterial({wireframe:!0,fog:!1,toneMapped:!1}),void 0===this.color&&(this.material.vertexColors=!0);const i=n.getAttribute("position"),a=new Float32Array(3*i.count);n.setAttribute("color",new BufferAttribute(a,3)),this.add(new Mesh(n,this.material)),this.update()}dispose(){this.children[0].geometry.dispose(),this.children[0].material.dispose()}update(){const e=this.children[0];if(void 0!==this.color)this.material.color.set(this.color);else{const t=e.geometry.getAttribute("color");_color1.copy(this.light.color),_color2.copy(this.light.groundColor);for(let e=0,r=t.count;e<r;e++){const n=e<r/2?_color1:_color2;t.setXYZ(e,n.r,n.g,n.b)}t.needsUpdate=!0}e.lookAt(_vector$b.setFromMatrixPosition(this.light.matrixWorld).negate())}}class GridHelper extends LineSegments{constructor(e=10,t=10,r=4473924,n=8947848){r=new Color(r),n=new Color(n);const i=t/2,a=e/t,o=e/2,s=[],l=[];for(let e=0,c=0,h=-o;e<=t;e++,h+=a){s.push(-o,0,h,o,0,h),s.push(h,0,-o,h,0,o);const t=e===i?r:n;t.toArray(l,c),c+=3,t.toArray(l,c),c+=3,t.toArray(l,c),c+=3,t.toArray(l,c),c+=3}const c=new BufferGeometry;c.setAttribute("position",new Float32BufferAttribute(s,3)),c.setAttribute("color",new Float32BufferAttribute(l,3));super(c,new LineBasicMaterial({vertexColors:!0,toneMapped:!1})),this.type="GridHelper"}}class PolarGridHelper extends LineSegments{constructor(e=10,t=16,r=8,n=64,i=4473924,a=8947848){i=new Color(i),a=new Color(a);const o=[],s=[];for(let r=0;r<=t;r++){const n=r/t*(2*Math.PI),l=Math.sin(n)*e,c=Math.cos(n)*e;o.push(0,0,0),o.push(l,0,c);const h=1&r?i:a;s.push(h.r,h.g,h.b),s.push(h.r,h.g,h.b)}for(let t=0;t<=r;t++){const l=1&t?i:a,c=e-e/r*t;for(let e=0;e<n;e++){let t=e/n*(2*Math.PI),r=Math.sin(t)*c,i=Math.cos(t)*c;o.push(r,0,i),s.push(l.r,l.g,l.b),t=(e+1)/n*(2*Math.PI),r=Math.sin(t)*c,i=Math.cos(t)*c,o.push(r,0,i),s.push(l.r,l.g,l.b)}}const l=new BufferGeometry;l.setAttribute("position",new Float32BufferAttribute(o,3)),l.setAttribute("color",new Float32BufferAttribute(s,3));super(l,new LineBasicMaterial({vertexColors:!0,toneMapped:!1})),this.type="PolarGridHelper"}}const _v1$6=new Vector3,_v2$3=new Vector3,_v3$1=new Vector3;class DirectionalLightHelper extends Object3D{constructor(e,t,r){super(),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=r,void 0===t&&(t=1);let n=new BufferGeometry;n.setAttribute("position",new Float32BufferAttribute([-t,t,0,t,t,0,t,-t,0,-t,-t,0,-t,t,0],3));const i=new LineBasicMaterial({fog:!1,toneMapped:!1});this.lightPlane=new Line(n,i),this.add(this.lightPlane),n=new BufferGeometry,n.setAttribute("position",new Float32BufferAttribute([0,0,0,0,0,1],3)),this.targetLine=new Line(n,i),this.add(this.targetLine),this.update()}dispose(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()}update(){_v1$6.setFromMatrixPosition(this.light.matrixWorld),_v2$3.setFromMatrixPosition(this.light.target.matrixWorld),_v3$1.subVectors(_v2$3,_v1$6),this.lightPlane.lookAt(_v2$3),void 0!==this.color?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(_v2$3),this.targetLine.scale.z=_v3$1.length()}}const _vector$c=new Vector3,_camera=new Camera$1$1;class CameraHelper extends LineSegments{constructor(e){const t=new BufferGeometry,r=new LineBasicMaterial({color:16777215,vertexColors:!0,toneMapped:!1}),n=[],i=[],a={},o=new Color(16755200),s=new Color(16711680),l=new Color(43775),c=new Color(16777215),h=new Color(3355443);function u(e,t,r){d(e,r),d(t,r)}function d(e,t){n.push(0,0,0),i.push(t.r,t.g,t.b),void 0===a[e]&&(a[e]=[]),a[e].push(n.length/3-1)}u("n1","n2",o),u("n2","n4",o),u("n4","n3",o),u("n3","n1",o),u("f1","f2",o),u("f2","f4",o),u("f4","f3",o),u("f3","f1",o),u("n1","f1",o),u("n2","f2",o),u("n3","f3",o),u("n4","f4",o),u("p","n1",s),u("p","n2",s),u("p","n3",s),u("p","n4",s),u("u1","u2",l),u("u2","u3",l),u("u3","u1",l),u("c","t",c),u("p","c",h),u("cn1","cn2",h),u("cn3","cn4",h),u("cf1","cf2",h),u("cf3","cf4",h),t.setAttribute("position",new Float32BufferAttribute(n,3)),t.setAttribute("color",new Float32BufferAttribute(i,3)),super(t,r),this.type="CameraHelper",this.camera=e,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=a,this.update()}update(){const e=this.geometry,t=this.pointMap;_camera.projectionMatrixInverse.copy(this.camera.projectionMatrixInverse),setPoint("c",t,e,_camera,0,0,-1),setPoint("t",t,e,_camera,0,0,1),setPoint("n1",t,e,_camera,-1,-1,-1),setPoint("n2",t,e,_camera,1,-1,-1),setPoint("n3",t,e,_camera,-1,1,-1),setPoint("n4",t,e,_camera,1,1,-1),setPoint("f1",t,e,_camera,-1,-1,1),setPoint("f2",t,e,_camera,1,-1,1),setPoint("f3",t,e,_camera,-1,1,1),setPoint("f4",t,e,_camera,1,1,1),setPoint("u1",t,e,_camera,.7,1.1,-1),setPoint("u2",t,e,_camera,-.7,1.1,-1),setPoint("u3",t,e,_camera,0,2,-1),setPoint("cf1",t,e,_camera,-1,0,1),setPoint("cf2",t,e,_camera,1,0,1),setPoint("cf3",t,e,_camera,0,-1,1),setPoint("cf4",t,e,_camera,0,1,1),setPoint("cn1",t,e,_camera,-1,0,-1),setPoint("cn2",t,e,_camera,1,0,-1),setPoint("cn3",t,e,_camera,0,-1,-1),setPoint("cn4",t,e,_camera,0,1,-1),e.getAttribute("position").needsUpdate=!0}}function setPoint(e,t,r,n,i,a,o){_vector$c.set(i,a,o).unproject(n);const s=t[e];if(void 0!==s){const e=r.getAttribute("position");for(let t=0,r=s.length;t<r;t++)e.setXYZ(s[t],_vector$c.x,_vector$c.y,_vector$c.z)}}const _box$3=new Box3;class BoxHelper extends LineSegments{constructor(e,t=16776960){const r=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new Float32Array(24),i=new BufferGeometry;i.setIndex(new BufferAttribute(r,1)),i.setAttribute("position",new BufferAttribute(n,3)),super(i,new LineBasicMaterial({color:t,toneMapped:!1})),this.object=e,this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}update(e){if(void 0!==e&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),void 0!==this.object&&_box$3.setFromObject(this.object),_box$3.isEmpty())return;const t=_box$3.min,r=_box$3.max,n=this.geometry.attributes.position,i=n.array;i[0]=r.x,i[1]=r.y,i[2]=r.z,i[3]=t.x,i[4]=r.y,i[5]=r.z,i[6]=t.x,i[7]=t.y,i[8]=r.z,i[9]=r.x,i[10]=t.y,i[11]=r.z,i[12]=r.x,i[13]=r.y,i[14]=t.z,i[15]=t.x,i[16]=r.y,i[17]=t.z,i[18]=t.x,i[19]=t.y,i[20]=t.z,i[21]=r.x,i[22]=t.y,i[23]=t.z,n.needsUpdate=!0,this.geometry.computeBoundingSphere()}setFromObject(e){return this.object=e,this.update(),this}copy(e){return LineSegments.prototype.copy.call(this,e),this.object=e.object,this}}class Box3Helper extends LineSegments{constructor(e,t=16776960){const r=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new BufferGeometry;n.setIndex(new BufferAttribute(r,1)),n.setAttribute("position",new Float32BufferAttribute([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3)),super(n,new LineBasicMaterial({color:t,toneMapped:!1})),this.box=e,this.type="Box3Helper",this.geometry.computeBoundingSphere()}updateMatrixWorld(e){const t=this.box;t.isEmpty()||(t.getCenter(this.position),t.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(e))}}class PlaneHelper extends Line{constructor(e,t=1,r=16776960){const n=r,i=new BufferGeometry;i.setAttribute("position",new Float32BufferAttribute([1,-1,1,-1,1,1,-1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,0,0,1,0,0,0],3)),i.computeBoundingSphere(),super(i,new LineBasicMaterial({color:n,toneMapped:!1})),this.type="PlaneHelper",this.plane=e,this.size=t;const a=new BufferGeometry;a.setAttribute("position",new Float32BufferAttribute([1,1,1,-1,1,1,-1,-1,1,1,1,1,-1,-1,1,1,-1,1],3)),a.computeBoundingSphere(),this.add(new Mesh(a,new MeshBasicMaterial({color:n,opacity:.2,transparent:!0,depthWrite:!1,toneMapped:!1})))}updateMatrixWorld(e){let t=-this.plane.constant;Math.abs(t)<1e-8&&(t=1e-8),this.scale.set(.5*this.size,.5*this.size,t),this.children[0].material.side=t<0?BackSide:FrontSide,this.lookAt(this.plane.normal),super.updateMatrixWorld(e)}}const _axis=new Vector3;let _lineGeometry,_coneGeometry;class ArrowHelper extends Object3D{constructor(e=new Vector3(0,0,1),t=new Vector3(0,0,0),r=1,n=16776960,i=.2*r,a=.2*i){super(),this.type="ArrowHelper",void 0===_lineGeometry&&(_lineGeometry=new BufferGeometry,_lineGeometry.setAttribute("position",new Float32BufferAttribute([0,0,0,0,1,0],3)),_coneGeometry=new CylinderGeometry(0,.5,1,5,1),_coneGeometry.translate(0,-.5,0)),this.position.copy(t),this.line=new Line(_lineGeometry,new LineBasicMaterial({color:n,toneMapped:!1})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new Mesh(_coneGeometry,new MeshBasicMaterial({color:n,toneMapped:!1})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(e),this.setLength(r,i,a)}setDirection(e){if(e.y>.99999)this.quaternion.set(0,0,0,1);else if(e.y<-.99999)this.quaternion.set(1,0,0,0);else{_axis.set(e.z,0,-e.x).normalize();const t=Math.acos(e.y);this.quaternion.setFromAxisAngle(_axis,t)}}setLength(e,t=.2*e,r=.2*t){this.line.scale.set(1,Math.max(1e-4,e-t),1),this.line.updateMatrix(),this.cone.scale.set(r,t,r),this.cone.position.y=e,this.cone.updateMatrix()}setColor(e){this.line.material.color.set(e),this.cone.material.color.set(e)}copy(e){return super.copy(e,!1),this.line.copy(e.line),this.cone.copy(e.cone),this}}class AxesHelper extends LineSegments{constructor(e=1){const t=[0,0,0,e,0,0,0,0,0,0,e,0,0,0,0,0,0,e],r=new BufferGeometry;r.setAttribute("position",new Float32BufferAttribute(t,3)),r.setAttribute("color",new Float32BufferAttribute([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],3));super(r,new LineBasicMaterial({vertexColors:!0,toneMapped:!1})),this.type="AxesHelper"}}const _floatView=new Float32Array(1),_int32View=new Int32Array(_floatView.buffer),DataUtils={toHalfFloat:function(e){_floatView[0]=e;const t=_int32View[0];let r=t>>16&32768,n=t>>12&2047;const i=t>>23&255;return i<103?r:i>142?(r|=31744,r|=(255==i?0:1)&&8388607&t,r):i<113?(n|=2048,r|=(n>>114-i)+(n>>113-i&1),r):(r|=i-112<<10|n>>1,r+=1&n,r)}},LOD_MIN=4,LOD_MAX=8,SIZE_MAX=Math.pow(2,LOD_MAX),EXTRA_LOD_SIGMA=[.125,.215,.35,.446,.526,.582],TOTAL_LODS=LOD_MAX-LOD_MIN+1+EXTRA_LOD_SIGMA.length,MAX_SAMPLES=20,ENCODINGS={[LinearEncoding]:0,[sRGBEncoding]:1,[RGBEEncoding]:2,[RGBM7Encoding]:3,[RGBM16Encoding]:4,[RGBDEncoding]:5,[GammaEncoding]:6},backgroundMaterial=new MeshBasicMaterial({side:BackSide,depthWrite:!1,depthTest:!1}),backgroundBox=new Mesh(new BoxGeometry,backgroundMaterial),_flatCamera=new OrthographicCamera,{_lodPlanes:_lodPlanes,_sizeLods:_sizeLods,_sigmas:_sigmas}=_createPlanes(),_clearColor=new Color;let _oldTarget=null;const PHI=(1+Math.sqrt(5))/2,INV_PHI=1/PHI,_axisDirections=[new Vector3(1,1,1),new Vector3(-1,1,1),new Vector3(1,1,-1),new Vector3(-1,1,-1),new Vector3(0,PHI,INV_PHI),new Vector3(0,PHI,-INV_PHI),new Vector3(INV_PHI,0,PHI),new Vector3(-INV_PHI,0,PHI),new Vector3(PHI,INV_PHI,0),new Vector3(-PHI,INV_PHI,0)];function convertLinearToRGBE(e){const t=Math.max(e.r,e.g,e.b),r=Math.min(Math.max(Math.ceil(Math.log2(t)),-128),127);e.multiplyScalar(Math.pow(2,-r));return(r+128)/255}class PMREMGenerator{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._blurMaterial=_getBlurShader(MAX_SAMPLES),this._equirectShader=null,this._cubemapShader=null,this._compileMaterial(this._blurMaterial)}fromScene(e,t=0,r=.1,n=100){_oldTarget=this._renderer.getRenderTarget();const i=this._allocateTargets();return this._sceneToCubeUV(e,r,n,i),t>0&&this._blur(i,0,0,t),this._applyPMREM(i),this._cleanup(i),i}fromEquirectangular(e){return this._fromTexture(e)}fromCubemap(e){return this._fromTexture(e)}compileCubemapShader(){null===this._cubemapShader&&(this._cubemapShader=_getCubemapShader(),this._compileMaterial(this._cubemapShader))}compileEquirectangularShader(){null===this._equirectShader&&(this._equirectShader=_getEquirectShader(),this._compileMaterial(this._equirectShader))}dispose(){this._blurMaterial.dispose(),null!==this._cubemapShader&&this._cubemapShader.dispose(),null!==this._equirectShader&&this._equirectShader.dispose();for(let e=0;e<_lodPlanes.length;e++)_lodPlanes[e].dispose()}_cleanup(e){this._pingPongRenderTarget.dispose(),this._renderer.setRenderTarget(_oldTarget),e.scissorTest=!1,_setViewport(e,0,0,e.width,e.height)}_fromTexture(e){_oldTarget=this._renderer.getRenderTarget();const t=this._allocateTargets(e);return this._textureToCubeUV(e,t),this._applyPMREM(t),this._cleanup(t),t}_allocateTargets(e){const t={magFilter:NearestFilter,minFilter:NearestFilter,generateMipmaps:!1,type:UnsignedByteType,format:RGBEFormat,encoding:_isLDR(e)?e.encoding:RGBEEncoding,depthBuffer:!1},r=_createRenderTarget(t);return r.depthBuffer=!e,this._pingPongRenderTarget=_createRenderTarget(t),r}_compileMaterial(e){const t=new Mesh(_lodPlanes[0],e);this._renderer.compile(t,_flatCamera)}_sceneToCubeUV(e,t,r,n){const i=new PerspectiveCamera(90,1,t,r),a=[1,-1,1,1,1,1],o=[1,1,1,-1,-1,-1],s=this._renderer,l=s.autoClear,c=s.outputEncoding,h=s.toneMapping;s.getClearColor(_clearColor),s.toneMapping=NoToneMapping,s.outputEncoding=LinearEncoding,s.autoClear=!1;let u=!1;const d=e.background;if(d){if(d.isColor){backgroundMaterial.color.copy(d).convertSRGBToLinear(),e.background=null;const t=convertLinearToRGBE(backgroundMaterial.color);backgroundMaterial.opacity=t,u=!0}}else{backgroundMaterial.color.copy(_clearColor).convertSRGBToLinear();const e=convertLinearToRGBE(backgroundMaterial.color);backgroundMaterial.opacity=e,u=!0}for(let t=0;t<6;t++){const r=t%3;0==r?(i.up.set(0,a[t],0),i.lookAt(o[t],0,0)):1==r?(i.up.set(0,0,a[t]),i.lookAt(0,o[t],0)):(i.up.set(0,a[t],0),i.lookAt(0,0,o[t])),_setViewport(n,r*SIZE_MAX,t>2?SIZE_MAX:0,SIZE_MAX,SIZE_MAX),s.setRenderTarget(n),u&&s.render(backgroundBox,i),s.render(e,i)}s.toneMapping=h,s.outputEncoding=c,s.autoClear=l}_textureToCubeUV(e,t){const r=this._renderer;e.isCubeTexture?null==this._cubemapShader&&(this._cubemapShader=_getCubemapShader()):null==this._equirectShader&&(this._equirectShader=_getEquirectShader());const n=e.isCubeTexture?this._cubemapShader:this._equirectShader,i=new Mesh(_lodPlanes[0],n),a=n.uniforms;a.envMap.value=e,e.isCubeTexture||a.texelSize.value.set(1/e.image.width,1/e.image.height),a.inputEncoding.value=ENCODINGS[e.encoding],a.outputEncoding.value=ENCODINGS[t.texture.encoding],_setViewport(t,0,0,3*SIZE_MAX,2*SIZE_MAX),r.setRenderTarget(t),r.render(i,_flatCamera)}_applyPMREM(e){const t=this._renderer,r=t.autoClear;t.autoClear=!1;for(let t=1;t<TOTAL_LODS;t++){const r=Math.sqrt(_sigmas[t]*_sigmas[t]-_sigmas[t-1]*_sigmas[t-1]),n=_axisDirections[(t-1)%_axisDirections.length];this._blur(e,t-1,t,r,n)}t.autoClear=r}_blur(e,t,r,n,i){const a=this._pingPongRenderTarget;this._halfBlur(e,a,t,r,n,"latitudinal",i),this._halfBlur(a,e,r,r,n,"longitudinal",i)}_halfBlur(e,t,r,n,i,a,o){const s=this._renderer,l=this._blurMaterial;"latitudinal"!==a&&"longitudinal"!==a&&console.error("blur direction must be either latitudinal or longitudinal!");const c=new Mesh(_lodPlanes[n],l),h=l.uniforms,u=_sizeLods[r]-1,d=isFinite(i)?Math.PI/(2*u):2*Math.PI/(2*MAX_SAMPLES-1),p=i/d,f=isFinite(i)?1+Math.floor(3*p):MAX_SAMPLES;f>MAX_SAMPLES&&console.warn(`sigmaRadians, ${i}, is too large and will clip, as it requested ${f} samples when the maximum is set to ${MAX_SAMPLES}`);const m=[];let g=0;for(let e=0;e<MAX_SAMPLES;++e){const t=e/p,r=Math.exp(-t*t/2);m.push(r),0==e?g+=r:e<f&&(g+=2*r)}for(let e=0;e<m.length;e++)m[e]=m[e]/g;h.envMap.value=e.texture,h.samples.value=f,h.weights.value=m,h.latitudinal.value="latitudinal"===a,o&&(h.poleAxis.value=o),h.dTheta.value=d,h.mipInt.value=LOD_MAX-r,h.inputEncoding.value=ENCODINGS[e.texture.encoding],h.outputEncoding.value=ENCODINGS[e.texture.encoding];const y=_sizeLods[n];_setViewport(t,3*Math.max(0,SIZE_MAX-2*y),(0===n?0:2*SIZE_MAX)+2*y*(n>LOD_MAX-LOD_MIN?n-LOD_MAX+LOD_MIN:0),3*y,2*y),s.setRenderTarget(t),s.render(c,_flatCamera)}}function _isLDR(e){return void 0!==e&&e.type===UnsignedByteType&&(e.encoding===LinearEncoding||e.encoding===sRGBEncoding||e.encoding===GammaEncoding)}function _createPlanes(){const e=[],t=[],r=[];let n=LOD_MAX;for(let i=0;i<TOTAL_LODS;i++){const a=Math.pow(2,n);t.push(a);let o=1/a;i>LOD_MAX-LOD_MIN?o=EXTRA_LOD_SIGMA[i-LOD_MAX+LOD_MIN-1]:0==i&&(o=0),r.push(o);const s=1/(a-1),l=-s/2,c=1+s/2,h=[l,l,c,l,c,c,l,l,c,c,l,c],u=6,d=6,p=3,f=2,m=1,g=new Float32Array(p*d*u),y=new Float32Array(f*d*u),v=new Float32Array(m*d*u);for(let e=0;e<u;e++){const t=e%3*2/3-1,r=e>2?0:-1,n=[t,r,0,t+2/3,r,0,t+2/3,r+1,0,t,r,0,t+2/3,r+1,0,t,r+1,0];g.set(n,p*d*e),y.set(h,f*d*e);const i=[e,e,e,e,e,e];v.set(i,m*d*e)}const b=new BufferGeometry;b.setAttribute("position",new BufferAttribute(g,p)),b.setAttribute("uv",new BufferAttribute(y,f)),b.setAttribute("faceIndex",new BufferAttribute(v,m)),e.push(b),n>LOD_MIN&&n--}return{_lodPlanes:e,_sizeLods:t,_sigmas:r}}function _createRenderTarget(e){const t=new WebGLRenderTarget(3*SIZE_MAX,3*SIZE_MAX,e);return t.texture.mapping=CubeUVReflectionMapping,t.texture.name="PMREM.cubeUv",t.scissorTest=!0,t}function _setViewport(e,t,r,n,i){e.viewport.set(t,r,n,i),e.scissor.set(t,r,n,i)}function _getBlurShader(e){const t=new Float32Array(e),r=new Vector3(0,1,0);return new RawShaderMaterial({name:"SphericalGaussianBlur",defines:{n:e},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:t},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:r},inputEncoding:{value:ENCODINGS[LinearEncoding]},outputEncoding:{value:ENCODINGS[LinearEncoding]}},vertexShader:_getCommonVertexShader(),fragmentShader:`\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t${_getEncodings()}\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t\tgl_FragColor = linearToOutputTexel( gl_FragColor );\n\n\t\t\t}\n\t\t`,blending:NoBlending,depthTest:!1,depthWrite:!1})}function _getEquirectShader(){const e=new Vector2(1,1);return new RawShaderMaterial({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null},texelSize:{value:e},inputEncoding:{value:ENCODINGS[LinearEncoding]},outputEncoding:{value:ENCODINGS[LinearEncoding]}},vertexShader:_getCommonVertexShader(),fragmentShader:`\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform vec2 texelSize;\n\n\t\t\t${_getEncodings()}\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t\tvec2 f = fract( uv / texelSize - 0.5 );\n\t\t\t\tuv -= f * texelSize;\n\t\t\t\tvec3 tl = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\t\t\t\tuv.x += texelSize.x;\n\t\t\t\tvec3 tr = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\t\t\t\tuv.y += texelSize.y;\n\t\t\t\tvec3 br = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\t\t\t\tuv.x -= texelSize.x;\n\t\t\t\tvec3 bl = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\n\t\t\t\tvec3 tm = mix( tl, tr, f.x );\n\t\t\t\tvec3 bm = mix( bl, br, f.x );\n\t\t\t\tgl_FragColor.rgb = mix( tm, bm, f.y );\n\n\t\t\t\tgl_FragColor = linearToOutputTexel( gl_FragColor );\n\n\t\t\t}\n\t\t`,blending:NoBlending,depthTest:!1,depthWrite:!1})}function _getCubemapShader(){return new RawShaderMaterial({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},inputEncoding:{value:ENCODINGS[LinearEncoding]},outputEncoding:{value:ENCODINGS[LinearEncoding]}},vertexShader:_getCommonVertexShader(),fragmentShader:`\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\n\t\t\t${_getEncodings()}\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb = envMapTexelToLinear( textureCube( envMap, vec3( - vOutputDirection.x, vOutputDirection.yz ) ) ).rgb;\n\t\t\t\tgl_FragColor = linearToOutputTexel( gl_FragColor );\n\n\t\t\t}\n\t\t`,blending:NoBlending,depthTest:!1,depthWrite:!1})}function _getCommonVertexShader(){return"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute vec3 position;\n\t\tattribute vec2 uv;\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t"}function _getEncodings(){return"\n\n\t\tuniform int inputEncoding;\n\t\tuniform int outputEncoding;\n\n\t\t#include <encodings_pars_fragment>\n\n\t\tvec4 inputTexelToLinear( vec4 value ) {\n\n\t\t\tif ( inputEncoding == 0 ) {\n\n\t\t\t\treturn value;\n\n\t\t\t} else if ( inputEncoding == 1 ) {\n\n\t\t\t\treturn sRGBToLinear( value );\n\n\t\t\t} else if ( inputEncoding == 2 ) {\n\n\t\t\t\treturn RGBEToLinear( value );\n\n\t\t\t} else if ( inputEncoding == 3 ) {\n\n\t\t\t\treturn RGBMToLinear( value, 7.0 );\n\n\t\t\t} else if ( inputEncoding == 4 ) {\n\n\t\t\t\treturn RGBMToLinear( value, 16.0 );\n\n\t\t\t} else if ( inputEncoding == 5 ) {\n\n\t\t\t\treturn RGBDToLinear( value, 256.0 );\n\n\t\t\t} else {\n\n\t\t\t\treturn GammaToLinear( value, 2.2 );\n\n\t\t\t}\n\n\t\t}\n\n\t\tvec4 linearToOutputTexel( vec4 value ) {\n\n\t\t\tif ( outputEncoding == 0 ) {\n\n\t\t\t\treturn value;\n\n\t\t\t} else if ( outputEncoding == 1 ) {\n\n\t\t\t\treturn LinearTosRGB( value );\n\n\t\t\t} else if ( outputEncoding == 2 ) {\n\n\t\t\t\treturn LinearToRGBE( value );\n\n\t\t\t} else if ( outputEncoding == 3 ) {\n\n\t\t\t\treturn LinearToRGBM( value, 7.0 );\n\n\t\t\t} else if ( outputEncoding == 4 ) {\n\n\t\t\t\treturn LinearToRGBM( value, 16.0 );\n\n\t\t\t} else if ( outputEncoding == 5 ) {\n\n\t\t\t\treturn LinearToRGBD( value, 256.0 );\n\n\t\t\t} else {\n\n\t\t\t\treturn LinearToGamma( value, 2.2 );\n\n\t\t\t}\n\n\t\t}\n\n\t\tvec4 envMapTexelToLinear( vec4 color ) {\n\n\t\t\treturn inputTexelToLinear( color );\n\n\t\t}\n\t"}const LineStrip=0,LinePieces=1,NoColors=0,FaceColors=1,VertexColors=2;function MeshFaceMaterial(e){return console.warn("THREE.MeshFaceMaterial has been removed. Use an Array instead."),e}function MultiMaterial(e=[]){return console.warn("THREE.MultiMaterial has been removed. Use an Array instead."),e.isMultiMaterial=!0,e.materials=e,e.clone=function(){return e.slice()},e}function PointCloud(e,t){return console.warn("THREE.PointCloud has been renamed to THREE.Points."),new Points(e,t)}function Particle(e){return console.warn("THREE.Particle has been renamed to THREE.Sprite."),new Sprite(e)}function ParticleSystem(e,t){return console.warn("THREE.ParticleSystem has been renamed to THREE.Points."),new Points(e,t)}function PointCloudMaterial(e){return console.warn("THREE.PointCloudMaterial has been renamed to THREE.PointsMaterial."),new PointsMaterial(e)}function ParticleBasicMaterial(e){return console.warn("THREE.ParticleBasicMaterial has been renamed to THREE.PointsMaterial."),new PointsMaterial(e)}function ParticleSystemMaterial(e){return console.warn("THREE.ParticleSystemMaterial has been renamed to THREE.PointsMaterial."),new PointsMaterial(e)}function Vertex(e,t,r){return console.warn("THREE.Vertex has been removed. Use THREE.Vector3 instead."),new Vector3(e,t,r)}function DynamicBufferAttribute(e,t){return console.warn("THREE.DynamicBufferAttribute has been removed. Use new THREE.BufferAttribute().setUsage( THREE.DynamicDrawUsage ) instead."),new BufferAttribute(e,t).setUsage(DynamicDrawUsage)}function Int8Attribute(e,t){return console.warn("THREE.Int8Attribute has been removed. Use new THREE.Int8BufferAttribute() instead."),new Int8BufferAttribute(e,t)}function Uint8Attribute(e,t){return console.warn("THREE.Uint8Attribute has been removed. Use new THREE.Uint8BufferAttribute() instead."),new Uint8BufferAttribute(e,t)}function Uint8ClampedAttribute(e,t){return console.warn("THREE.Uint8ClampedAttribute has been removed. Use new THREE.Uint8ClampedBufferAttribute() instead."),new Uint8ClampedBufferAttribute(e,t)}function Int16Attribute(e,t){return console.warn("THREE.Int16Attribute has been removed. Use new THREE.Int16BufferAttribute() instead."),new Int16BufferAttribute(e,t)}function Uint16Attribute(e,t){return console.warn("THREE.Uint16Attribute has been removed. Use new THREE.Uint16BufferAttribute() instead."),new Uint16BufferAttribute(e,t)}function Int32Attribute(e,t){return console.warn("THREE.Int32Attribute has been removed. Use new THREE.Int32BufferAttribute() instead."),new Int32BufferAttribute(e,t)}function Uint32Attribute(e,t){return console.warn("THREE.Uint32Attribute has been removed. Use new THREE.Uint32BufferAttribute() instead."),new Uint32BufferAttribute(e,t)}function Float32Attribute(e,t){return console.warn("THREE.Float32Attribute has been removed. Use new THREE.Float32BufferAttribute() instead."),new Float32BufferAttribute(e,t)}function Float64Attribute(e,t){return console.warn("THREE.Float64Attribute has been removed. Use new THREE.Float64BufferAttribute() instead."),new Float64BufferAttribute(e,t)}function AxisHelper(e){return console.warn("THREE.AxisHelper has been renamed to THREE.AxesHelper."),new AxesHelper(e)}function BoundingBoxHelper(e,t){return console.warn("THREE.BoundingBoxHelper has been deprecated. Creating a THREE.BoxHelper instead."),new BoxHelper(e,t)}function EdgesHelper(e,t){return console.warn("THREE.EdgesHelper has been removed. Use THREE.EdgesGeometry instead."),new LineSegments(new EdgesGeometry(e.geometry),new LineBasicMaterial({color:void 0!==t?t:16777215}))}function WireframeHelper(e,t){return console.warn("THREE.WireframeHelper has been removed. Use THREE.WireframeGeometry instead."),new LineSegments(new WireframeGeometry(e.geometry),new LineBasicMaterial({color:void 0!==t?t:16777215}))}function XHRLoader(e){return console.warn("THREE.XHRLoader has been renamed to THREE.FileLoader."),new FileLoader(e)}function BinaryTextureLoader(e){return console.warn("THREE.BinaryTextureLoader has been renamed to THREE.DataTextureLoader."),new DataTextureLoader(e)}function WebGLRenderTargetCube(e,t,r){return console.warn("THREE.WebGLRenderTargetCube( width, height, options ) is now WebGLCubeRenderTarget( size, options )."),new WebGLCubeRenderTarget(e,r)}function CanvasRenderer(){console.error("THREE.CanvasRenderer has been removed")}function JSONLoader(){console.error("THREE.JSONLoader has been removed.")}Curve.create=function(e,t){return console.log("THREE.Curve.create() has been deprecated"),e.prototype=Object.create(Curve.prototype),e.prototype.constructor=e,e.prototype.getPoint=t,e},Path$1.prototype.fromPoints=function(e){return console.warn("THREE.Path: .fromPoints() has been renamed to .setFromPoints()."),this.setFromPoints(e)},GridHelper.prototype.setColors=function(){console.error("THREE.GridHelper: setColors() has been deprecated, pass them in the constructor instead.")},SkeletonHelper.prototype.update=function(){console.error("THREE.SkeletonHelper: update() no longer needs to be called.")},Loader.prototype.extractUrlBase=function(e){return console.warn("THREE.Loader: .extractUrlBase() has been deprecated. Use THREE.LoaderUtils.extractUrlBase() instead."),LoaderUtils.extractUrlBase(e)},Loader.Handlers={add:function(){console.error("THREE.Loader: Handlers.add() has been removed. Use LoadingManager.addHandler() instead.")},get:function(){console.error("THREE.Loader: Handlers.get() has been removed. Use LoadingManager.getHandler() instead.")}},Box2.prototype.center=function(e){return console.warn("THREE.Box2: .center() has been renamed to .getCenter()."),this.getCenter(e)},Box2.prototype.empty=function(){return console.warn("THREE.Box2: .empty() has been renamed to .isEmpty()."),this.isEmpty()},Box2.prototype.isIntersectionBox=function(e){return console.warn("THREE.Box2: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},Box2.prototype.size=function(e){return console.warn("THREE.Box2: .size() has been renamed to .getSize()."),this.getSize(e)},Box3.prototype.center=function(e){return console.warn("THREE.Box3: .center() has been renamed to .getCenter()."),this.getCenter(e)},Box3.prototype.empty=function(){return console.warn("THREE.Box3: .empty() has been renamed to .isEmpty()."),this.isEmpty()},Box3.prototype.isIntersectionBox=function(e){return console.warn("THREE.Box3: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},Box3.prototype.isIntersectionSphere=function(e){return console.warn("THREE.Box3: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)},Box3.prototype.size=function(e){return console.warn("THREE.Box3: .size() has been renamed to .getSize()."),this.getSize(e)},Sphere.prototype.empty=function(){return console.warn("THREE.Sphere: .empty() has been renamed to .isEmpty()."),this.isEmpty()},Frustum.prototype.setFromMatrix=function(e){return console.warn("THREE.Frustum: .setFromMatrix() has been renamed to .setFromProjectionMatrix()."),this.setFromProjectionMatrix(e)},Line3.prototype.center=function(e){return console.warn("THREE.Line3: .center() has been renamed to .getCenter()."),this.getCenter(e)},MathUtils.random16=function(){return console.warn("THREE.Math: .random16() has been deprecated. Use Math.random() instead."),Math.random()},MathUtils.nearestPowerOfTwo=function(e){return console.warn("THREE.Math: .nearestPowerOfTwo() has been renamed to .floorPowerOfTwo()."),MathUtils.floorPowerOfTwo(e)},MathUtils.nextPowerOfTwo=function(e){return console.warn("THREE.Math: .nextPowerOfTwo() has been renamed to .ceilPowerOfTwo()."),MathUtils.ceilPowerOfTwo(e)},Matrix3.prototype.flattenToArrayOffset=function(e,t){return console.warn("THREE.Matrix3: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(e,t)},Matrix3.prototype.multiplyVector3=function(e){return console.warn("THREE.Matrix3: .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),e.applyMatrix3(this)},Matrix3.prototype.multiplyVector3Array=function(){console.error("THREE.Matrix3: .multiplyVector3Array() has been removed.")},Matrix3.prototype.applyToBufferAttribute=function(e){return console.warn("THREE.Matrix3: .applyToBufferAttribute() has been removed. Use attribute.applyMatrix3( matrix ) instead."),e.applyMatrix3(this)},Matrix3.prototype.applyToVector3Array=function(){console.error("THREE.Matrix3: .applyToVector3Array() has been removed.")},Matrix3.prototype.getInverse=function(e){return console.warn("THREE.Matrix3: .getInverse() has been removed. Use matrixInv.copy( matrix ).invert(); instead."),this.copy(e).invert()},Matrix4.prototype.extractPosition=function(e){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(e)},Matrix4.prototype.flattenToArrayOffset=function(e,t){return console.warn("THREE.Matrix4: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(e,t)},Matrix4.prototype.getPosition=function(){return console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead."),(new Vector3).setFromMatrixColumn(this,3)},Matrix4.prototype.setRotationFromQuaternion=function(e){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(e)},Matrix4.prototype.multiplyToArray=function(){console.warn("THREE.Matrix4: .multiplyToArray() has been removed.")},Matrix4.prototype.multiplyVector3=function(e){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},Matrix4.prototype.multiplyVector4=function(e){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},Matrix4.prototype.multiplyVector3Array=function(){console.error("THREE.Matrix4: .multiplyVector3Array() has been removed.")},Matrix4.prototype.rotateAxis=function(e){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),e.transformDirection(this)},Matrix4.prototype.crossVector=function(e){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},Matrix4.prototype.translate=function(){console.error("THREE.Matrix4: .translate() has been removed.")},Matrix4.prototype.rotateX=function(){console.error("THREE.Matrix4: .rotateX() has been removed.")},Matrix4.prototype.rotateY=function(){console.error("THREE.Matrix4: .rotateY() has been removed.")},Matrix4.prototype.rotateZ=function(){console.error("THREE.Matrix4: .rotateZ() has been removed.")},Matrix4.prototype.rotateByAxis=function(){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},Matrix4.prototype.applyToBufferAttribute=function(e){return console.warn("THREE.Matrix4: .applyToBufferAttribute() has been removed. Use attribute.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},Matrix4.prototype.applyToVector3Array=function(){console.error("THREE.Matrix4: .applyToVector3Array() has been removed.")},Matrix4.prototype.makeFrustum=function(e,t,r,n,i,a){return console.warn("THREE.Matrix4: .makeFrustum() has been removed. Use .makePerspective( left, right, top, bottom, near, far ) instead."),this.makePerspective(e,t,n,r,i,a)},Matrix4.prototype.getInverse=function(e){return console.warn("THREE.Matrix4: .getInverse() has been removed. Use matrixInv.copy( matrix ).invert(); instead."),this.copy(e).invert()},Plane.prototype.isIntersectionLine=function(e){return console.warn("THREE.Plane: .isIntersectionLine() has been renamed to .intersectsLine()."),this.intersectsLine(e)},Quaternion.prototype.multiplyVector3=function(e){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),e.applyQuaternion(this)},Quaternion.prototype.inverse=function(){return console.warn("THREE.Quaternion: .inverse() has been renamed to invert()."),this.invert()},Ray.prototype.isIntersectionBox=function(e){return console.warn("THREE.Ray: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},Ray.prototype.isIntersectionPlane=function(e){return console.warn("THREE.Ray: .isIntersectionPlane() has been renamed to .intersectsPlane()."),this.intersectsPlane(e)},Ray.prototype.isIntersectionSphere=function(e){return console.warn("THREE.Ray: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)},Triangle.prototype.area=function(){return console.warn("THREE.Triangle: .area() has been renamed to .getArea()."),this.getArea()},Triangle.prototype.barycoordFromPoint=function(e,t){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),this.getBarycoord(e,t)},Triangle.prototype.midpoint=function(e){return console.warn("THREE.Triangle: .midpoint() has been renamed to .getMidpoint()."),this.getMidpoint(e)},Triangle.prototypenormal=function(e){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),this.getNormal(e)},Triangle.prototype.plane=function(e){return console.warn("THREE.Triangle: .plane() has been renamed to .getPlane()."),this.getPlane(e)},Triangle.barycoordFromPoint=function(e,t,r,n,i){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),Triangle.getBarycoord(e,t,r,n,i)},Triangle.normal=function(e,t,r,n){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),Triangle.getNormal(e,t,r,n)},Shape.prototype.extractAllPoints=function(e){return console.warn("THREE.Shape: .extractAllPoints() has been removed. Use .extractPoints() instead."),this.extractPoints(e)},Shape.prototype.extrude=function(e){return console.warn("THREE.Shape: .extrude() has been removed. Use ExtrudeGeometry() instead."),new ExtrudeGeometry(this,e)},Shape.prototype.makeGeometry=function(e){return console.warn("THREE.Shape: .makeGeometry() has been removed. Use ShapeGeometry() instead."),new ShapeGeometry(this,e)},Vector2.prototype.fromAttribute=function(e,t,r){return console.warn("THREE.Vector2: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,r)},Vector2.prototype.distanceToManhattan=function(e){return console.warn("THREE.Vector2: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(e)},Vector2.prototype.lengthManhattan=function(){return console.warn("THREE.Vector2: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()},Vector3.prototype.setEulerFromRotationMatrix=function(){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},Vector3.prototype.setEulerFromQuaternion=function(){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},Vector3.prototype.getPositionFromMatrix=function(e){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(e)},Vector3.prototype.getScaleFromMatrix=function(e){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(e)},Vector3.prototype.getColumnFromMatrix=function(e,t){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(t,e)},Vector3.prototype.applyProjection=function(e){return console.warn("THREE.Vector3: .applyProjection() has been removed. Use .applyMatrix4( m ) instead."),this.applyMatrix4(e)},Vector3.prototype.fromAttribute=function(e,t,r){return console.warn("THREE.Vector3: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,r)},Vector3.prototype.distanceToManhattan=function(e){return console.warn("THREE.Vector3: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(e)},Vector3.prototype.lengthManhattan=function(){return console.warn("THREE.Vector3: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()},Vector4.prototype.fromAttribute=function(e,t,r){return console.warn("THREE.Vector4: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,r)},Vector4.prototype.lengthManhattan=function(){return console.warn("THREE.Vector4: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()},Object3D.prototype.getChildByName=function(e){return console.warn("THREE.Object3D: .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(e)},Object3D.prototype.renderDepth=function(){console.warn("THREE.Object3D: .renderDepth has been removed. Use .renderOrder, instead.")},Object3D.prototype.translate=function(e,t){return console.warn("THREE.Object3D: .translate() has been removed. Use .translateOnAxis( axis, distance ) instead."),this.translateOnAxis(t,e)},Object3D.prototype.getWorldRotation=function(){console.error("THREE.Object3D: .getWorldRotation() has been removed. Use THREE.Object3D.getWorldQuaternion( target ) instead.")},Object3D.prototype.applyMatrix=function(e){return console.warn("THREE.Object3D: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(e)},Object.defineProperties(Object3D.prototype,{eulerOrder:{get:function(){return console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order},set:function(e){console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order=e}},useQuaternion:{get:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")}}}),Mesh.prototype.setDrawMode=function(){console.error("THREE.Mesh: .setDrawMode() has been removed. The renderer now always assumes THREE.TrianglesDrawMode. Transform your geometry via BufferGeometryUtils.toTrianglesDrawMode() if necessary.")},Object.defineProperties(Mesh.prototype,{drawMode:{get:function(){return console.error("THREE.Mesh: .drawMode has been removed. The renderer now always assumes THREE.TrianglesDrawMode."),TrianglesDrawMode},set:function(){console.error("THREE.Mesh: .drawMode has been removed. The renderer now always assumes THREE.TrianglesDrawMode. Transform your geometry via BufferGeometryUtils.toTrianglesDrawMode() if necessary.")}}}),Object.defineProperties(LOD.prototype,{objects:{get:function(){return console.warn("THREE.LOD: .objects has been renamed to .levels."),this.levels}}}),Object.defineProperty(Skeleton.prototype,"useVertexTexture",{get:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")},set:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")}}),SkinnedMesh.prototype.initBones=function(){console.error("THREE.SkinnedMesh: initBones() has been removed.")},Object.defineProperty(Curve.prototype,"__arcLengthDivisions",{get:function(){return console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions},set:function(e){console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions=e}}),PerspectiveCamera.prototype.setLens=function(e,t){console.warn("THREE.PerspectiveCamera.setLens is deprecated. Use .setFocalLength and .filmGauge for a photographic setup."),void 0!==t&&(this.filmGauge=t),this.setFocalLength(e)},Object.defineProperties(Light.prototype,{onlyShadow:{set:function(){console.warn("THREE.Light: .onlyShadow has been removed.")}},shadowCameraFov:{set:function(e){console.warn("THREE.Light: .shadowCameraFov is now .shadow.camera.fov."),this.shadow.camera.fov=e}},shadowCameraLeft:{set:function(e){console.warn("THREE.Light: .shadowCameraLeft is now .shadow.camera.left."),this.shadow.camera.left=e}},shadowCameraRight:{set:function(e){console.warn("THREE.Light: .shadowCameraRight is now .shadow.camera.right."),this.shadow.camera.right=e}},shadowCameraTop:{set:function(e){console.warn("THREE.Light: .shadowCameraTop is now .shadow.camera.top."),this.shadow.camera.top=e}},shadowCameraBottom:{set:function(e){console.warn("THREE.Light: .shadowCameraBottom is now .shadow.camera.bottom."),this.shadow.camera.bottom=e}},shadowCameraNear:{set:function(e){console.warn("THREE.Light: .shadowCameraNear is now .shadow.camera.near."),this.shadow.camera.near=e}},shadowCameraFar:{set:function(e){console.warn("THREE.Light: .shadowCameraFar is now .shadow.camera.far."),this.shadow.camera.far=e}},shadowCameraVisible:{set:function(){console.warn("THREE.Light: .shadowCameraVisible has been removed. Use new THREE.CameraHelper( light.shadow.camera ) instead.")}},shadowBias:{set:function(e){console.warn("THREE.Light: .shadowBias is now .shadow.bias."),this.shadow.bias=e}},shadowDarkness:{set:function(){console.warn("THREE.Light: .shadowDarkness has been removed.")}},shadowMapWidth:{set:function(e){console.warn("THREE.Light: .shadowMapWidth is now .shadow.mapSize.width."),this.shadow.mapSize.width=e}},shadowMapHeight:{set:function(e){console.warn("THREE.Light: .shadowMapHeight is now .shadow.mapSize.height."),this.shadow.mapSize.height=e}}}),Object.defineProperties(BufferAttribute.prototype,{length:{get:function(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Use .count instead."),this.array.length}},dynamic:{get:function(){return console.warn("THREE.BufferAttribute: .dynamic has been deprecated. Use .usage instead."),this.usage===DynamicDrawUsage},set:function(){console.warn("THREE.BufferAttribute: .dynamic has been deprecated. Use .usage instead."),this.setUsage(DynamicDrawUsage)}}}),BufferAttribute.prototype.setDynamic=function(e){return console.warn("THREE.BufferAttribute: .setDynamic() has been deprecated. Use .setUsage() instead."),this.setUsage(!0===e?DynamicDrawUsage:StaticDrawUsage),this},BufferAttribute.prototype.copyIndicesArray=function(){console.error("THREE.BufferAttribute: .copyIndicesArray() has been removed.")},BufferAttribute.prototype.setArray=function(){console.error("THREE.BufferAttribute: .setArray has been removed. Use BufferGeometry .setAttribute to replace/resize attribute buffers")},BufferGeometry.prototype.addIndex=function(e){console.warn("THREE.BufferGeometry: .addIndex() has been renamed to .setIndex()."),this.setIndex(e)},BufferGeometry.prototype.addAttribute=function(e,t){return console.warn("THREE.BufferGeometry: .addAttribute() has been renamed to .setAttribute()."),t&&t.isBufferAttribute||t&&t.isInterleavedBufferAttribute?"index"===e?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),this.setIndex(t),this):this.setAttribute(e,t):(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),this.setAttribute(e,new BufferAttribute(arguments[1],arguments[2])))},BufferGeometry.prototype.addDrawCall=function(e,t,r){void 0!==r&&console.warn("THREE.BufferGeometry: .addDrawCall() no longer supports indexOffset."),console.warn("THREE.BufferGeometry: .addDrawCall() is now .addGroup()."),this.addGroup(e,t)},BufferGeometry.prototype.clearDrawCalls=function(){console.warn("THREE.BufferGeometry: .clearDrawCalls() is now .clearGroups()."),this.clearGroups()},BufferGeometry.prototype.computeOffsets=function(){console.warn("THREE.BufferGeometry: .computeOffsets() has been removed.")},BufferGeometry.prototype.removeAttribute=function(e){return console.warn("THREE.BufferGeometry: .removeAttribute() has been renamed to .deleteAttribute()."),this.deleteAttribute(e)},BufferGeometry.prototype.applyMatrix=function(e){return console.warn("THREE.BufferGeometry: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(e)},Object.defineProperties(BufferGeometry.prototype,{drawcalls:{get:function(){return console.error("THREE.BufferGeometry: .drawcalls has been renamed to .groups."),this.groups}},offsets:{get:function(){return console.warn("THREE.BufferGeometry: .offsets has been renamed to .groups."),this.groups}}}),Object.defineProperties(InstancedBufferGeometry.prototype,{maxInstancedCount:{get:function(){return console.warn("THREE.InstancedBufferGeometry: .maxInstancedCount has been renamed to .instanceCount."),this.instanceCount},set:function(e){console.warn("THREE.InstancedBufferGeometry: .maxInstancedCount has been renamed to .instanceCount."),this.instanceCount=e}}}),Object.defineProperties(Raycaster.prototype,{linePrecision:{get:function(){return console.warn("THREE.Raycaster: .linePrecision has been deprecated. Use .params.Line.threshold instead."),this.params.Line.threshold},set:function(e){console.warn("THREE.Raycaster: .linePrecision has been deprecated. Use .params.Line.threshold instead."),this.params.Line.threshold=e}}}),Object.defineProperties(InterleavedBuffer.prototype,{dynamic:{get:function(){return console.warn("THREE.InterleavedBuffer: .length has been deprecated. Use .usage instead."),this.usage===DynamicDrawUsage},set:function(e){console.warn("THREE.InterleavedBuffer: .length has been deprecated. Use .usage instead."),this.setUsage(e)}}}),InterleavedBuffer.prototype.setDynamic=function(e){return console.warn("THREE.InterleavedBuffer: .setDynamic() has been deprecated. Use .setUsage() instead."),this.setUsage(!0===e?DynamicDrawUsage:StaticDrawUsage),this},InterleavedBuffer.prototype.setArray=function(){console.error("THREE.InterleavedBuffer: .setArray has been removed. Use BufferGeometry .setAttribute to replace/resize attribute buffers")},ExtrudeGeometry.prototype.getArrays=function(){console.error("THREE.ExtrudeGeometry: .getArrays() has been removed.")},ExtrudeGeometry.prototype.addShapeList=function(){console.error("THREE.ExtrudeGeometry: .addShapeList() has been removed.")},ExtrudeGeometry.prototype.addShape=function(){console.error("THREE.ExtrudeGeometry: .addShape() has been removed.")},Scene.prototype.dispose=function(){console.error("THREE.Scene: .dispose() has been removed.")},Object.defineProperties(Uniform.prototype,{dynamic:{set:function(){console.warn("THREE.Uniform: .dynamic has been removed. Use object.onBeforeRender() instead.")}},onUpdate:{value:function(){return console.warn("THREE.Uniform: .onUpdate() has been removed. Use object.onBeforeRender() instead."),this}}}),Object.defineProperties(Material$1.prototype,{wrapAround:{get:function(){console.warn("THREE.Material: .wrapAround has been removed.")},set:function(){console.warn("THREE.Material: .wrapAround has been removed.")}},overdraw:{get:function(){console.warn("THREE.Material: .overdraw has been removed.")},set:function(){console.warn("THREE.Material: .overdraw has been removed.")}},wrapRGB:{get:function(){return console.warn("THREE.Material: .wrapRGB has been removed."),new Color}},shading:{get:function(){console.error("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead.")},set:function(e){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=e===FlatShading}},stencilMask:{get:function(){return console.warn("THREE."+this.type+": .stencilMask has been removed. Use .stencilFuncMask instead."),this.stencilFuncMask},set:function(e){console.warn("THREE."+this.type+": .stencilMask has been removed. Use .stencilFuncMask instead."),this.stencilFuncMask=e}}}),Object.defineProperties(MeshPhongMaterial.prototype,{metal:{get:function(){return console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead."),!1},set:function(){console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead")}}}),Object.defineProperties(MeshPhysicalMaterial.prototype,{transparency:{get:function(){return console.warn("THREE.MeshPhysicalMaterial: .transparency has been renamed to .transmission."),this.transmission},set:function(e){console.warn("THREE.MeshPhysicalMaterial: .transparency has been renamed to .transmission."),this.transmission=e}}}),Object.defineProperties(ShaderMaterial.prototype,{derivatives:{get:function(){return console.warn("THREE.ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives},set:function(e){console.warn("THREE. ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives=e}}}),WebGLRenderer.prototype.clearTarget=function(e,t,r,n){console.warn("THREE.WebGLRenderer: .clearTarget() has been deprecated. Use .setRenderTarget() and .clear() instead."),this.setRenderTarget(e),this.clear(t,r,n)},WebGLRenderer.prototype.animate=function(e){console.warn("THREE.WebGLRenderer: .animate() is now .setAnimationLoop()."),this.setAnimationLoop(e)},WebGLRenderer.prototype.getCurrentRenderTarget=function(){return console.warn("THREE.WebGLRenderer: .getCurrentRenderTarget() is now .getRenderTarget()."),this.getRenderTarget()},WebGLRenderer.prototype.getMaxAnisotropy=function(){return console.warn("THREE.WebGLRenderer: .getMaxAnisotropy() is now .capabilities.getMaxAnisotropy()."),this.capabilities.getMaxAnisotropy()},WebGLRenderer.prototype.getPrecision=function(){return console.warn("THREE.WebGLRenderer: .getPrecision() is now .capabilities.precision."),this.capabilities.precision},WebGLRenderer.prototype.resetGLState=function(){return console.warn("THREE.WebGLRenderer: .resetGLState() is now .state.reset()."),this.state.reset()},WebGLRenderer.prototype.supportsFloatTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")},WebGLRenderer.prototype.supportsHalfFloatTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")},WebGLRenderer.prototype.supportsStandardDerivatives=function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")},WebGLRenderer.prototype.supportsCompressedTextureS3TC=function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")},WebGLRenderer.prototype.supportsCompressedTexturePVRTC=function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")},WebGLRenderer.prototype.supportsBlendMinMax=function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")},WebGLRenderer.prototype.supportsVertexTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsVertexTextures() is now .capabilities.vertexTextures."),this.capabilities.vertexTextures},WebGLRenderer.prototype.supportsInstancedArrays=function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")},WebGLRenderer.prototype.enableScissorTest=function(e){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(e)},WebGLRenderer.prototype.initMaterial=function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")},WebGLRenderer.prototype.addPrePlugin=function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")},WebGLRenderer.prototype.addPostPlugin=function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")},WebGLRenderer.prototype.updateShadowMap=function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")},WebGLRenderer.prototype.setFaceCulling=function(){console.warn("THREE.WebGLRenderer: .setFaceCulling() has been removed.")},WebGLRenderer.prototype.allocTextureUnit=function(){console.warn("THREE.WebGLRenderer: .allocTextureUnit() has been removed.")},WebGLRenderer.prototype.setTexture=function(){console.warn("THREE.WebGLRenderer: .setTexture() has been removed.")},WebGLRenderer.prototype.setTexture2D=function(){console.warn("THREE.WebGLRenderer: .setTexture2D() has been removed.")},WebGLRenderer.prototype.setTextureCube=function(){console.warn("THREE.WebGLRenderer: .setTextureCube() has been removed.")},WebGLRenderer.prototype.getActiveMipMapLevel=function(){return console.warn("THREE.WebGLRenderer: .getActiveMipMapLevel() is now .getActiveMipmapLevel()."),this.getActiveMipmapLevel()},Object.defineProperties(WebGLRenderer.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=e}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=e}},shadowMapCullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")}},context:{get:function(){return console.warn("THREE.WebGLRenderer: .context has been removed. Use .getContext() instead."),this.getContext()}},vr:{get:function(){return console.warn("THREE.WebGLRenderer: .vr has been renamed to .xr"),this.xr}},gammaInput:{get:function(){return console.warn("THREE.WebGLRenderer: .gammaInput has been removed. Set the encoding for textures via Texture.encoding instead."),!1},set:function(){console.warn("THREE.WebGLRenderer: .gammaInput has been removed. Set the encoding for textures via Texture.encoding instead.")}},gammaOutput:{get:function(){return console.warn("THREE.WebGLRenderer: .gammaOutput has been removed. Set WebGLRenderer.outputEncoding instead."),!1},set:function(e){console.warn("THREE.WebGLRenderer: .gammaOutput has been removed. Set WebGLRenderer.outputEncoding instead."),this.outputEncoding=!0===e?sRGBEncoding:LinearEncoding}},toneMappingWhitePoint:{get:function(){return console.warn("THREE.WebGLRenderer: .toneMappingWhitePoint has been removed."),1},set:function(){console.warn("THREE.WebGLRenderer: .toneMappingWhitePoint has been removed.")}}}),Object.defineProperties(WebGLShadowMap.prototype,{cullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")}},renderReverseSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")}},renderSingleSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")}}}),Object.defineProperties(WebGLRenderTarget.prototype,{wrapS:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS=e}},wrapT:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT=e}},magFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter=e}},minFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter=e}},anisotropy:{get:function(){return console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy},set:function(e){console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy=e}},offset:{get:function(){return console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset},set:function(e){console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset=e}},repeat:{get:function(){return console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat},set:function(e){console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat=e}},format:{get:function(){return console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format},set:function(e){console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format=e}},type:{get:function(){return console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type},set:function(e){console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type=e}},generateMipmaps:{get:function(){return console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps},set:function(e){console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps=e}}}),Object.defineProperties(Audio.prototype,{load:{value:function(e){console.warn("THREE.Audio: .load has been deprecated. Use THREE.AudioLoader instead.");const t=this;return(new AudioLoader).load(e,(function(e){t.setBuffer(e)})),this}},startTime:{set:function(){console.warn("THREE.Audio: .startTime is now .play( delay ).")}}}),AudioAnalyser.prototype.getData=function(){return console.warn("THREE.AudioAnalyser: .getData() is now .getFrequencyData()."),this.getFrequencyData()},CubeCamera.prototype.updateCubeMap=function(e,t){return console.warn("THREE.CubeCamera: .updateCubeMap() is now .update()."),this.update(e,t)},CubeCamera.prototype.clear=function(e,t,r,n){return console.warn("THREE.CubeCamera: .clear() is now .renderTarget.clear()."),this.renderTarget.clear(e,t,r,n)},ImageUtils.crossOrigin=void 0,ImageUtils.loadTexture=function(e,t,r,n){console.warn("THREE.ImageUtils.loadTexture has been deprecated. Use THREE.TextureLoader() instead.");const i=new TextureLoader;i.setCrossOrigin(this.crossOrigin);const a=i.load(e,r,void 0,n);return t&&(a.mapping=t),a},ImageUtils.loadTextureCube=function(e,t,r,n){console.warn("THREE.ImageUtils.loadTextureCube has been deprecated. Use THREE.CubeTextureLoader() instead.");const i=new CubeTextureLoader;i.setCrossOrigin(this.crossOrigin);const a=i.load(e,r,void 0,n);return t&&(a.mapping=t),a},ImageUtils.loadCompressedTexture=function(){console.error("THREE.ImageUtils.loadCompressedTexture has been removed. Use THREE.DDSLoader instead.")},ImageUtils.loadCompressedTextureCube=function(){console.error("THREE.ImageUtils.loadCompressedTextureCube has been removed. Use THREE.DDSLoader instead.")};const SceneUtils={createMultiMaterialObject:function(){console.error("THREE.SceneUtils has been moved to /examples/jsm/utils/SceneUtils.js")},detach:function(){console.error("THREE.SceneUtils has been moved to /examples/jsm/utils/SceneUtils.js")},attach:function(){console.error("THREE.SceneUtils has been moved to /examples/jsm/utils/SceneUtils.js")}};function LensFlare(){console.error("THREE.LensFlare has been moved to /examples/jsm/objects/Lensflare.js")}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:REVISION}})),"undefined"!=typeof window&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=REVISION);var three_module=Object.freeze({__proto__:null,ACESFilmicToneMapping:ACESFilmicToneMapping,AddEquation:AddEquation,AddOperation:AddOperation,AdditiveAnimationBlendMode:AdditiveAnimationBlendMode,AdditiveBlending:AdditiveBlending,AlphaFormat:AlphaFormat,AlwaysDepth:AlwaysDepth,AlwaysStencilFunc:AlwaysStencilFunc,AmbientLight:AmbientLight,AmbientLightProbe:AmbientLightProbe,AnimationClip:AnimationClip,AnimationLoader:AnimationLoader,AnimationMixer:AnimationMixer,AnimationObjectGroup:AnimationObjectGroup,AnimationUtils:AnimationUtils,ArcCurve:ArcCurve,ArrayCamera:ArrayCamera,ArrowHelper:ArrowHelper,Audio:Audio,AudioAnalyser:AudioAnalyser,AudioContext:AudioContext,AudioListener:AudioListener,AudioLoader:AudioLoader,AxesHelper:AxesHelper,AxisHelper:AxisHelper,BackSide:BackSide,BasicDepthPacking:BasicDepthPacking,BasicShadowMap:BasicShadowMap,BinaryTextureLoader:BinaryTextureLoader,Bone:Bone,BooleanKeyframeTrack:BooleanKeyframeTrack,BoundingBoxHelper:BoundingBoxHelper,Box2:Box2,Box3:Box3,Box3Helper:Box3Helper,BoxBufferGeometry:BoxGeometry,BoxGeometry:BoxGeometry,BoxHelper:BoxHelper,BufferAttribute:BufferAttribute,BufferGeometry:BufferGeometry,BufferGeometryLoader:BufferGeometryLoader,ByteType:ByteType,Cache:Cache,Camera:Camera$1$1,CameraHelper:CameraHelper,CanvasRenderer:CanvasRenderer,CanvasTexture:CanvasTexture,CatmullRomCurve3:CatmullRomCurve3,CineonToneMapping:CineonToneMapping,CircleBufferGeometry:CircleGeometry,CircleGeometry:CircleGeometry,ClampToEdgeWrapping:ClampToEdgeWrapping,Clock:Clock,Color:Color,ColorKeyframeTrack:ColorKeyframeTrack,CompressedTexture:CompressedTexture,CompressedTextureLoader:CompressedTextureLoader,ConeBufferGeometry:ConeGeometry,ConeGeometry:ConeGeometry,CubeCamera:CubeCamera,CubeReflectionMapping:CubeReflectionMapping,CubeRefractionMapping:CubeRefractionMapping,CubeTexture:CubeTexture,CubeTextureLoader:CubeTextureLoader,CubeUVReflectionMapping:CubeUVReflectionMapping,CubeUVRefractionMapping:CubeUVRefractionMapping,CubicBezierCurve:CubicBezierCurve,CubicBezierCurve3:CubicBezierCurve3,CubicInterpolant:CubicInterpolant,CullFaceBack:CullFaceBack,CullFaceFront:CullFaceFront,CullFaceFrontBack:CullFaceFrontBack,CullFaceNone:CullFaceNone,Curve:Curve,CurvePath:CurvePath,CustomBlending:CustomBlending,CustomToneMapping:CustomToneMapping,CylinderBufferGeometry:CylinderGeometry,CylinderGeometry:CylinderGeometry,Cylindrical:Cylindrical,DataTexture:DataTexture,DataTexture2DArray:DataTexture2DArray,DataTexture3D:DataTexture3D,DataTextureLoader:DataTextureLoader,DataUtils:DataUtils,DecrementStencilOp:DecrementStencilOp,DecrementWrapStencilOp:DecrementWrapStencilOp,DefaultLoadingManager:DefaultLoadingManager,DepthFormat:DepthFormat,DepthStencilFormat:DepthStencilFormat,DepthTexture:DepthTexture,DirectionalLight:DirectionalLight,DirectionalLightHelper:DirectionalLightHelper,DiscreteInterpolant:DiscreteInterpolant,DodecahedronBufferGeometry:DodecahedronGeometry,DodecahedronGeometry:DodecahedronGeometry,DoubleSide:DoubleSide,DstAlphaFactor:DstAlphaFactor,DstColorFactor:DstColorFactor,DynamicBufferAttribute:DynamicBufferAttribute,DynamicCopyUsage:DynamicCopyUsage,DynamicDrawUsage:DynamicDrawUsage,DynamicReadUsage:DynamicReadUsage,EdgesGeometry:EdgesGeometry,EdgesHelper:EdgesHelper,EllipseCurve:EllipseCurve,EqualDepth:EqualDepth,EqualStencilFunc:EqualStencilFunc,EquirectangularReflectionMapping:EquirectangularReflectionMapping,EquirectangularRefractionMapping:EquirectangularRefractionMapping,Euler:Euler,EventDispatcher:EventDispatcher,ExtrudeBufferGeometry:ExtrudeGeometry,ExtrudeGeometry:ExtrudeGeometry,FaceColors:FaceColors,FileLoader:FileLoader,FlatShading:FlatShading,Float16BufferAttribute:Float16BufferAttribute,Float32Attribute:Float32Attribute,Float32BufferAttribute:Float32BufferAttribute,Float64Attribute:Float64Attribute,Float64BufferAttribute:Float64BufferAttribute,FloatType:FloatType,Fog:Fog,FogExp2:FogExp2,Font:Font,FontLoader:FontLoader,FrontSide:FrontSide,Frustum:Frustum,GLBufferAttribute:GLBufferAttribute,GLSL1:GLSL1,GLSL3:GLSL3,GammaEncoding:GammaEncoding,GreaterDepth:GreaterDepth,GreaterEqualDepth:GreaterEqualDepth,GreaterEqualStencilFunc:GreaterEqualStencilFunc,GreaterStencilFunc:GreaterStencilFunc,GridHelper:GridHelper,Group:Group,HalfFloatType:HalfFloatType,HemisphereLight:HemisphereLight,HemisphereLightHelper:HemisphereLightHelper,HemisphereLightProbe:HemisphereLightProbe,IcosahedronBufferGeometry:IcosahedronGeometry,IcosahedronGeometry:IcosahedronGeometry,ImageBitmapLoader:ImageBitmapLoader,ImageLoader:ImageLoader,ImageUtils:ImageUtils,ImmediateRenderObject:ImmediateRenderObject,IncrementStencilOp:IncrementStencilOp,IncrementWrapStencilOp:IncrementWrapStencilOp,InstancedBufferAttribute:InstancedBufferAttribute,InstancedBufferGeometry:InstancedBufferGeometry,InstancedInterleavedBuffer:InstancedInterleavedBuffer,InstancedMesh:InstancedMesh,Int16Attribute:Int16Attribute,Int16BufferAttribute:Int16BufferAttribute,Int32Attribute:Int32Attribute,Int32BufferAttribute:Int32BufferAttribute,Int8Attribute:Int8Attribute,Int8BufferAttribute:Int8BufferAttribute,IntType:IntType,InterleavedBuffer:InterleavedBuffer,InterleavedBufferAttribute:InterleavedBufferAttribute,Interpolant:Interpolant,InterpolateDiscrete:InterpolateDiscrete,InterpolateLinear:InterpolateLinear,InterpolateSmooth:InterpolateSmooth,InvertStencilOp:InvertStencilOp,JSONLoader:JSONLoader,KeepStencilOp:KeepStencilOp,KeyframeTrack:KeyframeTrack,LOD:LOD,LatheBufferGeometry:LatheGeometry,LatheGeometry:LatheGeometry,Layers:Layers,LensFlare:LensFlare,LessDepth:LessDepth,LessEqualDepth:LessEqualDepth,LessEqualStencilFunc:LessEqualStencilFunc,LessStencilFunc:LessStencilFunc,Light:Light,LightProbe:LightProbe,Line:Line,Line3:Line3,LineBasicMaterial:LineBasicMaterial,LineCurve:LineCurve,LineCurve3:LineCurve3,LineDashedMaterial:LineDashedMaterial,LineLoop:LineLoop,LinePieces:LinePieces,LineSegments:LineSegments,LineStrip:LineStrip,LinearEncoding:LinearEncoding,LinearFilter:LinearFilter,LinearInterpolant:LinearInterpolant,LinearMipMapLinearFilter:LinearMipMapLinearFilter,LinearMipMapNearestFilter:LinearMipMapNearestFilter,LinearMipmapLinearFilter:LinearMipmapLinearFilter,LinearMipmapNearestFilter:LinearMipmapNearestFilter,LinearToneMapping:LinearToneMapping,Loader:Loader,LoaderUtils:LoaderUtils,LoadingManager:LoadingManager,LogLuvEncoding:LogLuvEncoding,LoopOnce:LoopOnce,LoopPingPong:LoopPingPong,LoopRepeat:LoopRepeat,LuminanceAlphaFormat:LuminanceAlphaFormat,LuminanceFormat:LuminanceFormat,MOUSE:MOUSE,Material:Material$1,MaterialLoader:MaterialLoader,Math:MathUtils,MathUtils:MathUtils,Matrix3:Matrix3,Matrix4:Matrix4,MaxEquation:MaxEquation,Mesh:Mesh,MeshBasicMaterial:MeshBasicMaterial,MeshDepthMaterial:MeshDepthMaterial,MeshDistanceMaterial:MeshDistanceMaterial,MeshFaceMaterial:MeshFaceMaterial,MeshLambertMaterial:MeshLambertMaterial,MeshMatcapMaterial:MeshMatcapMaterial,MeshNormalMaterial:MeshNormalMaterial,MeshPhongMaterial:MeshPhongMaterial,MeshPhysicalMaterial:MeshPhysicalMaterial,MeshStandardMaterial:MeshStandardMaterial,MeshToonMaterial:MeshToonMaterial,MinEquation:MinEquation,MirroredRepeatWrapping:MirroredRepeatWrapping,MixOperation:MixOperation,MultiMaterial:MultiMaterial,MultiplyBlending:MultiplyBlending,MultiplyOperation:MultiplyOperation,NearestFilter:NearestFilter,NearestMipMapLinearFilter:NearestMipMapLinearFilter,NearestMipMapNearestFilter:NearestMipMapNearestFilter,NearestMipmapLinearFilter:NearestMipmapLinearFilter,NearestMipmapNearestFilter:NearestMipmapNearestFilter,NeverDepth:NeverDepth,NeverStencilFunc:NeverStencilFunc,NoBlending:NoBlending,NoColors:NoColors,NoToneMapping:NoToneMapping,NormalAnimationBlendMode:NormalAnimationBlendMode,NormalBlending:NormalBlending,NotEqualDepth:NotEqualDepth,NotEqualStencilFunc:NotEqualStencilFunc,NumberKeyframeTrack:NumberKeyframeTrack,Object3D:Object3D,ObjectLoader:ObjectLoader,ObjectSpaceNormalMap:ObjectSpaceNormalMap,OctahedronBufferGeometry:OctahedronGeometry,OctahedronGeometry:OctahedronGeometry,OneFactor:OneFactor,OneMinusDstAlphaFactor:OneMinusDstAlphaFactor,OneMinusDstColorFactor:OneMinusDstColorFactor,OneMinusSrcAlphaFactor:OneMinusSrcAlphaFactor,OneMinusSrcColorFactor:OneMinusSrcColorFactor,OrthographicCamera:OrthographicCamera,PCFShadowMap:PCFShadowMap,PCFSoftShadowMap:PCFSoftShadowMap,PMREMGenerator:PMREMGenerator,ParametricBufferGeometry:ParametricGeometry,ParametricGeometry:ParametricGeometry,Particle:Particle,ParticleBasicMaterial:ParticleBasicMaterial,ParticleSystem:ParticleSystem,ParticleSystemMaterial:ParticleSystemMaterial,Path:Path$1,PerspectiveCamera:PerspectiveCamera,Plane:Plane,PlaneBufferGeometry:PlaneGeometry,PlaneGeometry:PlaneGeometry,PlaneHelper:PlaneHelper,PointCloud:PointCloud,PointCloudMaterial:PointCloudMaterial,PointLight:PointLight,PointLightHelper:PointLightHelper,Points:Points,PointsMaterial:PointsMaterial,PolarGridHelper:PolarGridHelper,PolyhedronBufferGeometry:PolyhedronGeometry,PolyhedronGeometry:PolyhedronGeometry,PositionalAudio:PositionalAudio,PropertyBinding:PropertyBinding,PropertyMixer:PropertyMixer,QuadraticBezierCurve:QuadraticBezierCurve,QuadraticBezierCurve3:QuadraticBezierCurve3,Quaternion:Quaternion,QuaternionKeyframeTrack:QuaternionKeyframeTrack,QuaternionLinearInterpolant:QuaternionLinearInterpolant,REVISION:REVISION,RGBADepthPacking:RGBADepthPacking,RGBAFormat:RGBAFormat,RGBAIntegerFormat:RGBAIntegerFormat,RGBA_ASTC_10x10_Format:RGBA_ASTC_10x10_Format,RGBA_ASTC_10x5_Format:RGBA_ASTC_10x5_Format,RGBA_ASTC_10x6_Format:RGBA_ASTC_10x6_Format,RGBA_ASTC_10x8_Format:RGBA_ASTC_10x8_Format,RGBA_ASTC_12x10_Format:RGBA_ASTC_12x10_Format,RGBA_ASTC_12x12_Format:RGBA_ASTC_12x12_Format,RGBA_ASTC_4x4_Format:RGBA_ASTC_4x4_Format,RGBA_ASTC_5x4_Format:RGBA_ASTC_5x4_Format,RGBA_ASTC_5x5_Format:RGBA_ASTC_5x5_Format,RGBA_ASTC_6x5_Format:RGBA_ASTC_6x5_Format,RGBA_ASTC_6x6_Format:RGBA_ASTC_6x6_Format,RGBA_ASTC_8x5_Format:RGBA_ASTC_8x5_Format,RGBA_ASTC_8x6_Format:RGBA_ASTC_8x6_Format,RGBA_ASTC_8x8_Format:RGBA_ASTC_8x8_Format,RGBA_BPTC_Format:RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:RGBA_ETC2_EAC_Format,RGBA_PVRTC_2BPPV1_Format:RGBA_PVRTC_2BPPV1_Format,RGBA_PVRTC_4BPPV1_Format:RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT1_Format:RGBA_S3TC_DXT1_Format,RGBA_S3TC_DXT3_Format:RGBA_S3TC_DXT3_Format,RGBA_S3TC_DXT5_Format:RGBA_S3TC_DXT5_Format,RGBDEncoding:RGBDEncoding,RGBEEncoding:RGBEEncoding,RGBEFormat:RGBEFormat,RGBFormat:RGBFormat,RGBIntegerFormat:RGBIntegerFormat,RGBM16Encoding:RGBM16Encoding,RGBM7Encoding:RGBM7Encoding,RGB_ETC1_Format:RGB_ETC1_Format,RGB_ETC2_Format:RGB_ETC2_Format,RGB_PVRTC_2BPPV1_Format:RGB_PVRTC_2BPPV1_Format,RGB_PVRTC_4BPPV1_Format:RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format:RGB_S3TC_DXT1_Format,RGFormat:RGFormat,RGIntegerFormat:RGIntegerFormat,RawShaderMaterial:RawShaderMaterial,Ray:Ray,Raycaster:Raycaster,RectAreaLight:RectAreaLight,RedFormat:RedFormat,RedIntegerFormat:RedIntegerFormat,ReinhardToneMapping:ReinhardToneMapping,RepeatWrapping:RepeatWrapping,ReplaceStencilOp:ReplaceStencilOp,ReverseSubtractEquation:ReverseSubtractEquation,RingBufferGeometry:RingGeometry,RingGeometry:RingGeometry,SRGB8_ALPHA8_ASTC_10x10_Format:SRGB8_ALPHA8_ASTC_10x10_Format,SRGB8_ALPHA8_ASTC_10x5_Format:SRGB8_ALPHA8_ASTC_10x5_Format,SRGB8_ALPHA8_ASTC_10x6_Format:SRGB8_ALPHA8_ASTC_10x6_Format,SRGB8_ALPHA8_ASTC_10x8_Format:SRGB8_ALPHA8_ASTC_10x8_Format,SRGB8_ALPHA8_ASTC_12x10_Format:SRGB8_ALPHA8_ASTC_12x10_Format,SRGB8_ALPHA8_ASTC_12x12_Format:SRGB8_ALPHA8_ASTC_12x12_Format,SRGB8_ALPHA8_ASTC_4x4_Format:SRGB8_ALPHA8_ASTC_4x4_Format,SRGB8_ALPHA8_ASTC_5x4_Format:SRGB8_ALPHA8_ASTC_5x4_Format,SRGB8_ALPHA8_ASTC_5x5_Format:SRGB8_ALPHA8_ASTC_5x5_Format,SRGB8_ALPHA8_ASTC_6x5_Format:SRGB8_ALPHA8_ASTC_6x5_Format,SRGB8_ALPHA8_ASTC_6x6_Format:SRGB8_ALPHA8_ASTC_6x6_Format,SRGB8_ALPHA8_ASTC_8x5_Format:SRGB8_ALPHA8_ASTC_8x5_Format,SRGB8_ALPHA8_ASTC_8x6_Format:SRGB8_ALPHA8_ASTC_8x6_Format,SRGB8_ALPHA8_ASTC_8x8_Format:SRGB8_ALPHA8_ASTC_8x8_Format,Scene:Scene,SceneUtils:SceneUtils,ShaderChunk:ShaderChunk,ShaderLib:ShaderLib,ShaderMaterial:ShaderMaterial,ShadowMaterial:ShadowMaterial,Shape:Shape,ShapeBufferGeometry:ShapeGeometry,ShapeGeometry:ShapeGeometry,ShapePath:ShapePath,ShapeUtils:ShapeUtils,ShortType:ShortType,Skeleton:Skeleton,SkeletonHelper:SkeletonHelper,SkinnedMesh:SkinnedMesh,SmoothShading:SmoothShading,Sphere:Sphere,SphereBufferGeometry:SphereGeometry,SphereGeometry:SphereGeometry,Spherical:Spherical,SphericalHarmonics3:SphericalHarmonics3,SplineCurve:SplineCurve,SpotLight:SpotLight,SpotLightHelper:SpotLightHelper,Sprite:Sprite,SpriteMaterial:SpriteMaterial,SrcAlphaFactor:SrcAlphaFactor,SrcAlphaSaturateFactor:SrcAlphaSaturateFactor,SrcColorFactor:SrcColorFactor,StaticCopyUsage:StaticCopyUsage,StaticDrawUsage:StaticDrawUsage,StaticReadUsage:StaticReadUsage,StereoCamera:StereoCamera,StreamCopyUsage:StreamCopyUsage,StreamDrawUsage:StreamDrawUsage,StreamReadUsage:StreamReadUsage,StringKeyframeTrack:StringKeyframeTrack,SubtractEquation:SubtractEquation,SubtractiveBlending:SubtractiveBlending,TOUCH:TOUCH,TangentSpaceNormalMap:TangentSpaceNormalMap,TetrahedronBufferGeometry:TetrahedronGeometry,TetrahedronGeometry:TetrahedronGeometry,TextBufferGeometry:TextGeometry,TextGeometry:TextGeometry,Texture:Texture$1,TextureLoader:TextureLoader,TorusBufferGeometry:TorusGeometry,TorusGeometry:TorusGeometry,TorusKnotBufferGeometry:TorusKnotGeometry,TorusKnotGeometry:TorusKnotGeometry,Triangle:Triangle,TriangleFanDrawMode:TriangleFanDrawMode,TriangleStripDrawMode:TriangleStripDrawMode,TrianglesDrawMode:TrianglesDrawMode,TubeBufferGeometry:TubeGeometry,TubeGeometry:TubeGeometry,UVMapping:UVMapping,Uint16Attribute:Uint16Attribute,Uint16BufferAttribute:Uint16BufferAttribute,Uint32Attribute:Uint32Attribute,Uint32BufferAttribute:Uint32BufferAttribute,Uint8Attribute:Uint8Attribute,Uint8BufferAttribute:Uint8BufferAttribute,Uint8ClampedAttribute:Uint8ClampedAttribute,Uint8ClampedBufferAttribute:Uint8ClampedBufferAttribute,Uniform:Uniform,UniformsLib:UniformsLib,UniformsUtils:UniformsUtils,UnsignedByteType:UnsignedByteType,UnsignedInt248Type:UnsignedInt248Type,UnsignedIntType:UnsignedIntType,UnsignedShort4444Type:UnsignedShort4444Type,UnsignedShort5551Type:UnsignedShort5551Type,UnsignedShort565Type:UnsignedShort565Type,UnsignedShortType:UnsignedShortType,VSMShadowMap:VSMShadowMap,Vector2:Vector2,Vector3:Vector3,Vector4:Vector4,VectorKeyframeTrack:VectorKeyframeTrack,Vertex:Vertex,VertexColors:VertexColors,VideoTexture:VideoTexture,WebGL1Renderer:WebGL1Renderer,WebGLCubeRenderTarget:WebGLCubeRenderTarget,WebGLMultisampleRenderTarget:WebGLMultisampleRenderTarget,WebGLRenderTarget:WebGLRenderTarget,WebGLRenderTargetCube:WebGLRenderTargetCube,WebGLRenderer:WebGLRenderer,WebGLUtils:WebGLUtils,WireframeGeometry:WireframeGeometry,WireframeHelper:WireframeHelper,WrapAroundEnding:WrapAroundEnding,XHRLoader:XHRLoader,ZeroCurvatureEnding:ZeroCurvatureEnding,ZeroFactor:ZeroFactor,ZeroSlopeEnding:ZeroSlopeEnding,ZeroStencilOp:ZeroStencilOp,sRGBEncoding:sRGBEncoding}),DDSLoader=function(e){CompressedTextureLoader.call(this,e)};DDSLoader.prototype=Object.assign(Object.create(CompressedTextureLoader.prototype),{constructor:DDSLoader,parse:function(e,t){var r={mipmaps:[],width:0,height:0,format:null,mipmapCount:1};function n(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function i(e,t,r,n){for(var i=r*n*4,a=new Uint8Array(e,t,i),o=new Uint8Array(i),s=0,l=0,c=0;c<n;c++)for(var h=0;h<r;h++){var u=a[l],d=a[++l],p=a[++l],f=a[++l];l++,o[s]=p,o[++s]=d,o[++s]=u,o[++s]=f,s++}return o}var a,o=n("DXT1"),s=n("DXT3"),l=n("DXT5"),c=n("ETC1"),h=new Int32Array(e,0,31);if(542327876!==h[0])return console.error("THREE.DDSLoader.parse: Invalid magic number in DDS header."),r;if(4&!h[20])return console.error("THREE.DDSLoader.parse: Unsupported format, must contain a FourCC code."),r;var u,d=h[21],p=!1;switch(d){case o:a=8,r.format=RGB_S3TC_DXT1_Format;break;case s:a=16,r.format=RGBA_S3TC_DXT3_Format;break;case l:a=16,r.format=RGBA_S3TC_DXT5_Format;break;case c:a=8,r.format=RGB_ETC1_Format;break;default:if(!(32===h[22]&&16711680&h[23]&&65280&h[24]&&255&h[25]&&4278190080&h[26]))return console.error("THREE.DDSLoader.parse: Unsupported FourCC code ",(u=d,String.fromCharCode(255&u,u>>8&255,u>>16&255,u>>24&255))),r;p=!0,a=64,r.format=RGBAFormat}r.mipmapCount=1,131072&h[2]&&!1!==t&&(r.mipmapCount=Math.max(1,h[7]));var f=h[28];if(r.isCubemap=!!(512&f),r.isCubemap&&(!(1024&f)||!(2048&f)||!(4096&f)||!(8192&f)||!(16384&f)||!(32768&f)))return console.error("THREE.DDSLoader.parse: Incomplete cubemap faces"),r;r.width=h[4],r.height=h[3];for(var m=h[1]+4,g=r.isCubemap?6:1,y=0;y<g;y++)for(var v=r.width,b=r.height,_=0;_<r.mipmapCount;_++){if(p)var x=(w=i(e,m,v,b)).length;else{x=Math.max(4,v)/4*Math.max(4,b)/4*a;var w=new Uint8Array(e,m,x)}var S={data:w,width:v,height:b};r.mipmaps.push(S),m+=x,v=Math.max(v>>1,1),b=Math.max(b>>1,1)}return r}});var DRACOLoader=function(e){Loader.call(this,e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}};DRACOLoader.prototype=Object.assign(Object.create(Loader.prototype),{constructor:DRACOLoader,setDecoderPath:function(e){return this.decoderPath=e,this},setDecoderConfig:function(e){return this.decoderConfig=e,this},setWorkerLimit:function(e){return this.workerLimit=e,this},setVerbosity:function(){console.warn("THREE.DRACOLoader: The .setVerbosity() method has been removed.")},setDrawMode:function(){console.warn("THREE.DRACOLoader: The .setDrawMode() method has been removed.")},setSkipDequantization:function(){console.warn("THREE.DRACOLoader: The .setSkipDequantization() method has been removed.")},load:function(e,t,r,n){var i=new FileLoader(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(e,(e=>{var r={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(e,r).then(t).catch(n)}),r,n)},decodeDracoFile:function(e,t,r,n){var i={attributeIDs:r||this.defaultAttributeIDs,attributeTypes:n||this.defaultAttributeTypes,useUniqueIDs:!!r};this.decodeGeometry(e,i).then(t)},decodeGeometry:function(e,t){for(var r in t.attributeTypes){var n=t.attributeTypes[r];void 0!==n.BYTES_PER_ELEMENT&&(t.attributeTypes[r]=n.name)}var i,a=JSON.stringify(t);if(DRACOLoader.taskCache.has(e)){var o=DRACOLoader.taskCache.get(e);if(o.key===a)return o.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var s=this.workerNextTaskID++,l=e.byteLength,c=this._getWorker(s,l).then((r=>(i=r,new Promise(((r,n)=>{i._callbacks[s]={resolve:r,reject:n},i.postMessage({type:"decode",id:s,taskConfig:t,buffer:e},[e])}))))).then((e=>this._createGeometry(e.geometry)));return c.catch((()=>!0)).then((()=>{i&&s&&this._releaseTask(i,s)})),DRACOLoader.taskCache.set(e,{key:a,promise:c}),c},_createGeometry:function(e){var t=new BufferGeometry;e.index&&t.setIndex(new BufferAttribute(e.index.array,1));for(var r=0;r<e.attributes.length;r++){var n=e.attributes[r],i=n.name,a=n.array,o=n.itemSize;t.setAttribute(i,new BufferAttribute(a,o))}return t},_loadLibrary:function(e,t){var r=new FileLoader(this.manager);return r.setPath(this.decoderPath),r.setResponseType(t),r.setWithCredentials(this.withCredentials),new Promise(((t,n)=>{r.load(e,t,void 0,n)}))},preload:function(){return this._initDecoder(),this},_initDecoder:function(){if(this.decoderPending)return this.decoderPending;var e="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then((t=>{var r=t[0];e||(this.decoderConfig.wasmBinary=t[1]);var n=DRACOLoader.DRACOWorker.toString(),i=["/* draco decoder */",r,"","/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([i]))})),this.decoderPending},_getWorker:function(e,t){return this._initDecoder().then((()=>{var r;this.workerPool.length<this.workerLimit?((r=new Worker(this.workerSourceURL))._callbacks={},r._taskCosts={},r._taskLoad=0,r.postMessage({type:"init",decoderConfig:this.decoderConfig}),r.onmessage=function(e){var t=e.data;switch(t.type){case"decode":r._callbacks[t.id].resolve(t);break;case"error":r._callbacks[t.id].reject(t);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+t.type+'"')}},this.workerPool.push(r)):this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));return(r=this.workerPool[this.workerPool.length-1])._taskCosts[e]=t,r._taskLoad+=t,r}))},_releaseTask:function(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]},debug:function(){console.log("Task load: ",this.workerPool.map((e=>e._taskLoad)))},dispose:function(){for(var e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}),DRACOLoader.DRACOWorker=function(){var e,t;function r(e,t,r,n,i,a){var o=a.num_components(),s=r.num_points()*o,l=s*i.BYTES_PER_ELEMENT,c=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,i),h=e._malloc(l);t.GetAttributeDataArrayForAllPoints(r,a,c,l,h);var u=new i(e.HEAPF32.buffer,h,s).slice();return e._free(h),{name:n,array:u,itemSize:o}}onmessage=function(n){var i=n.data;switch(i.type){case"init":e=i.decoderConfig,t=new Promise((function(t){e.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(e)}));break;case"decode":var a=i.buffer,o=i.taskConfig;t.then((e=>{var t=e.draco,n=new t.Decoder,s=new t.DecoderBuffer;s.Init(new Int8Array(a),a.byteLength);try{var l=function(e,t,n,i){var a,o,s=i.attributeIDs,l=i.attributeTypes,c=t.GetEncodedGeometryType(n);if(c===e.TRIANGULAR_MESH)a=new e.Mesh,o=t.DecodeBufferToMesh(n,a);else{if(c!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");a=new e.PointCloud,o=t.DecodeBufferToPointCloud(n,a)}if(!o.ok()||0===a.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+o.error_msg());var h={index:null,attributes:[]};for(var u in s){var d,p,f=self[l[u]];if(i.useUniqueIDs)p=s[u],d=t.GetAttributeByUniqueId(a,p);else{if(-1===(p=t.GetAttributeId(a,e[s[u]])))continue;d=t.GetAttribute(a,p)}h.attributes.push(r(e,t,a,u,f,d))}c===e.TRIANGULAR_MESH&&(h.index=function(e,t,r){var n=3*r.num_faces(),i=4*n,a=e._malloc(i);t.GetTrianglesUInt32Array(r,i,a);var o=new Uint32Array(e.HEAPF32.buffer,a,n).slice();return e._free(a),{array:o,itemSize:1}}(e,t,a));return e.destroy(a),h}(t,n,s,o),c=l.attributes.map((e=>e.array.buffer));l.index&&c.push(l.index.array.buffer),self.postMessage({type:"decode",id:i.id,geometry:l},c)}catch(e){console.error(e),self.postMessage({type:"error",id:i.id,error:e.message})}finally{t.destroy(s),t.destroy(n)}}))}}},DRACOLoader.taskCache=new WeakMap,DRACOLoader.setDecoderPath=function(){console.warn("THREE.DRACOLoader: The .setDecoderPath() method has been removed. Use instance methods.")},DRACOLoader.setDecoderConfig=function(){console.warn("THREE.DRACOLoader: The .setDecoderConfig() method has been removed. Use instance methods.")},DRACOLoader.releaseDecoderModule=function(){console.warn("THREE.DRACOLoader: The .releaseDecoderModule() method has been removed. Use instance methods.")},DRACOLoader.getDecoderModule=function(){console.warn("THREE.DRACOLoader: The .getDecoderModule() method has been removed. Use instance methods.")};var GLTFExporter$1=function(){function e(){this.pluginCallbacks=[],this.register((function(e){return new C(e)})),this.register((function(e){return new L(e)})),this.register((function(e){return new D(e)}))}e.prototype={constructor:e,register:function(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this},unregister:function(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this},parse:function(e,t,r){for(var n=new E,i=[],a=0,o=this.pluginCallbacks.length;a<o;a++)i.push(this.pluginCallbacks[a](n));n.setPlugins(i),n.write(e,t,r)}};var t=0,r=1,n=2,i=3,a=4,o=5121,s=5123,l=5126,c=5125,h=34962,u=34963,d=9728,p=9729,f=9984,m=9985,g=9986,y=9987,v=33071,b=33648,_=10497,x={};x[NearestFilter]=d,x[NearestMipmapNearestFilter]=f,x[NearestMipmapLinearFilter]=g,x[LinearFilter]=p,x[LinearMipmapNearestFilter]=m,x[LinearMipmapLinearFilter]=y,x[ClampToEdgeWrapping]=v,x[RepeatWrapping]=_,x[MirroredRepeatWrapping]=b;var w={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"};function S(e,t){return e.length===t.length&&e.every((function(e,r){return e===t[r]}))}function M(e){return 4*Math.ceil(e/4)}function T(e,t){t=t||0;var r=M(e.byteLength);if(r!==e.byteLength){var n=new Uint8Array(r);if(n.set(new Uint8Array(e)),0!==t)for(var i=e.byteLength;i<r;i++)n[i]=t;return n.buffer}return e}var A=null;function E(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}function C(e){this.writer=e,this.name="KHR_lights_punctual"}function L(e){this.writer=e,this.name="KHR_materials_unlit"}function D(e){this.writer=e,this.name="KHR_materials_pbrSpecularGlossiness"}return E.prototype={constructor:E,setPlugins:function(e){this.plugins=e},write:function(e,t,r){this.options=Object.assign({},{binary:!1,trs:!1,onlyVisible:!0,truncateDrawRange:!0,embedImages:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},r),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e);var n=this;Promise.all(this.pending).then((function(){var e,r=n.buffers,i=n.json,a=n.options,o=n.extensionsUsed,s=new Blob(r,{type:"application/octet-stream"}),l=Object.keys(o);(l.length>0&&(i.extensionsUsed=l),i.buffers&&i.buffers.length>0&&(i.buffers[0].byteLength=s.size),!0===a.binary)?((e=new window.FileReader).readAsArrayBuffer(s),e.onloadend=function(){var r=T(e.result),n=new DataView(new ArrayBuffer(8));n.setUint32(0,r.byteLength,!0),n.setUint32(4,5130562,!0);var a=T(function(e){if(void 0!==window.TextEncoder)return(new TextEncoder).encode(e).buffer;for(var t=new Uint8Array(new ArrayBuffer(e.length)),r=0,n=e.length;r<n;r++){var i=e.charCodeAt(r);t[r]=i>255?32:i}return t.buffer}(JSON.stringify(i)),32),o=new DataView(new ArrayBuffer(8));o.setUint32(0,a.byteLength,!0),o.setUint32(4,1313821514,!0);var s=new ArrayBuffer(12),l=new DataView(s);l.setUint32(0,1179937895,!0),l.setUint32(4,2,!0);var c=12+o.byteLength+a.byteLength+n.byteLength+r.byteLength;l.setUint32(8,c,!0);var h=new Blob([s,o,a,n,r],{type:"application/octet-stream"}),u=new window.FileReader;u.readAsArrayBuffer(h),u.onloadend=function(){t(u.result)}}):i.buffers&&i.buffers.length>0?((e=new window.FileReader).readAsDataURL(s),e.onloadend=function(){var r=e.result;i.buffers[0].uri=r,t(i)}):t(i)}))},serializeUserData:function(e,t){if(0!==Object.keys(e.userData).length){var r=this.options,n=this.extensionsUsed;try{var i=JSON.parse(JSON.stringify(e.userData));if(r.includeCustomExtensions&&i.gltfExtensions){for(var a in void 0===t.extensions&&(t.extensions={}),i.gltfExtensions)t.extensions[a]=i.gltfExtensions[a],n[a]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}},getUID:function(e){return this.uids.has(e)||this.uids.set(e,this.uid++),this.uids.get(e)},isNormalizedNormalAttribute:function(e){if(this.cache.attributesNormalized.has(e))return!1;for(var t=new Vector3,r=0,n=e.count;r<n;r++)if(Math.abs(t.fromBufferAttribute(e,r).length()-1)>5e-4)return!1;return!0},createNormalizedNormalAttribute:function(e){var t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);for(var r=e.clone(),n=new Vector3,i=0,a=r.count;i<a;i++)n.fromBufferAttribute(r,i),0===n.x&&0===n.y&&0===n.z?n.setX(1):n.normalize(),r.setXYZ(i,n.x,n.y,n.z);return t.attributesNormalized.set(e,r),r},applyTextureTransform:function(e,t){var r=!1,n={};0===t.offset.x&&0===t.offset.y||(n.offset=t.offset.toArray(),r=!0),0!==t.rotation&&(n.rotation=t.rotation,r=!0),1===t.repeat.x&&1===t.repeat.y||(n.scale=t.repeat.toArray(),r=!0),r&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=n,this.extensionsUsed.KHR_texture_transform=!0)},processBuffer:function(e){var t=this.json,r=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),r.push(e),0},processBufferView:function(e,t,r,n,i){var a,u=this.json;u.bufferViews||(u.bufferViews=[]),a=t===o?1:t===s?2:4;for(var d=M(n*e.itemSize*a),p=new DataView(new ArrayBuffer(d)),f=0,m=r;m<r+n;m++)for(var g=0;g<e.itemSize;g++){var y;e.itemSize>4?y=e.array[m*e.itemSize+g]:0===g?y=e.getX(m):1===g?y=e.getY(m):2===g?y=e.getZ(m):3===g&&(y=e.getW(m)),t===l?p.setFloat32(f,y,!0):t===c?p.setUint32(f,y,!0):t===s?p.setUint16(f,y,!0):t===o&&p.setUint8(f,y),f+=a}var v={buffer:this.processBuffer(p.buffer),byteOffset:this.byteOffset,byteLength:d};return void 0!==i&&(v.target=i),i===h&&(v.byteStride=e.itemSize*a),this.byteOffset+=d,u.bufferViews.push(v),{id:u.bufferViews.length-1,byteLength:0}},processBufferViewImage:function(e){var t=this,r=t.json;return r.bufferViews||(r.bufferViews=[]),new Promise((function(n){var i=new window.FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){var e=T(i.result),a={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,n(r.bufferViews.push(a)-1)}}))},processAccessor:function(e,t,r,n){var i,a=this.options,d=this.json;if(e.array.constructor===Float32Array)i=l;else if(e.array.constructor===Uint32Array)i=c;else if(e.array.constructor===Uint16Array)i=s;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");i=o}if(void 0===r&&(r=0),void 0===n&&(n=e.count),a.truncateDrawRange&&void 0!==t&&null===t.index){var p=r+n,f=t.drawRange.count===1/0?e.count:t.drawRange.start+t.drawRange.count;r=Math.max(r,t.drawRange.start),(n=Math.min(p,f)-r)<0&&(n=0)}if(0===n)return null;var m,g=function(e,t,r){for(var n={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)},i=t;i<t+r;i++)for(var a=0;a<e.itemSize;a++){var o;e.itemSize>4?o=e.array[i*e.itemSize+a]:0===a?o=e.getX(i):1===a?o=e.getY(i):2===a?o=e.getZ(i):3===a&&(o=e.getW(i)),n.min[a]=Math.min(n.min[a],o),n.max[a]=Math.max(n.max[a],o)}return n}(e,r,n);void 0!==t&&(m=e===t.index?u:h);var y=this.processBufferView(e,i,r,n,m),v={bufferView:y.id,byteOffset:y.byteOffset,componentType:i,count:n,max:g.max,min:g.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(v.normalized=!0),d.accessors||(d.accessors=[]),d.accessors.push(v)-1},processImage:function(e,t,r){var n=this,i=n.cache,a=n.json,o=n.options,s=n.pending;i.images.has(e)||i.images.set(e,{});var l=i.images.get(e),c=t===RGBAFormat?"image/png":"image/jpeg",h=c+":flipY/"+r.toString();if(void 0!==l[h])return l[h];a.images||(a.images=[]);var u={mimeType:c};if(o.embedImages){var d=A=A||document.createElement("canvas");d.width=Math.min(e.width,o.maxTextureSize),d.height=Math.min(e.height,o.maxTextureSize);var p=d.getContext("2d");if(!0===r&&(p.translate(0,d.height),p.scale(1,-1)),"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap)p.drawImage(e,0,0,d.width,d.height);else{t!==RGBAFormat&&t!==RGBFormat&&console.error("GLTFExporter: Only RGB and RGBA formats are supported."),(e.width>o.maxTextureSize||e.height>o.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);var f=e.data;if(t===RGBFormat){f=new Uint8ClampedArray(e.height*e.width*4);for(var m=0,g=0;m<f.length;m+=4,g+=3)f[m+0]=e.data[g+0],f[m+1]=e.data[g+1],f[m+2]=e.data[g+2],f[m+3]=255}p.putImageData(new ImageData(f,e.width,e.height),0,0)}!0===o.binary?s.push(new Promise((function(e){d.toBlob((function(t){n.processBufferViewImage(t).then((function(t){u.bufferView=t,e()}))}),c)}))):u.uri=d.toDataURL(c)}else u.uri=e.src;var y=a.images.push(u)-1;return l[h]=y,y},processSampler:function(e){var t=this.json;t.samplers||(t.samplers=[]);var r={magFilter:x[e.magFilter],minFilter:x[e.minFilter],wrapS:x[e.wrapS],wrapT:x[e.wrapT]};return t.samplers.push(r)-1},processTexture:function(e){var t=this.cache,r=this.json;if(t.textures.has(e))return t.textures.get(e);r.textures||(r.textures=[]);var n={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY)};e.name&&(n.name=e.name),this._invokeAll((function(t){t.writeTexture&&t.writeTexture(e,n)}));var i=r.textures.push(n)-1;return t.textures.set(e,i),i},processMaterial:function(e){var t=this.cache,r=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;r.materials||(r.materials=[]);var n={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");var i=e.color.toArray().concat([e.opacity]);if(S(i,[1,1,1,1])||(n.pbrMetallicRoughness.baseColorFactor=i),e.isMeshStandardMaterial?(n.pbrMetallicRoughness.metallicFactor=e.metalness,n.pbrMetallicRoughness.roughnessFactor=e.roughness):(n.pbrMetallicRoughness.metallicFactor=.5,n.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap)if(e.metalnessMap===e.roughnessMap){var a={index:this.processTexture(e.metalnessMap)};this.applyTextureTransform(a,e.metalnessMap),n.pbrMetallicRoughness.metallicRoughnessTexture=a}else console.warn("THREE.GLTFExporter: Ignoring metalnessMap and roughnessMap because they are not the same Texture.");if(e.map){var o={index:this.processTexture(e.map)};this.applyTextureTransform(o,e.map),n.pbrMetallicRoughness.baseColorTexture=o}if(e.emissive){var s=e.emissive.clone().multiplyScalar(e.emissiveIntensity).toArray();if(S(s,[0,0,0])||(n.emissiveFactor=s),e.emissiveMap){var l={index:this.processTexture(e.emissiveMap)};this.applyTextureTransform(l,e.emissiveMap),n.emissiveTexture=l}}if(e.normalMap){var c={index:this.processTexture(e.normalMap)};e.normalScale&&-1!==e.normalScale.x&&(e.normalScale.x!==e.normalScale.y&&console.warn("THREE.GLTFExporter: Normal scale components are different, ignoring Y and exporting X."),c.scale=e.normalScale.x),this.applyTextureTransform(c,e.normalMap),n.normalTexture=c}if(e.aoMap){var h={index:this.processTexture(e.aoMap),texCoord:1};1!==e.aoMapIntensity&&(h.strength=e.aoMapIntensity),this.applyTextureTransform(h,e.aoMap),n.occlusionTexture=h}e.transparent?n.alphaMode="BLEND":e.alphaTest>0&&(n.alphaMode="MASK",n.alphaCutoff=e.alphaTest),e.side===DoubleSide&&(n.doubleSided=!0),""!==e.name&&(n.name=e.name),this.serializeUserData(e,n),this._invokeAll((function(t){t.writeMaterial&&t.writeMaterial(e,n)}));var u=r.materials.push(n)-1;return t.materials.set(e,u),u},processMesh:function(e){var o=this.cache,s=this.json,l=[e.geometry.uuid];if(Array.isArray(e.material))for(var c=0,h=e.material.length;c<h;c++)l.push(e.material[c].uuid);else l.push(e.material.uuid);var u=l.join(":");if(o.meshes.has(u))return o.meshes.get(u);var d,p=e.geometry;if(d=e.isLineSegments?r:e.isLineLoop?n:e.isLine?i:e.isPoints?t:e.material.wireframe?r:a,!0!==p.isBufferGeometry)throw new Error("THREE.GLTFExporter: Geometry is not of type THREE.BufferGeometry.");var f={},m={},g=[],y=[],v={uv:"TEXCOORD_0",uv2:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},b=p.getAttribute("normal");void 0===b||this.isNormalizedNormalAttribute(b)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),p.setAttribute("normal",this.createNormalizedNormalAttribute(b)));var _=null;for(var x in p.attributes)if("morph"!==x.substr(0,5)){var w=p.attributes[x];x=v[x]||x.toUpperCase();if(/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(x)||(x="_"+x),o.attributes.has(this.getUID(w)))m[x]=o.attributes.get(this.getUID(w));else{_=null;var S=w.array;"JOINTS_0"!==x||S instanceof Uint16Array||S instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),_=new BufferAttribute(new Uint16Array(S),w.itemSize,w.normalized));var M=this.processAccessor(_||w,p);null!==M&&(m[x]=M,o.attributes.set(this.getUID(w),M))}}if(void 0!==b&&p.setAttribute("normal",b),0===Object.keys(m).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){var T=[],A=[],E={};if(void 0!==e.morphTargetDictionary)for(var C in e.morphTargetDictionary)E[e.morphTargetDictionary[C]]=C;for(c=0;c<e.morphTargetInfluences.length;++c){var L={},D=!1;for(var x in p.morphAttributes)if("position"===x||"normal"===x){w=p.morphAttributes[x][c];var R=x.toUpperCase(),P=p.attributes[x];if(o.attributes.has(this.getUID(w)))L[R]=o.attributes.get(this.getUID(w));else{var O=w.clone();if(!p.morphTargetsRelative)for(var I=0,k=w.count;I<k;I++)O.setXYZ(I,w.getX(I)-P.getX(I),w.getY(I)-P.getY(I),w.getZ(I)-P.getZ(I));L[R]=this.processAccessor(O,p),o.attributes.set(this.getUID(P),L[R])}}else D||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),D=!0);y.push(L),T.push(e.morphTargetInfluences[c]),void 0!==e.morphTargetDictionary&&A.push(E[c])}f.weights=T,A.length>0&&(f.extras={},f.extras.targetNames=A)}var B=Array.isArray(e.material);if(B&&0===p.groups.length)return null;for(var N=B?e.material:[e.material],F=B?p.groups:[{materialIndex:0,start:void 0,count:void 0}],U=(c=0,F.length);c<U;c++){var z={mode:d,attributes:m};if(this.serializeUserData(p,z),y.length>0&&(z.targets=y),null!==p.index){var H=this.getUID(p.index);void 0===F[c].start&&void 0===F[c].count||(H+=":"+F[c].start+":"+F[c].count),o.attributes.has(H)?z.indices=o.attributes.get(H):(z.indices=this.processAccessor(p.index,p,F[c].start,F[c].count),o.attributes.set(H,z.indices)),null===z.indices&&delete z.indices}var G=this.processMaterial(N[F[c].materialIndex]);null!==G&&(z.material=G),g.push(z)}f.primitives=g,s.meshes||(s.meshes=[]),this._invokeAll((function(t){t.writeMesh&&t.writeMesh(e,f)}));var V=s.meshes.push(f)-1;return o.meshes.set(u,V),V},processCamera:function(e){var t=this.json;t.cameras||(t.cameras=[]);var r=e.isOrthographicCamera,n={type:r?"orthographic":"perspective"};return r?n.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:n.perspective={aspectRatio:e.aspect,yfov:MathUtils.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(n.name=e.type),t.cameras.push(n)-1},processAnimation:function(t,r){var n=this.json,i=this.nodeMap;n.animations||(n.animations=[]);for(var a=(t=e.Utils.mergeMorphTargetTracks(t.clone(),r)).tracks,o=[],s=[],l=0;l<a.length;++l){var c=a[l],h=PropertyBinding.parseTrackName(c.name),u=PropertyBinding.findNode(r,h.nodeName),d=w[h.propertyName];if("bones"===h.objectName&&(u=!0===u.isSkinnedMesh?u.skeleton.getBoneByName(h.objectIndex):void 0),!u||!d)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',c.name),null;var p,f=c.values.length/c.times.length;d===w.morphTargetInfluences&&(f/=u.morphTargetInfluences.length),!0===c.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(p="CUBICSPLINE",f/=3):p=c.getInterpolation()===InterpolateDiscrete?"STEP":"LINEAR",s.push({input:this.processAccessor(new BufferAttribute(c.times,1)),output:this.processAccessor(new BufferAttribute(c.values,f)),interpolation:p}),o.push({sampler:s.length-1,target:{node:i.get(u),path:d}})}return n.animations.push({name:t.name||"clip_"+n.animations.length,samplers:s,channels:o}),n.animations.length-1},processSkin:function(e){var t=this.json,r=this.nodeMap,n=t.nodes[r.get(e)],i=e.skeleton;if(void 0===i)return null;var a=e.skeleton.bones[0];if(void 0===a)return null;for(var o=[],s=new Float32Array(16*i.bones.length),l=new Matrix4,c=0;c<i.bones.length;++c)o.push(r.get(i.bones[c])),l.copy(i.boneInverses[c]),l.multiply(e.bindMatrix).toArray(s,16*c);return void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new BufferAttribute(s,16)),joints:o,skeleton:r.get(a)}),n.skin=t.skins.length-1},processNode:function(e){var t=this.json,r=this.options,n=this.nodeMap;t.nodes||(t.nodes=[]);var i={};if(r.trs){var a=e.quaternion.toArray(),o=e.position.toArray(),s=e.scale.toArray();S(a,[0,0,0,1])||(i.rotation=a),S(o,[0,0,0])||(i.translation=o),S(s,[1,1,1])||(i.scale=s)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===S(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(i.matrix=e.matrix.elements);if(""!==e.name&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){var l=this.processMesh(e);null!==l&&(i.mesh=l)}else e.isCamera&&(i.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){for(var c=[],h=0,u=e.children.length;h<u;h++){var d=e.children[h];if(d.visible||!1===r.onlyVisible)null!==(p=this.processNode(d))&&c.push(p)}c.length>0&&(i.children=c)}this._invokeAll((function(t){t.writeNode&&t.writeNode(e,i)}));var p=t.nodes.push(i)-1;return n.set(e,p),p},processScene:function(e){var t=this.json,r=this.options;t.scenes||(t.scenes=[],t.scene=0);var n={};""!==e.name&&(n.name=e.name),t.scenes.push(n);for(var i=[],a=0,o=e.children.length;a<o;a++){var s=e.children[a];if(s.visible||!1===r.onlyVisible){var l=this.processNode(s);null!==l&&i.push(l)}}i.length>0&&(n.nodes=i),this.serializeUserData(e,n)},processObjects:function(e){var t=new Scene;t.name="AuxScene";for(var r=0;r<e.length;r++)t.children.push(e[r]);this.processScene(t)},processInput:function(e){var t=this.options;e=e instanceof Array?e:[e],this._invokeAll((function(t){t.beforeParse&&t.beforeParse(e)}));for(var r=[],n=0;n<e.length;n++)e[n]instanceof Scene?this.processScene(e[n]):r.push(e[n]);r.length>0&&this.processObjects(r);for(n=0;n<this.skins.length;++n)this.processSkin(this.skins[n]);for(n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);this._invokeAll((function(t){t.afterParse&&t.afterParse(e)}))},_invokeAll:function(e){for(var t=0,r=this.plugins.length;t<r;t++)e(this.plugins[t])}},C.prototype={constructor:C,writeNode:function(e,t){if(e.isLight)if(e.isDirectionalLight||e.isPointLight||e.isSpotLight){var r=this.writer,n=r.json,i=r.extensionsUsed,a={};e.name&&(a.name=e.name),a.color=e.color.toArray(),a.intensity=e.intensity,e.isDirectionalLight?a.type="directional":e.isPointLight?(a.type="point",e.distance>0&&(a.range=e.distance)):e.isSpotLight&&(a.type="spot",e.distance>0&&(a.range=e.distance),a.spot={},a.spot.innerConeAngle=(e.penumbra-1)*e.angle*-1,a.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),!e.target||e.target.parent===e&&0===e.target.position.x&&0===e.target.position.y&&-1===e.target.position.z||console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(n.extensions=n.extensions||{},n.extensions[this.name]={lights:[]},i[this.name]=!0);var o=n.extensions[this.name].lights;o.push(a),t.extensions=t.extensions||{},t.extensions[this.name]={light:o.length-1}}else console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e)}},L.prototype={constructor:L,writeMaterial:function(e,t){if(e.isMeshBasicMaterial){var r=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},r[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}},D.prototype={constructor:D,writeMaterial:function(e,t){if(e.isGLTFSpecularGlossinessMaterial){var r=this.writer,n=r.extensionsUsed,i={};t.pbrMetallicRoughness.baseColorFactor&&(i.diffuseFactor=t.pbrMetallicRoughness.baseColorFactor);var a=[1,1,1];if(e.specular.toArray(a,0),i.specularFactor=a,i.glossinessFactor=e.glossiness,t.pbrMetallicRoughness.baseColorTexture&&(i.diffuseTexture=t.pbrMetallicRoughness.baseColorTexture),e.specularMap){var o={index:r.processTexture(e.specularMap)};r.applyTextureTransform(o,e.specularMap),i.specularGlossinessTexture=o}t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}}},e.Utils={insertKeyframe:function(e,t){var r,n=.001,i=e.getValueSize(),a=new e.TimeBufferType(e.times.length+1),o=new e.ValueBufferType(e.values.length+i),s=e.createInterpolant(new e.ValueBufferType(i));if(0===e.times.length){a[0]=t;for(var l=0;l<i;l++)o[l]=0;r=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<n)return 0;a[0]=t,a.set(e.times,1),o.set(s.evaluate(t),0),o.set(e.values,i),r=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<n)return e.times.length-1;a[a.length-1]=t,a.set(e.times,0),o.set(e.values,0),o.set(s.evaluate(t),e.values.length),r=a.length-1}else for(l=0;l<e.times.length;l++){if(Math.abs(e.times[l]-t)<n)return l;if(e.times[l]<t&&e.times[l+1]>t){a.set(e.times.slice(0,l+1),0),a[l+1]=t,a.set(e.times.slice(l+1),l+2),o.set(e.values.slice(0,(l+1)*i),0),o.set(s.evaluate(t),(l+1)*i),o.set(e.values.slice((l+1)*i),(l+2)*i),r=l+1;break}}return e.times=a,e.values=o,r},mergeMorphTargetTracks:function(e,t){for(var r=[],n={},i=e.tracks,a=0;a<i.length;++a){var o=i[a],s=PropertyBinding.parseTrackName(o.name),l=PropertyBinding.findNode(t,s.nodeName);if("morphTargetInfluences"===s.propertyName&&void 0!==s.propertyIndex){if(o.createInterpolant!==o.InterpolantFactoryMethodDiscrete&&o.createInterpolant!==o.InterpolantFactoryMethodLinear){if(o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(o=o.clone()).setInterpolation(InterpolateLinear)}var c,h=l.morphTargetInfluences.length,u=l.morphTargetDictionary[s.propertyIndex];if(void 0===u)throw new Error("THREE.GLTFExporter: Morph target name not found: "+s.propertyIndex);if(void 0!==n[l.uuid]){var d=o.createInterpolant(new o.ValueBufferType(1));c=n[l.uuid];for(m=0;m<c.times.length;m++)c.values[m*h+u]=d.evaluate(c.times[m]);for(m=0;m<o.times.length;m++){var p=this.insertKeyframe(c,o.times[m]);c.values[p*h+u]=o.values[m]}}else{for(var f=new((c=o.clone()).ValueBufferType)(h*c.times.length),m=0;m<c.times.length;m++)f[m*h+u]=c.values[m];c.name=(s.nodeName||"")+".morphTargetInfluences",c.values=f,n[l.uuid]=c,r.push(c)}}else r.push(o)}return e.tracks=r,e}},e}(),LineSegmentsGeometry=function(){InstancedBufferGeometry.call(this),this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.setAttribute("position",new Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.setAttribute("uv",new Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))},vector,box;LineSegmentsGeometry.prototype=Object.assign(Object.create(InstancedBufferGeometry.prototype),{constructor:LineSegmentsGeometry,isLineSegmentsGeometry:!0,applyMatrix4:function(e){var t=this.attributes.instanceStart,r=this.attributes.instanceEnd;return void 0!==t&&(t.applyMatrix4(e),r.applyMatrix4(e),t.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},setPositions:function(e){var t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));var r=new InstancedInterleavedBuffer(t,6,1);return this.setAttribute("instanceStart",new InterleavedBufferAttribute(r,3,0)),this.setAttribute("instanceEnd",new InterleavedBufferAttribute(r,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this},setColors:function(e){var t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));var r=new InstancedInterleavedBuffer(t,6,1);return this.setAttribute("instanceColorStart",new InterleavedBufferAttribute(r,3,0)),this.setAttribute("instanceColorEnd",new InterleavedBufferAttribute(r,3,3)),this},fromWireframeGeometry:function(e){return this.setPositions(e.attributes.position.array),this},fromEdgesGeometry:function(e){return this.setPositions(e.attributes.position.array),this},fromMesh:function(e){return this.fromWireframeGeometry(new WireframeGeometry(e.geometry)),this},fromLineSegments:function(e){var t=e.geometry;if(!t.isGeometry)return t.isBufferGeometry&&this.setPositions(t.attributes.position.array),this;console.error("THREE.LineSegmentsGeometry no longer supports Geometry. Use THREE.BufferGeometry instead.")},computeBoundingBox:(box=new Box3,function(){null===this.boundingBox&&(this.boundingBox=new Box3);var e=this.attributes.instanceStart,t=this.attributes.instanceEnd;void 0!==e&&void 0!==t&&(this.boundingBox.setFromBufferAttribute(e),box.setFromBufferAttribute(t),this.boundingBox.union(box))}),computeBoundingSphere:(vector=new Vector3,function(){null===this.boundingSphere&&(this.boundingSphere=new Sphere),null===this.boundingBox&&this.computeBoundingBox();var e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(void 0!==e&&void 0!==t){var r=this.boundingSphere.center;this.boundingBox.getCenter(r);for(var n=0,i=0,a=e.count;i<a;i++)vector.fromBufferAttribute(e,i),n=Math.max(n,r.distanceToSquared(vector)),vector.fromBufferAttribute(t,i),n=Math.max(n,r.distanceToSquared(vector));this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}),toJSON:function(){},applyMatrix:function(e){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)}}),UniformsLib.line={linewidth:{value:1},resolution:{value:new Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},dashOffset:{value:0},gapSize:{value:1},opacity:{value:1}},ShaderLib.line={uniforms:UniformsUtils.merge([UniformsLib.common,UniformsLib.fog,UniformsLib.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float dashOffset;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\t\t\t#include <premultiplied_alpha_fragment>\n\n\t\t}\n\t\t"};var LineMaterial=function(e){ShaderMaterial.call(this,{type:"LineMaterial",uniforms:UniformsUtils.clone(ShaderLib.line.uniforms),vertexShader:ShaderLib.line.vertexShader,fragmentShader:ShaderLib.line.fragmentShader,clipping:!0}),this.dashed=!1,Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(e){this.uniforms.diffuse.value=e}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(e){this.uniforms.linewidth.value=e}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(e){this.uniforms.dashScale.value=e}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(e){this.uniforms.dashSize.value=e}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(e){this.uniforms.gapSize.value=e}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}}}),this.setValues(e)};LineMaterial.prototype=Object.create(ShaderMaterial.prototype),LineMaterial.prototype.constructor=LineMaterial,LineMaterial.prototype.isLineMaterial=!0;var LineSegments2=function(e,t){void 0===e&&(e=new LineSegmentsGeometry),void 0===t&&(t=new LineMaterial({color:16777215*Math.random()})),Mesh.call(this,e,t),this.type="LineSegments2"},start,end;LineSegments2.prototype=Object.assign(Object.create(Mesh.prototype),{constructor:LineSegments2,isLineSegments2:!0,computeLineDistances:(start=new Vector3,end=new Vector3,function(){for(var e=this.geometry,t=e.attributes.instanceStart,r=e.attributes.instanceEnd,n=new Float32Array(2*t.data.count),i=0,a=0,o=t.data.count;i<o;i++,a+=2)start.fromBufferAttribute(t,i),end.fromBufferAttribute(r,i),n[a]=0===a?0:n[a-1],n[a+1]=n[a]+start.distanceTo(end);var s=new InstancedInterleavedBuffer(n,2,1);return e.setAttribute("instanceDistanceStart",new InterleavedBufferAttribute(s,1,0)),e.setAttribute("instanceDistanceEnd",new InterleavedBufferAttribute(s,1,1)),this}),raycast:function(){var e=new Vector4,t=new Vector4,r=new Vector4,n=new Vector3,i=new Matrix4,a=new Line3,o=new Vector3;return function(s,l){null===s.camera&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2.');var c=void 0!==s.params.Line2&&s.params.Line2.threshold||0,h=s.ray,u=s.camera,d=u.projectionMatrix,p=this.geometry,f=this.material,m=f.resolution,g=f.linewidth+c,y=p.attributes.instanceStart,v=p.attributes.instanceEnd,b=-u.near;h.at(1,r),r.w=1,r.applyMatrix4(u.matrixWorldInverse),r.applyMatrix4(d),r.multiplyScalar(1/r.w),r.x*=m.x/2,r.y*=m.y/2,r.z=0,n.copy(r);var _=this.matrixWorld;i.multiplyMatrices(u.matrixWorldInverse,_);for(var x=0,w=y.count;x<w;x++){if(e.fromBufferAttribute(y,x),t.fromBufferAttribute(v,x),e.w=1,t.w=1,e.applyMatrix4(i),t.applyMatrix4(i),!(e.z>b&&t.z>b)){if(e.z>b){const r=e.z-t.z,n=(e.z-b)/r;e.lerp(t,n)}else if(t.z>b){const r=t.z-e.z,n=(t.z-b)/r;t.lerp(e,n)}e.applyMatrix4(d),t.applyMatrix4(d),e.multiplyScalar(1/e.w),t.multiplyScalar(1/t.w),e.x*=m.x/2,e.y*=m.y/2,t.x*=m.x/2,t.y*=m.y/2,a.start.copy(e),a.start.z=0,a.end.copy(t),a.end.z=0;var S=a.closestPointToPointParameter(n,!0);a.at(S,o);var M=MathUtils.lerp(e.z,t.z,S),T=M>=-1&&M<=1,A=n.distanceTo(o)<.5*g;if(T&&A){a.start.fromBufferAttribute(y,x),a.end.fromBufferAttribute(v,x),a.start.applyMatrix4(_),a.end.applyMatrix4(_);var E=new Vector3,C=new Vector3;h.distanceSqToSegment(a.start,a.end,C,E),l.push({point:C,pointOnLine:E,distance:h.origin.distanceTo(C),object:this,face:null,faceIndex:x,uv:null,uv2:null})}}}}}()});var LineGeometry=function(){LineSegmentsGeometry.call(this),this.type="LineGeometry"};LineGeometry.prototype=Object.assign(Object.create(LineSegmentsGeometry.prototype),{constructor:LineGeometry,isLineGeometry:!0,setPositions:function(e){for(var t=e.length-3,r=new Float32Array(2*t),n=0;n<t;n+=3)r[2*n]=e[n],r[2*n+1]=e[n+1],r[2*n+2]=e[n+2],r[2*n+3]=e[n+3],r[2*n+4]=e[n+4],r[2*n+5]=e[n+5];return LineSegmentsGeometry.prototype.setPositions.call(this,r),this},setColors:function(e){for(var t=e.length-3,r=new Float32Array(2*t),n=0;n<t;n+=3)r[2*n]=e[n],r[2*n+1]=e[n+1],r[2*n+2]=e[n+2],r[2*n+3]=e[n+3],r[2*n+4]=e[n+4],r[2*n+5]=e[n+5];return LineSegmentsGeometry.prototype.setColors.call(this,r),this},fromLine:function(e){var t=e.geometry;if(!t.isGeometry)return t.isBufferGeometry&&this.setPositions(t.attributes.position.array),this;console.error("THREE.LineGeometry no longer supports Geometry. Use THREE.BufferGeometry instead.")},copy:function(){return this}});var Line2=function(e,t){void 0===e&&(e=new LineGeometry),void 0===t&&(t=new LineMaterial({color:16777215*Math.random()})),LineSegments2.call(this,e,t),this.type="Line2"};Line2.prototype=Object.assign(Object.create(LineSegments2.prototype),{constructor:Line2,isLine2:!0});var TGALoader=function(e){Loader.call(this,e)};TGALoader.prototype=Object.assign(Object.create(Loader.prototype),{constructor:TGALoader,load:function(e,t,r,n){var i=this,a=new Texture$1,o=new FileLoader(this.manager);return o.setResponseType("arraybuffer"),o.setPath(this.path),o.setWithCredentials(this.withCredentials),o.load(e,(function(e){a.image=i.parse(e),a.needsUpdate=!0,void 0!==t&&t(a)}),r,n),a},parse:function(e){var t=0,r=1,n=2,i=3,a=9,o=10,s=11,l=48,c=4,h=0,u=1,d=2,p=3;e.length<19&&console.error("THREE.TGALoader: Not enough data to contain header.");var f=new Uint8Array(e),m=0,g={id_length:f[m++],colormap_type:f[m++],image_type:f[m++],colormap_index:f[m++]|f[m++]<<8,colormap_length:f[m++]|f[m++]<<8,colormap_size:f[m++],origin:[f[m++]|f[m++]<<8,f[m++]|f[m++]<<8],width:f[m++]|f[m++]<<8,height:f[m++]|f[m++]<<8,pixel_size:f[m++],flags:f[m++]};!function(e){switch(e.image_type){case r:case a:(e.colormap_length>256||24!==e.colormap_size||1!==e.colormap_type)&&console.error("THREE.TGALoader: Invalid type colormap data for indexed type.");break;case n:case i:case o:case s:e.colormap_type&&console.error("THREE.TGALoader: Invalid type colormap data for colormap type.");break;case t:console.error("THREE.TGALoader: No data.");default:console.error('THREE.TGALoader: Invalid type "%s".',e.image_type)}(e.width<=0||e.height<=0)&&console.error("THREE.TGALoader: Invalid image size."),8!==e.pixel_size&&16!==e.pixel_size&&24!==e.pixel_size&&32!==e.pixel_size&&console.error('THREE.TGALoader: Invalid pixel size "%s".',e.pixel_size)}(g),g.id_length+m>e.length&&console.error("THREE.TGALoader: No data."),m+=g.id_length;var y=!1,v=!1,b=!1;switch(g.image_type){case a:y=!0,v=!0;break;case r:v=!0;break;case o:y=!0;break;case n:break;case s:y=!0,b=!0;break;case i:b=!0}var _="undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(g.width,g.height):document.createElement("canvas");_.width=g.width,_.height=g.height;var x=_.getContext("2d"),w=x.createImageData(g.width,g.height),S=function(e,t,r,n,i){var a,o,s,l;if(o=r.pixel_size>>3,s=r.width*r.height*o,t&&(l=i.subarray(n,n+=r.colormap_length*(r.colormap_size>>3))),e){var c,h,u;a=new Uint8Array(s);for(var d=0,p=new Uint8Array(o);d<s;)if(h=1+(127&(c=i[n++])),128&c){for(u=0;u<o;++u)p[u]=i[n++];for(u=0;u<h;++u)a.set(p,d+u*o);d+=o*h}else{for(h*=o,u=0;u<h;++u)a[d+u]=i[n++];d+=h}}else a=i.subarray(n,n+=t?r.width*r.height:s);return{pixel_data:a,palettes:l}}(y,v,g,m,f);return function(e,t,r,n,i){var a,o,s,f,m,y;switch((g.flags&l)>>c){default:case d:a=0,s=1,m=t,o=0,f=1,y=r;break;case h:a=0,s=1,m=t,o=r-1,f=-1,y=-1;break;case p:a=t-1,s=-1,m=-1,o=0,f=1,y=r;break;case u:a=t-1,s=-1,m=-1,o=r-1,f=-1,y=-1}if(b)switch(g.pixel_size){case 8:!function(e,t,r,n,i,a,o,s){var l,c,h,u=0,d=g.width;for(h=t;h!==n;h+=r)for(c=i;c!==o;c+=a,u++)l=s[u],e[4*(c+d*h)+0]=l,e[4*(c+d*h)+1]=l,e[4*(c+d*h)+2]=l,e[4*(c+d*h)+3]=255}(e,o,f,y,a,s,m,n);break;case 16:!function(e,t,r,n,i,a,o,s){var l,c,h=0,u=g.width;for(c=t;c!==n;c+=r)for(l=i;l!==o;l+=a,h+=2)e[4*(l+u*c)+0]=s[h+0],e[4*(l+u*c)+1]=s[h+0],e[4*(l+u*c)+2]=s[h+0],e[4*(l+u*c)+3]=s[h+1]}(e,o,f,y,a,s,m,n);break;default:console.error("THREE.TGALoader: Format not supported.")}else switch(g.pixel_size){case 8:!function(e,t,r,n,i,a,o,s,l){var c,h,u,d=l,p=0,f=g.width;for(u=t;u!==n;u+=r)for(h=i;h!==o;h+=a,p++)c=s[p],e[4*(h+f*u)+3]=255,e[4*(h+f*u)+2]=d[3*c+0],e[4*(h+f*u)+1]=d[3*c+1],e[4*(h+f*u)+0]=d[3*c+2]}(e,o,f,y,a,s,m,n,i);break;case 16:!function(e,t,r,n,i,a,o,s){var l,c,h,u=0,d=g.width;for(h=t;h!==n;h+=r)for(c=i;c!==o;c+=a,u+=2)l=s[u+0]+(s[u+1]<<8),e[4*(c+d*h)+0]=(31744&l)>>7,e[4*(c+d*h)+1]=(992&l)>>2,e[4*(c+d*h)+2]=(31&l)>>3,e[4*(c+d*h)+3]=32768&l?0:255}(e,o,f,y,a,s,m,n);break;case 24:!function(e,t,r,n,i,a,o,s){var l,c,h=0,u=g.width;for(c=t;c!==n;c+=r)for(l=i;l!==o;l+=a,h+=3)e[4*(l+u*c)+3]=255,e[4*(l+u*c)+2]=s[h+0],e[4*(l+u*c)+1]=s[h+1],e[4*(l+u*c)+0]=s[h+2]}(e,o,f,y,a,s,m,n);break;case 32:!function(e,t,r,n,i,a,o,s){var l,c,h=0,u=g.width;for(c=t;c!==n;c+=r)for(l=i;l!==o;l+=a,h+=4)e[4*(l+u*c)+2]=s[h+0],e[4*(l+u*c)+1]=s[h+1],e[4*(l+u*c)+0]=s[h+2],e[4*(l+u*c)+3]=s[h+3]}(e,o,f,y,a,s,m,n);break;default:console.error("THREE.TGALoader: Format not supported.")}}(w.data,g.width,g.height,S.pixel_data,S.palettes),x.putImageData(w,0,0),_}});var Stats=function(){var e=0,t=document.createElement("div");function r(e){return t.appendChild(e.dom),e}function n(r){for(var n=0;n<t.children.length;n++)t.children[n].style.display=n===r?"block":"none";e=r}t.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",t.addEventListener("click",(function(r){r.preventDefault(),n(++e%t.children.length)}),!1);var i=(performance||Date).now(),a=i,o=0,s=r(new Stats.Panel("FPS","#0ff","#002")),l=r(new Stats.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var c=r(new Stats.Panel("MB","#f08","#201"));return n(0),{REVISION:16,dom:t,addPanel:r,showPanel:n,begin:function(){i=(performance||Date).now()},end:function(){o++;var e=(performance||Date).now();if(l.update(e-i,200),e>=a+1e3&&(s.update(1e3*o/(e-a),100),a=e,o=0,c)){var t=performance.memory;c.update(t.usedJSHeapSize/1048576,t.jsHeapSizeLimit/1048576)}return e},update:function(){i=this.end()},domElement:t,setMode:n}};Stats.Panel=function(e,t,r){var n=1/0,i=0,a=Math.round,o=a(window.devicePixelRatio||1),s=80*o,l=48*o,c=3*o,h=2*o,u=3*o,d=15*o,p=74*o,f=30*o,m=document.createElement("canvas");m.width=s,m.height=l,m.style.cssText="width:80px;height:48px";var g=m.getContext("2d");return g.font="bold "+9*o+"px Helvetica,Arial,sans-serif",g.textBaseline="top",g.fillStyle=r,g.fillRect(0,0,s,l),g.fillStyle=t,g.fillText(e,c,h),g.fillRect(u,d,p,f),g.fillStyle=r,g.globalAlpha=.9,g.fillRect(u,d,p,f),{dom:m,update:function(l,y){n=Math.min(n,l),i=Math.max(i,l),g.fillStyle=r,g.globalAlpha=1,g.fillRect(0,0,s,d),g.fillStyle=t,g.fillText(a(l)+" "+e+" ("+a(n)+"-"+a(i)+")",c,h),g.drawImage(m,u+o,d,p-o,f,u,d,p-o,f),g.fillRect(u+p-o,d,o,f),g.fillStyle=r,g.globalAlpha=.9,g.fillRect(u+p-o,d,o,a((1-l/y)*f))}}};var Stats$1=Stats,ColorChannel={RED:0,GREEN:1,BLUE:2,ALPHA:3},shader_default2="varying vec2 vUv;void main(){vUv=position.xy*0.5+0.5;gl_Position=vec4(position.xy,1.0,1.0);}",shader_default3="#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\nuniform lowp sampler2D cocBuffer;uniform vec2 texelSize;uniform float scale;\n#if PASS == 1\nuniform vec4 kernel64[32];\n#else\nuniform vec4 kernel16[8];\n#endif\nvarying vec2 vUv;void main(){\n#ifdef FOREGROUND\nvec2 CoCNearFar=texture2D(cocBuffer,vUv).rg;float CoC=CoCNearFar.r*scale;\n#else\nfloat CoC=texture2D(cocBuffer,vUv).g*scale;\n#endif\nif(CoC==0.0){gl_FragColor=texture2D(inputBuffer,vUv);}else{\n#ifdef FOREGROUND\nvec2 step=texelSize*max(CoC,CoCNearFar.g*scale);\n#else\nvec2 step=texelSize*CoC;\n#endif\n#if PASS == 1\nvec4 acc=vec4(0.0);for(int i=0;i<32;++i){vec4 kernel=kernel64[i];vec2 uv=step*kernel.xy+vUv;acc+=texture2D(inputBuffer,uv);uv=step*kernel.zw+vUv;acc+=texture2D(inputBuffer,uv);}gl_FragColor=acc/64.0;\n#else\nvec4 maxValue=texture2D(inputBuffer,vUv);for(int i=0;i<8;++i){vec4 kernel=kernel16[i];vec2 uv=step*kernel.xy+vUv;maxValue=max(texture2D(inputBuffer,uv),maxValue);uv=step*kernel.zw+vUv;maxValue=max(texture2D(inputBuffer,uv),maxValue);}gl_FragColor=maxValue;\n#endif\n}}",BokehMaterial=class extends ShaderMaterial{constructor(e=!1,t=!1){super({type:"BokehMaterial",defines:{PASS:e?"2":"1"},uniforms:{kernel64:new Uniform(null),kernel16:new Uniform(null),inputBuffer:new Uniform(null),cocBuffer:new Uniform(null),texelSize:new Uniform(new Vector2),scale:new Uniform(1)},fragmentShader:shader_default3,vertexShader:shader_default2,blending:NoBlending,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,t&&(this.defines.FOREGROUND="1"),this.generateKernel()}generateKernel(){const e=new Float32Array(128),t=new Float32Array(32);let r=0,n=0;for(let i=0;i<80;++i){const a=2.39996323*i,o=Math.sqrt(i)/Math.sqrt(80),s=o*Math.cos(a),l=o*Math.sin(a);i%5==0?(t[n++]=s,t[n++]=l):(e[r++]=s,e[r++]=l)}const i=[],a=[];for(let t=0;t<128;)i.push(new Vector4(e[t++],e[t++],e[t++],e[t++]));for(let e=0;e<32;)a.push(new Vector4(t[e++],t[e++],t[e++],t[e++]));this.uniforms.kernel64.value=i,this.uniforms.kernel16.value=a}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t)}},shader_default4="#include <common>\n#include <packing>\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\nuniform float focusDistance;uniform float focalLength;uniform float cameraNear;uniform float cameraFar;varying vec2 vUv;float readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(depthBuffer,uv));\n#else\nreturn texture2D(depthBuffer,uv).r;\n#endif\n}void main(){float depth=readDepth(vUv);\n#ifdef PERSPECTIVE_CAMERA\nfloat viewZ=perspectiveDepthToViewZ(depth,cameraNear,cameraFar);float linearDepth=viewZToOrthographicDepth(viewZ,cameraNear,cameraFar);\n#else\nfloat linearDepth=depth;\n#endif\nfloat signedDistance=linearDepth-focusDistance;float magnitude=smoothstep(0.0,focalLength,abs(signedDistance));gl_FragColor.rg=vec2(step(signedDistance,0.0)*magnitude,step(0.0,signedDistance)*magnitude);}",CircleOfConfusionMaterial=class extends ShaderMaterial{constructor(e){super({type:"CircleOfConfusionMaterial",defines:{DEPTH_PACKING:"0"},uniforms:{depthBuffer:new Uniform(null),focusDistance:new Uniform(0),focalLength:new Uniform(0),cameraNear:new Uniform(.3),cameraFar:new Uniform(1e3)},fragmentShader:shader_default4,vertexShader:shader_default2,blending:NoBlending,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.adoptCameraSettings(e)}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}adoptCameraSettings(e=null){null!==e&&(this.uniforms.cameraNear.value=e.near,this.uniforms.cameraFar.value=e.far,e instanceof PerspectiveCamera?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}},shader_default5="varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;\n#if EDGE_DETECTION_MODE != 0\nvarying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;\n#endif\n#if EDGE_DETECTION_MODE == 1\n#include <common>\n#endif\n#if EDGE_DETECTION_MODE == 0 || PREDICATION_MODE == 1\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\nfloat readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(depthBuffer,uv));\n#else\nreturn texture2D(depthBuffer,uv).r;\n#endif\n}vec3 gatherNeighbors(){float p=readDepth(vUv);float pLeft=readDepth(vUv0);float pTop=readDepth(vUv1);return vec3(p,pLeft,pTop);}\n#elif PREDICATION_MODE == 2\nuniform sampler2D predicationBuffer;vec3 gatherNeighbors(){float p=texture2D(predicationBuffer,vUv).r;float pLeft=texture2D(predicationBuffer,vUv0).r;float pTop=texture2D(predicationBuffer,vUv1).r;return vec3(p,pLeft,pTop);}\n#endif\n#if PREDICATION_MODE != 0\nvec2 calculatePredicatedThreshold(){vec3 neighbours=gatherNeighbors();vec2 delta=abs(neighbours.xx-neighbours.yz);vec2 edges=step(PREDICATION_THRESHOLD,delta);return PREDICATION_SCALE*EDGE_THRESHOLD*(1.0-PREDICATION_STRENGTH*edges);}\n#endif\n#if EDGE_DETECTION_MODE != 0\nuniform sampler2D inputBuffer;\n#endif\nvoid main(){\n#if EDGE_DETECTION_MODE == 0\nconst vec2 threshold=vec2(DEPTH_THRESHOLD);\n#elif PREDICATION_MODE != 0\nvec2 threshold=calculatePredicatedThreshold();\n#else\nconst vec2 threshold=vec2(EDGE_THRESHOLD);\n#endif\n#if EDGE_DETECTION_MODE == 0\nvec3 neighbors=gatherNeighbors();vec2 delta=abs(neighbors.xx-vec2(neighbors.y,neighbors.z));vec2 edges=step(threshold,delta);if(dot(edges,vec2(1.0))==0.0){discard;}gl_FragColor=vec4(edges,0.0,1.0);\n#elif EDGE_DETECTION_MODE == 1\nfloat l=linearToRelativeLuminance(texture2D(inputBuffer,vUv).rgb);float lLeft=linearToRelativeLuminance(texture2D(inputBuffer,vUv0).rgb);float lTop=linearToRelativeLuminance(texture2D(inputBuffer,vUv1).rgb);vec4 delta;delta.xy=abs(l-vec2(lLeft,lTop));vec2 edges=step(threshold,delta.xy);if(dot(edges,vec2(1.0))==0.0){discard;}float lRight=linearToRelativeLuminance(texture2D(inputBuffer,vUv2).rgb);float lBottom=linearToRelativeLuminance(texture2D(inputBuffer,vUv3).rgb);delta.zw=abs(l-vec2(lRight,lBottom));vec2 maxDelta=max(delta.xy,delta.zw);float lLeftLeft=linearToRelativeLuminance(texture2D(inputBuffer,vUv4).rgb);float lTopTop=linearToRelativeLuminance(texture2D(inputBuffer,vUv5).rgb);delta.zw=abs(vec2(lLeft,lTop)-vec2(lLeftLeft,lTopTop));maxDelta=max(maxDelta.xy,delta.zw);float finalDelta=max(maxDelta.x,maxDelta.y);edges.xy*=step(finalDelta,LOCAL_CONTRAST_ADAPTATION_FACTOR*delta.xy);gl_FragColor=vec4(edges,0.0,1.0);\n#elif EDGE_DETECTION_MODE == 2\nvec4 delta;vec3 c=texture2D(inputBuffer,vUv).rgb;vec3 cLeft=texture2D(inputBuffer,vUv0).rgb;vec3 t=abs(c-cLeft);delta.x=max(max(t.r,t.g),t.b);vec3 cTop=texture2D(inputBuffer,vUv1).rgb;t=abs(c-cTop);delta.y=max(max(t.r,t.g),t.b);vec2 edges=step(threshold,delta.xy);if(dot(edges,vec2(1.0))==0.0){discard;}vec3 cRight=texture2D(inputBuffer,vUv2).rgb;t=abs(c-cRight);delta.z=max(max(t.r,t.g),t.b);vec3 cBottom=texture2D(inputBuffer,vUv3).rgb;t=abs(c-cBottom);delta.w=max(max(t.r,t.g),t.b);vec2 maxDelta=max(delta.xy,delta.zw);vec3 cLeftLeft=texture2D(inputBuffer,vUv4).rgb;t=abs(c-cLeftLeft);delta.z=max(max(t.r,t.g),t.b);vec3 cTopTop=texture2D(inputBuffer,vUv5).rgb;t=abs(c-cTopTop);delta.w=max(max(t.r,t.g),t.b);maxDelta=max(maxDelta.xy,delta.zw);float finalDelta=max(maxDelta.x,maxDelta.y);edges*=step(finalDelta,LOCAL_CONTRAST_ADAPTATION_FACTOR*delta.xy);gl_FragColor=vec4(edges,0.0,1.0);\n#endif\n}",shader_default6="uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;\n#if EDGE_DETECTION_MODE != 0\nvarying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;\n#endif\nvoid main(){vUv=position.xy*0.5+0.5;vUv0=vUv+texelSize*vec2(-1.0,0.0);vUv1=vUv+texelSize*vec2(0.0,-1.0);\n#if EDGE_DETECTION_MODE != 0\nvUv2=vUv+texelSize*vec2(1.0,0.0);vUv3=vUv+texelSize*vec2(0.0,1.0);vUv4=vUv+texelSize*vec2(-2.0,0.0);vUv5=vUv+texelSize*vec2(0.0,-2.0);\n#endif\ngl_Position=vec4(position.xy,1.0,1.0);}",shader_default7="#include <common>\n#include <dithering_pars_fragment>\n#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\nvarying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec4 sum=texture2D(inputBuffer,vUv0);sum+=texture2D(inputBuffer,vUv1);sum+=texture2D(inputBuffer,vUv2);sum+=texture2D(inputBuffer,vUv3);gl_FragColor=sum*0.25;\n#include <dithering_fragment>\n}",shader_default8="uniform vec2 texelSize;uniform vec2 halfTexelSize;uniform float kernel;uniform float scale;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vec2 dUv=(texelSize*vec2(kernel)+halfTexelSize)*scale;vUv0=vec2(uv.x-dUv.x,uv.y+dUv.y);vUv1=vec2(uv.x+dUv.x,uv.y+dUv.y);vUv2=vec2(uv.x+dUv.x,uv.y-dUv.y);vUv3=vec2(uv.x-dUv.x,uv.y-dUv.y);gl_Position=vec4(position.xy,1.0,1.0);}",ConvolutionMaterial=class extends ShaderMaterial{constructor(e=new Vector2){super({type:"ConvolutionMaterial",uniforms:{inputBuffer:new Uniform(null),texelSize:new Uniform(new Vector2),halfTexelSize:new Uniform(new Vector2),kernel:new Uniform(0),scale:new Uniform(1)},fragmentShader:shader_default7,vertexShader:shader_default8,blending:NoBlending,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.setTexelSize(e.x,e.y),this.kernelSize=KernelSize$1.LARGE}getKernel(){return kernelPresets$1[this.kernelSize]}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t),this.uniforms.halfTexelSize.value.set(e,t).multiplyScalar(.5)}},kernelPresets$1=[new Float32Array([0,0]),new Float32Array([0,1,1]),new Float32Array([0,1,1,2]),new Float32Array([0,1,2,2,3]),new Float32Array([0,1,2,3,4,4,5]),new Float32Array([0,1,2,3,4,5,7,8,9,10])],KernelSize$1={VERY_SMALL:0,SMALL:1,MEDIUM:2,LARGE:3,VERY_LARGE:4,HUGE:5},shader_default9="#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\nuniform float opacity;varying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);gl_FragColor=opacity*texel;\n#include <encodings_fragment>\n}",CopyMaterial=class extends ShaderMaterial{constructor(){super({type:"CopyMaterial",uniforms:{inputBuffer:new Uniform(null),opacity:new Uniform(1)},fragmentShader:shader_default9,vertexShader:shader_default2,blending:NoBlending,depthWrite:!1,depthTest:!1}),this.toneMapped=!1}},shader_default10="#include <packing>\n#include <clipping_planes_pars_fragment>\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\nuniform float cameraNear;uniform float cameraFar;varying float vViewZ;varying vec4 vProjTexCoord;void main(){\n#include <clipping_planes_fragment>\nvec2 projTexCoord=(vProjTexCoord.xy/vProjTexCoord.w)*0.5+0.5;projTexCoord=clamp(projTexCoord,0.002,0.998);float fragCoordZ=unpackRGBAToDepth(texture2D(depthBuffer,projTexCoord));\n#ifdef PERSPECTIVE_CAMERA\nfloat viewZ=perspectiveDepthToViewZ(fragCoordZ,cameraNear,cameraFar);\n#else\nfloat viewZ=orthographicDepthToViewZ(fragCoordZ,cameraNear,cameraFar);\n#endif\nfloat depthTest=(-vViewZ>-viewZ)? 1.0 : 0.0;gl_FragColor.rg=vec2(0.0,depthTest);}",shader_default11="#include <common>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying float vViewZ;varying vec4 vProjTexCoord;void main(){\n#include <skinbase_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <project_vertex>\nvViewZ=mvPosition.z;vProjTexCoord=gl_Position;\n#include <clipping_planes_vertex>\n}",DepthComparisonMaterial=class extends ShaderMaterial{constructor(e=null,t){super({type:"DepthComparisonMaterial",uniforms:{depthBuffer:new Uniform(e),cameraNear:new Uniform(.3),cameraFar:new Uniform(1e3)},fragmentShader:shader_default10,vertexShader:shader_default11,blending:NoBlending,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.adoptCameraSettings(t)}adoptCameraSettings(e=null){null!==e&&(this.uniforms.cameraNear.value=e.near,this.uniforms.cameraFar.value=e.far,e instanceof PerspectiveCamera?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA)}},shader_default14="#include <packing>\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\n#ifdef DOWNSAMPLE_NORMALS\nuniform lowp sampler2D normalBuffer;\n#endif\nvarying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;float readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(depthBuffer,uv));\n#else\nreturn texture2D(depthBuffer,uv).r;\n#endif\n}int findBestDepth(const in float samples[4]){float c=(samples[0]+samples[1]+samples[2]+samples[3])/4.0;float distances[4];distances[0]=abs(c-samples[0]);distances[1]=abs(c-samples[1]);distances[2]=abs(c-samples[2]);distances[3]=abs(c-samples[3]);float maxDistance=max(max(distances[0],distances[1]),max(distances[2],distances[3]));int remaining[3];int rejected[3];int i,j,k;for(i=0,j=0,k=0;i<4;++i){if(distances[i]<maxDistance){remaining[j++]=i;}else{rejected[k++]=i;}}for(;j<3;++j){remaining[j]=rejected[--k];}vec3 s=vec3(samples[remaining[0]],samples[remaining[1]],samples[remaining[2]]);c=(s.x+s.y+s.z)/3.0;distances[0]=abs(c-s.x);distances[1]=abs(c-s.y);distances[2]=abs(c-s.z);float minDistance=min(distances[0],min(distances[1],distances[2]));for(i=0;i<3;++i){if(distances[i]==minDistance){break;}}return remaining[i];}void main(){float d[4];d[0]=readDepth(vUv0);d[1]=readDepth(vUv1);d[2]=readDepth(vUv2);d[3]=readDepth(vUv3);int index=findBestDepth(d);\n#ifdef DOWNSAMPLE_NORMALS\nvec2 uvs[4];uvs[0]=vUv0;uvs[1]=vUv1;uvs[2]=vUv2;uvs[3]=vUv3;vec3 n=texture2D(normalBuffer,uvs[index]).rgb;\n#else\nvec3 n=vec3(0.0);\n#endif\ngl_FragColor=vec4(n,d[index]);}",shader_default15="uniform vec2 texelSize;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vUv0=uv;vUv1=vec2(uv.x,uv.y+texelSize.y);vUv2=vec2(uv.x+texelSize.x,uv.y);vUv3=uv+texelSize;gl_Position=vec4(position.xy,1.0,1.0);}",DepthDownsamplingMaterial=class extends ShaderMaterial{constructor(){super({type:"DepthDownsamplingMaterial",defines:{DEPTH_PACKING:"0"},uniforms:{depthBuffer:new Uniform(null),normalBuffer:new Uniform(null),texelSize:new Uniform(new Vector2)},fragmentShader:shader_default14,vertexShader:shader_default15,blending:NoBlending,depthWrite:!1,depthTest:!1}),this.toneMapped=!1}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t)}},EdgeDetectionMaterial=class extends ShaderMaterial{constructor(e=new Vector2,t=EdgeDetectionMode.COLOR){super({type:"EdgeDetectionMaterial",defines:{LOCAL_CONTRAST_ADAPTATION_FACTOR:"2.0",EDGE_THRESHOLD:"0.1",DEPTH_THRESHOLD:"0.01",PREDICATION_MODE:"0",PREDICATION_THRESHOLD:"0.01",PREDICATION_SCALE:"2.0",PREDICATION_STRENGTH:"1.0",DEPTH_PACKING:"0"},uniforms:{inputBuffer:new Uniform(null),depthBuffer:new Uniform(null),predicationBuffer:new Uniform(null),texelSize:new Uniform(e)},fragmentShader:shader_default5,vertexShader:shader_default6,blending:NoBlending,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.setEdgeDetectionMode(t)}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setEdgeDetectionMode(e){this.defines.EDGE_DETECTION_MODE=e.toFixed(0),this.needsUpdate=!0}setLocalContrastAdaptationFactor(e){this.defines.LOCAL_CONTRAST_ADAPTATION_FACTOR=e.toFixed("6"),this.needsUpdate=!0}setEdgeDetectionThreshold(e){this.defines.EDGE_THRESHOLD=e.toFixed("6"),this.defines.DEPTH_THRESHOLD=(.1*e).toFixed("6"),this.needsUpdate=!0}setPredicationMode(e){this.defines.PREDICATION_MODE=e.toFixed(0),this.needsUpdate=!0}setPredicationBuffer(e){this.uniforms.predicationBuffer.value=e}setPredicationThreshold(e){this.defines.PREDICATION_THRESHOLD=e.toFixed("6"),this.needsUpdate=!0}setPredicationScale(e){this.defines.PREDICATION_SCALE=e.toFixed("6"),this.needsUpdate=!0}setPredicationStrength(e){this.defines.PREDICATION_STRENGTH=e.toFixed("6"),this.needsUpdate=!0}},EdgeDetectionMode={DEPTH:0,LUMA:1,COLOR:2},PredicationMode={DISABLED:0,DEPTH:1,CUSTOM:2},shader_default17="#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\nuniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;float readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(depthBuffer,uv));\n#else\nreturn texture2D(depthBuffer,uv).r;\n#endif\n}float getViewZ(const in float depth){\n#ifdef PERSPECTIVE_CAMERA\nreturn perspectiveDepthToViewZ(depth,cameraNear,cameraFar);\n#else\nreturn orthographicDepthToViewZ(depth,cameraNear,cameraFar);\n#endif\n}FRAGMENT_HEADvoid main(){FRAGMENT_MAIN_UVvec4 color0=texture2D(inputBuffer,UV);vec4 color1=vec4(0.0);FRAGMENT_MAIN_IMAGEgl_FragColor=color0;\n#ifdef ENCODE_OUTPUT\n#include <encodings_fragment>\n#endif\n#include <dithering_fragment>\n}",shader_default18="uniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;VERTEX_HEADvoid main(){vUv=position.xy*0.5+0.5;VERTEX_MAIN_SUPPORTgl_Position=vec4(position.xy,1.0,1.0);}",EffectMaterial=class extends ShaderMaterial{constructor(e=null,t=null,r=null,n,i=!1){super({type:"EffectMaterial",defines:{DEPTH_PACKING:"0",ENCODE_OUTPUT:"1"},uniforms:{inputBuffer:new Uniform(null),depthBuffer:new Uniform(null),resolution:new Uniform(new Vector2),texelSize:new Uniform(new Vector2),cameraNear:new Uniform(.3),cameraFar:new Uniform(1e3),aspect:new Uniform(1),time:new Uniform(0)},blending:NoBlending,depthWrite:!1,depthTest:!1,dithering:i}),this.toneMapped=!1,null!==e&&this.setShaderParts(e),null!==t&&this.setDefines(t),null!==r&&this.setUniforms(r),this.adoptCameraSettings(n)}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setShaderParts(e){return this.fragmentShader=shader_default17.replace(Section.FRAGMENT_HEAD,e.get(Section.FRAGMENT_HEAD)).replace(Section.FRAGMENT_MAIN_UV,e.get(Section.FRAGMENT_MAIN_UV)).replace(Section.FRAGMENT_MAIN_IMAGE,e.get(Section.FRAGMENT_MAIN_IMAGE)),this.vertexShader=shader_default18.replace(Section.VERTEX_HEAD,e.get(Section.VERTEX_HEAD)).replace(Section.VERTEX_MAIN_SUPPORT,e.get(Section.VERTEX_MAIN_SUPPORT)),this.needsUpdate=!0,this}setDefines(e){for(const t of e.entries())this.defines[t[0]]=t[1];return this.needsUpdate=!0,this}setUniforms(e){for(const t of e.entries())this.uniforms[t[0]]=t[1];return this}adoptCameraSettings(e=null){null!==e&&(this.uniforms.cameraNear.value=e.near,this.uniforms.cameraFar.value=e.far,e instanceof PerspectiveCamera?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}setSize(e,t){const r=Math.max(e,1),n=Math.max(t,1);this.uniforms.resolution.value.set(r,n),this.uniforms.texelSize.value.set(1/r,1/n),this.uniforms.aspect.value=r/n}},Section={FRAGMENT_HEAD:"FRAGMENT_HEAD",FRAGMENT_MAIN_UV:"FRAGMENT_MAIN_UV",FRAGMENT_MAIN_IMAGE:"FRAGMENT_MAIN_IMAGE",VERTEX_HEAD:"VERTEX_HEAD",VERTEX_MAIN_SUPPORT:"VERTEX_MAIN_SUPPORT"},shader_default20="#include <common>\n#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\n#ifdef RANGE\nuniform vec2 range;\n#elif defined(THRESHOLD)\nuniform float threshold;uniform float smoothing;\n#endif\nvarying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);float l=linearToRelativeLuminance(texel.rgb);\n#ifdef RANGE\nfloat low=step(range.x,l);float high=step(l,range.y);l*=low*high;\n#elif defined(THRESHOLD)\nl=smoothstep(threshold,threshold+smoothing,l);\n#endif\n#ifdef COLOR\ngl_FragColor=vec4(texel.rgb*l,l);\n#else\ngl_FragColor=vec4(l);\n#endif\n}",LuminanceMaterial=class extends ShaderMaterial{constructor(e=!1,t=null){const r=null!==t;super({type:"LuminanceMaterial",uniforms:{inputBuffer:new Uniform(null),threshold:new Uniform(0),smoothing:new Uniform(1),range:new Uniform(r?t:new Vector2)},fragmentShader:shader_default20,vertexShader:shader_default2,blending:NoBlending,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.colorOutput=e,this.useThreshold=!0,this.useRange=r}get threshold(){return this.uniforms.threshold.value}set threshold(e){this.uniforms.threshold.value=e}get smoothing(){return this.uniforms.smoothing.value}set smoothing(e){this.uniforms.smoothing.value=e}get useThreshold(){return void 0!==this.defines.THRESHOLD}set useThreshold(e){e?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.needsUpdate=!0}get colorOutput(){return void 0!==this.defines.COLOR}set colorOutput(e){e?this.defines.COLOR="1":delete this.defines.COLOR,this.needsUpdate=!0}setColorOutputEnabled(e){this.colorOutput=e}get useRange(){return void 0!==this.defines.RANGE}set useRange(e){e?this.defines.RANGE="1":delete this.defines.RANGE,this.needsUpdate=!0}get luminanceRange(){return this.useRange}set luminanceRange(e){this.useRange=e}setLuminanceRangeEnabled(e){this.useRange=e}},shader_default21="#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\n#ifdef MASK_PRECISION_HIGH\nuniform mediump sampler2D maskTexture;\n#else\nuniform lowp sampler2D maskTexture;\n#endif\n#if MASK_FUNCTION != 0\nuniform float strength;\n#endif\nvarying vec2 vUv;void main(){\n#if COLOR_CHANNEL == 0\nfloat mask=texture2D(maskTexture,vUv).r;\n#elif COLOR_CHANNEL == 1\nfloat mask=texture2D(maskTexture,vUv).g;\n#elif COLOR_CHANNEL == 2\nfloat mask=texture2D(maskTexture,vUv).b;\n#else\nfloat mask=texture2D(maskTexture,vUv).a;\n#endif\n#if MASK_FUNCTION == 0\n#ifdef INVERTED\nmask=step(mask,0.0);\n#else\nmask=1.0-step(mask,0.0);\n#endif\n#else\nmask=clamp(mask*strength,0.0,1.0);\n#ifdef INVERTED\nmask=1.0-mask;\n#endif\n#endif\n#if MASK_FUNCTION == 2\ngl_FragColor=vec4(mask*texture2D(inputBuffer,vUv).rgb,mask);\n#else\ngl_FragColor=mask*texture2D(inputBuffer,vUv);\n#endif\n}",MaskMaterial=class extends ShaderMaterial{constructor(e=null){super({type:"MaskMaterial",uniforms:{maskTexture:new Uniform(e),inputBuffer:new Uniform(null),strength:new Uniform(1)},fragmentShader:shader_default21,vertexShader:shader_default2,blending:NoBlending,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.colorChannel=ColorChannel.RED,this.maskFunction=MaskFunction.DISCARD}set maskTexture(e){this.uniforms.maskTexture.value=e,delete this.defines.MASK_PRECISION_HIGH,e.type!==UnsignedByteType&&(this.defines.MASK_PRECISION_HIGH="1"),this.needsUpdate=!0}set colorChannel(e){this.defines.COLOR_CHANNEL=e.toFixed(0),this.needsUpdate=!0}set maskFunction(e){this.defines.MASK_FUNCTION=e.toFixed(0),this.needsUpdate=!0}get inverted(){return void 0!==this.defines.INVERTED}set inverted(e){this.inverted&&!e?delete this.defines.INVERTED:e&&(this.defines.INVERTED="1"),this.needsUpdate=!0}get strength(){return this.uniforms.strength.value}set strength(e){this.uniforms.strength.value=e}},MaskFunction={DISCARD:0,MULTIPLY:1,MULTIPLY_RGB_SET_ALPHA:2},shader_default22="uniform lowp sampler2D inputBuffer;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 c0=texture2D(inputBuffer,vUv0).rg;vec2 c1=texture2D(inputBuffer,vUv1).rg;vec2 c2=texture2D(inputBuffer,vUv2).rg;vec2 c3=texture2D(inputBuffer,vUv3).rg;float d0=(c0.x-c1.x)*0.5;float d1=(c2.x-c3.x)*0.5;float d=length(vec2(d0,d1));float a0=min(c0.y,c1.y);float a1=min(c2.y,c3.y);float visibilityFactor=min(a0,a1);gl_FragColor.rg=(1.0-visibilityFactor>0.001)? vec2(d,0.0): vec2(0.0,d);}",shader_default23="uniform vec2 texelSize;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vUv0=vec2(uv.x+texelSize.x,uv.y);vUv1=vec2(uv.x-texelSize.x,uv.y);vUv2=vec2(uv.x,uv.y+texelSize.y);vUv3=vec2(uv.x,uv.y-texelSize.y);gl_Position=vec4(position.xy,1.0,1.0);}",OutlineMaterial=class extends ShaderMaterial{constructor(e=new Vector2){super({type:"OutlineMaterial",uniforms:{inputBuffer:new Uniform(null),texelSize:new Uniform(new Vector2)},fragmentShader:shader_default22,vertexShader:shader_default23,blending:NoBlending,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.setTexelSize(e.x,e.y),this.uniforms.maskTexture=this.uniforms.inputBuffer}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t)}},shader_default24="#define sampleLevelZeroOffset(t, coord, offset) texture2D(t, coord + offset * texelSize)\n#if __VERSION__ < 300\n#define round(v) floor(v + 0.5)\n#endif\n#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\nuniform lowp sampler2D areaTexture;uniform lowp sampler2D searchTexture;uniform vec2 texelSize;uniform vec2 resolution;varying vec2 vUv;varying vec4 vOffset[3];varying vec2 vPixCoord;void movec(const in bvec2 c,inout vec2 variable,const in vec2 value){if(c.x){variable.x=value.x;}if(c.y){variable.y=value.y;}}void movec(const in bvec4 c,inout vec4 variable,const in vec4 value){movec(c.xy,variable.xy,value.xy);movec(c.zw,variable.zw,value.zw);}vec2 decodeDiagBilinearAccess(in vec2 e){e.r=e.r*abs(5.0*e.r-5.0*0.75);return round(e);}vec4 decodeDiagBilinearAccess(in vec4 e){e.rb=e.rb*abs(5.0*e.rb-5.0*0.75);return round(e);}vec2 searchDiag1(const in vec2 texCoord,const in vec2 dir,out vec2 e){vec4 coord=vec4(texCoord,-1.0,1.0);vec3 t=vec3(texelSize,1.0);for(int i=0;i<MAX_SEARCH_STEPS_INT;++i){if(!(coord.z<float(MAX_SEARCH_STEPS_DIAG_INT-1)&&coord.w>0.9)){break;}coord.xyz=t*vec3(dir,1.0)+coord.xyz;e=texture2D(inputBuffer,coord.xy).rg;coord.w=dot(e,vec2(0.5));}return coord.zw;}vec2 searchDiag2(const in vec2 texCoord,const in vec2 dir,out vec2 e){vec4 coord=vec4(texCoord,-1.0,1.0);coord.x+=0.25*texelSize.x;vec3 t=vec3(texelSize,1.0);for(int i=0;i<MAX_SEARCH_STEPS_INT;++i){if(!(coord.z<float(MAX_SEARCH_STEPS_DIAG_INT-1)&&coord.w>0.9)){break;}coord.xyz=t*vec3(dir,1.0)+coord.xyz;e=texture2D(inputBuffer,coord.xy).rg;e=decodeDiagBilinearAccess(e);coord.w=dot(e,vec2(0.5));}return coord.zw;}vec2 areaDiag(const in vec2 dist,const in vec2 e,const in float offset){vec2 texCoord=vec2(AREATEX_MAX_DISTANCE_DIAG,AREATEX_MAX_DISTANCE_DIAG)*e+dist;texCoord=AREATEX_PIXEL_SIZE*texCoord+0.5*AREATEX_PIXEL_SIZE;texCoord.x+=0.5;texCoord.y+=AREATEX_SUBTEX_SIZE*offset;return texture2D(areaTexture,texCoord).rg;}vec2 calculateDiagWeights(const in vec2 texCoord,const in vec2 e,const in vec4 subsampleIndices){vec2 weights=vec2(0.0);vec4 d;vec2 end;if(e.r>0.0){d.xz=searchDiag1(texCoord,vec2(-1.0,1.0),end);d.x+=float(end.y>0.9);}else{d.xz=vec2(0.0);}d.yw=searchDiag1(texCoord,vec2(1.0,-1.0),end);if(d.x+d.y>2.0){vec4 coords=vec4(-d.x+0.25,d.x,d.y,-d.y-0.25)*texelSize.xyxy+texCoord.xyxy;vec4 c;c.xy=sampleLevelZeroOffset(inputBuffer,coords.xy,vec2(-1,0)).rg;c.zw=sampleLevelZeroOffset(inputBuffer,coords.zw,vec2(1,0)).rg;c.yxwz=decodeDiagBilinearAccess(c.xyzw);vec2 cc=vec2(2.0)*c.xz+c.yw;movec(bvec2(step(0.9,d.zw)),cc,vec2(0.0));weights+=areaDiag(d.xy,cc,subsampleIndices.z);}d.xz=searchDiag2(texCoord,vec2(-1.0,-1.0),end);if(sampleLevelZeroOffset(inputBuffer,texCoord,vec2(1,0)).r>0.0){d.yw=searchDiag2(texCoord,vec2(1.0),end);d.y+=float(end.y>0.9);}else{d.yw=vec2(0.0);}if(d.x+d.y>2.0){vec4 coords=vec4(-d.x,-d.x,d.y,d.y)*texelSize.xyxy+texCoord.xyxy;vec4 c;c.x=sampleLevelZeroOffset(inputBuffer,coords.xy,vec2(-1,0)).g;c.y=sampleLevelZeroOffset(inputBuffer,coords.xy,vec2(0,-1)).r;c.zw=sampleLevelZeroOffset(inputBuffer,coords.zw,vec2(1,0)).gr;vec2 cc=vec2(2.0)*c.xz+c.yw;movec(bvec2(step(0.9,d.zw)),cc,vec2(0.0));weights+=areaDiag(d.xy,cc,subsampleIndices.w).gr;}return weights;}float searchLength(const in vec2 e,const in float offset){vec2 scale=SEARCHTEX_SIZE*vec2(0.5,-1.0);vec2 bias=SEARCHTEX_SIZE*vec2(offset,1.0);scale+=vec2(-1.0,1.0);bias+=vec2(0.5,-0.5);scale*=1.0/SEARCHTEX_PACKED_SIZE;bias*=1.0/SEARCHTEX_PACKED_SIZE;return texture2D(searchTexture,scale*e+bias).r;}float searchXLeft(in vec2 texCoord,const in float end){vec2 e=vec2(0.0,1.0);for(int i=0;i<MAX_SEARCH_STEPS_INT;++i){if(!(texCoord.x>end&&e.g>0.8281&&e.r==0.0)){break;}e=texture2D(inputBuffer,texCoord).rg;texCoord=vec2(-2.0,0.0)*texelSize+texCoord;}float offset=-(255.0/127.0)*searchLength(e,0.0)+3.25;return texelSize.x*offset+texCoord.x;}float searchXRight(vec2 texCoord,const in float end){vec2 e=vec2(0.0,1.0);for(int i=0;i<MAX_SEARCH_STEPS_INT;++i){if(!(texCoord.x<end&&e.g>0.8281&&e.r==0.0)){break;}e=texture2D(inputBuffer,texCoord).rg;texCoord=vec2(2.0,0.0)*texelSize.xy+texCoord;}float offset=-(255.0/127.0)*searchLength(e,0.5)+3.25;return-texelSize.x*offset+texCoord.x;}float searchYUp(vec2 texCoord,const in float end){vec2 e=vec2(1.0,0.0);for(int i=0;i<MAX_SEARCH_STEPS_INT;++i){if(!(texCoord.y>end&&e.r>0.8281&&e.g==0.0)){break;}e=texture2D(inputBuffer,texCoord).rg;texCoord=-vec2(0.0,2.0)*texelSize.xy+texCoord;}float offset=-(255.0/127.0)*searchLength(e.gr,0.0)+3.25;return texelSize.y*offset+texCoord.y;}float searchYDown(vec2 texCoord,const in float end){vec2 e=vec2(1.0,0.0);for(int i=0;i<MAX_SEARCH_STEPS_INT;i++){if(!(texCoord.y<end&&e.r>0.8281&&e.g==0.0)){break;}e=texture2D(inputBuffer,texCoord).rg;texCoord=vec2(0.0,2.0)*texelSize.xy+texCoord;}float offset=-(255.0/127.0)*searchLength(e.gr,0.5)+3.25;return-texelSize.y*offset+texCoord.y;}vec2 area(const in vec2 dist,const in float e1,const in float e2,const in float offset){vec2 texCoord=vec2(AREATEX_MAX_DISTANCE)*round(4.0*vec2(e1,e2))+dist;texCoord=AREATEX_PIXEL_SIZE*texCoord+0.5*AREATEX_PIXEL_SIZE;texCoord.y=AREATEX_SUBTEX_SIZE*offset+texCoord.y;return texture2D(areaTexture,texCoord).rg;}void detectHorizontalCornerPattern(inout vec2 weights,const in vec4 texCoord,const in vec2 d){\n#if !defined(DISABLE_CORNER_DETECTION)\nvec2 leftRight=step(d.xy,d.yx);vec2 rounding=(1.0-CORNER_ROUNDING_NORM)*leftRight;rounding/=leftRight.x+leftRight.y;vec2 factor=vec2(1.0);factor.x-=rounding.x*sampleLevelZeroOffset(inputBuffer,texCoord.xy,vec2(0,1)).r;factor.x-=rounding.y*sampleLevelZeroOffset(inputBuffer,texCoord.zw,vec2(1,1)).r;factor.y-=rounding.x*sampleLevelZeroOffset(inputBuffer,texCoord.xy,vec2(0,-2)).r;factor.y-=rounding.y*sampleLevelZeroOffset(inputBuffer,texCoord.zw,vec2(1,-2)).r;weights*=clamp(factor,0.0,1.0);\n#endif\n}void detectVerticalCornerPattern(inout vec2 weights,const in vec4 texCoord,const in vec2 d){\n#if !defined(DISABLE_CORNER_DETECTION)\nvec2 leftRight=step(d.xy,d.yx);vec2 rounding=(1.0-CORNER_ROUNDING_NORM)*leftRight;rounding/=leftRight.x+leftRight.y;vec2 factor=vec2(1.0);factor.x-=rounding.x*sampleLevelZeroOffset(inputBuffer,texCoord.xy,vec2(1,0)).g;factor.x-=rounding.y*sampleLevelZeroOffset(inputBuffer,texCoord.zw,vec2(1,1)).g;factor.y-=rounding.x*sampleLevelZeroOffset(inputBuffer,texCoord.xy,vec2(-2,0)).g;factor.y-=rounding.y*sampleLevelZeroOffset(inputBuffer,texCoord.zw,vec2(-2,1)).g;weights*=clamp(factor,0.0,1.0);\n#endif\n}void main(){vec4 weights=vec4(0.0);vec4 subsampleIndices=vec4(0.0);vec2 e=texture2D(inputBuffer,vUv).rg;if(e.g>0.0){\n#if !defined(DISABLE_DIAG_DETECTION)\nweights.rg=calculateDiagWeights(vUv,e,subsampleIndices);if(weights.r==-weights.g){\n#endif\nvec2 d;vec3 coords;coords.x=searchXLeft(vOffset[0].xy,vOffset[2].x);coords.y=vOffset[1].y;d.x=coords.x;float e1=texture2D(inputBuffer,coords.xy).r;coords.z=searchXRight(vOffset[0].zw,vOffset[2].y);d.y=coords.z;d=round(resolution.xx*d+-vPixCoord.xx);vec2 sqrtD=sqrt(abs(d));float e2=sampleLevelZeroOffset(inputBuffer,coords.zy,vec2(1,0)).r;weights.rg=area(sqrtD,e1,e2,subsampleIndices.y);coords.y=vUv.y;detectHorizontalCornerPattern(weights.rg,coords.xyzy,d);\n#if !defined(DISABLE_DIAG_DETECTION)\n}else{e.r=0.0;}\n#endif\n}if(e.r>0.0){vec2 d;vec3 coords;coords.y=searchYUp(vOffset[1].xy,vOffset[2].z);coords.x=vOffset[0].x;d.x=coords.y;float e1=texture2D(inputBuffer,coords.xy).g;coords.z=searchYDown(vOffset[1].zw,vOffset[2].w);d.y=coords.z;d=round(resolution.yy*d-vPixCoord.yy);vec2 sqrtD=sqrt(abs(d));float e2=sampleLevelZeroOffset(inputBuffer,coords.xz,vec2(0,1)).g;weights.ba=area(sqrtD,e1,e2,subsampleIndices.x);coords.x=vUv.x;detectVerticalCornerPattern(weights.ba,coords.xyxz,d);}gl_FragColor=weights;}",shader_default25="uniform vec2 texelSize;uniform vec2 resolution;varying vec2 vUv;varying vec4 vOffset[3];varying vec2 vPixCoord;void main(){vUv=position.xy*0.5+0.5;vPixCoord=vUv*resolution;vOffset[0]=vUv.xyxy+texelSize.xyxy*vec4(-0.25,-0.125,1.25,-0.125);vOffset[1]=vUv.xyxy+texelSize.xyxy*vec4(-0.125,-0.25,-0.125,1.25);vOffset[2]=vec4(vOffset[0].xz,vOffset[1].yw)+vec4(-2.0,2.0,-2.0,2.0)*texelSize.xxyy*MAX_SEARCH_STEPS_FLOAT;gl_Position=vec4(position.xy,1.0,1.0);}",SMAAWeightsMaterial=class extends ShaderMaterial{constructor(e=new Vector2,t=new Vector2){super({type:"SMAAWeightsMaterial",defines:{MAX_SEARCH_STEPS_INT:"16",MAX_SEARCH_STEPS_FLOAT:"16.0",MAX_SEARCH_STEPS_DIAG_INT:"8",MAX_SEARCH_STEPS_DIAG_FLOAT:"8.0",CORNER_ROUNDING:"25",CORNER_ROUNDING_NORM:"0.25",AREATEX_MAX_DISTANCE:"16.0",AREATEX_MAX_DISTANCE_DIAG:"20.0",AREATEX_PIXEL_SIZE:"(1.0 / vec2(160.0, 560.0))",AREATEX_SUBTEX_SIZE:"(1.0 / 7.0)",SEARCHTEX_SIZE:"vec2(66.0, 33.0)",SEARCHTEX_PACKED_SIZE:"vec2(64.0, 16.0)"},uniforms:{inputBuffer:new Uniform(null),areaTexture:new Uniform(null),searchTexture:new Uniform(null),texelSize:new Uniform(e),resolution:new Uniform(t)},fragmentShader:shader_default24,vertexShader:shader_default25,blending:NoBlending,depthWrite:!1,depthTest:!1}),this.toneMapped=!1}setOrthogonalSearchSteps(e){const t=Math.min(Math.max(e,0),112);this.defines.MAX_SEARCH_STEPS_INT=t.toFixed("0"),this.defines.MAX_SEARCH_STEPS_FLOAT=t.toFixed("1"),this.needsUpdate=!0}setDiagonalSearchSteps(e){const t=Math.min(Math.max(e,0),20);this.defines.MAX_SEARCH_STEPS_DIAG_INT=t.toFixed("0"),this.defines.MAX_SEARCH_STEPS_DIAG_FLOAT=t.toFixed("1"),this.needsUpdate=!0}setCornerRounding(e){const t=Math.min(Math.max(e,0),100);this.defines.CORNER_ROUNDING=t.toFixed("4"),this.defines.CORNER_ROUNDING_NORM=(t/100).toFixed("4"),this.needsUpdate=!0}get diagonalDetection(){return void 0===this.defines.DISABLE_DIAG_DETECTION}set diagonalDetection(e){e?delete this.defines.DISABLE_DIAG_DETECTION:this.defines.DISABLE_DIAG_DETECTION="1",this.needsUpdate=!0}get cornerRounding(){return void 0===this.defines.DISABLE_CORNER_DETECTION}set cornerRounding(e){e?delete this.defines.DISABLE_CORNER_DETECTION:this.defines.DISABLE_CORNER_DETECTION="1",this.needsUpdate=!0}},shader_default26="#include <common>\n#include <packing>\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D normalDepthBuffer;\n#else\nuniform mediump sampler2D normalDepthBuffer;\n#endif\n#ifndef NORMAL_DEPTH\nuniform lowp sampler2D normalBuffer;float readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(normalDepthBuffer,uv));\n#else\nreturn texture2D(normalDepthBuffer,uv).r;\n#endif\n}\n#endif\nuniform lowp sampler2D noiseTexture;uniform mat4 inverseProjectionMatrix;uniform mat4 projectionMatrix;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float minRadiusScale;uniform float intensity;uniform float fade;uniform float bias;uniform vec2 distanceCutoff;uniform vec2 proximityCutoff;varying vec2 vUv;varying vec2 vUv2;float getViewZ(const in float depth){\n#ifdef PERSPECTIVE_CAMERA\nreturn perspectiveDepthToViewZ(depth,cameraNear,cameraFar);\n#else\nreturn orthographicDepthToViewZ(depth,cameraNear,cameraFar);\n#endif\n}vec3 getViewPosition(const in vec2 screenPosition,const in float depth,const in float viewZ){vec4 clipPosition=vec4(vec3(screenPosition,depth)*2.0-1.0,1.0);float clipW=projectionMatrix[2][3]*viewZ+projectionMatrix[3][3];clipPosition*=clipW;return(inverseProjectionMatrix*clipPosition).xyz;}float getAmbientOcclusion(const in vec3 p,const in vec3 n,const in float depth,const in vec2 uv){\n#ifdef DISTANCE_SCALING\nfloat radiusScale=1.0-smoothstep(0.0,distanceCutoff.y,depth);radiusScale=radiusScale*(1.0-minRadiusScale)+minRadiusScale;float radius=RADIUS*radiusScale;\n#else\nfloat radius=RADIUS;\n#endif\nfloat noise=texture2D(noiseTexture,vUv2).r;float baseAngle=noise*PI2;float invSamples=1.0/SAMPLES_FLOAT;float rings=SPIRAL_TURNS*PI2;float occlusion=0.0;int taps=0;for(int i=0;i<SAMPLES_INT;++i){float alpha=(float(i)+0.5)*invSamples;float angle=alpha*rings+baseAngle;vec2 coord=alpha*radius*vec2(cos(angle),sin(angle))*texelSize+uv;if(coord.s<0.0||coord.s>1.0||coord.t<0.0||coord.t>1.0){continue;}\n#ifdef NORMAL_DEPTH\nfloat sampleDepth=texture2D(normalDepthBuffer,coord).a;\n#else\nfloat sampleDepth=readDepth(coord);\n#endif\nfloat viewZ=getViewZ(sampleDepth);\n#ifdef PERSPECTIVE_CAMERA\nfloat linearSampleDepth=viewZToOrthographicDepth(viewZ,cameraNear,cameraFar);\n#else\nfloat linearSampleDepth=sampleDepth;\n#endif\nfloat proximity=abs(depth-linearSampleDepth);if(proximity<proximityCutoff.y){float falloff=1.0-smoothstep(proximityCutoff.x,proximityCutoff.y,proximity);vec3 Q=getViewPosition(coord,sampleDepth,viewZ);vec3 v=Q-p;float vv=dot(v,v);float vn=dot(v,n)-bias;float f=max(RADIUS_SQ-vv,0.0)/RADIUS_SQ;occlusion+=(f*f*f*max(vn/(fade+vv),0.0))*falloff;}++taps;}return occlusion/(4.0*max(float(taps),1.0));}void main(){\n#ifdef NORMAL_DEPTH\nvec4 normalDepth=texture2D(normalDepthBuffer,vUv);\n#else\nvec4 normalDepth=vec4(texture2D(normalBuffer,vUv).rgb,readDepth(vUv));\n#endif\nfloat ao=1.0;float depth=normalDepth.a;float viewZ=getViewZ(depth);\n#ifdef PERSPECTIVE_CAMERA\nfloat linearDepth=viewZToOrthographicDepth(viewZ,cameraNear,cameraFar);\n#else\nfloat linearDepth=depth;\n#endif\nif(linearDepth<distanceCutoff.y){vec3 viewPosition=getViewPosition(vUv,depth,viewZ);vec3 viewNormal=unpackRGBToNormal(normalDepth.rgb);ao-=getAmbientOcclusion(viewPosition,viewNormal,linearDepth,vUv);float d=smoothstep(distanceCutoff.x,distanceCutoff.y,linearDepth);ao=mix(ao,1.0,d);ao=clamp(pow(ao,abs(intensity)),0.0,1.0);}gl_FragColor.r=ao;}",shader_default27="uniform vec2 noiseScale;varying vec2 vUv;varying vec2 vUv2;void main(){vUv=position.xy*0.5+0.5;vUv2=vUv*noiseScale;gl_Position=vec4(position.xy,1.0,1.0);}",SSAOMaterial=class extends ShaderMaterial{constructor(e){super({type:"SSAOMaterial",defines:{SAMPLES_INT:"0",SAMPLES_FLOAT:"0.0",SPIRAL_TURNS:"0.0",RADIUS:"1.0",RADIUS_SQ:"1.0",DISTANCE_SCALING:"1",DEPTH_PACKING:"0"},uniforms:{normalBuffer:new Uniform(null),normalDepthBuffer:new Uniform(null),noiseTexture:new Uniform(null),inverseProjectionMatrix:new Uniform(new Matrix4),projectionMatrix:new Uniform(new Matrix4),texelSize:new Uniform(new Vector2),cameraNear:new Uniform(0),cameraFar:new Uniform(0),distanceCutoff:new Uniform(new Vector2),proximityCutoff:new Uniform(new Vector2),noiseScale:new Uniform(new Vector2),minRadiusScale:new Uniform(.33),intensity:new Uniform(1),fade:new Uniform(.01),bias:new Uniform(0)},fragmentShader:shader_default26,vertexShader:shader_default27,blending:NoBlending,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.adoptCameraSettings(e)}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t)}adoptCameraSettings(e=null){if(null!==e){const t=this.uniforms;t.cameraNear.value=e.near,t.cameraFar.value=e.far,e instanceof PerspectiveCamera?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0}}},dummyCamera=new Camera$1$1,geometry=null;
/**
   * postprocessing v6.23.2 build Thu Oct 28 2021
   * https://github.com/vanruesc/postprocessing
   * Copyright 2021 Raoul van Rüschen
   * @license Zlib
   */function getFullscreenTriangle(){if(null===geometry){const e=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),t=new Float32Array([0,0,2,0,0,2]);void 0!==(geometry=new BufferGeometry).setAttribute?(geometry.setAttribute("position",new BufferAttribute(e,3)),geometry.setAttribute("uv",new BufferAttribute(t,2))):(geometry.addAttribute("position",new BufferAttribute(e,3)),geometry.addAttribute("uv",new BufferAttribute(t,2)))}return geometry}var Pass=class{constructor(e="Pass",t=new Scene,r=dummyCamera){this.name=e,this.scene=t,this.camera=r,this.screen=null,this.rtt=!0,this.needsSwap=!0,this.needsDepthTexture=!1,this.enabled=!0}get renderToScreen(){return!this.rtt}set renderToScreen(e){if(this.rtt===e){const t=this.getFullscreenMaterial();null!==t&&(t.needsUpdate=!0),this.rtt=!e}}isEnabled(){return this.enabled}setEnabled(e){this.enabled=e}getFullscreenMaterial(){return null!==this.screen?this.screen.material:null}setFullscreenMaterial(e){let t=this.screen;null!==t?t.material=e:(t=new Mesh(getFullscreenTriangle(),e),t.frustumCulled=!1,null===this.scene&&(this.scene=new Scene),this.scene.add(t),this.screen=t)}getDepthTexture(){return null}setDepthTexture(e,t=0){}render(e,t,r,n,i){throw new Error("Render method not implemented!")}setSize(e,t){}initialize(e,t,r){}dispose(){const e=this.getFullscreenMaterial();null!==e&&e.dispose();for(const e of Object.keys(this)){const t=this[e];if(null!==t&&"function"==typeof t.dispose){if(t instanceof Scene)continue;this[e].dispose()}}}},AUTO_SIZE=-1,Resizer=class{constructor(e,t=AUTO_SIZE,r=AUTO_SIZE,n=1){this.resizable=e,this.base=new Vector2(1,1),this.target=new Vector2(t,r),this.s=n}get scale(){return this.s}set scale(e){this.s=e,this.target.x=AUTO_SIZE,this.target.y=AUTO_SIZE,this.resizable.setSize(this.base.x,this.base.y)}get width(){const e=this.base,t=this.target;let r;return r=t.x!==AUTO_SIZE?t.x:t.y!==AUTO_SIZE?Math.round(t.y*(e.x/e.y)):Math.round(e.x*this.s),r}set width(e){this.target.x=e,this.resizable.setSize(this.base.x,this.base.y)}get height(){const e=this.base,t=this.target;let r;return r=t.y!==AUTO_SIZE?t.y:t.x!==AUTO_SIZE?Math.round(t.x/(e.x/e.y)):Math.round(e.y*this.s),r}set height(e){this.target.y=e,this.resizable.setSize(this.base.x,this.base.y)}static get AUTO_SIZE(){return AUTO_SIZE}},BlurPass=class extends Pass{constructor({resolutionScale:e=.5,width:t=Resizer.AUTO_SIZE,height:r=Resizer.AUTO_SIZE,kernelSize:n=KernelSize$1.LARGE}={}){super("BlurPass"),this.renderTargetA=new WebGLRenderTarget(1,1,{minFilter:LinearFilter,magFilter:LinearFilter,stencilBuffer:!1,depthBuffer:!1}),this.renderTargetA.texture.name="Blur.Target.A",this.renderTargetB=this.renderTargetA.clone(),this.renderTargetB.texture.name="Blur.Target.B",this.resolution=new Resizer(this,t,r,e),this.convolutionMaterial=new ConvolutionMaterial,this.ditheredConvolutionMaterial=new ConvolutionMaterial,this.ditheredConvolutionMaterial.dithering=!0,this.dithering=!1,this.kernelSize=n}get width(){return this.resolution.width}set width(e){this.resolution.width=e}get height(){return this.resolution.height}set height(e){this.resolution.height=e}get scale(){return this.convolutionMaterial.uniforms.scale.value}set scale(e){this.convolutionMaterial.uniforms.scale.value=e,this.ditheredConvolutionMaterial.uniforms.scale.value=e}get kernelSize(){return this.convolutionMaterial.kernelSize}set kernelSize(e){this.convolutionMaterial.kernelSize=e,this.ditheredConvolutionMaterial.kernelSize=e}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}render(e,t,r,n,i){const a=this.scene,o=this.camera,s=this.renderTargetA,l=this.renderTargetB;let c=this.convolutionMaterial,h=c.uniforms;const u=c.getKernel();let d,p,f,m=t;for(this.setFullscreenMaterial(c),p=0,f=u.length-1;p<f;++p)d=0==(1&p)?s:l,h.kernel.value=u[p],h.inputBuffer.value=m.texture,e.setRenderTarget(d),e.render(a,o),m=d;this.dithering&&(c=this.ditheredConvolutionMaterial,h=c.uniforms,this.setFullscreenMaterial(c)),h.kernel.value=u[p],h.inputBuffer.value=m.texture,e.setRenderTarget(this.renderToScreen?null:r),e.render(a,o)}setSize(e,t){const r=this.resolution;r.base.set(e,t);const n=r.width,i=r.height;this.renderTargetA.setSize(n,i),this.renderTargetB.setSize(n,i),this.convolutionMaterial.setTexelSize(1/n,1/i),this.ditheredConvolutionMaterial.setTexelSize(1/n,1/i)}initialize(e,t,r){if(t||r!==UnsignedByteType||(this.renderTargetA.texture.format=RGBFormat,this.renderTargetB.texture.format=RGBFormat),void 0!==r&&(this.renderTargetA.texture.type=r,this.renderTargetB.texture.type=r,r!==UnsignedByteType)){const e=this.convolutionMaterial,t=this.ditheredConvolutionMaterial;e.defines.FRAMEBUFFER_PRECISION_HIGH="1",t.defines.FRAMEBUFFER_PRECISION_HIGH="1"}}static get AUTO_SIZE(){return Resizer.AUTO_SIZE}},ClearMaskPass=class extends Pass{constructor(){super("ClearMaskPass",null,null),this.needsSwap=!1}render(e,t,r,n,i){const a=e.state.buffers.stencil;a.setLocked(!1),a.setTest(!1)}},color=new Color,ClearPass=class extends Pass{constructor(e=!0,t=!0,r=!1){super("ClearPass",null,null),this.needsSwap=!1,this.color=e,this.depth=t,this.stencil=r,this.overrideClearColor=null,this.overrideClearAlpha=-1}render(e,t,r,n,i){const a=this.overrideClearColor,o=this.overrideClearAlpha,s=e.getClearAlpha(),l=null!==a,c=o>=0;l?(color.copy(e.getClearColor(color)),e.setClearColor(a,c?o:s)):c&&e.setClearAlpha(o),e.setRenderTarget(this.renderToScreen?null:t),e.clear(this.color,this.depth,this.stencil),l?e.setClearColor(color,s):c&&e.setClearAlpha(s)}},workaroundEnabled=!1,OverrideMaterialManager=class{constructor(e=null){this.originalMaterials=new Map,this.material=null,this.materials=null,this.materialsBackSide=null,this.materialsDoubleSide=null,this.materialsFlatShaded=null,this.materialsFlatShadedBackSide=null,this.materialsFlatShadedDoubleSide=null,this.setMaterial(e),this.meshCount=0,this.replaceMaterial=e=>{if(e.isMesh){let t;if(e.material.flatShading)switch(e.material.side){case DoubleSide:t=this.materialsFlatShadedDoubleSide;break;case BackSide:t=this.materialsFlatShadedBackSide;break;default:t=this.materialsFlatShaded}else switch(e.material.side){case DoubleSide:t=this.materialsDoubleSide;break;case BackSide:t=this.materialsBackSide;break;default:t=this.materials}this.originalMaterials.set(e,e.material),e.isSkinnedMesh?e.material=t[2]:e.isInstancedMesh?e.material=t[1]:e.material=t[0],++this.meshCount}}}setMaterial(e){if(this.disposeMaterials(),this.material=e,null!==e){const t=this.materials=[e.clone(),e.clone(),e.clone()];for(const r of t)r.uniforms=Object.assign({},e.uniforms),r.side=FrontSide;t[2].skinning=!0,this.materialsBackSide=t.map((t=>{const r=t.clone();return r.uniforms=Object.assign({},e.uniforms),r.side=BackSide,r})),this.materialsDoubleSide=t.map((t=>{const r=t.clone();return r.uniforms=Object.assign({},e.uniforms),r.side=DoubleSide,r})),this.materialsFlatShaded=t.map((t=>{const r=t.clone();return r.uniforms=Object.assign({},e.uniforms),r.flatShading=!0,r})),this.materialsFlatShadedBackSide=t.map((t=>{const r=t.clone();return r.uniforms=Object.assign({},e.uniforms),r.flatShading=!0,r.side=BackSide,r})),this.materialsFlatShadedDoubleSide=t.map((t=>{const r=t.clone();return r.uniforms=Object.assign({},e.uniforms),r.flatShading=!0,r.side=DoubleSide,r}))}}render(e,t,r){const n=e.shadowMap.enabled;if(e.shadowMap.enabled=!1,workaroundEnabled){const n=this.originalMaterials;this.meshCount=0,t.traverse(this.replaceMaterial),e.render(t,r);for(const e of n)e[0].material=e[1];this.meshCount!==n.size&&n.clear()}else{const n=t.overrideMaterial;t.overrideMaterial=this.material,e.render(t,r),t.overrideMaterial=n}e.shadowMap.enabled=n}disposeMaterials(){if(null!==this.material){const e=this.materials.concat(this.materialsBackSide).concat(this.materialsDoubleSide).concat(this.materialsFlatShaded).concat(this.materialsFlatShadedBackSide).concat(this.materialsFlatShadedDoubleSide);for(const t of e)t.dispose()}}dispose(){this.originalMaterials.clear(),this.disposeMaterials()}static get workaroundEnabled(){return workaroundEnabled}static set workaroundEnabled(e){workaroundEnabled=e}},RenderPass=class extends Pass{constructor(e,t,r=null){super("RenderPass",e,t),this.needsSwap=!1,this.clearPass=new ClearPass,this.overrideMaterialManager=null===r?null:new OverrideMaterialManager(r),this.backgroundDisabled=!1,this.shadowMapDisabled=!1,this.selection=null}get renderToScreen(){return super.renderToScreen}set renderToScreen(e){super.renderToScreen=e,this.clearPass.renderToScreen=e}get overrideMaterial(){const e=this.overrideMaterialManager;return null!==e?e.material:null}set overrideMaterial(e){const t=this.overrideMaterialManager;null!==e?null!==t?t.setMaterial(e):this.overrideMaterialManager=new OverrideMaterialManager(e):null!==t&&(t.dispose(),this.overrideMaterialManager=null)}get clear(){return this.clearPass.enabled}set clear(e){this.clearPass.enabled=e}getSelection(){return this.selection}setSelection(e){this.selection=e}isBackgroundDisabled(){return this.backgroundDisabled}setBackgroundDisabled(e){this.backgroundDisabled=e}isShadowMapDisabled(){return this.shadowMapDisabled}setShadowMapDisabled(e){this.shadowMapDisabled=e}getClearPass(){return this.clearPass}render(e,t,r,n,i){const a=this.scene,o=this.camera,s=this.selection,l=o.layers.mask,c=a.background,h=e.shadowMap.autoUpdate,u=this.renderToScreen?null:t;null!==s&&o.layers.set(s.getLayer()),this.shadowMapDisabled&&(e.shadowMap.autoUpdate=!1),(this.backgroundDisabled||null!==this.clearPass.overrideClearColor)&&(a.background=null),this.clear&&this.clearPass.render(e,t),e.setRenderTarget(u),null!==this.overrideMaterialManager?this.overrideMaterialManager.render(e,a,o):e.render(a,o),o.layers.mask=l,a.background=c,e.shadowMap.autoUpdate=h}},DepthPass=class extends Pass{constructor(e,t,{resolutionScale:r=1,width:n=Resizer.AUTO_SIZE,height:i=Resizer.AUTO_SIZE,renderTarget:a}={}){super("DepthPass"),this.needsSwap=!1,this.renderPass=new RenderPass(e,t,new MeshDepthMaterial({depthPacking:RGBADepthPacking}));const o=this.renderPass;o.setBackgroundDisabled(!0),o.setShadowMapDisabled(!0);const s=o.getClearPass();s.overrideClearColor=new Color(16777215),s.overrideClearAlpha=1,this.renderTarget=a,void 0===this.renderTarget&&(this.renderTarget=new WebGLRenderTarget(1,1,{minFilter:NearestFilter,magFilter:NearestFilter,stencilBuffer:!1}),this.renderTarget.texture.name="DepthPass.Target"),this.resolution=new Resizer(this,n,i,r)}get texture(){return this.renderTarget.texture}getResolutionScale(){return this.resolutionScale}setResolutionScale(e){this.resolutionScale=e,this.setSize(this.resolution.base.x,this.resolution.base.y)}render(e,t,r,n,i){const a=this.renderToScreen?null:this.renderTarget;this.renderPass.render(e,a)}setSize(e,t){const r=this.resolution;r.base.set(e,t),this.renderTarget.setSize(r.width,r.height)}},DepthDownsamplingPass=class extends Pass{constructor({normalBuffer:e=null,resolutionScale:t=.5,width:r=Resizer.AUTO_SIZE,height:n=Resizer.AUTO_SIZE}={}){if(super("DepthDownsamplingPass"),this.setFullscreenMaterial(new DepthDownsamplingMaterial),this.needsDepthTexture=!0,this.needsSwap=!1,null!==e){const t=this.getFullscreenMaterial();t.uniforms.normalBuffer.value=e,t.defines.DOWNSAMPLE_NORMALS="1"}this.renderTarget=new WebGLRenderTarget(1,1,{minFilter:NearestFilter,magFilter:NearestFilter,stencilBuffer:!1,depthBuffer:!1,type:FloatType}),this.renderTarget.texture.name="DepthDownsamplingPass.Target",this.renderTarget.texture.generateMipmaps=!1,this.resolution=new Resizer(this,r,n),this.resolution.scale=t}get texture(){return this.renderTarget.texture}setDepthTexture(e,t=BasicDepthPacking){const r=this.getFullscreenMaterial();r.uniforms.depthBuffer.value=e,r.depthPacking=t}render(e,t,r,n,i){e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){const r=this.resolution;r.base.set(e,t),this.getFullscreenMaterial().setTexelSize(1/e,1/t),this.renderTarget.setSize(r.width,r.height)}initialize(e,t,r){e.capabilities.isWebGL2||console.error("The DepthDownsamplingPass requires WebGL 2")}},BlendFunction={SKIP:0,ADD:1,ALPHA:2,AVERAGE:3,COLOR_BURN:4,COLOR_DODGE:5,DARKEN:6,DIFFERENCE:7,EXCLUSION:8,LIGHTEN:9,MULTIPLY:10,DIVIDE:11,NEGATION:12,NORMAL:13,OVERLAY:14,REFLECT:15,SCREEN:16,SOFT_LIGHT:17,SUBTRACT:18},shader_default28="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return min(x+y,1.0)*opacity+x*(1.0-opacity);}",shader_default29="vec3 blend(const in vec3 x,const in vec3 y,const in float opacity){return y*opacity+x*(1.0-opacity);}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){float a=min(y.a,opacity);return vec4(blend(x.rgb,y.rgb,a),max(x.a,a));}",shader_default30="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return(x+y)*0.5*opacity+x*(1.0-opacity);}",shader_default31="float blend(const in float x,const in float y){return(y==0.0)? y : max(1.0-(1.0-x)/y,0.0);}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}",shader_default32="float blend(const in float x,const in float y){return(y==1.0)? y : min(x/(1.0-y),1.0);}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}",shader_default33="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return min(x,y)*opacity+x*(1.0-opacity);}",shader_default34="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return abs(x-y)*opacity+x*(1.0-opacity);}",shader_default35="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return(x+y-2.0*x*y)*opacity+x*(1.0-opacity);}",shader_default36="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return max(x,y)*opacity+x*(1.0-opacity);}",shader_default37="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return x*y*opacity+x*(1.0-opacity);}",shader_default38="float blend(const in float x,const in float y){return(y>0.0)? min(x/y,1.0): 1.0;}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}",shader_default39="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return(1.0-abs(1.0-x-y))*opacity+x*(1.0-opacity);}",shader_default40="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return y*opacity+x*(1.0-opacity);}",shader_default41="float blend(const in float x,const in float y){return(x<0.5)?(2.0*x*y):(1.0-2.0*(1.0-x)*(1.0-y));}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}",shader_default42="float blend(const in float x,const in float y){return(y==1.0)? y : min(x*x/(1.0-y),1.0);}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}",shader_default43="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return(1.0-(1.0-x)*(1.0-y))*opacity+x*(1.0-opacity);}",shader_default44="float blend(const in float x,const in float y){return(y<0.5)?(2.0*x*y+x*x*(1.0-2.0*y)):(sqrt(x)*(2.0*y-1.0)+2.0*x*(1.0-y));}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}",shader_default45="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return max(x+y-1.0,0.0)*opacity+x*(1.0-opacity);}",blendFunctions=new Map([[BlendFunction.SKIP,null],[BlendFunction.ADD,shader_default28],[BlendFunction.ALPHA,shader_default29],[BlendFunction.AVERAGE,shader_default30],[BlendFunction.COLOR_BURN,shader_default31],[BlendFunction.COLOR_DODGE,shader_default32],[BlendFunction.DARKEN,shader_default33],[BlendFunction.DIFFERENCE,shader_default34],[BlendFunction.EXCLUSION,shader_default35],[BlendFunction.LIGHTEN,shader_default36],[BlendFunction.MULTIPLY,shader_default37],[BlendFunction.DIVIDE,shader_default38],[BlendFunction.NEGATION,shader_default39],[BlendFunction.NORMAL,shader_default40],[BlendFunction.OVERLAY,shader_default41],[BlendFunction.REFLECT,shader_default42],[BlendFunction.SCREEN,shader_default43],[BlendFunction.SOFT_LIGHT,shader_default44],[BlendFunction.SUBTRACT,shader_default45]]),BlendMode=class extends EventDispatcher{constructor(e,t=1){super(),this.blendFunction=e,this.opacity=new Uniform(t)}getBlendFunction(){return this.blendFunction}setBlendFunction(e){this.blendFunction=e,this.dispatchEvent({type:"change"})}getShaderCode(){return blendFunctions.get(this.blendFunction)}},Effect$1=class extends EventDispatcher{constructor(e,t,{attributes:r=EffectAttribute.NONE,blendFunction:n=BlendFunction.SCREEN,defines:i=new Map,uniforms:a=new Map,extensions:o=null,vertexShader:s=null}={}){super(),this.name=e,this.attributes=r,this.fragmentShader=t,this.vertexShader=s,this.defines=i,this.uniforms=a,this.extensions=o,this.blendMode=new BlendMode(n),this.blendMode.addEventListener("change",(e=>this.setChanged()))}setChanged(){this.dispatchEvent({type:"change"})}getAttributes(){return this.attributes}setAttributes(e){this.attributes=e,this.setChanged()}getFragmentShader(){return this.fragmentShader}setFragmentShader(e){this.fragmentShader=e,this.setChanged()}getVertexShader(){return this.vertexShader}setVertexShader(e){this.vertexShader=e,this.setChanged()}setDepthTexture(e,t=0){}update(e,t,r){}setSize(e,t){}initialize(e,t,r){}dispose(){for(const e of Object.keys(this)){const t=this[e];if(null!==t&&"function"==typeof t.dispose){if(t instanceof Scene)continue;this[e].dispose()}}}},EffectAttribute={NONE:0,DEPTH:1,CONVOLUTION:2};function findSubstrings(e,t){const r=[];let n;for(;null!==(n=e.exec(t));)r.push(n[1]);return r}function prefixSubstrings(e,t,r){let n,i;for(const a of t){n="$1"+e+a.charAt(0).toUpperCase()+a.slice(1),i=new RegExp("([^\\.])(\\b"+a+"\\b)","g");for(const e of r.entries())null!==e[1]&&r.set(e[0],e[1].replace(i,n))}}function integrateEffect(e,t,r,n,i,a,o){const s=/(?:\w+\s+(\w+)\([\w\s,]*\)\s*{[^}]+})/g,l=/(?:varying\s+\w+\s+(\w*))/g,c=t.blendMode,h=new Map([["fragment",t.getFragmentShader()],["vertex",t.getVertexShader()]]),u=void 0!==h.get("fragment")&&/mainImage/.test(h.get("fragment")),d=void 0!==h.get("fragment")&&/mainUv/.test(h.get("fragment"));let p=[],f=[],m=!1,g=!1;if(void 0===h.get("fragment"))console.error("Missing fragment shader",t);else if(d&&0!=(o&EffectAttribute.CONVOLUTION))console.error("Effects that transform UV coordinates are incompatible with convolution effects",t);else if(u||d){if(d&&(r.set(Section.FRAGMENT_MAIN_UV,r.get(Section.FRAGMENT_MAIN_UV)+"\t"+e+"MainUv(UV);\n"),m=!0),null!==h.get("vertex")&&/mainSupport/.test(h.get("vertex"))){let t="\t"+e+"MainSupport(";/mainSupport *\([\w\s]*?uv\s*?\)/.test(h.get("vertex"))&&(t+="vUv"),t+=");\n",r.set(Section.VERTEX_MAIN_SUPPORT,r.get(Section.VERTEX_MAIN_SUPPORT)+t),p=p.concat(findSubstrings(l,h.get("vertex"))),f=f.concat(p).concat(findSubstrings(s,h.get("vertex")))}if(f=f.concat(findSubstrings(s,h.get("fragment"))),f=f.concat(Array.from(t.defines.keys()).map((e=>e.replace(/\([\w\s,]*\)/g,"")))),f=f.concat(Array.from(t.uniforms.keys())),t.uniforms.forEach(((t,r)=>a.set(e+r.charAt(0).toUpperCase()+r.slice(1),t))),t.defines.forEach(((t,r)=>i.set(e+r.charAt(0).toUpperCase()+r.slice(1),t))),prefixSubstrings(e,f,i),prefixSubstrings(e,f,h),n.set(c.blendFunction,c),u){const t=/MainImage *\([\w\s,]*?depth[\w\s,]*?\)/;let n=e+"MainImage(color0, UV, ";0!=(o&EffectAttribute.DEPTH)&&t.test(h.get("fragment"))&&(n+="depth, ",g=!0),n+="color1);\n\t";const i=e+"BlendOpacity";a.set(i,c.opacity),n+="color0 = blend"+c.getBlendFunction()+"(color0, color1, "+i+");\n\n\t",r.set(Section.FRAGMENT_MAIN_IMAGE,r.get(Section.FRAGMENT_MAIN_IMAGE)+n),r.set(Section.FRAGMENT_HEAD,r.get(Section.FRAGMENT_HEAD)+"uniform float "+i+";\n\n")}r.set(Section.FRAGMENT_HEAD,r.get(Section.FRAGMENT_HEAD)+h.get("fragment")+"\n"),null!==h.get("vertex")&&r.set(Section.VERTEX_HEAD,r.get(Section.VERTEX_HEAD)+h.get("vertex")+"\n")}else console.error("The fragment shader contains neither a mainImage nor a mainUv function",t);return{varyings:p,transformedUv:m,readDepth:g}}var EffectPass=class extends Pass{constructor(e,...t){super("EffectPass"),this.setFullscreenMaterial(new EffectMaterial(null,null,null,e)),this.effects=t.sort(((e,t)=>t.attributes-e.attributes)),this.skipRendering=!1,this.uniforms=0,this.varyings=0,this.minTime=1,this.maxTime=Number.POSITIVE_INFINITY}get encodeOutput(){return void 0!==this.getFullscreenMaterial().defines.ENCODE_OUTPUT}set encodeOutput(e){if(this.encodeOutput!==e){const t=this.getFullscreenMaterial();t.needsUpdate=!0,e?t.defines.ENCODE_OUTPUT="1":delete t.defines.ENCODE_OUTPUT}}get dithering(){return this.getFullscreenMaterial().dithering}set dithering(e){const t=this.getFullscreenMaterial();t.dithering!==e&&(t.dithering=e,t.needsUpdate=!0)}verifyResources(e){const t=e.capabilities;let r=Math.min(t.maxFragmentUniforms,t.maxVertexUniforms);this.uniforms>r&&console.warn("The current rendering context doesn't support more than "+r+" uniforms, but "+this.uniforms+" were defined"),r=t.maxVaryings,this.varyings>r&&console.warn("The current rendering context doesn't support more than "+r+" varyings, but "+this.varyings+" were defined")}updateMaterial(){const e=/\bblend\b/g,t=new Map([[Section.FRAGMENT_HEAD,""],[Section.FRAGMENT_MAIN_UV,""],[Section.FRAGMENT_MAIN_IMAGE,""],[Section.VERTEX_HEAD,""],[Section.VERTEX_MAIN_SUPPORT,""]]),r=new Map,n=new Map,i=new Map,a=new Set;let o,s=0,l=0,c=0,h=!1,u=!1;for(const e of this.effects)if(e.blendMode.getBlendFunction()===BlendFunction.SKIP)c|=e.getAttributes()&EffectAttribute.DEPTH;else if(0!=(c&EffectAttribute.CONVOLUTION)&&0!=(e.getAttributes()&EffectAttribute.CONVOLUTION))console.error("Convolution effects cannot be merged",e);else if(c|=e.getAttributes(),o=integrateEffect("e"+s++,e,t,r,n,i,c),l+=o.varyings.length,h=h||o.transformedUv,u=u||o.readDepth,null!==e.extensions)for(const t of e.extensions)a.add(t);for(const n of r.values())t.set(Section.FRAGMENT_HEAD,t.get(Section.FRAGMENT_HEAD)+n.getShaderCode().replace(e,"blend"+n.getBlendFunction())+"\n");0!=(c&EffectAttribute.DEPTH)?(u&&t.set(Section.FRAGMENT_MAIN_IMAGE,"float depth = readDepth(UV);\n\n\t"+t.get(Section.FRAGMENT_MAIN_IMAGE)),this.needsDepthTexture=null===this.getDepthTexture()):this.needsDepthTexture=!1,h?(t.set(Section.FRAGMENT_MAIN_UV,"vec2 transformedUv = vUv;\n"+t.get(Section.FRAGMENT_MAIN_UV)),n.set("UV","transformedUv")):n.set("UV","vUv"),t.forEach(((e,t,r)=>r.set(t,e.trim().replace(/^#/,"\n#")))),this.uniforms=i.size,this.varyings=l,this.skipRendering=0===s,this.needsSwap=!this.skipRendering;const d=this.getFullscreenMaterial();if(d.setShaderParts(t),d.setDefines(n),d.setUniforms(i),d.extensions={},a.size>0)for(const e of a)d.extensions[e]=!0;this.needsUpdate=!1}recompile(e){this.updateMaterial(),void 0!==e&&this.verifyResources(e)}getDepthTexture(){return this.getFullscreenMaterial().uniforms.depthBuffer.value}setDepthTexture(e,t=BasicDepthPacking){const r=this.getFullscreenMaterial();r.uniforms.depthBuffer.value=e,r.depthPacking=t,r.needsUpdate=!0;for(const r of this.effects)r.setDepthTexture(e,t)}render(e,t,r,n,i){const a=this.getFullscreenMaterial(),o=a.uniforms.time.value+n;this.needsUpdate&&this.recompile(e);for(const r of this.effects)r.update(e,t,n);this.skipRendering&&!this.renderToScreen||(a.uniforms.inputBuffer.value=t.texture,a.uniforms.time.value=o<=this.maxTime?o:this.minTime,e.setRenderTarget(this.renderToScreen?null:r),e.render(this.scene,this.camera))}setSize(e,t){this.getFullscreenMaterial().setSize(e,t);for(const r of this.effects)r.setSize(e,t)}initialize(e,t,r){for(const n of this.effects)n.initialize(e,t,r),n.addEventListener("change",(e=>this.handleEvent(e)));if(this.updateMaterial(),this.verifyResources(e),void 0!==r&&r!==UnsignedByteType){this.getFullscreenMaterial().defines.FRAMEBUFFER_PRECISION_HIGH="1"}}dispose(){super.dispose();for(const e of this.effects)e.dispose()}handleEvent(e){switch(e.type){case"change":this.needsUpdate=!0}}},LuminancePass=class extends Pass{constructor({width:e=Resizer.AUTO_SIZE,height:t=Resizer.AUTO_SIZE,renderTarget:r,luminanceRange:n,colorOutput:i}={}){super("LuminancePass"),this.setFullscreenMaterial(new LuminanceMaterial(i,n)),this.needsSwap=!1,this.renderTarget=r,void 0===this.renderTarget&&(this.renderTarget=new WebGLRenderTarget(1,1,{minFilter:LinearFilter,magFilter:LinearFilter,format:i?RGBAFormat:LuminanceFormat,stencilBuffer:!1,depthBuffer:!1}),this.renderTarget.texture.name="LuminancePass.Target",this.renderTarget.texture.generateMipmaps=!1),this.resolution=new Resizer(this,e,t)}get texture(){return this.renderTarget.texture}render(e,t,r,n,i){this.getFullscreenMaterial().uniforms.inputBuffer.value=t.texture,e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){const r=this.resolution;r.base.set(e,t),this.renderTarget.setSize(r.width,r.height)}initialize(e,t,r){if(void 0!==r&&r!==UnsignedByteType){this.getFullscreenMaterial().defines.FRAMEBUFFER_PRECISION_HIGH="1"}}},MaskPass=class extends Pass{constructor(e,t){super("MaskPass",e,t),this.needsSwap=!1,this.clearPass=new ClearPass(!1,!1,!0),this.inverse=!1}get clear(){return this.clearPass.enabled}set clear(e){this.clearPass.enabled=e}render(e,t,r,n,i){const a=e.getContext(),o=e.state.buffers,s=this.scene,l=this.camera,c=this.clearPass,h=this.inverse?0:1,u=1-h;o.color.setMask(!1),o.depth.setMask(!1),o.color.setLocked(!0),o.depth.setLocked(!0),o.stencil.setTest(!0),o.stencil.setOp(a.REPLACE,a.REPLACE,a.REPLACE),o.stencil.setFunc(a.ALWAYS,h,4294967295),o.stencil.setClear(u),o.stencil.setLocked(!0),this.clear&&(this.renderToScreen?c.render(e,null):(c.render(e,t),c.render(e,r))),this.renderToScreen?(e.setRenderTarget(null),e.render(s,l)):(e.setRenderTarget(t),e.render(s,l),e.setRenderTarget(r),e.render(s,l)),o.color.setLocked(!1),o.depth.setLocked(!1),o.stencil.setLocked(!1),o.stencil.setFunc(a.EQUAL,1,4294967295),o.stencil.setOp(a.KEEP,a.KEEP,a.KEEP),o.stencil.setLocked(!0)}},NormalPass=class extends Pass{constructor(e,t,{resolutionScale:r=1,width:n=Resizer.AUTO_SIZE,height:i=Resizer.AUTO_SIZE,renderTarget:a}={}){super("NormalPass"),this.needsSwap=!1,this.renderPass=new RenderPass(e,t,new MeshNormalMaterial);const o=this.renderPass;o.setBackgroundDisabled(!0),o.setShadowMapDisabled(!0);const s=o.getClearPass();s.overrideClearColor=new Color(7829503),s.overrideClearAlpha=1,this.renderTarget=a,void 0===this.renderTarget&&(this.renderTarget=new WebGLRenderTarget(1,1,{minFilter:NearestFilter,magFilter:NearestFilter,format:RGBFormat,stencilBuffer:!1}),this.renderTarget.texture.name="NormalPass.Target"),this.resolution=new Resizer(this,n,i,r)}get texture(){return this.renderTarget.texture}getResolutionScale(){return this.resolutionScale}setResolutionScale(e){this.resolutionScale=e,this.setSize(this.resolution.base.x,this.resolution.base.y)}render(e,t,r,n,i){const a=this.renderToScreen?null:this.renderTarget;this.renderPass.render(e,a,a)}setSize(e,t){const r=this.resolution;r.base.set(e,t),this.renderTarget.setSize(r.width,r.height)}},ShaderPass=class extends Pass{constructor(e,t="inputBuffer"){super("ShaderPass"),this.setFullscreenMaterial(e),this.uniform=null,this.setInput(t)}setInput(e){const t=this.getFullscreenMaterial();if(this.uniform=null,null!==t){const r=t.uniforms;void 0!==r&&void 0!==r[e]&&(this.uniform=r[e])}}render(e,t,r,n,i){null!==this.uniform&&null!==t&&(this.uniform.value=t.texture),e.setRenderTarget(this.renderToScreen?null:r),e.render(this.scene,this.camera)}initialize(e,t,r){if(void 0!==r&&r!==UnsignedByteType){this.getFullscreenMaterial().defines.FRAMEBUFFER_PRECISION_HIGH="1"}}},MILLISECONDS_TO_SECONDS=.001,SECONDS_TO_MILLISECONDS=1e3,Timer=class{constructor(){this.previousTime=0,this.currentTime=0,this.delta=0,this.fixedDelta=1e3/60,this.elapsed=0,this.timescale=1,this.fixedDeltaEnabled=!1}setFixedDeltaEnabled(e){return this.fixedDeltaEnabled=e,this}setAutoResetEnabled(e){return"undefined"!=typeof document&&void 0!==document.hidden&&(e?document.addEventListener("visibilitychange",this):document.removeEventListener("visibilitychange",this)),this}getDelta(){return this.delta*MILLISECONDS_TO_SECONDS}getFixedDelta(){return this.fixedDelta*MILLISECONDS_TO_SECONDS}setFixedDelta(e){return this.fixedDelta=e*SECONDS_TO_MILLISECONDS,this}getElapsed(){return this.elapsed*MILLISECONDS_TO_SECONDS}getTimescale(){return this.timescale}setTimescale(e){return this.timescale=e,this}update(e){return this.fixedDeltaEnabled?this.delta=this.fixedDelta:(this.previousTime=this.currentTime,this.currentTime=void 0!==e?e:performance.now(),this.delta=this.currentTime-this.previousTime),this.delta*=this.timescale,this.elapsed+=this.deltaTime,this}reset(){return this.delta=0,this.elapsed=0,this.currentTime=performance.now(),this}handleEvent(e){document.hidden||(this.currentTime=performance.now())}dispose(){"undefined"!=typeof document&&document.removeEventListener("visibilitychange",this)}},EffectComposer=class{constructor(e=null,{depthBuffer:t=!0,stencilBuffer:r=!1,alpha:n=!1,multisampling:i=0,frameBufferType:a}={}){this.renderer=e,this.inputBuffer=null,this.outputBuffer=null,null!==this.renderer&&(this.renderer.autoClear=!1,this.inputBuffer=this.createBuffer(t,r,a,i),this.outputBuffer=this.inputBuffer.clone()),this.copyPass=new ShaderPass(new CopyMaterial),this.alpha=n,this.depthTexture=null,this.passes=[],this.timer=new Timer,this.autoRenderToScreen=!0}get multisampling(){return this.inputBuffer instanceof WebGLMultisampleRenderTarget?this.inputBuffer.samples:0}set multisampling(e){const t=this.inputBuffer,r=this.multisampling;r>0&&e>0?(this.inputBuffer.samples=e,this.outputBuffer.samples=e):r!==e&&(this.inputBuffer.dispose(),this.outputBuffer.dispose(),this.inputBuffer=this.createBuffer(t.depthBuffer,t.stencilBuffer,t.texture.type,e),this.inputBuffer.depthTexture=this.depthTexture,this.outputBuffer=this.inputBuffer.clone())}getTimer(){return this.timer}getRenderer(){return this.renderer}replaceRenderer(e,t=!0){const r=this.renderer;if(null!==r&&r!==e){const n=r.getSize(new Vector2),i=e.getSize(new Vector2),a=r.domElement.parentNode;this.renderer=e,this.renderer.autoClear=!1,n.equals(i)||this.setSize(),t&&null!==a&&(a.removeChild(r.domElement),a.appendChild(e.domElement))}return r}createDepthTexture(){const e=this.depthTexture=new DepthTexture;return this.inputBuffer.depthTexture=e,this.inputBuffer.dispose(),this.inputBuffer.stencilBuffer?(e.format=DepthStencilFormat,e.type=UnsignedInt248Type):e.type=UnsignedIntType,e}deleteDepthTexture(){if(null!==this.depthTexture){this.depthTexture.dispose(),this.depthTexture=null,this.inputBuffer.depthTexture=null,this.inputBuffer.dispose();for(const e of this.passes)e.setDepthTexture(null)}}createBuffer(e,t,r,n){const i=this.renderer,a=i.getContext(),o=i.getDrawingBufferSize(new Vector2),s={format:this.alpha||a.getContextAttributes().alpha||r!==UnsignedByteType?RGBAFormat:RGBFormat,minFilter:LinearFilter,magFilter:LinearFilter,stencilBuffer:t,depthBuffer:e,type:r},l=n>0?new WebGLMultisampleRenderTarget(o.width,o.height,s):new WebGLRenderTarget(o.width,o.height,s);return n>0&&(l.samples=n),l.texture.name="EffectComposer.Buffer",l.texture.generateMipmaps=!1,l}addPass(e,t){const r=this.passes,n=this.renderer,i=n.getDrawingBufferSize(new Vector2),a=n.getContext().getContextAttributes().alpha,o=this.inputBuffer.texture.type;if(e.setSize(i.width,i.height),e.initialize(n,a,o),this.autoRenderToScreen&&(r.length>0&&(r[r.length-1].renderToScreen=!1),e.renderToScreen&&(this.autoRenderToScreen=!1)),void 0!==t?r.splice(t,0,e):r.push(e),this.autoRenderToScreen&&(r[r.length-1].renderToScreen=!0),e.needsDepthTexture||null!==this.depthTexture)if(null===this.depthTexture){const t=this.createDepthTexture();for(e of r)e.setDepthTexture(t)}else e.setDepthTexture(this.depthTexture)}removePass(e){const t=this.passes,r=t.indexOf(e);if(-1!==r&&t.splice(r,1).length>0){if(null!==this.depthTexture){const r=(e,t)=>e||t.needsDepthTexture;t.reduce(r,!1)||(e.getDepthTexture()===this.depthTexture&&e.setDepthTexture(null),this.deleteDepthTexture())}this.autoRenderToScreen&&r===t.length&&(e.renderToScreen=!1,t.length>0&&(t[t.length-1].renderToScreen=!0))}}removeAllPasses(){const e=this.passes;this.deleteDepthTexture(),e.length>0&&(this.autoRenderToScreen&&(e[e.length-1].renderToScreen=!1),this.passes=[])}render(e){const t=this.renderer,r=this.copyPass;let n,i,a,o=this.inputBuffer,s=this.outputBuffer,l=!1;void 0===e&&(e=this.timer.update().getDelta());for(const c of this.passes)c.isEnabled()&&(c.render(t,o,s,e,l),c.needsSwap&&(l&&(r.renderToScreen=c.renderToScreen,n=t.getContext(),i=t.state.buffers.stencil,i.setFunc(n.NOTEQUAL,1,4294967295),r.render(t,o,s,e,l),i.setFunc(n.EQUAL,1,4294967295)),a=o,o=s,s=a),c instanceof MaskPass?l=!0:c instanceof ClearMaskPass&&(l=!1))}setSize(e,t,r){const n=this.renderer;if(void 0===e||void 0===t){const r=n.getSize(new Vector2);e=r.width,t=r.height}else n.setSize(e,t,r);const i=n.getDrawingBufferSize(new Vector2),a=this.inputBuffer,o=this.outputBuffer;a.setSize(i.width,i.height),o.setSize(i.width,i.height);for(const e of this.passes)e.setSize(i.width,i.height)}reset(){this.dispose(),this.autoRenderToScreen=!0}dispose(){for(const e of this.passes)e.dispose();this.passes=[],null!==this.inputBuffer&&this.inputBuffer.dispose(),null!==this.outputBuffer&&this.outputBuffer.dispose(),this.deleteDepthTexture(),this.copyPass.dispose(),this.timer.dispose()}},Selection=class extends Set{constructor(e,t=10){super(),this.currentLayer=t,this.exclusive=!1,void 0!==e&&this.set(e)}get layer(){return this.currentLayer}set layer(e){this.setLayer(e)}getLayer(){return this.currentLayer}setLayer(e){const t=this.currentLayer;for(const r of this)r.layers.disable(t),r.layers.enable(e);this.currentLayer=e}clear(){const e=this.layer;for(const t of this)t.layers.disable(e);return super.clear()}set(e){this.clear();for(const t of e)this.add(t);return this}indexOf(e){return this.has(e)?0:-1}add(e){return this.exclusive?e.layers.set(this.layer):e.layers.enable(this.layer),super.add(e)}delete(e){return this.has(e)&&e.layers.disable(this.layer),super.delete(e)}setVisible(e){for(const t of this)e?t.layers.enable(0):t.layers.disable(0);return this}},shader_default46="#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D map;\n#else\nuniform lowp sampler2D map;\n#endif\nuniform float intensity;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){outputColor=clamp(texture2D(map,uv)*intensity,0.0,1.0);}",BloomEffect=class extends Effect$1{constructor({blendFunction:e=BlendFunction.SCREEN,luminanceThreshold:t=.9,luminanceSmoothing:r=.025,resolutionScale:n=.5,intensity:i=1,width:a=Resizer.AUTO_SIZE,height:o=Resizer.AUTO_SIZE,kernelSize:s=KernelSize$1.LARGE}={}){super("BloomEffect",shader_default46,{blendFunction:e,uniforms:new Map([["map",new Uniform(null)],["intensity",new Uniform(i)]])}),this.renderTarget=new WebGLRenderTarget(1,1,{minFilter:LinearFilter,magFilter:LinearFilter,stencilBuffer:!1,depthBuffer:!1}),this.renderTarget.texture.name="Bloom.Target",this.renderTarget.texture.generateMipmaps=!1,this.uniforms.get("map").value=this.renderTarget.texture,this.blurPass=new BlurPass({resolutionScale:n,width:a,height:o,kernelSize:s}),this.blurPass.resolution.resizable=this,this.luminancePass=new LuminancePass({renderTarget:this.renderTarget,colorOutput:!0}),this.luminancePass.resolution=this.resolution,this.luminanceMaterial.threshold=t,this.luminanceMaterial.smoothing=r}get texture(){return this.renderTarget.texture}get luminanceMaterial(){return this.luminancePass.getFullscreenMaterial()}get resolution(){return this.blurPass.resolution}get width(){return this.resolution.width}set width(e){this.resolution.width=e}get height(){return this.resolution.height}set height(e){this.resolution.height=e}get dithering(){return this.blurPass.dithering}set dithering(e){this.blurPass.dithering=e}get kernelSize(){return this.blurPass.kernelSize}set kernelSize(e){this.blurPass.kernelSize=e}get distinction(){return console.warn(this.name,"The distinction field has been removed, use .threshold and .smoothing instead."),1}set distinction(e){console.warn(this.name,"The distinction field has been removed, use .threshold and .smoothing instead.")}get intensity(){return this.uniforms.get("intensity").value}set intensity(e){this.uniforms.get("intensity").value=e}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}update(e,t,r){const n=this.renderTarget;this.luminancePass.isEnabled()?(this.luminancePass.render(e,t,n),this.blurPass.render(e,n,n)):this.blurPass.render(e,t,n)}setSize(e,t){this.blurPass.setSize(e,t),this.renderTarget.setSize(this.resolution.width,this.resolution.height)}initialize(e,t,r){this.blurPass.initialize(e,t,r),t||r!==UnsignedByteType||(this.renderTarget.texture.format=RGBFormat),void 0!==r&&(this.renderTarget.texture.type=r)}},shader_default48="uniform float brightness;uniform float contrast;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec3 color=inputColor.rgb+vec3(brightness-0.5);if(contrast>0.0){color/=vec3(1.0-contrast);}else{color*=vec3(1.0+contrast);}outputColor=vec4(min(color+vec3(0.5),1.0),inputColor.a);}",BrightnessContrastEffect=class extends Effect$1{constructor({blendFunction:e=BlendFunction.NORMAL,brightness:t=0,contrast:r=0}={}){super("BrightnessContrastEffect",shader_default48,{blendFunction:e,uniforms:new Map([["brightness",new Uniform(t)],["contrast",new Uniform(r)]])})}},shader_default53="void mainImage(const in vec4 inputColor,const in vec2 uv,const in float depth,out vec4 outputColor){\n#ifdef INVERTED\nvec3 color=vec3(1.0-depth);\n#else\nvec3 color=vec3(depth);\n#endif\noutputColor=vec4(color,inputColor.a);}",DepthEffect=class extends Effect$1{constructor({blendFunction:e=BlendFunction.NORMAL,inverted:t=!1}={}){super("DepthEffect",shader_default53,{blendFunction:e,attributes:EffectAttribute.DEPTH}),this.inverted=t}get inverted(){return this.defines.has("INVERTED")}set inverted(e){this.inverted!==e&&(e?this.defines.set("INVERTED","1"):this.defines.delete("INVERTED"),this.setChanged())}},shader_default54="#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D nearColorBuffer;uniform mediump sampler2D farColorBuffer;\n#else\nuniform lowp sampler2D nearColorBuffer;uniform lowp sampler2D farColorBuffer;\n#endif\nuniform lowp sampler2D nearCoCBuffer;uniform float scale;void mainImage(const in vec4 inputColor,const in vec2 uv,const in float depth,out vec4 outputColor){vec4 colorNear=texture2D(nearColorBuffer,uv);vec4 colorFar=texture2D(farColorBuffer,uv);float CoCNear=texture2D(nearCoCBuffer,uv).r;CoCNear=min(CoCNear*scale,1.0);vec4 result=inputColor*(1.0-colorFar.a)+colorFar;result=mix(result,colorNear,CoCNear);outputColor=result;}",DepthOfFieldEffect=class extends Effect$1{constructor(e,{blendFunction:t=BlendFunction.NORMAL,focusDistance:r=0,focalLength:n=.1,bokehScale:i=1,width:a=Resizer.AUTO_SIZE,height:o=Resizer.AUTO_SIZE}={}){super("DepthOfFieldEffect",shader_default54,{blendFunction:t,attributes:EffectAttribute.DEPTH,uniforms:new Map([["nearColorBuffer",new Uniform(null)],["farColorBuffer",new Uniform(null)],["nearCoCBuffer",new Uniform(null)],["scale",new Uniform(1)]])}),this.camera=e,this.renderTarget=new WebGLRenderTarget(1,1,{minFilter:LinearFilter,magFilter:LinearFilter,stencilBuffer:!1,depthBuffer:!1}),this.renderTarget.texture.name="DoF.Intermediate",this.renderTarget.texture.generateMipmaps=!1,this.renderTargetMasked=this.renderTarget.clone(),this.renderTargetMasked.texture.name="DoF.Masked.Far",this.renderTargetNear=this.renderTarget.clone(),this.renderTargetNear.texture.name="DoF.Bokeh.Near",this.uniforms.get("nearColorBuffer").value=this.renderTargetNear.texture,this.renderTargetFar=this.renderTarget.clone(),this.renderTargetFar.texture.name="DoF.Bokeh.Far",this.uniforms.get("farColorBuffer").value=this.renderTargetFar.texture,this.renderTargetCoC=this.renderTarget.clone(),this.renderTargetCoC.texture.format=RGBFormat,this.renderTargetCoC.texture.name="DoF.CoC",this.renderTargetCoCBlurred=this.renderTargetCoC.clone(),this.renderTargetCoCBlurred.texture.name="DoF.CoC.Blurred",this.uniforms.get("nearCoCBuffer").value=this.renderTargetCoCBlurred.texture,this.cocPass=new ShaderPass(new CircleOfConfusionMaterial(e));const s=this.circleOfConfusionMaterial;s.uniforms.focusDistance.value=r,s.uniforms.focalLength.value=n,this.blurPass=new BlurPass({width:a,height:o,kernelSize:KernelSize$1.MEDIUM}),this.blurPass.resolution.resizable=this,this.maskPass=new ShaderPass(new MaskMaterial(this.renderTargetCoC.texture));const l=this.maskPass.getFullscreenMaterial();l.maskFunction=MaskFunction.MULTIPLY,l.colorChannel=ColorChannel.GREEN,this.bokehNearBasePass=new ShaderPass(new BokehMaterial(!1,!0)),this.bokehNearFillPass=new ShaderPass(new BokehMaterial(!0,!0)),this.bokehFarBasePass=new ShaderPass(new BokehMaterial(!1,!1)),this.bokehFarFillPass=new ShaderPass(new BokehMaterial(!0,!1)),this.bokehScale=i,this.target=null}get circleOfConfusionMaterial(){return this.cocPass.getFullscreenMaterial()}get resolution(){return this.blurPass.resolution}get bokehScale(){return this.uniforms.get("scale").value}set bokehScale(e){[this.bokehNearBasePass,this.bokehNearFillPass,this.bokehFarBasePass,this.bokehFarFillPass].map((e=>e.getFullscreenMaterial().uniforms.scale)).forEach((t=>{t.value=e})),this.maskPass.getFullscreenMaterial().uniforms.strength.value=e,this.uniforms.get("scale").value=e}calculateFocusDistance(e){const t=this.camera,r=t.far-t.near,n=t.position.distanceTo(e);return Math.min(Math.max(n/r,0),1)}setDepthTexture(e,t=BasicDepthPacking){const r=this.circleOfConfusionMaterial;r.uniforms.depthBuffer.value=e,r.depthPacking=t}update(e,t,r){const n=this.renderTarget,i=this.renderTargetCoC,a=this.renderTargetCoCBlurred,o=this.renderTargetMasked,s=this.bokehFarBasePass,l=this.bokehFarFillPass,c=s.getFullscreenMaterial().uniforms,h=l.getFullscreenMaterial().uniforms,u=this.bokehNearBasePass,d=this.bokehNearFillPass,p=u.getFullscreenMaterial().uniforms,f=d.getFullscreenMaterial().uniforms;if(null!==this.target){const e=this.calculateFocusDistance(this.target);this.circleOfConfusionMaterial.uniforms.focusDistance.value=e}this.cocPass.render(e,null,i),this.blurPass.render(e,i,a),this.maskPass.render(e,t,o),c.cocBuffer.value=i.texture,h.cocBuffer.value=i.texture,s.render(e,o,n),l.render(e,n,this.renderTargetFar),p.cocBuffer.value=a.texture,f.cocBuffer.value=a.texture,u.render(e,t,n),d.render(e,n,this.renderTargetNear)}setSize(e,t){const r=this.resolution;let n=[this.cocPass,this.blurPass,this.maskPass,this.bokehNearBasePass,this.bokehNearFillPass,this.bokehFarBasePass,this.bokehFarFillPass];n.push(this.renderTargetCoC,this.renderTargetMasked),n.forEach((r=>r.setSize(e,t)));const i=r.width,a=r.height;n=[this.renderTarget,this.renderTargetNear,this.renderTargetFar,this.renderTargetCoCBlurred],n.forEach((e=>e.setSize(i,a)));[this.bokehNearBasePass,this.bokehNearFillPass,this.bokehFarBasePass,this.bokehFarFillPass].forEach((e=>e.getFullscreenMaterial().setTexelSize(1/i,1/a)))}initialize(e,t,r){[this.cocPass,this.maskPass,this.bokehNearBasePass,this.bokehNearFillPass,this.bokehFarBasePass,this.bokehFarFillPass].forEach((n=>n.initialize(e,t,r))),this.blurPass.initialize(e,t,UnsignedByteType),t||r!==UnsignedByteType||(this.renderTargetNear.texture.type=RGBFormat),void 0!==r&&(this.renderTarget.texture.type=r,this.renderTargetNear.texture.type=r,this.renderTargetFar.texture.type=r,this.renderTargetMasked.texture.type=r)}};function getNoise(e,t,r){const n=new Map([[LuminanceFormat,1],[RedFormat,1],[RGFormat,2],[RGBFormat,3],[RGBAFormat,4]]);let i;if(n.has(t)||console.error("Invalid noise texture format"),r===UnsignedByteType){i=new Uint8Array(e*n.get(t));for(let e=0,t=i.length;e<t;++e)i[e]=255*Math.random()}else{i=new Float32Array(e*n.get(t));for(let e=0,t=i.length;e<t;++e)i[e]=Math.random()}return i}var NoiseTexture=class extends DataTexture{constructor(e,t,r=LuminanceFormat,n=UnsignedByteType){super(getNoise(e*t,r,n),e,t,r,n)}};new Matrix4;var shader_default60="uniform vec3 hue;uniform float saturation;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec3 color=vec3(dot(inputColor.rgb,hue.xyz),dot(inputColor.rgb,hue.zxy),dot(inputColor.rgb,hue.yzx));float average=(color.r+color.g+color.b)/3.0;vec3 diff=average-color;if(saturation>0.0){color+=diff*(1.0-1.0/(1.001-saturation));}else{color+=diff*-saturation;}outputColor=vec4(min(color,1.0),inputColor.a);}",HueSaturationEffect=class extends Effect$1{constructor({blendFunction:e=BlendFunction.NORMAL,hue:t=0,saturation:r=0}={}){super("HueSaturationEffect",shader_default60,{blendFunction:e,uniforms:new Map([["hue",new Uniform(new Vector3)],["saturation",new Uniform(r)]])}),this.setHue(t)}setHue(e){const t=Math.sin(e),r=Math.cos(e);this.uniforms.get("hue").value.set(2*r,-Math.sqrt(3)*t-r,Math.sqrt(3)*t-r).addScalar(1).divideScalar(3)}};function createCanvas(e,t,r){const n=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),i=n.getContext("2d");if(n.width=e,n.height=t,r instanceof Image)i.drawImage(r,0,0);else{const n=i.createImageData(e,t);n.data.set(r),i.putImageData(n,0,0)}return n}var RawImageData=class{constructor(e=0,t=0,r=null){this.width=e,this.height=t,this.data=r}toCanvas(){return"undefined"==typeof document?null:createCanvas(this.width,this.height,this.data)}static from(e){const{width:t,height:r}=e;let n;if(e instanceof Image){const i=createCanvas(t,r,e);if(null!==i){n=i.getContext("2d").getImageData(0,0,t,r).data}}else n=e.data;return new RawImageData(t,r,n)}},LUTOperation={SCALE_UP:"lut.scaleup"},worker_default='(()=>{var q=Math.pow;var _={SCALE_UP:"lut.scaleup"};var k=[new Float32Array(3),new Float32Array(3)],t=[new Float32Array(3),new Float32Array(3),new Float32Array(3),new Float32Array(3)],U=[[new Float32Array([0,0,0]),new Float32Array([1,0,0]),new Float32Array([1,1,0]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([1,0,0]),new Float32Array([1,0,1]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([0,0,1]),new Float32Array([1,0,1]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([0,1,0]),new Float32Array([1,1,0]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([0,1,0]),new Float32Array([0,1,1]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([0,0,1]),new Float32Array([0,1,1]),new Float32Array([1,1,1])]];function L(a,n,r,m){let h=r[0]-n[0],e=r[1]-n[1],s=r[2]-n[2],l=a[0]-n[0],w=a[1]-n[1],c=a[2]-n[2],y=e*c-s*w,A=s*l-h*c,g=h*w-e*l,p=Math.sqrt(y*y+A*A+g*g),V=p*.5,F=y/p,f=A/p,i=g/p,u=-(a[0]*F+a[1]*f+a[2]*i),M=m[0]*F+m[1]*f+m[2]*i;return Math.abs(M+u)*V/3}function X(a,n,r,m,h,e){let s=(r+m*n+h*n*n)*3;e[0]=a[s+0],e[1]=a[s+1],e[2]=a[s+2]}function j(a,n,r,m,h,e){let s=r*(n-1),l=m*(n-1),w=h*(n-1),c=Math.floor(s),y=Math.floor(l),A=Math.floor(w),g=Math.ceil(s),p=Math.ceil(l),V=Math.ceil(w),F=s-c,f=l-y,i=w-A;if(c===s&&y===l&&A===w)X(a,n,s,l,w,e);else{let u;F>=f&&f>=i?u=U[0]:F>=i&&i>=f?u=U[1]:i>=F&&F>=f?u=U[2]:f>=F&&F>=i?u=U[3]:f>=i&&i>=F?u=U[4]:i>=f&&f>=F&&(u=U[5]);let[M,x,P,T]=u,d=k[0];d[0]=F,d[1]=f,d[2]=i;let o=k[1],Y=g-c,Z=p-y,b=V-A;o[0]=Y*M[0]+c,o[1]=Z*M[1]+y,o[2]=b*M[2]+A,X(a,n,o[0],o[1],o[2],t[0]),o[0]=Y*x[0]+c,o[1]=Z*x[1]+y,o[2]=b*x[2]+A,X(a,n,o[0],o[1],o[2],t[1]),o[0]=Y*P[0]+c,o[1]=Z*P[1]+y,o[2]=b*P[2]+A,X(a,n,o[0],o[1],o[2],t[2]),o[0]=Y*T[0]+c,o[1]=Z*T[1]+y,o[2]=b*T[2]+A,X(a,n,o[0],o[1],o[2],t[3]);let v=L(x,P,T,d)*6,S=L(M,P,T,d)*6,C=L(M,x,T,d)*6,E=L(M,x,P,d)*6;t[0][0]*=v,t[0][1]*=v,t[0][2]*=v,t[1][0]*=S,t[1][1]*=S,t[1][2]*=S,t[2][0]*=C,t[2][1]*=C,t[2][2]*=C,t[3][0]*=E,t[3][1]*=E,t[3][2]*=E,e[0]=t[0][0]+t[1][0]+t[2][0]+t[3][0],e[1]=t[0][1]+t[1][1]+t[2][1]+t[3][1],e[2]=t[0][2]+t[1][2]+t[2][2]+t[3][2]}}var O=class{static expand(n,r){let m=Math.cbrt(n.length/3),h=new Float32Array(3),e=new n.constructor(q(r,3)*3),s=1/(r-1);for(let l=0;l<r;++l)for(let w=0;w<r;++w)for(let c=0;c<r;++c){let y=c*s,A=w*s,g=l*s,p=Math.round(c+w*r+l*r*r)*3;j(n,m,y,A,g,h),e[p+0]=h[0],e[p+1]=h[1],e[p+2]=h[2]}return e}};self.addEventListener("message",a=>{let n=a.data,r=n.data;switch(n.operation){case _.SCALE_UP:r=O.expand(r,n.size);break}postMessage(r,[r.buffer]),close()});})();\n',c=new Color,LookupTexture3D=class extends DataTexture3D{constructor(e,t){super(e,t,t,t),this.type=FloatType,this.format=RGBFormat,this.encoding=LinearEncoding,this.minFilter=LinearFilter,this.magFilter=LinearFilter,this.wrapS=ClampToEdgeWrapping,this.wrapT=ClampToEdgeWrapping,this.wrapR=ClampToEdgeWrapping,this.unpackAlignment=1,this.domainMin=new Vector3(0,0,0),this.domainMax=new Vector3(1,1,1)}get isLookupTexture3D(){return!0}scaleUp(e,t=!0){const r=this.image;let n;if(e<=r.width)n=Promise.reject(new Error("The target size must be greater than the current size"));else{const i=URL.createObjectURL(new Blob([worker_default],{type:"text/javascript"})),a=new Worker(i);n=new Promise(((n,o)=>{a.addEventListener("error",(e=>o(e.error))),a.addEventListener("message",(t=>{const r=new LookupTexture3D(t.data,e);r.encoding=this.encoding,r.type=this.type,r.name=this.name,URL.revokeObjectURL(i),n(r)}));const s=t?[r.data.buffer]:[];a.postMessage({operation:LUTOperation.SCALE_UP,data:r.data,size:e},s)}))}return n}applyLUT(e){const t=this.image,r=e.image,n=Math.min(t.width,t.height,t.depth);if(n!==Math.min(r.width,r.height,r.depth))console.error("Size mismatch");else if(e.type!==FloatType||this.type!==FloatType)console.error("Both LUTs must be FloatType textures");else if(e.format!==RGBFormat||this.format!==RGBFormat)console.error("Both LUTs must be RGB textures");else{const e=t.data,i=r.data,a=n,o=a-1;for(let t=0,r=a**3;t<r;++t){const r=3*t,n=e[r+0]*o,s=e[r+1]*o,l=e[r+2]*o,c=3*Math.round(n+s*a+l*a*a);e[r+0]=i[c+0],e[r+1]=i[c+1],e[r+2]=i[c+2]}this.needsUpdate=!0}return this}convertToUint8(){if(this.type===FloatType){const e=this.image.data,t=new Uint8Array(e.length);for(let r=0,n=e.length;r<n;++r)t[r]=255*e[r];this.image.data=t,this.type=UnsignedByteType,this.needsUpdate=!0}return this}convertToFloat(){if(this.type===UnsignedByteType){const e=this.image.data,t=new Float32Array(e.length);for(let r=0,n=e.length;r<n;++r)t[r]=e[r]/255;this.image.data=t,this.type=FloatType,this.needsUpdate=!0}return this}convertLinearToSRGB(){const e=this.image.data;if(this.type===FloatType){const t=this.format===RGBAFormat?4:3;for(let r=0,n=e.length;r<n;r+=t)c.fromArray(e,r).convertLinearToSRGB().toArray(e,r);this.encoding=sRGBEncoding,this.needsUpdate=!0}else console.error("Color space conversion requires FloatType data");return this}convertSRGBToLinear(){const e=this.image.data;if(this.type===FloatType){const t=this.format===RGBAFormat?4:3;for(let r=0,n=e.length;r<n;r+=t)c.fromArray(e,r).convertSRGBToLinear().toArray(e,r);this.encoding=LinearEncoding,this.needsUpdate=!0}else console.error("Color space conversion requires FloatType data");return this}convertToRGBA(){if(this.format===RGBFormat){const e=this.image.width,t=this.image.data,r=new t.constructor(e**3*4),n=this.type===FloatType?1:255;for(let e=0,i=0,a=t.length;e<a;e+=3,i+=4)r[i+0]=t[e+0],r[i+1]=t[e+1],r[i+2]=t[e+2],r[i+3]=n;this.image.data=r,this.format=RGBAFormat,this.needsUpdate=!0}return this}toDataTexture(){const e=this.image.width,t=this.image.height*this.image.depth,r=new DataTexture(this.image.data,e,t);return r.name=this.name,r.type=this.type,r.format=this.format,r.encoding=this.encoding,r.minFilter=LinearFilter,r.magFilter=LinearFilter,r.wrapS=this.wrapS,r.wrapT=this.wrapT,r.generateMipmaps=!1,r}static from(e){const t=e.image,{width:r,height:n}=t,i=Math.min(r,n);let a;if(t instanceof Image){a=RawImageData.from(t).data;const e=new Uint8Array(i**3*3);if(r>n)for(let t=0;t<i;++t)for(let r=0;r<i;++r)for(let n=0;n<i;++n){const o=4*(n+t*i+r*i*i),s=3*(n+r*i+t*i*i);e[s+0]=a[o+0],e[s+1]=a[o+1],e[s+2]=a[o+2]}else for(let t=0,r=i**3;t<r;++t){const r=4*t,n=3*t;e[n+0]=a[r+0],e[n+1]=a[r+1],e[n+2]=a[r+2]}a=e}else a=t.data.slice();const o=new LookupTexture3D(a,i);return o.type=e.type,o.encoding=e.encoding,o.name=e.name,o}static createNeutral(e){const t=new Float32Array(e**3*3),r=1/(e-1);for(let n=0;n<e;++n)for(let i=0;i<e;++i)for(let a=0;a<e;++a){const o=3*(n+i*e+a*e*e);t[o+0]=n*r,t[o+1]=i*r,t[o+2]=a*r}const n=new LookupTexture3D(t,e);return n.name="neutral",n}},shader_default61="uniform vec3 scale;uniform vec3 offset;\n#ifdef CUSTOM_INPUT_DOMAIN\nuniform vec3 domainMin;uniform vec3 domainMax;\n#endif\n#ifdef LUT_3D\n#ifdef LUT_PRECISION_HIGH\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler3D lut;\n#else\nuniform mediump sampler3D lut;\n#endif\n#else\nuniform lowp sampler3D lut;\n#endif\nvec4 applyLUT(const in vec3 rgb){\n#ifdef TETRAHEDRAL_INTERPOLATION\nvec3 p=floor(rgb);vec3 f=rgb-p;vec3 v1=(p+0.5)*LUT_TEXEL_WIDTH;vec3 v4=(p+1.5)*LUT_TEXEL_WIDTH;vec3 v2,v3;vec3 frac;if(f.r>=f.g){if(f.g>f.b){frac=f.rgb;v2=vec3(v4.x,v1.y,v1.z);v3=vec3(v4.x,v4.y,v1.z);}else if(f.r>=f.b){frac=f.rbg;v2=vec3(v4.x,v1.y,v1.z);v3=vec3(v4.x,v1.y,v4.z);}else{frac=f.brg;v2=vec3(v1.x,v1.y,v4.z);v3=vec3(v4.x,v1.y,v4.z);}}else{if(f.b>f.g){frac=f.bgr;v2=vec3(v1.x,v1.y,v4.z);v3=vec3(v1.x,v4.y,v4.z);}else if(f.r>=f.b){frac=f.grb;v2=vec3(v1.x,v4.y,v1.z);v3=vec3(v4.x,v4.y,v1.z);}else{frac=f.gbr;v2=vec3(v1.x,v4.y,v1.z);v3=vec3(v1.x,v4.y,v4.z);}}vec4 n1=texture(lut,v1);vec4 n2=texture(lut,v2);vec4 n3=texture(lut,v3);vec4 n4=texture(lut,v4);vec4 weights=vec4(1.0-frac.x,frac.x-frac.y,frac.y-frac.z,frac.z);vec4 result=weights*mat4(vec4(n1.r,n2.r,n3.r,n4.r),vec4(n1.g,n2.g,n3.g,n4.g),vec4(n1.b,n2.b,n3.b,n4.b),vec4(1.0));return vec4(result.rgb,1.0);\n#else\nreturn texture(lut,rgb);\n#endif\n}\n#else\n#ifdef LUT_PRECISION_HIGH\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D lut;\n#else\nuniform mediump sampler2D lut;\n#endif\n#else\nuniform lowp sampler2D lut;\n#endif\nvec4 applyLUT(const in vec3 rgb){float slice=rgb.b*LUT_SIZE;float slice0=floor(slice);float interp=slice-slice0;float centeredInterp=interp-0.5;float slice1=slice0+sign(centeredInterp);\n#ifdef LUT_STRIP_HORIZONTAL\nfloat xOffset=clamp(rgb.r*LUT_TEXEL_HEIGHT,LUT_TEXEL_WIDTH*0.5,LUT_TEXEL_HEIGHT-LUT_TEXEL_WIDTH*0.5);vec2 uv0=vec2(slice0*LUT_TEXEL_HEIGHT+xOffset,rgb.g);vec2 uv1=vec2(slice1*LUT_TEXEL_HEIGHT+xOffset,rgb.g);\n#else\nfloat yOffset=clamp(rgb.g*LUT_TEXEL_WIDTH,LUT_TEXEL_HEIGHT*0.5,LUT_TEXEL_WIDTH-LUT_TEXEL_HEIGHT*0.5);vec2 uv0=vec2(rgb.r,slice0*LUT_TEXEL_WIDTH+yOffset);vec2 uv1=vec2(rgb.r,slice1*LUT_TEXEL_WIDTH+yOffset);\n#endif\nvec4 sample0=texture2D(lut,uv0);vec4 sample1=texture2D(lut,uv1);return mix(sample0,sample1,abs(centeredInterp));}\n#endif\nvoid mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec3 c=linearToInputTexel(inputColor).rgb;\n#ifdef CUSTOM_INPUT_DOMAIN\nif(c.r>=domainMin.r&&c.g>=domainMin.g&&c.b>=domainMin.b&&c.r<=domainMax.r&&c.g<=domainMax.g&&c.b<=domainMax.b){c=texelToLinear(applyLUT(scale*c+offset)).rgb;}else{c=inputColor.rgb;}\n#else\n#if !defined(LUT_3D) || defined(TETRAHEDRAL_INTERPOLATION)\nc=clamp(c,0.0,1.0);\n#endif\nc=texelToLinear(applyLUT(scale*c+offset)).rgb;\n#endif\noutputColor=vec4(c,inputColor.a);}",LUTEffect=class extends Effect$1{constructor(e,{blendFunction:t=BlendFunction.NORMAL,tetrahedralInterpolation:r=!1}={}){super("LUTEffect",shader_default61,{blendFunction:t,uniforms:new Map([["lut",new Uniform(null)],["scale",new Uniform(new Vector3)],["offset",new Uniform(new Vector3)],["domainMin",new Uniform(null)],["domainMax",new Uniform(null)]])}),this.tetrahedralInterpolation=r,this.inputEncoding=sRGBEncoding,this.outputEncoding=this.inputEncoding,this.setInputEncoding(sRGBEncoding),this.setLUT(e)}getOutputEncoding(){return this.outputEncoding}getInputEncoding(){return this.inputEncoding}setInputEncoding(e){const t=this.defines,r=this.getLUT();switch(e){case sRGBEncoding:t.set("linearToInputTexel(texel)","LinearTosRGB(texel)");break;case LinearEncoding:t.set("linearToInputTexel(texel)","texel");break;default:console.error("Unsupported input encoding:",e)}if(null!==r)switch(this.outputEncoding=r.encoding===LinearEncoding?e:r.encoding,this.outputEncoding){case sRGBEncoding:t.set("texelToLinear(texel)","sRGBToLinear(texel)");break;case LinearEncoding:t.set("texelToLinear(texel)","texel");break;default:console.error("Unsupported LUT encoding:",r.encoding)}this.inputEncoding!==e&&(this.inputEncoding=e,this.setChanged())}getLUT(){return this.uniforms.get("lut").value}setLUT(e){const t=this.defines,r=this.uniforms;if(this.getLUT()!==e){const n=e.image;if(t.clear(),t.set("LUT_SIZE",Math.min(n.width,n.height).toFixed(16)),t.set("LUT_TEXEL_WIDTH",(1/n.width).toFixed(16)),t.set("LUT_TEXEL_HEIGHT",(1/n.height).toFixed(16)),r.get("lut").value=e,r.get("domainMin").value=null,r.get("domainMax").value=null,e.type!==FloatType&&e.type!==HalfFloatType||t.set("LUT_PRECISION_HIGH","1"),n.width>n.height?t.set("LUT_STRIP_HORIZONTAL","1"):e instanceof DataTexture3D&&t.set("LUT_3D","1"),e instanceof LookupTexture3D){const n=e.domainMin,i=e.domainMax;0===n.x&&0===n.y&&0===n.z&&1===i.x&&1===i.y&&1===i.z||(t.set("CUSTOM_INPUT_DOMAIN","1"),r.get("domainMin").value=n.clone(),r.get("domainMax").value=i.clone())}this.configureTetrahedralInterpolation(),this.updateScaleOffset(),this.setInputEncoding(this.inputEncoding),this.setChanged()}}updateScaleOffset(){const e=this.getLUT(),t=Math.min(e.image.width,e.image.height),r=this.uniforms.get("scale").value,n=this.uniforms.get("offset").value;if(this.defines.has("TETRAHEDRAL_INTERPOLATION"))if(this.defines.has("CUSTOM_INPUT_DOMAIN")){const i=e.domainMax.clone().sub(e.domainMin);r.setScalar(t-1).divide(i),n.copy(e.domainMin).negate().multiply(r)}else r.setScalar(t-1),n.setScalar(0);else if(this.defines.has("CUSTOM_INPUT_DOMAIN")){const i=e.domainMax.clone().sub(e.domainMin).multiplyScalar(t);r.setScalar(t-1).divide(i),n.copy(e.domainMin).negate().multiply(r).addScalar(1/(2*t))}else r.setScalar((t-1)/t),n.setScalar(1/(2*t))}configureTetrahedralInterpolation(){const e=this.getLUT();e.minFilter=LinearFilter,e.magFilter=LinearFilter,this.defines.delete("TETRAHEDRAL_INTERPOLATION"),this.tetrahedralInterpolation&&null!==e&&(e instanceof DataTexture3D?(this.defines.set("TETRAHEDRAL_INTERPOLATION","1"),e.minFilter=NearestFilter,e.magFilter=NearestFilter):console.warn("Tetrahedral interpolation requires a 3D texture")),e.needsUpdate=!0}setTetrahedralInterpolationEnabled(e){this.tetrahedralInterpolation=e,this.configureTetrahedralInterpolation(),this.updateScaleOffset(),this.setChanged()}},shader_default62="void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec3 noise=vec3(rand(uv*time));\n#ifdef PREMULTIPLY\noutputColor=vec4(min(inputColor.rgb*noise,vec3(1.0)),inputColor.a);\n#else\noutputColor=vec4(noise,inputColor.a);\n#endif\n}",NoiseEffect=class extends Effect$1{constructor({blendFunction:e=BlendFunction.SCREEN,premultiply:t=!1}={}){super("NoiseEffect",shader_default62,{blendFunction:e}),this.premultiply=t}get premultiply(){return this.defines.has("PREMULTIPLY")}set premultiply(e){this.premultiply!==e&&(e?this.defines.set("PREMULTIPLY","1"):this.defines.delete("PREMULTIPLY"),this.setChanged())}};function getTextureDecoding(e,t){let r="texel";if(null!==e){if(!(Number.parseInt(REVISION)>=133&&t&&e.format===RGBAFormat&&e.type===UnsignedByteType&&e.encoding===sRGBEncoding))switch(e.encoding){case sRGBEncoding:r="sRGBToLinear(texel)";break;case LinearEncoding:r="texel";break;default:throw new Error(`Unsupported encoding: ${e.encoding}`)}}return r}var shader_default63="uniform lowp sampler2D edgeTexture;uniform lowp sampler2D maskTexture;uniform vec3 visibleEdgeColor;uniform vec3 hiddenEdgeColor;uniform float pulse;uniform float edgeStrength;\n#ifdef USE_PATTERN\nuniform lowp sampler2D patternTexture;varying vec2 vUvPattern;\n#endif\nvoid mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec2 edge=texture2D(edgeTexture,uv).rg;vec2 mask=texture2D(maskTexture,uv).rg;\n#ifndef X_RAY\nedge.y=0.0;\n#endif\nedge*=(edgeStrength*mask.x*pulse);vec3 color=edge.x*visibleEdgeColor+edge.y*hiddenEdgeColor;float visibilityFactor=0.0;\n#ifdef USE_PATTERN\nvec4 patternColor=texelToLinear(texture2D(patternTexture,vUvPattern));\n#ifdef X_RAY\nfloat hiddenFactor=0.5;\n#else\nfloat hiddenFactor=0.0;\n#endif\nvisibilityFactor=(1.0-mask.y>0.0)? 1.0 : hiddenFactor;visibilityFactor*=(1.0-mask.x)*patternColor.a;color+=visibilityFactor*patternColor.rgb;\n#endif\nfloat alpha=max(max(edge.x,edge.y),visibilityFactor);\n#ifdef ALPHA\noutputColor=vec4(color,alpha);\n#else\noutputColor=vec4(color,max(alpha,inputColor.a));\n#endif\n}",shader_default64="uniform float patternScale;varying vec2 vUvPattern;void mainSupport(const in vec2 uv){vUvPattern=uv*vec2(aspect,1.0)*patternScale;}",OutlineEffect=class extends Effect$1{constructor(e,t,{blendFunction:r=BlendFunction.SCREEN,patternTexture:n=null,edgeStrength:i=1,pulseSpeed:a=0,visibleEdgeColor:o=16777215,hiddenEdgeColor:s=2230538,resolutionScale:l=.5,width:c=Resizer.AUTO_SIZE,height:h=Resizer.AUTO_SIZE,kernelSize:u=KernelSize$1.VERY_SMALL,blur:d=!1,xRay:p=!0}={}){super("OutlineEffect",shader_default63,{uniforms:new Map([["maskTexture",new Uniform(null)],["edgeTexture",new Uniform(null)],["edgeStrength",new Uniform(i)],["visibleEdgeColor",new Uniform(new Color(o))],["hiddenEdgeColor",new Uniform(new Color(s))],["pulse",new Uniform(1)],["patternScale",new Uniform(1)],["patternTexture",new Uniform(null)]])}),this.blendMode.addEventListener("change",(e=>{this.blendMode.getBlendFunction()===BlendFunction.ALPHA?this.defines.set("ALPHA","1"):this.defines.delete("ALPHA"),this.setChanged()})),this.blendMode.setBlendFunction(r),this.setPatternTexture(n),this.xRay=p,this.scene=e,this.camera=t,this.renderTargetMask=new WebGLRenderTarget(1,1,{minFilter:LinearFilter,magFilter:LinearFilter,stencilBuffer:!1,format:RGBFormat}),this.renderTargetMask.texture.name="Outline.Mask",this.uniforms.get("maskTexture").value=this.renderTargetMask.texture,this.renderTargetOutline=this.renderTargetMask.clone(),this.renderTargetOutline.texture.name="Outline.Edges",this.renderTargetOutline.depthBuffer=!1,this.renderTargetBlurredOutline=this.renderTargetOutline.clone(),this.renderTargetBlurredOutline.texture.name="Outline.BlurredEdges",this.clearPass=new ClearPass,this.clearPass.overrideClearColor=new Color(0),this.clearPass.overrideClearAlpha=1,this.depthPass=new DepthPass(e,t),this.maskPass=new RenderPass(e,t,new DepthComparisonMaterial(this.depthPass.texture,t));const f=this.maskPass.getClearPass();f.overrideClearColor=new Color(16777215),f.overrideClearAlpha=1,this.blurPass=new BlurPass({resolutionScale:l,width:c,height:h,kernelSize:u}),this.blurPass.resolution.resizable=this,this.blur=d,this.outlinePass=new ShaderPass(new OutlineMaterial);this.outlinePass.getFullscreenMaterial().uniforms.inputBuffer.value=this.renderTargetMask.texture,this.time=0,this.selection=new Selection,this.selection.setLayer(10),this.pulseSpeed=a,this.isWebGL2=!1}get resolution(){return this.blurPass.resolution}get width(){return this.resolution.width}set width(e){this.resolution.width=e}get height(){return this.resolution.height}set height(e){this.resolution.height=e}get selectionLayer(){return this.selection.layer}set selectionLayer(e){this.selection.layer=e}get dithering(){return this.blurPass.dithering}set dithering(e){this.blurPass.dithering=e}get kernelSize(){return this.blurPass.kernelSize}set kernelSize(e){this.blurPass.kernelSize=e}get blur(){return this.blurPass.isEnabled()}set blur(e){this.blurPass.setEnabled(e),this.uniforms.get("edgeTexture").value=e?this.renderTargetBlurredOutline.texture:this.renderTargetOutline.texture}get xRay(){return this.defines.has("X_RAY")}set xRay(e){this.xRay!==e&&(e?this.defines.set("X_RAY","1"):this.defines.delete("X_RAY"),this.setChanged())}setPatternTexture(e){null!==e?(e.wrapS=e.wrapT=RepeatWrapping,this.defines.set("USE_PATTERN","1"),this.uniforms.get("patternTexture").value=e,this.setVertexShader(shader_default64)):(this.defines.delete("USE_PATTERN"),this.uniforms.get("patternTexture").value=null,this.setVertexShader(null));const t=getTextureDecoding(e,this.isWebGL2);this.defines.set("texelToLinear(texel)",t),this.setChanged()}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}setSelection(e){return this.selection.set(e),this}clearSelection(){return this.selection.clear(),this}selectObject(e){return this.selection.add(e),this}deselectObject(e){return this.selection.delete(e),this}update(e,t,r){const n=this.scene,i=this.camera,a=this.selection,o=this.uniforms.get("pulse"),s=n.background,l=i.layers.mask;a.size>0?(n.background=null,o.value=1,this.pulseSpeed>0&&(o.value=.375*Math.cos(this.time*this.pulseSpeed*10)+.625),this.time+=r,a.setVisible(!1),this.depthPass.render(e),a.setVisible(!0),i.layers.set(a.getLayer()),this.maskPass.render(e,this.renderTargetMask),i.layers.mask=l,n.background=s,this.outlinePass.render(e,null,this.renderTargetOutline),this.blur&&this.blurPass.render(e,this.renderTargetOutline,this.renderTargetBlurredOutline)):this.time>0&&(this.clearPass.render(e,this.renderTargetMask),this.time=0)}setSize(e,t){this.blurPass.setSize(e,t),this.renderTargetMask.setSize(e,t);const r=this.resolution.width,n=this.resolution.height;this.depthPass.setSize(r,n),this.renderTargetOutline.setSize(r,n),this.renderTargetBlurredOutline.setSize(r,n),this.outlinePass.getFullscreenMaterial().setTexelSize(1/r,1/n)}initialize(e,t,r){this.isWebGL2=e.capabilities.isWebGL2;const n=getTextureDecoding(this.uniforms.get("patternTexture").value,this.isWebGL2);this.defines.set("texelToLinear(texel)",n),this.blurPass.initialize(e,t,UnsignedByteType),void 0!==r&&(this.depthPass.initialize(e,t,r),this.maskPass.initialize(e,t,r),this.outlinePass.initialize(e,t,r))}},searchImageDataURL_default="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAAQCAYAAACm53kpAAAAeElEQVRYR+2XSwqAMAxEJ168ePEqwRSKhIIiuHjJqiU0gWE+1CQdApcVAMUAuARaMGCX1MIL/Ow13++9lW2s3mW9MWvsnWc/2fvGygwPAN4E8QzAA4CXAB6AHjG4JTHYI1ey3pcx6FHnEfhLDOIBKAmUBK6/ANUDTlROXAHd9EC1AAAAAElFTkSuQmCC",areaImageDataURL_default="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAAIwCAYAAAABNmBHAAAgAElEQVR4Xuy9CbhlV1ktOvbpq09DkiIkUBI6kxASIH0DlAQiIK1wRfSJTx+i4JX7vKIigs8HXpXvqVcvrcC9agQ7IDTSSWgqCQQliDRBJKkkhDSkqVPNqVOnP+8b//rH3P+eZ+199tlznVTlvVrft7+1T7OaueZY42/m37QALKNk2wHg1pITlB17mC+Pp11W3X/LHyT32vhg48/5SOv+PnwpsHA70JoGlueB1iKApeqzvOzn44GatTB76Xzhd7suBR7+WWADgDEAwwCG/L54b/poDLrHuvvm70Z2Avhsc+PVcxscBU8F8C8ADg5+ipIjD/PlGwfgju8B924E5seARUfLsiNmqQW0IjL8+7L2NYD/7COBzfcCm+aB8SVgdAkYIRCXKyDax4EdAanL5PuNPllNvXDlAHwFgP8AcC2AhRIoDXbsYb48dl5WkVFTE3LGDcC9m4CZCWBuFFgeAZaGAYJQQCRqDHT+McJrVb8zwATUXH02MHYfMHEIGFsAxgjApQqACYQORjtd/B7Axt/z79sC0+cMPgjjlwPwVwHcA+DfAHzTxcVgWBroqMN8+cYBeM71wH0TwKExYHYUWCIAHYRLTlkCYgcIBcAgU/n3qy8GRu4HRgnAOWBkERhddPAJhGJDBxkvw7cqimr+zFM/ZLnZF64cgL8BYD+AWwB8x/dlWuWagHiYL984AJ/0RWBy1AE4AizyM1yxYAcTigW55xMbAkxEiwEdkJ/ZCQxPAiOHgBECcKEC4TBZcKkSv+mTieNcNPNC26mLNsj45QD8LQDTAO4GcJt/7iw2bfoG4WG+vAGwm9ExiEg69zpg/wgwPQLMjgALzn4E4aIzoJjQ9g4024uygkj+pyuAoX0VAIfngOH5NgCHMhAm8Sv2y3XDZeBhNIp8OzJE8OsBzAKYBHAXgDt8/4O+MVT0j4f58o0D8Pxrgf3DwMwIMEPQEYRkNwfgsuuDZLskip0No0gWMD/9HGDoADAkAC4Aw/wsAgZAgs2Z0ABI0GU6IVmKv+f28KDnHxkA/G0A8y6G73N9kOCjXnh/Ebb6OvgwX75xAF5wLTA1VIHPADgMLDj4yIA5AAm6aCUnv4oz46eeDwxNAUMzwJAz4BABSNDFTwSfg7DDKHE23MG5PqIY8A1u/dINs9dBdy8AgnGPM2NfUBrsnw7z5RsH4IXXAAcJviFgluAbygBINnSLWOAjGxJ4pgOKDV0v/OSLKp8iGXBovhLBBOCQM2ACoTOhnYrAdItYbCij5JFzRyIAqRccAnDAQUjg6UNQ7hsMXP0cRQAexss3DsCLCECCLwCQzMcPwUi2MwAScAKbfnY/YRLFQ8DHX+IAJAMSfDkAF13kLvleIjhjQQHxUVS3jjgGpKeeNzYVQEjgUS8k+PghONdhIwAP4+XXBYCHKIJbwJyDTgaIAdCBJx3Q2M8tYAHP9m4df/ylQOsQ0JqtRLCx30K1wtLBggScQOgsKBGcWHAJeOwRC0BSM1mQIKRbhh+Bj98JQP6t4U0APEyXXxcAEnxkQAFwoVUxID9kvQg+c1C7vidRbIDkc24B//hTQGumDcCWA5DgMxASdNIFBUI5pCML8v8API5zfEQx4BudgqiczviSnJhQwCP4BMCGl+wO8+U7AJi/W4O4YS6+pmK/2ciADsAOBhTIIiAJnPB7AvNjP+0AnANaYkAHX2JBAc+tYaJXOqBZv24Vc386XW5dtkHGW+4HFAJonpOe+YYQZAShgKjv3PNvPQaxVoI8zJdfFwASfPzMUwS3Kt1v0UFIlos6oDFdAGFcliMAP/ryAEAGNwQRnDOgLbdlIEwrIs6AZ/QgkMMHQF6ZAKQcJAsSYPwIeAIk9wJgoPK1gi7+PwF4GC/fOAAvIQPSs0URTPBJ/Pp3GSEGRHfBCIQ0xowBtUbcAj7ys5X4Jfu1HIAGQrIgQRXEsAFQIORDFhiDY/rMHmrU4QUgR08AkgUjCAW6CD6CkwBsAIQC4GG6fPMA3OXiNzCg2I9gNCMksmAAoemDzoimFwL48M85AKkiuQVMAAp8CYRRDAt8GQiJ67N6GJODAXAHlsGguscA2AJg1IPGYmxOpBxFWkRN9LsATgIwXnNs/v/5z/9XCf8BO3YAtxbc/46/KDt+5+ea1Yku2VUxHz/z0v24FwMGK1gWsK2OUUxHHdCBeRUB6OxHABr4ZICIBd0QWSF+XRdMTAjgCdTrG9cBNwE4F8CpDkICyYLGsuhFt6zs+gISwUen8zEAjgMw4cfx2H6O/90yAFo84Cbg4ID3/9TfLTt+5+ebnRABkODjx0SwPi5ec/FrYpmqSAxM8Dn60CsqAFI6GfhqAMiDE/gokmvEr0C4PgDkBQm40wE8zMFEUDKEVoxIMLl/KS73mE7H9d+vcKHQQcjwW0Yu9nP8m8sAmOIBuWY6wP2/4s0ezjjg8TuvaR6ABJ70vxUApGrm7EbGE+i472BAB+WHfqHS/eoAaEwY2E9+wLSXTqhI7CXgnB6LCoOJ4BiST+hTnG0HcCwAglCx3ARoZEVFXnBPp/O/A/hXACc7CPs9/i1lAOyIB+RDX+P9/+pbQjjjAMfv/PL6AFDs1wFAgs/9fgKfgdE/ZEpuiQlbwAde6QAMBgiRmsSwA9BY0JfjovGRDBMH4TlcXGhcBOc6HkF0gjPhZgchxTLZMAci/04W/B6Ab3t09EPXcPyflgFwRTwgJ2MN9/8bf5qFM67x+B/aW4XQz42FeL0YrRyikztUFw0704mf9kXgxhOAqc3AAsPyRxxQCs/PdXOFY0W1KHy3QIUGtx+6vdnx1vsB+dsTncm2AogglFgVEAlUWrOMB2RyEmMCGQ/Y7/HvKns6tfGAnJQ+r/9b76oJZ1zD8WdyQjYBh8aBhVEHjELouQ8ukQ7VRSCJAALwkr+sALhnGzDD3JAJYJHg9uhoi4bx8ytkWUtvHT/7+Zc4dw1uZ3612fH2dkQf7yxIEEockwkJQn4IQoq8unhAhmPRKKFx0uv4K8ueTs94wD7u//VX9ghn7OP4c+4G7h8HpseB+dF2AKlFLwuAIZ8jD6NPrOhAffmfA9/ZBuzZCkyRWSeqBCWyoYGQ5yQrBpDbum/ME1HoPo0XEkSD2zlfbna8q6+EUJcTCxKEtHL5EQjP6BEPyIgYAZBvYt3xHyx7OqvGA65y/7/9wVXCGVc5/sl7qxD66dEqiYgRzAqhN1A4CBNAAlDyAFI+iZ9/N3DLJuC+jcDUBmCWyUnOrmTYCMIOkNclLg0B8/RsNLg9+UvNjnd1APLmmQpFHyEBROuWACQT8nN+H/GAvY7/VNnT6SsesMf13/CpahGnZzhjj+PPmwX2MYdDIfQexWyBAwEUOQDrRDN/98p3A7dvAO6fAA5sqHJDBEAyoUVGkwEd6HR12XU4kwzfl6fCXTZzjy57vvnR513X7Hj7AyDvggAUi9EyFgiZqNxPQF6345nOWbD1HQ/Y5fpvuLa/2+82/vNHgAPDFQDnhoF5j2C2qBWCI8bw1eRw5CL5l94L3DEOTI4DB8Y9OWmsEu/zBJ3rgsaybqBob/7A4C7jtWcooRrczr+u2fH2D0AOQgAUCxKEP7aGgLy64+m6KdjWFA9Yc/03/Osa4glrjr+AupqHz1sEs0cxG0BC9HIePLoit9eNkVf9L+DuUWByDJgaq4ybGYLPAWgiXmLedUE7dwC7saL7CqfPKXi4NYdaykCD410bAHlDEsNiwZ9wAPYbkJcfz6T2gm3N8YDZ9d/wHxUA+739fPwXPrSKYGb+BuP3jAFDElFH9HIWwbzCIGkBr/or4J4RYO8oMOW6ZVcAuvi1Cgoha04BCwT5gfMKHm7NoRde2+x41w5A3hQZkADk5+cGiAeMx3+/7AENFA8Yrv/G71cAXFM4Yzj+otOAaQLQA0gZxaIIZtMDFTigKJV8H9Iq6aZ59ZXAvSPAvpEKgBTtBODcSCWCZeRYtpzrmLyeGNCAyFl1v+Hei8qeb370Rdc2O97BAMi7EgB/2QG41nhAHU9LuWAbOB7Qr//GPRUA13r7Gv9FZwIMoVcEswEwfDoimEP0shKKtIphaZQAXv1+YM+wA3DEdcvRKkGJADQQEsQuhi1Tjt95vBsh5nx2IO59SsHDrTmUOStNjndwAAqEry0IyCMICkOyiuIBNwBvPFQQT7gBuPjc9oRYAIHyOEL4vIFEYVNaOou5vCGE/tV/A0wOVcnpzI47NOri3QFIBpSeaSDUdYLOSWvYImSGgftpJDa4MWJbAGxivGUA5MAOc0Be6eVLj7/4Mk+hzCOYPYpZDBiNkLh+G/M3yFyv/ltgL3W3YQfgcFUhgRY2PwY+Z7/EhAR1SFyXCOb57r28QfQBsJQBMn5D4y0HYLPje9Cd7RIC0PM3EiMofF4gVCBp1P840ix/gyz56r+vAMjk9Gl375iB4+CzveuZdLkkEPJ8ZEfX/6R73vOjzT5Si9hucLxHAVg4PwJgRwh9CKOXK8YA4ZEqKZXSQWh5P+5AftXfA/uGKvYjCKn72cctbFrZNECka5L5CPwIPtMH3TVz17MLB5gdLgA2Nd6jACycHwLQxFEUSR5ASvARDB0h9AQb9bXIgCGk6lUfAPYTgEPAITKgg1BObk58srTJgG58WMkWMaAbQQT1nc8rHGANAJsc71EAFs4PAagQestgC1lsBJ4BMCSOK6dDUcwqqaFiQr/0QeAAAdjy+jBiQQeeMSBZT3nCPUDIa9z+/MIB1gCwyfEeBWDh/BCAeQSzgkjFfGLBBD5nxQ4DxN0wv3hVxX5TBGDwL5obxvVA5YqYL5BeMLd66YYxJpRB0gK+96LCAdYAsMnxHgVg4fwIgMrhUPKQ2C+Bz0PmBTqBMQehAbDlIjj4F80KJguSVZ0FuXpjoCOgXawLjALhbT9eOMAuAGxqvEcBWDg/l1IE05Ed0ygZnyHdz0VwCqEPIfNyx0QQvvLDFQCp+8nfZk5und8tXwIgWcHSNX0N2CJmnAl3v6RwgNnhl17T7HiPArBwfghAS7mV/hey2JS9FvM3BLpUUi1YwDRMXvkRYJoAlAh2l0dcZ04s6JUTDIjyBcrl4yDc/dLCAdYAsMnxHgVg4fxwKVwJgGEJNmWtxpQMpX9on2eRhVA+O56AjMfnP+e3Xvf3NwG4xIPTleiY55bpGh6UbafNU0l0z0p+5Jh5HqYJ6b51nP6XP8cx12XNHQVgIQB/bFPVg2OC7Q+WgVFWng/FvtWLI06uWh5oguKEcXVS/9sEAF//VGD7t4ETDgJbF4CNi8CGZWBs2fPL/H6Vwp2KEtVk4fJ+v/EIYPN9wKa5qu+IncfPwXHVZe/aOL3EbwS7xv8A1rQvnO0j8PArTgTGZ4BxFv9mIxhOCGsv+0OPYDRghcLfkWkEuq0+G00x4OtfDGz+d2DbHmDLjL8si8AYP/7CGIAiEEMTG92zXqSbH+d9R2aA0XnvO+JjthiIrOVDHHPOkBrzUQAWAPsZp3oPDpa/Xag6EVkLBK+5rAnJC3/nYk/APD704WiEAV8OTHwX2LQH2DgFbJgFNrBhjd8r79deGoEwsllgNBOzy8CdjweG9wBj08AIAci2D6HafmyAk4/Z7SJ72hGYRwFYAMDLTwOGp4FRFgD3HhzqRGQiyeurqOdG6r0Rm8IEZjzRlkiqCWoEgK8Axm4BJu4HJhyAbFhDxmbDGnZO4j0SgLGDkpibgEq66TJw/1nA0F5gdLpq+zDqFfd5LMeWqu5HNST0uJOIllg+qgMWgI+HPv0xwLA3gWHpW2sC441gCECbmKziaGrnUdMO4aHeh6MxAP4SMHI7ML4HGD8AjHvHJGNAgpDgY/ck3stipRemvVhc+uASMPUEYGh/9dIRgGx8Y+MNbR/00uVtH0wEx94j/v0oAxaA8Ed+GBieAYZZg5kADC0QWGOFzGJlcGPzl1BxNLXD8sk4xftwNAbA/wwM3wGMUmxOOQBnHXzetIYvibonmSiuYTNjriVg7glAiwBk0fNZH6+PmX9P6kfNmCXGpftJ7TgKwBIAnln14BAAYxMYm5C6RjCyCoOyr0qkD/c+HI0B8DXA8N3AyCQwesD1VQKH7EcASm1Q+y4CkN9pUKiVF5nLvy+fBbTUd8QBaH1HvNBROiZvfsNnrF4kcvPwpdsBLBeU18Nf7AB23Dp4ecHC8oBgUlJJecLS+7+WOpE3gbE+HKw+yoevCYkMGKqPJrdEKARutaFYRs1fiEZ0wP8CDN8LDO8FRqYq3W10pgKgfYLaYCzootgA6KXaTA90y374TKB1sBozy77xHFZ536utRgAmEaw6g5kUSFZwSXnA330qsOlfgHMPDlZesLA8IOjoLypPWHj/11EnCiVwkz7kAExtsGraYUWdSDX5TmsagL8KDBGA7Bd30JsW0oWivnEOQNP7yGTSBR101AlZSUtGyfgZDkCWY1HnJdcBVe6325hTvelg2CQjZNDygG/2An0j1wKnL6y9vGBheUC8prQ8YeH9X39OVQSc7Mc6fCaKvAeHdCIVf4yMYCynTpX+nb97NJmlSQb8r8DQHm9YOFUZTKOzoXGhs6AxF0HIexcLBvWBuiHN8s2ne98R3qc6L4Vyb2oBVjfm9MIFHbjDCh6kPOBbQoG+oW8CO5bWVl6wsDwgfr20PGHh/X/1iaEIuDcCTIW/1Q4rFv8OnYiW3c+W2iKwUjKbyjQNwL1uuR6sAEgDgq1brXOmV81PxhNB6DUDBSYzQJwFtz623XcktX1Q1VWKaTF/zZhVazBVYA1tX5MazsGvobwe/jQr0Ne6BTh5uf/ygoXlAfG60vKEhff/rSe1i4DnTWDUACY1guFTDqLYdCBvf6DJYSMYATBfOx1kLfj1v1axH10nQ3Sd0GUkBnTfpemtBJgseIKQAHLQcVxa2TnuMW0Aqui5es8xBIegVdVVE8VhzHnLh65WMB9An+X18K6aAn2tO4ETl6vqbKuVFywsDwhevqg8YeH93/Rk70JE90nowxZbIJjvS3WYNSGUwGHJTpPxwwcbBuBrgRYBeKACn7VtpdUu/c0NJxO9BIxcKu4TTODzbkonPLoaL0vyUQRb2y8HsL1ckfWzMeuFi40Qezqi+yiPhyt7FOjr6/gCFwgP7Xb5vssTFt7/nQRg6MGRWmDRoeyTlpgw68GRTwgZgo1gGmXAX6/8dtaylSKY/koyID9BhzML3q1gAos2AcOrZYSoq/pJp1VtODRm9Z3LS/7WjVkvXOzEtOpKyGrlAT+4SoG+VY8vBGCvy/dVnrDw/vee65NBJiAjBIVcAJQjOm+DkCZEeiGAMw6sAwDZsJrAdhFM9rPGhd4904Co5oVuCZPV6kD40Ec6+9W8dBTBsfdc3nkpvnB82fp2RPcs79dHgb51LA9ofsDV6vut5/3PnxcAmLVBiDqgevDaJLkYrpuQxzcNwN8AWgIgRbB8loEBzXDwl4cGiDGft58SCOWGedgjvOJ+bPvgRkiuA+ZjzhnQQOiFNVbloa7l/fos0LdO5QENgEXlCfs8Qbf7HyMA3QVjYihYhLENgjX9y/qwxQmRU/asfd0ZcLU2CHVGyusJQLKfVi98CS12T5f7iECkHpsMkAhCF8+nshWH2I/jXsOYO144GV/9ApAIrS3vt4YCfetQHtAA2G+/4PW4/2PPbzMgmUMi2NoeSCRxIt2/FvuxWURIWCXg357gfTjEDNIHnTRXRCpH5ugKwGl3HpMBXQc0v6WLYVm/5limj04rG762K2uYY9jBkr9+rI03NL5ZbczS/dJ+LQyoga4o77fGAn0NlwdMAOy3vl/T938KAcj121z8Bn+Y9eWQJRz8Y6kNagDh2ey5EvxjxQD8TWdAuneCCO4An1vw5vdzQMmdktwq7pLZQR+dM34+ZumAxvY1Y04uqOAJ6FsExzeto7zfAAX6GiwPaLWR1lrfr8n7f/Rl3QGzmsis+/uO71V9OFgP2gpPhgr7TGRqRUT6dyvr4aIs/pm/2zVUNbBSv6G8e5pEv0Cvec7Po7+bTtjlBRlkvAMBkDeQyvsNWKCvofKACYBrre/X1P0/oWEAnnFD1YdjhtXxR73mX10FfCHHE9pVWcGAI/S0gKsfA2y+twrFZw6Hxf/F0Pk8Ri/kpGSnMuDx5T0iACgQHioo0NdAecBUHW6QdsV2/cL7v/Cyqr5gnc42CCOcfX1VIZ/V8We9IDmTzVXwPDJiXuKXPxtDBma8+lzP4WAgKkPxCUAPE4v5GzEuMX0PYJPLhB6FJsc7MAMmkVxaYC/K9gG+F1++8AQ7Gwbgk78I7GFpXgIwFiRXOwaJZPUbiR0yCUDRk+cHf+YpwMj9HgfI8ClGPyvsSiH0WSKRuYlitLb/zHM/JOSs5C/YIC9cMQDZr/dwxgOW9gtGYUBi0wA8l304vDQvAchilFbpIBQhZ7Ejq6ZQ0/Yhil8y4j89Axie9DAsD6FX9HOK3QtROTFkviN83kG4felIY8DCeLrSeMDSfsEovAECUFsTjHD+tcB+tkFgcXKvBRir7qtFl9owmO4Xy/1G3bAFfPrZHorFNWBFwHjQAFctIghj2kBarw06If/+MM9ZqTN6DgsDojCerjQesLRfMApvoGkAWh8Ob/tgAPSKWCp8ngNQtadjmTdltvNvn3peFYhgQQgh+iUmEaUAUoXM1yRLmWuFLaE9Z+XIAWBhPF1pPGBpv2AU3kDTALzwmqo6qtVh9kJErAudABia38TC5wJgS2xIhAwBn3yhByL4EhzXfRXxYsDTJ4IvrNN2JFMxZcBzVo4cABbG05XGA5b2C0bhDTQNQLZBYH1AVsQSAAU+imI1obHyblnjG/kJk3U8BHz8xVUQAhnQIl5CyNgKAGp5LKSSCoAySh5Jj79vTagcxUaIBeRNe79g9gq+DXig4wGzy+PONfT7RWFA4noAkGXZVAhcBckJQgNgrLiaNb3paIDo1vHHX+oA9LQBi4DxJcOUPJUnTgU2NJUyROs8irGARxQAC+PpCtsFd40H/AEf0gMQkLgeACT41PiGoLOKqyrJq3K/Ya9mNyr5FusN/uPLPIeDa8Bc+w3rtyl4VFHaMZc3i9RWBM9jjzgAFsbTFbYLRmm/YBTeQNMAtD4cBKDXBTQGdAB2MGBo8SCLmEuS1AFVAJ3A/NhPt0PoCcA8bSDG76XI7aySg6JYuGfKwJHFgH0E5B3ueMCe/Y4L+xVHAOZ+9EHcEgQgwbeiEYx6jwTdz4qfu7EhEJqxGqruf/RnHIAEnxgwBM0aC8aUAYWNBRCmoIll4HTqO122QcZbrgMWxtMVtgvuOx6wa7/jwhtoGoDWh4MBJ16WN4lfr8AqI0TVV1O1fa9BbQzovkAy4Ed+NgCQUSxZCFWvCOaOFREXyUwZOPIA2GdA3uGOB6wPaOz+QPv5S+MA3OXiN9aclghW+d3IgupBF2pPqxcxGenDPxfSRh2ASiKKiVP2PaZScvAKoA0VDc6cOlIB2GdA3uGOB1zR77iwX/F6AFB9ONSOQW0frA50sILVcckWJyIDSgwPAVcJgFbYuZ3FJvAlEHbJ3IsgJLGedeBIA+AAAXmHOx6wo99xYb/i9QKg2iAIfDJEJHqj4SExbEty0gkdhB/6P9oZbBZIGiKYVb9GKaN50lRHBLOvhDxh/5EKwDUG5B3ueMB2QGM/grb7/6wHAPNGMAY+GSGUjC52VX2f2CD4+HO0gqkZfegXKgBaHkcWtS0AWii9xG1ImrLlN5XR8L8fmQD05BVrmEENmpYSP9QX+KHiqj2/82+HqqDWwnbBRfGATdzAegGwru2DpRq7Mzq2fpAf0Nq0Rl2wBXzglZ4yUAPAmDSVWDBPHQjLcgTqOZ6zUvdKHh4ruDCerox/Dnu7YqwXAC1NI/QcEQuK6WK/kdgCTGC0PYAP/KIDMBgglq+hIkrOfsaCviLSofcJgJ5AdM7kkSaCj/HqQKVIGvD4swF8bcBjmzjsaQ2H5D/6acBd9wALB4DFWWB5AVherMp4GKIYEOp7+26UF0aSfT/xYuDG7wDjrIpAERytXf2vajj7ueryQXSFl10K/ON3gIWDwCLvjfGB8Z54O+Ee4ve6513uB2R1yzsqC+twbC8HcNVhfAeaBuDP/TvwtS3A/ePAIfYFVlPq2HHTuyulZCTlhbjhETF5yxTQGgPGhoHhIWC4VSXGD3n0tLkMHXHxu+YyB+MlPwDuZs5K6FlsbCzdVO9DuKfkHM8AEkP7B8fOkwDcD+B7np42+JkGOvKdAL4E4K8P0zvQdET0b14D3DgB3D0B7B8HZka9WzrD88N6sFm+YcUjrn7E1ZDvMtF9DBgeAYaHgSGB0PNHCD4BLwLRsByAyX/ij0/dDUxuqlIG5hix7eFhvLcOVUAtyPSydAFmOQNe6EYGV/9ZESiKgIEgtbaD/gHALQC4ovY5r5KwtjOU/XfTAHzzLuCmIeDuMWDvKHBwpMoN0WQzNtAaYSs0K4ZlOSAjGG9kPjCBRwZ0ABKEBJexYAZEAU3A7Oi1BeDym4EDnjQ1TwCGWMW8MXcKks0YOyZNlQOQjcgYIUHllEzYQ0ktm+r6oz8G4F4AXwXwRd8/kO9A0wB8y65KmPxgGJgcqYJTKYpTv2CCzyddQJRDOjKivn+Deh8BF8BnwBtaCUA+YYEyAU8h+c6Az9gNHHRmrgOgmDA3jHQ+iWupCeUAvNSrA9HNwqx+muk9nJVNg/CTfrmbAPwbgK8D+PcHkIibjob5o13A3XypWsAkG1cPA9PDFQDZM1id0i1KxsWfOrKnAFXlifCFFMMRcASigOcs2MGAIfE9iWXplS6On7UbmPaUUTXQrgsVMzcRj5Folg2V5ayUA5BWYKwOxKUafnosWjcJwk+7W5F2EKvlE3xcXaNYfiCYsGkA/smuqug6hcleAnAImPbO6YwRpMgjCAVAm/yQmKTv5hNsAf/i7SyNBSl2a8Qv/4/M1yF+BZSYlNQCnnVrpbC+mToAACAASURBVJcaI7sOSEY2NpaDXLqpR+vE/OVksDgImgGgghHoYJbTWc7oJtFWc65/cg2AYvh2ALsB3AzgVv95nS/f4QdsIkT9T3cBrGtITWZfC5hqtQHInsEGQn3UDDvEDEY/ICf7SxMOrAg8T+c00JGkvHGd2DABUYZIAONzCUDppCFhSukCBsLQrFtZe/IixYQpSyEoJoqnuPWrVRAubQh83HNlZB23z7j1ywmj6CIIqUPxw2Xeu9bx2jx10wz4Z7sqTYZaDD8EIDuoE3hMVEphWg66JIp90k0sBxBcy+iPIIaT1RtEsHS/yIAqw+VSNPWQfe5tlVEk8auXgVa5BUsEJuT5uoliAbE5AGotmIAjCPnR9xDG3TQernYAUupTdBGEFMf83OkApHG+XlvTAPwfuyrgSZOhas3u6cwTsUBVn2gTwyFMi8wjHZAA1M9fYGHDULJD1m8Cpa8fRxDad+l+Ykf/3XNvd11U+qiL39SxXevSsshdDFvgbI1O2AwAtRZMZzTBRuDFjxe1Xg8QEIB8yyj5yYIUxfQIkfkIRnmHCM712JoG4FsdgHHp3ACoMH2G6jM4lWzoQarSvwQ6MSB/vporVaFkh+mCLlpVR8Z+dqDZLoDOpHSiQeAFDkBjPrlgCHgCUaFifg67H/9uYjn4Ai1vpTERTAASBaoQJBAKeNqHlL6mwPDZYAOROag/EYRkPX34MwHIvzW9rQcA+TLpI22G7EcQKlJGsYIJhC6ClUMiXfBTbFUQAej6nPS/OuAl9pOOqIc2BLzg++3VmWgIEUz82cRuCAtLIHQQm0gO52uOAb22sC3JEWgRfPpZf2sQBQIgLydPEIFGwPEj8MlF2bSbsulghLftqsCXq9HGgHysznrGgi5qzTUTFH8FLhAUn3hIJwCN0HLncw37qaF2zoYvuKNivmQIuUNc7GvWt6sHNs26twA6vhyq8NEMAHlyntFrDCcQehyaPTl+FwAbXDcmAKMRThakEk8Q8kPg8SPL0qzLBl+A9QCgR6uZGs3vfHz8TtBZvkgGQrEPBVAUg2Sij50QAOjiVKI3saADJRm7dSLYWfSFDkCem/dhZeMy9pPY5QvSDYQyUJoDIK8qMezh3wY6fSL49PcGgCAA8pScJLIgAUYQEmz8RPA17StvGoBv39W24eREiBoNQSgWNI1HBkdgxJSw1AI+dFIbgOYmkjimQ1r6XXC3rAbCHycAgytohf8vsB/r2KRaRq7zpZ+D37HMX0s3DDcCUGLYaw53MJ4YUODzusqlGCQAOQCejuxA8UULUkxIwAmMAp8Wa3qkN/R9W+sBwOhIEPjk5SLr8HeKFbTQfb77csPIMHGl/4MPbReslPhNe4+MiTpi9AFGV4nI7MfvagNQLh/pfrYnDAS8aJQ42A2w4em2cAyWQUuJVQTGWLs1uL7DG9J1RjhA+jvYk4t3KXeMqijpzrud4At9z3XtP16yGfjKZmCGooYh1tZzvv8xXPFl4PoJYC97k9FlwZWD+Azi/deMZWeP13eQCGEyoERudChIjbb3mJYwH7V0QIKuCwj/gfMj0asn2I0FXRSHXfL/iRkNgLyeVj8ccMY//J1fyxzTAXT2+xoQViKYD/1hDqLxPiYxTgSvQrphphG97tz4Slqafnj7uk1kIQDZrvWTw8B3jwEW+RLxPgSiCERdPwPR7+wCPg/gulFgfruDkOMQkFc5x84e708JAMmCuRNBXi4TIg5CGRzGiBGE/D4E/C2r2vcAYJoify62i0aJSMhB+2IHoNwu0fkcjQ85pu3ack5nIBREqneYFyWLkAXIJHESe00Cyx5QyeL6F/tyEcDcrOW2n7fX8df0mME+/vQ/PQjhoy3gzo3AISYf80MQaQx1peH9wb7v2mrtmCBkIMMejp3jIJD1MsaxaMZ8v5N/67INAsB3BAYU4JL4DSo1J15AFPAEwuQHZJzkKfUAtOHLJSOQRWndBYQvCQA01cfnNopfsaCJaD2baBn79QjSTiOEP1EcawIpkq2kegBTNgHWEpOKF8Uwq2NRFPM4AqCf46/rA2U9/uVDvurB01zvAJpiiwOl3fEeciCGF+Ij11f+QkbSfMPfIzqw57mEFZ9Dl3Ps5HXWAYByHJAJKV7N+s0cCQQhwSlfm4lGZ0KB8C/rABgZUS6ZHITBSEhCowUYAAksF7cStWREyxRwtuPpOlgw+5s9sq6OaIJIIlUgEhA1edoTgHxa9HVw5jibZNF+j/9yGQA/7pbujZ4bwv2+cWB6tFo0NzYnkxFA+cvEAo43VBoEo2e+48EMXEOmD9F6xhCE8RwZEJ80VblKvDlmzwicfqy93/o+8K8TwB2jVSgW138FrJQTXBNlnJgmrjZwanow9CBP/rL9wF0jwAGWDtFyoN9PHutnIHT05mPXz93dMGQAPniJsjiBXiTbxDZFMF9NLUPQxKR5qezz1Y6/YZDH0D6GkdAkYJIvRalAdHAMmPZoYhb6NhDWvEyf/ma737CXN7R1ZC7hUbPgcFgqt/ZZjADnM1xqEVhYBpb4CUk5UsL7jQvj///5buDrLeCOEeD+YQchYwG9VIfyg1NaZszFiCH6DkRGLze5/dgk8IMWcMCjdCiCzR8od1B8OTwvJM8JEShFut1fzMhi+eRJr6LI7hYP2M/xVLwKNoZjUTwRMAQQmYyhWGQxsSADOflZ4kukj7PhZ75bETjBpkAGahMkcrGgwhsXeCyBHBj1wmOBQwvAwqKzoFeRV8ZaerjKYAuirmPY/o9X7q5Cyr7fAvYMAftCPGAEoYlBiVtFwLjtp2U4irj7yOANbi+crHyrfCbTquJV44O0F1FrwQGIMZFqdQDyP/gGSZ8TC0ZRRsOlVzzgasd/u+zpMByLehAfCgMQCDyGZJHFCCgLZ2f8mgI5qauEcVx9e5vACTgCTwEMWr5TdIpWKJb5MvrnoocDswvAPAG4VLGg6UKeqmi4iuDz4er30oX0FP7u5moMvIf7W8B+jwlUNAzFnlZCIhvGFRCeWzrgXSSIBreXTFZSgVLHAp4UHOFuociEEsn2PJwl/XEk0dzfSojeerFg1IOo5BKAveIBex1P67lgUzgWQaJwLAKRH04i14ItgDKEtGsRnWx49b2Vkk9wUefTGrKCF7R0JxZMqxN8cmPAxWcAcxGABKEAKPA5u9lEaAbCmKMI+sDN1X3z+ro24wEZFc0VEE64ABgT180PF9ZdBcDb6JpqcPtPk+1ACbmKjJnllwyuILunEAWjZHkBsrsRUnfD0qEiC5IJfyisgMhzWhcP2O14Ro4WbASgAMQJ48SJwchmBCDFa8qpyBbSP7OvU4PQ0p2W7+LSnSJUFOrI4V7w5IoBTQQTfJ6oTSYk2mQcpGRyH2syGjIF6EM3V/fM++C1CfwUExhCsmzCaQT43lZC3e1hBpEHh36XEqrB7Scmq5dV0XZxmV8WuDFzAF9iwhow9seAGoBcGtKjqAc+1l9rLb/1igesO55ysmCrC8ei6IxRMAKTWNBi6Xw98xNTFUi0jEcmpYgRAPhddpVi9OIEPP5cYD4CcLkCooHPwaW9kV+iwWrQHT8uA1fd3F7DFvgUHUP2k8jTiogAqLoxFpDgbMj9jXSuN7i9dLIdaxzBp5XVBMIMgFEnFAPKT9qPd6A9BIGI7MfPmf4U+40HzI8nWgq2PBxL4FEkjKJixGRRFyQQPzzd1iAUzCAQas1YOmAEoFjwkecDC/PAwhKw6CxIkCXwOdVJLxTobMjBdyIgfvimNvNJ7Evf4jWtdnRYD1YNGVuG93VWuWs4Jf+mlZCCZxwP/cnJ6mXVKk2+tK8lQQVHRTGc64SDAZB3Ey3JcxyACkToJx4wHl+YwqloGDICmYmTFgMQFBET8yyYzyAG/AfWX8mCGQg0BTRoHwt9KVaPE/HQ890AIfgWK+CRAaMRYnVdxHbhdY8Wslw1V93UDsmPIj9GxgiAioRRMIJNvoti+SW/Ikd0gwAU8+XxJcbGITJPDvI6XdCFREFSknTB83xka40H1PGF9dnycCxFwygkK0bASJQSVAbAYeD98xUAe5U3jKIwBosSgNsuABYogl3/IwgFPrOIg1Xc4ZrpAsSrvruykl2ucykapkMMh4CExD5DwJfWAYAxwk4MKPAJgOIjGSEGwuCakRhemw6Yv0UUwRf7L00L9pnsNx6Qx4feY4O8pDEcixOjsoTKKpMYjSFYYjOC8Eq3Wnnr0YYS+0Tmi2HysrPGLqwASNYzBnT2Mz2QD91laxLB0gs12GAh81cf/o/OcHyJ+qj0S/zxnhUZbSyYWaL8+Rq2S29wowiWkJPan4MvgrDDGAlRe7KIywDIgR3meEDWg9HbJgApNTkXo8o0i7oVgxnEgFr8F7jEdnU5GvqfJQKQKyEOPlsNIQvyvupAGHS/Okv4qv9oh+PHxMLk8ggBCRxvAmEN+AiEzz2iQfQBeNmkh4K52hJBKOaNe/FSLobLRXCz43rQnu2yi9oMSMDxs2jo8303ERz1wsCGZECF4kd3DwEYYwJjhoNlQrgIjlYodbBPrwMAZfEmyzcIv27gs6XDzC/IR1DOgA9a6DRz4wZAsZ+LYXvQYsHoD4ziOFklna6YD3+nnU6dZ7bGDAcBUImIAmEUw/zbJ1i/scGNDJiLXmle3RhQ+l/aq57gUQCWzwwBKPeLsZ/LFrGg/ShRXAe64Ajkv30kALAjF8R11Dy3K7KRwJcsUTaqWScARou3w/INVnCH+A36n8RvM3nB5XP4oD6DATBYwGb5ajlOLOh6X8JaBKRG77+7ygGYp1bn+V25/01AzBnwQ1ypanD7KWfA1QDYC3zJIj7KgOUzc9nFbetX/r+O5biwNhyX5uSEDr5o0xsJwLp8/m4A7GaJUv/j3/5+HQFYJ3oFPPkho/hNeqBcMkcB2BAA6XrxmMBkfFAci/m0JpwzXw0TXvXtzrz+PKc/Ml/ugzM9MDqCAbz/keVjjGcQA/YLvjoguo1mRslRI6RwfsiA5nqhL5D6nscF8gfTdfxpS+/hLzvWfzMQCoB1Fq/8b3VWaPIDZqsRV64DALsZHVHs1gEvsqFAeBSApQC8pHK90Oql4UEAyvCwNeGcBXNLOPMLftgZsI75ouUr9ousp2TEyIJ/sU4AzC1e+WIFshyAHPZREVwItrrD3wGAhibTYBhxVpe/xePyrNBuWaoNp3DgFwC81O+RAepK/a5Lfe51jxr7JwA83nPXYgq1asl0yX5N48+f4VEGLATlK1vAo5YB1gBSRmsM+NFE57lcfPD5pPFWCJImtyvGgGfOAacBYO59zFglgHgPefZsXV6/gPXBYeC0RVgyJNOGYuJjPka9eHWgjL9bWzhWk0/n/wPn+k8bgFNmgYcsVflZnBRmIShtJM/m7JGibGBoOIIez9wKPP4AcNpylfbNlGfdI+9NjBjz8JVzppckZuJ+dBw4aQ44drk6j1LIY9JkPD7P4s2lwVEGLHwJnncscNIh4Nh5YMsSsHm5ndOu1BGFThJ8/K6JrZtoslST2+XHA6ftB05ZAE5crgAups5TfaL6EF+UyIif3gAcOwtsXep82eIYY9JkXpMgMp/AeZQBC2b8OduBYw8C2+aALQvARgJwGZhY7swEzbNa88IRvAVO1qkF91J36DNOBE7eD2yfB45fqphLnevzdGeBKBfL8UX5/CZgyyyweRHYsFwxYHzRNK6oetSBMDLjUQAWTPqPngpsnQK2zgKbCMAlYMMSME4ALrcnR6JYQIwsoUnjpDRstOLy7cBJB4CHUGwuAtuW2nUDVH1EFUhycSwWjGD64mZg0xywcaECoI0z5P3X5P6nWlHdgHgUgAUAfOYOYMtBYNMssHEe2LgITBCADkIzSJZXpCOnIg25uPrhgnupO/TyhwLHHwSOmwW2LVSik2pCrDsQskzNIBGIpBdGI+VfNgMb5oENCxX4yPRjPj4xaJ0+WGeEHRXBDUz2Mx4FbDoIbJypADixUAFwzAFI8KUJChMV2SUaAGc1cE/xFJef3FYRti64nkqWDrqqEhbrsm5zvZCdPCd8nHzJOLZuABRz9hTHZwPL7LnLnoNMIY2VyaKcjtZLHOAbNgNPngKe4BacfGF1pnydD+hphQ/8XV5UiEueLGnDN1tWXj/3/4cTwAUzwGPcRcFJiDpPt3FLmf5vjwE2HAQ2zPrEzDv7OQg5OSM+ScYQy5Xbo8465u/ZfLTJ7fKHAdumKxVh8wKwealSE6inEoSy2MWCdbUHIghv3AqMzwHji9VLZuDzD8cXxxWZs5c7apmW0fMBnIHKn5X7d6I5npvRz94O7LgXuGIReJSb+Xl1tzqflybwRwqf9i97BQRWomWJQ7oZVFtJoqDX/b/oGODsvcBTATB9gsfGqmzdjtVz+G+PAyamgYmZCoDjFE2anCVg1CeJwOMnTRB/DmUINVkkgia3y08BtkwDW+YqAFJFMD1VAAw6XG61R31O9/fdrcDYPDDmY0zjc1UjivBuAMx1QdMB+WAYXU8dhEU16dOSkppbcHFSrng8MHwnsGMPcN5ypURHp2xMIa7zDz2z8Gn/kVe0YomO0wEwBYKujL7v/zHA6C3AxfOVh58g5AsZxx4fZM7sf3h6BcDxWWeGBZ+cMEFiwGEHHRnDzun7ONHs/djkRgBunql0VDOSHIDU3cxSD4aEajhFXS4H4S1bgVGN0V8we7E0Fh9jVDG6Obr1LJMRwn+kOCaTEYT0dsfqZHXl/p7PrLi9wIY7gO0H2yAgCAWCWCowKrYE8nMLn/a7PQn9X7zIJPPkCcK+758y7x7guNsB6l98gZjLLYet3Ay5n0sv4R+fCYxPA2MOwLEAQLIDPyP8uBg2cRYmzFweAYilKkn+OC8/Fdh0CNhEA4nGA40kd6FES13WLO8v1qHKAfh9B+DoYjU2Ak/js/8NAIwg7OUb7LCC+WAfB4CpBJoIiTRNRmS1l13kqWh3Adv2A8cdqqp1MB+aIOSxWv6pq5D2kkIAvt8rF7BLJksN/jMqfa7v+7/Ak4B3A6ceqpasKMq5akAmlLWY37t8ZW97PDB2qALg2BxgAFwANEGcnI5JcrDZRPlkaXL4u1KJUAfAjbTQ59x6dSvdLPXAgGYshZWR6JIRaXB/NwFI8C1WwLMXzMeSwLfcXuKrA2G+wrLCDcN/IIg4ERRn0qvyySAQX6mG1XuA4fuAbTOVwktRRr2MLCoQyvEZ/UY/WwjAj3jtFJZkU79g1ghkgEBf98+0Umb/3A2M3lkBl/fOcdMok2EjkZyv8773LAfgHDDKjwNwxEUw9yailpwdxBAEYhBbAuGzG3aKkQEJwAkCkOCjlb7Y6SYyf2UwlAS+vKYnAXjfNmDEX7DEfA5CjUcsnzvbu1nDtUMmCDkRZEEyGdlAk6G6lQTSa6m0MP6HuY73AxNTlcJLZ6WOJYC5/CNxLpHMgdKIKNl69Qvu6/75AjHOiTU87gKOOViJb748BKCWrnK/maTA+58AjM0Ao7PA6Lx/xBAupoYDC9okBRAmPdBZ47lNA/DhwMRsxX7mPgl+SrmK5EaRNRslXFQ9CKB9DkADn79cZtkHFkysJ103eBbqlh97DpmTQTYgk9VNxu+xYbXKU3lhFoJPOgdFGY+lPkgQxokkgF9Xgj4AvfoFs84eX4Ke9x9fIC+tRfDxvvniif358sSir2LCj5wNjBKAc8CIi2AxxLCzIAGY9L7AhGIKgpATw4l8wToB0JjPrfTkp+SLQbHrOqm5jNyajS6VCMIpApDAWwQ4LrGgXqzIfnq5cv0vN0ZXHTInME5GBNLb1DGdOYQsI7AfGKFjlgqve8wJwG4T+fuFAFytXzCLb+VgWnH/fIGYfc46Hs7iHC8ZkPcdXx4VfVXJw8+cA4wIgM6AHSLKWZCTESfLfg7WsIyRF3ckiRQ+HACXkwHptyP4KHrpJvKVGnOhRF9eBF9wE0mUEogz2wC+WGI/vVxiQQIxAs9+rmHA6E1YFYB8DJwQMZl0OrLZ++i7sfT8zroYHLS9df4RACWKxSZvLXzG/fQLZqk2gqn2/vUCUQ9UZaM9wDaPeSPrC4A5C1KV+NITKwCS/SiCR/jRBDlLmP7nHynsxno1IPwJSyRpbiMADXzuPDYfZfBTEoAmcuVQdiaW0zwXwQsCYDYmMaDA1wG8TBSvaoR0G77EcGSET6hjOvVApfRPAUN0zjr45JzVcSqiTxD+VeGzXku/4Nr7JwDJOkxFIwt6j6+RqUrlkO4bXzp1gCAAv04AzgLDDsBhKugLFUvQUhTwCEKbnKCw14HwJ9cDgGQ9WegRgDI8XEcVEDvAl7lVlglAgi+I4CR+Zf1mLGgMmDFhBGFfDCicRJFERviSABjLS7FC0MFKMU+07wOPE0kGvaoQgGvtF9z1/iODkwn3VWoEXxres5ib9xx1wZufBAwLgAQexbAD0JiQwJOuJBA68/H3Zhk6+3CifqqwWNMKN8wjKgbk6gWJgC+FMaBb5vJVmsUbV2vCqo3cRWZcCIACoax53+ulkqNd7iqOcU1WcC9cxEm5kQBUdZ+sTnSL/jEtTWngi21jhJNJBivZBukXvOL+yYBkcOqxKjJ4AGgxzMrBVwdAMmHrZOAYF2l6y/mwV6xD17zmWo6MbRyeWtOHwxJ91IIhr6rqZS70DPPLXDVUrfBwzHKr1EUp6/h0T/6L/GcCqslt4IhoTcwdAqDSs7I60WQH6R329pHuFyuXDJmEjuOSbdB+wSvuP5bGUjmsA5XoUvcvBXKKAQnApUdXwah0b8jXR2YzJTsC0ZHB33FL+2yiX3h/1YeD1fFZGT81g/H6yqkVa9YEpqMhTADle8erHA6t7Mh6j4ZBXdBGjFyO4CSIm9wGBiBvgqxwIAJQlXIyEJLyI/i0SkAG/FbhaEr6BXfcv+5dLKhCg4z1C1HEBJ8+BODQGZXfk/quAZC6ketAZEQCTWAU8PIJt0fgwHzZvVWNaKqi7JLOmtDWFy42g1FxH/XfqGkII0C+a0tnDkfsGxQjn3VPsk7tXmuy+Xp0JhtoJosAaFcUAJUYKiYJxcqHqKAH9rPlG2cMrmCUbMX9guMLpGTcCMKDlZGhMK8IPnPIn1X5PA2AwegwEEYmDGBMjOI5whGQP3NPBT7VJlRNaKvF4t2IWHbDErtDlSk1p4lJ7/zd246tglGZryIfrFhQ7pU8WCAX0ZENG+57U14Z4YrCeLrSxXdev6TfLwrbxT7znMrfKQXfHLQCnyvmRIv0Q3430ezMmL98P393G3wqz6am1NYzzoGn+svqRmTAU2citctqAX/2EI8F9ACEmLHXLZGoFxtSl2xyK2bAYwrj6Xr12+1noL/jUTCD9vvFrn6u0v1/nvGkaoVBAQi0eummMAuXQHMWJAA7gCixG8U0gFfcXdlBKk4Z6zELgAJfZEKrxpC1xOIl/+Sk7jkcdYlSco90y9+gK6vJrRiADD0piad7RuFo3udNCgft94vCdrGXn+tujgV3QAcHLcFnroelivHkchEL8ue0uQ74S3eubAITS3IQhKkMRjBMokgWG3L//2z3VSnP4VDgQWxUEEUxAZFHL0eR3HDfm3IRbDHkBfF0zy4EIKNhSvr9goGEBdvTz/MIYQLQdVsTwRTFDj5jQmdArRDYJQNDSs961R3tPhx5NXoVgoxleHnarjohgLec3D2HI492yQNvIwvqO9fJm9zKGbAwnu6FhaP5pFuMg/b7tTbpBdvTz68cz/zI8azVj8iAHTqgmFHXDUB89R2dtaC7tUGw4kDOgFb0R2wYRDGZ8g9O8aU4XwPOczhiwGlMjqqLWiFYGu570wADFsbTvaxg8nkow7E8nM/atfKzln6/1mS4YHv6BQ4+Z0BbqHcd0NwwYbVD3+1yWhXJxPBrbq8AqE/XApSqAxiBV2MZ/54DMOZwKE00rnDUWcR5KiV/brjtSAMALIyn+/mCyeehjIYp6fdrvVELth8RAClyHXxmhPi6r1m8FM0ucgk8+y4RHC1kAK/5XgW+2hZYofafWcPq1B5AqDqEYsQ3nepR2gqhV2yiol1COkD0C+aOaoGx4aL7DQCwMJ7uVwomn4fm7VrX2u/XAlELth+5sHPtN+l/Ap6sX2dCsZ/phZkIJgv9l++1wbcq+2WFv2NXIjNKAPzuw7MUAV8DTuynFIEsQy83RgTAhiv+NgBABaQOGE/3mwWTLwAqHnaQfr9GnwUbARgDNBUlkpzQboyYCyYDYdILdf0l4NduW9kGoa4geNdazLElKoA3Prx7DofiETtC6XvE7hGEzJlpcis3Qgrj6d5UOJoYDcMglrX2+y0NPtl5UZUjkfx/Hqbecoe0OZzdF1gHQrln9Bhee4s3f3Zxm4MvAk9VSFdUIw0i+Q2PaBtISiBSSFgCYMjMW00MP7pwvvLDmwFgQTzdHxcOSGvBg/b7ZRZByWYAlOERluKM3Ra9CKWc0q73dTBhMFT4ZwIw9l5Lrpes+HjeBiGCUOKXeuBvPcKTiEIOR0f+RhDBMYi0Lhea4GTaa5NbOQAVDzhgPB1La5RssV3rIP1+7yy5OAADoAchEHBkFbKfGRpiweAPtMs5IFNokyOGk/7rAYC9OhBFwNXVY1at5tftCBHaWVS2AJdEcEinrDNC+Lumiyc1B8AB4+muLARAXTDCWvr93lR4/Z0Xt6ODFQkj8WtumEwHTKDLQejAfN3uds/dfjoQdatGLxb8jQBAYz6/boxiFgAVudzNIc2/s3xLk1szAORoB4yn+2DhaATAGJCtbpkCYq9+v4V+aBgAQ4i66XtaC85YkDog/zdZvzUgfN1N7a633Xqv6fe9msDIHfNaB6Ay2JRE1AHAEDIfI5nzZCLeN4Nbm9yaA+CA8XSsul6yqV0rJ2WQfr+splCyCYBR/HJyKX4phs0PKBZ0lqOYTpvniAiUAmAd+HKjo1cvDjHgr+3wPJQsVCymUZrPMuRsRBDG4AQCsunyJtFGHwAAIABJREFUcc0BUJlxQoH62q8ST8cggpKNAFRGwCD9fkuvbwAkyGgJE3C+Nz1P1q9/T3F1EZBxvZh50s6AEYC5yyUHXt5/Q8zI5/KrAmAIkkipkyGPYwXz1aRT8v5ZO6jJrRyAvKOvNXlLazsXs9bo/ztc29Pohgotp5J49Rcj/pzfIwGS//3OM4CNd1dpntQpFUmjEH4LYIgnyn/OLjL8FeDGhwJbNgFjI8DIEDA8BAy1PFK7FSKf43cNKrvHx+8C/vmxwMgmYHgEaA35J0StpvvzL/nP8RbLAfhyT207TChgDRiu/ZL9DsfWNABvYzbhCDBKoBAk/pEobGWTqp819hzQ1/0k0PoaMDEJbJjxVZFgDad0SaUO5LksWVj+XScDmw5UEUDJ6U4d0nVbC91S3ovfVHp5al64cgC+k7mZAP768KCA0WD3A/ieLz090CDceVmlAuhBljLgrfcAw6PAyDAwPFwBkCAbItM4a/FiNtERjBl76W9ffD2AbwJDdwFj+6syImRXrd5Y2FjIYcnzWPLEqnsfC0zsr6qBMQmfIDR/pyJ6xMhKyMrSDiKD2xja6TADTt0/AGAs1KcAUCFrOLF6tbtiRVFavT/wuMCa7MfVTlH098YBeBcwNAIMEYAUlS4uBULOmK3LCnwOPANlEIOSoF9+C4DvVoWXhvdWZVOYqWgi3vOXDUQhgieB0EElViMYJ08HxqeqnG8D4IIDkAzo51DKQQJvBKUmKACzbM4+5hUivwrgiwC4LzvjmgCh6nBcgiMTcv9Abo0D8E6g5eCjfpUA6AxoQIzgi8ALmWwC4z//DxcPPwBak8DQFDB8yJPpPZHeGCyC0KN5DFCByfh9/+OAsekKgEzCTwD047X0SCPM1IYQjCv2E/MJoGVwUUQoPboq0MdqkWVn7RtDDMahB4g+P6qhXFpjVtkDtRGA2nKjos7IyOyHFUbIrXe0FXsTuzIYfNb4O2M3ATGIYQOmPn6hG6gi3eUkQQAeAIYOAUOzALMVh2pAlESqGFBAXAYOMQVjxll03iO/yYKRAT0FQXkwZkjp1pz51LO2XAT3KtD3AIAwj4Wg05kfiuUHYlsXAJLVnP0INLM0OYFx78AzcRySeTsw2AJueI+Dj2Fne4EWKz5MA0MzDkCCkAByUWqsJzarEanzj2zXwjEGFHuGY+pYsMojzZL1G9EBexXou339IRBrC3lJGmNDuSHX+w7WC4Cm6wWxm8DngLTImgC8pBcGBuTXf/1fXnyTugnFwxTQOgi0CECyIFlsvvJfEnh0mhsYI/s5uxFYi1xZof7oOqSAawwYjRGBzYGXbtWXaCIrlvHUagX6SP/ruMVYCEbEqECXAMjfree2HgA0ESur1/0vtnNwGSsG0RsZME20/+/XWH6Mugk/yngPAGy5GDYALjiIHIgRUIrsZjM7Ax+BSx1S4pfffQVIep8dL7dMDsTGjJB+CvQxTHmdtrw4l0CovFruC2NOe975egDQsCXRK/eK634JhBK90q2C7I1i+Gt0jxF40k1cPJAB7UP2m3MGJAAFQrGei9iUTH9yBUDTHfU3B5+BOIKQ43BWtNtPcWIOzEZE8FoK9K0DCGNxLi3FqaKA9gTgeoFwPQAoI0OulWT11oEwiFz7cwbErzNxWtEYBB+VY76Vh4DWrH8IOoGQ7Ocg1CqMRLPltmxvs1/SHaP4dcAJePYyyUCRIzrTB8tE8FoL9DUMwl61kQQ87Rmy2PS2rgB0a1ci18RudEJH57OsY02y/+83/sZdBKr4FXQTApBvprGgQCg9UEAM+h9F6ugJDkC3gJPBEvRGrYoYCBX9IxEcS5K4i6cZAHIw8oXQ4mLBb35YH5d7OekadtTV1UZSjaEIPH4nQzYNwgjAHNwDuWGYpZc7lzPfX1cQur5oBorfzDf+zi0yVTuSkuxBI2Q+PhQDIUEnMLo1TBCZLufGw/ixbQa0KB8CTODjPohdY78IQmfDjmW7Yo/doAX6GqIiAtDHaYswSmeMubV81kp11L6hy2PdAcgblfslOKC1IiKRmyRxZgV/8++DS8BFrxXi5Hd/U6MeSKdqEsEKhpBRsgRMbAtuG4KU/+9ry5brzP/lPVMv1EPOQegharrVcgZUhVHFxNPcp9VFtlOWkL437C0WABWypFRGsV0sb5Hn2zYBwvUGoKl10v1knDgo0y7XA8Pfv0UACnjaK33Co9gJQAOe64FkNvtZAHQdjz9v2Nz2GSa3jYej2W3KGuZ9ixGdIVSoKT13B2s5AHkGheST6qn0erHv5AIgAAU+LVfw/wq3CEAV7clBKDDGZG9/5oVXx/oyYARczcqH5GyH8eFplTawFvAtrtXLGpNrQDGbejupB3omlIHQGc/ErzOcGSRs8zrhAbbuL1Tco/JfbLlNwHOmi2kIcs3owbdwNpYtynDQhsFcgvuG9/YapGFvYX22zZcAU0/GwA2LJ/4AmGF9mwEbBu98Y3cMF+uAGQCj2HVp3BbPuo3IlqxAy5wHAq4OfARmEBXGfNIBa0BIsG0ecwC67merHgRpZLwocrWaovuTxew/V0txJQ2DWeae3WAGbdhb2DB4+wRw7w5g8Qpv88liyGtoWHzMi4C9fAEHbBi8kwUKu2xNAdBxaGBLbJdZux1LwAGECYAEm6wyfpelJrEgFnRDxESwgyUxIUsVMwjVy5AYO0bG89Auu1/5BF38KqjBHlUAYXsteNCGwTeWNuwtk4JMkrlzGNizA1hm69g1Nix+zDOBW0aBeRZZGqBh8M4emfWNADDT+zqMjQyESdQFHfDbZECCLRgdHeCTe8CBaKJY1rDnBRCIAuGW4TYAZeFG8ZuMkGiQ1IEwGCJtHZBmy1obBsvVMnDD3jIAerti3LEBOMjGcOpa3WfD4ic9t6oveDtLfw7QMHjnH6wPAybW6yaG4+8D4HIQfvtDIVtLejpBFsVvUI7NIBHw3DUjRzL3rDVtsYPOkAScuX3coNDynT2VYJCkn+PjqvUD8hVbS8NgjphGxcANe8sAGNoVY/824BCBtIaGxRe8pLKZdpMkTvXiJ2toGHzSNHDPScAyq3er4qPyGaNc7JCRXWLT2TjwGmCOeQashq6+qSpZmp8vojQpheF58ncdZVjLnjWPHr4VWKTKxrHGUqq97qXu3jp0wPy+eEC/DYNZsZAO6IEb9pY9lNCuGPcNV830ZmkM9dmw+OKfbdcXvJMPdY0Ng0/7GnDXKcDMccBS7MwdKz8KCAKQIgY0MWGCtr4TOHAasMwOkTqf6unyuLykfd254nkb7qsw/iVg7jhgmSX31Vpd9yRHeLx+zRhjEGRbB6wDYT8NdymyubzDzCCGfpMJWfSRYfr9HP/aMgBm7YoxNQHMbQHm+ID6aFh8yS93tAvGQb7da2gYfPoXgbtPAqaPA+a3AEubgGU1RM6B060fgkRoCzj+TcD+04CFE4BldZdRc4/YxlxgjJMewSiwN1zWfsOngdljq3EmY08vm5i/7j5yIMqpvupKyGoNg9lngYosl9wY/0dZdrMzYl8Ne8sAWNOu2MA3zw/F2CoNiy99XbvftrcLriz6PhsGn3U9cM9xMODObQYWCMANwPJ49UliuW6SaqqBn/gGYP8pwPyJwNIxwDK76ahDeN6uXYCuYyABkEza4LbpY5WEWdSLxjF26/dQB0SJ6r4ByAN6NQxmkWcqrnQ00x1DEDJFjR8CcNWGvWVPp6ZdMQ6OVOCb3wAscPJ6NCy+7PerkP5Q3tBY1PrT9tEw+JwbgPu2AlNbgVkCcCOwtAFYcgAuiwWlM/XqDjMEbP9t4MB2YO54YJFMo/5gHIcALV1TRZ17FXOhPtvgtvkqf9H4kvHDlyKK4l6VzvVSBF22uwjOb7pbw+CfcwBSkyeFEHAUx/yw9JTyEbo27C17Ol3aFWNuAlgIn9QxO2tYfNlbK6MvaxeMRYquvL9rTcPgJ30TuH8LcHAzMOugX3QALo21WXBZLEHwRF1OgHS2eOgbgIPHA7PHAezNu7QFWFZ7JnXJ5rnqxHEulvlzwyVNN3+wern5Yovl7SXLGwvn4riLWO4fgMRJXcPd/+pmOymELEhRzBxJAo9gVL4kwVnbsLccgHEpWi3epocCAMeBRU5eTcPiy/6qtl0wpvhA+2gYfO7NwOQm4OBGYGaDs+5ExYDGgqP+ccAkINaVpB8GTv4d4OBxwNw2YGFrxYCmV0YxLNYheCXau7EhV3ga3Lb8g4+R45uoGLADgHWqhsBXA8K1AZADyRvuvtkBSArh+i9DsQhCOtf0UUgW/7aiYW/Z0+nRrhizoxXwFhyAi5y4rGHxU66qAFhT3rDSIVdpGHzencDejcDBDcDsBDBP1uX1CMJRwFiQIBzxieL3KIY1YW5MPOxNwLRb8gs0aghAss1GZ1O+SFHsdRPt0i/PLHu++dFb/x4mXfhcbWxhfCtYMFr/uWvKxfDaAcg7ipPCvFOVpuo3HrCjYW/ZA+rRrti6TS6MVQ+L4NPH2nx698GnXF0BsKa8Iab4dFZpGHz+JLBvApieqAA4J8CPOQuOBBAOV0CUYbIskRkAecrvAdNbXc/aDCxSpyT4CEIyTgRgneiLIp3nP6fs+a4A4N8B8/48CUC+ZGJA29fpuLmxJW+5h5kNFg2jiWHSi0r0Uv4pCoZsxw8DUfnhd4Vk0XGdGvaWPaBV2hVjdjgA0BlpkQ/K9bmn/HOVqtClvKEBqlfD4AtmgP3jDsBxB6DA7tdbcvYzJvQJkii2n4NOeMpbgJktbYPGACiF3wFoEx1ZMNe/4jnPLXu+KwD4t/5SO/iMBcXuesHylyACMBPDgzGg7opM8mEHIGdwrfGA1rC37AH10a64Yr4APvvOSdwEPOVbKxu+K2pdKRTmdI3dqkPPVgbSTBGAY8AsATjWniBdx0QxJylOFCcr6HBiw1P/CDgU3EgEIMW52M8YkLolQRddIN1AyKWiBretf9MJQN6HsaCPxe4rvgDdHOcOxDIAcmDFDXvLnk4f7Yqt63gEIB/Yoj+4p9xaAbBHeUPM8qF2aRh84QQwNQYcGgdmx4C50WqCFngNsgSvQ+Dxu4MuiawhwIAXVk1O+e/A7CZgThY1dcno1nHL2oDIyZULpBsAFTBZ9pjT0QQgn2V6ufRicS8QRgbs5ZYpEsENDejBfpoLrwAOjgIzZMBRZ0AHoUC+SOA56xJwNlEyTFw5FxBPeWvlzpnbANCdQ1eSGTRybMuydgMggVBsKmtYoC6Mt8znZxsZMLzAxoAOvsh+ydDqtXx4FIDl8L/omQ7A0QqA82S/ERdTI22mNfaTuBIIxR4BhKe+y61punQC+MytI/Zz/c9EuvyBeetLAfGZ5WOMZ9j2/gqABB1fMLsHAVBqhfTcyH5d9MByEdzs+B50Z7voGZX+NzNSsd8cwUcG5ASRKYbdHRNYwhhDIHRgGmO0gFP+HJh15jOXjnyKblVT5Cbfoq+yJOszF8P8+VnNPlICkMAzds/YLxlYznrJwIpO6egTPMqA5ZNDAB6iCCYAyYBcBqTRQ0e4630SxZyQJQIvMJ8mSeLrYe+p/GzGfnTpEIBy6US/out+K1wg+brs88rHmDOgAVCMnrEfxxMte1Mt6j7u9zzKgIXzczEBOJIB0BnCJoqgIfDEhM58SWzJEPGJe9hfVH42un/Mfxl9bgSiBySIBWnAJBDGEDAB8QWFA8wO3/a+wH4+rg4RLPYLul8tCI8CsJmJMQAOuwFC9qMI9g9Z0CxhZz65K0wfFBPqu7PEyVdWAOTHVlTcpxhXHZLz1w0ZA6EDLhkCskRf0sw4dRYC0PQ/vVSRAYPo7QCdj7GqVOSMeBSAzUzMxZcDMwLgcKX/zbv45SQlHXDIgagJc+bjZBqAWhUoH/Y+B2D0J7rFa6LYDRmzomsAaOeKqxEvbWacHQB08JkRIteSXiSBLYJOLB+X4xrzAzY7vgfd2S4RAKkDDgPzNEAIxMASSWF38WsgkuXLyXTRSRCe/DduSZMBMwe6ObTd8JBj24Aot07uDObPP9XsIzUGFPs5+JJ/M6oT4buxHv9X7BeY8KgOWDg/Z58GTC9Xq5FxTXOw9c3Cm6k5fPcjgbHbgAlvVG2tH1T3Oavoq6BlniZ+12n5u/2sDbOvasqoFg8x2Lnbcd1GdhSAhXN+7qMrAC4sA8sORJ6yHwD28z+Ft4fdv8UyqUDrDmCEBcpZ39kLS6aq9l4D2rLb/KYsFTPWdfbvh86vQu2s1K/K+zIjTsXIVQ9a59Egs4Y6sZfIA/EcSp/jEXv8BWcAhxaA+SVgSQAkGAMICcwVlNLlqTc9Gbv/HAA7MrL4+f1VlXwrUq7SvCoyGcrrWpGhuur2fNGYwM8YT67hT3s1LaZvqn5MLM0bzmHMmIFSgdFNj/mIBct63NhFZwEzDsBFgpDPeanNgATfCtGsX9TIKwNrg9tuVkhlng7TI/YArX1VkXKrEe1l2SynN1RCsFJsqnQv3UIMxhwIRjU5AGN9QUteVz3BUAvahuNgjC3HxLAND7nBp/cgONXF5wCz8xUDGgCjKPbvevlzcKUHH2ag6cnYzepYBB9Zi2FxDJdjoXJv1WDFiLJ6MKqKZUzoQFTfj2HmwTKcTpVWvcxHKm6kKgoORAEvVclPD6NdzLXpMT8IYNPcLV7yJGB2AVhYrAC4SNA5AxKM9ryDPE5fs6eeVKWGZ2M3S3MQfEyJUKV8L1ZpJXpVJ9pLilmlAxWkVJHKwIhjjD9TtVXVm1HdOy/pJiaMFRWM+bo0rWl4yM1N7oPhTJecC8wRgAttBjQWdBBGESwgSiV0Pb9DRgu0TY19N+M1mRKh8niqFx3rRDsLqjgl9yaGXT80vcL1wnE252PAZCzAHQCoiqoW3yYWFIt664fUpKaREr1NPakH6XkuOQ+YDwy4FMSwgU8GSRSz0UJx3Vx/5vFNbrs/EiLRY+v4ACITww6iJEodQKwBIyBRv9vwhKzUW6z66TUGEwhDS3ezqusAyNxnJn8xa1KRPSFts9YfFB/QDZcAm78CnDBT5U8rCqjfc3yh8Gn/hGd/MsKf1+QzYJ4891Jye13iy1cAE9cDJ+6FpYrEkidxDN3OtXR+FwBGMezoMmxJLOumAuD4J4rxJrfdH/XCoLGFVKiUbw+LAPQqWWaMMLrd6/+JycSIm85w9lOpt1j1MwAwFTiqAWEUxeYH5ENn/jInUVHeMXQ/f/jRePvCa4DhTwLHfBc4frGqqaNJzLPw6iZxV+HTplFGvZrXZT45N39+HW3TujlZv8D6fp8HRq8Dts9XIOR5YtakgBgdrrrt5Qsq8Ssd0BhQ4HMwmVitAWHAY/LbLDQNQDaTVJ8Q6W4qVB51OOqDZDPVB3TLOBepW5jmqaLbec3jGgBGMSxvvemDYkQ9GoKF1ShUCSKCqBeQrvmfVZPC1keBjXcCmw911tTJ8q5XgOLaQgA+x/OdWA2EGZ98gbjleTHdQHQN+2iwls3nK3/Zhj3VeQhovYzdxmArSwQgDRA3QiSCJUrTnjfl4KozRCSCCeYmt90EoJJbVCk/1+FiCwFZxLk4dRfLFia6x8LbYkD9v9cXtLG6+O4AYQRfrgPygVIcqyhTXcWFOJH8fh3rz7EKwnUArq8mcGwK2MCC1i7WY7Zenh56feHT/jE3yliE4TZncd636gPFCKWavGhcRx2J+cvs9MlSw0Ty3cCm+c7n0G0MExdW4BMIbTXE9UCynvyCCX+Ovm4gbByA/xisVgJPpXrzLj4EoRJjJIZrWHArS9iprK+KcefgiyB0XVKGjOmCmW9xhRVMUSyRFnNeFGEdI2q+/HFXclkp9WsAbgTG9wGj08CI64WxRk/OTDcUAvBHXSLQxcVCDMQSWbzv+1e7WVbz+k5w2tJtsbcCYV6WJY7hmAsDA7r1Sz3OgOgoM+KTOJbcjSI5yGIaNE1uuwlAAU/MF+tF5/0sIghVLdVdM2S0bSzHx2Mi+FTxXf8X925NC4BycK8QwfmgVX1LlcFiykEMcL2BndJJ7aQfijKfxLGDwAhByM7aC5U4qwPzNwufNnNuOH4VZaCPlPo2AahqFqoPVFc14ga2m+WEEL0cAz9kdPrOmMu8r1o/rTsXz7f9oswFs+jO6LAqkvC3Ggg5Fg6mwW03CUI6X12h8lyfcz3QHqr3DIl64DbqaQKc9mI87QXACD6vpJqY0EVxz2CEyCI5eMSGX2e7VtI5J4yTRyZhscrvt1nQuivOAaNLlYESwcySgiVbr37Bfd0/u31yEgg2FVaiPCeVOguqAfGov0iR0R9JABJ0bnwk9nMxw+fOh55EbgRhzozrBUA1polN9CLwok5HEEUQBjFMQB7D+j656PW+IrJ8O/bBCo4sGFdGejqiyYCx3mKe9/JtTiBvmI5OFiTisg9LtJFF7gZGDrUbHKs79+hyu5hSaUvh1foFr3r/6vZJCiXgCDwVVFJ7MVmRLsrGltuFCc68yFdACMDAflwR4QM3HPoKgIExt4gz42SuaQb8hBOE2oZmlu+KFlKR3QSssMJxDPWbbjpfLoJrxG8CYT8MKGZSVTCxYFTIb84nkCxCIPLDiby30gXFghaF4c2ReR466Uu2fvoFr3r/fKAEFxvpqMcd9yonIrkuK5LLV7MVCM+/uDJCyIC2J8a0z1iwqyESgMl15Sa33QKgmtPEBnp11mwuXgO70Ud4DHWzfgDYC3zBEOk7HlA6XKyHQzb8HgGoCSQLqsxorIy1Bxie7Wx0rFaf+wr9Xv32C+56/7HbJ5VHtRYT+GJrsehHcya57PyKAQk6+vBkBZPpjPEExlwU59awg3C24W6KBsC6tqHR+MidyVG3i3rdAnAsH2T093XT+zLr197MTA80h3SfsZP2UqpCrPQ46oF317VrpeiKXTJ9MhMLkgGdCacKG/mupV9w1/vnwyGgCDCKWzJe3lqsyzLWZWe6/kc/oKzgKH4jC7oolhdC4jiuzM0WPo+cPQ2AsX1obFCTO5Jzn566PwbReiwnfTWjI4KvDoh1juh+aT+WKSYD3i8Aql2rJk+VsVQly5kkddv2FvHT61icqO7Fr71/IkLNXOi0FQjV0046oBy6wZ922Q95ICqDEaL4XWw3COcf9Mw73DFB9AqE6wZAAS8XuzGQIDKf+oVkqxt00ttAc+YT0PJ9qRFSB8xoye5Xu1ZVeCSgCLbYLVNswoncHxoeLwCzBGjBNki/4BX3z9lXgUCyIIGmhova83cRgO5Te9yLgP3MfmsBS8xs8/U67ePQOqy9umBUruDchqo8sHSd3PMfT5ifo+ack8eFHI6QEcnT5GvdOnVdXof+ptJ+BVPWceiaRHA8Us/nkACo8mzqlqmWrbFDppT5A5UIZm7CPA2Vgm3QfsEd909kKIqB1qJAKCBG8ZstZz3xHOAAiwmpDIdng1maZQAkZzsHZ537YfQrwNyxoQ+HakrnS0h1mUA1C96TdJTmORyhC3oeqdwROi+GDhkFI6bYNrcNDEDeAkXwQizPRpmnIs3OdqZPSaRFUcbchHlgie6agq2kX7Dd/+d8lUJVXuUzk8ERmS+2vfd4uvN2VOV5rSwb0y3JhgIh9wJeN3YMQCIgR78Q+nDEVYBYZUrUpbXFnM7COSdf7N4IPvtDnT2BY/h8Chh10MXQeYGS+7GGjaQiABpuNIFiECnzdWJMIUHcazLptC7YivsF8/7FgLFMqpiQL5TuNbKfA/DC46rqqAbAwIKWK+timRUBEiNGsOQsyQm+Gpjd4n046hbT84KPuYjOmHHyp92gcgDS2OoIuVIeh/xyUkaVwyEWdLrewHE3uBUDcKIwnq40HpDXL+n3CzbaKdguel5VnFJl2awaghLQBTzteZ0cjLq2A2n0M6EPh2pC57Wg41poLzZsAZNso0Hw6eVR/J8bF9YjWGmVCpGKwQLBRCcrbiSxNLgVAxCF8XSl8YDHHFPW7xeFBRwv/rGqOKUBkODzqgdWPYAM53vTASMQu4Bx9J+69OHIF+N71F1O1gUB+AsBfFqKC+4Wi4BWX+CYgOTAU36wdMVNVKka3MoBWBhPxyiuko3xkSX9fvGMkqsDlzzHC1N6SQ4DoINOe7KelWWTheziObeKCdARApD1AdVnRH048gKUAmAEYi6Oh4DJV4VoGDWqjq4XLbO5o1jBoimEPhPJmwu9FvnTLgdgYTwd2wyXbMyRKen3i2eXXB245FlVYUpVxUpGiLtmGBlrTEhVUwV8dEkVKAq3MHJ1uzRbRx+OOgDWFX6MsXJU/36lJoEoA2AKvw8+uwTEDIBbStdOs8ddDsDCeDom7ZdszBIs6fcL9ror2C75US9IxJJsEsHdGFBil4yYuUwknofJgF4XcEUfjrz+X7fKo4EJJ//PkMORO6FrVjQMeL5kJhZMMXzLwNZCt1nzDFgYT8cQwpLt4hDON0i/X7ys5OrAJVe0S/ISgFY7j9ZvnQ7I3+lyqpYaL98CWp/N+nDkZdhi6bW8An1kP3fRTLKVWlwF6RZCH2L4zDDR0k1IqeTNb2OQSYNbOQMWxtMxeqtkY6I+ny9VEz6btfb7xc+XXB249AoXv85+tIBVgJJ6n4lf6oV+mfjdDJNMH0wAVFX90GMk1f5TxlS3Fggh92DyN0IORy5665KIfCktsl+K3VsGtpVOWOMiuDCerlSnjQ2rB+n3C+pIBdulz8wqonrNPLKgwKaC5B3s53qhXVq6oDNg6sOhqvqhEr3V2VNLBjmnSSNdrOLJ1zkAu6VPRjFcFz4fXDJ8i45hG94Gt3IGjOFYA8TTlQZ/qGH1oP1+8ZtlT1MAtHK8mQg25zOZUSCLIliWcbw8wfW5Ln04ssqnHX04euiCk6/3de66MPpuAQVZAEFkw2MKFw6a1wEL4+lSBvmAOMhD8vkOkFX77feLNw14YT/ssmc4A6oOdHBEkwXlgjH2k4Nal6wB4fIuX9LzZjAmorNeHMo5Tc0OewHwDTUh9HXxfGJsYkAbAAAgAElEQVS/uvCpoAcew6zBBrdyBlQwwoDxdLZWXLDFkHyF8xGE/fb7xR8XXByAAVC1oB18HQYIT+8uGfP75SCUs1o64he8v4j6cIQ+IqkPhxrBCHjdjBH6AblQkAeY1ondukSiELmsUPpjbyp7XuvDgAXxdNZVvWCLIfmKg6Bbhrjup98v3lVwcQLw8gqA5v9zC9jErutltg8gMxDWWMBaMVkmANWFyEV6R0uH2I1IzW7ypbkQOTP5f2ch9KsFkwp0kQlDAOmxzHpscGuGAQvi6VD4RgmAg/b7xZVlT5MATNXwqQc6KGwf2U2uGV2uzg3D4ua7fDnPwZcKgIdq9GaIBPZb0YdD7hgyIFWMXiH0eQ5vXS5HcMkc++9lz2t9GLAgns7KxxZsCkgdtN8vWD+vYDMAUpcja7lOR9eLVcIP4tcuob/3AOHCdW02VTX62ApB4Mv1v24gnPy9HiH03fJ366KYHYTHsgBBg1s5AxbG0+HLZaOp65i+ln6/YM5EwdYBwGj1cmUkE7+8THLNdAHhwrUOXtcrO/pwhF4cct2oN68BMDCfmsJM/n6PEPoYPp8bH3kCkbtjji2tJJA962YAWBBPZ0WBCrbYsFoOf9pDAiENk179fkuvf9nTXewKcBSjsn7ldonWbgQpx+26otaLIwAlfi2QQSJY3Yjy5i9dmsFM/oEDMM/Z7Uf0RiYUA7J+ToNbOQC3e0WBBm9qLad6HICG1ZK1XB5PoxnuOOIcxSXe/Of8xHV/P+FpwN47gKUpYHmuSve0pKZgCKSq5wqniWE1WZz/xouBm74KTMwBI17lVBXwtWSs+8/vL45Ff3vhpcAnvwos8d48DZX3M2hx9XIAnu0IIO0chu35AOgLL0yuG/jOmwbg028G/mNz1YWdETbm4I5BrFlov+EtD2wIo7l+Atg8D2xY7iw3V5diEqO54mnj6XdMAYcU+6gon7A3NSO2qFjlyZYDkAX6uD5Iam44YaUfVNDNxaJcLIPXcGGpfi6PnZdVD1wPspQBX/wl4OaNwN6Jqg+xwrxslcVFuYJblehkcYYZGPS3L20BxueBcS8nwg5H5kZkx6TQSbXFZcCQKadx5Cz5mPurAFxrRaa17pAR2PFC+ElSHKQ/0QjQcgCyGyM9v3SnsDBRJgL6msWCf6IfWeUJac8UFlpY8500DcCfvgb43hiwZwyYVhd2D/VSrKGAmIDnBkiafEcN9cprHgKMzgNjS1V7rRjRlceyrqif6KAkMgXIM+6tAnDl+zSL36O9+U8p9jGHQo285/2XA/AnXeNnKAorDXH/AILwbSvLEz6Ql2+cAf/3XcCdw8DkKHBwpOpFbE2wadzIdyh3jjNQirYWEwYq+/zJwMh8pf+xKNSwM6DZMmzNRRbM2K+2Ii6TlFrAWfd5V3i/F7IgT2LBF5LbIdkqxLPWvtzlAGQ3RpU3Y7AiixMxLOUB2t7pKQ8M0qCTnp8HkojJgNqaMEJesQv4AR3Iw8DB4QqAs+6SWRiqgJgY0HVDAdBA4Ba4xN7ndlSFAAjAYX4IPO5dBDMAdS2i+Jx7XTf1eEdTDfgAQnR34p/wQkRmjNAoByDT/ugFphXAmjAEn8qaPQAgZCs0lSckCNmVigEbFMsPBBE3DcBX7gLuawH7hoAD7EM8DMw48AhATrjtQwiXoqkTEwWd7LOneXNCbz6Tiq/TInb2M8ZzIFrTQbGiy92oGz7pXl/7jvdAJnb2470IbB3T77Sai+hyAP5voTqW6sKwFAc/TAdc5+3dvcsTrvPVYSK4SQb8xV3+6IaAqSHg0FDVh3iOIFTIFxtit9orL5Z/LD1Q4s+B8OnHVuXwhhdd5DoLGsgCCJ04q66X/Ju/vSaeAxDPvbdtmdtKDV90gVEPIl/xySkviOhmAEjrlzSkwj40SlQZYZ39I+8JBMx8mZryhOsKwqYB+KpdVSDFvhYwPVR9BD7uyX4SwRS59nNI+bRck/DzJ05v12M0nY8fAk8iWL5BB5qASPGRCi8EVjzv3mqpkC9ACrrwhKukB67GhpqRRowQMqCiYbj8oOoHeUWpdYIBAUj8c8WjrjyhNIJ1unzjDPjqXdUjJAAP8TMEzLYq9uOHICQALe/EwWe+QgddAqCzzD8+vgIgg0qp+5nYjaDzCgjmnCYone0klqP4JSgvvK+6LoFPoFMlkPGh+0rPWta4RHTNJJQz4M8EAGoNTPVU8opS64CC9zoAWTFChcq7lCdch6s3L4J/2QFIEBKA1P9mHIBmhPh3Ai354RyAAmWsR/PRs6vOR8Z8FMPS97yxtIlYgVB/I7jC0rIKSfLXF1EEB+BFFjQ3jCLA49OWsRTTEPzvzQEwry7VrZ5KwzAQAPssT9jw1dcHgCrORQCS/bgn+1HsCYQSveaHkzvGv1scgU/6R55Y1YIxhvOm1EZekQWl8wVDxJgwc88QiJc6AKX/meHDawX9z16M/Em7bO8Q08GBP/jEkAEVjMBoAFWXUjRA3KtNwOBXW3EkAZhrALktpC6lKtTV4OU7RHB+3kHWgv/zrnYZl2kCkF4uF8MGQGc+MqEYUCA0n1tkwxbw4ScHAHr71Q7W4++c8czwcBAmHVB/c7Bcek9b3FuwbdD/kjGWgzJjQ3thGmVA3jhfOyU+RxB6FamOFp8NrhsTgLy8Cpzm5QlVptAU+6CiNgXCaIQ0BcDYV8b0P4pi30vfIxD5+w72C9aliegW8MHzqrmh/meuFhYi0pKbs6D9fsh/n1XFMrYMbPgUByCZz6J+uEknDA9AornWFRb01WZEsACoHhOqyC7wdetT0QAK2KqOb5MCUvPyhLE0oQxzqaYNXL5xBvyVXe12vByLADjXAvgxBvSPGFGMIjCmJbEW8HfntxtQmxT0cmxp9UPAdKAZ1upA6EB7qgDo6oCUxXRtPVSpAwJpnUhuxAqWCCYK1MBExZljY5S8SYr+pxAFAuBayhNG26jw8usCQLX0SAAkwwcAEngyQizaXoziIli+Oe7/9kJvNk1LmBMe9ECO3XRB7aPeF0EYHNVPdT8gj016YBcWtBfBVYJuz7mF7VgGY/pO8f5WdQ1/7U67nIKNS7j0wIbDPFZsyNHHY7od/xdlEHj8CcC3TgCWHgGAPSxiSdt4312u/8SPAl8/Dlh4pDeZW2PD4J1c9+uyDaIDkgEJQKnTfG/N8nUAmu5HUnMW5ARbPfEuIHy/ACjRK7FL5pOR4RaxgTHofKl8r/S1ZWBnAGDKefbn3AFIPRPXB7sFiVQimKVgGdl5ooNwLQ1/1U+DQGSXQ9r5Evy1q9rZbP1lGQDZsPpzI8APHgXgod7qUx11YtBbFzC+/C+BL7SAWwhgdoLkONSLqy5oLogYft3ZI1F7EAC+phsAnekokhP4HIzml/PvthQWmPB9LJ7jxkcSr14jWj4/0wFlgJD5eoDw6fe4DzAYPHokWhHJZ3TFSkn4h7YOSOBwEtiMTv1aY0uktFYTmI2/43EMQmCuAJmUE0gmVD8EFdPpdnxhVhqzDr8F4NMtYM9Jfg98EVTeNu9Q2OFZBX7vr9vtgm/lcezczZ61ZNN8DCvilYCdPXqNDQpAlfGTKm0M6AA0PTAyoMSx64cRfPQHXsniOTI+fEWDFGp+Qb9BeySRBV2kpl0QxxGAlHDmkI56X6z+EP7UDYSdRgh/IouwIZ36lHabBE0GJ0r10Rgb/xA/tt/j/6aMAf+7R4CxzuBXWRGULwBfIrY6UNfpvLae7n0I+LO/reoLMqiVMbW38oUhkNkQIzZO7tIweGePcmWlAFTjAYHPVGwXxWoLYblEDkLuTT8MDPhXLJ4jALpaJB+ggU6xfgJknT7IKXIQXh4Y0FZCog+wxiUTwSkXUbSMV1rB/A31OXWuFpPUda/mRHKi1e6U+hA7Zq7l+A+UAfDtHg/LrptkQpZ727cRWOL9542Pa3rOvuOqagUltgtmJM08j4/PILbIDKz6w5PAHsbraTnMGdZWIwIzxIfeK0rn578J3LAVuH8CODRahV/FFQ/1IumIvXP1QudNfyNT8oVqcHviPcBd48A0g2RDuoDqHdb2SalZAdG9dnfDkAE0gXnH5ijWCDbKCq5/MRiV0QD8HgHQ63jG0hdsLGxA3x9Bw1Asli7hO3BwApgng/Gjvq01IHrXJ7q3Cz7E++YziF2rs1ZLZ+8H9jJsSoECWXj6igmR87aLgfbGq4GvbgLu2gjsHwdmCEIPSI1h+SkCRjpfUC3iNWcpoRrcnrYbuGsUOMBo7QBCxSTG/igxVcBIVGPWM1h1JYQPnyKNExGZMDIJ9b66eEBGxPDY1Y5nv+GCjfGAxD+DDpiawphABWZPjwNzNLAEIH4XCH0M7/5c93bBfI8Yk2cgVAdvdT10ifDkBWC/r9lGH51NhIsnsWHOfPmEUKT94WeAG8eAO8aAfWPAwVEHISNQlKQUglJjJExqC+H6Nq93kOpUg9szbwLuHa66QzFWkaFieXxi6hgVHOMCYGRuJ+5V4jYJIDKI9KlsAvFDq8QDrnb8NWVPh9EwdFkQ79TlSMIsN0Mi5s9MoOGno4U6f3YAvefL7Y7rvdoFLxOANSA8f7xSgWmd0kCQbmZ6mTLEnJ0UqWLhUkxlrBn6n3wWuGkYuGukCsufGq2iojnRFpafsU7MDxErJuZhYCsJosHtWTcBe1oeq+hxigJgXBrMmTBPnJKLrr+VED54ibHYvZos8sO+DNcrHrDX8YVVyglAKud0LtMjFPtNMz6QLDY7VomLJd671AEH4Xu+3g7nWq28ISvX58/hguOBg8vtFQvV/hEzxfqOevuTfpjri8vAWz8L3NYCfjBc6ZYHmBcitnFd06pxyb8W4gPlgonBqffTtdTg9pybqiVNBssyUsdUD7eGO9amnf3sXtxQipl7Wg/sD4A8AwHIyZMYky50Tp/xgN2OL8y051qw2hXzwRCEdT2nmck1RxHG+w5jeO9NFQBpR6ldMIMXlFWgVndqF2dVFsJzuOgRwMElB6DcI6rznemD0RnbwQiSRS3g7Z+tVIl7PC9kahiYZm6IizuLigliT/VoUog+p8P9l3wJ7qGEanB77k3VczroUToWLCsABud4ypaLCUoxf9i/9w9ADiICULrQRWuIB6w7nuZrwaZwLBGwClSqSyz3AhHbaRGEFGOmC44D72UVgjW2C2Z4lIF4ArjodODQcqUGqAxfcpG4mJVuVqcL5tbs2z/veV0tYK/nhTAqesYNHdO5PCJZos+WuzxHJIViuXFyJxupNLg976ZK2lizUKodilGUgzyGhokF8yw5Mf+qRkjdjfuDtwkkm7DTkNaBaQ2ox1q3eMD8+B6O3H6em8Kx1Ccx9ptWl9iYIUAAWrI3I3nHgPdOtsO5eOuxXXBdj0V1vOL/so3Cxef60tlSpYwveKf0pAu6ohfdJ8k4CUqgvr5jV6VGTBKALeCAh+VbZLTnh5gu6D44A6H8cVlkNK95O1WkBrfn31R5HSy+JCwPplAxRegE/2T+AloGncNmbQyogUQx/KwB4gHj8YWNTwRAOW0FIIIndoqNkTAxz/bd09XDGLBdMM6/pLKi5whAX60gCK2ujxzEAqGL2pQ1Jis5AJEAFHvTujYAKjRf+SEugm1d2COQLU/DAwQ44caEw8AtZzSIPgAvuKkdrWMM6M7xCMBoiBn4YpCE2NCfxWAA5MEuwvCCEICwlnhAHV+YORfDsWJGgPpMKwg1b9QpFnzHbD2BK2JGul9s8KkYW17vLALQRTCBpzXZpS4gtCXXMAkduuAy8E7PijPWprXJ5CR38ygw1fJDohh2BlRAgq2OeN7uTWc1D0AFNtmL54ESBsCaJcLkDajxj5ZXRiCIGA0waDwgjy8sk5+HY+X9ppUbJSCp6TnFCMXwny1WAFQ8rUAc2wUrRL6mXTAefWnFfnz3FpbagQKLAqAzoZjAKkkpXkNO5GCEvOMLFXOnnC4xIKOjnQGNdWSM+GqHQGd7JSsxUf+JzQLwhTdV4je1nQvr1MkPGtlf9yP2Dy+gAqZ6rQytfvdHSDxgLwBF8AmAYjHWluEDiKGMiqOVvtejXTBOuRSYJwDJAARgZAGWL9Nk+IM3SzgTydE4eec1nZHbtDaNAf1Dpd/SMx2END6kD0oXtFhBXmcY+OY6AFChnKnzl7NfdMR3qCAae2B+VVMYXASvDs3/X/zHJZcB84vuiqABEo0QPnhnwqQLyRURmZBPytnwHde0M1vN2lR6picoKULaxHDIEdHkW2iWg4/7b5zb7DSQAVd0/griV2JYojfpwRGEYsGBrOBmx/OgP5sAKANkcbFzNWTRnX/GSGImMYH/LYlk+gGvdT+bW+SWH+Ig1GqL5QeTtR2EYj5LVHfjw/ZDwL8yJ6TB7UU3VVoTjTYxYDK+Ivv7dzNAZIxpZSiU8jjKgIWTcykZkBawDBBnQdMr5QeTKI5iWCB09AmEb7+ucnOQ/aTPWn6wuzyS4u+R0Ob6CUGqJpIDA97AdqINbgRgBJ69CG4Jp6q/ckjXqB/RKla4WpkO2ODgHoynigA0JiLwaNiEt95YQKJ4FRC+7brKzRH9jZbN6iJYuSHm9I5iOAOhHNJfZkh+gxsBKPbLu3+JgaWDdojhMO5kkDWSlNTg4B6MpyIAjf3IggJgMD4MCARjFMU9QCgAykhSKnUCYHB9JB0wy5aTRUxmup4h+Q1uAmDs+hpXgFLnB6ULONOn5xACNJqxghsc3IPxVBGAiQG9aLeilWUJW1FvVXEN0TKp1C6At19TMSCBpz1dHtT/JH7N9yaxp6QkF73KBxYIr10nAMproB44qQGTj6sjUrtOFPtLeFQHLES9AdDFrq1E6M13MaxVCTNAXNFThIylLcor40zxtgDAPKuVwDMrOKw+SBTbtR2MND7sZwC7Qvm4wqHa4T/uIrhb+7n0EgbQdTijoyg+agWXT8llDsAFWr/B8qP1K7bT0pvtVwHhW6+t2C/m8svvZlawi2CKe37nhFtapkDnILRqBQA+v04AjMyn79EIkXO/DnzyCBwVweX4wxs9B4rRZgyPVFqykgDd+5JSpBU5r0vHyHz+jsc3ub0KABsZMCyQgeExKyFPVIz3lmcM6OfPAGCADYPE67Jfs6h7G0o+xvi7oyK4cLZfOgpsXwC2Lq9MwuuVERonKn4nSJrcXnQKcM7dwMMXgYcsVxkSebJgzOWPqdB1ad2f3gpsnwK2LXWeR9m3danUIV1lBSCPArBwtp+7DThuBti6UDWDmWA/DvXk8LRptfPtNUlihYZTOPCi04GH3wFsnwGOW6iAs5n3GeJJ+KLoE+9VDClQ8R6vOQHYegDYwuY3S6H/iJ8jb11ck0q9Qhoc9QMWgPBZJwFbpoFN88DGRWBiqQIgWyJY3lPozaGJ1KTEPh36zpTkJrcXPRE44S7g+Cng2DlgyyKwaclfFoIwvCwx9Zn3Q1DmIPx/2/sSaMuusszvjfXq1ZRUElJkKsBEGQyYhJCBSkUqAW1tsBdpuxEVaBzowXZqe1g90G2LotjQdmMjKqtBxQERdAWUAkUlZNBGkQRNyIAEMAkxpFKpqjfUG3t9//m/c/+737njPq9uVeqcte66b7jnnn32/s6///3v//++Tz0dmD0KzC4DM6vAFpd/0L3Gh6yTDgnvLwKzAWDGiH/ThcC2OWDrErB1pRgQisIQhAa+AED+HEEY6uNLyrRnZLSl6tSbrgLOeBQ44yiw8ziwfaV4UGbdegmA5QMTLFlqsfn7XecDW+eAmePAltXiXnkuZSBkRcm4UGXtU2uo3xsAZgz6y54JzMwDWzkgBOAqMMVBCSAUObh8QuN/CiTgcWAuyWhL1amvvBbY+VgxbW477paa7gIBqCnUrbUBiQuhAKDUot13IbBlDtiyBEyvtO5VDxvvVfxW/JkWNFrCeK8NAGsY7BsvKQC4hQCkJNaKy2LRIsg6SJ3IQSe1onKKC2CsOYMeN+0Dtj0ObDsGbFsEZmWp5S74g2Ir2uA22BScAJGA+dJFwPQ8ML0ETAUAkgDTPq9zdK/+sMWpPF19NxYwA4g3PtsHxAE4SQC6FdSgmGWRRIJLZJll8EGKjHiX1jwaN10HzD4BbD0GzC4WrsKMW2pNobZoCu6CLCDfCTqzgg6sr+wFphaAKQfgZHKvpRSYg7HN5XCL2AbAZwPrZGaj6ippXhgn0kqmU1woxnHedg5AATuWHig2FE1uVRwoxoX+Wcbg89S3AqCKPONcCi8oPtVP+9++G3j+oSK2xRBFDElUxbTS+3nvc4FpDsjxllXQoJg8FgdCQoGJJTTicLcQ6vPL6wbg9cDM4cJv27oAzFA5ky9/UOSvmg8oP86n0dICBn25JwjARWDSAUgBHN6vfdbv10AbARh8X91vDM2ss+NvAECKPVLCsHoyUgRqrlbnRwB933OBc+4DXrIC0IEmiLnE75di8HsyAcjzWUVGUi6uICMpVwwJVMXdeOk3XAxc+Hng+vV2esAYw+sWoP31r3eLcLwQBeQUrEHh4Jo2h4vDmJPuAyMLGAeEn7uqbgB+I7DlSWBGCwe31Gb9aL20kGDb/EGRxY6WTz8f2wtM8l4pgL1SgM8esHCvsuylME4nn9cfQLtldg6TZ0kUKorAfij23vAPCmqp3fcCl60XFINid1PlZrf41/dnApB6wSQjutUfIDJR8CGIQOwWEH7DywpKrWc8CFzqRLHkVYrB2jS2FQH5vkuBycXCAlIUUAAkCM2iRBA6+ARCe7DjYmQduLYTleiQ/XTTS4DpI+6nLhZW2nzVCEBaMLd+soIGqjD1ampdugiYWCpeBKA9bBJC9ActAk8LES26SqsftInLZ44dQif4Igdhym5WLrPDyuYH/7HTCNwDnPko8LXrBccjQaioe6BiKad3+QY/MGTH6rS3OBvCnQDuAIyqhiDkQ9RX+29yE3on8IwjxQPI8zkTiApGU3oVkD/4fGDieAuAdMw5MFQjEgg1DYsUku+a3uI0TGBfV7PotwHwaOEmbHEATvuDIutni6UAQoFRIFRYhfe/dhEw7tbe9Of0Si1g8HkrwRcevDajz07gIJ7n05rYyWIpb4ya/7vv8PRdFpj/LXDmkQLAnA4jCCOlTBRN/rFMAJKgkkVHpGUjySSBSFeg7/azqk8EgbSEq8UDRACLKDXSyaQ7Br//DcA4LSCtwnKhTEkQcmAIQhtM+Uaajl0uS9NatITXWzpzfcdNB4DpY+6nBgDaCtanYLN6fCj4u1ay0QIqtML/EYC61wSA9tAJeP6eWsAoDysFpg1eB0HIQRCIIkVeCqQf/05P3WCB+UPA+CPAzvmCaFWDKEuYcl1yMN+Y2dckqGTeHPEvvWDSNhOAfbefX0A6rS8CUw8X9066bFIfdqMHJID++DJgLACQumyc3gyAEYRRKFCLD1eu5ODLF6QvXedx0w3A1BwwxdAJLTXjd8seQnGrZ9bPFxLyA7WIKON63tYtCQBN/sv9QPm6BkLp0vl9t/m6ietR6fbyBA4gnXtORwRRpNnTtPpW6gWLH83lKqcOFTEnDiKtoHwy8RNFhrefyeztbnrBfbWfgttsP+kIyO32ELD1cHHvInrlvWs6TsnB7qAUlg/suFtAWkE55zYQ0QpqcALoNCXTEt7A3KoaDwGQfqoAOEUBa7fUbKctltwCajVbxvSiyvoasM0BaBKwwdKb9fN7NfcqBWGiSWykWXER0umeacUEonQgCKRfIgDFjya5yq8Wfsfs8dYgiuMxgpAg/vnMzu6mF0z6Zj5APdvPQec0TEosnvQosGOhaLuIYvnwEYSithE52F1XFAA0p5yigD4otCqygFKnpHUpLYP0OcKURYv6Mj4MNR433QhM0gL6QongawOg+6rl9CswKoSkEIxPyTsuAPigCYBmAXVfYcVf+n0SRYw6dP1YwNgHsgSajiJP429RrpWOM6cxDiJB6NINM4w7LbUGMQUwB/M9mZ3dSy+YVG0EoBiDBST5ddZ+PkCsAiIlQZDa3LVatJ0WXG2PbL98AB+4omB3oP/HgTUhmGgBfRqWf2TTrUSjExDSP/qWzQDgfAFAWyzR8rkFtDAKX75jo6nUguZxZ8NByHbvvqBQ36T1swcsBaBAGGRg40Ir+rt9WUDhQ5ZAU7Es2e9LLzglqHRxNkbeuW+oQRRls5jaMjnK0a9ecNf2R4LAwO829kQB3LTtEYQPUwzQAWgW0AGo8AQH0ljp/V17pm0KRcEifGuNOnocO1rACQbKPXhs8TtNwVr5uh+n6Zf3wDgu29g2FdMtOc8B6PdpFj08ZFrplw+ZA5FTvAQQ0/BT36FPDkRqBT9Jag7xYlQItY0f88j78sZzCcKPZlrAQfSCK9uvB4h577SCotUiEJ8opq8IQFl/PUBPEoBLxbRE62LSqG4dFB8r5bHcOtiOQSqT5T7RKzYDgJx+BUCCTxZQCwhaQc9oKcEnEBKknj5FsJ1LAPo9xoWWPWDy+6IIoqbeaO0VA+zHB0zxIQDKkn1GgtXiRxMIAx0Vn0Db+lkuFjLRCt5WEwD71Qvu2H5OfekD5FaciQay/GIbFgBXriwAyGmJADR1ck3DwTE3TQ4B0LetzBJErTYAr2BBSI3HTS8tLKBZPo/fWQDZp197Z3scjGb5BDp/L3+njMweB6B83Gj9wj3atOsPWin9WgXCFlVO/3ctf4iD8XkBkH5USlAZlNPZAQqARr5vxu1yjmH0givbX0UQKI63o0Wun/xHuR8E4VnPK5JQLd4VNttTBvK2uoiKOUf/f+GjwMNBh0NMV6J0c0NpcRv7mrYv3kh8/uHxYp+bVpwLp3R7sts2YzouSq3KGa+q7+x7Co4nazAerRKsVlV1QitF59dyyFZaYY0HMu9mWL3gtvZXMbymBIFMZ1ov2h0B+LTLisxgW+Eq5uU92iZ72ud9vvR+4JFp4NjkRh2ONi0OB1/UBCkvEYRhfuNs4OmhhiPKnFQlx6aAjMnSXJUAACAASURBVPjmz1w41nnwO4cCIBvBwZgTAOUHRq3gyDExD4zRGVYEnpm5LqmQc0M5esFt7acFl0SlHiBxuTkYxxdaihUC4QVXFu5FCUD5QtJl85sjGA0ziQxqeu/fem+hw0F2fLLQGxFlYMRvo7v1WmIVtpt1DFkXvOR7LwJ2HSkyoZmEypoVVe8p7b6qEMnidGG/Vl/L2aPOIwuA1pAIQE3DAmFa4j9f7CPaFpCHKujr5xzZesGdHqAqKz5X+FLRAl58le+jui+kTBALMcgZ73CDBkpN2/7+bfcWOhwUyCEAjQTcAVhKdjkPc2RajewKyu/n1//qJcA2uhBMRGXQOcn9U6JIOjXHQqSYOsVoQp1HNgAvz8yny80H5PVz9H6RqVd849WtXQ/zA0Ow2ayGLJ474L0G79vvbulwkJi8BGCg4S01SKqofoNvSIC+5zkhFUupV8rUTpJN06KpaBkFQm5M1HlkA3AyM5/u9Zl38zrk6f0iU6/4hmscgK5ISUtCTowyDqb7UxwsqFJW3fo/vbuIBJEZ1YRgyHwQKNi0KEl1OKTCZJdxtPDn//v8ooaDaVgqFyiTD2IKfcjZS4Fo+7g+HXOPv84jG4DIzKfLzQf8KVfI/FNKrQ6h94tfz+vOA9cGAAbrpylY2SDlVTTt+uCnV3/V3a7DQQAysJAwobZJgUXi78Qayhd812WeiOAZzEyUiAkHMeu5BF5FwZQAWLPwknkLQy9CrPMy8+lIHZFzvN3T+YbV+8X7c64OHHix74V6zIxB+RJ0wQ+UU992tYoFy3fcXcTDxQkoPsCUhFIczKVCegSg5B8A/PILN9ZwxBSxtiKiUAOi7JW0dLTustF8AGbm0/1o3vjjnSGdj+lYlGwdRO8XN+c1wABIoHk6k61yuSCJITq3jDY9Vx0BqK++uwAfX6JkI/hME0SC1EGguiQ+isqcQRLrF6/0jO2w+6FMnZhyZYsQ1W50qOHgPX1NXndtODsfgMwHzMin+0+ZN0S9YOllMzWfLwKQSS396P3iY3kNOLDPM1y065H4gOW3p4uTDkB8zWdb7FgbdDhEgJkCUDRvogTmd/vPv3BVAUBuvylNzAAYi4hisVQnEHoIqWblrxqm4Mx8ujfljT+YjsWBYgIOc0oJPsq1slCpH71fKybJOEoAuuVTRSCnYlmU6P/Z4iSJEcbLv+Yu9/1EAh7JKEXDKxq4ChUiKymRbwjgHdcUWTARgLYXHSr2LOU+BV7MVwzxwOfkOWybYAGZD5iRT0edjpxD6VhcOQ6j94tP51wdOHBdMeXa9OqWRcmWXA1XLUIUH6zyCwlAs3z+YBkfs1u+VIejJEF3ckrjI9T0y/aMA2+/tgAg08VURKT8vbKMUgAMIGzzAcOi5HknHQAz8+l+MW/829KxhtH7tTz+jIMAJPCYMULAWd6fvi+EY9ouoZBM/Kx/4LUBgFLgNC5o16FrE8JJVJgkiFhaQQBv3+dVbMrWVsC8UxFRkjjaVsW2DtRdOJ/vAyohVYK7A+bTvTdj8HlqTMcaRu/XxHkzjgNkIOWuDr8jnYYDKDutgpUhra0uAlAyCCUAK8BXcjBXgLCk/h0D/hcByDxFAdAzoFUqUBYRJTUcMWdPP7ONL6i5bLQeALJRQ+bT/W7G4AuAOXq/lsGdcRgAY+glLkYclJVTsa6ptCX3uQjAKINQstFrAZKIwWxQIhIJuovB/Nx+r2LzFCwlj8Y0evl/MYk0kieVtcvrwGUnHQCVjjVkPl3mItQsIPuElx9G79dOzDgMgGkAWlNyBJn8xKprBRC+zgEo4LWRgcdVcOCjjlNvmx84DrzNAahaFZWLygKWxUNibIhTcPD9BMLLa65bzreAMSGVoXvJ/Cgh1WUfO+XTZS5CDYDs9GH1fnOrIDcAkABTTDCCLYK0Cwi/586WcKJUiEpC8CCBYDsiiSplqUIUmOjf+o2tIiKVUJbgU5uSWl4DWwX4+PcXnrQATBNS+8yny1yEopdcay+930y5YhgAg+9n2OoUeI5TdQer+32fdhmGoOBZanBo+g1yEKU4dYgFSvqB//vZBIBt9RshkTbW8ZZZ2hUgvDL3iU3uux4LSBM0ZD7dPRnTH08VAIfV+2XAOucQAMuVcKfFSD/+IAABsEoGwYAoHZIKEEYxRIHwLS8pUuhjFVs6/ZZhIVWyxVKBBIRXnbQATBNS+8ynI4tBzkEACv+chlUVIKE/5cRGsWmlKfIzudc3APLQSlg3E2OCyVRc1kpU3DgBmKoQsWtlBcswjPu+nfTYtBL+GQdgOf16GCZW6pXlBCqWSgqJypoOAFfXXDifbwFJLvi5HAjlnUsiIe6AjOp4iQNQHRlT2PlgJCUbbc2s+v/hFwFb/q7gm6HlYpBbmTV2sscQyy/qFBj2v0/cAdz/HGD7NDA1AUyOOU+1CwWOewNjKj6/O03F1/WuugW4/XJgfBoYmwDGdH7IxB5kLPIB+I8AfNwZgga5ck2fJbEm8V9zNWPfrasbgMuPAcuseJ8Exsb9FdBhA+7gaQNKB6TfcgCYug+YJT+g89aoBDMmIMScP12uTKj13uDv8zsKig/uJ1uQOsnojm3qB5P5ACRBH3OhPuzzRN9DV88HqQLEWPJnvTy5nm/t/1s4BcuSpRZtGAu4fi+wtBVYEyccrYwn6hF8/FkJp9bKxAKVFsn/d8urgbHPA9NPOEOWl4+2cfoFHhfVrJTZPKHSj5daOtup6JyCpPx8rHWRVQ7WOlrYCMx8AHIzlxkALPD9c0VB+x/A3E/+E2fUYHXdF7KTGwdvTd0AHP9r4PgWYG0KWBdfsBdsMPfPrKKsoL9XAVLAvO2fFylCE4cKliyrDVZNcGS1CqEYhWFiAZV+XntaURdTLmpCEbpchTYLqi6NrkMCzLzt5Xc4HwyJmmkJ+Z73jQOh4NWeDUZiK1K08f0EXt7CMHVawIk7gaVpYJUA9LI1Ao8bzKX1cytoFtFfpdCIWz7rgzHgth8u0oPGDwETc8CEMySUzFaikgtlpW1Ta8JqNba7lVljSRgW+Q6ZP/57WQvj6fydBjXfAjKbgEvMLwWCvhNoipgNpnQshlS4IGFWzIk6ylWwAz93ETLxGWB5ClidLABoIOS7pmGfG+33YAG5mND0G8F4678vkiPJczNOAC4UyQm2N8w94kirFlfIAl7i402d6dbPWWAtrsjOFiuCvAJZOQE0pHTFsckHYDeCvhNgipQNxoAz8/8IPr5nbvH2jd+6AThJAE4AqwTdZKEBLDoDgU4+YVkPHIBoPwareOt/BkDexsMFAFnbzNJYm0IDnVwbt4uyur1kwL7Tp+iZM/08WT9Rc7DHUmuYTr/x+6o4ovvu9fjBbgR9JyA+omwwxvZI5ULg6ZW7y9FPf9QNwKm/CgCcKABovh8ByVy/UCtJq2f+X1yYJPGU27lIZLbuEWDsWBHesZeDz4iURLUWa1TE47LqK12fZmd3OXidFctqm92KatVs1jAEsNv6sdymaa2g8+xUL4I+Pn2beCgbLGWHI/h8G3oTr45iK86POlbBU9yKI/AcfLR+ouQwH9BfmmbLlTHboOnZ/T9+5vaf8FUaAThXsFOQ45mUcgZCWTAxe0UQ+urYMO1/37GtxQmoLCBtRSp30LrDp2SFdzYMgk/R+VNwvwR9mwQDsaspGSfJgYDYNTbp8psCQFJxEIBkQjDrxt8dXCUIY+COH5MVFPi8SOn2n/QYLZ9Gp0cxANIP5IvAkzVzxivRydnKNzBa8fddM84b6AFyAriMF2pajk9kYIeoClXmA3AQgr5NQEHMBqMVFMNaIOayNRL/vhlH3RZwmhbQQUcAasrVVGz4EtjCu/3dfb/ID3PbT7uKAZ/MhcIC0vqRTo4W0IBIEAmEtFwCYqjW03bcmdwBYeoWgetUbrR8snrloiR2drpACf+rD4D9EvTVjIJu7HBV+781X752Czj9lwUZkTEgcPoNPp5Nv4oBRhCG6dd+1DkMz1JIhR1BAHJ7zwqO3fIRRM5tmDK5CoQKsSgOeBYBKFZULTqcB9r6Ni5KYmd3WKDUA0BlhNLM8EbT1QBXBU72aI5ZjUcVOxz7WLkQ8d37vsart/uA6RcPsxNSAtAXHDYNC1AEpf9s01kKwuBwGU7HgVt/1jtD1e60fgQigSe/j5bQp+KYpGB+H62jT7P8/ZypBIC8Dhcx8eY9wF015abhmnoAyJ5WSrKeNgKO9SHxnT/LSasJBim5lRjWBEIVeROInKL1qunybRawLgASdEy74qjaNNzJCgqEEYzBGvK0297mAFSHEIB6ebKDgc8J1ksmV8t29f1en6L5v6cxIK5iK6Xne/5jCTiFcTqVn/r/tWDPWwXnEPTVgIKUHU7ljASawKefIwDpMdRxRB+wFgD+RREDJABpwSzz2c0LfxczVjkVKwaYgtBBezu3SvX08d39P5uO3QKahXMQciourZRAGKZWar/YZ1xXRPe8wQr2AUK7TvbOVTZBXx4MBECRnConUBSFEXT6mf/TK+/qmzAF/0UBOPqBZYF52HrTFCw2LH5G8UCzJEko5nZqmRnPh/uCXmpnVpDTsIPPwKApOaSA2QLDLSHf97iPx0tpISLfz7bl4iFfsUsnj+HZWEeOYDCDnDmCvZkEgedcCjxGseIhBYt3vx049HwMLRh8gA9gh2MoH9ABqKJzxf0McO7XlSAU4HzhYYFq+5D7hwBu/98OQLlIBCKnW39SlXNY+nqeiq2dkQg+gnGPb9/ZpT0lq6MV5D96gLCwgDmCwbdnCvZmCgY/dxy47xxg5SWuUjigYPHFbwA+fyGwfr2rXrMvPB+vp3L3GHCgi9JOHQCkRVPppeUBigXLFymyejYTB4YsgfA20ofRAlYB0FfAlvQqP0/TsX5PLOB5DNu471cmIwiBaRww/F01J+mz2pqChxUMZvpJlmBv3iTocsW4dzewfhkGFix+2febXDAeJO/YEILBB7pU1g8LQFo98QASVGYNQ6DZfEG3fnEqrgLhbf/HV15anbkFNCvohWSl9XPQ2XTM/2s3I4DwPIZwBEDfgitH0Ek6N6x+u/iD7T4g/YdBBYPpWHEaHlqwNw+AQa4Yj54JrJO+aQDB4pt+oCAyYvOPEIQDCgYfeF/9U3AbAMX7ItAlVtAspKZdz5SOlvA2pstxjES3wJ+92NgAGK2gwi78QoVfEhBeQACqNNP1RdoA18kKdgDhxkUI/zKIYDCnqyzB3jwAJnLFOEIW7QEEi1/1Y21ywVglCAcQDD5/Efj7M4CVrZ5AKlkhxeQUaxBI4nvFzxf8IfCVC4HV7cC6ZEX5nen3VX1vAGLZq8ysrvHY+QBwbGfI2E6JpLvdX+ksthpUvQrmX/sVDGZVUJZgb17vJHLFeGQcmCdVb5+Cxd/5xjZ6QzzMLOQBBIOfTV2Ps4HFHQ7CLQUQmUrV0rgKJMsCjsxGAqTn/hzw0EXA4tnAyg5gbTYBorKkUyLnkB9YVhTxu+kT13iccwtwdBewPAus+b2ar9xJAafqfgMQO4dh+J9+BHe5gqZZZzYok1JJUcpaR6bp93P+W/N6p0KuGIemgEWKgPQhWPxdP7NBLhiHKYHUp2DwpZ8rLOD8tmJQVplOLxAqmbRKC6EDYC7/CeCRPcCx3cDSrsISrs04CPm9ArZk55UvKAspYLqPaPdR4/H0g8DRHcDyVr/X6VabLHk2PhjpPVZY7d5xwF6CwS9y/4LbbVyQsEKIufGiKe0p2JvXOx3kinF0GjhOQY+oNRtljji9TQPf/fOV9IZY4Gq4D8Hgy/4W+Oo2YG5bUUy04vUcLCqSJVRWszJbNgxSmMau+q/Ao2cBR88EjtOqbgNWWaTkIFz3YiWrF4nAjtN0nBZrJnU+/8PA3CxwfMYB6LUra3oglL0tps6wlVha5rLiqd9AdDfB4Je6U0s/0BXTDYh80Sr2FOzNA2AXuWIszABL1JaKWq1R+nwGeM17OsoFY5XTVw/B4Cv+Djg0C8xvLYqJCECzgsxmZlq9T8e0XGUyaUizavPtxoFr/zvw2BnA0Z3A8e2FVV3x6c4sqwObckeyhiXAowUSADhD1XhceDMwx37lvU4XxVN2n3rJIocygkr/Vbs7fe+EdBLcfaXXQ3IPWIrpBB6XlnwpR76jYG9e7/SQKzarxM7qJFj8mg8UarMV9IZ4gvNDD8HgKx8HDs8A8zMFAFnPYQPDl0Co2g4fpDZLqKCxT0/7fhJ4fCdwbFvhRiwRgJruCOwUgCpeCvUjZmEFxhfk9W969kW/B8xvKQqnVgg+B6CB0MsI7P70AHgmd2n1NQ0rv7FvALIlVYK73MnQCDLThSGZoDpuP7uCeuX5n8zroB5yxThGnQ0CgyBMxY63Aq/5aBHG6EBviDlOLV0Eg1+0AByZLgbl+HRxnZXJoqqttA4ODovlJZVuSjTQFtq+NwNPbHMAzramdVpVs6wEoPtdNg37wJfvsYiJP9NFqvHY+7vAwjSwxAeNxVO8T6aNVRRRlT6hHrJ0Ovaw0WDJCKng7g86APvNB9wg2JvXO33IFWOBgn8EIf2nRLD4tbe1+AU7yAWbZeskGHwVdd2mgAUCcNKnJgLQrZ/V9/Jnn5JUYmnAE3hCmv3+t8AWQfSzyPK/POOgJgDdsgqA5nfJAvLdLV+bz0kK4RqPZ3wQWJxyAPqDVhZQyQr7gyaXI9axWCFVAGLvRUhV46PgLnUWBs0HbBPszeudPuWKsTRZAJDTo8l8ui/42juL5veQC7ZpsEow+OrZQlqVVuH4FLA8WVyDAOTAmHUQCAWQkOlsQAwDt/9/AE8SgPQpNa07+AhAA6HLXbb5Xr4IaAMfv/eGvP5NzyYA7UGjBWTWjh40v9fSyscHLtaxhJWxFVsNNAXH1khw983+DYPmA5aCvXkdNIBccemfceooAfhAAcA+6A2xLuAGucxrzgKOMexDfV9OwbS2BB/BEoqLSrBoYGgJ3E8qLcIEsP/ngCPuUy7S13L3wb6PU56/m/Xj4Ps0TKCXQA6AXuNeZY3HMz5QANAeND1kwcKXlj6wOZQ+b7R+Pi0PD0DeFAfk590CKg8qncfoFzIRVWVqfFfBhgn25vXOAHLFWCDbvPstBsJZ4LUPt+jdesgFg+qVptWq11bg2gtgfuLiRAAgQeg+oEmsOujsXb5SsAoCIN/3vx04OlNM6Yv0tdx1MKvK7/TFjVmeCD4HQQQhf159eV7/pmc/kwCcKABoeYvR0oept7SEoZQ0Tr1lPuPQFlAtO0nyAcWhpzw/FSjFzGjLx+RGvxzoSeC1hwsA9klvaFN5FAy+9mJgnhaQ0qqagglADo4c9AhCDpJPl5ZommQ8738HcGw6AJBW1VecZv0cePwOY0/wl1lAD/WUCx0mMlDLr8bjmb+Dwp3x4nkDYbD0thIO5aNtfmDi/xGEeRawxhs7Vb/q2huABQJwAlhyy2cC0xoggjAAUCWWAkksOiIY978TmOOqeqqwqAx3WGhHK06n7TDwOcAV/iipPAKjwgrZm2o8nkUA0gKmAHTrp+o9MTrEYvq44o9pZIOtgmu8mafCV72YAKT/RwAy5OPOuVlAAk9Oule6xQRTWUKlWtkU/IvAHAHti5oIwDK841ZPFtCmdr0U8PaC9hVultd4CIC8P2Ztt/m5/qC11TJXlJDGGpfGAmYODgFoCxACkLpuWh3KCgqE8gNVZK4KtxgjJAB/2X1Krao1rfN7CWZf3LSBT4uAEIyWBVpipL7GgwA0AW25GbGENBTRx3rm1M2w39mmrFVwjTd1Kn+VAZALEE5LtIDyMWUBvbLNLGHgd5H/V07BDp7r3uU+Jadgn3ptxekA5MBri0/Wp4wzBjDbCnkMWMqVpE8GJwLQqvfc0pqbkVj5aNk7gbCxgJno30cAjntowtXNaZ1suvSKNhsYTcVKmw9F5xGE+94dfEoP+JYhD/8OC8eIPUsUHokVVKB78XszbzAF4Pvd//PCKVGIpOAr78mn4DZOm8YC1jco+w6EFTDDPJqeCEBZBa5GffVbhmQ8DtZW5TYOvPhXip0GTuu22lTMLSw+aAVl9QhEWjurI/aQiLJkTMLsX9R3r/ymZ73fp1+37OU9hunXSkdl7T3QrhKCtlCM59k2i5CMMSIAGdqxEIwrmptzTsCEut5yilKoJLAcxCq3fe8tLCDBFwO+tKjyuxSCMdYEXoeDrHcHvu0tTwLzmwHA4N/Gh6zNCqqeOSxC2lb8tQSiMwbuqXIqAcjFh2JjBKGJyShQG6ygVbfJegULWBYcMR3rvb6oCRaQwFPgl1M5rR7/JtBZOIZWx/0+s4QeY5z/1/X2tFnAxPpFELaVkdLN8MWGVr4pCBsfMHN8bmTKfCjZ0Ncp456/x58zLzfw6Qf3ABd8pUgEYmqk5bGyek06IQl1bkXScnlN/u8L24Gdx1qVq91KQvrpgwaAAw9p+wnXPw1YjyWMGtDo2ASOFGMU7SIEUzdYD34vMPmXwLbHgdkFYAtlGiim6DpxJtvq9LtlVr/aWKEB8pUXAOOPAFPzwBTZ9r04vdQ9Ts4pAZ3cd+yHxgfMAOH+vcA69/9Uxijmz/AerYpdar1lNSMYzV+vWY/34I8DY58Gph8Bpo8A04vAFEFIknIHohGVR62QhFRSYjQE6qFri2z3iaPAhHNNlxKwArI0Q1IAxwfReacbC5gBPp66/5ICgLKCtqnsrKKlrFZUFPKOr7osMTtdsxzqQRZ93Q1MPARMPllohUxRqkEK6gShOP0S+dY2hlRv99y+ovRi7IiTnTvLqmg6xDPYpqAUgRgsoR7MxgJmgHD/c4E1FXu7FRRbvEgd7evXWlbPpp9EgUjiJpwe6zwOMlvpAWCMVusJYPIYMOlSDZRpoGiNxKzbdIQlXONMWJbGtw4svdgz3El47nzTRvPrrKptAJT6ZrzfintvAJgx4vsvdQvIXK5VYF3sUZxmJUvgA1FOvwF8spKyBtM1y6EepI4LqVMedbEaTp0EIKdPKh5FqYYqSxgo2jgFr13j6XXHnOiSZOeBVSvyC8qC2r05FVvVw9cAMAOA178AWPMp2LJaaekiCPXExwHw660n1oB/niGQazwOkkSepbJ/72I1x4CJ+cJ6lYI1riccrVicUuVSmIW82pkwnHHVOKbFsOozQGkFkwewnBES37ABYMaAX39ZAUCCb82nIlo+40p2gNnvsoKunxH1xGwA/LOzdQOQJPIuHzV2GBg7Cow7AI0l33XfjOsv6oVodes6ISbBsAZMX+kJxU56KY7pkmFVhOciuvTzSt05v0+ryuT/9gDrZNe4wPMsI7VJP3GcP7gUOOdvgL1rRYJ0ZI5IV3hV4/wrGYPPU3/AiRhYusy2K7mU999P+z90ObD7LuBZK0Xdkeq9NSX2+o4HLwfWlopFCC0fgciBMtAFC8CGrYXVoVjnU2G7rTXrzh4kfRzLY1kyGwBoeiGcPiXb5eAzdXWnazPCSScb4j3xfmav8Cx2p50lAMW0VXINitCogl2r9H2dcctWwQxQsn6ZTBbMNtcgdKIbiZj51VcBk38CXPxoQcfCUg8pjcYgZScw/momACnXyr4leBhs5QaBTHpf7X8dMPYJYO8XgAv9e8QJlAZZq8D4xSuANYKPJQn0AR2AHKy1MACKe9nfFI6IEqduEWoHIJ9wlsVKLekoMCa9EAegSTYQeM4TXco2SEMkAHEbBZoj4bbYtdyCVrFqGXgTSxgXYTZeHLi9AMjEQRCVUXP/n4KUaaT8vVTi+Rtg7GPAuYcAWlMCgUVkQfJ2Q12yBvPXMwHImhDWwf81imsTiLSEvHZkr+jY/p9CQRD4p8DOBwteItai05qn31FFdfLlFxYWgCDUIkRkj/TxbCEi/89jfPZ3X2VqYSJQbmUNQY3HQT7hbv2sLoerVwKQHNEEoCsm8R4MhPRjXUGzVEIKIoY7yaEYuY4dgGb5RXruoSgtSCLLarkICQ9f6QNykGjFdjsIBaI4kGlt8W+Rg5g0HJ8qAp47nihAzFpuWtPIMBZJlASILvR6fQ0DCVbJCkJOJCqnk4pGpb99tZ8MopyiKDX7WWDiwYKXiEQOehCrgKh+eJQ+EQHo1Lby/zRlyf8TIbf9XS5ftIb8I92YugH4ay2pLusorl7dAoonWtMwQSTdOFuQSLTGHyIC8kxSIQuA4hwU2WUAoO4/grBcDbsfWElSzg+JCoYDoEGM1ixSkHzgF/wG7y8sIa3J7JPAGWuFJSQIaU01iJHUiYP4e33BrPOHmG/JMaOfTZVYRhwGav87vWKPJ9/rSH4IOGO5sITqg/ggxXs4TOaBAECbeoOsgfl+DrQShFqcEIhyyt0MbMusEkx76iAZXKM8BvXiZAGlF+KaIbaadYpem4aDgpJZQz6YJABV5VcHAJZ0v4FxX6KG5UpYs0KnqjhRuagEVgPglYAl9ciHf8mdUrJh0Qx9vkDBzBywfbkYQIGwahA/kglATsHsDzKA0BATiPyZ4NEDwIeoa/uFYKKXL2f24nQoIgd9R3yQCMTFqwIAfdBWI7+yB5ZLECYLETd85YJl+2YAUNosLIel/xYlu4Jsl6bhNhD6it4WJCvA2Zc4Gxo73RcgJeOqFmGR6rcChLYACyGojmEYdj59KnZ+tIQRhH9IvWA2hiREjDeRI9Cly7fMF3EtWRFawhQIf5IJwE56wdTIYdt7tp9ys1K8JnoJvod9Wn682PNkP4hUy1ndWgstAtBDMLYN5/6PAc5DGNoF4SrZfN+4+IhT8jqwg2Cp8ThIJ5vfSWBXAVCrWN9SMxDK+skaOvhoAc8me654pmUB3f0wyt+E8FyRAGmPlOEoiSD2qgvmAKoOm52fAuiTDHSyIRxx+lI0QxxADubfF5vffMmSajrWlP7nmZ3dSy+4r/ZzAUEHnQ8R70HsXlK+PgJsW68G4XYGZj0EY2EYATCAT6tAhmE0DXcC4faapcwMgAIfLb0kuzT9Qmw5uwAAIABJREFUSi+EfeALkSrpBovbrQDnkm8wAo8/E3i+CCsZ98NCpAp8cUekZyBavI4ET/TnaAk/RQCyAXy6uNSPA0i+wMeB6ePA5HFgZq2wpNGK3FUDAHmv3fSCe7afX8CB4UNEEOolVi/3obastNwJ9cO5BOBKEQMsAcifHWzRAigWWAlCn5K2bQYAOe1KMjTIR2kRUhKVS7IrLia0v+3xwHMZMCbYNP0KfG79zAqK5DxOvyEuWu6VD5KSHy2YAEQAfpaRdl5UkuUctIpBnCIIl4psD03FtIIP1ADAlBuJM47EqqUX3LX9kSBQcuuyftK78xUkHyQ+RLqHZ3Fv1KcgLj5kAQ1s0Qo6IA1nHhNLQzA8ZxvBXuNx8DcS5UYpNnoYxsCnUIqvZo0F3wPTMa7Hv53HOJVbS/l+5bumX7d+5WLE44hxIRJB2NMCqj9ixwuE90svWCaIA6bAp959EKeWChAyA0PTOV2unGMQveCO7bfqHbcS4rJR7Ewqnw5AWhLuImg2uFQAXAVs8RGmntW4+g2hB3P79L/EJ9zGvqrxOPibiVihAOgrWQOf/EBfBcsPNBBqW9Hv6zzGqFzmoXz3B9AePgXiq6bgiv4YOB9QHS8AfpkAFMMjrWAcQA0iO9XJiQyAnos2vV7ESHOOQfWCO7Zf7F40mZFQScRKAYBaSU6vAVcTgN7xXHiUFpDTMK2dFh56912BTiDcvpkATIXzCL4g3WXTZ4jpGfjoF/oihL+fx+0yWUABLwIwtYKKIabgCzHQvi2ggBKn0McEQDaKT5cGkIOo6SuyYzEfjQB0EM5nZgAPoxe8of3sgSqCQM3jkdFLvpRvR13+7UVRuhUFSavNO6otwp88ZZ3+t4M6HLtch6OT9AG/q9cmtf//gV1JDYcnQ2zY6/YakfSrU+Pg1M45NqPt3IEtoM7WFHokyrWKkooglCMWLYjiUXMtK3g8Uzd1WL3gDe3vRRCoUEYCwGtYFxxqgA2E/jI20F5hhmQod98BHNnlxOTig1aGiDanO21yV4DygWuB8YeB6fnC9WEtiKVVKeE0ZGiXWczeJoWMIig5a9V5DA1ANoKDeDylZ9NSXxyAsiKawrQqmCv2HVf5e8aRoxfc1n7xs+khItAUvojvyWryxVcWJZksVSyZoQRA3dcAoHzax4Gj2wtu6FVKM7gMgti02jbV476oUJJs1j/AbA1mQ3Pm8eTRsoZDtR+xZKCiEKmMXTIeXHPGdhYArX8FwG4DGMEnAHIK4yvT58nWC2b73cexaZgWWaEKgU1gjNbPP7PvOYGsUSBkv3hBtmRWNzxjTk9RWktvxp6POj0vARjY9sWkFel8RWxegjIF4RjwAOnZWMPBTGjqvHmszxJOBUD3xyznL2bqROvoP3N3q84jG4C7M/PpcvMBef0cvV9k6hXv+2Yno5QfGArRbaCC0mWv2YtF3ecerNDhkNZIIsXQRv5dlTtGADJSz2gEE1EJQM//026HdIEZLC8B6A0tk0g1Ja8DuzJdphS82QBEZj5dbj7gxZN5er/IZI+67pscgE7QaDOUMyC0Wb8+gXjuR4F5J6YsaXnFhBoAGEVvUhb60jISgCQnoh/OLBgvIrL8v7DdFkEYM5dtNg97tvz5zJqzdfIBmJlPl5sP+DJP5xtW7xffnzeh7H+Z+3+RpkyWT1YxuURJYVtx6T0fCTocouQV85VkHRIGegEuEv/YKpkA/JceVmL8kv6t5/9pu62tfiPWcFQVEa0DZ9WcLJEPwMx8uvfnjT9IgZyj94t/ldeA/S9tMaGa9SNdmsIxbvVscVJ1GScoMt4UPwhAsmMZ0aXzQBsvdGRBjQz0FUpEJRAJQOq4KAnBdz+sfiPJ3bOYn8fsykyVWMfiN3BOzckS+QDMzKe7OW/88aqQzsfE5kH1fvGjeQ0wADodmVGwOeiMsUqHrGOnS4UFy9P/wAEojkEnI+IqOIJQNLgpCXhcmLAtD/D+kgQE235L93tj+YBqgTX9BiCeW/NedT4AmQ+YkU/3sbzxBymQuZhm8g1T+QbV+wWFdjKO/Te2mEFNlCb6gPF708VJ1TXHgKd91GnZpDfi1k/gM2vqU3DUnCuBmNQe3P9vw6pe229KOvB0K1k+ZS+rnrfM2AlA3JMZtah/EZKZT3drxuDz1O/yxAwu9JgJxr3lQfR+8aa8Buy/wdWQZAVl+ZzCrG3q9c/YrkmHy3IRYryAAqAkEBIlopJxNNUbER+fA/H+/+AAdP9PmS9dazicJybm7mlB8nR2dI1HvgVkOlZGPt2nM29GCamcGZjAwlQ+vvrV+8X/zGsAAUiLVPp/wd+zaTMFWw+/kAA0GQQnpCw5mDsAMIrcRB5mC/+MAffTwgfwKY2KfmCZ6ZIkUShrxXxBX4yYaV8Hzmcn13jUA8CMfDqWYeQcSkhVOl8U6uxH7xekrsg49h8oiCENgC5TUG5vKxxT8f2aRtOtcAKQ1s8soPuOVUIwpchNlEEIOyNSIrrvv3hwnckWIZPZsnbcDyzTpvg3lU8mpZQqozyfK74aj3wAKh1LgrsD5tMxiz/nkGD1sHq/YNFOxkEAcuW7oqmXlisuQOT7VV2jwi/kTgj1RkoZhBje8Z83SCAEEJZW0C3gff8tADCt4VASaWIBK0HI9q8BF5yUAMzIp8tNx5Jg9bB6v/jdDPSRns0BWIZeUitIo9IhHmhXTvzCPQddccnZ76U1V/IvC4SBCFyg26DFNg7c++Mhhb6qiCikT7WVUmr6lYn2nRKyrdZ51GMBlZIc07GUBdMjny6XCiUmpA6j94vMZbgBMFo552pu27PXAqXTyAUQcitOQjAm9xX0N9pIwIPmSCmH5QuPqER0L4kDYgp9zOUL6fYxkbZcFceyAreAF3GlV+NRDwAz8uksnT3jiILVSmpWNlhMze+k94vMZfgGAPJeHDjpCrgM01Tdry9OzvmYAzAqLVWIwEShwzbRwwSEn+MqP6bQK5tZlWyhjCCCsC19Xv7gOnBRbgp7cu/5AOyVjqVMmA75dJZ9nHF0yohWNlhMxKnS+0XmMtwAmFq4imnYbrEqNJPc+9kfd62RKh0On8qV9hXZ9askEPgAfI56ziocUgVbzGT28lEtRMoKtg7lBHtznfZNA+CQ+XQWM8k4uglWK/NLYKzS+8U9GReXD0g/Tyvh4Ne17Yb4Zbr6g6y7/aNWcoPpjKRTsJIags5IJwkEAv6en05S6GUBfRWsUExZyVZVQCQwrgN7Wfdd41GPBczIp8ODeXfTSbBa6YYxlY8/p3q/udc3C+jTbtvqt2oadnB2m4oNgMn0W0p+hYWHWbwg9yU/0Kb9EIy+5y2hiCit4UgKyTeAkN8Valk4Le/ldlONRz4AWWBRM6fdIPfHstw/G+SE5rMnVQ/kA5AkLHS0ak7V7reXfhgACaBqDtD3e/nmc5k9kA/A80JReq+U38zGVp3ObJo/BvAOD3dtwiWar9zEHsgHIGlFubqSx7+Jja36anLLcDvvgwA+NDpDfILv+qlzuXwAXuSjrkKemlO2e3U1uWUYnL8dwB/5e2apca9LNv+vsQfyAUheX4VguB+mzIsaG9ntqxhF4Xbe3QD+n7/uHLAW9wQ1tblMRQ/UA0CaHC7plXEh+q4T0OWcfhleYTSHBK0EH/mi+fcRuKQn4I6fWpeoB4AevCz3HOOm9yb3F5mBlZBNclYCj1aRfyfrbgPCTR6AzK+vD4CyglX7jpmN7HY66d1E0ctdIrEEE4wEIMlam+Pk7YF6AMj7EwAVbU82vTerCwhAXopJN9zVI+AYrOeULLZgErY2x8nZA/kAJGWr0naUWdFpy2cT+oCWjpdjLFxE5UzYIBBpEUX5nLnlvAktb76SPVAfAOUHpiAMm96bsVtCAMaKALICMyxDq6cXfycA+b/mOLl6oF4AiqBRIEzBp7/X2Af0+fi1XIioMIlAI+AIPIGPmeROWV3j1Zuvyu2B+gHoFfZiDS2lC0LiY52WUADkQoTTMH1BFSYRdHoRfKSu5v9qrizMHYPT+vx6ARhSuDcAzzmDo5ZGHT1PAKYMwQxME2jiSo/gEwBrrq+u41ZOy++oD4BaCcsXTPiSI3ey8s4KGoG8QwCMFM+0ggQhLR0BF19SXuD/ayakz7uR0/TsMcxg3SjfqWNA0hsrga/ojaq/8WPcC+YIk4Ke4CMSuB2XVht1Oj8zIfXlU8BtU8DhmYRXWdfrdF1fgr3+S8At48CD04DVjXQSDO70PTUnaJ5uOCwsIIFHSSFy1pKPWCDsZxCpw8UVgKSPxLXM937OzxxAljzcPAbcswU4Qh4V3UN8mKoeKm/bu78IfKJQa8VD48CylHQiL3O3/qg5Rf30BKACMtJXjXKQcfBSK8Dfqc3KVCwuN2VFGRnm/yKZtq4Re5ifyQQgM2A+BeB3GHaZBo5MAIue0l7Kt3cC4xhw+5eL7TuCkJk1jBtyerbUfYG5ExjZ/pqrxE5fAOrOq5SmowVIrRp1IyT2R6+fg0bgVYG4CsyZe2UsaiOGKXr4Sfp9k8CxCYAFSKyvXeY1o1BxQux91yMtfsHPutgnnyUuUvhc0ZsgUXib+nVkq6+ZKaABIHsgVZnuwD9sVo66rrR4ImdhLGSQ8zPL/JgBQxeU1ouWkO9PTgDzbgmXxrzMkatl3keivfG5x4r4IRcz5BfkO5vEZ0kgpIfBZ8yKjlL17syy0tMNcOn9dl4Fy6dLFabj1Mpvow9Ify+I4Nlo9Xt+ZqU9VdJpqZh4QDDyxUyYOYJwHDg+DhgI/WUVZl7aSEt93+GO9Ia2iuZKOfA7lhp9JpvAVy61w2mOwO5hmCgMHC1H9O24gu6UD9jP+ZmbtLRaSsei9SL4XDPbAEh/kGQ/pSUcc0lbApFWb67lQUhpVnLBsoKqqZclFMmUtrxPcwxl3X7vOCAtYLSCcugFQmqhdssH7HU+RznjiOlYXA8wqkOfkItTAom+oKygca4ES8jY+N3z7fSG4hfUtp3ihUHruVSsFy1iRvNP+1N7A5BdJACmVpAgZPhGOyCigEjlPLudn7kvFtOxuB4g6OjD8UWLRkCZFRwrLCEXJQQhp2K+37lQeBCRX1A7KPQto1prFEmSYn2mB9EAsO+kYfk8KQhZF8yjVz5gp/MztyOUjiW9bCUhEBhKRCCgSis45uQ/PhX/xfFWMgOnWu2gxB0TF/o0kEZ/kCDM1Ts+3RHYnwVUL6XhDFrAswfIB6w6P1MrTulY0sum1VICglKwCEACqvQFCUK3gHcsFQCM/ILayqP1k9JshVqrncMalOYYvgcGAyCvIwuod8YBJQmZpmGJeyRwkGw4n8jJOJQNw3idLFhMRNB0SgASTJyKoy/4ieXCeFfJBUeV2SoAclFyR0bbm1OHTUiN0/DTAwD7zQeM52dqj8VsGEkVE2jKetG7AEhQ0frJAv6RC0trC1skl+IWlNinGLbSaZg7Mc0xfA8MbgF1LQV1z08A2G8+oM7PVF9Ms2GUE0gQyp+Lwu2yagLgR9ZaYpkSypQ6a6Q2DCqzpkvietXIFdoZfuieGmcOD0DeP0HEbBhNwYPmA/L8zJQsATAKnguEqS+XTqkE4YfWWwCUFZTksYAYwZfIBeN9Tw0cjOwu8gDIZqsoSSvhEeQDiiGYFoyWiSDRypWgi69UP5sc5fIcquSCNeXqe2X9ZAHfM7Khe2pcOB+AT41+aO5iRD3QAHBEHd9ctuiBBoANEkbaAw0AR9r9zcUbADYYGGkPNAAcafc3F28A2GBgpD3QAHCk3d9cvAFgg4GR9kADwJF2f3PxBoANBkbaAw0AR9r9zcUbADYYGGkPNAAcafc3F28A2GBgpD3QAHCk3d9cfOxqYJ2au9RdPtdp/khoEOlglDYT39V1PzQFXLsMXAlgt9PCxJKPbufyf8/KHIPfBPAZABf79Xc5XQ0ZQ1Q7360NbxoHrlsDvs5ZRsgo0une06by6X1mZvtP99PNAp4F4LsBXA5gjw8EGTeqaGF4QhzQF80CX7cAvGIdeDYAfhdZ2sTKUcVrpE7nd31N5gj8e2dIo2osk7NZpMdK0Z19tv+bJ4F9K8D1ACj8yfNSikHeg+5Z969m57Y/8/ZP+dPLKZhP/rcA+AYAF7g1oRUhEMUzFMt6eSJfX78b2DkPfM0i8GIAX+uWlAMppreUUErn8p2gzTl+2flg/sDbTkvIOik+CP20//mzwAXzwDcCuNTPJeFXpEpM6QEjIHm/zTF8D7T5gATYNQCe69aAloRTGulfBESBSYNyxR5g/Bhw7hKwZwl4vk9LnM5JmsBzUyDGAX3B8G23Mz/g9BuUa/0IiutfMkj7zwKmngAuXSvOpUvAWYBtF4BTnspIj/O8zPaf7qdvWITw6eZA0JLQEhKEGgxZhUj/dz3NzSKwbR44exnYvVKcy+mM5Km0JhxInUtrGkmzCPicg3W5LMGkQiZZTm9xS9Z3+4m2o8C5c4X15pTKW2Lb+fCx7WLtjYxzqiql29Icw/dA5SqYf6RTTilg+lYCIXmICKQ4IK9wxfSJY8AZK8CuFWDnanEua9ZTAMsaCog3Dt92O/MvnRGBtGwkqKRmMEkqCaa+2k+0LQDTh4rP88UHj74kF1WaATo9QHQ7mmP4HugYhtEKj4PB6ZQ+FS0hQahpldPya1kXTOqNY8DscgG+HavAttUCvBxInitrkgL4lcO33c7spBdM3kAuSnq2nx9gQfAh4JyVwvrxwel2z3p4aMlzH6DM2z/lT+8aB+Q/OT4EEqckWQSBkGD6EQKQnDCLwBSnYgcf32fXioGUFawC4esyu7CXXnDP9tOCsyD4KLB1rmgvX7zfbu2WG/Jtme0/3U/vKxBNAMoi0KcjkATCN3HOEr3UAjDrwOP71rXixYEkeKMFlSX8ocwR6KUXTJ7AaNE2tF8WfA4Ye7Kw1mwvX/yZn+eKnvcrfzC6IK/ObP/pfnpfAGQnySoISBqUXyAASS1AK0JfagWYcRDOrAF66TxZQU7jBOEbM0egH71gcgXSFZAV54NQtj9YcNIpbONCyh8Ygi8CVospApDuB63g92W2/3Q/vW8AsqM4gLIKBBIH8bcJwMCNMX68BTqBb8s6sGWtsIA6jwDk662ZI9CvXjA5A6NVa2t/IAicnC/aGV+8T74IQPm/AmGuBc+8/VP+9IEAyLslAKMV/LgAyIUInfnjwPQqMOOgI/DstQ5Mr7UAqMF8V2YXDqoXXNl+EQQ6N9v29aKdesUpWJZbAPyPme0/3U8fGIDssDid/pUASCvCaXgJmFguAEfgEXT27gDkuwaUg/nbmSMwjF7whvbLhSDL5TwwvdRqo9oqHzACkCB8U2b7T/fThwIgO01T1IMCoAZxGRhbKoAXQUcQTjkI+a4B5e5FzjGsXvCG9gdqrLGFYrpVG/UuHzBOw2/LaXxzbh43DKeoJwlAHqLndSs4udoCoIBHQE45EPk3DuitmYOQoxdctp8+rFwIWsGFYiFFoLGNchcEQC6e+OJC5J2Z7T/dTx/aApYdJ37AyJK/DIwvFxYvWr0IwEn/H1Opco5sveDUhSAAF4HJpQJkWixp6k2n4IYfMGf0amDHev2I8+l4/UbvNw8Eozw72wJePOJ8und7EkKj9ztKGA1/7WwATo44n45pWI3e7/AAGPWZ2QBkYHCU+XTMfGGQmYIxjd7vqOE0+PXzATjifDrKtTZ6v4MP/MlyRj4AR5xPF+VaqZLJF1UzKdPV6P2eLDDr3I58AI44n07ZMARbo/d78gMubWE+AEecT8e9YOn2Uheu0fs9tUCYD8AR59MpG6bR+z21gKfW1gNAz4geRT5dTEZo9H5PPRDmAzBmRM8BJzqfLiYjSKKr0fs9dYBYDwBHmE9XtRfMsIz04aQZ1+j9npygrA+Akqs8wfl0BCCTWRq935MTYL1aVQ8Ao1zlAnAi8+kEQGZTNXq/vYb75Pt/fQAcUT5dBGCj93vyAaxXi+oDoFLyT3A+3Rcavd9eY3xS/z8fgCQX/LPR3SOzkon55jg1eyAfgD8M4NcAPD6aDmBtB1e4NMDNcer1QD4AbwbwxwDe4UvRE9wHZG1gNSXDLlwLNcep1QP5APxzzwj9IIAPnXhT5ORc5EYCA9HNcWr1QD4AmRH6FQBMTSZZH98ZmD5Bh5g1FopiNns1x6nTA/kAvAfAEwDudnI+EvQxPfkEzYfaCXRSBluQMB7YHKdGD+QDsBNBH/9+AkAobqTADGK7Inw1x8nfA/kA7EXQt8kgrGAGMfBxZ5Cv5ji5eyAfgL0I+r68uR0QmUFoBQU8vfNvzXHy9kA9AORoMw7CdGQCjoUZDwL4kv/+8OZ1gJhBIjGDgMh3vTavBc035/RAPgD7JegjODfhiMwgoqeJwNPPTaB6Ezq/hq+sB4AcXeXEP+ZhGVo9vRimIQD5v5oPAZCupgDI9wg8/qz/1Xz55usyeyAfgMMQ9GU2Op4eAchpOIJQQEz/VuPlm6/K7IH6AMjgGzdl6QtyX5jWjpQFevF3lq3xf6yhrOlIAUgQCojR8gmE+l9Nl2++JrMH6gEgR5UA5KYsc+AZmCbQCDi+IvgEQMob1XBEAHIajgBMLV+0kCdws6aGu3zqfkV9AGTwjftg3JRVVRAtHQEXX/wbAcoXP5d5CID8GoJKvqDAloKOoIz/y7x8c3pmD4zhaqwjRzCYyQg5gr2ZgsFTLweWr8XQgsXjbwLWrnNtMlKgNoLBmZAa7PTCAuYIBlMvlWQswwr2UlUw45jdDSx8HbD+Ctd+HVCwePKbgJV9aASDM8Yg59TWFDysYPBtmYK91IbNOHaPA/M7gUXKXA4hWDz79cA8+W0aweCMURj+1HYfcBjBYO54MMY3tGDv8I3nmWSHOzYOLJ0LLPGXAQWLz3oB8MQUsEa16kYwOG8whjh74yJkUMFgbsNlCfYO0epwissVY34bsHw2sEIRkAEEi/dcU0SP5qhF1ggG5w3GEGdXr4L5134Fg4kAjuDQgr1DtDqcUmZETwArZwAru4BVqsv0KVh8/o3F4v0QXZBGMDhvMIY4u3MYhv95Zh+Cu1xBcxuOU/HfeDIq5cv7FuwdotXhlCBXjOXZAnyrO4BV6in0IVh8wStLuWCsUAyvEQzOG5ABz+4eB+R/ewnu/kOP/3G/l4kJTERlljQtIot2e53/IwO2OPl4FLtcnCqAp9cahT56CBZf+LpSLhhz1N5qBIPzBmTAs/sLRHcTDKbiNHdBGGymOC/3hglEvgjAnoK9A7Y4+XgiV4zVWYDAs/etxaubYPFFP1QkLtCIP8neaASD8wZkwLP7AyC/tJNg8L/xLNBu+YBdBXsHbHEFAINcMVamgdWZAoRrfPdXm8KitLdmgYveWAq+2y7iMqfuRjA4b1AGOLt/APJLqwSD3+y5T1yI0AoSbAxMMzGV1o8/My2ro2DvAK2t+GgiV4zj4+3AIwDXtwBrVJeuECze+9aW4Dut4PxkIhYsdetGMDhvoDqcPRgA+SWp4O4veQ5Uv/mAGwR78+6rQq4Yq9PAOi2fA4/vBkKudKVU7VZw77uKvWFuZbtcMNb5v0YwOG9g+jx7cADyi6Pg7gccgIxlcA5TKhaD01yYKBmVFpBZMfx/m2Bvny3t8LGqoqTliZbVI+gMgHwnMAnCIFi897cLAAZ6QyzFzzSCwXkD1OPs4QDIL5XgLmk5JHk/SD5gKdibd38VcsVYGmuBTaAzEHLHgyCcaokB7/1IkUET5IKxwF5pBIPzBqbPs4cHIC/AaeqvPL9pmHxAE+zts6VdLCD/lcgVY3UyWD0Bj1ZwqgCggXA7sPfWAoAJvaEtZBrB4Lyx6efsPADyCtmCvf00s/NnOsgVY3m8BTRZPZuGBUACdArY+5lWDqGmYbIrLHEx0ggG5w1OH2fnA7CPizQfaXqgUw80AGywMdIeaAA40u5vLt4AsMHASHugAeBIu7+5eAPABgMj7YEGgCPt/ubiDQAbDIy0BxoAjrT7m4s3AGwwMNIeaAA40u5vLt4AsMHASHugAeBIu7+5eAPABgMj7YEGgCPt/ubiDQAbDIy0B8ZYNMbkX+ZekpuIiOQrPar+xs889HJg6jZg5jAwvVZ8B+ll9PlO5/Fc/o+ECjnHfi8zYfkvM5ulmp4qJXVqx5deD4zfAkw/CGxdAZgoHfuh131QkaI5hu8Bs4Ds8B0AWLnIRGCBsFfn87JffDMwdjOw5R5g8giwZa34jnQQUwDo99wBfJ4TM7COiNdlaj2rA/jeV/vfDeATAP4UGH8I2Lrc6gc+SHqY4oMZ74VSKM0xfA+UUzB/oBUUCKMl6zSQ/PsXqZD5KQC/A0w/DEwcAcYXgYnVwppwADuBkefnCim90FmBWXwnK87Uen53BI8sbuwqaz9p5UgnQhBS+ZN1zE8Ak0utviCwq8DI8/nx5hi+Bzb4gJzKZE1SEFZZgS9/2pWR/gTAJ4HJQ8DEMWB8ARhfBsaWCwDquwQKvvNgHXvOcYVbPFJPkw+dDxC/W1Y4tWDpw/Rlgo4lo1T4/KxTihDNpJwj3/UiMLXemprjffC7eWpzDN8DlYsQDiKtVxzEqoHkyX9HRizW+nIgaQnvAiaeBCbmC0s4tgSMu2rMePAR9X252jXklaTFU108K0MHav/nvJ6ZxVVk9OI7GR2IZoGQNc/HgbHgIwqILIVujuF7oOMqWFawCoRxkfEIB5CWgkREBCNf9wMTc8A4QciBWyoGz16rwNgaML5eWKpctYZL3N+TWLX0gvtuP0HHk2n16JDyxXmVhfU0qywbJbr5GSuXKxA/sV5Y9UYWdnjwyS3qKKgarWA69Wg6fjQOIK0HadnIjPVFB+AiME4AuiUkCFnESyCSkmAuU7Cjm15wX+2X2ifBRn9A8mKcW2UFjULVQcgVDl80u40SYh763FfvquhLCxitoBYUsoJfjXKttByMq9CKcHn4sPuCbgXNJwyWkECcz5Q376UX3LNncZyQAAADEklEQVT9fFgIJs6lBBwtn3Tt6FpIz4RWnuQxPh2XIGzm4CwQ9hWIFgBTK0gQHiIAJddKq0ELQh+KL1qUR4MvSEsoENIKrgALHNiMox+94K7tl9qnnMio8MSf6SNwGpYVjCDk/Ju7isq496fCqX0BkDeqlWwKwic1gAQSpzGREnFgREz01eALLvvq2Kfi45m6cf3qBXdsfxRbJMho8dimqOhEK8cXQRr9QVpvPoDNMXQP9A3ACELFxPh+jACkP0fLIKFCCRRqKuPUdqjlC9o07JZwKVNHeBC94DQcZO0XAAkmgotAk9QYrR9f/BvByYfMSATDVMzwTXMM3QMDAVAgVHCZ7/MaQK4QZUHiNCbBQlqUw74YCb7gcmYkelC9YFlwvVv7RRAorTuBkECU9asCID9/x9B935zYzyKkqpfiNHxcA0gLQgvBAaPVkCqm3h2AtC5m/RyEqzw/4xhGL3hD++MmslgqCbgUfLKAcRrmTlBzDN0DA1tAXUlWcDm1IOIIJAjlT/Fd05lbFQFwjdtgGcewesFt7Rc/Gx8iWjUCjGCT1YvWT1MwgUqrf3NG45tTbcu0aximWx9xENcEQHGbcYAEwtSXSqY0gnCdgeuMI0cvuGx/FUGgFhwEYrR80QckWN+X0fjm1DwAWv8RgJFilJZBznz0pQg+AZAAlVWh1GvGka0XzB0cCQi30aSGVa9AF62fLOB7MhrfnJoPwPER59Px+o3e76mL5Kwp2G57xPl0kxc3er+nLvyKtLmhfUC78RHn081ONnq/pzcAR5xPR9mRRu/31IVgvgUccT4dNaobvd/TGYAjzqejumqj93s6A3DE+XRUg2VSCjdaGr3fUw+I+VPwiPPpqJjO8J1Nw43e7ymHwHoAKMFd7QErAeEE5NNJMb3R+z3lsGcNzgfgiPPpomJ6o/d76oGwPgCOKJ8uKqY3er+nKwBHmE+noqRG7/fUA199U/AI8+kEwEbv93QHoEhZTnA+nYqSGr3fBoAtaiqBUImdm5hPJwA2er+nKwBHnE+X1gUzSbnR+z11wPj/AeCpPDD3t7rvAAAAAElFTkSuQmCC",shader_default71="uniform sampler2D weightMap;varying vec2 vOffset0;varying vec2 vOffset1;void movec(const in bvec2 c,inout vec2 variable,const in vec2 value){if(c.x){variable.x=value.x;}if(c.y){variable.y=value.y;}}void movec(const in bvec4 c,inout vec4 variable,const in vec4 value){movec(c.xy,variable.xy,value.xy);movec(c.zw,variable.zw,value.zw);}void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec4 a;a.x=texture2D(weightMap,vOffset0).a;a.y=texture2D(weightMap,vOffset1).g;a.wz=texture2D(weightMap,uv).rb;vec4 color=inputColor;if(dot(a,vec4(1.0))>=1e-5){bool h=max(a.x,a.z)>max(a.y,a.w);vec4 blendingOffset=vec4(0.0,a.y,0.0,a.w);vec2 blendingWeight=a.yw;movec(bvec4(h),blendingOffset,vec4(a.x,0.0,a.z,0.0));movec(bvec2(h),blendingWeight,a.xz);blendingWeight/=dot(blendingWeight,vec2(1.0));vec4 blendingCoord=blendingOffset*vec4(texelSize,-texelSize)+uv.xyxy;color=blendingWeight.x*texture2D(inputBuffer,blendingCoord.xy);color+=blendingWeight.y*texture2D(inputBuffer,blendingCoord.zw);}outputColor=color;}",shader_default72="varying vec2 vOffset0;varying vec2 vOffset1;void mainSupport(const in vec2 uv){vOffset0=uv+texelSize*vec2(1.0,0.0);vOffset1=uv+texelSize*vec2(0.0,1.0);}",SMAAEffect=class extends Effect$1{constructor(e,t,r=SMAAPreset.HIGH,n=EdgeDetectionMode.COLOR){super("SMAAEffect",shader_default71,{vertexShader:shader_default72,blendFunction:BlendFunction.NORMAL,attributes:EffectAttribute.CONVOLUTION|EffectAttribute.DEPTH,uniforms:new Map([["weightMap",new Uniform(null)]])}),this.renderTargetEdges=new WebGLRenderTarget(1,1,{minFilter:LinearFilter,stencilBuffer:!1,depthBuffer:!1,format:RGBFormat}),this.renderTargetEdges.texture.name="SMAA.Edges",this.renderTargetWeights=this.renderTargetEdges.clone(),this.renderTargetWeights.texture.name="SMAA.Weights",this.renderTargetWeights.texture.format=RGBAFormat,this.uniforms.get("weightMap").value=this.renderTargetWeights.texture,this.clearPass=new ClearPass(!0,!1,!1),this.clearPass.overrideClearColor=new Color(0),this.clearPass.overrideClearAlpha=1,this.edgeDetectionPass=new ShaderPass(new EdgeDetectionMaterial(new Vector2,n)),this.weightsPass=new ShaderPass(new SMAAWeightsMaterial);const i=new Texture$1(e);i.name="SMAA.Search",i.magFilter=NearestFilter,i.minFilter=NearestFilter,i.format=RGBAFormat,i.generateMipmaps=!1,i.needsUpdate=!0,i.flipY=!0;const a=new Texture$1(t);a.name="SMAA.Area",a.magFilter=LinearFilter,a.minFilter=LinearFilter,a.format=RGBAFormat,a.generateMipmaps=!1,a.needsUpdate=!0,a.flipY=!1;const o=this.weightsPass.getFullscreenMaterial();o.uniforms.searchTexture.value=i,o.uniforms.areaTexture.value=a,this.applyPreset(r)}get edgeDetectionMaterial(){return this.edgeDetectionPass.getFullscreenMaterial()}get colorEdgesMaterial(){return this.edgeDetectionMaterial}get weightsMaterial(){return this.weightsPass.getFullscreenMaterial()}setEdgeDetectionThreshold(e){this.edgeDetectionPass.getFullscreenMaterial().setEdgeDetectionThreshold(e)}setOrthogonalSearchSteps(e){this.weightsPass.getFullscreenMaterial().setOrthogonalSearchSteps(e)}applyPreset(e){const t=this.edgeDetectionMaterial,r=this.weightsMaterial;switch(e){case SMAAPreset.LOW:t.setEdgeDetectionThreshold(.15),r.setOrthogonalSearchSteps(4),r.diagonalDetection=!1,r.cornerRounding=!1;break;case SMAAPreset.MEDIUM:t.setEdgeDetectionThreshold(.1),r.setOrthogonalSearchSteps(8),r.diagonalDetection=!1,r.cornerRounding=!1;break;case SMAAPreset.HIGH:t.setEdgeDetectionThreshold(.1),r.setOrthogonalSearchSteps(16),r.setDiagonalSearchSteps(8),r.setCornerRounding(25),r.diagonalDetection=!0,r.cornerRounding=!0;break;case SMAAPreset.ULTRA:t.setEdgeDetectionThreshold(.05),r.setOrthogonalSearchSteps(32),r.setDiagonalSearchSteps(16),r.setCornerRounding(25),r.diagonalDetection=!0,r.cornerRounding=!0}}setDepthTexture(e,t=BasicDepthPacking){const r=this.edgeDetectionMaterial;r.uniforms.depthBuffer.value=e,r.depthPacking=t}update(e,t,r){this.clearPass.render(e,this.renderTargetEdges),this.edgeDetectionPass.render(e,t,this.renderTargetEdges),this.weightsPass.render(e,this.renderTargetEdges,this.renderTargetWeights)}setSize(e,t){const r=this.weightsPass.getFullscreenMaterial(),n=this.edgeDetectionPass.getFullscreenMaterial();this.renderTargetEdges.setSize(e,t),this.renderTargetWeights.setSize(e,t),r.uniforms.resolution.value.set(e,t),r.uniforms.texelSize.value.set(1/e,1/t),n.uniforms.texelSize.value.copy(r.uniforms.texelSize.value)}dispose(){const e=this.weightsPass.getFullscreenMaterial().uniforms;e.searchTexture.value.dispose(),e.areaTexture.value.dispose(),super.dispose()}static get searchImageDataURL(){return searchImageDataURL_default}static get areaImageDataURL(){return areaImageDataURL_default}},SMAAPreset={LOW:0,MEDIUM:1,HIGH:2,ULTRA:3},shader_default73="uniform lowp sampler2D aoBuffer;uniform float luminanceInfluence;\n#ifdef DEPTH_AWARE_UPSAMPLING\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D normalDepthBuffer;\n#else\nuniform mediump sampler2D normalDepthBuffer;\n#endif\n#endif\n#ifdef COLORIZE\nuniform vec3 color;\n#endif\nvoid mainImage(const in vec4 inputColor,const in vec2 uv,const in float depth,out vec4 outputColor){float aoLinear=texture2D(aoBuffer,uv).r;\n#if defined(DEPTH_AWARE_UPSAMPLING) && __VERSION__ == 300\nvec4 normalDepth[4];normalDepth[0]=textureOffset(normalDepthBuffer,uv,ivec2(0,0));normalDepth[1]=textureOffset(normalDepthBuffer,uv,ivec2(0,1));normalDepth[2]=textureOffset(normalDepthBuffer,uv,ivec2(1,0));normalDepth[3]=textureOffset(normalDepthBuffer,uv,ivec2(1,1));float dot01=dot(normalDepth[0].rgb,normalDepth[1].rgb);float dot02=dot(normalDepth[0].rgb,normalDepth[2].rgb);float dot03=dot(normalDepth[0].rgb,normalDepth[3].rgb);float minDot=min(dot01,min(dot02,dot03));float s=step(THRESHOLD,minDot);float smallestDistance=1.0;int index;for(int i=0;i<4;++i){float distance=abs(depth-normalDepth[i].a);if(distance<smallestDistance){smallestDistance=distance;index=i;}}ivec2 offsets[4];offsets[0]=ivec2(0,0);offsets[1]=ivec2(0,1);offsets[2]=ivec2(1,0);offsets[3]=ivec2(1,1);ivec2 coord=ivec2(uv*vec2(textureSize(aoBuffer,0)))+offsets[index];float aoNearest=texelFetch(aoBuffer,coord,0).r;float ao=mix(aoNearest,aoLinear,s);\n#else\nfloat ao=aoLinear;\n#endif\nfloat l=linearToRelativeLuminance(inputColor.rgb);ao=mix(ao,1.0,l*luminanceInfluence);\n#ifdef COLORIZE\noutputColor=vec4(1.0-(1.0-ao)*(1.0-color),inputColor.a);\n#else\noutputColor=vec4(vec3(ao),inputColor.a);\n#endif\n}",NOISE_TEXTURE_SIZE=64,SSAOEffect=class extends Effect$1{constructor(e,t,{blendFunction:r=BlendFunction.MULTIPLY,distanceScaling:n=!0,depthAwareUpsampling:i=!0,normalDepthBuffer:a=null,samples:o=9,rings:s=7,distanceThreshold:l=.97,distanceFalloff:c=.03,rangeThreshold:h=5e-4,rangeFalloff:u=.001,minRadiusScale:d=.33,luminanceInfluence:p=.7,radius:f=.1825,intensity:m=1,bias:g=.025,fade:y=.01,color:v=null,resolutionScale:b=1,width:_=Resizer.AUTO_SIZE,height:x=Resizer.AUTO_SIZE}={}){super("SSAOEffect",shader_default73,{blendFunction:r,attributes:EffectAttribute.DEPTH,defines:new Map([["THRESHOLD","0.997"]]),uniforms:new Map([["aoBuffer",new Uniform(null)],["normalDepthBuffer",new Uniform(null)],["luminanceInfluence",new Uniform(p)],["color",new Uniform(null)],["scale",new Uniform(0)]])}),this.renderTargetAO=new WebGLRenderTarget(1,1,{minFilter:LinearFilter,magFilter:LinearFilter,stencilBuffer:!1,depthBuffer:!1,format:RGBFormat}),this.renderTargetAO.texture.name="AO.Target",this.renderTargetAO.texture.generateMipmaps=!1,this.uniforms.get("aoBuffer").value=this.renderTargetAO.texture,this.resolution=new Resizer(this,_,x,b),this.r=1,this.camera=e,this.ssaoPass=new ShaderPass((()=>{const r=new NoiseTexture(NOISE_TEXTURE_SIZE,NOISE_TEXTURE_SIZE);r.wrapS=r.wrapT=RepeatWrapping;const n=new SSAOMaterial(e);return n.uniforms.noiseTexture.value=r,n.uniforms.intensity.value=m,n.uniforms.minRadiusScale.value=d,n.uniforms.fade.value=y,n.uniforms.bias.value=g,null!==a?(n.uniforms.normalDepthBuffer.value=a,n.defines.NORMAL_DEPTH="1",i&&(this.depthAwareUpsampling=i,this.uniforms.get("normalDepthBuffer").value=a)):n.uniforms.normalBuffer.value=t,n})()),this.distanceScaling=n,this.samples=o,this.rings=s,this.color=v,this.radius=f>1?f/100:f,this.setDistanceCutoff(l,c),this.setProximityCutoff(h,u)}get ssaoMaterial(){return this.ssaoPass.getFullscreenMaterial()}get samples(){return Number(this.ssaoMaterial.defines.SAMPLES_INT)}set samples(e){const t=this.ssaoMaterial;t.defines.SAMPLES_INT=e.toFixed(0),t.defines.SAMPLES_FLOAT=e.toFixed(1),t.needsUpdate=!0}get rings(){return Number(this.ssaoMaterial.defines.SPIRAL_TURNS)}set rings(e){const t=this.ssaoMaterial;t.defines.SPIRAL_TURNS=e.toFixed(1),t.needsUpdate=!0}get radius(){return this.r}set radius(e){this.r=Math.min(Math.max(e,1e-6),1);const t=this.r*this.resolution.height,r=this.ssaoMaterial;r.defines.RADIUS=t.toFixed(11),r.defines.RADIUS_SQ=(t*t).toFixed(11),r.needsUpdate=!0}get depthAwareUpsampling(){return this.defines.has("DEPTH_AWARE_UPSAMPLING")}set depthAwareUpsampling(e){this.depthAwareUpsampling!==e&&(e?this.defines.set("DEPTH_AWARE_UPSAMPLING","1"):this.defines.delete("DEPTH_AWARE_UPSAMPLING"),this.setChanged())}get distanceScaling(){return void 0!==this.ssaoMaterial.defines.DISTANCE_SCALING}set distanceScaling(e){if(this.distanceScaling!==e){const t=this.ssaoMaterial;e?t.defines.DISTANCE_SCALING="1":delete t.defines.DISTANCE_SCALING,t.needsUpdate=!0}}get color(){return this.uniforms.get("color").value}set color(e){const t=this.uniforms,r=this.defines;null!==e?r.has("COLORIZE")?t.get("color").value.set(e):(r.set("COLORIZE","1"),t.get("color").value=new Color(e),this.setChanged()):r.has("COLORIZE")&&(r.delete("COLORIZE"),t.get("color").value=null,this.setChanged())}setDistanceCutoff(e,t){this.ssaoMaterial.uniforms.distanceCutoff.value.set(Math.min(Math.max(e,0),1),Math.min(Math.max(e+t,0),1))}setProximityCutoff(e,t){this.ssaoMaterial.uniforms.proximityCutoff.value.set(Math.min(Math.max(e,0),1),Math.min(Math.max(e+t,0),1))}setDepthTexture(e,t=BasicDepthPacking){const r=this.ssaoMaterial;void 0===r.defines.NORMAL_DEPTH&&(r.uniforms.normalDepthBuffer.value=e,r.depthPacking=t)}update(e,t,r){this.ssaoPass.render(e,null,this.renderTargetAO)}setSize(e,t){const r=this.resolution;r.base.set(e,t);const n=r.width,i=r.height;this.renderTargetAO.setSize(n,i),this.ssaoMaterial.setTexelSize(1/n,1/i);const a=this.camera,o=this.ssaoMaterial.uniforms;o.noiseScale.value.set(n,i).divideScalar(NOISE_TEXTURE_SIZE),o.projectionMatrix.value.copy(a.projectionMatrix),o.inverseProjectionMatrix.value.copy(a.projectionMatrix).invert(),this.radius=this.r}},shader_default74="#ifdef TEXTURE_PRECISION_HIGH\nuniform mediump sampler2D map;\n#else\nuniform lowp sampler2D map;\n#endif\n#if defined(ASPECT_CORRECTION) || defined(UV_TRANSFORM)\nvarying vec2 vUv2;\n#endif\nvoid mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){\n#if defined(ASPECT_CORRECTION) || defined(UV_TRANSFORM)\nvec4 texel=texelToLinear(texture2D(map,vUv2));\n#else\nvec4 texel=texelToLinear(texture2D(map,uv));\n#endif\noutputColor=TEXEL;}",shader_default75="#ifdef ASPECT_CORRECTION\nuniform float scale;\n#else\nuniform mat3 uvTransform;\n#endif\nvarying vec2 vUv2;void mainSupport(const in vec2 uv){\n#ifdef ASPECT_CORRECTION\nvUv2=uv*vec2(aspect,1.0)*scale;\n#else\nvUv2=(uvTransform*vec3(uv,1.0)).xy;\n#endif\n}",TextureEffect=class extends Effect$1{constructor({blendFunction:e=BlendFunction.NORMAL,texture:t=null,aspectCorrection:r=!1}={}){super("TextureEffect",shader_default74,{blendFunction:e,defines:new Map([["TEXEL","texel"]]),uniforms:new Map([["map",new Uniform(null)],["scale",new Uniform(1)],["uvTransform",new Uniform(null)]])}),this.texture=t,this.aspectCorrection=r,this.isWebGL2=!1}get texture(){return this.uniforms.get("map").value}set texture(e){const t=this.texture,r=this.defines;if(t!==e){this.uniforms.get("map").value=e,r.delete("TEXTURE_PRECISION_HIGH");const n=getTextureDecoding(e,this.isWebGL2);r.set("texelToLinear(texel)",n),null!==e&&(e.type!==UnsignedByteType&&r.set("TEXTURE_PRECISION_HIGH","1"),null!==t&&t.type===e.type&&t.encoding===e.encoding||this.setChanged())}}get aspectCorrection(){return this.defines.has("ASPECT_CORRECTION")}set aspectCorrection(e){this.aspectCorrection!==e&&(e?(this.uvTransform&&(this.uvTransform=!1),this.defines.set("ASPECT_CORRECTION","1"),this.setVertexShader(shader_default75)):(this.defines.delete("ASPECT_CORRECTION"),this.setVertexShader(null)),this.setChanged())}get uvTransform(){return this.defines.has("UV_TRANSFORM")}set uvTransform(e){this.uvTransform!==e&&(e?(this.aspectCorrection&&(this.aspectCorrection=!1),this.defines.set("UV_TRANSFORM","1"),this.uniforms.get("uvTransform").value=new Matrix3,this.setVertexShader(shader_default75)):(this.defines.delete("UV_TRANSFORM"),this.uniforms.get("uvTransform").value=null,this.setVertexShader(null)),this.setChanged())}setTextureSwizzleRGBA(e,t=e,r=e,n=e){const i="rgba";let a="";e===ColorChannel.RED&&t===ColorChannel.GREEN&&r===ColorChannel.BLUE&&n===ColorChannel.ALPHA||(a=[".",i[e],i[t],i[r],i[n]].join("")),this.defines.set("TEXEL","texel"+a),this.setChanged()}update(e,t,r){const n=this.uniforms.get("map").value;this.uvTransform&&n.matrixAutoUpdate&&(n.updateMatrix(),this.uniforms.get("uvTransform").value.copy(n.matrix))}initialize(e,t,r){this.isWebGL2=e.capabilities.isWebGL2;const n=getTextureDecoding(this.texture,this.isWebGL2);this.defines.set("texelToLinear(texel)",n)}},LUTCubeLoader=class extends Loader{load(e,t=(()=>{}),r=(()=>{}),n=null){const i=this.manager,a=new LoadingManager,o=new FileLoader(a);return o.setPath(this.path),o.setResponseType("text"),new Promise(((s,l)=>{a.onError=e=>{i.itemError(e),null!==n?(n(`Failed to load ${e}`),s()):l(`Failed to load ${e}`)},i.itemStart(e),o.load(e,(r=>{try{const n=this.parse(r);i.itemEnd(e),t(n),s(n)}catch(t){console.error(t),a.onError(e)}}),r)}))}parse(e){const t=/^([\d.]+) +([\d.]+) +([\d.]+) *$/gm;let r=/TITLE +"([^"]*)"/.exec(e);const n=null!==r?r[1]:null;if(r=/LUT_3D_SIZE +(\d+)/.exec(e),null===r)throw new Error("Missing LUT_3D_SIZE information");const i=Number(r[1]),a=new Float32Array(i**3*3),o=new Vector3(0,0,0),s=new Vector3(1,1,1);if(r=/DOMAIN_MIN +([\d.]+) +([\d.]+) +([\d.]+)/.exec(e),null!==r&&o.set(Number(r[1]),Number(r[2]),Number(r[3])),r=/DOMAIN_MAX +([\d.]+) +([\d.]+) +([\d.]+)/.exec(e),null!==r&&s.set(Number(r[1]),Number(r[2]),Number(r[3])),o.x>s.x||o.y>s.y||o.z>s.z)throw o.set(0,0,0),s.set(1,1,1),new Error("Invalid input domain");let l=0;for(;null!==(r=t.exec(e));)a[l++]=Number(r[1]),a[l++]=Number(r[2]),a[l++]=Number(r[3]);const c=new LookupTexture3D(a,i,i,i);return c.encoding=sRGBEncoding,c.domainMin.copy(o),c.domainMax.copy(s),null!==n&&(c.name=n),c}},SMAAImageLoader=class extends Loader{load(e=(()=>{}),t=null){4===arguments.length?(e=arguments[1],t=arguments[3]):3!==arguments.length&&"function"==typeof arguments[0]||(e=arguments[1],t=null);const r=this.manager,n=new LoadingManager;return new Promise(((i,a)=>{const o=new Image,s=new Image;n.onError=e=>{r.itemError(e),null!==t?(t(`Failed to load ${e}`),i()):a(`Failed to load ${e}`)},n.onLoad=()=>{const t=[o,s];e(t),i(t)},o.addEventListener("error",(e=>{n.itemError("smaa-search")})),s.addEventListener("error",(e=>{n.itemError("smaa-area")})),o.addEventListener("load",(()=>{r.itemEnd("smaa-search"),n.itemEnd("smaa-search")})),s.addEventListener("load",(()=>{r.itemEnd("smaa-area"),n.itemEnd("smaa-area")})),r.itemStart("smaa-search"),r.itemStart("smaa-area"),n.itemStart("smaa-search"),n.itemStart("smaa-area"),o.src=searchImageDataURL_default,s.src=areaImageDataURL_default}))}};let _context={loaders:{},eventHandlerStore:{}};const BACKGROUND_COLOR_DEFAULT=0,WIDTH_DEFAULT=1024,HEIGHT_DEFAULT=768,WIDTH_MIN=0,HEIGHT_MIN=0,WIDTH_MAX=15360,HEIGHT_MAX=8192,LIGHT_PROBE_INTENSITY_OFFSET=0,LIGHT_INTENSITY_OFFSET=0,LIGHT_INTENSITY_RATIO=1,ENVMAP_FACTOR=5,INDEXED_DB_NAME="avw_scene_v2",INDEXED_DB_VERSION=1,INDEXED_DB_OBJECT_STORE="cache",AVW_HEADER=[10,8,29,32,43,55,40,67],AVW_STEP=3,INSTANCE_COUNT_MAX=65535,DRAWABLE_FOG=!1,DRAWABLE_RENDER_ORDER_BASE=1e4;class CoordinateConvertHelper{constructor(){let e={x:0,y:0,z:0},t={scaleX:1,scaleY:1,scaleZ:1},r="surface";this.setDatumShiftModel=n=>{e.x=n.lon,e.y=n.lat,e.z=n.alt,t.scaleX=n.scaleX,t.scaleY=n.scaleY,t.scaleZ=n.scaleZ,r=n.type},this.convertTransform=(n,i)=>{var a=new Matrix4;switch(a.makeScale(t.scaleX,t.scaleY,t.scaleZ),null==i&&(null==r&&(r=""),i=r),i.toLowerCase()){case"surface":var o=this.CartesianFrom(n);return(s=this.GetWorldToLocal({x:e.x,y:e.y,z:e.z})).multiply(a),o=this.preMult(o,s),new Vector3(o.x,o.z,-o.y);case"ecef":o=this.CartesianFrom(n);return o=this.preMult(o,a),new Vector3(o.x,o.z,-o.y);case"planarglobal":return this.preMult(n,a);case"planarlocal":var s;return(s=new Matrix4).makeTranslation(-e.x,-e.y,-e.z),n=this.preMult(n,s),n=this.preMult(n,a),new Vector3(n.x,n.z,-n.y);case"mercator":var l=20037508.34*n.x/180,c=Math.log(Math.tan((90+n.y)*Math.PI/360))/(Math.PI/180);c=20037508.34*c/180;var h=n.z+e.z;return l+=e.x,c-=e.y,new Vector3(l*t.scaleX,h*t.scaleY,-c*t.scaleZ);default:return{x:n.x||0,y:n.y||0,z:n.z||0}}},this.getCartesianFrom=e=>this.CartesianFrom(e),this.XYZToLLA=(n,i)=>{var a=new Matrix4;a.makeScale(t.scaleX,t.scaleY,t.scaleZ);var o=new Matrix4;switch(o.copy(a).invert(),null==i&&(i=r),i){case"surface":var s=this.GetWorldToLocal({x:e.x,y:e.y,z:e.z}),l=new Matrix4;return l.copy(s).invert(),c=this.preMult({x:n.x,y:-n.z,z:n.y},l),c=this.preMult(c,o),this.fromCartesian(c);case"ecef":var c=this.preMult({x:n.x,y:-n.z,z:n.y},o);return this.fromCartesian(c);case"planarglobal":return c=this.preMult(n,o);case"planarlocal":return(s=new Matrix4).makeTranslation(e.x,e.y,e.z),s.multiply(o),this.preMult({x:n.x,y:-n.z,z:n.y},s);case"mercator":n.x=n.x/t.scaleX-e.x,n.z=0-n.z/t.scaleZ,n.z=n.z+e.y;var h=n.x/20037508.34*180,u=n.z/20037508.34*180;u=180/Math.PI*(2*Math.atan(Math.exp(u*Math.PI/180))-.5*Math.PI);var d=n.y/t.scaleY-e.z;return new Vector3(h,u,d);default:return{x:n.x,y:n.y,z:n.z}}},this.CartesianFrom=e=>{var t=e.x*Math.PI/180,r=e.y*Math.PI/180,n=Math.sqrt(Math.pow(CoordinateConvertHelper.EARTH_RADIUS_EQUATOR,2)-Math.pow(CoordinateConvertHelper.EARTH_RADIUS_POLAR,2))/CoordinateConvertHelper.EARTH_RADIUS_EQUATOR,i=Math.sqrt(1-Math.pow(n,2)*Math.pow(Math.sin(r),2)),a=CoordinateConvertHelper.EARTH_RADIUS_EQUATOR/i,o=e.z,s=(a+o)*Math.cos(r)*Math.cos(t),l=(a+o)*Math.cos(r)*Math.sin(t),c=(a*(1-Math.pow(n,2))+o)*Math.sin(r);return new Vector3(s,l,c)},this.fromCartesian=e=>{var t=e.x,r=e.y,n=e.z,i=CoordinateConvertHelper.EARTH_RADIUS_EQUATOR,a=CoordinateConvertHelper.EARTH_RADIUS_POLAR,o=(i-a)/i,s=2*o-o*o,l=Math.sqrt(t*t+r*r),c=Math.atan2(n*i,l*a),h=(i*i-a*a)/(a*a),u=Math.sin(c),d=Math.cos(c),p=Math.atan((n+h*a*u*u*u)/(l-s*i*d*d*d)),f=Math.atan2(r,t),m=Math.sin(p),g=i/Math.sqrt(1-s*m*m),y=l/Math.cos(p)-g,v=180/Math.PI;return new Vector3(f*v,p*v,y)},this.GetWorldToLocal=e=>{var t=this.CartesianFrom(e),r=e.x*Math.PI/180,n=e.y*Math.PI/180,i=Math.cos(r)*Math.cos(n),a=Math.sin(r)*Math.cos(n),o=Math.sin(n),s=new Vector3(i,a,o),l=new Vector3(-Math.sin(r),Math.cos(r),0),c=new Vector3(s.x,s.y,s.z).cross(l),h=new Matrix4;h.set(l.x,l.y,l.z,1,c.x,c.y,c.z,1,s.x,s.y,s.z,1,0,0,0,1);var u=new Matrix4;return u.setPosition(-t.x,-t.y,-t.z),h.multiply(u)},this.preMult=(e,t)=>{var r=t.elements;return new Vector3(r[0]*e.x+r[4]*e.y+r[8]*e.z+1*r[12],r[1]*e.x+r[5]*e.y+r[9]*e.z+1*r[13],r[2]*e.x+r[6]*e.y+r[10]*e.z+1*r[14])}}}CoordinateConvertHelper.EARTH_RADIUS_EQUATOR=6378137,CoordinateConvertHelper.EARTH_RADIUS_POLAR=6356752.31414;let ArticulationTypes={numeric:"numeric",enum:"enum",boolean:"boolean",text:"text"};window.logger={debug:function(){},info:function(){},warn:function(){},error:function(){},dir:function(){},time:function(){},timeEnd:function(){}},window.isDebug&&(window.logger={debug:console.debug.bind(window.console),info:console.info.bind(window.console),warn:console.warn.bind(window.console),error:console.error.bind(window.console),dir:console.dir.bind(window.console),time:console.time.bind(window.console),timeEnd:console.timeEnd.bind(window.console)});const VECTOR3_Y_AXIS=new Vector3(0,1,0);var util$1={degreeToRadian:(e=0)=>e/180*Math.PI,lookupSkyboxFogColor:(e,t)=>{let r;switch(t){case ACESFilmicToneMapping:e.toLowerCase().indexOf("skybox-day")>=0&&e.toLowerCase().indexOf("skybox-day2")<0&&(r="#919da9"),e.toLowerCase().indexOf("skybox-dusk")>=0&&(r="#a68d7c"),e.toLowerCase().indexOf("skybox-night")>=0&&(r="#1f5074"),e.toLowerCase().indexOf("skybox-day2")>=0&&(r="#94a8ac"),e.toLowerCase().indexOf("skybox-white")>=0&&(r="#7d8d98"),e.toLowerCase().indexOf("skybox-blue")>=0&&(r="#021629"),e.toLowerCase().indexOf("skybox-blue07")>=0&&(r="#053452"),e.toLowerCase().indexOf("skybox-real")>=0&&(r="#081225"),e.toLowerCase().indexOf("skyboxsun25deg")>=0&&(r="#a7a399"),e.toLowerCase().indexOf("pisa")>=0&&(r="#9a805b"),e.toLowerCase().indexOf("skybox-day-10")>=0&&(r="#a4d9e7"),e.toLowerCase().indexOf("skybox-day-18")>=0&&(r="#bae1f0"),e.toLowerCase().indexOf("skybox-dusk-4")>=0&&(r="#e79f86"),e.toLowerCase().indexOf("skybox-dusk-6")>=0&&(r="#d1ab87"),e.toLowerCase().indexOf("skybox-night-3")>=0&&(r="#20517a"),e.toLowerCase().indexOf("skybox-night-24")>=0&&(r="#11192c");break;default:e.toLowerCase().indexOf("skybox-day")>=0&&(r="#a0bee0"),e.toLowerCase().indexOf("skybox-dusk")>=0&&(r="#d39c7d"),e.toLowerCase().indexOf("skybox-night")>=0&&(r="#20517a"),e.toLowerCase().indexOf("skybox-day2")>=0&&(r="#94a8ac"),e.toLowerCase().indexOf("skybox-white")>=0&&(r="#7d8d98"),e.toLowerCase().indexOf("skybox-blue")>=0&&(r="#021629"),e.toLowerCase().indexOf("skybox-blue07")>=0&&(r="#053452"),e.toLowerCase().indexOf("skybox-real")>=0&&(r="#081225"),e.toLowerCase().indexOf("skyboxsun25deg")>=0&&(r="#a7a399"),e.toLowerCase().indexOf("pisa")>=0&&(r="#9a805b"),e.toLowerCase().indexOf("skybox-day-10")>=0&&(r="#a4d8e6"),e.toLowerCase().indexOf("skybox-day-18")>=0&&(r="#a4d8e6"),e.toLowerCase().indexOf("skybox-dusk-4")>=0&&(r="#e79f86"),e.toLowerCase().indexOf("skybox-dusk-6")>=0&&(r="#d1ab87"),e.toLowerCase().indexOf("skybox-night-3")>=0&&(r="#20517a"),e.toLowerCase().indexOf("skybox-night-24")>=0&&(r="#11192c")}return r},findModelInThree:(e,t)=>{if(!e||!t)return;let r;return e.children instanceof Array&&e.children.length>0&&(r=e.children.find((e=>e.name===t))),r},findNodeInThree:(e,t)=>{if(!e||!t)return;let r;return e.children instanceof Array&&e.children.length>0&&e.traverse((e=>{e.name===t&&(r=e)})),r},findNodeRecursively:(e,t)=>{if(t&&t.children&&t.children instanceof Array&&0!==t.children.length)for(let r of t.children){if(r.name===e)return r;if(r.children instanceof Array&&r.children.length>0){let t=util$1.findNodeRecursively(e,r);if(t)return t}}},setThreePropertyRecursively:(e,t,r)=>{logger.debug("TRACE: util.setThreePropertyRecursively() - Entering.",e,t,r),e.children instanceof Array&&e.children.length>0&&e.traverse((e=>{logger.debug("TRACE: util.setThreePropertyRecursively() - traverse.",e,t,r,util$1.clone(r)),e[t]=util$1.clone(r)})),logger.debug("TRACE: util.setThreePropertyRecursively() - Exiting.")},setNodePropertyRecursively:(e,t,r)=>{if(logger.debug("TRACE: util.setNodePropertyRecursively() - Entering.",e,t,r),e.children&&e.children instanceof Array&&0!==e.children.length){for(let n of e.children)logger.debug("TRACE: util.setNodePropertyRecursively() - traverse.",n,t,r,util$1.clone(r)),n[t]=util$1.clone(r),n.children instanceof Array&&n.children.length>0&&util$1.setNodePropertyRecursively(n,t,r);logger.debug("TRACE: util.setNodePropertyRecursively() - Exiting.")}else logger.debug("TRACE: util.setNodePropertyRecursively() - Exiting.")},capableForCastingShadow:e=>!!e&&("Object3D"===e.type||"Group"===e.type||e.isMesh),genCubeUrls:(e,t)=>[(e=(e+"///").replace("////","/").replace("///","/"))+"px"+(t=("."+t).replace("..",".")),e+"nx"+t,e+"py"+t,e+"ny"+t,e+"pz"+t,e+"nz"+t],url:(e,t)=>`${e||""}///${t||""}`.replace("/////","/").replace("////","/").replace("///","/"),numberOrDefault:(e,t)=>"number"==typeof e?e:t,isBoolean:e=>"boolean"==typeof e,isNumber:e=>"number"==typeof e,isCSSColor:e=>/^#[0-9a-fA-F]{6}$/.test(e),isFunction:e=>"[object Function]"===Object.prototype.toString.call(e),eq:(e,t,r,n)=>{if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return!1;if(e!=e)return t!=t;var i=typeof e;return("function"===i||"object"===i||"object"==typeof t)&&deepEq(e,t,r,n)},deepEq(e,t,r,n){var i=Object.prototype.toString.call(e);if(i!==Object.prototype.toString.call(t))return!1;switch(i){case"[object RegExp]":case"[object String]":return""+e==""+t;case"[object Number]":return+e!=+e?+t!=+t:0==+e?1/+e==1/t:+e==+t;case"[object Date]":case"[object Boolean]":return+e==+t}var a="[object Array]"===i;if(!a){if("object"!=typeof e||"object"!=typeof t)return!1;var o=e.constructor,s=t.constructor;if(o==s&&!(this.isFunction(o)&&o instanceof o&&this.isFunction(s)&&s instanceof s)&&"constructor"in e&&"constructor"in t)return!1}n=n||[];for(var l=(r=r||[]).length;l--;)if(r[l]===e)return n[l]===t;if(r.push(e),n.push(t),a){if((l=e.length)!==t.length)return!1;for(;l--;)if(!this.eq(e[l],t[l],r,n))return!1}else{var c,h=Object.keys(e);if(l=h.length,Object.keys(t).length!==l)return!1;for(;l--;)if(c=h[l],!t.hasOwnProperty(c)||!this.eq(e[c],t[c],r,n))return!1}return r.pop(),n.pop(),!0},eq(e,t,r,n){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return!1;if(e!=e)return t!=t;var i=typeof e;return("function"===i||"object"===i||"object"==typeof t)&&this.deepEq(e,t,r,n)},clone:e=>{var t;if(logger.info("util.clone(): clone obj:",e),e instanceof Array){t=[];for(var r=e.length;r--;)t[r]=util$1.clone(e[r]);return t}if(e instanceof Object){for(var n in t={},e)t[n]=util$1.clone(e[n]);return t}return e},getSettingsRecursively:e=>{if(void 0!==e&&e){if("function"==typeof e)return"()";var t;if(e instanceof Array){t=[];for(let i=0;i<e.length;i++)if("FolderItem"===e[i].type||"BuildingItem"===e[i].type||"BuildingFloorItem"===e[i].type)if(e[i].children.length>0){(r=e[i].getSettings()).children=util$1.getSettingsRecursively(e[i].children),t.push(r)}else{var r=e[i].getSettings();t.push(r)}else if("ModelItem"===e[i].type||"IconAsset"===e[i].type||"GroupItem"===e[i].type){var n=e[i].getSettings();t.push(n)}return t}if(e instanceof Object){for(var i in t={},e)t[i]=util$1.getSettingsRecursively(e[i]);return t}return e}},deepClone:e=>{if(e){var t=e instanceof Array?[]:{};for(let r in e)"object"==typeof e[r]?t[r]=util$1.deepClone(e[r]):t[r]=e[r];return t}},isObject:e=>"object"==typeof e&&null!=e,cloneDeep:(e,t=new WeakMap)=>{if(!util$1.isObject(e))return e;if(t.has(e))return t.get(e);if([Date,RegExp,Set,Map,WeakMap,WeakSet].includes(e.constructor))return new e.constructor(e);const r=Object.getOwnPropertyDescriptors(e),n=Object.create(Object.getPrototypeOf(e),r);t.set(e,n);for(let r of Reflect.ownKeys(e))n[r]=util$1.isObject(e[r])?util$1.cloneDeep(e[r],t):e[r];return n},guid:()=>{function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},randomString:e=>{e=e||32;for(var t="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",r=t.length,n="",i=0;i<e;i++)n+=t.charAt(Math.floor(Math.random()*r));return n},colorMultiply:(e,t)=>{if("number"!=typeof t)return e;t<0&&(t=0),t>1&&(t=1);let r=util$1.colorToInteger(e);return util$1.integerToColor(r*t)},integerToColor:e=>"number"!=typeof e?"#ffffff":"#{colorInt.toString(16)}",colorToInteger:e=>"string"!=typeof e?16777215:("#"===e.charAt(0)&&(e=e.substring(1)),parseInt(`0x${e}`)),colorToRGBAObject:e=>"string"!=typeof(e=""+e)?{r:1,g:1,b:1,a:1}:("#"===e.charAt(0)&&(e=e.substring(1)),3===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),4===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]),/^[0-9a-fA-F]{6}$/.test(e)?{r:parseInt(e.substr(0,2),16)/255,g:parseInt(e.substr(2,2),16)/255,b:parseInt(e.substr(4,2),16)/255,a:1}:/^[0-9a-fA-F]{8}$/.test(e)?{r:parseInt(e.substr(0,2),16)/255,g:parseInt(e.substr(2,2),16)/255,b:parseInt(e.substr(4,2),16)/255,a:parseInt(e.substr(6,2),16)/255}:void 0),colorToRGBAString:e=>"string"!=typeof(e=""+e)?"rgba (1, 1, 1, 1)":("#"===e.charAt(0)&&(e=e.substring(1)),3===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),4===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]),/^[0-9a-fA-F]{6}$/.test(e)?`rgba (${parseInt(e.substr(0,2),16)/255}, ${parseInt(e.substr(2,2),16)/255}, ${parseInt(e.substr(4,2),16)/255}, 1)`:/^[0-9a-fA-F]{8}$/.test(e)?`rgba (${parseInt(e.substr(0,2),16)/255}, ${parseInt(e.substr(2,2),16)/255}, ${parseInt(e.substr(4,2),16)/255}, ${parseInt(e.substr(6,2),16)/255})`:void 0),rgbAStringToColor:e=>"#"+((1<<24)+(255*e.r<<16)+(255*e.g<<8)+255*e.b).toString(16).substring(1),randomRGBAObject:()=>({r:Math.random(),g:Math.random(),b:Math.random(),a:.5+.5*Math.random()}),randomRGBAString:()=>`rgba (${Math.random()}, ${Math.random()}, ${Math.random()}, ${.5+.5*Math.random()})`,addDegrees:(e,t)=>e&&t&&e.lon&&e.lat&&t.lon&&t.lat?{lon:e.lon+t.lon,lat:e.lat+t.lat,alt:e.alt?t.alt?e.alt+t.alt:e.alt:t.alt?t.alt:0}:{lon:0,lat:0,alt:0},unifyCoordinates:(e,t)=>{if(t){switch("surface"===e.type.toLowerCase()&&(e.type="Surface"),"ecef"===e.type.toLowerCase()&&(e.type="ECEF"),"planarglobal"===e.type.toLowerCase()&&(e.type="PlanarGlobal"),"planarlocal"===e.type.toLowerCase()&&(e.type="PlanarLocal"),"default"===e.type.toLowerCase()&&(e.type="default"),e.type.toLowerCase()){case"surface":let r=t({X:e.lon,Y:e.lat,Z:e.alt},"Surface");e.x=r.x,e.y=0-r.z,e.z=0-r.y}return e}},findMeshByMaterial:(e,t,r)=>{if("function"!=typeof e.traverse)return[];let n=[];return e.traverse((e=>{if(e.material&&e.material===t&&n.push(e),e.material instanceof Array)for(let r of e.material)if(r===t){n.push(e);break}if(r instanceof Array)for(let t of r)if(e.material&&e.material===t&&n.push(e),e.material instanceof Array)for(let r of e.material)if(r===t){n.push(e);break}})),n},fetchJSON:(e,t,r,n)=>{switch(t.toLowerCase()){case"get":case"delete":case"head":case"post":case"put":break;default:t="GET"}return new Promise((function(i,a){let o=new XMLHttpRequest;if(o.onreadystatechange=function(){4==o.readyState&&(200==o.status||204==o.status||304==o.status?i(o.responseText):a(new Error(o.statusText)))},o.open(t,e,!0),r instanceof Array)for(let e of r)o.setRequestHeader(e.key,e.value);o.send(JSON.stringify(n))}))},fetchContentLength:(e,t,r)=>new Promise((function(n,i){let a=new XMLHttpRequest;if(a.onreadystatechange=function(){if(4==a.readyState)if(200==a.status||204==a.status||304==a.status){let e=a.getResponseHeader("Content-Length");n(e)}else{if(404==a.status||405==a.status)return;i(new Error(a.statusText))}},a.open("HEAD",e,!0),t instanceof Array)for(let e of t)a.setRequestHeader(e.key,e.value);a.send(JSON.stringify(r))})),fetchContentLastModified:(e,t,r)=>new Promise((function(n,i){try{if(!e||""===e)return void i();0===e.indexOf("data:")&&n("0");let a=new XMLHttpRequest;if(a.onreadystatechange=function(){if(4==a.readyState)if(200==a.status||204==a.status||304==a.status){let e=a.getResponseHeader("Last-Modified");n(e)}else{if(404==a.status||405==a.status)return;i(new Error(a.statusText))}},a.open("HEAD",e,!0),t instanceof Array)for(let e of t)a.setRequestHeader(e.key,e.value);a.send(JSON.stringify(r))}catch(e){i(e)}})),applyVertexColors(e,t){const r=e.attributes.position,n=[];for(let e=0;e<r.count;e++)n.push(t.r,t.g,t.b);e.setAttribute("color",new Float32BufferAttribute(n,3))},formatWithRegex:e=>(e+"").replace(/\d{1,3}(?=(\d{3})+$)/g,"$&,"),isImage:e=>e instanceof ImageBitmap||e instanceof Image,lonLatToWebMercator:(e,t)=>{if("number"!=typeof e||"number"!=typeof t)return{x:0,y:0};let r=20037508.34*e/180,n=Math.log(Math.tan((90+t)*Math.PI/360))/(Math.PI/180);return n=20037508.34*n/180,{x:r,y:n}},getNodelFromModelItem:e=>{if("Group"!=e.parent.type){let t=util$1.getNodelFromModelItem(e.parent);if(t)return t}else{let t=_context.defaultObjectTree.getItemByUUID(e.uuid);if(t&&("ModelItem"===t.type||"IconAsset"===t.type||"BuildingItem"===t.type))return t;{let t=util$1.getNodelFromModelItem(e.parent);if(t)return t}}},nodeInModelItem:(e,t)=>{for(let r=0;r<e.length;r++)if("ModelItem"===e[r].type){if(util$1.nodeInModelItemRecursion(e[r].children,t))return e[r]}else if("IconAsset"===e[r].type){if(util$1.judegIconAssetFromClick(e[r].name,t))return e[r]}else if("BuildingFloorItem"===e[r].type)for(let n=0;n<e[r].children.length;n++)if("ModelItem"===e[r].children[n].type){if(util$1.nodeInModelItemRecursion(e[r].children[n].children,t))return e[r].children[n]}else if("IconAsset"===e[r].children[n].type&&util$1.judegIconAssetFromClick(e[r].children[n].name,t))return e[r].children[n]},nodeInModelItemRecursion:(e,t)=>{for(let r=0;r<e.length;r++){if(e[r].name===t)return e[r];if(e[r].children.length>0){let n=util$1.nodeInModelItemRecursion(e[r].children,t);if(n)return n}}},judegIconAssetFromClick:(e,t)=>e+"底图"===t||e+"文字"===t||e+"图标"===t,getModelTransform:e=>{var t={};return t.position=JSON.parse(JSON.stringify(e.position)),t.rotation=JSON.parse(JSON.stringify(e.rotation)),t.rotation.x=t.rotation._x,t.rotation.y=t.rotation._y,t.rotation.z=t.rotation._z,t.scale=JSON.parse(JSON.stringify(e.scale)),t.rotation.x=t.rotation._x=MathUtils.radToDeg(t.rotation._x),t.rotation.y=t.rotation._y=MathUtils.radToDeg(t.rotation._y),t.rotation.z=t.rotation._z=MathUtils.radToDeg(t.rotation._z),t},getCopyName:(e,t=0,r)=>{let n;return n=t?`${e}${t}`:`${e}`,r.getItemByName(n)?util$1.getCopyName(e,t+1,r):n},changeTransformFromBuildind:(e,t,r)=>(e.transform.position.x=(e.transform.position.x-t.position.x)/t.scale.x,e.transform.position.y=(e.transform.position.y-t.position.y)/t.scale.y,e.transform.position.z=(e.transform.position.z-t.position.z)/t.scale.z,r?(e.transform.position.x=(e.transform.position.x-r.position.x)/r.scale.x,e.transform.position.y=(e.transform.position.y-r.position.y)/r.scale.y,e.transform.position.z=(e.transform.position.z-r.position.z)/r.scale.z,e):e),changeTransformFromScene:(e,t,r)=>{let n=JSON.parse(JSON.stringify(e.transform)),i=new Vector3,a=(t.position.x+e.transform.position.x)*t.scale.x,o=(t.position.y+e.transform.position.y)*t.scale.y,s=(t.position.z+e.transform.position.z)*t.scale.z;if(i.set(a,o,s),n.position=i,r){let e=new Vector3,t=(r.position.x+n.position.x)*r.scale.x,i=(r.position.y+n.position.y)*r.scale.y,a=(r.position.z+n.position.z)*r.scale.z;return e.set(t,i,a),n.position=e,n}return n},addAllParentPosition:(e,t)=>{if(!e.parent||!e.parent.position)return t;{t.set(t.x+e.parent.position.x,t.y+e.parent.position.y,t.z+e.parent.position.z);let r=util$1.addAllParentPosition(e.parent,t);if(r)return r}},recoverShowGetSettings:(e,t)=>{for(let r=0;r<e.length;r++)t[r].isVisible=e[r].isVisible,e[r].children&&e[r].children.length>0&&"ModelItem"!=t[r].type&&util$1.recoverShowGetSettings(e[r].children,t[r].children)},recoverShow:(e,t)=>{for(let r=0;r<e.length;r++)t[r].isVisible=e[r].isVisible,e[r].children&&e[r].children.length>0&&util$1.recoverShow(e[r].children,t[r].children)},recoverIsShowOrHide:(e,t)=>{if(e)for(let r=0;r<e.length;r++)e[r].isVisible?t[r].show():t[r].hide(),e[r].children&&e[r].children.length>0&&"ModelItem"!=t[r].type&&util$1.recoverIsShowOrHide(e[r].children,t[r].children)},setObjectTreeIsHideRecursion:e=>{for(let t=0;t<e.length;t++)"ModelItem"===e[t].type||"IconAsset"===e[t].type||"GroupItem"===e[t].type?e[t].hide():e[t].children&&e[t].children.length>0&&util$1.setObjectTreeIsHideRecursion(e[t].children)},setObjectTreeShowByUUID:(e,t)=>{for(let r=0;r<e.length;r++)e[r].getGroup&&(e[r].getGroup().uuid===t?(e[r].show(),util$1.setParentVisible(e[r].getGroup()),"ModelItem"!=e[r].type&&e[r].children.length>0&&util$1.setObjectTreeShowRecursion(e[r].children)):e[r].children.length>0&&util$1.setObjectTreeShowByUUID(e[r].children,t))},setObjectTreeShowRecursion:e=>{for(let t=0;t<e.length;t++)e[t].getGroup()&&"IconAsset"!=e[t].type&&(e[t].show(),"ModelItem"!=e[t].type&&e[t].children.length>0&&util$1.setObjectTreeShowRecursion(e[t].children))},setParentVisible:e=>{e.parent&&null!=e.parent.visible&&(e.parent.visible=!0,util$1.setParentVisible(e.parent))},findObjectToBuilding:e=>{let t=_context.defaultObjectTree.children;for(let r=0;r<t.length;r++)if("BuildingItem"===t[r].type&&util$1.findObjectToBuildingRecursion(t[r].getGroup(),e))return t[r]},findObjectToBuildingRecursion:(e,t)=>{if(e.uuid===t)return e;if(e.children&&e.children.length>0)for(let r=0;r<e.children.length;r++)if(e.children[r]){let n=util$1.findObjectToBuildingRecursion(e.children[r],t);if(n)return n}},findObjectToFloor:(e=[])=>{let t;for(let r=0;r<e.length;r++){let n=_context.defaultObjectTree.getItemByUUID(e[r]);if(n&&"BuildingFloorItem"===n.type){t=n;break}}return t},judegParentIsVisible:e=>null!==e.parent?!1!==e.visible&&util$1.judegParentIsVisible(e.parent):!1!==e.visible&&void 0,judegParentIsModelName:(e,t)=>!(!t||!t.parent)&&(null!==t.parent&&(t.parent.name===e&&"Group"===t.parent.type||util$1.judegParentIsModelName(e,t.parent))),findModelItemNodeByName:(e,t)=>{if(e.name===t)return e;if(e.children&&e.children.length>0)for(let r=0;r<e.children.length;r++){let n=util$1.findModelItemNodeByName(e.children[r],t);if(n)return n}},objectTreeChildrenRecursion:(e,t,r,n)=>{if("ModelItem"===e.type&&(n=e.name),e.children&&e.children.length>0)for(let i=0;i<e.children.length;i++){if(e.children[i].name===t&&n===util$1.modelName)return e.children[i].modelName=util$1.modelName,[e.children[i]];if(e.children[i].children&&e.children[i].children.length>0){let a=util$1.objectTreeChildrenRecursion(e.children[i],t,r,n);if(a)return a}}},setArticulation:(e,t)=>{e.children&&"ModelItem"===e.type&&(t.articulations=[],t.articulationAnimations=[],e.articulations&&e.articulations.forEach((e=>{let r={type:e._type,name:e._name,values:e._values,defaultValue:e.value};t.addArticulation(r);let n=t.articulations.find((t=>t._name==e._name));n&&(n.getModelNode=()=>t.getGroup(),e.properties.forEach((e=>{n.addProperty({nodes:e.nodes,modifiers:e.modifiers})})),n.type==ArticulationTypes.text&&n.addOrUpdateTextArticulation(),setTimeout((()=>{n.set(e.value)})),n.remark=e.remark,n.isEnable=e.isEnable,n.openThreshold=e.openThreshold)})),e.articulationAnimations&&e.articulationAnimations.forEach(((e,r)=>{t.addArticulationAnimation(e.animationName),t.articulationAnimations[r].animationSpeed=e.animationSpeed,t.articulationAnimations[r].animationType=e.animationType,t.articulationAnimations[r].isEnable=e.isEnable,e.articulationAnimationItems&&e.articulationAnimationItems.forEach((e=>{t.articulationAnimations[r].addAnimationItem({startTime:e.startTime,continueTime:e.continueTime,articulationName:e.articulationName,startState:e.startState,endState:e.endState})}))})))},setNode:(e,t,r)=>{if(e.children){"ModelItem"===e.type&&(util$1.modelName=e.name);for(let n=0;n<e.children.length;n++)if(e.children[n].isNode){let i=util$1.objectTreeChildrenRecursion(t,e.children[n].name,util$1.modelName,null);if(i&&i.length>0)for(let t in e.children[n])"id"!==t&&"children"!==t&&"isNode"!==t&&"material"!==t&&"name"!==t&&"modelName"!==t&&i[0].setProperty(t,e.children[n][t]);e.children[n].children&&e.children[n].children.length>0&&util$1.setNode(e.children[n],t,r)}else e.children[n].children&&e.children[n].children.length>0&&util$1.setNode(e.children[n],t,r)}},oldSetNode:(e,t,r)=>{if(e.children){"ModelItem"===e.type&&(util$1.modelName=e.name);for(let n=0;n<e.children.length;n++)if(e.children[n].isNode){util$1.modelName&&r.selectNodes(util$1.objectTreeChildrenRecursion(t,e.children[n].name,util$1.modelName,null));for(let t in e.children[n])"children"!==t&&"isNode"!==t&&"material"!==t&&"name"!==t&&"modelName"!==t&&r.setProperty(t,e.children[n][t]);e.children[n].children&&e.children[n].children.length>0&&util$1.setNode(e.children[n],t,r)}else e.children[n].children&&e.children[n].children.length>0&&util$1.setNode(e.children[n],t,r)}},iconVisible:(e,t)=>{for(let r=0;r<e.length;r++)"IconAsset"===e[r].type?t?e[r].iconShow():e[r].iconHide():e[r].children&&e[r].children.length>0&&util$1.iconVisible(e[r].children,t)},convertRotation:e=>{var t=new Vector3(0,0,1);return e.quaternion.setFromEuler(e.rotation),t.applyQuaternion(e.quaternion),new Euler((MathUtils.radToDeg(Math.atan2(-t.y,-t.z))+180+180)%360-180,(MathUtils.radToDeg(Math.atan2(-t.x,-t.z))+180+180)%360-180,(MathUtils.radToDeg(Math.atan2(-t.x,-t.y))+180+180)%360-180)},interpolate:(e=[],t=1,r=50,n)=>{if(!(e instanceof Array||e instanceof Float32Array))return;if("number"!=typeof t||t<1||t>3)return void logger.warn("维度（dimension）参数不正确。取值范围是 1 - 3。");if("number"!=typeof r||r<1)return void logger.warn("最大插值数量（max）参数不正确。取值范围是正整数。");if(e.length%t!=0)return void logger.warn(`数组元素个数（${e.length}）与维度（${t}）不符，应为维度的整数倍。`);let i=1/0,a=-1/0,o=[],s=[];for(let r=0;r<e.length/t;r++){let n=[];for(let i=0;i<t;i++)n.push(e[r*t+i]);if(o.push(n),r>0){let e=0;switch(t){case 1:e=Math.abs(o[r][0]-o[r-1][0]);break;case 2:e=Math.sqrt((o[r][0]-o[r-1][0])*(o[r][0]-o[r-1][0])+(o[r][1]-o[r-1][1])*(o[r][1]-o[r-1][1]));break;case 3:e=Math.sqrt((o[r][0]-o[r-1][0])*(o[r][0]-o[r-1][0])+(o[r][1]-o[r-1][1])*(o[r][1]-o[r-1][1])+(o[r][2]-o[r-1][2])*(o[r][2]-o[r-1][2]))}if(0===e)continue;s.push(e),e>a&&(a=e),e<i&&(i=e)}}if(n&&s.length>0)return s.reduce(((e,t)=>e+t));if(!isFinite(a)||!isFinite(i))return;if(a/i<1.5)return e;let l=[];for(let e=0;e<o.length&&(l.push(o[e]),e!==o.length-1);e++){let t=Math.round(s[e]/i);logger.debug("interpolateCount, max",t,r),t=t>r?r:t,logger.debug("interpolateCount",t);for(let r=0;r<t-1;r++)l.push(util$1.lerp(o[e],o[e+1],1/t+1/t*r))}let c=[];for(let e of l)c.push(...e);return c},lerp:(e,t,r)=>{if(e.length===t.length&&!(r<0||r>1))switch(e.length){case 1:return e+(t-e)*r;case 2:return[e[0]+(t[0]-e[0])*r,e[1]+(t[1]-e[1])*r];case 3:return[e[0]+(t[0]-e[0])*r,e[1]+(t[1]-e[1])*r,e[2]+(t[2]-e[2])*r]}},base64ToBlob:e=>{let t=e.split(";base64,"),r=t[0].split(":")[1],n=window.atob(t[1]),i=n.length,a=new Uint8Array(i);for(let e=0;e<i;++e)a[e]=n.charCodeAt(e);let o=new Blob([a],{type:r});return URL.createObjectURL(o)},calcEulerAngelsFromNormal:e=>{let t=new Vector3;return e instanceof Vector3&&(0!==e.x||0!==e.y||0!==e.z)?(e.x=Math.round(1e3*e.x)/1e3,e.y=Math.round(1e3*e.y)/1e3,e.z=Math.round(1e3*e.z)/1e3,t.x=0===e.y?e.z<0?-Math.PI/2:Math.PI/2:Math.atan(e.z/e.y),t.y=0,t.z=0===e.y?e.x<0?-Math.PI/2:Math.PI/2:Math.atan(e.x/e.y),logger.debug(e,t),t):t},calcQuaternionFromNormal:e=>{let t=new Quaternion,r=new Vector3;if(!(e instanceof Vector3)||0===e.x&&0===e.y&&0===e.z)return t.setFromAxisAngle(r,0),t;e.x=Math.round(1e3*e.x)/1e3,e.y=Math.round(1e3*e.y)/1e3,e.z=Math.round(1e3*e.z)/1e3,r.x=e.z,r.y=0,r.z=0-e.x;let n=e.angleTo(VECTOR3_Y_AXIS);return t.setFromAxisAngle(r,n)},isDepthTestDisabled:e=>{if(!e)return!1;if("boolean"==typeof e.depthTest)return!e.depthTest;if(e instanceof Array){for(let t of e)if(!1===t.depthTest)return!0;return!1}},markObjectsNeedsUpdate:()=>{if(_context.objectsNeedsUpdate instanceof Array)for(let e of _context.objectsNeedsUpdate)e&&(e.needsUpdate=!0)},addToObjectsNeedsUpdate:e=>{_context.objectsNeedsUpdate||(_context.objectsNeedsUpdate=[]),_context.objectsNeedsUpdate.push(e)},removeFromObjectsNeedsUpdate:e=>{if(_context.objectsNeedsUpdate&&0!==_context.objectsNeedsUpdate.length)for(let t=_context.objectsNeedsUpdate.length-1;t>=0;t--)_context.objectsNeedsUpdate[t]===e&&_context.objectsNeedsUpdate.splice(t,1)},disposeThreeObject:e=>{e&&(e.traverse?e.traverse((function(e){if(e.geometry&&e.geometry.dispose&&e.geometry.dispose(),e.material&&e.material.dispose){for(var t in e.material)e.material[t]&&e.material[t].dispose&&e.material[t].dispose instanceof Function&&e.material[t].dispose();e.material.dispose&&e.material.dispose()}else if(e.material&&e.material.length)for(let r=e.material.length-1;r>=0;r--){for(var t in e.material[r])e.material[r][t]&&e.material[r][t].dispose&&e.material[r][t].dispose instanceof Function&&e.material[r][t].dispose();e.material[r].dispose&&e.material[r].dispose()}e.dispose&&e.dispose()})):e&&e.dispose&&e.dispose())},getAutoRotateTime(e=1,t="CW"){let r=1;return"CCW"===t&&(r=-1),r*(1/e)*60}};window.navigator.userAgent&&window.navigator.userAgent.indexOf("AppleWebKit")>=0?util$1.isAppleWebKit=!0:util$1.isAppleWebKit=!1;var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function getAugmentedNamespace(e){if(e.__esModule)return e;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach((function(r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})})),t}function createCommonjsModule(e){var t={exports:{}};return e(t,t.exports),t.exports}function commonjsRequire(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets option of @rollup/plugin-commonjs appropriately for this require call to behave properly.')}var _traverse_0_6_6_traverse=createCommonjsModule((function(e){var t=e.exports=function(e){return new r(e)};function r(e){this.value=e}function n(e,t,r){var n=[],o=[],h=!0;return function e(u){var d=r?i(u):u,p={},f=!0,m={node:d,node_:u,path:[].concat(n),parent:o[o.length-1],parents:o,key:n.slice(-1)[0],isRoot:0===n.length,level:n.length,circular:null,update:function(e,t){m.isRoot||(m.parent.node[m.key]=e),m.node=e,t&&(f=!1)},delete:function(e){delete m.parent.node[m.key],e&&(f=!1)},remove:function(e){s(m.parent.node)?m.parent.node.splice(m.key,1):delete m.parent.node[m.key],e&&(f=!1)},keys:null,before:function(e){p.before=e},after:function(e){p.after=e},pre:function(e){p.pre=e},post:function(e){p.post=e},stop:function(){h=!1},block:function(){f=!1}};if(!h)return m;function g(){if("object"==typeof m.node&&null!==m.node){m.keys&&m.node_===m.node||(m.keys=a(m.node)),m.isLeaf=0==m.keys.length;for(var e=0;e<o.length;e++)if(o[e].node_===u){m.circular=o[e];break}}else m.isLeaf=!0,m.keys=null;m.notLeaf=!m.isLeaf,m.notRoot=!m.isRoot}g();var y=t.call(m,m.node);return void 0!==y&&m.update&&m.update(y),p.before&&p.before.call(m,m.node),f?("object"!=typeof m.node||null===m.node||m.circular||(o.push(m),g(),l(m.keys,(function(t,i){n.push(t),p.pre&&p.pre.call(m,m.node[t],t);var a=e(m.node[t]);r&&c.call(m.node,t)&&(m.node[t]=a.node),a.isLast=i==m.keys.length-1,a.isFirst=0==i,p.post&&p.post.call(m,a),n.pop()})),o.pop()),p.after&&p.after.call(m,m.node),m):m}(e).node}function i(e){if("object"==typeof e&&null!==e){var t;if(s(e))t=[];else if(function(e){return"[object Date]"===o(e)}(e))t=new Date(e.getTime?e.getTime():e);else if(function(e){return"[object RegExp]"===o(e)}(e))t=new RegExp(e);else if(function(e){return"[object Error]"===o(e)}(e))t={message:e.message};else if(function(e){return"[object Boolean]"===o(e)}(e))t=new Boolean(e);else if(function(e){return"[object Number]"===o(e)}(e))t=new Number(e);else if(function(e){return"[object String]"===o(e)}(e))t=new String(e);else if(Object.create&&Object.getPrototypeOf)t=Object.create(Object.getPrototypeOf(e));else if(e.constructor===Object)t={};else{var r=e.constructor&&e.constructor.prototype||e.__proto__||{},n=function(){};n.prototype=r,t=new n}return l(a(e),(function(r){t[r]=e[r]})),t}return e}r.prototype.get=function(e){for(var t=this.value,r=0;r<e.length;r++){var n=e[r];if(!t||!c.call(t,n)){t=void 0;break}t=t[n]}return t},r.prototype.has=function(e){for(var t=this.value,r=0;r<e.length;r++){var n=e[r];if(!t||!c.call(t,n))return!1;t=t[n]}return!0},r.prototype.set=function(e,t){for(var r=this.value,n=0;n<e.length-1;n++){var i=e[n];c.call(r,i)||(r[i]={}),r=r[i]}return r[e[n]]=t,t},r.prototype.map=function(e){return n(this.value,e,!0)},r.prototype.forEach=function(e){return this.value=n(this.value,e,!1),this.value},r.prototype.reduce=function(e,t){var r=1===arguments.length,n=r?this.value:t;return this.forEach((function(t){this.isRoot&&r||(n=e.call(this,n,t))})),n},r.prototype.paths=function(){var e=[];return this.forEach((function(t){e.push(this.path)})),e},r.prototype.nodes=function(){var e=[];return this.forEach((function(t){e.push(this.node)})),e},r.prototype.clone=function(){var e=[],t=[];return function r(n){for(var o=0;o<e.length;o++)if(e[o]===n)return t[o];if("object"==typeof n&&null!==n){var s=i(n);return e.push(n),t.push(s),l(a(n),(function(e){s[e]=r(n[e])})),e.pop(),t.pop(),s}return n}(this.value)};var a=Object.keys||function(e){var t=[];for(var r in e)t.push(r);return t};function o(e){return Object.prototype.toString.call(e)}var s=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},l=function(e,t){if(e.forEach)return e.forEach(t);for(var r=0;r<e.length;r++)t(e[r],r,e)};l(a(r.prototype),(function(e){t[e]=function(t){var n=[].slice.call(arguments,1),i=new r(t);return i[e].apply(i,n)}}));var c=Object.hasOwnProperty||function(e,t){return t in e}}));class Node{constructor({id:e=util$1.guid(),name:t,children:r=[],material:n,isCastingShadow:i=!1,isReceivingShadow:a=!1,isRotating:o=!1,rotatingAxis:s="y",rotatingSpeed:l=1,isScaling:c=!1,isBreathing:h=!1,startScale:u=1,stopScale:d=2,fadeOutScale:p=1.5,scalingSpeed:f=.1,breathingSpeed:m=.1,endBreathe:g=1.5,isVisible:y=!0,isLock:v=!1,enableSSR:b=!1,modelNode:_}){this.id=e,this.name=t||this.id,this.children=r,this.material=n,this.isCastingShadow=i,this.isReceivingShadow=a,this.isRotating=o,this.rotatingAxis=s,this.rotatingSpeed=l,this.isScaling=c,this.isBreathing=h,this.startScale=u,this.stopScale=d,this.fadeOutScale=p,this.scalingSpeed=f,this.breathingSpeed=m,this.endBreathe=g,this.isVisible=y,this.isLock=v,this.enableSSR=b,this.isNode=!0;let x={};x.position=JSON.parse(JSON.stringify(_.position)),x.rotation=JSON.parse(JSON.stringify(_.rotation)),x.rotation.x=x.rotation._x,x.rotation.y=x.rotation._y,x.rotation.z=x.rotation._z,x.scale=JSON.parse(JSON.stringify(_.scale)),x.rotation.x=x.rotation._x=MathUtils.radToDeg(x.rotation._x),x.rotation.y=x.rotation._y=MathUtils.radToDeg(x.rotation._y),x.rotation.z=x.rotation._z=MathUtils.radToDeg(x.rotation._z),this.transformNode=x;var w=_;this.setProperty=(e,t,r)=>{switch(this[e]=t,w.userData&&(w.userData.nodeSettings={isRotating:this.isRotating,rotatingAxis:this.rotatingAxis,rotatingSpeed:this.rotatingSpeed,isScaling:this.isScaling,isBreathing:this.isBreathing,startScale:this.startScale,stopScale:this.stopScale,fadeOutScale:this.fadeOutScale,scalingSpeed:this.scalingSpeed,breathingSpeed:this.breathingSpeed,endBreathe:this.endBreathe,isLock:this.isLock}),e){case"isCastingShadow":w.castShadow=!!t,util$1.setThreePropertyRecursively(w,"castShadow",!!t),util$1.setNodePropertyRecursively(this,"isCastingShadow",!!t);break;case"isReceivingShadow":w.receiveShadow=!!t,util$1.setThreePropertyRecursively(w,"receiveShadow",!!t),util$1.setNodePropertyRecursively(this,"isReceivingShadow",!!t);break;case"isVisible":w.visible=!!t,util$1.setThreePropertyRecursively(w,"visible",!!t),util$1.setNodePropertyRecursively(this,"isVisible",!!t);break;case"isRotating":case"rotatingAxis":case"rotatingSpeed":_context.scene.setNodeRotating&&_context.scene.setNodeRotating({enabled:this.isRotating,node:w,rotatingAxis:this.rotatingAxis,rotatingSpeed:this.rotatingSpeed});break;case"isScaling":case"startScale":case"stopScale":case"fadeOutScale":case"scalingSpeed":_context.scene.setNodeScaling&&_context.scene.setNodeScaling({enabled:this.isScaling,node:w,startScale:this.startScale,stopScale:this.stopScale,fadeOutScale:this.fadeOutScale,scalingSpeed:this.scalingSpeed});break;case"isBreathing":case"breathingSpeed":_context.scene.setNodeBreathing&&_context.scene.setNodeBreathing({enabled:this.isBreathing,node:w,endBreathe:this.endBreathe,breathingSpeed:this.breathingSpeed});break;case"enableSSR":this.enableSSR&&_context.instance.ssrOn&&setTimeout((()=>{_context.instance.ssrOn(this.name,this.modelName)}),500);break;case"transformNode":r||(this.transformNode=t,w.position.set(t.position.x,t.position.y,t.position.z),w.scale.set(t.scale.x,t.scale.y,t.scale.z),w.rotation.order=t.rotation._order,w.rotation.x=MathUtils.degToRad(t.rotation.x),w.rotation.y=MathUtils.degToRad(t.rotation.y),w.rotation.z=MathUtils.degToRad(t.rotation.z))}}}}Node._fromThreeObject=function(e){let t,{uuid:r,name:n,type:i,material:a,castShadow:o,receiveShadow:s,visible:l,isLock:c,children:h,userData:u}=e;if(a instanceof Array){t=[];for(let e of a)t.push(e.name)}else t=a?a.name:void 0;let d=new Node({id:r,name:n,material:t,isCastingShadow:o,isReceivingShadow:s,isVisible:l,isLock:c,modelNode:e});if(u.nodeSettings&&(d.isRotating=u.nodeSettings.isRotating,d.rotatingAxis=u.nodeSettings.rotatingAxis,d.rotatingSpeed=u.nodeSettings.rotatingSpeed,d.isScaling=u.nodeSettings.isScaling,d.isBreathing=u.nodeSettings.isBreathing,d.startScale=u.nodeSettings.startScale,d.stopScale=u.nodeSettings.stopScale,d.fadeOutScale=u.nodeSettings.fadeOutScale,d.scalingSpeed=u.nodeSettings.scalingSpeed,d.breathingSpeed=u.nodeSettings.breathingSpeed,d.endBreathe=u.nodeSettings.endBreathe,d.isLock=u.nodeSettings.isLock),h instanceof Array)for(let e of h)d.children.push(Node._fromThreeObject(e));return d};var axisTypeChangeEvent$1={type:"axisTypeChange"},mouseDownEvent$1={type:"mouseDown"},mouseUpEvent$1={type:"mouseUp",mode:null};class NodeSelection extends EventDispatcher{constructor(){super("NodeSelection");let e="centre",t=new Map,r=new Object3D,n=new Vector3,i=new Euler,a=new Vector3,o=[];this.controlsState=!1;let s=e=>{let t={};t.position=JSON.parse(JSON.stringify(e.threeObject.position)),t.rotation=JSON.parse(JSON.stringify(e.threeObject.rotation)),t.rotation.x=t.rotation._x,t.rotation.y=t.rotation._y,t.rotation.z=t.rotation._z,t.scale=JSON.parse(JSON.stringify(e.threeObject.scale)),t.rotation.x=t.rotation._x=MathUtils.radToDeg(t.rotation._x),t.rotation.y=t.rotation._y=MathUtils.radToDeg(t.rotation._y),t.rotation.z=t.rotation._z=MathUtils.radToDeg(t.rotation._z),e.userObject.transformNode=t},l=e=>{let r=e.target.object.position.clone().sub(n);n=e.target.object.position.clone(),t.forEach((e=>{let t=r.clone();t.divide(e.threeObject.parent.getWorldScale(new Vector3));let n=new Matrix4;n.makeRotationFromQuaternion(e.threeObject.parent.getWorldQuaternion(new Quaternion)).invert(),t.applyMatrix4(n);let i=e.transform.position.clone().add(t);e.threeObject.position.copy(i),e.transform.position=e.threeObject.position.clone(),e.transform.rotation=e.threeObject.rotation.clone(),e.transform.scale=e.threeObject.scale.clone(),s(e)}))},c=r=>{let n=r.target.axis.toLocaleLowerCase();if("e"!==n&&0!==r.target.rotationAngleDelta)if("centre"===e){let e=r.target.object.position.clone();t.forEach((t=>{((e,t,r,n)=>{if(!e||!e.position)return;if(!t)return;if("x"!==r&&"y"!==r&&"z"!==r)return;const i=e.getWorldPosition(new Vector3);i.sub(t);const a={x:new Vector3(1,0,0),y:new Vector3(0,1,0),z:new Vector3(0,0,1)};i.applyAxisAngle(a[r],n),e.rotateOnWorldAxis(a[r],n);let o=e.parent.getWorldPosition(new Vector3);i.add(t),i.sub(o),i.divide(e.parent.getWorldScale(new Vector3));let s=new Matrix4;s.makeRotationFromQuaternion(e.parent.getWorldQuaternion(new Quaternion)).invert(),i.applyMatrix4(s),e.position.copy(i)})(t.threeObject,e,n,r.target.rotationAngleDelta),t.transform.position=t.threeObject.position.clone(),t.transform.rotation=t.threeObject.rotation.clone(),t.transform.scale=t.threeObject.scale.clone(),s(t)}))}else"oneself"===e&&t.forEach((e=>{e.threeObject[`rotate${n.toLocaleUpperCase()}`](r.target.rotationAngleDelta),s(e)}))},h=e=>{let r=e.target.object.scale.clone();t.forEach((e=>{let t=r.clone(),n=new Matrix4;n.makeRotationFromQuaternion(e.threeObject.parent.getWorldQuaternion(new Quaternion)).invert(),t.applyMatrix4(n);let i=e.transform.scale;e.threeObject.scale.set(i.x*t.x,i.y*t.y,i.z*t.z),s(e)}))};this.clearSelection=()=>{o.length=0,t.clear()},this.deselectNodes=e=>{logger.warn("NodeSelection.deselectNodes(): TO BE IMPLEMENTED.")},this.dispose=()=>{o.forEach((e=>{e.dispose&&e.dispose()})),o=[],t.clear()},this.getAllProperties=()=>{if(t.size<1)return null;if(1===t.size){let e=this.getSelectionList();return t.get(e[0]).userObject}let n={};return t.forEach((e=>{for(let t in e.userObject)switch(t){case"id":case"children":case"material":break;case"isCastingShadow":case"isReceivingShadow":case"isRotating":case"rotatingAxis":case"rotatingSpeed":case"isScaling":case"startScale":case"StopScale":case"FadeOutScale":case"ScalingSpeed":n.hasOwnProperty(t)?n[t]=util$1.eq(n[t],e.userObject[t])?n[t]:null:n[t]=util$1.clone(e.userObject[t])}})),"centre"==e?(n.transformNode={},n.transformNode.position=JSON.parse(JSON.stringify(r.position)),n.transformNode.rotation=JSON.parse(JSON.stringify(r.rotation)),n.transformNode.rotation.x=n.transformNode.rotation._x,n.transformNode.rotation.y=n.transformNode.rotation._y,n.transformNode.rotation.z=n.transformNode.rotation._z,n.transformNode.scale=JSON.parse(JSON.stringify(r.scale)),n.transformNode.rotation.x=n.transformNode.rotation._x=MathUtils.radToDeg(n.transformNode.rotation._x),n.transformNode.rotation.y=n.transformNode.rotation._y=MathUtils.radToDeg(n.transformNode.rotation._y),n.transformNode.rotation.z=n.transformNode.rotation._z=MathUtils.radToDeg(n.transformNode.rotation._z)):"oneself"==e&&(n.transformNode={},t.forEach((e=>{let t={};for(var r in t.position=JSON.parse(JSON.stringify(e.threeObject.position)),t.rotation=JSON.parse(JSON.stringify(e.threeObject.rotation)),t.rotation.x=t.rotation._x,t.rotation.y=t.rotation._y,t.rotation.z=t.rotation._z,t.scale=JSON.parse(JSON.stringify(e.threeObject.scale)),t.rotation.x=t.rotation._x=MathUtils.radToDeg(t.rotation._x),t.rotation.y=t.rotation._y=MathUtils.radToDeg(t.rotation._y),t.rotation.z=t.rotation._z=MathUtils.radToDeg(t.rotation._z),t)if(n.transformNode.hasOwnProperty(r))for(let e in t[r])n.transformNode[r]&&!n.transformNode[r].hasOwnProperty(e)?n.transformNode[r][e]=util$1.clone(t[r][e]):n.transformNode[r][e]=util$1.eq(n.transformNode[r][e],t[r][e])?n.transformNode[r][e]:"--";else n.transformNode[r]=util$1.clone(t[r])}))),delete n.id,delete n.children,delete n.material,n},this.getProperty=(e="")=>{if(t.size<1)return null;if(1===t.size){let e=this.getSelectionList();return t.get(e[0]).userObject}switch(e){case"id":case"children":case"material":needContinue=!0}if(needContinue)return null;let r;return t.forEach((t=>{r=void 0===r?util$1.clone(t.userObject[e]):util$1.eq(r,t.userObject[e])?r:null})),r},this.merge=()=>(logger.warn("NodeSelection.merge(): TO BE IMPLEMENTED."),new Node),this.setProperties=e=>{if("object"==typeof e)for(let r in e){let n=!1;switch(r){case"id":case"name":case"children":case"material":n=!0}n||t.forEach((t=>{t.userObject[r]=e[r]}))}else logger.warn("NodeSelection.setProperties(): Invalid properties object specified.")},this.setProperty=(e="",r,n)=>{if(logger.debug("TRACE: NodeSelection.setProperty (propertyName, propertyValue) - Entering.",e,r),""===e)return logger.warn("NodeSelection.setProperty(): No propertyName specified."),void logger.debug("TRACE: NodeSelection.setProperty (propertyName, propertyValue) - Exiting.");if(e.indexOf("transformNode")>-1)this.setPropertyTransformNode(e,r);else switch(e){case"id":case"name":case"children":case"material":return logger.warn("NodeSelection.setProperty(): Given propertyName conflicts with an reserved property."),void logger.debug("TRACE: NodeSelection.    (propertyName, propertyValue) - Exiting.");default:t.forEach((t=>{if(_context.scene){let i=t.threeObject,a=t.userObject;"Object3D"!==i.type&&"Group"!==i.type&&!i.isMesh||i.name!==a.name||a.setProperty(e,r,n)}}))}},this.setPropertyByUUID=(e,t="",r,n)=>{if(logger.debug("TRACE: NodeSelection.setProperty (propertyName, propertyValue) - Entering.",t,r),""===t)return logger.warn("NodeSelection.setProperty(): No propertyName specified."),void logger.debug("TRACE: NodeSelection.setProperty (propertyName, propertyValue) - Exiting.");let i=_context.instance.defaultObjectTree.getItemByUUID(e);i instanceof Node&&i.setProperty(t,r,n)},this.setPropertyTransformNode=(n="",i)=>{if(""===n)return;if(-1===n.indexOf("transformNode"))return;let a=n.split("-");if(_context.transformControls.dispatchEvent(mouseDownEvent$1),"oneself"===e)t.forEach(((e,t)=>{let r=JSON.parse(JSON.stringify(_context.instance.getModelTransformByUUID(t)));3==a.length?r[a[1]][a[2]]=i:2==a.length&&(r[a[1]]=i),_context.instance.setModelTransformByUUID(t,r)})),this.enableTransformControl();else if("centre"===e){let e=["x","y","z"];if("rotation"===a[1])if(3==a.length){let e=r.rotation[a[2]];r[`rotate${a[2].toUpperCase()}`](MathUtils.degToRad(i)-e);let t={target:{axis:a[2],object:r,rotationAngleDelta:MathUtils.degToRad(i)-e}};c(t)}else 2==a.length&&e.forEach((e=>{let t=r.rotation[e];r[`rotate${e.toUpperCase()}`](MathUtils.degToRad(i[e])-t);let n={target:{axis:e,object:r,rotationAngleDelta:MathUtils.degToRad(i[e])-t}};c(n)}));else if("position"===a[1])if(3==a.length){r.position[`set${a[2].toUpperCase()}`](i),l({target:{object:r}})}else 2==a.length&&e.forEach((e=>{r.position[`set${e.toUpperCase()}`](i[e]),l({target:{object:r}})}));else if("scale"===a[1])if(3==a.length){r.scale[`set${a[2].toUpperCase()}`](i),h({target:{object:r}})}else 2==a.length&&e.forEach((e=>{r.scale[`set${e.toUpperCase()}`](i[e]),h({target:{object:r}})}))}mouseUpEvent$1.mode=_context.transformControls.mode,_context.transformControls.dispatchEvent(mouseUpEvent$1)},this.selectNodes=(e,t=!1)=>{if(t||(o.length=0),!(e instanceof Array)||e.length<1)return void logger.warn("NodeSelection.selectNodes(): No node selected.");let r=!1;for(let t of e)t instanceof Node?o.push(t):r=!0;return r&&logger.warn("NodeSelection.selectNodes(): Invalid input found."),o.length},this.getSelectionList=()=>{let e=[];return t.forEach(((t,r)=>{e.push(r)})),e},this.selectObjectByUUID=(e=[])=>(t.clear(),_context.effectStore.highlightObject(null),e.forEach((e=>{let r={threeObject:null,userObject:null,transform:{}},n=_context.instance.defaultObjectTree.getItemByUUID(e),i=_context.scene.getObjectByProperty("uuid",e);n&&n instanceof Node?(r.userObject=n,r.threeObject=i,r.transform.position=i.position.clone(),r.transform.rotation=i.rotation.clone(),r.transform.scale=i.scale.clone(),t.set(e,r),_context.effectStore.highlightObject(r.threeObject,!0)):logger.warn("ModeSelection.selectObjectByUUID(): Invalid input found.")})),this.controlsState&&this.enableTransformControl(),this.getSelectionList()),this.setSelectNodeByUUID=e=>{let r={threeObject:null,userObject:null,transform:{}},n=_context.instance.defaultObjectTree.getItemByUUID(e),i=_context.scene.getObjectByProperty("uuid",e);return n&&n instanceof Node?(r.userObject=n,r.threeObject=i,r.transform.position=i.position.clone(),r.transform.rotation=i.rotation.clone(),r.transform.scale=i.scale.clone(),1==t.size&&t.forEach((e=>{e.transform.position=e.threeObject.position.clone(),e.transform.rotation=e.threeObject.rotation.clone(),e.transform.scale=e.threeObject.scale.clone()})),t.set(e,r),_context.effectStore.highlightObject(r.threeObject,!0),this.controlsState&&this.enableTransformControl()):logger.warn("ModeSelection.selectObjectByUUID(): Invalid input found."),this.getSelectionList()},this.deleteSelectNodeByUUID=e=>t.get(e)?(_context.effectStore.cancleHighlightObject(t.get(e).threeObject),t.delete(e),this.controlsState&&this.enableTransformControl(),this.getSelectionList()):(logger.warn("ModeSelection.deleteSelectObjectByUUID(): Invalid input found."),this.getSelectionList()),this.toggleSelectObjectByUUID=e=>(t.get(e)?this.deleteSelectNodeByUUID(e):this.setSelectNodeByUUID(e),this.getSelectionList()),this.getCenterPosition=()=>{let e=[];if(t.forEach((t=>{t.threeObject.traverse((t=>{let r=t.getWorldPosition(new Vector3);if(t.geometry){t.geometry.computeBoundingBox();let n=t.geometry.boundingBox.getCenter(new Vector3);r.add(n),e.push(r)}else t.children&&t.children.length||e.push(r)}))})),!e.length)return new Vector3;let r=e[0].clone(),n=e[0].clone();return e.forEach((e=>{r.min(e),n.max(e)})),new Box3(r,n).getCenter(new Vector3)},this.enableTransformControl=()=>{if(this.disableTransformControl(),1===t.size){let e=this.getSelectionList();return void _context.transformControls.attach(t.get(e[0]).threeObject)}if(t.size<1)return;this.controlsState=!0;let e=this.getCenterPosition();r.position.copy(e),r.rotation.set(0,0,0),r.scale.set(1,1,1),n.copy(e),i.copy(r.rotation),a.copy(r.scale),_context.scene.add(r),_context.transformControls.addEventListener("translate",l),_context.transformControls.addEventListener("rotate",c),_context.transformControls.addEventListener("scale",h),_context.transformControls.attach(r),_context.transformControls.showE=!1},this.disableTransformControl=()=>{_context.transformControls.removeEventListener("translate",l),_context.transformControls.removeEventListener("rotate",c),_context.transformControls.removeEventListener("scale",h),_context.transformControls.showE=!0,this.controlsState=!1,_context.transformControls.object&&_context.transformControls.detach()},this.onTransformControlsEvent=(e,t)=>(_context.transformControls.addEventListener(e,t),1),this.offTransformControlsEvent=(e,t)=>(_context.transformControls.removeEventListener(e,t),1),this.getAxisType=()=>e,this.setAxisType=t=>("centre"!=t&&"oneself"!=t||(e=t,this.dispatchEvent(axisTypeChangeEvent$1)),e),this.getSelectedNodeMap=()=>t}}class ObjectTreeItem{constructor(e){let t=e;function r(e){return e=e.sort(((e,t)=>e.index-t.index))}this.isVisible=!0,this.isLock=!1,this._nodeSelection=new NodeSelection(_context.scene),this.getType=()=>this.type,this.transform={position:{x:0,y:0,z:0},rotation:{_x:0,_y:0,_z:0,_order:"XYZ"},scale:{x:1,y:1,z:1}},this.isModel=()=>"modelitem"===t.toLowerCase(),this.isFolder=()=>"folderitem"===t.toLowerCase(),this.dispose=(e,t)=>{_context.instance.disableTransform(),this.modelItemSSROffRecursion(this.children,e);for(let t=this.children.length-1;t>=0;t--)this.children[t].name===e&&(util$1.disposeThreeObject(this.children[t].getGroup()),this.getGroup().remove(this.children[t].getGroup()),this.children.splice(t,1));r(this.children).forEach(((e,t)=>{e.index=t})),_context.instance.cutLevelByUUID(this.getGroup().uuid,!1),t&&t(1,"删除成功")},this.remove=(e,t)=>{_context.instance.disableTransform(),this.modelItemSSROffRecursion(this.children,e);for(let t=this.children.length-1;t>=0;t--)this.children[t].name===e&&(this.getGroup().remove(this.children[t].getGroup()),this.children.splice(t,1));r(this.children).forEach(((e,t)=>{e.index=t})),_context.instance.cutLevelByUUID(this.getGroup().uuid,!1),t&&t(1,"删除成功")},this.hide=()=>{_context.scene.children.map((e=>{"__sysObjectsWater"===e.name&&e.children.map((e=>{e.userData.modelName===this.name&&(e.visible=!1)}))})),this.getGroup().visible=!1,this.isVisible=!1},this.show=()=>{_context.scene.children.map((e=>{"__sysObjectsWater"===e.name&&e.children.map((e=>{e.userData.modelName===this.name&&(e.visible=!0)}))})),this.getGroup().visible=!0,this.isVisible=!0},this.rename=(e,t)=>{if(e){for(let t=0;t<_context.ssr.length;t++)_context.ssr[t].modelName===this.name&&(_context.ssr[t].modelName=e);if(this.name=e,this.getGroup().name=e,this.materialStore)for(let t in this.materialStore._materials)this.materialStore._materials[t]._modelName=e;for(let t=0;t<this.children.length;t++)this.children[t].parent&&(this.children[t].parent=e);t&&t(1,"模型重命名成功")}},this.copy=(e,t)=>{if(e){_context.copyModel=null;for(let r=0;r<this.children.length;r++)switch(this.children[r].type){case"ModelItem":case"IconAsset":if(this.children[r].name===e)return _context.copyModel=this.children[r].getSettings(),_context.copyModel.transform.position=util$1.changeTransformFromScene(_context.copyModel,this.getGroup().parent,this.getGroup()).position,void(t&&t(1,"复制成功"));break;case"BuildingFloorItem":for(let n=0;n<this.children[r].children.length;n++)if(this.children[r].children[n].name===e)return _context.copyModel=this.children[r].children[n].getSettings(),_context.copyModel.transform.position=util$1.changeTransformFromScene(_context.copyModel,this.getGroup().parent,this.getGroup()).position,void(t&&t(1,"复制成功"))}}},this.paste=e=>{if(_context.copyModel){let t=JSON.parse(JSON.stringify(_context.copyModel));switch(t.name=util$1.getCopyName(t.name+"副本",0,_context.defaultObjectTree),this.type){case"BuildingItem":case"BuildingFloorItem":return t.parent=this.name,t.index=this.children.length,delete t.id,void this.addNoneFloor(t,(r=>{1===r&&("ModelItem"===t.type?this.pasteLater(this,t,(t=>{1===t&&e&&e(1,"粘贴成功")})):e&&e(1,"粘贴成功"))}));case"ModelItem":case"IconAsset":if("objectTree"===this.parent)t.parent="objectTree",t.index=_context.defaultObjectTree.children.length,delete t.id,"ModelItem"===t.type?_context.defaultObjectTree.addModel(t,(r=>{1===r&&this.pasteLater(_context.defaultObjectTree,t,(t=>{1===t&&e&&e(1,"粘贴成功")}))})):"IconAsset"===t.type&&_context.defaultObjectTree.addIconAsset(t,null,(t=>{1===t&&e&&e(1,"粘贴成功")}));else{let r=_context.defaultObjectTree.getItemByUUID(this.getGroup().parent.uuid);r?(t.parent=r.name,t.index=r.children.length,delete t.id,r.addNoneFloor(t,(n=>{1===n&&("ModelItem"===t.type?this.pasteLater(r,t,(t=>{1===t&&e&&e(1,"粘贴成功")})):e&&e(1,"粘贴成功"))}))):_context.instance.defaultObjectTree.children.forEach((r=>{"BuildingItem"===r.type&&r.children.forEach((r=>{"BuildingFloorItem"===r.type&&this.parent===r.name&&(t.parent=r.name,t.index=r.children.length,delete t.id,r.addNoneFloor(t,(n=>{1===n&&("ModelItem"===t.type?this.pasteLater(r,t,(t=>{1===t&&e&&e(1,"粘贴成功")})):e&&e(1,"粘贴成功"))})))}))}))}}}else e&&e(0,"用户没有进行复制无法粘贴")},this.pasteLater=(e,t,r)=>{if(e&&t){if("ModelItem"===t.type){let r=e.getItemByName(t.name);e.getItemByName(t.name).materialStore.applySettings(t.materials),util$1.setNode(t,r,this._nodeSelection),util$1.setArticulation(t,r),_context.instance.cutLevelByUUID(e.getGroup().uuid,!1),t.children&&this.modelItemSSROnRecursion(t.children,t.name);for(let e in t.materials)t.materials[e].enableTranslation&&_context.instance.setMaterialAnimation({name:t.materials[e].name,enableTranslation:t.materials[e].enableTranslation,translationSpeedU:t.materials[e].translationSpeedU,translationSpeedV:t.materials[e].translationSpeedV,modelName:t.name})}else t.type;r&&r(1,"成功")}else r&&r(0,"参数错误")},this.move=(e,t)=>{e||t&&t(0,"参数错误");let r=_context.defaultObjectTree.getItemByName(e),n=null;r.getSettings().children&&(n=JSON.parse(JSON.stringify(r.getSettings().children))),r||t&&t(0,"目标不存在");let i=JSON.parse(JSON.stringify(r.getGroup().parent.uuid));r.parent=this.name,r.clipping=!1,this.children.push(r),this.getGroup().add(r.getGroup()),"objectTree"===parent?_context.defaultObjectTree.remove(r.name):_context.defaultObjectTree.getItemByUUID(i).remove(r.name),n&&this.modelItemSSROnRecursion(n,r.name),t&&t(1,"移动成功")},this.getModelTransform=(e,t)=>{var r={};for(let t=0;t<this.children.length;t++)if("ModelItem"===this.children[t].type||"IconAsset"===this.children[t].type)this.children[t].name===e&&(r=util$1.getModelTransform(this.children[t].getGroup()));else if("BuildingFloorItem"===this.children[t].type)if(this.children[t].name===e)r=util$1.getModelTransform(this.children[t].getGroup());else for(let n=0;n<this.children[t].children.length;n++)this.children[t].children[n].name===e&&(r=util$1.getModelTransform(this.children[t].children[n].getGroup()));return t&&t(1,"获取成功"),r},this.setModelTransform=(e,t,r)=>{for(let r=0;r<this.children.length;r++)if("ModelItem"===this.children[r].type||"IconAsset"===this.children[r].type)this.children[r].name===e&&_context.instance.setTransform(this.children[r].getGroup(),t);else if("BuildingFloorItem"===this.children[r].type)if(this.children[r].name===e)_context.instance.setTransform(this.children[r].getGroup(),t);else for(let n=0;n<this.children[r].children.length;n++)this.children[r].children[n].name===e&&_context.instance.setTransform(this.children[r].children[n].getGroup(),t);r&&r(1,"设置成功")},this.addModelFromScene=(e,t)=>{e||t&&t(0,"参数错误"),_context.instance.disableTransform();let r=_context.instance.defaultObjectTree.children.find((t=>t.name===e)),n=null;r.getSettings().children&&(n=JSON.parse(JSON.stringify(r.getSettings().children))),r||t&&t(0,"对象不存在"),r.index=this.children.length,r.parent=this.name,r.parentUUID=this.getGroup().uuid,this.children.push(r);var i={transform:{position:r.getGroup().position}};"BuildingItem"===this.type?util$1.changeTransformFromBuildind(i,this.getGroup()):"BuildingFloorItem"===this.type&&util$1.changeTransformFromBuildind(i,this.getGroup().parent,this.getGroup()),this.getGroup().add(r.getGroup()),_context.instance.defaultObjectTree.remove(e),n&&this.modelItemSSROnRecursion(n,r.name),t&&t(1,"添加成功"),"BuildingItem"==this.type?_context.instance.cutLevel(this.getGroup().uuid,this.floor):"BuildingFloorItem"===this.type&&_context.instance.cutLevel(this.getGroup().parent.uuid,_context.defaultObjectTree.getItemByUUID(this.getGroup().parent.uuid).floor)},this.removeFromBuilding=(e,t)=>{e||t&&t(0,"参数错误"),_context.instance.disableTransform();let r=this.getItemByName(e),n=null;r.getSettings().children&&(n=JSON.parse(JSON.stringify(r.getSettings().children))),r||t&&t(0,"对象不存在"),r.index=_context.instance.defaultObjectTree.children.length,r.parent="objectTree",_context.instance.defaultObjectTree.children.push(r);var i={transform:{position:r.getGroup().position}};if("BuildingItem"===this.type){let e=util$1.changeTransformFromScene(i,this.getGroup()).position;r.getGroup().position.set(e.x,e.y,e.z)}else if("BuildingFloorItem"===this.type){let e=util$1.changeTransformFromScene(i,this.getGroup().parent,this.getGroup()).position;r.getGroup().position.set(e.x,e.y,e.z)}_context.scene.models.add(r.getGroup()),this.remove(e),_context.instance.clipNode(this.name,0,0,0,0),_context.instance.cutLevel(this.getGroup().uuid,this.floor),n&&this.modelItemSSROnRecursion(n,r.name),t&&t(1,"移除成功")},this.modelItemSSROnRecursion=(e,t)=>{for(let r=0;r<e.length;r++)e[r].enableSSR&&_context.instance.ssrOn(e[r].name,t),e[r].children&&e[r].children.length>0&&this.modelItemSSROnRecursion(e[r].children,t)},this.modelItemSSROffRecursion=(e,t)=>{for(let r=0;r<e.length;r++)e[r].enableSSR&&_context.instance.ssrOff(e[r].name,t),e[r].children&&e[r].children.length>0&&this.modelItemSSROffRecursion(e[r].children,t)},this._getVisible=()=>this.isVisible,this._setVisible=e=>{this.isVisible=e},this._getLock=()=>this.isLock,this._setLock=e=>{this.isLock=e},this.lock=()=>{this.isLock=!0},this.unLock=()=>{this.isLock=!1}}}class IconItem extends ObjectTreeItem{constructor(e,t,r,n=_context.defaultObjectTree,i){super("IconItem"),this.type=e.type,this.name=e.name,this.param=e.param,this.textParam=e.textParam,this.index=e.index?e.index:null,this.parent=e.parent?e.parent:null,this.transform=e.transform?e.transform:this.transform,this.isEditor=!0,this.isCustom=e.isCustom||!1,this._cliiping=!1,this.children=[];let a=new Group,o=null;function s(e){Object.assign(e.uniforms,this.uniforms),e.fragmentShader="uniform vec3 outlineColor;\n"+e.fragmentShader,e.fragmentShader="uniform float outlineThickness;\n"+e.fragmentShader,e.fragmentShader="uniform vec2 resolution;\n"+e.fragmentShader,e.fragmentShader="uniform float outline;\n"+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <map_fragment>",["#ifdef USE_MAP"," vec4 texelColor = mapTexelToLinear( texture2D( map, vUv ) );"," texelColor = mapTexelToLinear( texelColor );"," if (outline == 0.) {","\tdiffuseColor = diffuseColor * texelColor;"," } else { ","\tfloat width = 0.0;","\tif (resolution.x > resolution.y) {","\t\twidth = resolution.y;","\t} else {","\t\twidth = resolution.x;","\t}"," \tvec2 texel = vec2( 1.0 / resolution.y, 1.0 / resolution.x );"," \t#define OFFSET_COUNT_FLOAT 32."," \t#define OFFSET_COUNT 8"," \tfloat aspect = resolution.x / resolution.y;"," \tvec2 offsets[OFFSET_COUNT];"," \toffsets[0] = vec2( 0., 1.);"," \toffsets[1] = vec2( 0., -1.);"," \toffsets[2] = vec2( 1., 0. );"," \toffsets[3] = vec2( -1., 0. );"," \toffsets[4] = vec2( -0.5, 0.5);"," \toffsets[5] = vec2( 0.5, -0.5);"," \toffsets[6] = vec2( 0.5, 0.5);"," \toffsets[7] = vec2( -0.5, -0.5);"," \tfloat a = 0.0;"," \tfloat theta = 0.;"," \tfor( float i = 0.; i < OFFSET_COUNT_FLOAT; i ++ ) {","\t\ttheta = (6.283185307179586 / OFFSET_COUNT_FLOAT) * i;"," \t\tvec2 samplePoint = vec2(cos(theta) * outlineThickness, sin(theta) * outlineThickness * aspect);","  \t\tfloat val = texture2D( map, vUv + texel * samplePoint).a;","  \t\ta = max(a, val);"," \t}"," \tif (texelColor.a > 0.95) {","\t\tdiffuseColor = diffuseColor * texelColor;"," \t} else {"," \t\ttexelColor = mix( vec4(outlineColor, a), texelColor, texelColor.a );","\t\tdiffuseColor = vec4(outlineColor.x + 0.5, outlineColor.g + 0.5, outlineColor.b + 0.5, a) * texelColor;"," \t}"," }","#endif"].join("\n"))}a.renderOrder=1,a.type="IconGroup",this.getGroup=()=>a,this.add=(e,t,r,n=_context.defaultObjectTree,i)=>{if("IconItem"!==e.type&&"IconAsset"!==e.type)return;if(a.name=e.name,a.position.set(e.transform.position.x,e.transform.position.y,e.transform.position.z),e.transform.scale&&a.scale.set(Number(e.transform.scale.x)<=0?1:e.transform.scale.x,Number(e.transform.scale.y)<=0?1:e.transform.scale.y,Number(e.transform.scale.z)<=0?1:e.transform.scale.z),""!=e.param.background){let t=_context.loaders.textureLoader.load(util$1.url(_context.instance.resourceBasePath,"texture/iconBackground/"+e.param.background+".png"),(e=>{this.backgroundMap=h(e)}));(o=new SpriteMaterial({map:t,color:new Color(e.param.backgroundColor),fog:!1,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest,alphaTest:.1,transparent:!0,sizeAttenuation:e.param.sizeAttenuation,polygonOffset:e.param.polygonOffset,polygonOffsetFactor:e.param.polygonOffsetFactor,polygonOffsetUnits:e.param.polygonOffsetUnits})).uniforms={outlineColor:{value:new Color("#ffff00")},outlineThickness:{value:65},resolution:{value:new Vector2(_context.renderer.domElement.width,_context.renderer.domElement.height)},outline:{value:0}},o.onBeforeCompile=s,(u=new Sprite(o)).name=e.name+"底图",u.type="IconBackground",u.scale.set(e.param.sizeAttenuation?Number(e.param.width)/25:Number(e.param.width)/2500,e.param.sizeAttenuation?Number(e.param.height)/25:Number(e.param.height)/2500,1);let r=-1;if(u.center=new Vector2(r*e.param.offsetV+.5,r*e.param.offsetH+.5),e.param.backgroundColor&&"rgba"===e.param.backgroundColor.substring(0,4)){let t=e.param.backgroundColor.slice(4);t=t.split(","),t=parseFloat(t[3].replace(/[^0-9.]/gi,"")),u.material.opacity=t}a.add(u)}else{var o,u;(o=new SpriteMaterial).uniforms={outlineColor:{value:new Color("#ffff00")},outlineThickness:{value:65},resolution:{value:new Vector2(_context.renderer.domElement.width,_context.renderer.domElement.height)},outline:{value:0}},(u=new Sprite(o)).visible=!1,a.add(u)}if(-1!=e.param.path.indexOf("[[origin]]"))var d=e.param.path.replace("[[origin]]",_context.origin);else d=e.param.path;e.map&&(d=e.map);let p=_context.loaders.textureLoader.load(d,(e=>{this.map=h(e),i&&i(1)}));var f=new SpriteMaterial({map:p,color:new Color("#ffffff"),fog:!1,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest,alphaTest:.1,transparent:!0,sizeAttenuation:e.param.sizeAttenuation,polygonOffset:e.param.polygonOffset,polygonOffsetFactor:e.param.polygonOffsetFactor,polygonOffsetUnits:e.param.polygonOffsetUnits});""==e.param.background&&(f.uniforms={outlineColor:{value:new Color("#ffff00")},outlineThickness:{value:65},resolution:{value:new Vector2(_context.renderer.domElement.width,_context.renderer.domElement.height)},outline:{value:0}},f.onBeforeCompile=s);var m=new Sprite(f);m.name=e.name+"图标",m.type="IconAsset",m.scale.set(e.param.sizeAttenuation?Number(e.param.width)/50:Number(e.param.width)/5e3,e.param.sizeAttenuation?Number(e.param.height)/50:Number(e.param.height)/5e3,1);""==e.param.background?m.center=new Vector2(-1*e.param.offsetV+.5,-1*e.param.offsetH+.5):m.center=new Vector2(-2*e.param.offsetV+.5,-2*e.param.offsetH+.5),a.add(m);return null!=e.textParam&&e.textParam.enableText?(e.textParam.canvas=c(e.textParam.fontFamily,e.textParam.fontSize,e.textParam.fontBold,e.textParam.enableItalic,e.textParam.background,e.textParam.color,e.textParam.text),l(a,e).name=e.name+"文字"):a.add(new Group),t?(t.add(a),"GroupItem"===t.type&&t.childrenAdd(this),r&&r(1)):(_context.scene.models.add(a),n.addItem(this),r&&r(1)),a},this.update=function(e,t){if(a.clear(),this.type=e.type,this.name=e.name,this.param=e.param,this.textParam=e.textParam,this.transform=e.transform,null!=a){if(a.name=e.name,""!=e.param.background){let t=_context.loaders.textureLoader.load(util$1.url(_context.instance.resourceBasePath,"texture/iconBackground/"+e.param.background+".png"),(e=>{this.backgroundMap=e}));(r=new SpriteMaterial({map:t,color:new Color(e.param.backgroundColor),fog:!1,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest,alphaTest:.1,transparent:!0,sizeAttenuation:e.param.sizeAttenuation,polygonOffset:e.param.polygonOffset,polygonOffsetFactor:e.param.polygonOffsetFactor,polygonOffsetUnits:e.param.polygonOffsetUnits})).uniforms={outlineColor:{value:new Color("#ffff00")},outlineThickness:{value:65},resolution:{value:new Vector2(_context.renderer.domElement.width,_context.renderer.domElement.height)},outline:{value:1}},r.onBeforeCompile=s,(n=new Sprite(r)).name=e.name+"底图",n.type="IconBackground",n.scale.set(e.param.sizeAttenuation?Number(e.param.width)/25:Number(e.param.width)/2500,e.param.sizeAttenuation?Number(e.param.height)/25:Number(e.param.height)/2500,1);let i=-1;if(n.center=new Vector2(e.param.offsetV*i+.5,e.param.offsetH*i+.5),"rgba"===e.param.backgroundColor.substring(0,4)){let t=e.param.backgroundColor.slice(4);t=t.split(","),t=parseFloat(t[3].replace(/[^0-9.]/gi,"")),n.material.opacity=t}a.add(n)}else{var r,n;(r=new SpriteMaterial).uniforms={outlineColor:{value:new Color("#ffff00")},outlineThickness:{value:65},resolution:{value:new Vector2(_context.renderer.domElement.width,_context.renderer.domElement.height)},outline:{value:0}},(n=new Sprite(r)).visible=!1,a.add(n)}if(-1!=e.param.path.indexOf("[[origin]]"))var i=e.param.path.replace("[[origin]]",_context.origin);else i=e.param.path;e.map&&(i=e.map);let t=_context.loaders.textureLoader.load(i,(e=>{this.map=h(e)}));var o=new SpriteMaterial({map:t,color:new Color("#ffffff"),fog:!1,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest,alphaTest:.1,transparent:!0,sizeAttenuation:e.param.sizeAttenuation,polygonOffset:e.param.polygonOffset,polygonOffsetFactor:e.param.polygonOffsetFactor,polygonOffsetUnits:e.param.polygonOffsetUnits});""==e.param.background&&(o.uniforms={outlineColor:{value:new Color("#ffff00")},outlineThickness:{value:65},resolution:{value:new Vector2(_context.renderer.domElement.width,_context.renderer.domElement.height)},outline:{value:0}},o.onBeforeCompile=s);var u=new Sprite(o);u.name=e.name+"图标",u.type="IconAsset",u.scale.set(e.param.sizeAttenuation?Number(e.param.width)/50:Number(e.param.width)/5e3,e.param.sizeAttenuation?Number(e.param.height)/50:Number(e.param.height)/5e3,1);let d=-1;""==e.param.background?u.center=new Vector2(d*e.param.offsetV+.5,d*e.param.offsetH+.5):u.center=new Vector2(2*d*e.param.offsetV+.5,2*d*e.param.offsetH+.5),a.add(u);null!=e.textParam&&e.textParam.enableText?(e.textParam.canvas=c(e.textParam.fontFamily,e.textParam.fontSize,e.textParam.fontBold,e.textParam.enableItalic,e.textParam.background,e.textParam.color,e.textParam.text),l(a,e).name=e.name+"文字"):a.add(new Group)}t&&t(1)},this.iconHide=()=>{o=a.visible,a.visible=!1},this.iconShow=()=>{a.visible=o,o=null},this.getSettings=()=>(a&&(this.transform.position=a.position,this.transform.rotation=a.rotation,this.transform.scale=a.scale),{name:this.name,type:this.getType(),isVisible:this._getVisible(),isLock:this._getLock(),index:this.index,param:this.param,map:this.map,backgroundMap:this.backgroundMap,textParam:this.textParam,transform:this.transform,parent:this.parent,isCustom:this.isCustom,isEditor:this.isEditor});let l=(e,t)=>{var r;if(null!=t.textParam){var n=t.textParam.canvas,i=new CanvasTexture(n),a=new SpriteMaterial({map:i,color:16777215,fog:DRAWABLE_FOG,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest,sizeAttenuation:t.param.sizeAttenuation});(r=new Sprite(a)).scale.set(t.param.sizeAttenuation?.045*t.textParam.canvas.width:405e-6*t.textParam.canvas.width,t.param.sizeAttenuation?.045*t.textParam.canvas.height:405e-6*t.textParam.canvas.height,1);let o=-1;return r.center=new Vector2(t.textParam.offsetV*o+.5,t.textParam.offsetH*o+.5),r.type="IconAsset",r.name=t.name+"文字",r.visible=t.textParam.enableText,e?e.add(r):_objectStore.add(r),r}},c=(e,t,r,n,i,a,o)=>{let s=document.createElement("canvas"),l=s.getContext("2d");var c=4.5*t,h="";r&&(h="bold");var u="";return n&&(u="italic"),l.font=`${u} ${h} ${c}px ${e}`,s.width=1.8*(l.measureText(o).width+c),s.height=3.2*c,l.fillStyle=i,l.fillRect(0,0,s.width,s.height),l.font=`${u} ${h} ${2*c}px ${e}`,l.fillStyle=a,l.textAlign="center",l.textBaseline="middle",l.fillText(o,s.width/2,s.height/2),s},h=e=>{var t=document.createElement("canvas");return t.width=e.image.width,t.height=e.image.height,t.getContext("2d").drawImage(e.image,0,0,t.width,t.height),t.toDataURL()};this.add(e,t,r,n,i),e.isVisible?this.show():this.hide()}get clipping(){return this._cliiping}set clipping(e){this._cliiping=e,e?this.iconHide():this.isVisible&&this.iconShow()}}class ArticulationProperty{constructor({nodes:e,modifiers:t}){this.nodes=e,this.modifiers=t,this.addModifier=(e,t)=>{},this.updateModifier=(e,t)=>{},this.removeModifier=e=>{}}}class AnimationController{constructor(e){var t=!1;this._type=e,this.pause=()=>{t=!0},this.resume=()=>{t=!1},this.update=e=>{t||"function"==typeof this.render&&this.render(e)},this.reset=()=>{},this.dispose=()=>{},this.getIsPaused=()=>t}get type(){return this._type}}let ArticulationModifierTypes={translationX:"translationX",translationY:"translationY",translationZ:"translationZ",rotationX:"rotationX",rotationY:"rotationY",rotationZ:"rotationZ",scaleX:"scaleX",scaleY:"scaleY",scaleZ:"scaleZ",opacity:"opacity",colorOverlay:"colorOverlay",colorReplace:"colorReplace",stroke:"stroke"};class RGBAColor{constructor(e,t,r,n){null==t&&null==r&&null==n?(this.color=new Color(this._getrgbaNum(e,0)/255,this._getrgbaNum(e,1)/255,this._getrgbaNum(e,2)/255),this.alpha=this._getrgbaNum(e,3)):(this.color=new Color(e,t,r),this.alpha=n)}_getrgbaNum(e="rgba(255,255,255,0)",t){let r=e.match(/(\d(\.\d+)?)+/g);return r[t]?parseFloat(r[t]):0}copy(e){return this.color=e.color.clone(),this.alpha=e.alpha,this}lerp(e,t){return this.color.r=this.color.r+(e.color.r-this.color.r)*t,this.color.g=this.color.g+(e.color.g-this.color.g)*t,this.color.b=this.color.b+(e.color.b-this.color.b)*t,this.alpha=this.alpha+(e.alpha-this.alpha)*t,this}clone(){return new this.constructor(this.color.r,this.color.g,this.color.b,this.alpha)}}class ArticulationAnimationController extends AnimationController{constructor(e,t,r=1,n,i,a,o,s){super("ArticulationAnimationController"),this.name=e+t.name+n,this.animationObject=t,this.duration=r,this.animationType=n,this.initVal=i,this.targetVal=a,this._currentTime=0,this._diffValue,[ArticulationModifierTypes.stroke,ArticulationModifierTypes.colorOverlay,ArticulationModifierTypes.colorReplace].includes(this.animationType)||(this._diffValue=(a-i)/r),this._checkOpacity=e=>(e<0&&(e=0),e>1&&(e=1),e),this.render=e=>{if(null!=this.animationObject){if(r-this._currentTime<e||this._currentTime>=r){switch(this.animationType){case ArticulationModifierTypes.rotationX:this.animationObject.rotation.x=a/180*Math.PI;break;case ArticulationModifierTypes.rotationY:this.animationObject.rotation.y=a/180*Math.PI;break;case ArticulationModifierTypes.rotationZ:this.animationObject.rotation.z=a/180*Math.PI;break;case ArticulationModifierTypes.translationX:this.animationObject.position.x=a;break;case ArticulationModifierTypes.translationY:this.animationObject.position.y=a;break;case ArticulationModifierTypes.translationZ:this.animationObject.position.z=a;break;case ArticulationModifierTypes.scaleX:this.animationObject.scale.x=a;break;case ArticulationModifierTypes.scaleY:this.animationObject.scale.y=a;break;case ArticulationModifierTypes.scaleZ:this.animationObject.scale.z=a;break;case ArticulationModifierTypes.opacity:t.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{e.transparent=!0,e.opacity=this._checkOpacity(a)})):(e.material.transparent=!0,e.material.opacity=this._checkOpacity(a)))}));break;case ArticulationModifierTypes.colorOverlay:t.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{e.color=a.color.clone(),e.opacity=a.alpha,e.opacity<=0&&(e.opacity=1,e.color=s&&s(e.name,this.animationType)&&s(e.name,this.animationType).articulationVal.color)})):(e.material.color=a.color.clone(),e.material.opacity=a.alpha,e.material.opacity<=0&&(e.material.opacity=1,e.material.color=s&&s(e.name,this.animationType)&&s(e.name,this.animationType).articulationVal.color)))}));break;case ArticulationModifierTypes.colorReplace:t.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{e.map=null,e.color=a.color.clone(),e.opacity=a.alpha,e.opacity<=0&&(e.opacity=1,e.color=s&&s(e.name,this.animationType)&&s(e.name,this.animationType).articulationVal.color,e.map=s&&s(e.name,this.animationType)&&s(e.name,this.animationType).articulationVal.map,e.needsUpdate=!0)})):(e.material.map=null,e.material.color=a.color.clone(),e.material.opacity=a.alpha,e.material.opacity<=0&&(e.material.opacity=1,e.material.color=s&&s(e.name,this.animationType)&&s(e.name,this.animationType).articulationVal.color,e.material.map=s&&s(e.name,this.animationType)&&s(e.name,this.animationType).articulationVal.map,e.material.needsUpdate=!0)))}));break;case ArticulationModifierTypes.stroke:_context.effectStore.initOutlinePass(t,!1,a)}return this.needsRemove=!0,void(this._currentTime=0)}switch(this._currentTime+=e,this.animationType){case ArticulationModifierTypes.rotationX:this.animationObject.rotation.x+=this._diffValue/180*Math.PI*e;break;case ArticulationModifierTypes.rotationY:this.animationObject.rotation.y+=this._diffValue/180*Math.PI*e;break;case ArticulationModifierTypes.rotationZ:this.animationObject.rotation.z+=this._diffValue/180*Math.PI*e;break;case ArticulationModifierTypes.translationX:this.animationObject.position.x+=this._diffValue*e;break;case ArticulationModifierTypes.translationY:this.animationObject.position.y+=this._diffValue*e;break;case ArticulationModifierTypes.translationZ:this.animationObject.position.z+=this._diffValue*e;break;case ArticulationModifierTypes.scaleX:this.animationObject.scale.x+=this._diffValue*e;break;case ArticulationModifierTypes.scaleY:this.animationObject.scale.y+=this._diffValue*e;break;case ArticulationModifierTypes.scaleZ:this.animationObject.scale.z+=this._diffValue*e;break;case ArticulationModifierTypes.opacity:t.traverse((t=>{"Mesh"==t.type&&(t.material instanceof Array?t.material.forEach((t=>{this._diffValue=(a-t.opacity)/r,t.transparent=!0,t.opacity+=this._diffValue*e,t.opacity=this._checkOpacity(t.opacity),o&&(t.opacity=o(t.opacity))})):(this._diffValue=(a-t.material.opacity)/r,t.material.transparent=!0,t.material.opacity+=this._diffValue*e,t.material.opacity=this._checkOpacity(t.material.opacity),o&&(t.material.opacity=o(t.material.opacity))))}));break;case ArticulationModifierTypes.colorOverlay:t.traverse((t=>{if("Mesh"==t.type){let n;t.material instanceof Array?t.material.forEach((t=>{a.alpha>0?(t.transparent=!0,this._diffValue=new RGBAColor((t.color.r-a.color.r)/r,(t.color.g-a.color.g)/r,(t.color.b-a.color.b)/r,(t.opacity-a.alpha)/r),n=new RGBAColor(t.color.r+this._diffValue.color.r*e,t.color.g+this._diffValue.color.g*e,t.color.b+this._diffValue.color.b*e,t.opacity+this._diffValue.alpha*e),o&&(t.color=o(n.color)),t.opacity=this._checkOpacity(n.alpha)):(t.opacity=1,t.color=s&&s(t.name,this.animationType)&&s(t.name,this.animationType).articulationVal.color)})):a.alpha>0?(t.material.transparent=!0,this._diffValue=new RGBAColor((t.material.color.r-a.color.r)/r,(t.material.color.g-a.color.g)/r,(t.material.color.b-a.color.b)/r,(t.material.opacity-a.alpha)/r),n=new RGBAColor(t.material.color.r+this._diffValue.color.r*e,t.material.color.g+this._diffValue.color.g*e,t.material.color.b+this._diffValue.color.b*e,t.material.opacity+this._diffValue.alpha*e),o&&(t.material.color=o(n.color)),t.material.opacity=this._checkOpacity(n.alpha)):(t.material.opacity=1,t.material.color=s&&s(t.name,this.animationType)&&s(t.name,this.animationType).articulationVal.color)}}));break;case ArticulationModifierTypes.colorReplace:t.traverse((t=>{if("Mesh"==t.type){let n;t.material instanceof Array?t.material.forEach((t=>{a.alpha>0?(t.map=null,t.transparent=!0,this._diffValue=new RGBAColor((t.color.r-a.color.r)/r,(t.color.g-a.color.g)/r,(t.color.b-a.color.b)/r,(t.opacity-a.alpha)/r),n=new RGBAColor(t.color.r+this._diffValue.color.r*e,t.color.g+this._diffValue.color.g*e,t.color.b+this._diffValue.color.b*e,t.opacity+this._diffValue.alpha*e),o&&(t.color=o(n.color)),t.opacity=this._checkOpacity(n.alpha)):(t.opacity=1,t.color=s&&s(t.name,this.animationType)&&s(t.name,this.animationType).articulationVal.color,t.map=s&&s(t.name,this.animationType)&&s(t.name,this.animationType).articulationVal.map,t.needsUpdate=!0)})):a.alpha>0?(t.material.map=null,t.material.transparent=!0,this._diffValue=new RGBAColor((t.material.color.r-a.color.r)/r,(t.material.color.g-a.color.g)/r,(t.material.color.b-a.color.b)/r,(t.material.opacity-a.alpha)/r),n=new RGBAColor(t.material.color.r+this._diffValue.color.r*e,t.material.color.g+this._diffValue.color.g*e,t.material.color.b+this._diffValue.color.b*e,t.material.opacity+this._diffValue.alpha*e),o&&(t.material.color=o(n.color)),t.material.opacity=this._checkOpacity(n.alpha)):(t.material.opacity=1,t.material.color=s&&s(t.name,this.animationType)&&s(t.name,this.animationType).articulationVal.color,t.material.map=s&&s(t.name,this.animationType)&&s(t.name,this.animationType).articulationVal.map,t.material.needsUpdate=!0)}}));break;case ArticulationModifierTypes.stroke:this._diffValue=new RGBAColor((a.color.r-i.color.r)/r,(a.color.g-i.color.g)/r,(a.color.b-i.color.b)/r,(a.alpha-i.alpha)/r),i.color.r+=this._diffValue.color.r*e,i.color.g+=this._diffValue.color.g*e,i.color.b+=this._diffValue.color.b*e,i.alpha+=this._diffValue.alpha*e,i.alpha=this._checkOpacity(i.alpha),_context.effectStore.initOutlinePass(t,!1,new RGBAColor(i.color.r,i.color.g,i.color.b,i.alpha))}}}}}ArticulationAnimationController.type="ArticulationAnimationController";class Articulation{constructor({type:e="numeric",name:t="",values:r=[],defaultValue:n}={}){let i=e,a=t,o=r,s=n,l=!1;this.properties=[],this.value=n,this.remark,this.isEnable=!0,this.openThreshold=!1;let c=[],h=[];function u(e,t,r,n){if("string"==typeof e)if("string"==typeof t&&""!==t)if(r instanceof Array&&!(r.length<1)){switch(e){case ArticulationTypes.numeric:if(2!==r.length)return void logger.warn(`关节参数错误（values）：${r}，numeric 类型的关节 values 参数应为 2 个数字组成的数组。`);if("number"!=typeof r[0]||"number"!=typeof r[1])return void logger.warn(`关节参数错误（values）：${r}，numeric 类型的关节 values 参数应为 2 个数字组成的数组。`);if(r[0]>r[1])return void logger.warn(`关节参数错误（values）：${r}，numeric 类型的关节 values[0] 应小于等于 values[1]。`);if("number"!=typeof n)return void logger.warn(`关节参数错误（values）：${r}，numeric 类型的关节 defaultValue 值应为数值。`);if(n<r[0]||n>r[1])return void logger.warn(`关节参数错误（defaultValue）：${n}，numeric 类型的关节 defaultValue 值应在 values[0] 和 values[1] 之间。`);break;case ArticulationTypes.enum:let t=!1;for(let e of r){if("string"!=typeof e&&"number"!=typeof e)return void logger.warn(`关节参数错误（values）：${r}，enum 类型的关节 values 参数应为字符串或数值组成的数组。`);n===e&&(t=!0)}if(!t)return void logger.warn(`关节参数错误（defaultValue）：${n}，enum 类型的关节 defaultValue 应该为 values 参数中定义过的枚举值之一。`);break;case ArticulationTypes.boolean:if(r=[!1,!0],"boolean"!=typeof n)return void logger.warn(`关节参数错误（defaultValue）：${n}，boolean 类型的关节 defaultValue 应该为 true 或 false 之一。`);break;case ArticulationTypes.text:break;default:return void logger.warn(`关节参数错误（type）：${e}，不支持的类型`)}l=!0}else logger.warn(`关节参数错误（values）：${r}。`);else logger.warn(`关节参数错误（name）：${t}。`);else logger.warn(`关节参数错误（type）：${e}。`)}this._recordDefaultVal=(e,t,r)=>{h.find((r=>r.articulationName===e&&r.articulationProperty===t))||h.push({articulationName:e,articulationProperty:t,articulationVal:r})},this._delDefaultVal=(e,t)=>{let r=h.findIndex((r=>r.articulationName===e&&r.articulationProperty===t));r>-1&&h.splice(r,1)},u(e,t,r,n),this.update=({type:e,name:t,values:r,defaultValue:n}={})=>{"string"!=typeof e||e===i?u(e,t=t||a,r=r||o,n=null==n?s:n):logger.warn(`关节参数错误（type）：${e}，不支持修改关节的类型。`)},this.addProperty=({nodes:e,modifiers:t})=>{let r=new ArticulationProperty({nodes:e,modifiers:t});this.properties.push(r)},this.removePropertyByIndex=e=>{this.properties.splice(e,1)},this.getSettings=()=>{},this.getName=()=>a,this.setName=e=>{e&&""!==e&&(a=e)},this.getType=()=>i,this.getModifierTypes=()=>({translationX:"translateX",translationY:"translateY",translationZ:"translateZ",rotationX:"rotateX",rotationY:"rotateY",rotationZ:"rotateZ",scaleX:"scaleX",scaleY:"scaleY",scaleZ:"scaleZ",opacity:"opacity",colorOverlay:"colorOverlay",colorReplace:"colorReplace",stroke:"stroke"}),this._interpolateAbsoluteNumeric=(t,r)=>{if(o[1]===o[0]||t[1]===t[0])return Number(t[0]);switch(e){case ArticulationTypes.numeric:let e=Number(t[0]),i=Number(t[1]);if(this.openThreshold)return Number(r-o[0])/Number(o[1]-o[0])*Number(i-e)+e;{let n=Math.max(...o),a=Math.min(...o);return r>=n?Number(t[o.indexOf(n)]):r<=a?Number(t[o.indexOf(a)]):Number(r-o[0])/Number(o[1]-o[0])*Number(i-e)+e}case ArticulationTypes.enum:case ArticulationTypes.boolean:let a=o.findIndex((e=>e===r));return a<0?s:Number(t[a]);default:return Number(n)}},this._interpolateRelativeNumeric=(t,r,n)=>{if(t==ArticulationModifierTypes.rotationX||t==ArticulationModifierTypes.rotationY||t==ArticulationModifierTypes.rotationZ){if(o[1]===o[0]||r[1]===r[0])return Number(r[0]);switch(e){case ArticulationTypes.numeric:let e=Number(r[0]),t=Number(r[1]);if(this.openThreshold)return Number(n-o[0])/Number(o[1]-o[0])*Number(t-e)+e;{let i=Math.max(...o),a=Math.min(...o);return n>=i?Number(r[o.indexOf(i)]):n<=a?Number(r[o.indexOf(a)]):Number(n-o[0])/Number(o[1]-o[0])*Number(t-e)+e}case ArticulationTypes.enum:case ArticulationTypes.boolean:let i=o.findIndex((e=>e===n));return Number(i<0?s:r[i])}}else if(t==ArticulationModifierTypes.opacity){if(o[1]===o[0]||r[1]===r[0])return.01*Number(r[0]);let t=Number(r[0]),a=Number(r[1]),l=0;switch(e){case ArticulationTypes.numeric:l=Number(n-o[0])/Number(o[1]-o[0])*Number(a-t)+t,l*=.01;break;case ArticulationTypes.enum:a=Number(r[r.length-1]),l=(i=o.findIndex((e=>e===n)))<0?.01*Number(s):.01*Number(r[i]);break;case ArticulationTypes.boolean:var i;l=(i=o.findIndex((e=>e===n)))<0?.01*Number(s):.01*Number(r[i])}return l<=0?0:l>=1?1:l}},this._interpolateColor=(t,n)=>{if(r[1]===r[0])return new RGBAColor(t[0]);switch(e){case ArticulationTypes.numeric:let e=Number(n-r[0])/Number(r[1]-r[0]),i=new RGBAColor(t[0]),a=new RGBAColor(t[1]);return i.lerp(a,e);case ArticulationTypes.enum:case ArticulationTypes.boolean:let s=o.findIndex((e=>e===n));return s<0?new RGBAColor(255,255,255,0):new RGBAColor(t[s])}},this._checkColor=e=>(e.r<0&&(e.r=0),e.r>1&&(e.r=1),e.g<0&&(e.g=0),e.g>1&&(e.g=1),e.b<0&&(e.b=0),e.b>1&&(e.b=1),e),this._checkOpacity=e=>(e<0&&(e=0),e>1&&(e=1),e),this.set=(e,t)=>{if(!this.isValid()||"function"!=typeof this.getModelNode||null==_context||null==_context.animationStore)return void logger.warn("正在设置的关节无效。");this.value=s=e;let r=this.getModelNode();if(i!=ArticulationTypes.text)for(let n of this.properties){let i=[];for(let e of n.nodes)r.getObjectByName(e)&&i.push(r.getObjectByName(e));if(0===i.length)return void logger.warn("正在设置的关节无效，无法找到指定的节点。");_context.effectStore&&_context.effectStore.initOutlinePass();for(let a of n.modifiers)for(let n of i){let i,o=_context&&_context.animationStore&&_context.animationStore.findAnimation&&_context.animationStore.findAnimation(r.name+n.name+a.key,ArticulationAnimationController.type);switch(o&&_context.animationStore.remove(o),a.key){case ArticulationModifierTypes.rotationX:this._recordDefaultVal(n.name,a.key,n.rotation.x),h.find((e=>e.articulationName===n.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?i=new ArticulationAnimationController(r.name,n,t,a.key,n.rotation.x/Math.PI*180,this._interpolateRelativeNumeric(ArticulationModifierTypes.rotationX,a.values,e)):n.rotation.set(this._interpolateRelativeNumeric(ArticulationModifierTypes.rotationX,a.values,e)/180*Math.PI,n.rotation.y,n.rotation.z);break;case ArticulationModifierTypes.rotationY:this._recordDefaultVal(n.name,a.key,n.rotation.y),h.find((e=>e.articulationName===n.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?i=new ArticulationAnimationController(r.name,n,t,a.key,n.rotation.y/Math.PI*180,this._interpolateRelativeNumeric(ArticulationModifierTypes.rotationY,a.values,e)):n.rotation.set(n.rotation.x,this._interpolateRelativeNumeric(ArticulationModifierTypes.rotationY,a.values,e)/180*Math.PI,n.rotation.z);break;case ArticulationModifierTypes.rotationZ:this._recordDefaultVal(n.name,a.key,n.rotation.z),h.find((e=>e.articulationName===n.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?i=new ArticulationAnimationController(r.name,n,t,a.key,n.rotation.z/Math.PI*180,this._interpolateRelativeNumeric(ArticulationModifierTypes.rotationZ,a.values,e)):n.rotation.set(n.rotation.x,n.rotation.y,this._interpolateRelativeNumeric(ArticulationModifierTypes.rotationZ,a.values,e)/180*Math.PI);break;case ArticulationModifierTypes.translationX:this._recordDefaultVal(n.name,a.key,n.position.x),h.find((e=>e.articulationName===n.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?i=new ArticulationAnimationController(r.name,n,t,a.key,n.position.x,this._interpolateAbsoluteNumeric(a.values,e)):n.position.set(this._interpolateAbsoluteNumeric(a.values,e),n.position.y,n.position.z);break;case ArticulationModifierTypes.translationY:this._recordDefaultVal(n.name,a.key,n.position.y),h.find((e=>e.articulationName===n.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?i=new ArticulationAnimationController(r.name,n,t,a.key,n.position.y,this._interpolateAbsoluteNumeric(a.values,e)):n.position.set(n.position.x,this._interpolateAbsoluteNumeric(a.values,e),n.position.z);break;case ArticulationModifierTypes.translationZ:this._recordDefaultVal(n.name,a.key,n.position.z),h.find((e=>e.articulationName===n.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?i=new ArticulationAnimationController(r.name,n,t,a.key,n.position.z,this._interpolateAbsoluteNumeric(a.values,e)):n.position.set(n.position.x,n.position.y,this._interpolateAbsoluteNumeric(a.values,e));break;case ArticulationModifierTypes.scaleX:this._recordDefaultVal(n.name,a.key,n.scale.x),h.find((e=>e.articulationName===n.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?i=new ArticulationAnimationController(r.name,n,t,a.key,n.scale.x,this._interpolateAbsoluteNumeric(a.values,e)):n.scale.set(this._interpolateAbsoluteNumeric(a.values,e),n.scale.y,n.scale.z);break;case ArticulationModifierTypes.scaleY:this._recordDefaultVal(n.name,a.key,n.scale.y),h.find((e=>e.articulationName===n.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?i=new ArticulationAnimationController(r.name,n,t,a.key,n.scale.y,this._interpolateAbsoluteNumeric(a.values,e)):n.scale.set(n.scale.x,this._interpolateAbsoluteNumeric(a.values,e),n.scale.z);break;case ArticulationModifierTypes.scaleZ:this._recordDefaultVal(n.name,a.key,n.scale.z),h.find((e=>e.articulationName===n.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?i=new ArticulationAnimationController(r.name,n,t,a.key,n.scale.z,this._interpolateAbsoluteNumeric(a.values,e)):n.scale.set(n.scale.x,n.scale.y,this._interpolateAbsoluteNumeric(a.values,e));break;case ArticulationModifierTypes.opacity:t&&t>0?i=new ArticulationAnimationController(r.name,n,t,a.key,a.values[0],this._interpolateRelativeNumeric(ArticulationModifierTypes.opacity,a.values,e),this._checkOpacity):(n.traverse((e=>{if("Mesh"==e.type)if(e.material instanceof Array)e.material.forEach((t=>{let r=t.opacity,n=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ArticulationModifierTypes.opacity));n&&(r=n.articulationVal);let i=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ArticulationModifierTypes.colorOverlay));i&&(r=i.articulationVal.opacity);let o=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ArticulationModifierTypes.colorReplace));o&&(r=o.articulationVal.opacity),this._recordDefaultVal(e.name+":"+t.name,a.key,r)}));else{let t=e.material.opacity,r=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ArticulationModifierTypes.opacity));r&&(t=r.articulationVal);let i=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ArticulationModifierTypes.colorOverlay));i&&(t=i.articulationVal.opacity);let o=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ArticulationModifierTypes.colorReplace));o&&(t=o.articulationVal.opacity),this._recordDefaultVal(n.name+":"+e.name,a.key,t)}})),n.traverse((t=>{"Mesh"==t.type&&(t.material instanceof Array?t.material.forEach((t=>{t.transparent=!0,t.opacity=this._interpolateRelativeNumeric(ArticulationModifierTypes.opacity,a.values,e)})):(t.material.transparent=!0,t.material.opacity=this._interpolateRelativeNumeric(ArticulationModifierTypes.opacity,a.values,e)))})));break;case ArticulationModifierTypes.colorOverlay:let o=this._interpolateColor(a.values,e);t&&t>0?i=new ArticulationAnimationController(r.name,n,t,a.key,new RGBAColor(a.values[0]),o,this._checkColor,this.getDefaultVal):(n.traverse((e=>{if("Mesh"==e.type)if(e.material instanceof Array)e.material.forEach((t=>{let r=t.opacity,n=new Color(t.color),i=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ArticulationModifierTypes.colorOverlay));i&&(n=new Color(i.articulationVal.color),r=i.articulationVal.opacity);let o=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ArticulationModifierTypes.opacity));o&&(r=o);let s=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ArticulationModifierTypes.colorReplace));s&&(n=new Color(s.articulationVal.color),r=s.articulationVal.opacity),this._recordDefaultVal(e.name+":"+t.name,a.key,{color:n,opacity:r})}));else{let t=e.material.opacity,r=new Color(e.material.color),i=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ArticulationModifierTypes.colorOverlay));i&&(r=new Color(i.articulationVal.color),t=i.articulationVal.opacity);let o=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ArticulationModifierTypes.opacity));o&&(t=o);let s=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ArticulationModifierTypes.colorReplace));s&&(r=new Color(s.articulationVal.color),t=s.articulationVal.opacity),this._recordDefaultVal(n.name+":"+e.name,a.key,{color:r,opacity:t})}})),n.traverse((e=>{if("Mesh"==e.type)if(e.material instanceof Array)e.material.forEach((e=>{let t=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ArticulationModifierTypes.colorReplace));t||(e.transparent=!0,e.color=o.color,e.opacity=o.alpha,t=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ArticulationModifierTypes.colorOverlay)),e.opacity<=0&&(e.opacity=1,e.color=t&&new Color(t.articulationVal.color)))}));else{let t=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ArticulationModifierTypes.colorReplace));t||(e.material.transparent=!0,e.material.color=o.color,e.material.opacity=o.alpha,t=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ArticulationModifierTypes.colorOverlay)),e.material.opacity<=0&&(e.material.opacity=1,e.material.color=t&&new Color(t.articulationVal.color)))}})));break;case ArticulationModifierTypes.colorReplace:let s=this._interpolateColor(a.values,e);t&&t>0?i=new ArticulationAnimationController(r.name,n,t,a.key,new RGBAColor(a.values[0]),s,this._checkColor,this.getDefaultVal):(n.traverse((e=>{if("Mesh"==e.type)if(e.material instanceof Array)e.material.forEach((t=>{let r=t.opacity,n=new Color(t.color),i=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ArticulationModifierTypes.colorReplace));i&&(r=i.articulationVal.opacity,n=new Color(i.articulationVal.color));let o=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ArticulationModifierTypes.opacity));o&&(r=o);let s=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ArticulationModifierTypes.colorOverlay));s&&(r=s.articulationVal.opacity,n=new Color(s.articulationVal.color)),this._recordDefaultVal(e.name+":"+t.name,a.key,{map:t.map,color:n,opacity:r})}));else{let t=e.material.opacity,r=new Color(e.material.color),i=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ArticulationModifierTypes.colorReplace));i&&(t=i.articulationVal.opacity,r=new Color(i.articulationVal.color));let o=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ArticulationModifierTypes.opacity));o&&(t=o);let s=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ArticulationModifierTypes.colorOverlay));s&&(t=s.articulationVal.opacity,r=new Color(s.articulationVal.color)),this._recordDefaultVal(n.name+":"+e.name,a.key,{map:e.map,color:r,opacity:t})}})),n.traverse((e=>{if("Mesh"==e.type)if(e.material instanceof Array)e.material.forEach((e=>{if(s.alpha>0)e.transparent=!0,e.map=null,e.color=s.color,e.opacity=s.alpha;else{let t=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ArticulationModifierTypes.colorReplace));t&&(e.opacity=1,e.map=t.articulationVal.map,e.color=new Color(t.articulationVal.color),e.needsUpdate=!0)}}));else if(s.alpha>0)e.material.transparent=!0,e.map=null,e.material.color=s.color,e.material.opacity=s.alpha;else{let t=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ArticulationModifierTypes.colorReplace));t&&(e.material.opacity=1,e.material.map=t.articulationVal.map,e.material.color=new Color(t.articulationVal.color),e.material.needsUpdate=!0)}})));break;case ArticulationModifierTypes.stroke:if(t&&t>0){let o,s=h.find((e=>e.articulationName===n.name&&e.articulationProperty===a.key));s?(o=s.articulationVal,this._delDefaultVal(n.name,a.key),this._recordDefaultVal(n.name,a.key,this._interpolateColor(a.values,e))):(this._recordDefaultVal(n.name,a.key,this._interpolateColor(a.values,e)),o=new RGBAColor(a.values[0])),i=new ArticulationAnimationController(r.name,n,t,a.key,o,this._interpolateColor(a.values,e),this._checkColor)}else _context.effectStore&&_context.effectStore.initOutlinePass(n,!0,this._interpolateColor(a.values,e))}i&&_context.animationStore.add(i)}}},this.reset=(e,t)=>{if(h.length<=0)return;let r=this.getModelNode();if(i!=ArticulationTypes.text)for(let n of e){let e=r.getObjectByName(n);e&&t&&t.forEach((t=>{let r;switch(t){case ArticulationModifierTypes.rotationX:r=h.find((r=>r.articulationName===e.name&&r.articulationProperty===t)),r&&(e.rotation.x=r.articulationVal,this._delDefaultVal(e.name,t));break;case ArticulationModifierTypes.rotationY:r=h.find((r=>r.articulationName===e.name&&r.articulationProperty===t)),r&&(e.rotation.y=r.articulationVal,this._delDefaultVal(e.name,t));break;case ArticulationModifierTypes.rotationZ:r=h.find((r=>r.articulationName===e.name&&r.articulationProperty===t)),r&&(e.rotation.z=r.articulationVal,this._delDefaultVal(e.name,t));break;case ArticulationModifierTypes.translationX:r=h.find((r=>r.articulationName===e.name&&r.articulationProperty===t)),r&&(e.position.x=r.articulationVal,this._delDefaultVal(e.name,t));break;case ArticulationModifierTypes.translationY:r=h.find((r=>r.articulationName===e.name&&r.articulationProperty===t)),r&&(e.position.y=r.articulationVal,this._delDefaultVal(e.name,t));break;case ArticulationModifierTypes.translationZ:r=h.find((r=>r.articulationName===e.name&&r.articulationProperty===t)),r&&(e.position.z=r.articulationVal,this._delDefaultVal(e.name,t));break;case ArticulationModifierTypes.scaleX:r=h.find((r=>r.articulationName===e.name&&r.articulationProperty===t)),r&&(e.scale.x=r.articulationVal,this._delDefaultVal(e.name,t));break;case ArticulationModifierTypes.scaleY:r=h.find((r=>r.articulationName===e.name&&r.articulationProperty===t)),r&&(e.scale.y=r.articulationVal,this._delDefaultVal(e.name,t));break;case ArticulationModifierTypes.scaleZ:r=h.find((r=>r.articulationName===e.name&&r.articulationProperty===t)),r&&(e.scale.z=r.articulationVal,this._delDefaultVal(e.name,t));break;case ArticulationModifierTypes.opacity:e.traverse((n=>{"Mesh"==n.type&&(n.material instanceof Array?n.material.forEach((e=>{r=h.find((r=>r.articulationName===n.name+":"+e.name&&r.articulationProperty===t)),r&&(e.opacity=r.articulationVal,this._delDefaultVal(n.name+":"+e.name,t))})):(r=h.find((r=>r.articulationName===e.name+":"+n.name&&r.articulationProperty===t)),r&&(n.material.opacity=r.articulationVal,this._delDefaultVal(e.name+":"+n.name,t))))}));break;case ArticulationModifierTypes.colorOverlay:e.traverse((n=>{"Mesh"==n.type&&(n.material instanceof Array?n.material.forEach((e=>{r=h.find((r=>r.articulationName.indexOf(e.name)>-1&&r.articulationProperty===t)),r&&(e.color=r.articulationVal.color,e.opacity=r.articulationVal.opacity,this._delDefaultVal(n.name+":"+e.name,t))})):(r=h.find((e=>e.articulationName.indexOf(n.name)>-1&&e.articulationProperty===t)),r&&(n.material.color=r.articulationVal.color,n.material.opacity=r.articulationVal.opacity,this._delDefaultVal(e.name+":"+n.name,t))))}));break;case ArticulationModifierTypes.colorReplace:e.traverse((n=>{if("Mesh"==n.type)if(n.material instanceof Array)n.material.forEach((e=>{if(r=h.find((r=>r.articulationName.indexOf(e.name)>-1&&r.articulationProperty===t)),r){let i=r.articulationVal;e.map=i.map,e.color=new Color(i.color),e.opacity=i.opacity,e.needsUpdate=!0,this._delDefaultVal(n.name+":"+e.name,t)}}));else if(r=h.find((e=>e.articulationName.indexOf(n.name)>-1&&e.articulationProperty===t)),r){let i=r.articulationVal;n.map=i.map,n.material.color=new Color(i.color),n.opacity=i.opacity,n.material.needsUpdate=!0,this._delDefaultVal(e.name+":"+n.name,t)}}));break;case ArticulationModifierTypes.stroke:_context.effectStore.initOutlinePass()}}))}else c.forEach((t=>{t.traverse((t=>{if(e.inclues(t.name)){let e=r.getObjectByName(t.parent.name),n=e.children.findIndex((e=>e.name==t.name));e.children.splice(n,1),t.material&&t.material.dispose(),t.geometry&&t.geometry.dispose()}}))}))},this.addOrUpdateTextArticulation=()=>{let e=this.getModelNode();c.forEach((t=>{t.traverse((t=>{let r=e.getObjectByName(t.parent.name),n=r.children.findIndex((e=>e.name==t.name));r.children.splice(n,1),t.material&&t.material.dispose(),t.geometry&&t.geometry.dispose()}))})),c=[],this.properties.forEach(((t,r)=>{t.nodes.forEach(((n,i)=>{let s=e.getObjectByName(n);if(s){let e=s.name+a+r+i,n=s.children.findIndex((t=>t.name==e));n>-1&&(s.children[n].material.dispose(),s.children[n].geometry.dispose(),s.children.splice(n,1));let l=function({labelFontFamily:e="微软雅黑",labelFontSize:t=3,labelFontBold:r=!1,labelEnableItalic:n=!1,labelBackground:i="rgb(0,0,0)",labelColor:a="rgb(1,1,1)",labelText:o="标题文字"}){let s=document.createElement("canvas"),l=s.getContext("2d"),c=t,h="";r&&(h="bold");let u="";return n&&(u="italic"),l.font=`${u} ${h} ${c}px ${e}`,l.textAlign="center",l.textBaseline="middle",s.width=1.8*(l.measureText(o).width+c),s.height=3.2*c,l.fillStyle=i,l.fillRect(0,0,s.width,s.height),l.font=`${u} ${h} ${2*c}px ${e}`,l.fillStyle=a,l.textAlign="center",l.textBaseline="middle",l.fillText(o,s.width/2,s.height/2),s}(o[0]),h=new CanvasTexture(l),u=new SpriteMaterial({map:h,color:16777215,fog:DRAWABLE_FOG,depthWrite:!0,depthTest:!1,depthFunc:AlwaysDepth,sizeAttenuation:!0}),d=new Sprite(u);d.scale.set(.005*l.width,.005*l.height,1);let p=t.modifiers.find((e=>"x"==e.key)).values[0],f=t.modifiers.find((e=>"y"==e.key)).values[0],m=t.modifiers.find((e=>"z"==e.key)).values[0];d.position.set(p,f,m),d.name=e,d.parent=s,s.children.push(d),c.push(d)}}))}))},this.deleteArticulation=()=>{let e=this.getModelNode();if(i!=ArticulationTypes.text)for(let t of this.properties){let r=[];for(let n of t.nodes)e.getObjectByName(n)&&r.push(e.getObjectByName(n));if(0===r.length)return void logger.warn("正在设置的关节无效，无法找到指定的节点。");for(let e of t.modifiers)for(let t of r){let r=0;switch(e.key){case ArticulationModifierTypes.rotationX:r=h.find((r=>r.articulationName===t.name&&r.articulationProperty===e.key)).articulationVal,t.rotation.set(r,t.rotation.y,t.rotation.z),this._delDefaultVal(t.name,e.key);break;case ArticulationModifierTypes.rotationY:r=h.find((r=>r.articulationName===t.name&&r.articulationProperty===e.key)).articulationVal,t.rotation.set(t.rotation.x,r,t.rotation.z),this._delDefaultVal(t.name,e.key);break;case ArticulationModifierTypes.rotationZ:r=h.find((r=>r.articulationName===t.name&&r.articulationProperty===e.key)).articulationVal,t.rotation.set(t.rotation.x,t.rotation.y,r),this._delDefaultVal(t.name,e.key);break;case ArticulationModifierTypes.translationX:r=h.find((r=>r.articulationName===t.name&&r.articulationProperty===e.key)).articulationVal,t.position.set(r,t.position.y,t.position.z),this._delDefaultVal(t.name,e.key);break;case ArticulationModifierTypes.translationY:r=h.find((r=>r.articulationName===t.name&&r.articulationProperty===e.key)).articulationVal,t.position.set(t.position.x,r,t.position.z),this._delDefaultVal(t.name,e.key);break;case ArticulationModifierTypes.translationZ:r=h.find((r=>r.articulationName===t.name&&r.articulationProperty===e.key)).articulationVal,t.position.set(t.position.x,t.position.y,r),this._delDefaultVal(t.name,e.key);break;case ArticulationModifierTypes.scaleX:r=h.find((r=>r.articulationName===t.name&&r.articulationProperty===e.key)).articulationVal,t.scale.set(r,t.scale.y,t.scale.z),this._delDefaultVal(t.name,e.key);break;case ArticulationModifierTypes.scaleY:r=h.find((r=>r.articulationName===t.name&&r.articulationProperty===e.key)).articulationVal,t.scale.set(t.scale.x,r,t.scale.z),this._delDefaultVal(t.name,e.key);break;case ArticulationModifierTypes.scaleZ:r=h.find((r=>r.articulationName===t.name&&r.articulationProperty===e.key)).articulationVal,t.scale.set(t.scale.x,t.scale.y,r),this._delDefaultVal(t.name,e.key);break;case ArticulationModifierTypes.opacity:t.traverse((n=>{if("Mesh"==n.type)if(n.material instanceof Array)n.material.forEach((t=>{t.transparent=!1;let i=h.find((r=>r.articulationName.indexOf(t.name)>-1&&r.articulationProperty===e.key));i&&(r=i.articulationVal,t.opacity=r,this._delDefaultVal(n.name+":"+t.name,e.key))}));else{let i=h.find((t=>t.articulationName.indexOf(n.name)>-1&&t.articulationProperty===e.key));i&&(r=i.articulationVal,n.material.transparent=!1,n.material.opacity=r,this._delDefaultVal(t.name+":"+n.name,e.key))}}));break;case ArticulationModifierTypes.colorOverlay:t.traverse((n=>{if("Mesh"==n.type)if(n.material instanceof Array)n.material.forEach((t=>{let i=h.find((r=>r.articulationName===n.name+":"+t.name&&r.articulationProperty===e.key));i&&(r=i.articulationVal,t.color=r.color,t.opacity=r.opacity,this._delDefaultVal(n.name+":"+t.name,e.key))}));else{let i=h.find((r=>r.articulationName===t.name+":"+n.name&&r.articulationProperty===e.key));i&&(r=i.articulationVal,n.material.color=r.color,n.material.opacity=r.opacity,this._delDefaultVal(t.name+":"+n.name,e.key))}}));break;case ArticulationModifierTypes.colorReplace:t.traverse((n=>{if("Mesh"==n.type)if(n.material instanceof Array)n.material.forEach((t=>{let i=h.find((r=>r.articulationName.indexOf(t.name)>-1&&r.articulationProperty===e.key));i&&(r=i.articulationVal,t.map=r.map,t.color=r.color,t.opacity=r.opacity,t.needsUpdate=!0,this._delDefaultVal(n.name+":"+t.name,e.key))}));else{let i=h.find((t=>t.articulationName.indexOf(n.name)>-1&&t.articulationProperty===e.key));i&&(r=i.articulationVal,n.map=r.map,n.material.color=r.color,n.material.transparent=r.opacity,n.material.needsUpdate=!0,this._delDefaultVal(t.name+":"+n.name,e.key))}}));break;case ArticulationModifierTypes.stroke:_context.effectStore.initOutlinePass()}}}else c.forEach((t=>{t.traverse((t=>{let r=e.getObjectByName(t.parent.name),n=r.children.findIndex((e=>e.name==t.name));r.children.splice(n,1),t.material&&t.material.dispose(),t.geometry&&t.geometry.dispose()}))})),c=[]},this.getDefaultVal=(e,t)=>h.find((r=>r.articulationName.indexOf(e)>-1&&r.articulationProperty===t)),this.isValid=()=>l,this.getValues=()=>o,this.getDefaultValue=()=>s}get name(){return this.getName()}set name(e){this.setName(e)}get type(){return this.getType()}set type(e){logger.warn("不支持修改关节的类型。")}}class AreaLineAnimationController extends AnimationController{constructor(e,t){super("AreaLineAnimationController"),this.animationObject=e,this.resolution=t,this.render=e=>{null!=this.animationObject&&this.animationObject.resolution.set(this.resolution.x/4,this.resolution.y/4)},this.reset=()=>{}}}AreaLineAnimationController.type="AreaLineAnimationController";let AnimationTypes={NONE:"none",ROUND:"round",REPEAT:"repeat"};class ArticulationAnimationGroupController extends AnimationController{constructor(e,t,r,n,i){super("ArticulationAnimationGroupController"),this.animationName=this.name=e,this.animationType=t,this.animationSpeed=r,this.articulationAnimations=n;let a,o=this.articulationAnimations.map((e=>e.startTime+e.continueTime)),s=[...new Set(this.articulationAnimations.map((e=>e.startTime)))],l=[...new Set(o)].sort(((e,t)=>e-t)),c=Math.max(...o)/r,h=0,u=!1,d=[];this._recordDefaultVal=(e,t,r,n,i)=>{d.find((n=>n.startTime==e&&n.articulationName===t&&n.articulationProperty===r))||d.push({startTime:e,articulationName:t,articulationProperty:r,articulationVal:n,articulationDiff:i})};let p=-1,f=-1;this._recordDefaultStateAnimations=()=>{this.articulationAnimations.forEach((e=>{a||(a=_context.defaultObjectTree.getItemByName(e.modelId));let t=a&&a.articulations.find((t=>t._name==e.articulationName));if(t)for(let n of t.properties){let i=[];for(let e of n.nodes)a.getGroup().getObjectByName(e)&&i.push(a.getGroup().getObjectByName(e));let o=0,s=0;for(let a of n.modifiers)for(let n of i)switch(a.key){case ArticulationModifierTypes.rotationX:o=t._interpolateRelativeNumeric(ArticulationModifierTypes.rotationX,a.values,e.startState),s=t._interpolateRelativeNumeric(ArticulationModifierTypes.rotationX,a.values,e.endState),this._recordDefaultVal(e.startTime,n.name,a.key,n.rotation.x,(s-o)/e.continueTime*r);break;case ArticulationModifierTypes.rotationY:o=t._interpolateRelativeNumeric(ArticulationModifierTypes.rotationY,a.values,e.startState),s=t._interpolateRelativeNumeric(ArticulationModifierTypes.rotationY,a.values,e.endState),this._recordDefaultVal(e.startTime,n.name,a.key,n.rotation.y,(s-o)/e.continueTime*r);break;case ArticulationModifierTypes.rotationZ:o=t._interpolateRelativeNumeric(ArticulationModifierTypes.rotationZ,a.values,e.startState),s=t._interpolateRelativeNumeric(ArticulationModifierTypes.rotationZ,a.values,e.endState),this._recordDefaultVal(e.startTime,n.name,a.key,n.rotation.z,(s-o)/e.continueTime*r);break;case ArticulationModifierTypes.translationX:o=t._interpolateAbsoluteNumeric(a.values,e.startState),s=t._interpolateAbsoluteNumeric(a.values,e.endState),this._recordDefaultVal(e.startTime,n.name,a.key,n.position.x,(s-o)/e.continueTime*r);break;case ArticulationModifierTypes.translationY:o=t._interpolateAbsoluteNumeric(a.values,e.startState),s=t._interpolateAbsoluteNumeric(a.values,e.endState),this._recordDefaultVal(e.startTime,n.name,a.key,n.position.y,(s-o)/e.continueTime*r);break;case ArticulationModifierTypes.translationZ:o=t._interpolateAbsoluteNumeric(a.values,e.startState),s=t._interpolateAbsoluteNumeric(a.values,e.endState),this._recordDefaultVal(e.startTime,n.name,a.key,n.position.z,(s-o)/e.continueTime*r);break;case ArticulationModifierTypes.scaleX:o=t._interpolateAbsoluteNumeric(a.values,e.startState),s=t._interpolateAbsoluteNumeric(a.values,e.endState),this._recordDefaultVal(e.startTime,n.name,a.key,n.scale.x,(s-o)/e.continueTime*r);break;case ArticulationModifierTypes.scaleY:o=t._interpolateAbsoluteNumeric(a.values,e.startState),s=t._interpolateAbsoluteNumeric(a.values,e.endState),this._recordDefaultVal(e.startTime,n.name,a.key,n.scale.y,(s-o)/e.continueTime*r);break;case ArticulationModifierTypes.scaleZ:o=t._interpolateAbsoluteNumeric(a.values,e.startState),s=t._interpolateAbsoluteNumeric(a.values,e.endState),this._recordDefaultVal(e.startTime,n.name,a.key,n.scale.z,(s-o)/e.continueTime*r);break;case ArticulationModifierTypes.opacity:o=t._interpolateRelativeNumeric(ArticulationModifierTypes.opacity,a.values,e.startState),s=t._interpolateRelativeNumeric(ArticulationModifierTypes.opacity,a.values,e.endState),n.traverse((t=>{"Mesh"==t.type&&(t.material instanceof Array?t.material.forEach((n=>{n.transparent=!0,this._recordDefaultVal(e.startTime,t.name+":"+n.name,a.key,n.opacity,(s-o)/e.continueTime*r)})):(t.material.transparent=!0,this._recordDefaultVal(e.startTime,t.name+":"+t.name,a.key,t.material.opacity,(s-o)/e.continueTime*r)))}));break;case ArticulationModifierTypes.colorOverlay:o=t._interpolateColor(a.values,e.startState),s=t._interpolateColor(a.values,e.endState),n.traverse((t=>{if("Mesh"==t.type)if(t.material instanceof Array)t.material.forEach((n=>{let i=new RGBAColor((s.color.r-o.color.r)/e.continueTime*r,(s.color.g-o.color.g)/e.continueTime*r,(s.color.b-o.color.b)/e.continueTime*r,(s.alpha-o.alpha)/e.continueTime*r);this._recordDefaultVal(e.startTime,t.name+":"+n.name,a.key,{color:n.color,opacity:n.opacity},i),n.transparent=!0}));else{let i=new RGBAColor((s.color.r-o.color.r)/e.continueTime*r,(s.color.g-o.color.g)/e.continueTime*r,(s.color.b-o.color.b)/e.continueTime*r,(s.alpha-o.alpha)/e.continueTime*r);this._recordDefaultVal(e.startTime,n.name+":"+t.name,a.key,{color:t.material.color,opacity:t.material.opacity},i),t.material.transparent=!0}}));break;case ArticulationModifierTypes.colorReplace:o=t._interpolateColor(a.values,e.startState),s=t._interpolateColor(a.values,e.endState),n.traverse((t=>{if("Mesh"==t.type)if(t.material instanceof Array)t.material.forEach((n=>{let i=new RGBAColor((s.color.r-o.color.r)/e.continueTime*r,(s.color.g-o.color.g)/e.continueTime*r,(s.color.b-o.color.b)/e.continueTime*r,(s.alpha-o.alpha)/e.continueTime*r);this._recordDefaultVal(e.startTime,t.name+":"+n.name,a.key,{map:n.map,color:n.color,opacity:n.opacity},i),n.map=null,n.transparent=!0}));else{let i=new RGBAColor((s.color.r-o.color.r)/e.continueTime*r,(s.color.g-o.color.g)/e.continueTime*r,(s.color.b-o.color.b)/e.continueTime*r,(s.alpha-o.alpha)/e.continueTime*r);this._recordDefaultVal(e.startTime,n.name+":"+t.name,a.key,{map:t.material.map,color:t.material.color,opacity:t.material.opacity},i),t.material.map=null,t.material.transparent=!0}}));break;case ArticulationModifierTypes.stroke:o=t._interpolateColor(a.values,e.startState),s=t._interpolateColor(a.values,e.endState);let i=new RGBAColor((s.color.r-o.color.r)/e.continueTime*r,(s.color.g-o.color.g)/e.continueTime*r,(s.color.b-o.color.b)/e.continueTime*r,(s.alpha-o.alpha)/e.continueTime*r);this._recordDefaultVal(e.startTime,n.name,a.key,{color:o,tempColor:o.clone()},i)}}}))},this._initAnimation=()=>{p=-1;let e=[];this.articulationAnimations.forEach((t=>{a||(a=_context.defaultObjectTree.getItemByName(t.modelId));let r=a&&a.articulations.find((e=>e._name==t.articulationName));if(r)for(let n of r.properties){let i=[];for(let e of n.nodes){let t=a.getGroup().getObjectByName(e);t&&i.push(t)}let o=0;_context.effectStore.initOutlinePass();for(let a of n.modifiers)for(let n of i){let i=e.find((e=>e.nodeName==n.name&&e.modifierKey==a.key));if([ArticulationModifierTypes.colorOverlay,ArticulationModifierTypes.colorReplace].includes(a.key)&&(i=e.find((e=>e.nodeName==n.name&&[ArticulationModifierTypes.colorOverlay,ArticulationModifierTypes.colorReplace].includes(e.modifierKey)))),!i)switch(e.push({nodeName:n.name,modifierKey:a.key}),a.key){case ArticulationModifierTypes.rotationX:o=r._interpolateRelativeNumeric(ArticulationModifierTypes.rotationX,a.values,t.startState),n.rotation.x=o/180*Math.PI;break;case ArticulationModifierTypes.rotationY:o=r._interpolateRelativeNumeric(ArticulationModifierTypes.rotationY,a.values,t.startState),n.rotation.y=o/180*Math.PI;break;case ArticulationModifierTypes.rotationZ:o=r._interpolateRelativeNumeric(ArticulationModifierTypes.rotationZ,a.values,t.startState),n.rotation.z=o/180*Math.PI;break;case ArticulationModifierTypes.translationX:o=r._interpolateAbsoluteNumeric(a.values,t.startState),n.position.x=o;break;case ArticulationModifierTypes.translationY:o=r._interpolateAbsoluteNumeric(a.values,t.startState),n.position.y=o;break;case ArticulationModifierTypes.translationZ:o=r._interpolateAbsoluteNumeric(a.values,t.startState),n.position.z=o;break;case ArticulationModifierTypes.scaleX:o=r._interpolateAbsoluteNumeric(a.values,t.startState),n.scale.x=o;break;case ArticulationModifierTypes.scaleY:o=r._interpolateAbsoluteNumeric(a.values,t.startState),n.scale.y=o;break;case ArticulationModifierTypes.scaleZ:o=r._interpolateAbsoluteNumeric(a.values,t.startState),n.scale.z=o;break;case ArticulationModifierTypes.opacity:o=r._interpolateRelativeNumeric(ArticulationModifierTypes.opacity,a.values,t.startState),n.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{e.transparent=!0,e.opacity=o})):(e.material.transparent=!0,e.material.opacity=o))}));break;case ArticulationModifierTypes.colorOverlay:o=r._interpolateColor(a.values,t.startState),n.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{o.alpha>0?(e.transparent=!0,e.color=o.color,e.opacity=o.alpha):(e.opacity=1,e.color=r.getDefaultVal(e.name,a.key)&&r.getDefaultVal(e.name,a.key).articulationVal.color)})):o.alpha>0?(e.material.transparent=!0,e.material.color=o.color,e.material.opacity=o.alpha):(e.material.opacity=1,e.material.color=r.getDefaultVal(e.name,a.key)&&r.getDefaultVal(e.name,a.key).articulationVal.color))}));break;case ArticulationModifierTypes.colorReplace:o=r._interpolateColor(a.values,t.startState),n.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{o.alpha>0?(e.map=null,e.transparent=!0,e.color=o.color,e.opacity=o.alpha):(e.map=r.getDefaultVal(e.name,a.key)&&r.getDefaultVal(e.name,a.key).articulationVal.map,e.color=r.getDefaultVal(e.name,a.key)&&r.getDefaultVal(e.name,a.key).articulationVal.color,e.opacity=1),e.needsUpdate=!0})):(o.alpha>0?(e.material.map=null,e.material.transparent=!0,e.material.color=o.color,e.material.opacity=o.alpha):(e.material.map=r.getDefaultVal(e.name,a.key)&&r.getDefaultVal(e.name,a.key).articulationVal.map,e.material.color=r.getDefaultVal(e.name,a.key)&&r.getDefaultVal(e.name,a.key).articulationVal.color,e.material.opacity=1),e.material.needsUpdate=!0))}));break;case ArticulationModifierTypes.stroke:o=r._interpolateColor(a.values,t.startState);let e=d.find((e=>e.startTime==t.startTime&&e.articulationName===n.name&&e.articulationProperty===a.key));e&&(e.articulationVal.tempColor.color=o.color.clone(),e.articulationVal.tempColor.alpha=o.alpha),_context.effectStore.initOutlinePass(n,!0,o)}}}}))},this._recordDefaultStateAnimations(),this._initAnimation(),this._setEndAnimation=e=>{let t=l[e];this.articulationAnimations.filter((e=>e.startTime+e.continueTime==t)).forEach((e=>{a||(a=_context.defaultObjectTree.getItemByName(e.modelId));let t=a&&a.articulations.find((t=>t._name==e.articulationName));if(t)for(let r of t.properties){let n=[];for(let e of r.nodes)a.getGroup().getObjectByName(e)&&n.push(a.getGroup().getObjectByName(e));let i=0;_context.effectStore.initOutlinePass();for(let a of r.modifiers)for(let r of n)switch(a.key){case ArticulationModifierTypes.rotationX:i=t._interpolateRelativeNumeric(ArticulationModifierTypes.rotationX,a.values,e.endState),r.rotation.x=i/180*Math.PI;break;case ArticulationModifierTypes.rotationY:i=t._interpolateRelativeNumeric(ArticulationModifierTypes.rotationY,a.values,e.endState),r.rotation.y=i/180*Math.PI;break;case ArticulationModifierTypes.rotationZ:i=t._interpolateRelativeNumeric(ArticulationModifierTypes.rotationZ,a.values,e.endState),r.rotation.z=i/180*Math.PI;break;case ArticulationModifierTypes.translationX:i=t._interpolateAbsoluteNumeric(a.values,e.endState),r.position.x=i;break;case ArticulationModifierTypes.translationY:i=t._interpolateAbsoluteNumeric(a.values,e.endState),r.position.y=i;break;case ArticulationModifierTypes.translationZ:i=t._interpolateAbsoluteNumeric(a.values,e.endState),r.position.z=i;break;case ArticulationModifierTypes.scaleX:i=t._interpolateAbsoluteNumeric(a.values,e.endState),r.scale.x=i;break;case ArticulationModifierTypes.scaleY:i=t._interpolateAbsoluteNumeric(a.values,e.endState),r.scale.y=i;break;case ArticulationModifierTypes.scaleZ:i=t._interpolateAbsoluteNumeric(a.values,e.endState),r.scale.z=i;break;case ArticulationModifierTypes.opacity:i=t._interpolateRelativeNumeric(ArticulationModifierTypes.opacity,a.values,e.endState),r.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{e.transparent=!0,e.opacity=i})):(e.material.transparent=!0,e.material.opacity=i))}));break;case ArticulationModifierTypes.colorOverlay:i=t._interpolateColor(a.values,e.endState),r.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{i.alpha>0?(e.color=i.color,e.opacity=i.alpha):(e.color=t.getDefaultVal(e.name,a.key)&&t.getDefaultVal(e.name,a.key).articulationVal.color,e.opacity=1)})):i.alpha>0?(e.material.color=i.color,e.material.opacity=i.alpha):(e.material.color=t.getDefaultVal(e.name,a.key)&&t.getDefaultVal(e.name,a.key).articulationVal.color,e.material.opacity=1))}));break;case ArticulationModifierTypes.colorReplace:i=t._interpolateColor(a.values,e.endState),r.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{i.alpha>0?(e.map=null,e.color=i.color,e.opacity=i.alpha):(e.map=t.getDefaultVal(e.name,a.key)&&t.getDefaultVal(e.name,a.key).articulationVal.map,e.color=t.getDefaultVal(e.name,a.key)&&t.getDefaultVal(e.name,a.key).articulationVal.color,e.opacity=1),e.needsUpdate=!0})):(i.alpha>0?(e.material.map=null,e.material.color=i.color,e.material.opacity=i.alpha):(e.material.map=t.getDefaultVal(e.name,a.key)&&t.getDefaultVal(e.name,a.key).articulationVal.map,e.material.color=t.getDefaultVal(e.name,a.key)&&t.getDefaultVal(e.name,a.key).articulationVal.color,e.material.opacity=1),e.material.needsUpdate=!0))}));break;case ArticulationModifierTypes.stroke:i=t._interpolateColor(a.values,e.endState),_context.effectStore.initOutlinePass(r,!0,i)}}}))},this._setStartAnimation=e=>{s[e]==parseInt(h)&&this.articulationAnimations.filter((t=>t.startTime==s[e])).forEach((e=>{a||(a=_context.defaultObjectTree.getItemByName(e.modelId));let t=a&&a.articulations.find((t=>t._name==e.articulationName));if(t)for(let r of t.properties){let n=[];for(let e of r.nodes)a.getGroup().getObjectByName(e)&&n.push(a.getGroup().getObjectByName(e));let i=0;_context.effectStore.initOutlinePass();for(let a of r.modifiers)for(let r of n)switch(a.key){case ArticulationModifierTypes.rotationX:i=t._interpolateRelativeNumeric(ArticulationModifierTypes.rotationX,a.values,e.startState),r.rotation.x=i/180*Math.PI;break;case ArticulationModifierTypes.rotationY:i=t._interpolateRelativeNumeric(ArticulationModifierTypes.rotationY,a.values,e.startState),r.rotation.y=i/180*Math.PI;break;case ArticulationModifierTypes.rotationZ:i=t._interpolateRelativeNumeric(ArticulationModifierTypes.rotationZ,a.values,e.startState),r.rotation.z=i/180*Math.PI;break;case ArticulationModifierTypes.translationX:i=t._interpolateAbsoluteNumeric(a.values,e.startState),r.position.x=i;break;case ArticulationModifierTypes.translationY:i=t._interpolateAbsoluteNumeric(a.values,e.startState),r.position.y=i;break;case ArticulationModifierTypes.translationZ:i=t._interpolateAbsoluteNumeric(a.values,e.startState),r.position.z=i;break;case ArticulationModifierTypes.scaleX:i=t._interpolateAbsoluteNumeric(a.values,e.startState),r.scale.x=i;break;case ArticulationModifierTypes.scaleY:i=t._interpolateAbsoluteNumeric(a.values,e.startState),r.scale.y=i;break;case ArticulationModifierTypes.scaleZ:i=t._interpolateAbsoluteNumeric(a.values,e.startState),r.scale.z=i;break;case ArticulationModifierTypes.opacity:r.traverse((r=>{"Mesh"==r.type&&(r.material instanceof Array?r.material.forEach((r=>{r.transparent=!0,i=t._interpolateRelativeNumeric(ArticulationModifierTypes.opacity,a.values,e.startState),r.opacity=i})):(r.material.transparent=!0,i=t._interpolateRelativeNumeric(ArticulationModifierTypes.opacity,a.values,e.startState),r.material.opacity=i))}));break;case ArticulationModifierTypes.colorOverlay:i=t._interpolateColor(a.values,e.startState),r.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{i.alpha>0?(e.transparent=!0,e.color=i.color,e.opacity=i.alpha):(e.color=t.getDefaultVal(e.name,a.key)&&t.getDefaultVal(e.name,a.key).articulationVal.color,e.opacity=1)})):i.alpha>0?(e.material.transparent=!0,e.material.color=i.color,e.material.opacity=i.alpha):(e.material.color=t.getDefaultVal(e.name,a.key)&&t.getDefaultVal(e.name,a.key).articulationVal.color,e.material.opacity=1))}));break;case ArticulationModifierTypes.colorReplace:i=t._interpolateColor(a.values,e.startState),r.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{i.alpha>0?(e.map=null,e.transparent=!0,e.color=i.color,e.opacity=i.alpha):(e.map=t.getDefaultVal(e.name,a.key)&&t.getDefaultVal(e.name,a.key).articulationVal.map,e.color=t.getDefaultVal(e.name,a.key)&&t.getDefaultVal(e.name,a.key).articulationVal.color,e.opacity=1)})):i.alpha>0?(e.material.map=null,e.material.transparent=!0,e.material.color=i.color,e.material.opacity=i.alpha):(e.material.map=t.getDefaultVal(e.name,a.key)&&t.getDefaultVal(e.name,a.key).articulationVal.map,e.material.color=t.getDefaultVal(e.name,a.key)&&t.getDefaultVal(e.name,a.key).articulationVal.color,e.material.opacity=1))}));break;case ArticulationModifierTypes.stroke:i=t._interpolateColor(a.values,e.startState);let n=d.find((t=>t.startTime==e.startTime&&t.articulationName===r.name&&t.articulationProperty===a.key));n&&(n.articulationVal.tempColor.color=i.color.clone(),n.articulationVal.tempColor.alpha=i.alpha),_context.effectStore.initOutlinePass(r,!0,i)}}}))},this.render=e=>{if(this.articulationAnimations&&!(this.articulationAnimations.length<=0)&&(h+=e,this.articulationAnimations.forEach((e=>{f=l.findIndex((t=>t==e.startTime+e.continueTime)),h>=(e.startTime+e.continueTime)/r&&p==f&&this._setEndAnimation(f)})),this.articulationAnimations.forEach((t=>{if(t.startTime/r<=h&&h<=(t.startTime+t.continueTime)/r){f=l.findIndex((e=>h<e/r)),f>=0&&p!=f&&(u?(this._setStartAnimation(f+1),this._setEndAnimation(f)):(f>0&&this._setEndAnimation(f-1),this._setStartAnimation(f)),p=f),a||(a=_context.defaultObjectTree.getItemByName(t.modelId));let n=a&&a.articulations.find((e=>e._name==t.articulationName));if(n){let r=0;for(let i of n.properties){let o=[];for(let e of i.nodes){let t=a.getGroup().getObjectByName(e);t&&o.push(t)}_context.effectStore.initOutlinePass();for(let a of i.modifiers)for(let i of o)switch([ArticulationModifierTypes.opacity,ArticulationModifierTypes.stroke,ArticulationModifierTypes.colorOverlay,ArticulationModifierTypes.colorReplace].includes(a.key)||(r=d.find((e=>e.startTime==t.startTime&&e.articulationName===i.name&&e.articulationProperty===a.key)).articulationDiff),a.key){case ArticulationModifierTypes.rotationX:u?i.rotation.x-=r/180*Math.PI*e:i.rotation.x+=r/180*Math.PI*e;break;case ArticulationModifierTypes.rotationY:u?i.rotation.y-=r/180*Math.PI*e:i.rotation.y+=r/180*Math.PI*e;break;case ArticulationModifierTypes.rotationZ:u?i.rotation.z-=r/180*Math.PI*e:i.rotation.z+=r/180*Math.PI*e;break;case ArticulationModifierTypes.translationX:u?i.position.x-=r*e:i.position.x+=r*e;break;case ArticulationModifierTypes.translationY:u?i.position.y-=r*e:i.position.y+=r*e;break;case ArticulationModifierTypes.translationZ:u?i.position.z-=r*e:i.position.z+=r*e;break;case ArticulationModifierTypes.scaleX:u?i.scale.x-=r*e:i.scale.x+=r*e;break;case ArticulationModifierTypes.scaleY:u?i.scale.y-=r*e:i.scale.y+=r*e;break;case ArticulationModifierTypes.scaleZ:u?i.scale.z-=r*e:i.scale.z+=r*e;break;case ArticulationModifierTypes.opacity:i.traverse((i=>{"Mesh"==i.type&&(i.material instanceof Array?i.material.forEach((i=>{r=d.find((e=>e.startTime==t.startTime&&e.articulationName.split(":")[1]===i.name&&e.articulationProperty===a.key)).articulationDiff,i.transparent=!0,u?i.opacity-=r*e:i.opacity+=r*e,i.opacity=n._checkOpacity(i.opacity)})):(r=d.find((e=>e.startTime==t.startTime&&e.articulationName.split(":")[1]===i.name&&e.articulationProperty===a.key)).articulationDiff,i.material.transparent=!0,u?i.material.opacity-=r*e:i.material.opacity+=r*e,i.material.opacity=n._checkOpacity(i.material.opacity)))}));break;case ArticulationModifierTypes.colorOverlay:i.traverse((i=>{if("Mesh"==i.type){let o;i.material instanceof Array?i.material.forEach((i=>{r=d.find((e=>e.startTime==t.startTime&&e.articulationName.split(":")[1]===i.name&&e.articulationProperty===a.key)).articulationDiff,o=u?new RGBAColor(i.color.r-r.color.r*e,i.color.g-r.color.g*e,i.color.b-r.color.b*e,i.opacity-r.alpha*e):new RGBAColor(i.color.r+r.color.r*e,i.color.g+r.color.g*e,i.color.b+r.color.b*e,i.opacity+r.alpha*e),o.alpha>0?(i.color=n._checkColor(o.color),i.opacity=n._checkOpacity(o.alpha)):(i.opacity=1,i.color=n.getDefaultVal(i.name,a.key)&&n.getDefaultVal(i.name,a.key).articulationVal.color)})):(r=d.find((e=>e.startTime==t.startTime&&e.articulationName.split(":")[1]===i.name&&e.articulationProperty===a.key)).articulationDiff,o=u?new RGBAColor(i.material.color.r-r.color.r*e,i.material.color.g-r.color.g*e,i.material.color.b-r.color.b*e,i.material.opacity-r.alpha*e):new RGBAColor(i.material.color.r+r.color.r*e,i.material.color.g+r.color.g*e,i.material.color.b+r.color.b*e,i.material.opacity+r.alpha*e),o.alpha>0?(i.material.color=n._checkColor(o.color),i.material.opacity=n._checkColor(o.alpha)):(i.material.opacity=1,i.material.color=n.getDefaultVal(i.name,a.key)&&n.getDefaultVal(i.name,a.key).articulationVal.color))}}));break;case ArticulationModifierTypes.colorReplace:i.traverse((i=>{if("Mesh"==i.type){let o;i.material instanceof Array?i.material.forEach((i=>{r=d.find((e=>e.startTime==t.startTime&&e.articulationName.split(":")[1]===i.name&&e.articulationProperty===a.key)).articulationDiff,o=u?new RGBAColor(i.color.r-r.color.r*e,i.color.g-r.color.g*e,i.color.b-r.color.b*e,i.opacity-r.alpha*e):new RGBAColor(i.color.r+r.color.r*e,i.color.g+r.color.g*e,i.color.b+r.color.b*e,i.opacity+r.alpha*e),o.alpha>0?(i.map=null,i.color=n._checkColor(o.color),i.opacity=n._checkOpacity(o.alpha)):(i.opacity=1,i.color=n.getDefaultVal(i.name,a.key)&&n.getDefaultVal(i.name,a.key).articulationVal.color,i.map=n.getDefaultVal(i.name,a.key)&&n.getDefaultVal(i.name,a.key).articulationVal.map),i.needsUpdate=!0})):(r=d.find((e=>e.startTime==t.startTime&&e.articulationName.split(":")[1]===i.name&&e.articulationProperty===a.key)).articulationDiff,o=u?new RGBAColor(i.material.color.r-r.color.r*e,i.material.color.g-r.color.g*e,i.material.color.b-r.color.b*e,i.material.opacity-r.alpha*e):new RGBAColor(i.material.color.r+r.color.r*e,i.material.color.g+r.color.g*e,i.material.color.b+r.color.b*e,i.material.opacity+r.alpha*e),o.alpha>0?(i.material.map=null,i.material.color=n._checkColor(o.color),i.material.opacity=n._checkOpacity(o.alpha)):(i.material.opacity=1,i.material.color=n.getDefaultVal(i.name,a.key)&&n.getDefaultVal(i.name,a.key).articulationVal.color,i.material.map=n.getDefaultVal(i.name,a.key)&&n.getDefaultVal(i.name,a.key).articulationVal.map),i.material.needsUpdate=!0)}}));break;case ArticulationModifierTypes.stroke:let o,s=d.find((e=>e.startTime==t.startTime&&e.articulationName===i.name&&e.articulationProperty===a.key));u?(s.articulationVal.tempColor.color.r-=s.articulationDiff.color.r*e,s.articulationVal.tempColor.color.g-=s.articulationDiff.color.g*e,s.articulationVal.tempColor.color.b-=s.articulationDiff.color.b*e,s.articulationVal.tempColor.alpha-=s.articulationDiff.alpha*e):(s.articulationVal.tempColor.color.r+=s.articulationDiff.color.r*e,s.articulationVal.tempColor.color.g+=s.articulationDiff.color.g*e,s.articulationVal.tempColor.color.b+=s.articulationDiff.color.b*e,s.articulationVal.tempColor.alpha+=s.articulationDiff.alpha*e),o=new RGBAColor(s.articulationVal.tempColor.color.r,s.articulationVal.tempColor.color.g,s.articulationVal.tempColor.color.b,s.articulationVal.tempColor.alpha),s.articulationVal.tempColor.color=n._checkColor(o.color),s.articulationVal.tempColor.alpha=n._checkOpacity(o.alpha),_context.effectStore.initOutlinePass(i,!0,new RGBAColor(s.articulationVal.tempColor.color.r,s.articulationVal.tempColor.color.g,s.articulationVal.tempColor.color.b,s.articulationVal.tempColor.alpha))}}}}})),i&&i({progress:h/c}),h>c||1==u))switch(h>c&&this._setEndAnimation(l.length-1),this.animationType){case AnimationTypes.NONE:h=0;let t=_context.animationStore.findAnimation(this.animationName,ArticulationAnimationGroupController.type);t&&_context.animationStore.remove(t),p=-1;break;case AnimationTypes.ROUND:h=0,this._initAnimation();break;case AnimationTypes.REPEAT:u=!0,h-=2*e,h<=0&&(h=0,u=!1,this._initAnimation())}},this.reset=()=>{this._initAnimation()}}}ArticulationAnimationGroupController.type="ArticulationAnimationGroupController";var BaseCarrierController=function(e){var t={};this.update=function(r){for(var n in t){var i=t[n];if(i.userData.currentTime<i.userData.duration&&i.userData.duration>0){i.userData.currentTime+=r;var a=i.userData.currentTime/i.userData.duration,o={x:i.userData.startPos.x+(i.userData.targetPos.x-i.userData.startPos.x)*a,y:i.userData.startPos.y+(i.userData.targetPos.y-i.userData.startPos.y)*a,z:i.userData.startPos.z+(i.userData.targetPos.z-i.userData.startPos.z)*a};i.position.set(o.x,o.y,o.z)}else i.position.set(i.userData.targetPos.x,i.userData.targetPos.y,i.userData.targetPos.z);e&&e(t)}},this.add=function(e,r){t[e]=r},this.remove=function(e){delete t[e]},this.dispose=function(){}};class ClippingController{constructor({meshes:e=[],clippingPlanes:t=[]}){_context.renderer.localClippingEnabled=!0;let r=[],n=[];if(e instanceof Array||!(meshs.length>0)){for(let t of e)t instanceof Mesh&&r.push(t),t.traverse((e=>{e instanceof Mesh&&r.push(e)}));for(let e of t)"number"==typeof e.nx&&"number"==typeof e.ny&&"number"==typeof e.nz&&"number"==typeof e.d?n.push(new Plane(new Vector3(e.nx,e.ny,e.nz),e.d)):logger.warn("剪裁面参数错误。");for(let e of r)if(e.material instanceof Array)for(const t of e.material)t.clippingPlanes=n,t.clipShadows=!0;else e.material&&(e.material.clippingPlanes=n,e.material.clipShadows=!0);this.clear=()=>{for(let e of r)if(e.material instanceof Array)for(const t of e.material)t.clippingPlanes=null,t.clipShadows=null;else e.material&&(e.material.clippingPlanes=null,e.material.clipShadows=null);r=null,n=null},this.pointClipTest=e=>{let t=!0;return n.forEach((r=>{t=t&&r.distanceToPoint(e)<0})),t}}}get type(){return"ClippingController"}set enabled(e){_context.renderer.localClippingEnabled=e}}class DistanceController extends AnimationController{constructor(e,t,r){super("DistanceController"),this.camera=e,this.object=t,this.object0=t,this.name=r,this.render=()=>{var e=this.camera.position.clone();if(null!=this.object)if(this.object.enableAutoHidebyDistance){if(null!=this.object.distance&&this.object.distance)var t=this.object.distance.distanceTo(e);else t=this.object.position.distanceTo(e);if(t>=this.object.minDistance&&t<=this.object.maxDistance){if(!this.object)return;this.object.visible=this.object.activeVisible&&!0}else{if(!this.object)return;this.object.visible=!1}}else this.object.visible=this.object.activeVisible},this.reset=()=>{this.object=this.object0}}}DistanceController.type="DistanceController";class FireflyAnimationController extends AnimationController{constructor(e){super("FireflyAnimationController"),this.animationObject=e,this.value=this.animationObject.uniforms.time.value,this.render=e=>{this.animationObject.uniforms.time.value+=e},this.reset=()=>{this.animationObject.uniforms.time.value=this.value}}}FireflyAnimationController.type="FireflyAnimationController";class FireworksAnimationController extends AnimationController{constructor(e,t){super("FireworksAnimationController"),this.firworksArr=e,this.option=t,this.name=t.name,this.reDraw=function(e){let t=this.option.centerPos.x+Number(this.option.offset.x)+2*this.option.range*Math.random()-this.option.range,r=Number(this.option.offset.y)+this.option.bottomHeight+(this.option.topHeight-this.option.bottomHeight)*Math.random(),n=this.option.centerPos.z+Number(this.option.offset.z)+2*this.option.range*Math.random()-this.option.range;for(var i of(e.pos.x=t,e.pos.y=r,e.pos.z=n,e.speed=this.option.speed+this.option.speedR*Math.random(),e.lifetime=this.option.lifetime+this.option.lifetimeR*Math.random(),e.leaveTime=e.lifetime,e.currentTime=0,e.color=16777215*Math.random(),e.children))i.position.set(e.pos.x,e.pos.y,e.pos.z),i.dir=new Vector3(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1).normalize(),i.material.opacity=1},this.operationFireWork=function(e,t){for(var r of e.children)r.position.set(r.position.x+r.dir.x*e.speed*t,r.position.y+r.dir.y*e.speed*t,r.position.z+r.dir.z*e.speed*t),.1*e.lifetime>e.leaveTime&&(r.material.opacity=e.leaveTime/(10*e.lifetime));e.leaveTime-=t,e.currentTime+=t},this.render=e=>{for(var t of this.firworksArr.children)t.leaveTime<=0?this.reDraw(t):this.operationFireWork(t,e)},this.reset=()=>{}}}FireworksAnimationController.type="FireworksAnimationController";class InstancedBubbleAnimationController extends AnimationController{constructor(e,t,r,n,i,a,o=!1,s){super("InstancedBubbleAnimationController"),this.instancedMesh=e,this.instanceId=t,this.startScale=r,this.endScale=n,this.startDisappearScale=i,this.diffusionSpeed=a,this.yScale=o,this.camera=s,this.dummy=new Object3D,this.dummy.matrixAutoUpdate=!1,this.instancedMesh.getMatrixAt(t,this.dummy.matrix),this.matrix0=this.dummy.matrix.clone(),this.dummy.matrix.decompose(this.dummy.position,this.dummy.quaternion,this.dummy.scale),this.render=e=>{if(this.instancedMesh instanceof InstancedMesh){if(void 0===e){var t=this.endScale/100;this.dummy.scale.x+=this.diffusionSpeed*t,this.dummy.scale.z+=this.diffusionSpeed*t,this.yScale&&(this.dummy.scale.y+=this.diffusionSpeed*t)}else this.dummy.scale.x+=this.diffusionSpeed*e,this.dummy.scale.z+=this.diffusionSpeed*e,this.yScale&&(this.dummy.scale.y+=this.diffusionSpeed*e);if(this.diffusionSpeed>=0?this.dummy.scale.x>this.endScale&&(this.dummy.scale.x=this.startScale,this.dummy.scale.z=this.startScale,this.yScale&&(this.dummy.scale.y=this.startScale)):this.dummy.scale.x<this.endScale&&(this.dummy.scale.x=this.startScale,this.dummy.scale.z=this.startScale,this.yScale&&(this.dummy.scale.y=this.startScale)),this.instancedMesh.hideByDistance[this.instanceId]){let e=this.camera.position.clone(),t=new Matrix4,n=new Vector3;this.instancedMesh.getMatrixAt(this.instanceId,t),n.setFromMatrixPosition(t);var r=n.distanceTo(e);(r<this.instancedMesh.minDistances[this.instanceId]||r>this.instancedMesh.maxDistances[this.instanceId]||!this.instancedMesh.activeVisible[this.instanceId])&&(this.dummy.scale.x=0,this.dummy.scale.y=0,this.dummy.scale.z=0)}this.instancedMesh.visible[this.instanceId]||(this.dummy.scale.x=0,this.dummy.scale.y=0,this.dummy.scale.z=0),this.dummy.updateMatrix(),this.instancedMesh.setMatrixAt(this.instanceId,this.dummy.matrix),this.instancedMesh.instanceMatrix.needsUpdate=!0}},this.reset=()=>{this.dummy.scale.set(this.scaleX0,this.scaleY0,this.scaleZ0),this.instanceMatrix.scale(this.dummy.scale.x,this.dummy.scale.y,this.dummy.scale.z),this.instancedMesh.setMatrixAt(this.instanceId,this.instanceMatrix),this.instancedMesh.instanceMatrix.needsUpdate=!0}}}InstancedBubbleAnimationController.type="InstancedBubbleAnimationController";class ModelTransformAnimationController extends AnimationController{constructor(e,t){if(super("ModelTransformAnimationController"),this.animationObject=e,this.params=t,this.position=t.position,this.rotation=t.rotation,this.scale=t.scale,this.duration=t.duration,this.diffPostion={x:0,y:0,z:0},t.isChangeCoordX&&(this.diffPostion.x=(this.position.x-this.animationObject.position.x)/this.duration),t.isChangeCoordY&&(this.diffPostion.y=(this.position.y-this.animationObject.position.y)/this.duration),t.isChangeCoordZ&&(this.diffPostion.z=(this.position.z-this.animationObject.position.z)/this.duration),this.diffRoation={x:0,y:0,z:0},t.isChangeRotationX){let e=this.rotation.x-MathUtils.radToDeg(this.animationObject.rotation.x),t=Math.abs(e);t>180?(this.rotation.x=MathUtils.degToRad(this.rotation.x),this.diffRoation.x=MathUtils.degToRad(360-t)/this.duration,e>0&&(this.diffRoation.x=-this.diffRoation.x)):(this.rotation.x=MathUtils.degToRad(this.rotation.x),this.diffRoation.x=(this.rotation.x-this.animationObject.rotation.x)/this.duration)}if(t.isChangeRotationY){let e=this.rotation.y-MathUtils.radToDeg(this.animationObject.rotation.y),t=Math.abs(e);t>180?(this.rotation.y=MathUtils.degToRad(this.rotation.y),this.diffRoation.y=MathUtils.degToRad(360-t)/this.duration,e>0&&(this.diffRoation.y=-this.diffRoation.y)):(this.rotation.y=MathUtils.degToRad(this.rotation.y),this.diffRoation.y=(this.rotation.y-this.animationObject.rotation.y)/this.duration)}if(t.isChangeRotationZ){let e=this.rotation.z-MathUtils.radToDeg(this.animationObject.rotation.z),t=Math.abs(e);t>180?(this.rotation.z=MathUtils.degToRad(this.rotation.z),this.diffRoation.z=MathUtils.degToRad(360-t)/this.duration,e>0&&(this.diffRoation.z=-this.diffRoation.z)):(this.rotation.z=MathUtils.degToRad(this.rotation.z),this.diffRoation.z=(this.rotation.z-this.animationObject.rotation.z)/this.duration)}this.diffScale={x:1,y:1,z:1},t.isChangeScaleX&&(this.diffScale.x=(this.scale.x-this.animationObject.scale.x)/this.duration),t.isChangeScaleY&&(this.diffScale.y=(this.scale.y-this.animationObject.scale.y)/this.duration),t.isChangeScaleZ&&(this.diffScale.z=(this.scale.z-this.animationObject.scale.z)/this.duration),this.animationDurationTime=0}render(e){if(this.params.isChangeCoordX&&(this.animationObject.position.x+=this.diffPostion.x*e,_context.eventHandlerStore.cameraMove()),this.params.isChangeCoordY&&(this.animationObject.position.y+=this.diffPostion.y*e,_context.eventHandlerStore.cameraMove()),this.params.isChangeCoordZ&&(this.animationObject.position.z+=this.diffPostion.z*e,_context.eventHandlerStore.cameraMove()),this.params.isChangeRotationX&&(this.animationObject.rotation.x+=this.diffRoation.x*e),this.params.isChangeRotationY&&(this.animationObject.rotation.y+=this.diffRoation.y*e),this.params.isChangeRotationZ&&(this.animationObject.rotation.z+=this.diffRoation.z*e),this.params.isChangeScaleX&&(this.animationObject.scale.x+=this.diffScale.x*e),this.params.isChangeScaleY&&(this.animationObject.scale.y+=this.diffScale.y*e),this.params.isChangeScaleZ&&(this.animationObject.scale.z+=this.diffScale.z*e),this.animationDurationTime+=e,this.animationDurationTime>this.duration){this.params.isChangeCoordX&&(this.animationObject.position.x=this.position.x,_context.eventHandlerStore.cameraMove()),this.params.isChangeCoordY&&(this.animationObject.position.y=this.position.y,_context.eventHandlerStore.cameraMove()),this.params.isChangeCoordZ&&(this.animationObject.position.z=this.position.z,_context.eventHandlerStore.cameraMove()),this.params.isChangeRotationX&&(this.animationObject.rotation.x=this.rotation.x),this.params.isChangeRotationY&&(this.animationObject.rotation.y=this.rotation.y),this.params.isChangeRotationZ&&(this.animationObject.rotation.z=this.rotation.z),this.params.isChangeScaleX&&(this.animationObject.scale.x=this.scale.x),this.params.isChangeScaleY&&(this.animationObject.scale.y=this.scale.y),this.params.isChangeScaleZ&&(this.animationObject.scale.z=this.scale.z);let e=_context.animationStore.findNodeAnimation(this.animationObject,ModelTransformAnimationController.type);e&&_context.animationStore.remove(e)}}}ModelTransformAnimationController.type="ModelTransformAnimationController";class NodeBlinkingAnimationController extends AnimationController{constructor(e,t=1,r="",n="default"){super("NodeBlinkingAnimationController"),this.animationObject=e,this.targetColor=new Color(1,1,1),this.defaultColors={},this.animationObject.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((t=>{t.transparent=!0,this.defaultColors[e.name+t.name]=t.color.clone()})):(e.material.transparent=!0,this.defaultColors[e.name]=e.material.color.clone()))})),this.animationObject.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{e.color=this.targetColor})):e.material.color=this.targetColor)})),this.blinkingColor=new Color(r),this.r=(this.targetColor.r-this.blinkingColor.r)/t,this.g=(this.targetColor.g-this.blinkingColor.g)/t,this.b=(this.targetColor.b-this.blinkingColor.b)/t,this.currentColor=this.targetColor,this.render=e=>{null!=this.animationObject&&(this.currentColor=0==t?this.blinkingColor:this._changeColor(this.currentColor,e),this.animationObject.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{e.color=this.currentColor})):e.material.color=this.currentColor)})))},this.reset=()=>{this.animationObject.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((t=>{t.transparent=!1,t.color=this.defaultColors[e.name+t.name]})):(e.material.transparent=!1,e.material.color=this.defaultColors[e.name]))}))},this._changeColor=(e,t)=>(e.r+=this.r*t,e.r>=1&&(e.r=this.blinkingColor.r),e.g+=this.g*t,e.g>=1&&(e.g=this.blinkingColor.g),e.b+=this.b*t,e.b>=1&&(e.b=this.blinkingColor.b),e)}}NodeBlinkingAnimationController.type="NodeBlinkingAnimationController";class NodeBreatheAnimationController extends AnimationController{constructor(e,t,r,n=!1){super("NodeBreatheAnimationController"),this.animationObject=e,this.endBreathe=t,this.diffusionSpeed=r,this.yScale=n,this.scaleX0=this.animationObject.scale.x,this.scaleY0=this.animationObject.scale.y,this.scaleZ0=this.animationObject.scale.z,this.isScale=!0,this.render=e=>{if(null!=this.animationObject)if(this.animationObject.scale.x<this.endBreathe&&!0===this.isScale)if(void 0===e){var t=this.endBreathe/100;this.animationObject.scale.x+=this.diffusionSpeed*t,this.animationObject.scale.z+=this.diffusionSpeed*t,this.yScale&&(this.animationObject.scale.y+=this.diffusionSpeed*t),this.animationObject.scale.x>=this.endBreathe&&(this.isScale=!1)}else this.animationObject.scale.x+=this.diffusionSpeed*e,this.animationObject.scale.z+=this.diffusionSpeed*e,this.yScale&&(this.animationObject.scale.y+=this.diffusionSpeed*e),this.animationObject.scale.x>=this.endBreathe&&(this.isScale=!1);else if(void 0===e){t=this.endBreathe/100;this.animationObject.scale.x-=this.diffusionSpeed*t,this.animationObject.scale.z-=this.diffusionSpeed*t,this.yScale&&(this.animationObject.scale.y-=this.diffusionSpeed*t),this.animationObject.scale.x<=1&&(this.isScale=!0)}else this.animationObject.scale.x-=this.diffusionSpeed*e,this.animationObject.scale.z-=this.diffusionSpeed*e,this.yScale&&(this.animationObject.scale.y-=this.diffusionSpeed*e),this.animationObject.scale.x<=1&&(this.isScale=!0)},this.reset=()=>{this.animationObject.scale.set(this.scaleX0,this.scaleY0,this.scaleZ0)}}}NodeBreatheAnimationController.type="NodeBreatheAnimationController";class NodeMovingAnimationController extends AnimationController{constructor(e,t="round",r=!1,n="path",i=[],a=[0,0,0],o="",s=""){super("NodeMovingAnimationController"),this.animationObject=e,this.loopMode=t,this.reverse=r,this.direction=n,this.points=i,this.offset=a,this.pathId=o,this.defaultPosition=this.animationObject.position.clone(),this.defaultRotation=this.animationObject.rotation.clone(),this.isReverse=!1,this.reverse&&(this.points=this.points.reverse()),this.times=[];let l=0;for(let e=1;e<this.points.length;e++){const t=this.points[e];t.speed=t.speed||0;const r=this.points[e-1];let n=new Vector3(t.x,t.y,t.z).distanceTo(new Vector3(r.x,r.y,r.z)),i=0;i=this.reverse?n/this.points[0].speed:n/t.speed,l+=i,this.times.push(l)}this.time=0,this.render=e=>{if(null!=this.animationObject){if(this.isReverse&&this.time<0&&(this.time=0,this.isReverse=!1),this.time>=0){if(this.time>=this.times[this.times.length-1])switch(this.loopMode){case"none":this.time=-1;break;case"round":this.time=this.times[this.times.length-1],this.time-=e,this.isReverse=!0;break;case"repeat":this.time=0,this.reset()}else this.isReverse?this.time-=e:this.time+=e;if(this.time>=0){for(let e=0;e<this.times.length;e++){if(this.times[e]>=this.time){this.currentIndex=e;break}}let e;e=this.isReverse?new Vector3(this.points[this.currentIndex+1].x,this.points[this.currentIndex+1].y,this.points[this.currentIndex+1].z):new Vector3(this.points[this.currentIndex].x,this.points[this.currentIndex].y,this.points[this.currentIndex].z);let t,r=0;if(r=0==this.currentIndex?this.time/this.times[this.currentIndex]:(this.time-this.times[this.currentIndex-1])/(this.times[this.currentIndex]-this.times[this.currentIndex-1]),this.isReverse&&(r=1-r),t=this.isReverse?this.currentIndex>0?e.lerp(new Vector3(this.points[this.currentIndex].x,this.points[this.currentIndex].y,this.points[this.currentIndex].z),r):e.lerp(new Vector3(this.points[0].x,this.points[0].y,this.points[0].z),r):e.lerp(new Vector3(this.points[this.currentIndex+1].x,this.points[this.currentIndex+1].y,this.points[this.currentIndex+1].z),r),"path"==this.direction){let t=new Vector3(this.animationObject.rotation.x,this.animationObject.rotation.y,this.animationObject.rotation.z).angleTo(e);this.isReverse?this.animationObject.rotation.y=this.reverse?t:-t:this.animationObject.rotation.y=this.reverse?-t:t}this.offset?(this.animationObject.position.x=t.x+this.offset[0],this.animationObject.position.y=t.y+this.offset[1],this.animationObject.position.z=t.z+this.offset[2]):(this.animationObject.position.x=t.x,this.animationObject.position.y=t.y,this.animationObject.position.z=t.z),s instanceof Function&&s({id:this.pathId,pass:this.currentIndex,ratio:this.isReverse?1-r:r})}}_context.eventHandlerStore.cameraMove()}},this.reset=()=>{this.animationObject.position.x=this.defaultPosition.x,this.animationObject.position.y=this.defaultPosition.y,this.animationObject.position.z=this.defaultPosition.z,this.animationObject.rotation.x=this.defaultRotation.x,this.animationObject.rotation.y=this.defaultRotation.y,this.animationObject.rotation.z=this.defaultRotation.z}}}NodeMovingAnimationController.type="NodeMovingAnimationController";class NodeRotationAnimationController extends AnimationController{constructor(e,t,r,n,i,a,o){super("NodeRotationAnimationController"),this.animationObject=e,this.isX=t,this.isY=r,this.isZ=n,this.xSpeed=i,this.ySpeed=a,this.zSpeed=o,this.rotationX0=this.animationObject.rotation.x,this.rotationY0=this.animationObject.rotation.y,this.rotationZ0=this.animationObject.rotation.z,this.render=e=>{null!=this.animationObject&&(this.isX&&(this.animationObject.rotation.x+=this.xSpeed*e*20/Math.PI),this.isY&&(this.animationObject.rotation.y+=this.ySpeed*e*20/Math.PI),this.isZ&&(this.animationObject.rotation.z+=this.zSpeed*e*20/Math.PI))},this.reset=()=>{this.animationObject.rotation.x=this.rotationX0,this.animationObject.rotation.y=this.rotationY0,this.animationObject.rotation.z=this.rotationZ0}}}NodeRotationAnimationController.type="NodeRotationAnimationController";class NodeScaleAnimationController extends AnimationController{constructor(e,t,r,n,i,a=!1){super("NodeScaleAnimationController"),this.animationObject=e,this.startScale=t,this.endScale=r,this.startDisappearScale=n,this.diffusionSpeed=i,this.yScale=a,this.scaleX0=this.animationObject.scale.x,this.scaleY0=this.animationObject.scale.y,this.scaleZ0=this.animationObject.scale.z,e.material?this.opacity=e.material.opacity||1:this.opacity=1,this.render=e=>{if(null!=this.animationObject){if(void 0===e){var t=this.endScale/100;this.animationObject.scale.x+=this.diffusionSpeed*t,this.animationObject.scale.z+=this.diffusionSpeed*t,this.yScale&&(this.animationObject.scale.y+=this.diffusionSpeed*t)}else this.animationObject.scale.x+=this.diffusionSpeed*e,this.animationObject.scale.z+=this.diffusionSpeed*e,this.yScale&&(this.animationObject.scale.y+=this.diffusionSpeed*e);if(this.diffusionSpeed>=0){if(this.animationObject.scale.x>this.endScale)if(this.animationObject.scale.x=this.startScale,this.animationObject.scale.z=this.startScale,this.yScale&&(this.animationObject.scale.y=this.startScale),this.animationObject.material)this.animationObject.material.opacity=this.opacity;else if(this.animationObject.children.length>0){var r=this;this.animationObject.traverse((function(e){e.material&&(e.material.opacity=r.opacity)}))}if(this.animationObject.scale.x>this.startDisappearScale){var n=(1-(this.animationObject.scale.x-this.startDisappearScale)/(this.endScale-this.startDisappearScale))*this.opacity;this.animationObject.material?(this.animationObject.material.opacity=n,this.animationObject.material.transparent=!0):this.animationObject.children.length>0&&this.animationObject.traverse((function(e){e.material&&(e.material.opacity=n,e.material.transparent=!0)}))}}else{if(this.animationObject.scale.x<this.endScale)if(this.animationObject.scale.x=this.startScale,this.animationObject.scale.z=this.startScale,this.yScale&&(this.animationObject.scale.y=this.startScale),this.animationObject.material)this.animationObject.material.opacity=this.opacity;else if(this.animationObject.children.length>0){r=this;this.animationObject.traverse((function(e){e.material&&(e.material.opacity=r.opacity)}))}if(this.animationObject.scale.x<this.startDisappearScale){n=(1-(this.startDisappearScale-this.animationObject.scale.x)/(this.endScale-this.startDisappearScale))*this.opacity;this.animationObject.material?(this.animationObject.material.opacity=n,this.animationObject.material.transparent=!0):this.animationObject.children.length>0&&this.animationObject.traverse((function(e){e.material&&(e.material.opacity=n,e.material.transparent=!0)}))}}}},this.reset=()=>{this.animationObject.scale.set(this.scaleX0,this.scaleY0,this.scaleZ0),this.animationObject.material?this.animationObject.material.opacity=this.opacity:this.animationObject.children.length>0&&this.animationObject.traverse((e=>{e.material&&(e.material.opacity=this.opacity)}))}}}NodeScaleAnimationController.type="NodeScaleAnimationController";class ODLineRollingAnimationController extends AnimationController{constructor(e,t){super("ODLineRollingAnimationController"),this.animationObject=e,this.speed=t,this.value=this.animationObject.userData.mesh.material.uniforms.dashOffset.value,this.render=e=>{this.animationObject.userData.mesh.material.uniforms.dashOffset.value-=parseFloat(this.speed*e/10)},this.reset=()=>{this.animationObject.userData.mesh.material.uniforms.dashOffset.value=this.value}}}ODLineRollingAnimationController.type="ODLineRollingAnimationController";class RainAnimationController extends AnimationController{constructor(e,t){super("RainAnimationController"),this.animationObject=e,this.isFollowCamera=t,this.render=e=>{for(var t=0;t<this.animationObject.children.length;t++){var r=this.animationObject.children[t];r.position.y-=3*(1+.05*t),r.position.y<0&&(r.position.y=250)}if(this.isFollowCamera){let e=_context.camera.position.x,t=_context.camera.position.y,r=_context.camera.position.z;this.animationObject.position.set(e,t,r)}},this.reset=()=>{}}}RainAnimationController.type="RainAnimationController";class RainlineAnimationController extends AnimationController{constructor(e){super("RainlineAnimationController"),this.animationObject=e,this.value=this.animationObject.uniforms.time.value,this.render=e=>{this.animationObject.uniforms.time.value+=e},this.reset=()=>{this.animationObject.uniforms.time.value=this.value}}}RainlineAnimationController.type="RainlineAnimationController";class SmoothTransformController extends AnimationController{constructor(e,t,r=1){if(super("SmoothTransformController"),e.isObject3D)if(t&&(t.position||t.rotation||t.scale)){if(r<=0)return t.position instanceof Vector3&&this._node.position.set(t.position.x,t.position.y,t.position.z),t.rotation,t.scale instanceof Vector3&&this._node.scale.set(t.scale.x,t.scale.y,t.scale.z),e.getDirectionalLightHelper&&e.getDirectionalLightHelper().update(),void(this.needsRemove=!0);this._node=e,this._transform=t,this._duration=r,this._elapseTimeTotal=0,this._originalTransform={position:e.position.clone(),rotation:e.rotation.clone(),scale:e.scale.clone()},this._skipFrame=2,this._skipFrameCounter=0}else this.needsRemove=!0;else this.needsRemove=!0}render(e){if(!this._node)return void(this.needsRemove=!0);if(this._elapseTimeTotal+=e,this._skipFrameCounter<this._skipFrame)return void this._skipFrameCounter++;this._skipFrameCounter=0;let t=1*this._elapseTimeTotal/this._duration;return this._transform.position instanceof Vector3&&this._node.position.set(this._originalTransform.position.x+t*(this._transform.position.x-this._originalTransform.position.x),this._originalTransform.position.y+t*(this._transform.position.y-this._originalTransform.position.y),this._originalTransform.position.z+t*(this._transform.position.z-this._originalTransform.position.z)),this._transform.rotation,this._transform.scale instanceof Vector3&&this._node.scale.set(this._originalTransform.scale.x+t*(this._transform.scale.x-this._originalTransform.scale.x),this._originalTransform.scale.y+t*(this._transform.scale.y-this._originalTransform.scale.y),this._originalTransform.scale.z+t*(this._transform.scale.z-this._originalTransform.scale.z)),this._node.getDirectionalLightHelper&&this._node.getDirectionalLightHelper().update(),this._elapseTimeTotal>this._duration?(this._transform.position instanceof Vector3&&this._node.position.set(this._transform.position.x,this._transform.position.y,this._transform.position.z),this._transform.rotation,this._transform.scale instanceof Vector3&&this._node.scale.set(this._transform.scale.x,this._transform.scale.y,this._transform.scale.z),this._node.getDirectionalLightHelper&&this._node.getDirectionalLightHelper().update(),void(this.needsRemove=!0)):void 0}}SmoothTransformController.type="SmoothTransformController";class SnowAnimationController extends AnimationController{constructor(e,t){super("SnowAnimationController"),this.animationObject=e,this.isFollowCamera=t,this.render=e=>{for(var t=0;t<this.animationObject.children.length;t++){var r=this.animationObject.children[t];r.position.y-=1,r.position.y<0&&(r.position.y=250)}if(this.isFollowCamera){let e=_context.camera.position.x,t=_context.camera.position.y,r=_context.camera.position.z;this.animationObject.position.set(e,t,r)}},this.reset=()=>{}}}SnowAnimationController.type="SnowAnimationController";class TrailAnimationController extends AnimationController{constructor(e,t,r){super("TrailAnimationController"),this.baseCarrierController=e,this.trailCon=t,this.name=r,this.render=e=>{null==this.baseCarrierController&&null==this.trailCon||(this.baseCarrierController.update(e),this.trailCon.update(e))},this.dispose=()=>{this.baseCarrierController.dispose(),this.trailCon.dispose(),this.baseCarrierController=void 0,this.trailCon=void 0}}}TrailAnimationController.type="TrailAnimationController";var require$$0=getAugmentedNamespace(three_module),THREE_MeshLine$1=createCommonjsModule((function(e,t){(function(){var r=void 0!==commonjsRequire,n=this.THREE||r&&require$$0;if(!n)throw new Error("MeshLine requires three.js");function i(){n.BufferGeometry.call(this),this.type="MeshLine",this.positions=[],this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[],this.counters=[],this._points=[],this._geom=null,this.widthCallback=null,this.matrixWorld=new n.Matrix4,Object.defineProperties(this,{geometry:{enumerable:!0,get:function(){return this}},geom:{enumerable:!0,get:function(){return this._geom},set:function(e){this.setGeometry(e,this.widthCallback)}},points:{enumerable:!0,get:function(){return this._points},set:function(e){this.setPoints(e,this.widthCallback)}}})}function a(e,t){var r=new n.Matrix4,i=new n.Ray,a=new n.Sphere,o=new n.Vector3,s=this.geometry;if(a.copy(s.boundingSphere),a.applyMatrix4(this.matrixWorld),!1!==e.ray.intersectSphere(a,o)){r.getInverse(this.matrixWorld),i.copy(e.ray).applyMatrix4(r);var l=new n.Vector3,c=new n.Vector3,h=new n.Vector3,u=this instanceof n.LineSegments?2:1,d=s.index,p=s.attributes;if(null!==d)for(var f=d.array,m=p.position.array,g=p.width.array,y=0,v=f.length-1;y<v;y+=u){var b=f[y],_=f[y+1];l.fromArray(m,3*b),c.fromArray(m,3*_);var x=null!=g[Math.floor(y/3)]?g[Math.floor(y/3)]:1,w=e.params.Line.threshold+this.material.lineWidth*x/2,S=w*w;if(!(i.distanceSqToSegment(l,c,o,h)>S)){o.applyMatrix4(this.matrixWorld);var M=e.ray.origin.distanceTo(o);M<e.near||M>e.far||(t.push({distance:M,point:h.clone().applyMatrix4(this.matrixWorld),index:y,face:null,faceIndex:null,object:this}),y=v)}}}}function o(e,t,r,n,i){var a;if(e=e.subarray||e.slice?e:e.buffer,r=r.subarray||r.slice?r:r.buffer,e=t?e.subarray?e.subarray(t,i&&t+i):e.slice(t,i&&t+i):e,r.set)r.set(e,n);else for(a=0;a<e.length;a++)r[a+n]=e[a];return r}function s(e){n.ShaderMaterial.call(this,{uniforms:Object.assign({},n.UniformsLib.fog,{lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},color:{value:new n.Color(16777215)},opacity:{value:1},resolution:{value:new n.Vector2(1,1)},sizeAttenuation:{value:1},dashArray:{value:0},dashOffset:{value:0},dashRatio:{value:.5},useDash:{value:0},visibility:{value:1},alphaTest:{value:0},repeat:{value:new n.Vector2(1,1)}}),vertexShader:n.ShaderChunk.meshline_vert,fragmentShader:n.ShaderChunk.meshline_frag}),this.type="MeshLineMaterial",Object.defineProperties(this,{lineWidth:{enumerable:!0,get:function(){return this.uniforms.lineWidth.value},set:function(e){this.uniforms.lineWidth.value=e}},map:{enumerable:!0,get:function(){return this.uniforms.map.value},set:function(e){this.uniforms.map.value=e}},useMap:{enumerable:!0,get:function(){return this.uniforms.useMap.value},set:function(e){this.uniforms.useMap.value=e}},alphaMap:{enumerable:!0,get:function(){return this.uniforms.alphaMap.value},set:function(e){this.uniforms.alphaMap.value=e}},useAlphaMap:{enumerable:!0,get:function(){return this.uniforms.useAlphaMap.value},set:function(e){this.uniforms.useAlphaMap.value=e}},color:{enumerable:!0,get:function(){return this.uniforms.color.value},set:function(e){this.uniforms.color.value=e}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}},sizeAttenuation:{enumerable:!0,get:function(){return this.uniforms.sizeAttenuation.value},set:function(e){this.uniforms.sizeAttenuation.value=e}},dashArray:{enumerable:!0,get:function(){return this.uniforms.dashArray.value},set:function(e){this.uniforms.dashArray.value=e,this.useDash=0!==e?1:0}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},dashRatio:{enumerable:!0,get:function(){return this.uniforms.dashRatio.value},set:function(e){this.uniforms.dashRatio.value=e}},useDash:{enumerable:!0,get:function(){return this.uniforms.useDash.value},set:function(e){this.uniforms.useDash.value=e}},visibility:{enumerable:!0,get:function(){return this.uniforms.visibility.value},set:function(e){this.uniforms.visibility.value=e}},alphaTest:{enumerable:!0,get:function(){return this.uniforms.alphaTest.value},set:function(e){this.uniforms.alphaTest.value=e}},repeat:{enumerable:!0,get:function(){return this.uniforms.repeat.value},set:function(e){this.uniforms.repeat.value.copy(e)}}}),this.setValues(e)}i.prototype=Object.create(n.BufferGeometry.prototype),i.prototype.constructor=i,i.prototype.isMeshLine=!0,i.prototype.setMatrixWorld=function(e){this.matrixWorld=e},i.prototype.setGeometry=function(e,t){this._geometry=e,e instanceof n.Geometry?this.setPoints(e.vertices,t):e instanceof n.BufferGeometry?this.setPoints(e.getAttribute("position").array,t):this.setPoints(e,t)},i.prototype.setPoints=function(e,t){if(e instanceof Float32Array||e instanceof Array){if(this._points=e,this.widthCallback=t,this.positions=[],this.counters=[],e.length&&e[0]instanceof n.Vector3)for(var r=0;r<e.length;r++){var i=e[r],a=r/e.length;this.positions.push(i.x,i.y,i.z),this.positions.push(i.x,i.y,i.z),this.counters.push(a),this.counters.push(a)}else for(r=0;r<e.length;r+=3){a=r/e.length;this.positions.push(e[r],e[r+1],e[r+2]),this.positions.push(e[r],e[r+1],e[r+2]),this.counters.push(a),this.counters.push(a)}this.process()}else console.error("ERROR: The BufferArray of points is not instancied correctly.")},i.prototype.raycast=a,i.prototype.compareV3=function(e,t){var r=6*e,n=6*t;return this.positions[r]===this.positions[n]&&this.positions[r+1]===this.positions[n+1]&&this.positions[r+2]===this.positions[n+2]},i.prototype.copyV3=function(e){var t=6*e;return[this.positions[t],this.positions[t+1],this.positions[t+2]]},i.prototype.process=function(){var e,t,r=this.positions.length/6;this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[],t=this.compareV3(0,r-1)?this.copyV3(r-2):this.copyV3(0),this.previous.push(t[0],t[1],t[2]),this.previous.push(t[0],t[1],t[2]);for(var i=0;i<r;i++){if(this.side.push(1),this.side.push(-1),e=this.widthCallback?this.widthCallback(i/(r-1)):1,this.width.push(e),this.width.push(e),this.uvs.push(i/(r-1),0),this.uvs.push(i/(r-1),1),i<r-1){t=this.copyV3(i),this.previous.push(t[0],t[1],t[2]),this.previous.push(t[0],t[1],t[2]);var a=2*i;this.indices_array.push(a,a+1,a+2),this.indices_array.push(a+2,a+1,a+3)}i>0&&(t=this.copyV3(i),this.next.push(t[0],t[1],t[2]),this.next.push(t[0],t[1],t[2]))}t=this.compareV3(r-1,0)?this.copyV3(1):this.copyV3(r-1),this.next.push(t[0],t[1],t[2]),this.next.push(t[0],t[1],t[2]),this._attributes&&this._attributes.position.count===this.positions.length?(this._attributes.position.copyArray(new Float32Array(this.positions)),this._attributes.position.needsUpdate=!0,this._attributes.previous.copyArray(new Float32Array(this.previous)),this._attributes.previous.needsUpdate=!0,this._attributes.next.copyArray(new Float32Array(this.next)),this._attributes.next.needsUpdate=!0,this._attributes.side.copyArray(new Float32Array(this.side)),this._attributes.side.needsUpdate=!0,this._attributes.width.copyArray(new Float32Array(this.width)),this._attributes.width.needsUpdate=!0,this._attributes.uv.copyArray(new Float32Array(this.uvs)),this._attributes.uv.needsUpdate=!0,this._attributes.index.copyArray(new Uint16Array(this.indices_array)),this._attributes.index.needsUpdate=!0):this._attributes={position:new n.BufferAttribute(new Float32Array(this.positions),3),previous:new n.BufferAttribute(new Float32Array(this.previous),3),next:new n.BufferAttribute(new Float32Array(this.next),3),side:new n.BufferAttribute(new Float32Array(this.side),1),width:new n.BufferAttribute(new Float32Array(this.width),1),uv:new n.BufferAttribute(new Float32Array(this.uvs),2),index:new n.BufferAttribute(new Uint16Array(this.indices_array),1),counters:new n.BufferAttribute(new Float32Array(this.counters),1)},this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setIndex(this._attributes.index),this.computeBoundingSphere(),this.computeBoundingBox()},i.prototype.advance=function(e){var t=this._attributes.position.array,r=this._attributes.previous.array,n=this._attributes.next.array,i=t.length;o(t,0,r,0,i),o(t,6,t,0,i-6),t[i-6]=e.x,t[i-5]=e.y,t[i-4]=e.z,t[i-3]=e.x,t[i-2]=e.y,t[i-1]=e.z,o(t,6,n,0,i-6),n[i-6]=e.x,n[i-5]=e.y,n[i-4]=e.z,n[i-3]=e.x,n[i-2]=e.y,n[i-1]=e.z,this._attributes.position.needsUpdate=!0,this._attributes.previous.needsUpdate=!0,this._attributes.next.needsUpdate=!0},n.ShaderChunk.meshline_vert=["",n.ShaderChunk.logdepthbuf_pars_vertex,n.ShaderChunk.fog_pars_vertex,"","attribute vec3 previous;","attribute vec3 next;","attribute float side;","attribute float width;","attribute float counters;","","uniform vec2 resolution;","uniform float lineWidth;","uniform vec3 color;","uniform float opacity;","uniform float sizeAttenuation;","","varying vec2 vUV;","varying vec4 vColor;","varying float vCounters;","","vec2 fix( vec4 i, float aspect ) {","","    vec2 res = i.xy / i.w;","    res.x *= aspect;","\t vCounters = counters;","    return res;","","}","","void main() {","","    float aspect = resolution.x / resolution.y;","","    vColor = vec4( color, opacity );","    vUV = uv;","","    mat4 m = projectionMatrix * modelViewMatrix;","    vec4 finalPosition = m * vec4( position, 1.0 );","    vec4 prevPos = m * vec4( previous, 1.0 );","    vec4 nextPos = m * vec4( next, 1.0 );","","    vec2 currentP = fix( finalPosition, aspect );","    vec2 prevP = fix( prevPos, aspect );","    vec2 nextP = fix( nextPos, aspect );","","    float w = lineWidth * width;","","    vec2 dir;","    if( nextP == currentP ) dir = normalize( currentP - prevP );","    else if( prevP == currentP ) dir = normalize( nextP - currentP );","    else {","        vec2 dir1 = normalize( currentP - prevP );","        vec2 dir2 = normalize( nextP - currentP );","        dir = normalize( dir1 + dir2 );","","        vec2 perp = vec2( -dir1.y, dir1.x );","        vec2 miter = vec2( -dir.y, dir.x );","        //w = clamp( w / dot( miter, perp ), 0., 4. * lineWidth * width );","","    }","","    //vec2 normal = ( cross( vec3( dir, 0. ), vec3( 0., 0., 1. ) ) ).xy;","    vec4 normal = vec4( -dir.y, dir.x, 0., 1. );","    normal.xy *= .5 * w;","    normal *= projectionMatrix;","    if( sizeAttenuation == 0. ) {","        normal.xy *= finalPosition.w;","        normal.xy /= ( vec4( resolution, 0., 1. ) * projectionMatrix ).xy;","    }","","    finalPosition.xy += normal.xy * side;","","    gl_Position = finalPosition;","",n.ShaderChunk.logdepthbuf_vertex,n.ShaderChunk.fog_vertex&&"    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",n.ShaderChunk.fog_vertex,"}"].join("\n"),n.ShaderChunk.meshline_frag=["",n.ShaderChunk.fog_pars_fragment,n.ShaderChunk.logdepthbuf_pars_fragment,"","uniform sampler2D map;","uniform sampler2D alphaMap;","uniform float useMap;","uniform float useAlphaMap;","uniform float useDash;","uniform float dashArray;","uniform float dashOffset;","uniform float dashRatio;","uniform float visibility;","uniform float alphaTest;","uniform vec2 repeat;","","varying vec2 vUV;","varying vec4 vColor;","varying float vCounters;","","void main() {","",n.ShaderChunk.logdepthbuf_fragment,"","    vec4 c = vColor;","    if( useMap == 1. ) c *= texture2D( map, vUV * repeat );","    if( useAlphaMap == 1. ) c.a *= texture2D( alphaMap, vUV * repeat ).a;","    if( c.a < alphaTest ) discard;","    if( useDash == 1. ){","        c.a *= ceil(mod(vCounters + dashOffset, dashArray) - (dashArray * dashRatio));","    }","    gl_FragColor = c;","    gl_FragColor.a *= step(vCounters, visibility);","",n.ShaderChunk.fog_fragment,"}"].join("\n"),s.prototype=Object.create(n.ShaderMaterial.prototype),s.prototype.constructor=s,s.prototype.isMeshLineMaterial=!0,s.prototype.copy=function(e){return n.ShaderMaterial.prototype.copy.call(this,e),this.lineWidth=e.lineWidth,this.map=e.map,this.useMap=e.useMap,this.alphaMap=e.alphaMap,this.useAlphaMap=e.useAlphaMap,this.color.copy(e.color),this.opacity=e.opacity,this.resolution.copy(e.resolution),this.sizeAttenuation=e.sizeAttenuation,this.dashArray.copy(e.dashArray),this.dashOffset.copy(e.dashOffset),this.dashRatio.copy(e.dashRatio),this.useDash=e.useDash,this.visibility=e.visibility,this.alphaTest=e.alphaTest,this.repeat.copy(e.repeat),this},e.exports&&(t=e.exports={MeshLine:i,MeshLineMaterial:s,MeshLineRaycast:a}),t.MeshLine=i,t.MeshLineMaterial=s,t.MeshLineRaycast=a}).call(commonjsGlobal)})),TrailController=function(e){var t=[],r=e;this.g=new THREE_MeshLine$1.MeshLine,this.update=function(e){for(var n=r.userData.trailDuration,i=t.length-1;i>=0;i--)t[i].currentTime+e>n?t.splice(i,1):t[i].currentTime+=e;var a=r.position.clone();if(t.length<=0?t.push({pos:a,currentTime:0}):a.x==t[t.length-1].pos.x&&a.y==t[t.length-1].pos.y&&a.z==t[t.length-1].pos.z||t.push({pos:a,currentTime:0}),t.length>2){for(var o=r.userData.mesh,s=[],l=0;l<t.length;l++)s.push(t[l].pos.x),s.push(t[l].pos.y),s.push(t[l].pos.z);this.g.setPoints(s),o.geometry=this.g.geometry}},this.dispose=function(){}};class TreeAnimationController extends AnimationController{constructor(e){super("TreeAnimationController"),this.tree=e,this.windTime=0,this.render=e=>{null!=!this.tree&&(this.windTime+=e,this.tree.updateWindEffect(0,this.windTime),this.windTime>Number.MAX_SAFE_INTEGER-1e3&&(this.windTime=0))},this.dispose=()=>{this.tree=void 0}}}TreeAnimationController.type="TreeAnimationController";class UVAnimationController extends AnimationController{constructor(e,t,r,n,i){super("UVAnimationController"),this.material=e,this.enableU=t,this.enableV=r,this.uSpeed=n,this.vSpeed=i;let a=this._findFirstAvailableMapForUV();a&&!this.material._uvDefault&&(this.material._uvDefault={wrapS:a.wrapS,wrapT:a.wrapT,repeat:a.repeat?a.repeat.clone():void 0,offset:a.offset?a.offset.clone():void 0}),this.reset=()=>{let e=this._findFirstAvailableMapForUV();e&&this.material&&this.material._uvDefault&&(e.repeat.x=this.material._uvDefault.repeat.x,e.repeat.y=this.material._uvDefault.repeat.y,e.offset.x=this.material._uvDefault.offset.x,e.offset.y=this.material._uvDefault.offset.y)}}_findFirstAvailableMapForUV(){if(this.material)return this.material.map||this.material.specularMap||this.material.displacementMap||this.material.normalMap||this.material.bumpMap||this.material.roughnessMap||this.material.metalnessMap||this.material.alphaMap||this.material.emissiveMap}render(e){null!=this.material&&(this.enableU&&(null!=this.material.map&&(this.material.map.offset.x+=this.uSpeed*e),null!=this.material.emissiveMap&&(this.material.emissiveMap.offset.x+=this.uSpeed*e),null!=this.material.alphaMap&&(this.material.alphaMap.offset.x+=this.uSpeed*e),null!=this.material.normalMap&&(this.material.normalMap.offset.x+=this.uSpeed*e),null!=this.material.bumpMap&&(this.material.bumpMap.offset.x+=this.uSpeed*e)),this.enableV&&(null!=this.material.map&&(this.material.map.offset.y+=this.vSpeed*e),null!=this.material.emissiveMap&&(this.material.emissiveMap.offset.y+=this.vSpeed*e),null!=this.material.alphaMap&&(this.material.alphaMap.offset.y+=this.vSpeed*e),null!=this.material.normalMap&&(this.material.normalMap.offset.y+=this.vSpeed*e),null!=this.material.bumpMap&&(this.material.bumpMap.offset.y+=this.vSpeed*e)))}}UVAnimationController.type="UVAnimationController";class UVMeshLineAnimationController extends AnimationController{constructor(e,t,r,n,i){super("UVMeshLineAnimationController"),this.material=e,this.enableU=t,this.enableV=r,this.uSpeed=n,this.vSpeed=i,this.reset=()=>{this.material.map&&(this.material.offset.x=0,this.material.offset.y=0)}}render(e){null!=this.material&&(this.enableU&&(this.material.offset.x+=this.uSpeed*e),this.enableV&&(this.material.offset.y+=this.vSpeed*e))}}UVMeshLineAnimationController.type="UVMeshLineAnimationController";class WaterAnimationController extends AnimationController{constructor(e,t=1){super("WaterAnimationController"),this._material=e,this._speed=t}get speed(){return this._speed}set speed(e){this._speed=e}render(e){null!=this._material&&(this._material.uniforms.time.value+=e*this._speed)}}WaterAnimationController.type="WaterAnimationController";class Map$1{constructor({id:e=util$1.guid(),name:t="",type:r="color",source:n="",intensity:i=1}={}){this._id=e,this._name=t,this._type=r,this._source=n,this._intensity=i}get id(){return this._id}get name(){return this._name}set name(e){this._name=e}get type(){return this._type}set type(e){this._type=e}get source(){return this._source}set source(e){this._source=e}get intensity(){return this._intensity}set intensity(e){this._intensity=e}getCanvas({width:e,height:t,adjust:r="auto",pixelRatio:n=1}={}){if(this._source)switch(this._type.toLowerCase()){case"color":return this._colorCanvas||(this._colorCanvas=this.createColorCanvas({width:e,width:t})),this._colorCanvas;case"file":return;case"imagebitmap":return void(this._canvas||(this._canvas=this.createCanvas({width:e,width:t})))}}createCanvas({width:e,height:t,adjust:r}={}){if("imagebitmap"!==this._type)return;let n=document.createElement("canvas");return n.width=e||this._source.width,n.height=t||this._source.height,n.getContext("2d").drawImage(this._source,0,0),n}createColorCanvas({width:e,height:t}){let r=document.createElement("canvas");return r.width=e||64,r.height=t||64,r.getContext("2d").fillStyle=this._source||"#ffffaa",r.getContext("2d").fillRect(0,0,e||64,t||64),r}destroyCanvas(){this._canvas||this._canvas.parentElement.removeChild(this._canvas)}isColor(){return"color"===this._type.toLowerCase()}isFile(){return"file"===this._type.toLowerCase()}isImageBitmap(){return"imagebitmap"===this._type.toLowerCase()}isTexture(){return this.isFile()||this.isImageBitmap()}}Map$1._fromThreeObject=function(e,t){if(!e)return new Map$1({source:t});let r=new Map$1({id:e.uuid,name:e.name});return e.image&&(r.type="imagebitmap",r.source=e.image,r.intensity=1),r};class Texture{constructor({id:e=util$1.guid(),name:t="",type:r="imagebitmap",textureSource:n=""}={}){this._id=e,this._name=t,this._type=r,this._textureSource=n}get id(){return this._id}get name(){return this._name}get type(){return this._type}get textureSource(){return this._textureSource}set textureSource(e){this._textureSource=e}getCanvas({width:e,height:t,adjust:r}={}){if(this._textureSource&&"imagebitmap"===this._type){if(!this._canvas){this._canvas=document.createElement("canvas"),this._canvas.width=e||this._textureSource.width,this._canvas.height=t||this._textureSource.height,this._canvas.getContext("2d").drawImage(this._textureSource,0,0,this._canvas.width,this._canvas.height)}return this._canvas}}destroyCanvas(){this._canvas&&(this._canvas.parentElement.removeChild(this._canvas),this._canvas=void 0)}}Texture._fromThreeObject=function({uuid:e,name:t,type:r,image:n,rotation:i,center:a,flipY:o}={}){return new Texture({id:e,name:t,type:"imagebitmap",textureSource:n})};var Water=function(e,t){Mesh.call(this,e);var r=this,n=void 0!==(t=t||{}).textureWidth?t.textureWidth:512,i=void 0!==t.textureHeight?t.textureHeight:512,a=void 0!==t.clipBias?t.clipBias:0,o=void 0!==t.alpha?t.alpha:1,s=void 0!==t.time?t.time:0,l=void 0!==t.waterNormals?t.waterNormals:null,c=void 0!==t.sunDirection?t.sunDirection:new Vector3(.70707,.70707,0),h=new Color(void 0!==t.sunColor?t.sunColor:16777215),u=new Color(void 0!==t.waterColor?t.waterColor:8355711),d=void 0!==t.eye?t.eye:new Vector3(0,0,0),p=void 0!==t.distortionScale?t.distortionScale:20,f=void 0!==t.side?t.side:FrontSide,m=void 0!==t.fog&&t.fog,g=void 0!==t.reflectionRate?t.reflectionRate:.9,y=void 0!==t.yUp&&t.yUp;r.reflectionAutoUpdate=void 0===t.reflectionAutoUpdate||t.reflectionAutoUpdate;var v=new Plane,b=new Vector3,_=new Vector3,x=new Vector3,w=new Matrix4,S=new Vector3(0,0,-1),M=new Vector4,T=new Vector3,A=new Vector3,E=new Vector4,C=new Matrix4,L=new PerspectiveCamera,D=new WebGLRenderTarget(n,i,{minFilter:LinearFilter,magFilter:LinearFilter,format:RGBFormat});MathUtils.isPowerOfTwo(n)&&MathUtils.isPowerOfTwo(i)||(D.texture.generateMipmaps=!1);var R={uniforms:UniformsUtils.merge([UniformsLib.fog,UniformsLib.lights,{normalSampler:{value:null},mirrorSampler:{value:null},alpha:{value:1},time:{value:0},size:{value:1},distortionScale:{value:20},textureMatrix:{value:new Matrix4},sunColor:{value:new Color(8355711)},sunDirection:{value:new Vector3(.70707,.70707,0)},eye:{value:new Vector3},waterColor:{value:new Color(5592405)},reflectionRate:{value:.9}}]),vertexShader:["uniform mat4 textureMatrix;","uniform float time;","varying vec4 mirrorCoord;","varying vec4 worldPosition;","#include <common>","#include <fog_pars_vertex>","#include <shadowmap_pars_vertex>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>","void main() {","\tmirrorCoord = modelMatrix * vec4( position, 1.0 );","\tworldPosition = mirrorCoord.xyzw;","\tmirrorCoord = textureMatrix * mirrorCoord;","\tvec4 mvPosition =  modelViewMatrix * vec4( position, 1.0 );","\tgl_Position = projectionMatrix * mvPosition;","#include <clipping_planes_vertex>","#include <beginnormal_vertex>","#include <defaultnormal_vertex>","#include <logdepthbuf_vertex>","#include <fog_vertex>","#include <shadowmap_vertex>","}"].join("\n"),fragmentShader:["uniform sampler2D mirrorSampler;","uniform float alpha;","uniform float time;","uniform float size;","uniform float distortionScale;","uniform float reflectionRate;","uniform sampler2D normalSampler;","uniform vec3 sunColor;","uniform vec3 sunDirection;","uniform vec3 eye;","uniform vec3 waterColor;","varying vec4 mirrorCoord;","varying vec4 worldPosition;","vec4 getNoise( vec2 uv ) {","\tvec2 uv0 = ( uv / 103.0 ) + vec2(time / 17.0, time / 29.0);","\tvec2 uv1 = uv / 107.0-vec2( time / -19.0, time / 31.0 );","\tvec2 uv2 = uv / vec2( 8907.0, 9803.0 ) + vec2( time / 101.0, time / 97.0 );","\tvec2 uv3 = uv / vec2( 1091.0, 1027.0 ) - vec2( time / 109.0, time / -113.0 );","\tvec4 noise = texture2D( normalSampler, uv0 ) +","\t\ttexture2D( normalSampler, uv1 ) +","\t\ttexture2D( normalSampler, uv2 ) +","\t\ttexture2D( normalSampler, uv3 );","\treturn noise * 0.5 - 1.0;","}","void sunLight( const vec3 surfaceNormal, const vec3 eyeDirection, float shiny, float spec, float diffuse, inout vec3 diffuseColor, inout vec3 specularColor ) {","\tvec3 reflection = normalize( reflect( -sunDirection, surfaceNormal ) );","\tfloat direction = max( 0.0, dot( eyeDirection, reflection ) );","\tspecularColor += pow( direction, shiny ) * sunColor * spec;","\tdiffuseColor += max( dot( sunDirection, surfaceNormal ), 0.0 ) * sunColor * diffuse;","}","#include <common>","#include <packing>","#include <bsdfs>","#include <fog_pars_fragment>","#include <logdepthbuf_pars_fragment>","#include <lights_pars_begin>","#include <shadowmap_pars_fragment>","#include <shadowmask_pars_fragment>","#include <clipping_planes_pars_fragment>","void main() {","#include <clipping_planes_fragment>","#include <logdepthbuf_fragment>","\tvec4 noise = getNoise( worldPosition.xz * size );","\tvec3 surfaceNormal = normalize( noise.xzy * vec3( 1.5, 1.0, 1.5 ) );","\tvec3 diffuseLight = vec3(0.0);","\tvec3 specularLight = vec3(0.0);","\tvec3 worldToEye = eye-worldPosition.xyz;","\tvec3 eyeDirection = normalize( worldToEye );","\tsunLight( surfaceNormal, eyeDirection, 100.0, 2.0, 0.5, diffuseLight, specularLight );","\tfloat distance = length(worldToEye);","\tvec2 distortion = surfaceNormal.xz * ( 0.001 + 1.0 / distance ) * distortionScale;","\tvec3 reflectionSample = vec3( texture2D( mirrorSampler, mirrorCoord.xy / mirrorCoord.w + distortion ) );","\tfloat theta = max( dot( eyeDirection, surfaceNormal ), 0.0 );","\tfloat rf0 = 0.3;","\tfloat reflectance = rf0 + ( 1.0 - rf0 ) * pow( ( 1.0 - theta ), 5.0 );","\tvec3 scatter = max( 0.0, dot( surfaceNormal, eyeDirection ) ) * waterColor;","\tvec3 albedo = mix( ( sunColor * diffuseLight * 0.3 + scatter ) * getShadowMask(), ( vec3( 0.1 ) + reflectionSample * 0.9 * reflectionRate + reflectionSample * specularLight ), reflectance);","\tvec3 outgoingLight = albedo;","\tgl_FragColor = vec4( outgoingLight, alpha );","#include <tonemapping_fragment>","#include <fog_fragment>","}"].join("\n")},P=new ShaderMaterial({fragmentShader:R.fragmentShader,vertexShader:R.vertexShader,uniforms:UniformsUtils.clone(R.uniforms),lights:!0,side:f,fog:m});P.clipping=!0,P.uniforms.mirrorSampler.value=D.texture,P.uniforms.textureMatrix.value=C,P.uniforms.alpha.value=o,P.uniforms.time.value=s,P.uniforms.normalSampler.value=l,P.uniforms.sunColor.value=h,P.uniforms.waterColor.value=u,P.uniforms.sunDirection.value=c,P.uniforms.distortionScale.value=p,P.uniforms.reflectionRate.value=g,P.uniforms.eye.value=d,r.material=P,r.getRenderTarget=function(){return D},r.onBeforeRender=function(e,t,n){if(_.setFromMatrixPosition(r.matrixWorld),x.setFromMatrixPosition(n.matrixWorld),w.extractRotation(r.matrixWorld),b.set(0,y?1:0,y?0:1),b.applyMatrix4(w),T.subVectors(_,x),!(T.dot(b)>0)){T.reflect(b).negate(),T.add(_),w.extractRotation(n.matrixWorld),S.set(0,0,-1),S.applyMatrix4(w),S.add(x),A.subVectors(_,S),A.reflect(b).negate(),A.add(_),L.position.copy(T),L.up.set(0,1,0),L.up.applyMatrix4(w),L.up.reflect(b),L.lookAt(A),L.far=n.far,L.updateMatrixWorld(),L.projectionMatrix.copy(n.projectionMatrix),C.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),C.multiply(L.projectionMatrix),C.multiply(L.matrixWorldInverse),v.setFromNormalAndCoplanarPoint(b,_),v.applyMatrix4(L.matrixWorldInverse),M.set(v.normal.x,v.normal.y,v.normal.z,v.constant);var i=L.projectionMatrix;if(E.x=(Math.sign(M.x)+i.elements[8])/i.elements[0],E.y=(Math.sign(M.y)+i.elements[9])/i.elements[5],E.z=-1,E.w=(1+i.elements[10])/i.elements[14],M.multiplyScalar(2/M.dot(E)),i.elements[2]=M.x,i.elements[6]=M.y,i.elements[10]=M.z+1-a,i.elements[14]=M.w,d.setFromMatrixPosition(n.matrixWorld),e.outputEncoding!==LinearEncoding)return logger.warn("THREE.Water: WebGLRenderer must use LinearEncoding as outputEncoding."),void(r.onBeforeRender=function(){});if(e.toneMapping!==NoToneMapping)return logger.warn("THREE.Water: WebGLRenderer must use NoToneMapping as toneMapping."),void(r.onBeforeRender=function(){});if(r.reflectionAutoUpdate||r.needsUpdate){var o=e.getRenderTarget(),s=e.xr.enabled,l=e.shadowMap.autoUpdate;r.visible=!1;var c=null;for(let e=0;e<_context.scene.children.length;e++)"__objects"===_context.scene.children[e].name&&(c=_context.scene.children[e].visible,_context.scene.children[e].visible=!1);util$1.iconVisible(_context.defaultObjectTree.children,!1),e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(D),e.state.buffers.depth.setMask(!0),!1===e.autoClear&&e.clear(),e.render(t,L),r.needsUpdate=void 0,r.visible=!0;for(let e=0;e<_context.scene.children.length;e++)"__objects"===_context.scene.children[e].name&&(_context.scene.children[e].visible=c);util$1.iconVisible(_context.defaultObjectTree.children,!0),e.xr.enabled=s,e.shadowMap.autoUpdate=l,e.setRenderTarget(o)}var h=n.viewport;void 0!==h&&e.state.viewport(h)}}};Water.prototype=Object.create(Mesh.prototype),Water.prototype.constructor=Water;class Material{constructor({materialOfThree:e,id:t=util$1.guid(),name:r,type:n="metalness",mapType:i="metalness",color:a,map:o,mapIntensit:s=1,metalnessMap:l,metalnessIntensity:c=1,specularF0Texture:h,roughnessMap:u,roughnessIntensity:d=1,enableSpecularMap:p=!0,specularMapType:f,specularMap:m,specularMapIntensity:g=0,enableNormalMap:y,normalMapType:v,normalMap:b,normalMapFlipY:_,normalMapIntensity:x=1,enableDisplacement:w,displacementMap:S,displacementIntensity:M=1,enableOpacity:T,opacityType:A,opacityMap:E,opacityIntensity:C=1,opacityInverted:L=!1,emissive:D,enableEmissive:R,emissiveMap:P,emissiveIntensity:O=1,enableLightMap:I,lightMap:k,lightMapIntensity:B=1,enableUV:N=!1,repeatU:F=1,repeatV:U=1,offsetU:z=0,offsetV:H=0,enableTranslation:G=!1,translationSpeedU:V=0,translationSpeedV:j=0,enableSSR:W=!1,envMapIntensity:Y=1,side:X,depth:$,waterFlowSpeed:Z,waterOffsetY:q,waterColor:J,waterOpacity:Q,waterReflectionRate:K,waterWave:ee}){var te=e;te.disableSSR=!0,this._id=t,this._name=r,this._type=n,this._mapType=i,this._color=`#${a.getHexString()}`,this._map=Map$1._fromThreeObject(o,this._color),this._mapIntensit=s,this._metalnessMap=Map$1._fromThreeObject(l),this._metalnessIntensity=c,"color"===this._metalnessMap._type&&(this._metalnessMap._source="#ffffff"),this._roughnessMap=Map$1._fromThreeObject(u),"color"===this._roughnessMap._type&&(this._roughnessMap._source="#ffffff"),this._roughnessIntensity=1-Number(d),this._enableSpecularMap=!0,this._specularMapType=f,this._specularMap=Map$1._fromThreeObject(m),"color"===this._specularMap._type&&(this._specularMap._source="#ffffff"),this._specularMapIntensity=g,this._enableNormalMap=y,y?te.bumpMap?this._normalMapType="bump":this._normalMapType="normal":this._normalMapType="bump",this._normalMap=Map$1._fromThreeObject(b),this._normalMapFlipY=_,this._normalMapIntensity=x,"color"===this._normalMap._type&&(this._normalMap._source="#ffffff"),this._enableDisplacement=w,this._displacementMap=Map$1._fromThreeObject(S),"color"===this._displacementMap._type&&(this._displacementMap._source="#ffffff"),this._displacementIntensity=M,this._enableOpacity=T,this._opacityType=A,this._opacityMap=Map$1._fromThreeObject(E),this._opacityIntensity=C,this._opacityInverted=L,"color"===this._opacityMap._type&&(this._opacityMap._source="#ffffff"),this._enableEmissive=R,this._emissiveMap=Map$1._fromThreeObject(P),this._emissiveIntensity=O,this._emissiveMapColor="#ffffff","color"===this._emissiveMap._type&&(this._emissiveMapColor="#"+D.getHexString()),this._enableLightMap=I,this._lightMap=Map$1._fromThreeObject(k),this._lightMapIntensity=B,"color"===this._lightMap._type&&(this._lightMap._source="#ffffff"),this._enableUV=N,this._repeatU=F,this._repeatV=U,this._offsetU=z,this._offsetV=H,this._enableTranslation=G,this._translationSpeedU=V,this._translationSpeedV=j,this._enableSSR=W,this._envMapIntensity=Y,this._side=X,this._depth=$,this._relatedNodes=[],this._waterFlowSpeed=.25,this._waterOffsetY=0,this._waterColor="#001e0f",this._waterReflectionAutoUpdate=!0,this._waterReflectionQuality=512,this._waterOpacity=.65,this._waterReflectionRate=1,this._waterWave=3.7,this.addRelatedNode=function(e){this._relatedNodes.push(e)},this.addModelName=function(e){this._modelName=e},this._material=()=>te}get material(){return this._material}get id(){return this._id}get name(){return this._name}set name(e){this._name=e}get type(){return this._type}set type(e){if(e!==this._type){switch(e.toLowerCase()){case"specular":if("water"===this._type){let e=util$1.findMeshByMaterial(_context.scene,this._material());for(let t of e){let e=t.getObjectByName(t.name+this._material().name+"_water_");e&&(util$1.removeFromObjectsNeedsUpdate(e),e.geometry.dispose(),e.material.dispose(),t.remove(e)),t.position.y-=this._waterOffsetY}this._material().transparent=this._material().userData.transparent,this._material().opacity=this._material().userData.opacity}if("envmap"===this._specularMapType){let e={"skybox-blue":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-blue07":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-day":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-day2":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-dusk":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-night":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-real":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-day-10":"texture/cubemap/skybox-day-10/specularmap.dds","skybox-day-18":"texture/cubemap/skybox-day-18/specularmap.dds","skybox-dusk-4":"texture/cubemap/skybox-dusk-4/specularmap.dds","skybox-dusk-6":"texture/cubemap/skybox-dusk-6/specularmap.dds","skybox-night-3":"texture/cubemap/skybox-night-3/specularmap.dds","skybox-night-24":"texture/cubemap/skybox-night-24/specularmap.dds"},t=_context.instance.getSkyboxName();if(!t||""===t)return;let r=e[t]||"texture/cubemap/CubeMap-CityDay-01_Cube.dds";if(r){let e=(new DDSLoader).load(this.url(r),(function(e){e.magFilter=LinearFilter,e.minFilter=LinearFilter,e.mapping=CubeReflectionMapping}));if(this._material().envMap=e,this.specularMapIntensity=.4,this._material().envMap.needsUpdate=!0,this._copies instanceof Array)for(let t of this._copies)t.envMap=e,t.envMapIntensity=2,t.envMap.needsUpdate=!0}}if("custom"===this._specularMapType){if(this._material().envMap=null,this._copies instanceof Array)for(let e of this._copies)e.envMap=null;this.specularMap=this._specularMap}break;case"water":if("specular"===this._type&&(this._material().envMap=null,this.specularMapIntensity=.2,this._copies instanceof Array))for(let e of this._copies)e.envMap=null,e.envMapIntensity=1;let e=util$1.findMeshByMaterial(_context.scene,this._material(),this._copies);for(let t of e){if(t.isWater=!0,t.parent instanceof Object3D){let e=t.parent.getObjectByName(t.parent.name+this._material().name+"_water_");e instanceof Mesh&&(e.geometry.dispose(),e.material.dispose(),e.parent.remove(e))}for(let e=0;e<t.children.length;e++)-1!=t.children[e].name.indexOf(t.name+this._material().name+"_water_")&&(util$1.removeFromObjectsNeedsUpdate(t.children[e]),t.children[e].geometry.dispose(),t.children[e].material.dispose(),t.remove(t.children[e]),e--);if(t.geometry,t.geometry instanceof BufferGeometry){let e=t.geometry.clone();if(t.geometry.groups.length>0){let r=0;for(let e in t.material)t.material[e]===this._material()&&(r=parseInt(e));let n=t.geometry.groups.find((e=>e.materialIndex===r));e.clearGroups(),e.addGroup(n.start,n.count,0),e.setDrawRange(n.start,n.count)}let r=new Water(e,{textureWidth:this.waterReflectionQuality,textureHeight:this.waterReflectionQuality,waterNormals:(new TextureLoader).load(util$1.url(_context.instance.resourceBasePath,"texture/water/waternormals.jpg"),(function(e){e.wrapS=e.wrapT=RepeatWrapping})),alpha:this.waterOpacity||.65,sunDirection:new Vector3,sunColor:16777215,waterColor:this.waterColor||7695,distortionScale:this.waterWave||3.7,fog:!0,reflectionRate:this.waterReflectionRate||1,yUp:!0,reflectionAutoUpdate:this.waterReflectionAutoUpdate});r.name=t.name+this._material().name+"_water_";const n=.39*Math.PI,i=2*Math.PI*(.205-.5);let a=new Vector3;a.x=Math.cos(i),a.y=Math.sin(i)*Math.sin(n),a.z=Math.sin(i)*Math.cos(n),r.receiveShadow=!0,r.material.transparent=!0,r.material.uniforms.sunDirection.value.copy(a).normalize(),r.needsUpdate=!0,t.add(r),util$1.addToObjectsNeedsUpdate(r),t.userData.y=t.position.y,t.position.y=t.userData.y+this._waterOffsetY,_context.animationStore.add(new WaterAnimationController(r.material,this.waterFlowSpeed||.25))}}if(this._material().userData||(this._material().userData={}),this._material(),this._material().userData.transparent=this._material().transparent,this._material().userData.opacity=this._material().opacity,this._material().transparent=!0,this._material().opacity=0,this._copies instanceof Array)for(let e of this._copies)e.userData||(e.userData={}),e.userData.transparent=e.transparent,e.userData.opacity=e.opacity,e.transparent=!0,e.opacity=0;break;case"metalness":if("water"===this._type){let e=util$1.findMeshByMaterial(_context.scene,this._material(),this._copies);for(let t of e){let e=t.getObjectByName(t.name+this._material().name+"_water_");e&&(util$1.removeFromObjectsNeedsUpdate(e),e.geometry.dispose(),e.material.dispose(),t.remove(e)),t.position.y-=this._waterOffsetY}if(this._material().transparent=this._material().userData.transparent,this._material().opacity=this._material().userData.opacity,this._copies instanceof Array)for(let e of this._copies)e.transparent=e.userData.transparent,e.opacity=e.userData.opacity}if("specular"===this._type&&(this._material().envMap=null,this.specularMapIntensity=.2,this._copies instanceof Array))for(let e of this._copies)e.envMap=null,e.envMapIntensity=1}this._type=e}}get mapType(){return this._mapType}set mapType(e){if(e!==this._type){switch(e.toLowerCase()){case"specular":if("envmap"===this._specularMapType){let e={"skybox-blue":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-blue07":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-day":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-day2":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-dusk":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-night":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-real":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-day-10":"texture/cubemap/skybox-day-10/specularmap.dds","skybox-day-18":"texture/cubemap/skybox-day-18/specularmap.dds","skybox-dusk-4":"texture/cubemap/skybox-dusk-4/specularmap.dds","skybox-dusk-6":"texture/cubemap/skybox-dusk-6/specularmap.dds","skybox-night-3":"texture/cubemap/skybox-night-3/specularmap.dds","skybox-night-24":"texture/cubemap/skybox-night-24/specularmap.dds"},t=_context.instance.getSkyboxName();if(!t||""===t)return;let r=e[t]||"texture/cubemap/CubeMap-CityDay-01_Cube.dds";if(r){let e=(new DDSLoader).load(this.url(r),(function(e){e.magFilter=LinearFilter,e.minFilter=LinearFilter,e.mapping=CubeReflectionMapping}));if(this._material().envMap=e,this.specularMapIntensity=.4,this._material().envMap.needsUpdate=!0,this._copies instanceof Array)for(let t of this._copies)t.envMap=e,t.envMapIntensity=2,t.envMap.needsUpdate=!0}}if("custom"===this._specularMapType){if(this._material().envMap=null,this._copies instanceof Array)for(let e of this._copies)e.envMap=null;this.specularMap=this._specularMap}}this._mapType=e}}get color(){return logger.debug("TRACE: Material.color (getter) - Entering."),this._color}set color(e){logger.debug("TRACE: Material.color (setter) - Entering."),logger.debug("TRACE: Material.color (setter) - Exiting."),this._color=e;let t=new Color(e);if(this._material())if(this._material().color){let e=util$1.colorToRGBAObject(this._color);this._material().color.r=e.r*this._mapIntensit,this._material().color.g=e.g*this._mapIntensit,this._material().color.b=e.b*this._mapIntensit}else{this._material().color=t;let e=util$1.colorToRGBAObject(this._color);this._material().color.r=e.r*this._mapIntensit,this._material().color.g=e.g*this._mapIntensit,this._material().color.b=e.b*this._mapIntensit}if(this._copies instanceof Array)for(let e of this._copies)if(e)if(e.color){let t=util$1.colorToRGBAObject(this._color);e.color.r=t.r*this._mapIntensit,e.color.g=t.g*this._mapIntensit,e.color.b=t.b*this._mapIntensit}else{e.color=new Color(t);let t=util$1.colorToRGBAObject(this._color);e.color.r=t.r*this._mapIntensit,e.color.g=t.g*this._mapIntensit,e.color.b=t.b*this._mapIntensit}}get map(){return logger.debug("TRACE: Material.map (getter) - Entering."),logger.debug("TRACE: Material.map (getter) - Exiting."),void 0===this._map._source&&"imagebitmap"===this._map._type&&(this._map._source=this._color,this._map._type="color"),this._map}set map({type:e="color",source:t="#ffffff",reset:r=!1}){if(logger.debug("TRACE: Material.map (setter) - Entering."),"color"!==e.toLowerCase())if("imagebitmap"!==e.toLowerCase())e.toLowerCase(),logger.debug("TRACE: Material.map (setter) - Exiting.");else{if(t&&"#ffffff"!==t&&""!==t){if(this._map.type="imagebitmap",this._map._name=t.name,this._map.source=t,this._material()&&(this._material().map?(this._material().map=this._material().map.clone(),this._material().map.image=t.textureSource):(this._material().map=new Texture$1(t.textureSource),this._material().map.wrapS=1e3,this._material().map.wrapT=1e3,this._material().map.encoding=3001,this._material().map.flipY=!1,this._material().map.format=1022,this._material().map.version=10,this.enableUV&&(this.enableUV=!0)),this._material().map.needsUpdate=!0,this._material().color?this._material().color.setStyle(this._color):this._material().color=new Color(this._color)),this._material().needsUpdate=!0,this._copies instanceof Array)for(let e of this._copies)e&&(e.map?(e.map=e.map.clone(),e.map.image=t.textureSource):(e.map=new Texture$1(t.textureSource),e.map.wrapS=1e3,e.map.wrapT=1e3,e.map.encoding=3001,e.map.flipY=!1,e.map.format=1022,e.map.version=10,this.enableUV&&(this.enableUV=!0)),e.map.needsUpdate=!0,e.color?e.color.setStyle(this._color):e.color=new Color(this._color));return void logger.debug("TRACE: Material.map (setter) - Exiting.")}if(this._map._type="imagebitmap",this._map._name=void 0,this._map._source=void 0,this._material()&&(this._material().map&&(this._material().map.dispose(),this._material().map=null),this._material().needsUpdate=!0),this._copies instanceof Array)for(let e of this._copies)e&&e.map&&(e.map.dispose(),e.map=null);logger.debug("TRACE: Material.map (setter) - Exiting.")}else{if(!util$1.isCSSColor(t))return void logger.debug("TRACE: Material.map (setter) - Exiting.");if(this._map._source?this._map._name=this._map._source._name:this._map._name=null,this._color=t,this._material())if(this._material().color){let e=util$1.colorToRGBAObject(this._color);this._material().color.r=e.r*this._mapIntensit,this._material().color.g=e.g*this._mapIntensit,this._material().color.b=e.b*this._mapIntensit,this._material().map=null}else{this._material().color=new Color(this._color);let e=util$1.colorToRGBAObject(this._color);this._material().color.r=e.r*this._mapIntensit,this._material().color.g=e.g*this._mapIntensit,this._material().color.b=e.b*this._mapIntensit,this._material().map=null}if(this._copies instanceof Array)for(let e of this._copies)if(e)if(e.color){let t=util$1.colorToRGBAObject(this._color);e.color.r=t.r*this._mapIntensit,e.color.g=t.g*this._mapIntensit,e.color.b=t.b*this._mapIntensit,e.map=null}else{e.color=new Color(this._color);let t=util$1.colorToRGBAObject(this._color);e.color.r=t.r*this._mapIntensit,e.color.g=t.g*this._mapIntensit,e.color.b=t.b*this._mapIntensit,e.map=null}if(r){if(this._map._type="imagebitmap",this._map._name=void 0,this._map._source=void 0,this._material()&&this._material().map&&(this._material().map.dispose(),this._material().map=null),this._copies instanceof Array)for(let e of this._copies)e&&e.map&&(e.map.dispose(),e.map=null);logger.debug("TRACE: Material.map (setter) - Exiting.")}logger.debug("TRACE: Material.map (setter) - Exiting.")}}get mapIntensit(){return logger.debug("TRACE: Material.mapIntensit (getter) - Entering."),this._mapIntensit}set mapIntensit(e){if(logger.debug("TRACE: Material.mapIntensit (setter) - Entering."),logger.debug("TRACE: Material.mapIntensit (setter) - Exiting."),this._mapIntensit=e,this._material()&&this._color){let t=util$1.colorToRGBAObject(this._color);this._material().color.r=t.r*e,this._material().color.g=t.g*e,this._material().color.b=t.b*e}if(this._copies instanceof Array)for(let t of this._copies)if(t&&this._color){let r=util$1.colorToRGBAObject(this._color);t.color.r=r.r*e,t.color.g=r.g*e,t.color.b=r.b*e}}get metalnessMap(){return logger.debug("TRACE: Material.metalnessMap (getter) - Entering."),logger.debug("TRACE: Material.metalnessMap (getter) - Exiting."),this._metalnessMap}set metalnessMap({type:e,source:t}){if(logger.debug("TRACE: Material.metalnessMap (setter) - Entering."),"imagebitmap"===e.toLowerCase()&&t instanceof Texture){if(this._metalnessMap.type="imagebitmap",this._metalnessMap._name=t.name,this._metalnessMap.source=t,this._material()&&(this._material().metalnessMap?this._material().metalnessMap.image=this._metalnessMap.source.textureSource:(this._material().metalnessMap=new Texture$1(this._metalnessMap.source.textureSource),this.enableUV&&(this.enableUV=!0)),this._material().metalnessMap.needsUpdate=!0),this._copies instanceof Array)for(let e of this._copies)e&&(e.metalnessMap?e.metalnessMap.image=this._metalnessMap.source.textureSource:(e.metalnessMap=new Texture$1(this._metalnessMap.source.textureSource),this.enableUV&&(this.enableUV=!0)),e.metalnessMap.needsUpdate=!0);logger.debug("TRACE: Material.metalnessMap (setter) - Exiting.")}else{if("imagebitmap"===e.toLowerCase()&&!t){if(this._material()&&(this._material().metalnessMap=null),this._copies instanceof Array)for(let e of this._copies)e&&(e.metalnessMap=null);return this._metalnessMap.type="imagebitmap",this._metalnessMap._name="",this._metalnessMap.source="",void logger.debug("TRACE: Material.metalnessMap (setter) - Exiting.")}e.toLowerCase(),logger.debug("TRACE: Material.metalnessMap (setter) - Exiting.")}}get metalnessIntensity(){return logger.debug("TRACE: Material.metalnessIntensity (getter) - Entering."),logger.debug("TRACE: Material.metalnessIntensity (getter) - Exiting."),this._metalnessIntensity}set metalnessIntensity(e){if(logger.debug("TRACE: Material.metalnessIntensity (setter) - Entering."),this._metalnessIntensity=e,this._material().metalness=this._metalnessIntensity,this._copies instanceof Array)for(let e of this._copies)e.metalness=this._metalnessIntensity;logger.debug("TRACE: Material.metalnessIntensity (setter) - Exiting.")}get roughnessMap(){return logger.debug("TRACE: Material.roughnessMap (getter) - Entering."),logger.debug("TRACE: Material.roughnessMap (getter) - Exiting."),this._roughnessMap}set roughnessMap({type:e,source:t}){if(logger.debug("TRACE: Material.roughnessMap (setter) - Entering."),"imagebitmap"===e.toLowerCase()&&t instanceof Texture){if(this._roughnessMap.type="imagebitmap",this._roughnessMap._name=t.name,this._roughnessMap.source=t,this._material()&&(this._material().roughnessMap?this._material().roughnessMap.image=this._roughnessMap.source.textureSource:(this._material().roughnessMap=new Texture$1(this._roughnessMap.source.textureSource),this.enableUV&&(this.enableUV=!0)),this._material().roughnessMap.needsUpdate=!0),this._copies instanceof Array)for(let e of this._copies)e&&(e.roughnessMap?e.roughnessMap.image=this._roughnessMap.source.textureSource:(e.roughnessMap=new Texture$1(this._roughnessMap.source.textureSource),this.enableUV&&(this.enableUV=!0)),e.roughnessMap.needsUpdate=!0);logger.debug("TRACE: Material.roughnessMap (setter) - Exiting.")}else{if("imagebitmap"===e.toLowerCase()&&!t){if(this._material()&&(this._material().roughnessMap=null),this._copies instanceof Array)for(let e of this._copies)e&&(e.roughnessMap=null);return this._roughnessMap.type="imagebitmap",this._roughnessMap._name="",this._roughnessMap.source="",void logger.debug("TRACE: Material.metalnessMap (setter) - Exiting.")}e.toLowerCase(),logger.debug("TRACE: Material.roughnessMap (setter) - Exiting.")}}get roughnessIntensity(){return logger.debug("TRACE: Material.roughnessIntensity (getter) - Entering."),logger.debug("TRACE: Material.roughnessIntensity (getter) - Exiting."),this._roughnessIntensity}set roughnessIntensity(e){if(logger.debug("TRACE: Material.roughnessIntensity (setter) - Entering."),this._roughnessIntensity=e,this._material().roughness=1-Number(this._roughnessIntensity),this._copies instanceof Array)for(let e of this._copies)e.roughness=1-Number(this._roughnessIntensity);logger.debug("TRACE: Material.roughnessIntensity (setter) - Exiting.")}get enableSpecularMap(){return logger.debug("TRACE: Material.enableSpecularMap (getter) - Entering."),logger.debug("TRACE: Material.enableSpecularMap (getter) - Exiting."),this._enableSpecularMap}set enableSpecularMap(e){if(logger.debug("TRACE: Material.enableSpecularMap (setter) - Entering."),"boolean"==typeof e){if(this._enableSpecularMap=e,this._enableSpecularMap)this.specularMap=this._specularMap;else if("specular"!==this.type&&(this._material().envMap=null,this._copies instanceof Array))for(let e of this._copies)e.envMap=null;logger.debug("TRACE: Material.enableSpecularMap (setter) - Exiting.")}else logger.debug("TRACE: Material.enableSpecularMap (setter) - Exiting.")}get specularMap(){return logger.debug("TRACE: Material.specularMap (getter) - Entering."),logger.debug("TRACE: Material.specularMap (getter) - Exiting."),this._specularMap}set specularMap({type:e,source:t}){if(logger.debug("TRACE: Material.specularMap (setter) - Entering."),"custom"===this._specularMapType)if("imagebitmap"===e.toLowerCase()&&(t instanceof Texture||util$1.isImage(t)||""===t)){if(this._specularMap.type="imagebitmap",this._specularMap._name=t.name,this._specularMap.source=t,!this._enableSpecularMap)return void logger.debug("TRACE: Material.specularMap (setter) - Exiting.");if(this._material()){let e=(new DDSLoader).load(this.url("texture/cubemap/CubeMap-CityDay-01_Cube.dds"),(function(e){e.magFilter=LinearFilter,e.minFilter=LinearFilter,e.mapping=CubeReflectionMapping}));this._material().envMap=e,this._material().envMap.needsUpdate=!0}if(this._copies instanceof Array)for(let e of this._copies)if(e){let t=(new DDSLoader).load(this.url("texture/cubemap/CubeMap-CityDay-01_Cube.dds"),(function(e){e.magFilter=LinearFilter,e.minFilter=LinearFilter,e.mapping=CubeReflectionMapping}));e.envMap=t,e.envMap.needsUpdate=!0}logger.debug("TRACE: Material.specularMap (setter) - Exiting.")}else if("file"!==e.toLowerCase()||"string"!=typeof t||""===t)logger.debug("TRACE: Material.specularMap (setter) - Exiting.");else{if(this._material()){if(this._specularMap.type="file",this._specularMap.source=t,this._material().envMap){let e=(new DDSLoader).load(this.url(t),(function(e){e.magFilter=LinearFilter,e.minFilter=LinearFilter,e.mapping=CubeReflectionMapping}));this._material().envMap=e}else{let e=(new DDSLoader).load(this.url(t),(function(e){e.magFilter=LinearFilter,e.minFilter=LinearFilter,e.mapping=CubeReflectionMapping}));this._material().envMap=e}this._material().envMap.needsUpdate=!0}if(this._copies instanceof Array)for(let e of this._copies)if(e){if(this._specularMap.type="file",this._specularMap.source=t,e.envMap){let r=(new DDSLoader).load(this.url(t),(function(e){e.magFilter=LinearFilter,e.minFilter=LinearFilter,e.mapping=CubeReflectionMapping}));e.envMap=r}else{let r=(new DDSLoader).load(this.url(t),(function(e){e.magFilter=LinearFilter,e.minFilter=LinearFilter,e.mapping=CubeReflectionMapping}));e.envMap=r}e.envMap.needsUpdate=!0}logger.debug("TRACE: Material.specularMap (setter) - Exiting.")}else logger.debug("TRACE: Material.specularMap (setter) - Exiting.")}get specularMapIntensity(){return logger.debug("TRACE: Material.specularMapIntensity (getter) - Entering."),logger.debug("TRACE: Material.specularMapIntensity (getter) - Exiting."),this._specularMapIntensity}set specularMapIntensity(e){if(logger.debug("TRACE: Material.specularMapIntensity (setter) - Entering."),this._specularMapIntensity=e,logger.debug("TRACE: Material.specularMapIntensity (setter) - Exiting."),this._material().envMapIntensity=this._specularMapIntensity*ENVMAP_FACTOR,this._copies instanceof Array)for(let e of this._copies)e.envMapIntensity=this._specularMapIntensity*ENVMAP_FACTOR}get enableNormalMap(){return logger.debug("TRACE: Material.enableNormalMap (getter) - Entering."),logger.debug("TRACE: Material.enableNormalMap (getter) - Exiting."),this._enableNormalMap}set enableNormalMap(e){if(logger.debug("TRACE: Material.enableNormalMap (setter) - Entering."),"boolean"==typeof e){if(this._enableNormalMap=e,this._enableNormalMap)this.normalMap={type:this._normalMap.type,source:this._normalMap.source,name:this._normalMap.name};else if(this._material().normalMap=null,this._material().bumpMap=null,this._copies instanceof Array)for(let e of this._copies)e.normalMap=null,e.bumpMap=null;logger.debug("TRACE: Material.enableNormalMap (setter) - Exiting.")}else logger.debug("TRACE: Material.enableNormalMap (setter) - Exiting.")}get normalMapType(){return logger.debug("TRACE: Material.normalMapType (getter) - Entering."),logger.debug("TRACE: Material.normalMapType (getter) - Exiting."),this._normalMapType}set normalMapType(e){if(logger.debug("TRACE: Material.normalMapType (setter) - Entering."),this._normalMapType=e,this._enableNormalMap){if(logger.debug("TRACE: Material.normalMapType (setter) - Exiting."),this._material()&&"imagebitmap"===this._normalMap.type&&("normal"===this._normalMapType?(this._material().bumpMap=null,this._material().bumpScale=0,this._normalMap.source?(this._material().normalMap?this._normalMap.source.textureSource?this._material().normalMap.image=this._normalMap.source.textureSource:this._material().normalMap.image=this._normalMap.source:(this._material().normalMap=new Texture$1(this._normalMap.source.textureSource||this._normalMap.source),this._material().normalMap.wrapS=1e3,this._material().normalMap.wrapT=1e3,this._material().normalMap.encoding=3001,this._material().normalMap.flipY=!1,this._material().normalMap.format=1022,this._material().normalMap.version=10,this.enableUV&&(this.enableUV=!0)),this._material().normalMap.needsUpdate=!0):this._material().normalMap=null,this._material().normalScale?(this._material().normalScale.x=this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._material().normalScale.y=this._material().normalScale.x):this._material().normalScale=new Vector2(this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity)):"bump"===this._normalMapType&&(this._material().normalMap=null,this._material().normalScale=null,this._normalMap.source?(this._material().bumpMap?this._normalMap.source.textureSource?this._material().bumpMap.image=this._normalMap.source.textureSource:this._material().bumpMap.image=this._normalMap.source:(this._material().bumpMap=new Texture$1(this._normalMap.source.textureSource||this._normalMap.source),this._material().bumpMap.wrapS=1e3,this._material().bumpMap.wrapT=1e3,this._material().bumpMap.encoding=3001,this._material().bumpMap.flipY=!1,this._material().bumpMap.format=1022,this._material().bumpMap.version=10,this.enableUV&&(this.enableUV=!0)),this._material().bumpMap.needsUpdate=!0):this._material().bumpMap=null,this._normalMapIntensity>=0&&this._normalMapIntensity<=1&&(this._material().bumpScale=this._normalMapIntensity)),this._material().needsUpdate=!0),this._copies instanceof Array)for(let e of this._copies)e&&"imagebitmap"===this._normalMap.type&&("normal"===this._normalMapType?(e.bumpMap=null,e.bumpScale=0,this._normalMap.source?(e.normalMap?this._normalMap.source.textureSource?e.normalMap.image=this._normalMap.source.textureSource:e.normalMap.image=this._normalMap.source:(e.normalMap=new Texture$1(this._normalMap.source.textureSource||this._normalMap.source),e.normalMap.wrapS=1e3,e.normalMap.wrapT=1e3,e.normalMap.encoding=3001,e.normalMap.flipY=!1,e.normalMap.format=1022,e.normalMap.version=10,this.enableUV&&(this.enableUV=!0)),e.normalMap.needsUpdate=!0):e.normalMap=null,e.normalScale?(e.normalScale.x=this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,e.normalScale.y=e.normalScale.x):e.normalScale=new Vector2(this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity)):"bump"===this._normalMapType&&(e.normalMap=null,e.normalScale=null,this._normalMap.source?(e.bumpMap?this._normalMap.source.textureSource?e.bumpMap.image=this._normalMap.source.textureSource:e.bumpMap.image=this._normalMap.source:(e.bumpMap=new Texture$1(this._normalMap.source.textureSource||this._normalMap.source),e.bumpMap.wrapS=1e3,e.bumpMap.wrapT=1e3,e.bumpMap.encoding=3001,e.bumpMap.flipY=!1,e.bumpMap.format=1022,e.bumpMap.version=10,this.enableUV&&(this.enableUV=!0)),e.bumpMap.needsUpdate=!0):e.bumpMap=null,this._normalMapIntensity>=0&&this._normalMapIntensity<=1&&(e.bumpScale=this._normalMapIntensity)))}else logger.debug("TRACE: Material.normalMapType (setter) - Exiting.")}get normalMap(){return logger.debug("TRACE: Material.normalMap (getter) - Entering."),logger.debug("TRACE: Material.normalMap (getter) - Exiting."),this._normalMap}set normalMap({type:e,source:t,name:r=""}){if(logger.debug("TRACE: Material.normalMap (setter) - Entering."),"imagebitmap"===e.toLowerCase()&&(t instanceof Texture||util$1.isImage(t)||""===t||void 0===t)){if(this._normalMap.type="imagebitmap",t&&void 0!==t.name?this._normalMap._name=t.name:this._normalMap._name=""!==r?r:null,t&&(t._textureSource?this._normalMap.source=t._textureSource:this._normalMap.source=t),""!==t&&void 0!==t||(this._normalMap.source=void 0),!this._enableNormalMap)return void logger.debug("TRACE: Material.normalMap (setter) - Exiting.");if(this._material()&&("normal"===this._normalMapType?(this._material().bumpMap=null,this._material().bumpScale=null,this._normalMap.source?(this._material().normalMap?this._normalMap.source.textureSource?this._material().normalMap.image=this._normalMap.source.textureSource:this._material().normalMap.image=this._normalMap.source:(this._material().normalMap=new Texture$1(this._normalMap.source.textureSource||this._normalMap.source),this._material().normalMap.wrapS=1e3,this._material().normalMap.wrapT=1e3,this._material().normalMap.encoding=3001,this._material().normalMap.flipY=!1,this._material().normalMap.format=1022,this._material().normalMap.version=10,this.enableUV&&(this.enableUV=!0)),this._material().normalMap.needsUpdate=!0):this._material().normalMap=null,this._material().normalScale?(this._material().normalScale.x=this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._material().normalScale.y=this._material().normalScale.x):this._material().normalScale=new Vector2(this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity)):"bump"===this._normalMapType&&(this._material().normalMap=null,this._material().normalScale=null,this._normalMap.source?(this._material().bumpMap?this._normalMap.source.textureSource?this._material().bumpMap.image=this._normalMap.source.textureSource:this._material().bumpMap.image=this._normalMap.source:(this._material().bumpMap=new Texture$1(this._normalMap.source.textureSource||this._normalMap.source),this._material().bumpMap.wrapS=1e3,this._material().bumpMap.wrapT=1e3,this._material().bumpMap.encoding=3001,this._material().bumpMap.flipY=!1,this._material().bumpMap.format=1022,this._material().bumpMap.version=10,this.enableUV&&(this.enableUV=!0)),this._material().bumpMap.needsUpdate=!0):this._material().bumpMap=null,this._normalMapIntensity>=0&&this._normalMapIntensity<=1&&(this._material().bumpScale=this._normalMapIntensity)),this._material().needsUpdate=!0),this._copies instanceof Array)for(let e of this._copies)e&&("normal"===this._normalMapType?(e.bumpMap=null,e.bumpScale=null,this._normalMap.source?(e.normalMap?this._normalMap.source.textureSource?e.normalMap.image=this._normalMap.source.textureSource:e.normalMap.image=this._normalMap.source:(e.normalMap=new Texture$1(this._normalMap.source.textureSource||this._normalMap.source),e.normalMap.wrapS=1e3,e.normalMap.wrapT=1e3,e.normalMap.encoding=3001,e.normalMap.flipY=!1,e.normalMap.format=1022,e.normalMap.version=10,this.enableUV&&(this.enableUV=!0)),e.normalMap.needsUpdate=!0):e.normalMap=null,e.normalScale?(e.normalScale.x=this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,e.normalScale.y=e.normalScale.x):e.normalScale=new Vector2(this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity)):"bump"===this._normalMapType&&(e.normalMap=null,e.normalScale=null,this._normalMap.source?(e.bumpMap?this._normalMap.source.textureSource?e.bumpMap.image=this._normalMap.source.textureSource:e.bumpMap.image=this._normalMap.source:(e.bumpMap=new Texture$1(this._normalMap.source.textureSource||this._normalMap.source),e.bumpMap.wrapS=1e3,e.bumpMap.wrapT=1e3,e.bumpMap.encoding=3001,e.bumpMap.flipY=!1,e.bumpMap.format=1022,e.bumpMap.version=10,this.enableUV&&(this.enableUV=!0)),e.bumpMap.needsUpdate=!0):e.bumpMap=null,this._normalMapIntensity>=0&&this._normalMapIntensity<=1&&(e.bumpScale=this._normalMapIntensity)));logger.debug("TRACE: Material.normalMap (setter) - Exiting.")}else e.toLowerCase(),logger.debug("TRACE: Material.normalMap (setter) - Exiting.")}get normalMapIntensity(){return logger.debug("TRACE: Material.normalMapIntensity (getter) - Entering."),logger.debug("TRACE: Material.normalMapIntensity (getter) - Exiting."),this._normalMapIntensity}set normalMapIntensity(e){if(logger.debug("TRACE: Material.normalMapIntensity (setter) - Entering."),this._normalMapIntensity=e,this._enableNormalMap){if("normal"===this._normalMapType?this._material().normalScale?(this._material().normalScale.x=this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._material().normalScale.y=this._material().normalScale.x):this._material().normalScale=new Vector2(this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity):"bump"===this._normalMapType&&this._normalMapIntensity>=0&&this._normalMapIntensity<=1&&(this._material().bumpScale=this._normalMapIntensity),this._material()&&(this._material().needsUpdate=!0),this._copies instanceof Array)for(let e of this._copies)"normal"===this._normalMapType?e.normalScale?(e.normalScale.x=this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,e.normalScale.y=e.normalScale.x):e.normalScale=new Vector2(this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity):"bump"===this._normalMapType&&this._normalMapIntensity>=0&&this._normalMapIntensity<=1&&(e.bumpScale=this._normalMapIntensity);logger.debug("TRACE: Material.normalMapIntensity (setter) - Exiting.")}else logger.debug("TRACE: Material.normalMapIntensity (setter) - Exiting.")}get normalMapTextureFlipY(){return logger.debug("TRACE: Material.normalMapTextureFlipY (getter) - Entering."),logger.debug("TRACE: Material.normalMapTextureFlipY (getter) - Exiting."),this._normalMapTextureFlipY}set normalMapTextureFlipY(e){if(logger.debug("TRACE: Material.normalMapTextureFlipY (setter) - Entering."),"boolean"==typeof e)if(this._normalMapTextureFlipY=e,this._enableNormalMap){if(this._material().normalScale?(this._material().normalScale.x=this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._material().normalScale.y=this._material().normalScale.x):this._material().normalScale=new Vector2(this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity),this._copies instanceof Array)for(let e of this._copies)e.normalScale?(e.normalScale.x=this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,e.normalScale.y=e.normalScale.x):e.normalScale=new Vector2(this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity);logger.debug("TRACE: Material.normalMapTextureFlipY (setter) - Exiting.")}else logger.debug("TRACE: Material.normalMapTextureFlipY (setter) - Exiting.");else logger.debug("TRACE: Material.normalMapTextureFlipY (setter) - Exiting.")}get enableDisplacement(){return logger.debug("TRACE: Material.enableDisplacement (getter) - Entering."),logger.debug("TRACE: Material.enableDisplacement (getter) - Exiting."),this._enableDisplacement}set enableDisplacement(e){if(logger.debug("TRACE: Material.enableDisplacement (setter) - Entering."),"boolean"==typeof e){if(this._enableDisplacement=e,this._enableDisplacement)this.displacementMap=this._displacementMap;else if(this._material().displacementMap=null,this._copies instanceof Array)for(let e of this._copies)e.displacementMap=null;this._material()&&(this._material().needsUpdate=!0),logger.debug("TRACE: Material.enableDisplacement (setter) - Exiting.")}else logger.debug("TRACE: Material.enableDisplacement (setter) - Exiting.")}get displacementMap(){return logger.debug("TRACE: Material.displacementMap (getter) - Entering."),logger.debug("TRACE: Material.displacementMap (getter) - Exiting."),this._displacementMap}set displacementMap({type:e,source:t}){if(logger.debug("TRACE: Material.displacementMap (setter) - Entering."),"imagebitmap"===e.toLowerCase()&&(t instanceof Texture||util$1.isImage(t)||""===t)){if(this._displacementMap.type="imagebitmap",this._displacementMap._name=t.name,t instanceof Texture&&(this._displacementMap.source=t),""===t&&(this._displacementMap.source=void 0),!this._enableDisplacement)return void logger.debug("TRACE: Material.displacementMap (setter) - Exiting.");if(this._material()&&(this._displacementMap.source?(this._material().displacementMap?this._material().displacementMap.image=this._displacementMap.source.textureSource:(this._material().displacementMap=new Texture$1(this._displacementMap.source.textureSource),this.enableUV&&(this.enableUV=!0)),this._material().displacementMap.needsUpdate=!0):this._material().displacementMap=null,this._material().needsUpdate=!0),this._copies instanceof Array)for(let e of this._copies)e&&(this._displacementMap.source?(e.displacementMap?e.displacementMap.image=this._displacementMap.source.textureSource:(e.displacementMap=new Texture$1(this._displacementMap.source.textureSource),this.enableUV&&(this.enableUV=!0)),e.displacementMap.needsUpdate=!0):e.displacementMap=null);logger.debug("TRACE: Material.displacementMap (setter) - Exiting.")}else e.toLowerCase(),logger.debug("TRACE: Material.displacementMap (setter) - Exiting.")}get displacementIntensity(){return logger.debug("TRACE: Material.displacementIntensity (getter) - Entering."),logger.debug("TRACE: Material.displacementIntensity (getter) - Exiting."),this._displacementIntensity}set displacementIntensity(e){if(logger.debug("TRACE: Material.displacementIntensity (setter) - Entering."),this._displacementIntensity=e,this._material().displacementScale=this._displacementIntensity,this._copies instanceof Array)for(let e of this._copies)e.displacementScale=this._displacementIntensity;logger.debug("TRACE: Material.displacementIntensity (setter) - Exiting.")}get enableOpacity(){return logger.debug("TRACE: Material.enableOpacity (getter) - Entering."),logger.debug("TRACE: Material.enableOpacity (getter) - Exiting."),this._enableOpacity}set enableOpacity(e){if(logger.debug("TRACE: Material.enableOpacity (setter) - Entering."),"boolean"==typeof e){if("water"!==this._type){if(this._enableOpacity=e,this._enableOpacity?(this._material().transparent=!0,this._material().opacity=this._opacityIntensity,this.opacityMap=this._opacityMap):(this._material().transparent=!1,this._material().opacity=1,this._material().alphaMap=null),this._copies instanceof Array)for(let e of this._copies)this._enableOpacity?(e.transparent=!0,e.opacity=this._opacityIntensity,this.opacityMap=this._opacityMap):(e.transparent=!1,e.opacity=1,e.alphaMap=null);logger.debug("TRACE: Material.enableOpacity (setter) - Exiting.")}}else logger.debug("TRACE: Material.enableOpacity (setter) - Exiting.")}get opacityType(){return logger.debug("TRACE: Material.opacityType (getter) - Entering."),logger.debug("TRACE: Material.opacityType (getter) - Exiting."),this._opacityType}set opacityType(e){if(logger.debug("TRACE: Material.opacityType (setter) - Entering."),"string"==typeof e){switch(e.toLowerCase()){case"blend":case"mask":case"refraction":case"refracting":break;default:return void logger.debug("TRACE: Material.opacityType (setter) - Exiting.")}switch(this._opacityType=e,this._opacityType.toLowerCase()){case"blend":case"mask":case"refraction":case"refracting":break;default:return void logger.debug("TRACE: Material.opacityType (setter) - Exiting.")}logger.debug("TRACE: Material.opacityType (setter) - Exiting.")}else logger.debug("TRACE: Material.opacityType (setter) - Exiting.")}get opacityMap(){return logger.debug("TRACE: Material.opacityMap (getter) - Entering."),logger.debug("TRACE: Material.opacityMap (getter) - Exiting."),this._opacityMap}set opacityMap({type:e,source:t}){if(logger.debug("TRACE: Material.opacityMap (setter) - Entering."),"imagebitmap"===e.toLowerCase()&&(t instanceof Texture||util$1.isImage(t)||""===t)){if(this._opacityMap.type="imagebitmap",this._opacityMap._name=t.name,t instanceof Texture&&(this._opacityMap.source=t),""===t&&(this._opacityMap.source=void 0),!this._enableOpacity)return void logger.debug("TRACE: Material.opacityMap (setter) - Exiting.");if(this._material()&&(this._opacityMap.source?(this._material().transparent=!0,this._material().opacity=this._opacityIntensity,this._material().alphaMap?this._material().alphaMap.image=this._opacityMap.source.textureSource:(this._material().alphaMap=new Texture$1(this._opacityMap.source.textureSource),this.enableUV&&(this.enableUV=!0)),this._material().alphaMap.needsUpdate=!0):this._material().alphaMap=null),this._copies instanceof Array)for(let e of this._copies)e&&(this._opacityMap.source?(e.transparent=!0,e.opacity=this._opacityIntensity,e.alphaMap?e.alphaMap.image=this._opacityMap.source.textureSource:(e.alphaMap=new Texture$1(this._opacityMap.source.textureSource),this.enableUV&&(this.enableUV=!0)),e.alphaMap.needsUpdate=!0):e.alphaMap=null);logger.debug("TRACE: Material.opacityMap (setter) - Exiting.")}else e.toLowerCase(),logger.debug("TRACE: Material.opacityMap (setter) - Exiting.")}get opacityIntensity(){return logger.debug("TRACE: Material.opacityIntensity (getter) - Entering."),logger.debug("TRACE: Material.opacityIntensity (getter) - Exiting."),this._opacityIntensity}set opacityIntensity(e){if(logger.debug("TRACE: Material.opacityIntensity (setter) - Entering."),this._opacityIntensity=e,this._enableOpacity){if(this._material()&&(this._material().transparent=!0,this._material().opacity=this._opacityIntensity),this._copies instanceof Array)for(let e of this._copies)e&&(e.transparent=!0,e.opacity=this._opacityIntensity);logger.debug("TRACE: Material.opacityIntensity (setter) - Exiting.")}else logger.debug("TRACE: Material.opacityIntensity (setter) - Exiting.")}get enableEmissive(){return logger.debug("TRACE: Material.enableEmissive (getter) - Entering."),logger.debug("TRACE: Material.enableEmissive (getter) - Exiting."),this._enableEmissive}set enableEmissive(e){if(logger.debug("TRACE: Material.enableEmissive (setter) - Entering."),"boolean"==typeof e){if(this._enableEmissive=e,this._enableEmissive)this.emissiveMap=this._emissiveMap,this.emissiveMapColor=this._emissiveMapColor;else if(this._material().emissiveMap=void 0,this._material().emissive.r=0,this._material().emissive.g=0,this._material().emissive.b=0,this._material().emissiveIntensity=0,this._copies instanceof Array)for(let e of this._copies)void 0===e.emissiveMap?e.emissiveMap=void 0:e.emissiveMap.image=void 0,e.emissive.r=0,e.emissive.g=0,e.emissive.b=0,e.emissiveIntensity=0;logger.debug("TRACE: Material.enableEmissive (setter) - Exiting.")}else logger.debug("TRACE: Material.enableEmissive (setter) - Exiting.")}get emissiveMapColor(){return this._emissiveMapColor}set emissiveMapColor(e){if(this._emissiveMapColor=e,this._enableEmissive){if(this._material()&&(this._material().emissive?this._material().emissive.setStyle(this._emissiveMapColor):this._material().emissive=new Color(this._emissiveMapColor),this._material().emissiveIntensity=this._emissiveIntensity),this._copies instanceof Array)for(let e of this._copies)e&&(e.emissive?e.emissive.setStyle(this._emissiveMapColor):e.emissive=new Color(this._emissiveMapColor),e.emissiveIntensity=this._emissiveIntensity);logger.debug("TRACE: Material.emissiveMap (setter) - Exiting.")}else logger.debug("TRACE: Material.emissiveMap (setter) - Exiting.")}get emissiveMap(){return logger.debug("TRACE: Material.emissiveMap (getter) - Entering."),logger.debug("TRACE: Material.emissiveMap (getter) - Exiting."),this._emissiveMap.color=this.emissiveMapColor,this._emissiveMap._color=this.emissiveMapColor,this._emissiveMap}set emissiveMap({type:e,source:t,reset:r=!1}){if(logger.debug("TRACE: Material.emissiveMap (setter) - Entering."),"color"===e.toLowerCase()){if(!util$1.isCSSColor(t))return void logger.debug("TRACE: Material.emissiveMap (setter) - Exiting.");this.emissiveMap._source?this.emissiveMap._name=this.emissiveMap._source._name:this.emissiveMap._name=void 0,this.emissiveMapColor=t,r&&(this._material().emissiveMap=void 0)}if("imagebitmap"===e.toLowerCase()&&(t instanceof Texture||util$1.isImage(t)||void 0===t||""===t)){if(this._emissiveMap._type="imagebitmap",this._emissiveMap._name=t?t.name:void 0,t instanceof Texture&&(this._emissiveMap.source=t),""!==t&&void 0!==t||(this._emissiveMap.source=void 0,this._material().emissiveMap=void 0),!this._enableEmissive)return void logger.debug("TRACE: Material.emissiveMap (setter) - Exiting.");if(this._material()&&(this._emissiveMap.source?(this._material().emissiveMap?(this._material().emissiveMap.image=this._emissiveMap.source.textureSource||this._emissiveMap.source,0==this._material().emissive.r&&0==this._material().emissive.g&&0==this._material().emissive.b&&(this._material().emissive.r=1,this._material().emissive.g=1,this._material().emissive.b=1)):(this._material().emissiveMap=new Texture$1(this._emissiveMap.source.textureSource||this._emissiveMap.source),this._material().emissiveMap.wrapS=1e3,this._material().emissiveMap.wrapT=1e3,this._material().emissiveMap.encoding=3001,this._material().emissiveMap.flipY=!1,this._material().emissiveMap.format=1022,this._material().emissiveMap.version=10,this.enableUV&&(this.enableUV=!0),0==this._material().emissive.r&&0==this._material().emissive.g&&0==this._material().emissive.b&&(this._material().emissive.r=1,this._material().emissive.g=1,this._material().emissive.b=1)),this._material().emissiveIntensity=this._emissiveIntensity,this._material().emissiveMap.needsUpdate=!0):this._material().emissiveMap=void 0),this._copies instanceof Array)for(let e of this._copies)e&&(this._emissiveMap.source?(e.emissiveMap?(e.emissiveMap.image=this._emissiveMap.source.textureSource||this._emissiveMap.source,e.emissive.r=1,e.emissive.g=1,e.emissive.b=1):(e.emissiveMap=new Texture$1(this._emissiveMap.source.textureSource||this._emissiveMap.source),e.emissiveMap.wrapS=1e3,e.emissiveMap.wrapT=1e3,e.emissiveMap.encoding=3001,e.emissiveMap.flipY=!1,e.emissiveMap.format=1022,e.emissiveMap.version=10,this.enableUV&&(this.enableUV=!0),0==e.emissive.r&&0==e.emissive.g&&0==e.emissive.b&&(e.emissive.r=1,e.emissive.g=1,e.emissive.b=1)),e.emissiveIntensity=this._emissiveIntensity,e.emissiveMap.needsUpdate=!0):e.emissiveMap=void 0);return this.emissiveMapColor=this._emissiveMapColor,void logger.debug("TRACE: Material.emissiveMap (setter) - Exiting.")}e.toLowerCase(),logger.debug("TRACE: Material.emissiveMap (setter) - Exiting.")}get emissiveIntensity(){return logger.debug("TRACE: Material.emissiveIntensity (getter) - Entering."),logger.debug("TRACE: Material.emissiveIntensity (getter) - Exiting."),this._emissiveIntensity}set emissiveIntensity(e){if(logger.debug("TRACE: Material.emissiveIntensity (setter) - Entering."),this._emissiveIntensity=e,this._material().emissiveIntensity=this._emissiveIntensity,this._copies instanceof Array)for(let e of this._copies)e.emissiveIntensity=this._emissiveIntensity;logger.debug("TRACE: Material.emissiveIntensity (setter) - Exiting.")}get enableLightMap(){return logger.debug("TRACE: Material.enableLightMap (getter) - Entering."),logger.debug("TRACE: Material.enableLightMap (getter) - Exiting."),this._enableLightMap}set enableLightMap(e){if(logger.debug("TRACE: Material.enableLightMap (setter) - Entering."),"boolean"==typeof e){if(this._enableLightMap=e,this._enableLightMap){if(this.lightMap=this._lightMap,this._relatedNodes instanceof Array)for(let e of this._relatedNodes)e.geometry&&e.geometry.attributes&&e.geometry.attributes.uv&&!e.geometry.attributes.uv2&&e.geometry.setAttribute("uv2",new BufferAttribute(e.geometry.attributes.uv.array,2))}else if(this._material().lightMap=null,this._copies instanceof Array)for(let e of this._copies)e.lightMap=null;logger.debug("TRACE: Material.enableLightMap (setter) - Exiting.")}else logger.debug("TRACE: Material.enableLightMap (setter) - Exiting.")}get lightMap(){return logger.debug("TRACE: Material.lightMap (getter) - Entering."),logger.debug("TRACE: Material.lightMap (getter) - Exiting."),this._lightMap}set lightMap({type:e,source:t}){if(logger.debug("TRACE: Material.lightMap (setter) - Entering."),"imagebitmap"===e.toLowerCase()&&t instanceof Texture||util$1.isImage(t)||""===t){if(this._lightMap.type="imagebitmap",this._lightMap._name=t.name,this._lightMap.source=t,!this._enableLightMap)return void logger.debug("TRACE: Material.lightMap (setter) - Exiting.");if(this._material()){if(this._material().lightMap?""===this._lightMap.source?this._material().lightMap=null:this._material().lightMap.image=this._lightMap.source.textureSource:(this._material().lightMap=new Texture$1(this._lightMap.source.textureSource),this.enableUV&&(this.enableUV=!0)),this._relatedNodes instanceof Array)for(let e of this._relatedNodes)e.geometry&&e.geometry.attributes&&e.geometry.attributes.uv&&!e.geometry.attributes.uv2&&e.geometry.setAttribute("uv2",new BufferAttribute(e.geometry.attributes.uv.array,2));this._material().lightMap&&(this._material().lightMap.needsUpdate=!0)}if(this._copies instanceof Array)for(let e of this._copies)if(e){if(e.lightMap?""===this._lightMap.source?e.lightMap=null:e.lightMap.image=this._lightMap.source.textureSource:(e.lightMap=new Texture$1(this._lightMap.source.textureSource),this.enableUV&&(this.enableUV=!0)),this._relatedNodes instanceof Array)for(let e of this._relatedNodes)e.geometry&&e.geometry.attributes&&e.geometry.attributes.uv&&!e.geometry.attributes.uv2&&e.geometry.setAttribute("uv2",new BufferAttribute(e.geometry.attributes.uv.array,2));e.lightMap&&(e.lightMap.needsUpdate=!0)}logger.debug("TRACE: Material.lightMap (setter) - Exiting.")}else e.toLowerCase(),logger.debug("TRACE: Material.lightMap (setter) - Exiting.")}get lightMapIntensity(){return logger.debug("TRACE: Material.lightMapIntensity (getter) - Entering."),logger.debug("TRACE: Material.lightMapIntensity (getter) - Exiting."),this._lightMapIntensity}set lightMapIntensity(e){if(logger.debug("TRACE: Material.lightMapIntensity (setter) - Entering."),this._lightMapIntensity=e,this._material().lightMapIntensity=this._lightMapIntensity,this._copies instanceof Array)for(let e of this._copies)e.lightMapIntensity=this._lightMapIntensity;logger.debug("TRACE: Material.lightMapIntensity (setter) - Exiting.")}get side(){return logger.debug("TRACE: Material.side (getter) - Entering."),logger.debug("TRACE: Material.side (getter) - Exiting."),this._side}set side(e){switch(logger.debug("TRACE: Material.side (setter) - Entering."),this._side=e,this._side){case 0:this._material().side=FrontSide;break;case 1:this._material().side=BackSide;break;case 2:this._material().side=DoubleSide}if(this._copies instanceof Array)for(let e of this._copies)switch(this._side){case 0:e.side=FrontSide;break;case 1:e.side=BackSide;break;case 2:e.side=DoubleSide}logger.debug("TRACE: Material.side (setter) - Exiting.")}get depth(){return logger.debug("TRACE: Material.depth (getter) - Entering."),logger.debug("TRACE: Material.depth (getter) - Exiting."),this._depth}set depth(e){switch(logger.debug("TRACE: Material.depth (setter) - Entering."),this._depth=e,this._depth){case 0:this._material().depthWrite=!1,this._material().depthTest=!1;break;case 1:this._material().depthWrite=!1,this._material().depthTest=!0;break;case 2:this._material().depthWrite=!0,this._material().depthTest=!0}if(this._copies instanceof Array)for(let e of this._copies)switch(this._depth){case 0:e.depthWrite=!1,e.depthTest=!1;break;case 1:e.depthWrite=!1,e.depthTest=!0;break;case 2:e.depthWrite=!0,e.depthTest=!0}logger.debug("TRACE: Material.depth (setter) - Exiting.")}get waterFlowSpeed(){return logger.debug("TRACE: Material.waterFlowSpeed (getter) - Entering."),logger.debug("TRACE: Material.waterFlowSpeed (getter) - Exiting."),this._waterFlowSpeed}set waterFlowSpeed(e){if(logger.debug("TRACE: Material.waterFlowSpeed (setter) - Entering."),this._waterFlowSpeed=e,"water"!=this._type)return;let t=util$1.findMeshByMaterial(_context.scene,this._material());for(let r of t)if(r.getObjectByName(r.name+this._material().name+"_water_")){let t=_context.animationStore.findMaterialAnimation(r.getObjectByName(r.name+this._material().name+"_water_").material,"WaterAnimationController");t&&(t.speed=e)}logger.debug("TRACE: Material.waterFlowSpeed (setter) - Exiting.")}get waterOffsetY(){return logger.debug("TRACE: Material.waterOffsetY (getter) - Entering."),logger.debug("TRACE: Material.waterOffsetY (getter) - Exiting."),this._waterOffsetY}set waterOffsetY(e){if(logger.debug("TRACE: Material.waterOffsetY (setter) - Entering."),this._waterOffsetY=e,"water"!=this._type)return;let t=util$1.findMeshByMaterial(_context.scene,this._material());for(let r of t){r.position.y=r.userData.y+e;let t=_context.defaultObjectTree.getItemByUUID(r.uuid);t&&(t.transformNode=_context.instance.getModelTransformByUUID(r.uuid))}logger.debug("TRACE: Material.waterOffsetY (setter) - Exiting.")}get waterColor(){return logger.debug("TRACE: Material.waterColor (getter) - Entering."),logger.debug("TRACE: Material.waterColor (getter) - Exiting."),this._waterColor}set waterColor(e){if(logger.debug("TRACE: Material.waterColor (setter) - Entering."),"water"!=this._type)return;this._waterColor=e;let t=util$1.findMeshByMaterial(_context.scene,this._material());for(let r of t){let t=r.getObjectByName(r.name+this._material().name+"_water_");t&&(t.material.uniforms.waterColor.value=new Color(e))}logger.debug("TRACE: Material.waterColor (setter) - Exiting.")}get waterReflectionAutoUpdate(){return logger.debug("TRACE: Material.waterReflectionAutoUpdate (getter) - Entering."),logger.debug("TRACE: Material.waterReflectionAutoUpdate (getter) - Exiting."),this._waterReflectionAutoUpdate}set waterReflectionAutoUpdate(e){if(logger.debug("TRACE: Material.waterReflectionAutoUpdate (setter) - Entering."),"water"!=this._type)return;this._waterReflectionAutoUpdate=e;let t=util$1.findMeshByMaterial(_context.scene,this._material());for(let r of t){let t=r.getObjectByName(r.name+this._material().name+"_water_");t&&(t.reflectionAutoUpdate=e,t.needsUpdate=!0)}logger.debug("TRACE: Material.waterReflectionAutoUpdate (setter) - Exiting.")}get waterReflectionQuality(){return logger.debug("TRACE: Material.waterReflectionQuality (getter) - Entering."),logger.debug("TRACE: Material.waterReflectionQuality (getter) - Exiting."),this._waterReflectionQuality}set waterReflectionQuality(e){if(logger.debug("TRACE: Material.waterReflectionQuality (setter) - Entering."),"water"!=this._type)return;this._waterReflectionQuality=e;let t=util$1.findMeshByMaterial(_context.scene,this._material());for(let r of t){let t=r.getObjectByName(r.name+this._material().name+"_water_");t&&t.getRenderTarget().setSize(e,e)}logger.debug("TRACE: Material.waterReflectionQuality (setter) - Exiting.")}get waterOpacity(){return logger.debug("TRACE: Material.waterOpacity (getter) - Entering."),logger.debug("TRACE: Material.waterOpacity (getter) - Exiting."),this._waterOpacity}set waterOpacity(e){if(logger.debug("TRACE: Material.waterOpacity (setter) - Entering."),this._waterOpacity=e,"water"!=this._type)return;let t=util$1.findMeshByMaterial(_context.scene,this._material());for(let r of t){let t=r.getObjectByName(r.name+this._material().name+"_water_");t&&(t.material.uniforms.alpha.value=e)}logger.debug("TRACE: Material.waterOpacity (setter) - Exiting.")}get waterReflectionRate(){return logger.debug("TRACE: Material.waterReflectionRate (getter) - Entering."),logger.debug("TRACE: Material.waterReflectionRate (getter) - Exiting."),this._waterReflectionRate}set waterReflectionRate(e){if(logger.debug("TRACE: Material.waterReflectionRate (setter) - Entering."),this._waterReflectionRate=e,"water"!=this._type)return;let t=util$1.findMeshByMaterial(_context.scene,this._material());for(let r of t){let t=r.getObjectByName(r.name+this._material().name+"_water_");t&&(t.material.uniforms.reflectionRate.value=e)}logger.debug("TRACE: Material.waterReflectionRate (setter) - Exiting.")}get waterWave(){return logger.debug("TRACE: Material.waterWave (getter) - Entering."),logger.debug("TRACE: Material.waterWave (getter) - Exiting."),this._waterWave}set waterWave(e){if(logger.debug("TRACE: Material.waterWave (setter) - Entering."),this._waterWave=e,"water"!=this._type)return;let t=util$1.findMeshByMaterial(_context.scene,this._material());for(let r of t){let t=r.getObjectByName(r.name+this._material().name+"_water_");t&&(t.material.uniforms.distortionScale.value=e)}logger.debug("TRACE: Material.waterWave (setter) - Exiting.")}get enableSSR(){return logger.debug("TRACE: Material.enableSSR (getter) - Entering."),logger.debug("TRACE: Material.enableSSR (getter) - Exiting."),this._enableSSR}set enableSSR(e){if(logger.debug("TRACE: Material.enableSSR (setter) - Entering."),"boolean"==typeof e){if(_context&&_context.effectStore&&_context.effectStore.visualEffect&&_context.effectStore.visualEffect._passes&&_context.effectStore.visualEffect._passes.ssrPass&&_context.effectStore.visualEffect._passes.ssrPass.ssrEffect){if(this._enableSSR=e,this._enableSSR){_context.effectStore.visualEffect._passes.ssrPass.ssrEffect.selects||(_context.effectStore.visualEffect._passes.ssrPass.ssrEffect.selects=[]);for(let e=0;e<this._relatedNodes.length;e++)_context.effectStore.visualEffect._passes.ssrPass.ssrEffect.selects.includes(this._relatedNodes[e])||_context.effectStore.visualEffect._passes.ssrPass.ssrEffect.selects.push(this._relatedNodes[e])}this._material().disableSSR=!this._enableSSR,logger.debug("TRACE: Material.enableSSR (setter) - Exiting.")}}else logger.debug("TRACE: Material.enableSSR (setter) - Exiting.")}get enableSSRMirror(){return logger.debug("TRACE: Material.enableSSR (getter) - Entering."),logger.debug("TRACE: Material.enableSSR (getter) - Exiting."),this._enableSSR}set enableSSRMirror(e){if(logger.debug("TRACE: Material.enableSSR (setter) - Entering."),"boolean"==typeof e){if(this._enableSSR=e,this._enableSSR){this._enableSSR=!0;let e=null;for(let t=0;t<_context.envMapIntensity.length;t++)_context.envMapIntensity[t].name===this.material().name&&_context.envMapIntensity[t].modelName===this._modelName&&(e=_context.envMapIntensity[t]);e?e.Intensity=this._envMapIntensity:_context.envMapIntensity.push({name:this.material().name,modelName:this._modelName,Intensity:1}),this._relatedNodes.forEach((e=>{let t,r=_context.instance.defaultObjectTree.getItemByName(this._modelName);for(let n=0;n<r.children.length&&(t=util$1.findModelItemNodeByName(r.children[n],e.name),!t);n++);t&&t.enableSSR&&_context.instance.addCubeCamera(this._modelName,e,this._name)}))}else{this._enableSSR=!1;for(let e=0;e<_context.envMapIntensity.length;e++)_context.envMapIntensity[e].name===this.material().name&&_context.envMapIntensity[e].modelName===this._modelName&&(_context.envMapIntensity[e].Intensity=1);setTimeout((()=>{this._relatedNodes.forEach((e=>{for(let t=0;t<_context.ssr.length;t++)if(_context.ssr[t].nodeName===e.name&&_context.ssr[t].modelName===this._modelName){if(!_context.instance.findMaterialInModel(_context.ssr[t].modelName,_context.ssr[t].materialName)._material().envMap)return;_context.instance.findMaterialInModel(_context.ssr[t].modelName,_context.ssr[t].materialName)._material().envMap.dispose(),_context.instance.findMaterialInModel(_context.ssr[t].modelName,_context.ssr[t].materialName)._material().envMap=null,_context.ssr.splice(t,1),t--}}))}),10)}logger.debug("TRACE: Material.enableSSR (setter) - Exiting.")}else logger.debug("TRACE: Material.enableSSR (setter) - Exiting.")}get envMapIntensity(){return logger.debug("TRACE: Material.enableSSR (getter) - Entering."),logger.debug("TRACE: Material.enableSSR (getter) - Exiting."),this._envMapIntensity}set envMapIntensity(e){}get enableTranslation(){return logger.debug("TRACE: Material.enableTranslation (getter) - Entering."),logger.debug("TRACE: Material.enableTranslation (getter) - Exiting."),this._enableTranslation}set enableTranslation(e){logger.debug("TRACE: Material.enableTranslation (setter) - Entering."),this._enableTranslation=e,logger.debug("TRACE: Material.enableTranslation (setter) - Exiting.")}get translationSpeedU(){return logger.debug("TRACE: Material.translationSpeedU (getter) - Entering."),logger.debug("TRACE: Material.translationSpeedU (getter) - Exiting."),this._translationSpeedU}set translationSpeedU(e){logger.debug("TRACE: Material.translationSpeedU (setter) - Entering."),this._translationSpeedU=e,logger.debug("TRACE: Material.translationSpeedU (setter) - Exiting.")}get translationSpeedV(){return logger.debug("TRACE: Material.translationSpeedV (getter) - Entering."),logger.debug("TRACE: Material.translationSpeedV (getter) - Exiting."),this._translationSpeedV}set translationSpeedV(e){logger.debug("TRACE: Material.translationSpeedV (setter) - Entering."),this._translationSpeedV=e,logger.debug("TRACE: Material.translationSpeedV (setter) - Exiting.")}get enableUV(){return logger.debug("TRACE: Material.enableUV (getter) - Entering."),logger.debug("TRACE: Material.enableUV (getter) - Exiting."),this._enableUV}set enableUV(e){if(logger.debug("TRACE: Material.enableUV (setter) - Entering."),this._enableUV=e,this._enableUV){let e=this._findFirstAvailableMapForUV();e&&(this._material()._uvDefault||(this._material()._uvDefault={wrapS:e.wrapS,wrapT:e.wrapT,repeat:e.repeat?e.repeat.clone():void 0,offset:e.offset?e.offset.clone():void 0}),e.wrapS=RepeatWrapping,e.wrapT=RepeatWrapping,e.repeat.set(this.repeatU,this.repeatV),e.offset.set(this.offsetU,this.offsetV))}else{let e=this._findFirstAvailableMapForUV();e&&this._material()._uvDefault&&(e.wrapS=this._material()._uvDefault.wrapS,e.wrapT=this._material()._uvDefault.wrapT,e.repeat.set(this._material()._uvDefault.repeat.x,this._material()._uvDefault.repeat.y),e.offset.set(this._material()._uvDefault.offset.x,this._material()._uvDefault.offset.y))}logger.debug("TRACE: Material.enableUV (setter) - Exiting.")}get repeatU(){return logger.debug("TRACE: Material.repeatU (getter) - Entering."),logger.debug("TRACE: Material.repeatU (getter) - Exiting."),this._repeatU}set repeatU(e){if(logger.debug("TRACE: Material.repeatU (setter) - Entering."),this._repeatU=e,this._enableUV){let e=this._findFirstAvailableMapForUV();e&&(e.wrapS=RepeatWrapping,e.repeat.x=this._repeatU)}logger.debug("TRACE: Material.repeatU (setter) - Exiting.")}get repeatV(){return logger.debug("TRACE: Material.repeatV (getter) - Entering."),logger.debug("TRACE: Material.repeatV (getter) - Exiting."),this._repeatV}set repeatV(e){if(logger.debug("TRACE: Material.repeatV (setter) - Entering."),this._repeatV=e,this._enableUV){let e=this._findFirstAvailableMapForUV();e&&(e.wrapT=RepeatWrapping,e.repeat.y=this._repeatV)}logger.debug("TRACE: Material.repeatV (setter) - Exiting.")}get offsetU(){return logger.debug("TRACE: Material.offsetU (getter) - Entering."),logger.debug("TRACE: Material.offsetU (getter) - Exiting."),this._offsetU}set offsetU(e){if(logger.debug("TRACE: Material.offsetU (setter) - Entering."),this._offsetU=e,this._enableUV){let e=this._findFirstAvailableMapForUV();e&&(e.offset.x=this.offsetU)}logger.debug("TRACE: Material.offsetU (setter) - Exiting.")}get offsetV(){return logger.debug("TRACE: Material.offsetV (getter) - Entering."),logger.debug("TRACE: Material.offsetV (getter) - Exiting."),this._offsetV}set offsetV(e){if(logger.debug("TRACE: Material.offsetV (setter) - Entering."),this._offsetV=e,this._enableUV){let e=this._findFirstAvailableMapForUV();e&&(e.offset.y=this.offsetV)}logger.debug("TRACE: Material.offsetV (setter) - Exiting.")}get relatedNodes(){return logger.debug("TRACE: Material.relatedNodes (getter) - Entering."),logger.debug("TRACE: Material.relatedNodes (getter) - Exiting."),this._relatedNodes}set resourceBasePath(e){this._resourceBasePath=e}get modelName(){return this._modelName}set modelName(e){}url(e){return`${this._resourceBasePath}///${e}`.replace("/////","/").replace("////","/").replace("///","/")}getSettings(){let e={};for(var t in this)t.indexOf("_")>-1&&-1==t.indexOf("relatedNodes")&&(e[t.replace("_","")]=this[t.replace("_","")]);return e}_findFirstAvailableMapForUV(){if(this._material())return this._material().map||this._material().specularMap||this._material().displacementMap||this._material().normalMap||this._material().bumpMap||this._material().roughnessMap||this._material().metalnessMap||this._material().alphaMap||this._material().emissiveMap}}Material._toThreeObject=function(e,t){new MeshPhongMaterial},Material._fromThreeObject=function(e,t=""){if(!e)return;let r=new Material({materialOfThree:e,id:e.uuid,name:e.name,type:"metalness",mapType:"metalness",color:e.color,map:e.map,mapIntensit:e.mapIntensit,metalnessMap:e.metalnessMap,metalnessIntensity:e.metalness,roughnessMap:e.roughnessMap,roughnessIntensity:e.roughness,enableSpecularMap:!!e.envMap,specularMapType:e.envMap?"custom":"envmap",specularMap:e.envMap,specularMapIntensity:e.envMapIntensity/ENVMAP_FACTOR,enableNormalMap:!!e.normalMap,normalMapType:"",normalMap:e.normalMap,normalMapFlipY:e.normalMapFlipY,normalMapIntensity:e.normalScale?e.normalScale.x:1,enableDisplacement:!!e.displacementMap,displacementMap:e.displacementMap,displacementIntensity:e.displacementScale,enableOpacity:!!e.alphaMap,opacityType:"blend",opacityMap:e.alphaMap,opacityIntensity:1,opacityInverted:!1,emissive:e.emissive,enableEmissive:!!e.emissiveMap||0!==e.emissive.r||0!==e.emissive.g||0!==e.emissive.b,emissiveMap:e.emissiveMap,emissiveIntensity:e.emissiveIntensity,enableLightMap:!!e.lightMap,lightMap:e.lightMap,lightMapIntensity:e.lightMapIntensity,enableSSR:e.enableSSR,envMapIntensity:e.envMapIntensity,side:e.side,depth:e.depthTest&&e.depthWrite?2:e.depthTest||e.depthWrite?1:0});return r._resourceBasePath=t,r};class MaterialStore{constructor(e,t){this._materials=new Object,this._textureStore=e,this._context=t}add(e,t,r,n){let i=this._materials[e];if(void 0!==i)if(i._material().uuid===t.uuid)i.addRelatedNode(r);else{if(r.material instanceof Array){for(let e=0;e<r.material.length;e++)if(r.material[e].name===i.name){r.material[e]=i._material();break}}else r.material=i._material();i.addRelatedNode(r)}else this._materials[e]=Material._fromThreeObject(t,this._context.resourceBasePath),this._materials[e].addRelatedNode(r),this._materials[e].addModelName(n)}clear(){this._materials=[]}find(e){return this._materials[e]}getAll(){return this._materials}remove(e){if(null!=this._materials[e])return delete this._materials[e],!0}getSettings(){let e={};for(let t in this._materials){let r={};for(let e in this._materials[t])"_id"!==e&&"_material"!==e&&"_relatedNodes"!==e&&"_copies"!==e&&"function"!=typeof this._materials[t][e]&&(this._materials[t][e]instanceof Map$1?(r[e.replace("_","")]=this._materials[t][e],r[e.replace("_","")]._id&&delete r[e.replace("_","")]._id):r[e.replace("_","")]=this._materials[t][e]);e[t]=r}return e}applySettings(e){if(e)for(let t in e){let r=this.find(t);if(r){for(let n in e[t])if(r[n]instanceof Map$1){for(let r in e[t][n])e[t][n][r.replace("_","")]=e[t][n][r];switch(e[t][n].type){case"imagebitmap":r[n]={type:"imagebitmap",source:e[t][n].source instanceof ImageBitmap?e[t][n].source:void 0!==e[t][n].name?this._textureStore.find(e[t][n].name):this._textureStore.find(t+"#"+n),reset:!0};break;case"color":r[n]={...e[t][n],reset:!0};break;case"file":default:r[n]=e[t][n]}}else r[n]=e[t][n];e[t].color&&(r.color=e[t].color),this._context&&this._context.setMaterialAnimation({name:t,enableTranslation:r.enableTranslation,translationSpeedU:util$1.numberOrDefault(r.translationSpeedU,0),translationSpeedV:util$1.numberOrDefault(r.translationSpeedV,0),modelName:r._modelName})}}else logger.error("无效的材质设置。")}}class ArticulationAnimationItem{constructor({startTime:e,continueTime:t,articulationName:r,startState:n,endState:i,modelId:a}){this.startTime=Number(e),this.continueTime=Number(t),this.articulationName=r,this.startState=n,this.endState=i;let o=a;this.getModelId=()=>o}get modelId(){return this.getModelId()}}class ArticulationAnimation{constructor(e,t){this.animationName=e,this.animationType=AnimationTypes.NONE,this.animationSpeed=1;let r=t;this.isEnable=!0,this.articulationAnimationItems=[];let n=[];this.addAnimationItem=({startTime:e,continueTime:t,articulationName:n,startState:i,endState:a})=>{let o=new ArticulationAnimationItem({startTime:e,continueTime:t,articulationName:n,startState:i,endState:a,modelId:r});this.articulationAnimationItems.push(o)},this.play=e=>{let t=_context.animationStore.findAnimation(r+this.animationName,ArticulationAnimationGroupController.type);t&&(t.reset(),_context.animationStore.remove(t)),t=new ArticulationAnimationGroupController(r+this.animationName,this.animationType,this.animationSpeed,this.articulationAnimationItems,e),_context.animationStore.add(t),this.animationType==AnimationTypes.NONE&&n.push(t)},this.pause=()=>{let e=_context.animationStore.findAnimation(r+this.animationName,ArticulationAnimationGroupController.type);e&&e.pause()},this.resume=()=>{let e=_context.animationStore.findAnimation(r+this.animationName,ArticulationAnimationGroupController.type);e&&e.resume()},this.reset=()=>{let e=_context.animationStore.findAnimation(r+this.animationName,ArticulationAnimationGroupController.type);if(e&&(e.reset(),_context.animationStore.remove(e)),this.animationType==AnimationTypes.NONE){let e=n.findIndex((e=>e.animationName==r+this.animationName));e>-1&&(n[e].reset(),n.splice(e,1))}},this.delete=()=>{let e=_context.animationStore.findAnimation(r+this.animationName,ArticulationAnimationGroupController.type);e&&(e.reset(),_context.animationStore.remove(e))},this.getParentUUId=()=>r}get parentUUId(){return this.getParentUUId}}class ModelItem extends ObjectTreeItem{constructor({id:e=util$1.guid(),name:t,modelPath:r,transform:n,children:i=[],isVisible:a,isLock:o,index:s,parent:l,loadModel:c,parentUUID:h},u,d,p){super("ModelItem"),this.id=e,this.name=t||this.id,this.modelPath=r,this.children=i,this.materialStore=new MaterialStore(_context.textureStore,_context.instance),this.type="ModelItem",this.index=s,this.parent=l,this.articulations=[],this.articulationAnimations=[],this.parentUUID=h;let f=p||null;var m;this.addArticulation=({type:e,name:t,values:r,defaultValue:n})=>{let i=new Articulation({type:e,name:t,values:r,defaultValue:n});i.isValid()&&(i.getModelNode=()=>m,i._type=i.getType(),i._name=i.getName(),i._values=i.getValues(),i._defaultValue=i.getDefaultValue(),this.articulations.push(i))},this.deleteArticulation=e=>{let t=this.articulations.findIndex((t=>t.name==e));this.articulations[t].deleteArticulation(),this.articulations.splice(t,1)},this.addArticulationAnimation=e=>{let t=new ArticulationAnimation(e,this.name);this.articulationAnimations.push(t)},this.playArticulationAnimation=(e,t)=>{let r=this.articulationAnimations.find((t=>t.animationName===e));r&&r.play(t)},this.pauseArticulationAnimation=e=>{let t=this.articulationAnimations.find((t=>t.animationName===e));t&&t.pause()},this.resumeArticulationAnimation=e=>{let t=this.articulationAnimations.find((t=>t.animationName===e));t&&t.resume()},this.resetArticulationAnimation=e=>{let t=this.articulationAnimations.find((t=>t.animationName===e));t&&t.reset()},this.deleteArticulationAnimation=e=>{let t=this.articulationAnimations.findIndex((t=>t.animationName===e));t>-1&&(this.articulationAnimations[t].delete(),this.articulationAnimations.splice(t,1))},this.materialStore.getModelNode=()=>m,this.getGroup=()=>m,this.findMaterial=e=>this.materialStore.find(e),this.getMaterials=()=>this.materialStore.getAll(),this.applyState=()=>{if(m&&""!==_context.stateStore.getCurrentState()){let e=_context.stateStore.findState(_context.stateStore.getCurrentState());e.settings.models&&e.settings.models[this.name]&&"boolean"==typeof e.settings.models[this.name].visible&&(m.visible=e.settings.models[this.name].visible)}},this.scale=(e=1,t=1,r=1)=>{m&&m.scale.set(e,t,r)},this.translate=(e=0,t=0,r=0)=>{m&&m.position.set(e,t,r)},this.rotateX=e=>{m&&m.rotateX(util$1.degreeToRadian(e))},this.rotateY=e=>{m&&m.rotateY(util$1.degreeToRadian(e))},this.rotateZ=e=>{m&&m.rotateZ(util$1.degreeToRadian(e))},this.findNode=(e="")=>util$1.findNodeRecursively(e,m),this.hideNode=(e="")=>{let t=util$1.findNodeRecursively(e,m);t&&(t.visible=!1)},this.showNode=(e="")=>{let t=util$1.findNodeRecursively(e,m);t&&(t.visible=!0)},this.getSettings=()=>(m&&(this.transform.position=m.position,this.transform.rotation=m.rotation,this.transform.scale=m.scale),{id:this.id,name:this.name,modelPath:this.modelPath,articulations:this.articulations,articulationAnimations:this.articulationAnimations,children:this.children,materials:this.materialStore.getSettings(),transform:this.transform,type:this.getType(),isVisible:this._getVisible(),isLock:this._getLock(),index:this.index,parent:this.parent}),this.addModel=(e,t,r)=>(logger.debug("TRACE: ModelItem.addModel() - Entering.",e),e=e||{},logger.debug("TRACE: ModelItem.addModel() - Leaving and return a Promise."),new Promise(((n,i)=>{_context.loaders.gltfLoader||(t&&t(0,"No loader initiated."),i(new Error("No loader initiated."))),e.name||(e.name=util$1.guid()),-1!=e.modelPath.indexOf("[[origin]]")?e.modelPath.replace("[[origin]]",_context.origin):e.modelPath,_context.cacheStore.load({path:e.modelPath,type:"glb",onLoad:r=>{(m=r).name=e.name,e.transform&&(e.transform.position&&null!=e.transform.position.x&&m.position.set(e.transform.position.x,e.transform.position.y,e.transform.position.z),e.transform.rotation&&null!=e.transform.rotation._x&&(m.rotation.x=e.transform.rotation._x,m.rotation.y=e.transform.rotation._y,m.rotation.z=e.transform.rotation._z),e.transform.scale&&(null!=e.transform.scale.x?m.scale.set(e.transform.scale.x,e.transform.scale.y,e.transform.scale.z):"number"==typeof e.transform.scale&&m.scale.set(e.transform.scale,e.transform.scale,e.transform.scale))),f?f.add(m):_context.scene.models.add(m),m.traverse((t=>{if(util$1.capableForCastingShadow(t)&&(t.castShadow=!0,t.receiveShadow=!0),t.material instanceof Array){for(let r of t.material)if(r instanceof MeshStandardMaterial){r.alphaTest=.05,r.depthWrite=!0,r.depthTest=!0,r.vertexColors=!1,r.needsUpdate=!0,this.materialStore.add(r.name,r,t,e.name);for(let e in r)r[e]instanceof Texture$1&&r[e].image&&_context.textureStore.add(r[e].name||`${r.name}#${e}`,r[e])}}else if(t.material instanceof MeshStandardMaterial){t.material.alphaTest=.05,t.material.depthWrite=!0,t.material.depthTest=!0,t.material.vertexColors=!1,t.material.needsUpdate=!0,this.materialStore.add(t.material.name,t.material,t,e.name);for(let e in t.material)t.material[e]instanceof Texture$1&&t.material[e].image&&_context.textureStore.add(t.material[e].name||`${t.material.name}#${e}`,t.material[e])}})),this.children=Node._fromThreeObject(m).children,e.isVisible=null==e.isVisible||e.isVisible,e.isVisible?this.show():this.hide(),this._setLock(e.isLock),n(),setTimeout((()=>{_context.instance.focus(),t&&t(1,r)}),500),_context.paintControls&&_context.paintControls.updateWorld()},onProgress:r,onError:e=>{t?t(0,e):logger.debug(e),i(e)}})}))),null!=c&&c instanceof Object3D?((m=c).traverse((e=>{if(util$1.capableForCastingShadow(e)&&(e.castShadow=!0,e.receiveShadow=!0),e.material instanceof Array){for(let t of e.material)if(t instanceof MeshStandardMaterial){t.alphaTest=.05,t.depthWrite=!0,t.depthTest=!0,t.vertexColors=!1,t.needsUpdate=!0,this.materialStore.add(t.name,t,e,c.name);for(let e in t)t[e]instanceof Texture$1&&t[e].image&&_context.textureStore.add(t[e].name||`${t.name}#${e}`,t[e])}}else if(e.material instanceof MeshStandardMaterial){e.material.alphaTest=.05,e.material.depthWrite=!0,e.material.depthTest=!0,e.material.vertexColors=!1,e.material.needsUpdate=!0,this.materialStore.add(e.material.name,e.material,e,c.name);for(let t in e.material)e.material[t]instanceof Texture$1&&e.material[t].image&&_context.textureStore.add(e.material[t].name||`${e.material.name}#${t}`,e.material[t])}})),this.children=Node._fromThreeObject(m).children):this.addModel({name:t,modelPath:r,transform:n,isVisible:a,isLock:o},u,d)}}class BuildingFloorItem extends ObjectTreeItem{constructor({name:e="untitled",level:t,parent:r,children:n,isVisible:i,isLock:a,transform:o,loadModel:s,parentUUID:l},c,h,u){if(super("BuildingFloorItem"),-1!=e.indexOf("/"))return void logger.warn('创建文件夹中名称不能使用"/"');let d=c;var p=s||new Group;if(p.name=e,this.name=e,this.type="BuildingFloorItem",this.level=Number(t),this.parent=r,this.parentUUID=l,this.children=[],this.transform=o||this.transform,p.position.set(this.transform.position.x,this.transform.position.y,this.transform.position.z),p.scale.set(this.transform.scale.x,this.transform.scale.y,this.transform.scale.z),p.rotation.set(this.transform.rotation._x,this.transform.rotation._y,this.transform.rotation._z),s||c.add(p),this.getGroup=()=>p,this.getParentGroup=()=>d,this.addItem=e=>{this.children.push(e)},this.addNoneFloor=(e,t,r)=>{if(!this.children.find((t=>t.name===e.name))||e.loadModel)switch(e.parent=this.name,e.parentUUID=this.getGroup().uuid,e.isNoExcursion||(e=util$1.changeTransformFromBuildind(e,d,p)),e.type){case"ModelItem":this.addItem(new ModelItem(e,t,(t=>{r&&r({name:e.name,parent:this.name,loaded:t.loaded})}),p));break;case"IconAsset":this.addItem(new IconItem(e,p,t))}else logger.warn(`当前位置已经存在名称为“${e.name}”的模型。`)},this.getItemByName=e=>{let t=this.children.find((t=>t.name===e));if(t)return t},this.getSettings=()=>(p&&(this.transform.position=p.position,this.transform.rotation=p.rotation,this.transform.scale=p.scale),{name:this.name,children:this.children,transform:this.transform,type:this.type,isVisible:this._getVisible(),isLock:this._getLock(),level:this.level,parent:this.parent,index:this.index}),null!=n&&n.length>0){let e=this;null!=s&&s?n.map((t=>{s.children.map((r=>{r.name===t.name&&(t.loadModel=r,t.isNoExcursion=!0,e.addNoneFloor(t,h,u))}))})):n.map((t=>{t.isNoExcursion=!0,e.addNoneFloor(t,h,u)}))}else h&&h(1);i?this.show():this.hide(),i?this.show():this.hide(),a?this.lock():this.unLock()}}class BuildingItem extends ObjectTreeItem{constructor({name:e="untitled",index:t,parent:r,children:n,isVisible:i,isLock:a,transform:o,loadModel:s,floor:l,parentUUID:c},h,u,d){if(super("BuildingItem"),-1==e.indexOf("/")){this.name=e,this.children=[];var p=s||new Group;if(p.name=e,this.type="BuildingItem",this.parent=r,this.parentUUID=c,this.index=t,this.floor=l,this.transform=o||this.transform,p.position.set(this.transform.position.x,this.transform.position.y,this.transform.position.z),p.scale.set(this.transform.scale.x,this.transform.scale.y,this.transform.scale.z),p.rotation.set(this.transform.rotation._x,this.transform.rotation._y,this.transform.rotation._z),s||h.add(p),this.getGroup=()=>p,this.addItem=e=>{this.children.push(e),this.children=this.children.sort(this.compare("level",!1))},this.compare=(e,t)=>(r,n)=>{var i=r[e],a=n[e];return t?i-a:a-i},this.addFloor=(e,t,r)=>{!p.children.find((t=>t.name===e.name))||e.loadModel?(e.parent=this.name,e.parentUUID=this.getGroup().uuid,e.isVisible=null==e.isVisible||e.isVisible,e.isLock=null!=e.isLock&&e.isLock,this.addItem(new BuildingFloorItem(e,p,t,r))):logger.warn(`当前位置已经存在名称为“${e.name}”的模型。`)},this.addNoneFloor=(e,t,r)=>{if(!p.children.find((t=>t.name===e.name))||e.loadModel)switch(e.parent=this.name,e.parentUUID=this.getGroup().uuid,e.isNoExcursion||(e=util$1.changeTransformFromBuildind(e,p)),e.type){case"ModelItem":this.addItem(new ModelItem(e,t,(t=>{r&&r({name:e.name,parent:this.name,loaded:t.loaded})}),p));break;case"IconAsset":this.addItem(new IconItem(e,p,t))}else logger.warn(`当前位置已经存在名称为“${e.name}”的模型。`)},this.getItemByName=e=>{let t=this.children.find((t=>t.name===e));if(t)return t},this.getSettings=()=>(p&&(this.transform.position=p.position,this.transform.rotation=p.rotation,this.transform.scale=p.scale),{name:this.name,children:this.children,transform:this.transform,type:this.type,parent:this.parent,isVisible:this._getVisible(),isLock:this._getLock(),index:this.index,floor:this.floor}),null!=n&&n.length>0){let e=this;null!=s&&s?n.map((t=>{s.children.map((r=>{r.name===t.name&&(t.loadModel=r,"ModelItem"===t.type||"IconAsset"===t.type?(t.isNoExcursion=!0,e.addNoneFloor(t,u,d)):"BuildingFloorItem"===t.type&&e.addFloor(t,u,d))}))})):n.map((t=>{"ModelItem"===t.type||"IconAsset"===t.type?(t.isNoExcursion=!0,e.addNoneFloor(t,u,d)):"BuildingFloorItem"===t.type&&e.addFloor(t,u,d)}))}else u&&u(1);i?this.show():this.hide(),a?this.lock():this.unLock()}else logger.warn('创建文件夹中名称不能使用"/"')}}class FolderItem extends ObjectTreeItem{constructor(e="untitled",t={},r){if(super("FolderItem"),this.name=e,-1==e.indexOf("/")){this.children=[],this.path=t.path?t.path+"/"+e:"/"+e;var n=new Group;n.name=e,_context.scene.noneModels.add(n),this.type="FolderItem",this.index=r,this.group=()=>n,this.addItem=(e,t)=>{this.children.push(e),t&&t(1,"文件夹创建成功")},this.addFolder=(e="untitled",t,r)=>{this.children.find((t=>t.isFolder()&&t.name===e))?logger.warn(`当前位置已经存在名称为“${e}”的文件夹。`):this.addItem(new FolderItem(e,t,this.children.length),r)},this.addModel=(e,t,r)=>{this.children.find((t=>t.isModel()&&t.name===e.name))?logger.warn(`当前位置已经存在名称为“${e.name}”的模型。`):("number"!=typeof e.index&&(e.index=this.children.length),this.addItem(new ModelItem(e,t,r)))},this.getSettings=()=>({name:this.name,path:this.path,children:this.children,transform:this.transform,type:this.getType(),isVisible:this._getVisible(),isLock:this._getLock(),index:this.index}),this.rename=(e,t)=>{e&&(this.name=e,t&&t(1,"模型重命名成功"))}}else logger.warn('创建文件夹中名称不能使用"/"')}}class GroupItem extends ObjectTreeItem{constructor({name:e,index:t,isVisible:r,isLock:n,transform:i},a,o=_context.scene.models,s=_context.defaultObjectTree){super("GroupItem"),this.type="GroupItem",this.isVisible=r,this.isLock=n,this.transform=i||this.transform,this.name=e,this.index=t,this.children=[];let l=a||new Group;l.name=e,o.add(l),s.addItem(this),l.position.set(this.transform.position.x,this.transform.position.y,this.transform.position.z),l.scale.set(this.transform.scale.x,this.transform.scale.y,this.transform.scale.z),l.rotation.set(this.transform.rotation._x,this.transform.rotation._y,this.transform.rotation._z),this.getGroup=()=>l,this.add=e=>{l.add(e)},this.childrenAdd=e=>{this.children.push(e)},this.getType=()=>this.type,this.getItemByName=e=>{let t=this.children.find((t=>t.name===e));if(t)return t},this.getSettings=()=>(l&&(this.transform.position=l.position,this.transform.rotation=l.rotation,this.transform.scale=l.scale),this.children.forEach((e=>{if(e.getMesh&&e.getMesh()&&e.getMesh().count){var t=[];if("ModelAsset"===e.type)for(let n=0;n<e.getMesh().count;n++){var r=new Matrix4;e.getMesh().getMatrixAt(n,r),t.push(r)}e.matrix=t}})),{name:this.name,type:this.type,children:this.children,isVisible:this.isVisible,isLock:this.isLock,index:this.index,transform:this.transform})}}var BufferGeometryUtils={computeTangents:function(e){e.computeTangents(),console.warn("THREE.BufferGeometryUtils: .computeTangents() has been removed. Use BufferGeometry.computeTangents() instead.")},mergeBufferGeometries:function(e,t){for(var r=null!==e[0].index,n=new Set(Object.keys(e[0].attributes)),i=new Set(Object.keys(e[0].morphAttributes)),a={},o={},s=e[0].morphTargetsRelative,l=new BufferGeometry,c=0,h=0;h<e.length;++h){var u=e[h],d=0;if(r!==(null!==u.index))return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(var p in u.attributes){if(!n.has(p))return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+'. All geometries must have compatible attributes; make sure "'+p+'" attribute exists among all geometries, or in none of them.'),null;void 0===a[p]&&(a[p]=[]),a[p].push(u.attributes[p]),d++}if(d!==n.size)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+". Make sure all geometries have the same number of attributes."),null;if(s!==u.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(var p in u.morphAttributes){if(!i.has(p))return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+".  .morphAttributes must be consistent throughout all geometries."),null;void 0===o[p]&&(o[p]=[]),o[p].push(u.morphAttributes[p])}if(l.userData.mergedUserData=l.userData.mergedUserData||[],l.userData.mergedUserData.push(u.userData),t){var f;if(r)f=u.index.count;else{if(void 0===u.attributes.position)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+". The geometry must have either an index or a position attribute"),null;f=u.attributes.position.count}l.addGroup(c,f,h),c+=f}}if(r){var m=0,g=[];for(h=0;h<e.length;++h){for(var y=e[h].index,v=0;v<y.count;++v)g.push(y.getX(v)+m);m+=e[h].attributes.position.count}l.setIndex(g)}for(var p in a){var b=this.mergeBufferAttributes(a[p]);if(!b)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed while trying to merge the "+p+" attribute."),null;l.setAttribute(p,b)}for(var p in o){var _=o[p][0].length;if(0===_)break;l.morphAttributes=l.morphAttributes||{},l.morphAttributes[p]=[];for(h=0;h<_;++h){var x=[];for(v=0;v<o[p].length;++v)x.push(o[p][v][h]);var w=this.mergeBufferAttributes(x);if(!w)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed while trying to merge the "+p+" morphAttribute."),null;l.morphAttributes[p].push(w)}}return l},mergeBufferAttributes:function(e){for(var t,r,n,i=0,a=0;a<e.length;++a){var o=e[a];if(o.isInterleavedBufferAttribute)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. InterleavedBufferAttributes are not supported."),null;if(void 0===t&&(t=o.array.constructor),t!==o.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(void 0===r&&(r=o.itemSize),r!==o.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(void 0===n&&(n=o.normalized),n!==o.normalized)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;i+=o.array.length}var s=new t(i),l=0;for(a=0;a<e.length;++a)s.set(e[a].array,l),l+=e[a].array.length;return new BufferAttribute(s,r,n)},interleaveAttributes:function(e){for(var t,r=0,n=0,i=0,a=e.length;i<a;++i){var o=e[i];if(void 0===t&&(t=o.array.constructor),t!==o.array.constructor)return console.error("AttributeBuffers of different types cannot be interleaved"),null;r+=o.array.length,n+=o.itemSize}var s=new InterleavedBuffer(new t(r),n),l=0,c=[],h=["getX","getY","getZ","getW"],u=["setX","setY","setZ","setW"],d=0;for(a=e.length;d<a;d++){var p=(o=e[d]).itemSize,f=o.count,m=new InterleavedBufferAttribute(s,p,l,o.normalized);c.push(m),l+=p;for(var g=0;g<f;g++)for(var y=0;y<p;y++)m[u[y]](g,o[h[y]](g))}return c},estimateBytesUsed:function(e){var t=0;for(var r in e.attributes){var n=e.getAttribute(r);t+=n.count*n.itemSize*n.array.BYTES_PER_ELEMENT}var i=e.getIndex();return t+=i?i.count*i.itemSize*i.array.BYTES_PER_ELEMENT:0},mergeVertices:function(e,t=1e-4){t=Math.max(t,Number.EPSILON);for(var r={},n=e.getIndex(),i=e.getAttribute("position"),a=n?n.count:i.count,o=0,s=Object.keys(e.attributes),l={},c={},h=[],u=["getX","getY","getZ","getW"],d=0,p=s.length;d<p;d++){l[b=s[d]]=[],(S=e.morphAttributes[b])&&(c[b]=new Array(S.length).fill().map((()=>[])))}var f=Math.log10(1/t),m=Math.pow(10,f);for(d=0;d<a;d++){var g=n?n.getX(d):d,y="",v=0;for(p=s.length;v<p;v++)for(var b=s[v],_=(w=e.getAttribute(b)).itemSize,x=0;x<_;x++)y+=~~(w[u[x]](g)*m)+",";if(y in r)h.push(r[y]);else{for(v=0,p=s.length;v<p;v++){b=s[v];var w=e.getAttribute(b),S=e.morphAttributes[b],M=(_=w.itemSize,l[b]),T=c[b];for(x=0;x<_;x++){var A=u[x];if(M.push(w[A](g)),S)for(var E=0,C=S.length;E<C;E++)T[E].push(S[E][A](g))}}r[y]=o,h.push(o),o++}}const L=e.clone();for(d=0,p=s.length;d<p;d++){b=s[d];var D=e.getAttribute(b);w=new BufferAttribute(new D.array.constructor(l[b]),D.itemSize,D.normalized);if(L.setAttribute(b,w),b in c)for(v=0;v<c[b].length;v++){var R=e.morphAttributes[b][v],P=new BufferAttribute(new R.array.constructor(c[b][v]),R.itemSize,R.normalized);L.morphAttributes[b][v]=P}}return L.setIndex(h),L},toTrianglesDrawMode:function(e,t){if(t===TrianglesDrawMode)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t===TriangleFanDrawMode||t===TriangleStripDrawMode){var r=e.getIndex();if(null===r){var n=[],i=e.getAttribute("position");if(void 0===i)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(var a=0;a<i.count;a++)n.push(a);e.setIndex(n),r=e.getIndex()}var o=r.count-2,s=[];if(t===TriangleFanDrawMode)for(a=1;a<=o;a++)s.push(r.getX(0)),s.push(r.getX(a)),s.push(r.getX(a+1));else for(a=0;a<o;a++)a%2==0?(s.push(r.getX(a)),s.push(r.getX(a+1)),s.push(r.getX(a+2))):(s.push(r.getX(a+2)),s.push(r.getX(a+1)),s.push(r.getX(a)));s.length/3!==o&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var l=e.clone();return l.setIndex(s),l.clearGroups(),l}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e},computeMorphedAttributes:function(e){if(!0!==e.geometry.isBufferGeometry)return console.error("THREE.BufferGeometryUtils: Geometry is not of type BufferGeometry."),null;var t=new Vector3,r=new Vector3,n=new Vector3,i=new Vector3,a=new Vector3,o=new Vector3,s=new Vector3,l=new Vector3,c=new Vector3;function h(e,h,u,d,p,f,m,g,y){t.fromBufferAttribute(u,f),r.fromBufferAttribute(u,m),n.fromBufferAttribute(u,g);var v=e.morphTargetInfluences;if(h.morphTargets&&d&&v){s.set(0,0,0),l.set(0,0,0),c.set(0,0,0);for(var b=0,_=d.length;b<_;b++){var x=v[b],w=d[b];0!==x&&(i.fromBufferAttribute(w,f),a.fromBufferAttribute(w,m),o.fromBufferAttribute(w,g),p?(s.addScaledVector(i,x),l.addScaledVector(a,x),c.addScaledVector(o,x)):(s.addScaledVector(i.sub(t),x),l.addScaledVector(a.sub(r),x),c.addScaledVector(o.sub(n),x)))}t.add(s),r.add(l),n.add(c)}e.isSkinnedMesh&&(e.boneTransform(f,t),e.boneTransform(m,r),e.boneTransform(g,n)),y[3*f+0]=t.x,y[3*f+1]=t.y,y[3*f+2]=t.z,y[3*m+0]=r.x,y[3*m+1]=r.y,y[3*m+2]=r.z,y[3*g+0]=n.x,y[3*g+1]=n.y,y[3*g+2]=n.z}var u,d,p,f,m,g,y,v,b,_=e.geometry,x=e.material,w=_.index,S=_.attributes.position,M=_.morphAttributes.position,T=_.morphTargetsRelative,A=_.attributes.normal,E=_.morphAttributes.position,C=_.groups,L=_.drawRange,D=new Float32Array(S.count*S.itemSize),R=new Float32Array(A.count*A.itemSize);if(null!==w)if(Array.isArray(x))for(f=0,g=C.length;f<g;f++)for(b=x[(v=C[f]).materialIndex],m=Math.max(v.start,L.start),y=Math.min(v.start+v.count,L.start+L.count);m<y;m+=3)h(e,b,S,M,T,u=w.getX(m),d=w.getX(m+1),p=w.getX(m+2),D),h(e,b,A,E,T,u,d,p,R);else for(f=Math.max(0,L.start),g=Math.min(w.count,L.start+L.count);f<g;f+=3)h(e,x,S,M,T,u=w.getX(f),d=w.getX(f+1),p=w.getX(f+2),D),h(e,x,A,E,T,u,d,p,R);else if(void 0!==S)if(Array.isArray(x))for(f=0,g=C.length;f<g;f++)for(b=x[(v=C[f]).materialIndex],m=Math.max(v.start,L.start),y=Math.min(v.start+v.count,L.start+L.count);m<y;m+=3)h(e,b,S,M,T,u=m,d=m+1,p=m+2,D),h(e,b,A,E,T,u,d,p,R);else for(f=Math.max(0,L.start),g=Math.min(S.count,L.start+L.count);f<g;f+=3)h(e,x,S,M,T,u=f,d=f+1,p=f+2,D),h(e,x,A,E,T,u,d,p,R);return{positionAttribute:S,normalAttribute:A,morphedPositionAttribute:new Float32BufferAttribute(D,3),morphedNormalAttribute:new Float32BufferAttribute(R,3)}}};class InstancedObject{constructor({path:e,gltf:t,name:r="grass",count:n=1,transform:i,points:a,isVisible:o,matrix:s,randomValues:l}={},c,h){if(!(a&&a instanceof Array))return;a.length>INSTANCE_COUNT_MAX&&(logger.warn(`实例对象的实例数不能超过 ${INSTANCE_COUNT_MAX}，将忽略超出的 ${a.length-INSTANCE_COUNT_MAX} 个实例。`),a.splice(INSTANCE_COUNT_MAX,a.length-INSTANCE_COUNT_MAX)),n=a.length,this.name=r,this.type="ModelAsset",this.isVisible=o,this.count=n,this.points=a,this.transform=i,this.matrix=[],this.delta=0,this.path=e;let u=new MaterialStore(_context.textureStore,_context.instance),d=null,p=-1/0,f=1/0,m=-1/0,g=1/0,y=[],v=c,b=[],_=l,x={},w=new Vector2;w.set(Math.random(),Math.random());_context.loaders.gltfLoader;for(let e=0;e<100;e++){let e=[];for(let t=0;t<100;t++)e.push(w.clone());b.push(e)}this.setRand=e=>{_=e},this.findNode=(e="")=>{if(!this.children||""===e)return;return this._findNodeRecursively(e,this)},this.addInstanceIsMatrix=e=>{if(e)for(let t=0;t<e.length;t++)for(let r of y){let n=new Matrix4;n.fromArray(e[t].elements),r.setMatrixAt(t,n.clone()),r.instanceMatrix.needsUpdate=!0}},this.removeInstance=(e,t)=>{if(!("number"!=typeof e||e>this.points)){for(let t=e;t<this.points.length;t++)for(let e of y){var r=new Matrix4;e.getMatrixAt(t+1,r),e.setMatrixAt(t,r),e.instanceMatrix.needsUpdate=!0}for(let e of y)e.count-=1;this.points.splice(e,1),t&&t(1)}},this.addInstance=(e,t)=>{if(console.log(new Date,e),!(e&&e instanceof Array))return;let r=this.points.length;e.length+this.points.length>INSTANCE_COUNT_MAX&&(logger.warn(`实例对象的实例数不能超过 ${INSTANCE_COUNT_MAX}，将忽略超出的 ${e.length+this.points.length-INSTANCE_COUNT_MAX} 个实例。`),this.points.splice(INSTANCE_COUNT_MAX-this.points.length,e.length+this.points.length-INSTANCE_COUNT_MAX)),this.points.push.apply(this.points,e),this.count=this.points.length;for(let e of y)e.count=this.count;let n=t.getGroup().rotation,i=t.getGroup().scale;for(let e=r;e<this.points.length;e++){let t=new Object3D;t.rotation.set(0-n._x,0-n._y,0-n._z);let r=new Vector3(this.points[e][0]/(i.x||1),this.points[e][1]/(i.y||1),this.points[e][2]/(i.z||1));if(r=r.applyEuler(t.rotation),t.position.set(r.x,r.y,r.z),_&&_.scaleMax&&_.scaleMin&&_.scaleFlag){let e=Math.random()*(_.scaleMax-_.scaleMin)+_.scaleMin;t.scale.set(x.x*e,x.y*e,x.z*e)}else t.scale.set(x.x,x.y,x.z);_&&_.rotateMax&&_.rotateMin&&_.rotateFlag&&t.rotateY(MathUtils.degToRad(Math.random()*(_.rotateMax-_.rotateMin)+_.rotateMin)),t.updateMatrix();let a=t.matrix.clone();for(let t of y)t.setMatrixAt(e,a),t.instanceMatrix.needsUpdate=!0}};let S=e=>{let t=e.geometry.clone(),r=e.material;if(r instanceof Array)for(let e of r)e.vertexColors=!1,e.alphaTest=.05;else r.vertexColors=!1,r.alphaTest=.05;d=new InstancedMesh(t,r,INSTANCE_COUNT_MAX),d.count=this.count,d.name=`${this.name}#${y.length}`,d.castShadow=!0,d.receiveShadow=!0,this.transform&&(d.position.set(this.transform.position?this.transform.position.x+e.position.x:0+e.position.x,this.transform.position?this.transform.position.y+e.position.y:0+e.position.y,this.transform.position?this.transform.position.z+e.position.z:0+e.position.z),x=e.parent.scale),d.instanceMatrix.setUsage(DynamicDrawUsage);for(let e=0;e<this.count;e++){p<this.points[e][0]&&(p=this.points[e][0]),f>this.points[e][0]&&(f=this.points[e][0]),m<this.points[e][2]&&(m=this.points[e][2]),g>this.points[e][2]&&(g=this.points[e][2]),p===f&&(p=200+p,f=-200+f),m===g&&(m=200+m,g=-200+g);let t=new Object3D;if(t.position.set(this.points[e][0],this.points[e][1],this.points[e][2]),_&&_.scaleMax&&_.scaleMin&&_.scaleFlag){let e=Math.random()*(_.scaleMax-_.scaleMin)+_.scaleMin;t.scale.set(x.x*e,x.y*e,x.z*e)}else t.scale.set(x.x,x.y,x.z);_&&_.rotateMax&&_.rotateMin&&_.rotateFlag&&t.rotateY(MathUtils.degToRad(Math.random()*(_.rotateMax-_.rotateMin)+_.rotateMin)),t.updateMatrix();let r=t.matrix.clone();d.setMatrixAt(e,r)}d.instanceMatrix.needsUpdate=!0,v.add(d),y.push(d)},M=new TreeAnimationController(this);if(_context.animationStore.add(M),this.updateWindEffect=(e,t)=>{if(0!==y.length&&(this.delta+=1,!(this.delta<2||(this.delta=0,void 0===this.windForce&&(this.windForce=0),void 0===this.windForceDelta&&(this.windForceDelta=0),void 0===this.windForceChange&&(this.windForceChange=1),this.windForceDelta+=1,this.windForceDelta<this.windForceChange)))){this.windForceDelta=0,this.windForceChange=3*Math.random(),Math.random()>.5?this.windForce+=.005*Math.random():this.windForce-=.005*Math.random(),e=this.windForce;for(let t=0;t<b.length;t++)for(let r=0;r<b.length;r++)b[t][r].x=b[t][r].x*(e*Math.random()-e/2+1)>1?1:b[t][r].x*(e*Math.random()-e/2+1),b[t][r].y=b[t][r].y*(e*Math.random()-e/2+1)>1?1:b[t][r].y*(e*Math.random()-e/2+1);if(this.windTimes)for(let e=0;e<this.windTimes.length;e++)this.windTimes[e].value=t}},this.getMesh=()=>d,this.hide=()=>{y.visible=!1},this.show=()=>{y.visible=!0},t){if(s){if(this.name===t.scene.name)S(t.scene,s[0]);else{let e=t.scene.children.find((e=>e.name.indexOf(this.name)>=0));e&&S(e,s[0])}this.addInstanceIsMatrix(s)}h&&h(1)}else{if(!e)return;_context.cacheStore.load({path:e,type:"glb",onLoad:e=>{if(e.traverse((e=>{if(util$1.capableForCastingShadow(e)&&(e.castShadow=!0,e.receiveShadow=!0),e.material instanceof MeshStandardMaterial){e.material.alphaTest=.05,e.material.vertexColors=!1,e.material.needsUpdate=!0,u.add(e.material.name,e.material,e,this.name);for(let t in e.material)e.material[t]instanceof Texture$1&&e.material[t].image&&_context.textureStore.add(e.material[t].name||`${e.material.name}#${t}`,e.material[t])}})),s){e.traverse((e=>{"Mesh"===e.type&&S(e,s[0])}));var t=v.getItemByName(this.name);t&&t.addInstanceIsMatrix&&t.addInstanceIsMatrix(s)}else e.traverse((e=>{"Mesh"===e.type&&S(e)}));h&&h(1)},onProgress:0,onError:0})}}}class MarkerItem extends ObjectTreeItem{constructor({id:e=util$1.guid(),name:t,modelPath:r,transform:n,isVisible:i}={},a,o){super("MarkerItem"),this.id=e,this.name=t||this.id,this.modelPath=r,this.type="MarkerItem",this.animations=[],this.scale=(e=1,t=1,r=1)=>{_modelNode&&_modelNode.scale.set(e,t,r)},this.translate=(e=0,t=0,r=0)=>{_modelNode&&_modelNode.position.set(e,t,r)},this.rotateX=e=>{_modelNode&&_modelNode.rotateX(util$1.degreeToRadian(e))},this.rotateY=e=>{_modelNode&&_modelNode.rotateY(util$1.degreeToRadian(e))},this.rotateZ=e=>{_modelNode&&_modelNode.rotateZ(util$1.degreeToRadian(e))},this.load=(e={color:"#ffffff",position:[0,0,0],size:100,opacity:1},t,r)=>(logger.debug("TRACE: MarkerItem.load() - Entering.",e),e.color=e.color||"#ffffff",e.position=e.position||[0,0,0],e.size="number"==typeof e.size&&e.size>=0?e.size:100,e.opacity="number"==typeof e.opacity&&e.opacity>=0&&e.opacity<=1?e.opacity:1,logger.debug("TRACE: MarkerItem.load() - Leaving and return a Promise."),new Promise(((n,i)=>{_context.loaders.gltfLoader||(t&&t(0,"No loader initiated."),i(new Error("No loader initiated."))),e.name||(e.name=util$1.guid());var a=e.path;_context.loaders.gltfLoader.load(a,(r=>{if(r.scene.traverse((t=>{if(t.isMesh){if(t.userData.transparent=t.material.transparent,t.castShadow=!1,t.receiveShadow=!1,e.opacity<.99&&(t.material.transparent=!0,t.material.opacity=e.opacity),t.material.transparent&&t.material.map&&(t.material.opacity=e.opacity,t.material.alphaMap=t.material.map.clone(),t.material.emissiveMap=t.material.map.clone(),e.ignoreMap instanceof Array)){let r=!1;for(let n of e.ignoreMap)n===t.name&&(r=!0);r&&(t.material.map=null)}t.material.color=new Color(e.color),t.material.emissive=new Color(e.color),t.material.emissiveIntensity=.5,t.material.depthWrite=_context.drawableDepthTest,t.material.depthTest=_context.drawableDepthTest,t.material.onBeforeCompile=function(e){let t=ShaderChunk.lights_phong_pars_fragment;t=t.replace("vec3 irradiance = dotNL * directLight.color;","float colorIntensity = max(max(directLight.color.r,directLight.color.g),directLight.color.b);vec3 irradiance = dotNL * vec3(colorIntensity,colorIntensity,colorIntensity);"),e.fragmentShader=e.fragmentShader.replace("#include <lights_phong_pars_fragment>",t);let r=ShaderChunk.lights_pars_begin;r=r.replace("vec3 irradiance = ambientLightColor;","float colorIntensity = max(max(ambientLightColor.r,ambientLightColor.g),ambientLightColor.b);vec3 irradiance = vec3(colorIntensity,colorIntensity,colorIntensity);"),r=r.replace("vec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );","vec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );float colorIntensity = max(max(irradiance.r,irradiance.g),irradiance.b);irradiance = vec3(colorIntensity,colorIntensity,colorIntensity);"),e.fragmentShader=e.fragmentShader.replace("#include <lights_pars_begin>",r)},t.material.needsUpdate=!0}})),e.animations instanceof Array)for(let t of e.animations)switch(t.type){case"internal":let n,i;switch(t.nodeName&&(n=r.scene.getObjectByName(t.nodeName)),n||(n=r.scene),t.animation){case"rotateY":i=new NodeRotationAnimationController(n,!1,!0,!1,0,"number"==typeof t.speed?t.speed:.1,0),_context.animationStore.add(i),this.animations.push(i);break;case"spread":t.startScale="number"==typeof t.startScale?t.startScale:.1,t.stopScale="number"==typeof t.stopScale?t.stopScale:1,t.fadeOutScale="number"==typeof t.fadeOutScale?t.fadeOutScale:.7,t.speed="number"==typeof t.speed?t.speed:.1,i=new NodeScaleAnimationController(n,t.startScale,t.stopScale,t.fadeOutScale,t.speed,!0),_context.animationStore.add(i),this.animations.push(i);break;case"uvY":if(!n.material)break;t.speed="number"==typeof t.speed?t.speed:.2,i=new UVAnimationController(n.material,!1,!0,0,t.speed),_context.animationStore.add(i),this.animations.push(i);break;case"uvX":if(!n.material)break;t.speed="number"==typeof t.speed?t.speed:.2,i=new UVAnimationController(n.material,!0,!1,t.speed,0),_context.animationStore.add(i),this.animations.push(i)}break;case"imported":const a=new AnimationMixer(r.scene);if(a.name=e.name,!r.animations[e.index||0])break;a.clipAction(r.animations[e.index||0]).setDuration(1).setEffectiveTimeScale("number"==typeof e.timeScale?e.timeScale:1).play(),_context.animationMixers.push(a)}r.scene.name=e.name,r.scene.scale.set(e.size,e.size,e.size),r.scene.path=e.path;let i=new Group;i.name=e.name,i.position.set(e.position[0],e.position[1],e.position[2]),i.add(r.scene),_context.objectStore.add(e.name,i),n(),t&&t(1,i)}),r,(e=>{t?t(0,e):logger.debug(e),i(e)}))}))),this.destroy=()=>{}}}class Model{constructor({id:e=util$1.guid(),name:t,url:r,animations:n,children:i=[],isVisible:a,index:o}){this.id=e,this.name=t||this.id,this.url=r,this.animations=n,this.children=i,this.isVisible=a,this.index=o}findNode(e=""){if(!this.children||""===e)return;return this._findNodeRecursively(e,this)}_findNodeRecursively(e,t){if(t.children&&t.children instanceof Array&&0!==t.children.length)for(let r of t.children){if(r.name===e)return r;if(r.children instanceof Array&&r.children.length>0){let t=this._findNodeRecursively(e,r);if(t)return t}}}}var axisTypeChangeEvent={type:"axisTypeChange"},mouseDownEvent={type:"mouseDown"},mouseUpEvent={type:"mouseUp",mode:null};class ModelSelection extends EventDispatcher{constructor(){super("ModelSelection");let e="centre",t=new Map,r=new Map,n=new Object3D,i=new Vector3,a=new Euler,o=new Vector3;this.controlsState=!1;let s=e=>{let t=e.target.object.position.clone().sub(i);i=e.target.object.position.clone(),r.forEach((e=>{let r=t.clone();r.divide(e.threeObject.parent.getWorldScale(new Vector3));let n=new Matrix4;n.makeRotationFromQuaternion(e.threeObject.parent.getWorldQuaternion(new Quaternion)).invert(),r.applyMatrix4(n);let i=e.transform.position.clone().add(r);e.threeObject.position.copy(i),e.transform.position=e.threeObject.position.clone(),e.transform.rotation=e.threeObject.rotation.clone(),e.transform.scale=e.threeObject.scale.clone()}))},l=t=>{let n=t.target.axis.toLocaleLowerCase();if("e"!==n&&0!==t.target.rotationAngleDelta)if("centre"===e){let e=t.target.object.position.clone();r.forEach((r=>{((e,t,r,n)=>{if(!e||!e.position)return;if(!t)return;if("x"!==r&&"y"!==r&&"z"!==r)return;const i=e.getWorldPosition(new Vector3);i.sub(t);const a={x:new Vector3(1,0,0),y:new Vector3(0,1,0),z:new Vector3(0,0,1)};i.applyAxisAngle(a[r],n),e.rotateOnWorldAxis(a[r],n);let o=e.parent.getWorldPosition(new Vector3);i.add(t),i.sub(o),i.divide(e.parent.getWorldScale(new Vector3));let s=new Matrix4;s.makeRotationFromQuaternion(e.parent.getWorldQuaternion(new Quaternion)).invert(),i.applyMatrix4(s),e.position.copy(i)})(r.threeObject,e,n,t.target.rotationAngleDelta),r.transform.position=r.threeObject.position.clone(),r.transform.rotation=r.threeObject.rotation.clone(),r.transform.scale=r.threeObject.scale.clone()}))}else"oneself"===e&&r.forEach((e=>{e.threeObject[`rotate${n.toLocaleUpperCase()}`](t.target.rotationAngleDelta)}))},c=e=>{let t=e.target.object.scale;r.forEach((e=>{let r=t.clone(),n=new Matrix4;n.makeRotationFromQuaternion(e.threeObject.parent.getWorldQuaternion(new Quaternion)).invert(),r.applyMatrix4(n);let i=e.transform.scale;e.threeObject.scale.set(i.x*r.x,i.y*r.y,i.z*r.z)}))};this.setPropertyTransform=(t="",i)=>{let a;if(""===t)return a={success:0,message:"修改失败"},a;let o=t.split(".");if(_context.transformControls.dispatchEvent(mouseDownEvent),"oneself"===e)r.forEach(((e,t)=>{let r=JSON.parse(JSON.stringify(_context.instance.getModelTransformByUUID(t)));2===o.length?r[o[0]][o[1]]=i:1===o.length&&(r[o[0]]=i),_context.instance.setModelTransformByUUID(t,r)})),this.enableTransformControl(),a={success:1,message:"修改成功"};else if("centre"===e){let e=["x","y","z"];if("rotation"===o[0])if(2==o.length){let e=n.rotation[o[1]];n[`rotate${o[1].toUpperCase()}`](MathUtils.degToRad(i)-e);let t={target:{axis:o[1],object:n,rotationAngleDelta:MathUtils.degToRad(i)-e}};l(t)}else 1==o.length&&e.forEach((e=>{let t=n.rotation[e];n[`rotate${e.toUpperCase()}`](MathUtils.degToRad(i[e])-t);let r={target:{axis:e,object:n,rotationAngleDelta:MathUtils.degToRad(i[e])-t}};l(r)}));else if("position"===o[0])if(2==o.length){n.position[`set${o[1].toUpperCase()}`](i),s({target:{object:n}})}else 1==o.length&&e.forEach((e=>{n.position[`set${e.toUpperCase()}`](i[e]),s({target:{object:n}})}));else if("scale"===o[0])if(2==o.length){n.scale[`set${o[1].toUpperCase()}`](i),c({target:{object:n}})}else 1==o.length&&e.forEach((e=>{n.scale[`set${e.toUpperCase()}`](i[e]),c({target:{object:n}})}))}mouseUpEvent.mode=_context.transformControls.mode,_context.transformControls.dispatchEvent(mouseUpEvent)},this.selectObjectByUUID=(e=[])=>(r.clear(),t.forEach((e=>{e.forEach((e=>{e.children[0].material.uniforms.outline.value=0}))})),_context.effectStore.highlightObject(null),e.forEach((e=>{let n={threeObject:null,userObject:null,transform:{}},i=_context.instance.defaultObjectTree.getItemByUUID(e);if(i)if(n.userObject=i,n.threeObject=i.getGroup(),n.transform.position=i.getGroup().position.clone(),n.transform.rotation=i.getGroup().rotation.clone(),n.transform.scale=i.getGroup().scale.clone(),r.set(e,n),"IconAsset"===i.type)i.getGroup().children[0].material.uniforms.outline.value=1,t.set(e,[i.getGroup()]);else{let r=[];i.getGroup().traverse((e=>{"IconGroup"===e.type&&(e.children[0].material.uniforms.outline.value=1,r.push(e))})),r.length>0?(t.set(e,r),_context.effectStore.highlightObject(n.threeObject,!0)):_context.effectStore.highlightObject(n.threeObject,!0)}else logger.warn("ModeSelection.selectObjectByUUID(): Invalid input found.")})),this.controlsState&&this.enableTransformControl(),this.getSelectionList()),this.setSelectObjectByUUID=e=>{let n={threeObject:null,userObject:null,transform:{}},i=_context.instance.defaultObjectTree.getItemByUUID(e);if(i){if(n.userObject=i,n.threeObject=i.getGroup(),n.transform.position=i.getGroup().position.clone(),n.transform.rotation=i.getGroup().rotation.clone(),n.transform.scale=i.getGroup().scale.clone(),r.set(e,n),"IconAsset"===i.type)i.getGroup().children[0].material.uniforms.outline.value=1,t.set(e,[i.getGroup()]);else{let r=[];i.getGroup().traverse((e=>{"IconGroup"===e.type&&(e.children[0].material.uniforms.outline.value=1,r.push(e))})),r.length>0?(t.set(e,r),_context.effectStore.highlightObject(n.threeObject,!0)):_context.effectStore.highlightObject(n.threeObject,!0)}this.controlsState&&this.enableTransformControl()}else logger.warn("ModeSelection.selectObjectByUUID(): Invalid input found.");return this.getSelectionList()},this.deleteSelectObjectByUUID=e=>{if(!r.get(e))return logger.warn("ModeSelection.deleteSelectObjectByUUID(): Invalid input found."),this.getSelectionList();_context.effectStore.cancleHighlightObject(r.get(e).threeObject);let n=t.get(e);return n&&n.forEach((e=>{e.children[0].material.uniforms.outline.value=0})),t.delete(e),r.delete(e),this.controlsState&&this.enableTransformControl(),this.getSelectionList()},this.toggleSelectObjectByUUID=e=>(r.get(e)?this.deleteSelectObjectByUUID(e):this.setSelectObjectByUUID(e),this.getSelectionList()),this.getSelectionList=()=>{let e=[];return r.forEach(((t,r)=>{e.push(r)})),e},this.getProperty=e=>{},this.setProperty=(e,t,n)=>{let i={success:0,message:""};if("--"==n)return;let a=t.split(".");switch(e){case"transform":this.setPropertyTransform(t,n);break;case"iconAssetData":r.forEach(((e,t)=>{if("IconAsset"==e.userObject.type){let t=JSON.parse(JSON.stringify(e.userObject));a.length>1?t[a[0]][a[1]]=n:1==a.length&&(t[a[0]]=n),delete t.backgroundMap,delete t.map,e.userObject.update(t)}})),i={success:1,message:"修改成功"}}return i},this.getAllProperties=()=>{if(!r.size)return{};if(1===r.size){let e=this.getSelectionList()[0],t=r.get(e),n={};return n.position=JSON.parse(JSON.stringify(t.threeObject.position)),n.rotation=JSON.parse(JSON.stringify(t.threeObject.rotation)),n.rotation.x=n.rotation._x,n.rotation.y=n.rotation._y,n.rotation.z=n.rotation._z,n.scale=JSON.parse(JSON.stringify(t.threeObject.scale)),n.rotation.x=n.rotation._x=MathUtils.radToDeg(n.rotation._x),n.rotation.y=n.rotation._y=MathUtils.radToDeg(n.rotation._y),n.rotation.z=n.rotation._z=MathUtils.radToDeg(n.rotation._z),{...t.userObject,transform:n}}let t={};return r.forEach((e=>{for(let r in e.userObject)switch(logger.info(`ModeSelection.getAllProperties(): deep clone userObject-propertyName: ${r}`),r){case"id":case"children":case"materialStore":case"level":case"floor":case"backgroundMap":case"map":case"_nodeSelection":case"getType":t[r]=void 0;break;case"textParam":case"param":if(e.userObject[r].canvas&&delete e.userObject[r].canvas,t.hasOwnProperty(r))for(let n in e.userObject[r])console.log(r,n),t[r]&&!t[r].hasOwnProperty(n)?t[r][n]=util$1.clone(e.userObject[r][n]):t[r][n]=util$1.eq(t[r][n],e.userObject[r][n])?t[r][n]:"--";else t[r]=util$1.clone(JSON.parse(JSON.stringify(e.userObject[r])));break;case"name":t.hasOwnProperty(r)?t.label=util$1.eq(t[r],e.userObject[r])?t[r]:"--":(t[r]=util$1.clone(e.userObject[r]),t.label=util$1.clone(e.userObject[r]))}})),"centre"==e?(t.transform={},t.transform.position=JSON.parse(JSON.stringify(n.position)),t.transform.rotation=JSON.parse(JSON.stringify(n.rotation)),t.transform.rotation.x=t.transform.rotation._x,t.transform.rotation.y=t.transform.rotation._y,t.transform.rotation.z=t.transform.rotation._z,t.transform.scale=JSON.parse(JSON.stringify(n.scale)),t.transform.rotation.x=t.transform.rotation._x=MathUtils.radToDeg(t.transform.rotation._x),t.transform.rotation.y=t.transform.rotation._y=MathUtils.radToDeg(t.transform.rotation._y),t.transform.rotation.z=t.transform.rotation._z=MathUtils.radToDeg(t.transform.rotation._z)):"oneself"==e&&(t.transform={},r.forEach((e=>{let r={};for(var n in r.position=JSON.parse(JSON.stringify(e.threeObject.position)),r.rotation=JSON.parse(JSON.stringify(e.threeObject.rotation)),r.rotation.x=r.rotation._x,r.rotation.y=r.rotation._y,r.rotation.z=r.rotation._z,r.scale=JSON.parse(JSON.stringify(e.threeObject.scale)),r.rotation.x=r.rotation._x=MathUtils.radToDeg(r.rotation._x),r.rotation.y=r.rotation._y=MathUtils.radToDeg(r.rotation._y),r.rotation.z=r.rotation._z=MathUtils.radToDeg(r.rotation._z),r)if(t.transform.hasOwnProperty(n))for(let e in r[n])t.transform[n]&&!t.transform[n].hasOwnProperty(e)?t.transform[n][e]=util$1.clone(r[n][e]):t.transform[n][e]=util$1.eq(t.transform[n][e],r[n][e])?t.transform[n][e]:"--";else t.transform[n]=util$1.clone(r[n])}))),t},this.getCenterPosition=()=>{let e=[];if(r.forEach((t=>{t.threeObject.traverse((t=>{let r=t.getWorldPosition(new Vector3);if(t.geometry){t.geometry.computeBoundingBox();let n=t.geometry.boundingBox.getCenter(new Vector3);r.add(n),e.push(r)}else t.children&&t.children.length||e.push(r)}))})),!e.length)return new Vector3;let t=e[0].clone(),n=e[0].clone();return e.forEach((e=>{t.min(e),n.max(e)})),new Box3(t,n).getCenter(new Vector3)},this.enableTransformControl=()=>{if(this.disableTransformControl(),1===r.size){let e=this.getSelectionList();return void _context.transformControls.attach(r.get(e[0]).threeObject)}if(r.size<1)return;this.controlsState=!0;let e=this.getCenterPosition();n.position.copy(e),n.rotation.set(0,0,0),n.scale.set(1,1,1),i.copy(e),a.copy(n.rotation),o.copy(n.scale),_context.scene.add(n),_context.transformControls.addEventListener("translate",s),_context.transformControls.addEventListener("rotate",l),_context.transformControls.addEventListener("scale",c),_context.transformControls.attach(n),_context.transformControls.showE=!1},this.disableTransformControl=()=>{_context.transformControls.removeEventListener("translate",s),_context.transformControls.removeEventListener("rotate",l),_context.transformControls.removeEventListener("scale",c),_context.transformControls.showE=!0,this.controlsState=!1,_context.transformControls.detach()},this.getSelectedModelMap=()=>r,this.getAxisType=()=>e,this.setAxisType=t=>("centre"!=t&&"oneself"!=t||(e=t,this.dispatchEvent(axisTypeChangeEvent)),e)}}class LoadModelItem extends ObjectTreeItem{constructor(e,t){super("LoadModelItem"),this.materialStore=new MaterialStore(_context.textureStore,_context.instance),this.type="ModelItem",this.addModel=(e,t)=>{for(let t=e.children.length-1;t>=0;t--)_context.scene.models.add(e.children[t]);for(let e=_context.scene.models.children.length-1;e>=0;e--)for(let r=t.length-1;r>=0;r--)if(t[r].name===_context.scene.models.children[e].userData.name&&("IconAsset"===t[r].type||"GroupItem"===t[r].type)){_context.scene.models.remove(_context.scene.models.children[e]);break}e.traverse((e=>{if(util$1.capableForCastingShadow(e)&&(e.castShadow=!0,e.receiveShadow=!0),e.material instanceof MeshStandardMaterial){e.material.alphaTest=.05,e.material.depthWrite=!0,e.material.depthTest=!0,e.material.vertexColors=!1,e.material.needsUpdate=!0;for(let t in e.material)e.material[t]instanceof Texture$1&&e.material[t].image&&_context.textureStore.add(e.material[t].name||`${e.material.name}#${t}`,e.material[t])}}))},this.addModel(e,t)}}class ObjectTree extends ObjectTreeItem{constructor(e){super("ObjectTree"),this.children=[],this._nodeSelection=new NodeSelection(e),this.parentNode=null,this.getGroup=()=>_context.scene.models,this.addItem=(e,t)=>{this.children.push(e),t&&t(1)},this.addFolder=(e="untitled",t,r,n,i)=>{this.children.find((t=>t.isFolder()&&t.name===e))?logger.warn(`当前位置已经存在名称为“${e}”的文件夹。`):null!=t.children?this.addItem(this.recursionAddFolderOrModel(t,n,i),r):this.addItem(new FolderItem(e,{},"number"==typeof t.index?t.index:this.children.length),r)},this.recursionAddFolderOrModel=(e,t,r)=>{if("FolderItem"===e.type){let n=new FolderItem(e.name,{},"number"==typeof e.index?e.index:this.children.length);if(e.children.length>0)for(let i of e.children)n.children.push(this.recursionAddFolderOrModel(i,t,r));return n}switch(e.type){case"ModelItem":return"number"!=typeof e.index&&(e.index=this.children.length),new ModelItem(e,t,r)}},this.addModel=(e,t,r,n)=>{if(this.children.find((t=>t.name===e.name))&&!e.loadModel)return void logger.warn(`当前位置已经存在名称为“${e.name}”的模型。`);"number"!=typeof e.index&&(e.index=this.children.length),e.parent="objectTree",e.parentUUID="objectTreeUUID";let i=new ModelItem(e,t,r,n);this.addItem(i)},this.addIconAsset=(e,t,r)=>{delete e.textParam.canvas;var n=util$1.deepClone(e);n.nameRepetition||(n.name=util$1.getCopyName(n.name,null,this)),"number"!=typeof n.index&&(n.index=this.children.length),n.parent="objectTree",n.isVisible=!0,new IconItem(n,t,r)},this.loadModel=(e,t,r)=>{if(!this.children.find((t=>t.name===e.name)))return logger.debug("TRACE: ModelItem.addModel() - Entering.",e),e=e||{},logger.debug("TRACE: ModelItem.addModel() - Leaving and return a Promise."),new Promise(((n,i)=>{_context.loaders.gltfLoader||(t&&t(0,"No loader initiated."),i(new Error("No loader initiated."))),e.name||(e.name=util$1.guid()),_context.cacheStore.load({path:e.modelPath,type:"AVWS",onLoad:e=>{let r,i=e.children[0].children;r=e.children[0].userData.dhExtension.objectTree?e.children[0].userData.dhExtension.objectTree.children:e.children[0].userData.dhExtension.models;for(const e of i)for(const t of r){if(e.userData.name!=t.name)continue;let r=util$1.cloneDeep(t);if(r.loadModel=e,"ModelItem"==t.type&&this.addItem(new ModelItem(r)),"IconAsset"==t.type&&new IconItem(r,null),"GroupItem"==t.type){let e=new GroupItem(r);r.children.forEach((t=>{switch(t.type){case"IconAsset":new IconItem(t,e);break;case"ModelAsset":logger.debug(r,t);let n={name:t.name,gltf:{scene:r.loadModel},transform:t.transform,points:t.points,matrix:t.matrix},i=e.children.find((e=>e.name===n.name));i?i.addInstanceIsMatrix(n.matrix):e.childrenAdd(new InstancedObject(n,e))}}))}"BuildingItem"==t.type&&_context.instance.defaultObjectTree.addBuilding(r)}var a=util$1.cloneDeep(e.children[0].userData.dhExtension);new LoadModelItem(e.children[0],r),t&&t(1,a),n(),setTimeout((()=>{_context.instance.focus()}),500),_context.paintControls&&_context.paintControls.updateWorld()},onProgress:r,onError:e=>{t?t(0,e):logger.debug(e),i(e)}})}));logger.warn(`当前位置已经存在名称为“${e.name}”的模型。`)},this.addBuilding=(e,t,r,n=_context.scene.models)=>{this.children.find((t=>t.name===e.name))?logger.warn(`当前位置已经存在名称为“${e.name}”的模型。`):("number"!=typeof e.index&&(e.index=this.children.length),e.parent="objectTree",e.parentUUID="objectTreeUUID",e.isVisible=null==e.isVisible||e.isVisible,e.floor=null!=e.floor?e.floor:null,this.addItem(new BuildingItem(e,n,t,r)))},this.findItem=e=>{if(e)return e=e.split("/"),_traverse_0_6_6_traverse(this.children).get(e)},this.findItemByName=e=>{if("string"==typeof e&&""!==e)for(let t=0;t<this.children.length;t++){let r=this.objectTreeRecursion(this.children[t],e);if(r)return r}},this.objectTreeRecursion=(e,t)=>{if(t&&e)if("ModelItem"===e.type){if(e.name===t)return e}else{if(!(e.children instanceof Array))return;for(let r=0;r<e.children.length;r++){let n=this.objectTreeRecursion(e.children[r],t);if(n)return n}}},this.findItemByObject3D=e=>{if(!(e instanceof Object3D))return;let t=e;for(;t.parent&&t.parent.name!==_context.scene.models.name;)t=t.parent;return this.getItemByName(t.name)},this.getParentIds=e=>{if(!(e instanceof Object3D))return;let t=[],r=e;for(;r.parent.name!==_context.scene.models.name;)r=r.parent,t.push(r.uuid);return t},this.getItemByIndex=e=>{if("number"==typeof e&&!(e>this.children.length))return this.children[e]},this.findNodeByName=e=>{if("string"==typeof e&&""!==e)for(let t=0;t<this.children.length;t++){let r=this.nodeRecursion(this.children[t],e);if(r)return r}},this.nodeRecursion=(e,t)=>{if(t&&e){if(e.name===t)return e;if(e.children.length>0)for(let r=0;r<e.children.length;r++){if(e.children[r].name===t)return e.children[r];if(e.children[r].children&&e.children[r].children.length>0){let n=this.nodeRecursion(e.children[r],t);if(n)return n}}}},this.getAsset=(e,t)=>{if("string"==typeof e&&""!==e)for(let r=0;r<this.children.length;r++){let n=this.iconAssetRecursion(this.children[r],e,t);if(n)return n}},this.iconAssetRecursion=(e,t,r)=>{if(e)if(e.type===r){if(e.name===t)return e}else if(e.children&&e.children.length>0)for(let n=0;n<e.children.length;n++)if(e.children[n].type===r){if(e.children[n].name===t)return e.children[n]}else if(e.children[n].children&&e.children[n].children.length>0){let i=this.iconAssetRecursion(e.children[n],t,r);if(i)return i}},this.rankUp=(e,t,r=this.children)=>{for(let n=0;n<r.length;n++)if(r[n].name===e){for(let n=0;n<r.length;n++)if(r[n].name===e){if(0===r[n].index)return void(t&&t(0,"已是第一名无法上移"));r[n].index-=1;for(let e=0;e<r.length;e++)r[e].index===r[n].index&&r[e].name!=r[n].name&&(r[e].index+=1);return void(t&&t(1,"成功"))}}else"FolderItem"!==r[n].type&&"BuildingItem"!==r.type&&"BuildingFloorItem"!==r.type||r[n].children.length>0&&this.rankUp(e,t,r[n].children)},this.rankDown=(e,t,r=this.children)=>{for(let n=0;n<r.length;n++)if(r[n].name===e){for(let n=0;n<r.length;n++)if(r[n].name===e){if(r[n].index===r.length-1)return void(t&&t(0,"已是最后一名无法下移"));r[n].index+=1;for(let e=0;e<r.length;e++)r[e].index===r[n].index&&r[e].name!=r[n].name&&(r[e].index-=1);return void(t&&t(1,"成功"))}}else"FolderItem"!==r[n].type&&"BuildingItem"!==r.type&&"BuildingFloorItem"!==r.type||r[n].children.length>0&&this.rankDown(e,t,r[n].children)},this.traverse=(e,t)=>{if(e&&"function"==typeof e&&this.children&&this.children instanceof Array){t||(t=this.children);for(let r of t)e(r),r.children instanceof Array&&this.traverse(e,r.children)}},this.findMaterialRecursion=(e,t)=>{if(e.name===t&&"ModelItem"==e.type)return e;if(e.children.length>0)for(let r=0;r<e.children.length;r++){if(e.children[r].name===t&&"ModelItem"==e.children[r].type)return e.children[r];if(e.children[r].children.length>0){let n=this.findMaterialRecursion(e.children[r],t);if(n)return n}}},this.findModelFromBuilding=(e=this.children,t,r)=>{if(t)for(let i=0;i<e.length;i++){let a=null;if("modelUUID"===r?a=e[i].getGroup?e[i].getGroup().uuid:e[i].id:"modelName"===r&&(a=e[i].name),t===a){if("objectTree"===e[i].parent)return e[i];if(n=this.findModelFromBuilding(this.children,e[i].parentUUID,"modelUUID"))return n}else if(e[i].children&&e[i].children.length>0){var n;if(n=this.findModelFromBuilding(e[i].children,t,r))return n}}},this.hideItemByName=e=>{let t=this.getItemByName(e);t&&("ModelItem"===t.type||"IconAsset"===t.type?this.modelIsHide(t,!1):"FolderItem"===t.type&&this.folderItemIsHideRecursion(t,!1))},this.showItemByName=e=>{let t=this.getItemByName(e);t&&("ModelItem"===t.type||"IconAsset"===t.type?this.modelIsHide(t,!0):"FolderItem"===t.type&&this.folderItemIsHideRecursion(t,!0))},this.folderItemIsHideRecursion=(e,t)=>{if(e._setVisible(t),!(e.children<=0))for(let r=0;r<e.children.length;r++)"ModelItem"===e.children[r].type?this.modelIsHide(e.children[r],t):"FolderItem"!==e.children[r].type&&"BuildingItem"!==children.type||this.folderItemIsHideRecursion(e.children[r],t)},this.modelIsHide=(e,t)=>{e._setVisible(t),e.getGroup().visible=t,_context.scene.children.map((r=>{"__sysObjectsWater"===r.name&&r.children.map((r=>{r.userData.modelName===e.name&&(r.visible=t)}))}))},this.renameItem=(e,t,r)=>{e&&t&&("ModelItem"===this.getItemByName(t).type&&(_context.scene.models.getObjectByName(t).name=e),this.getItemByName(t).rename(e,r))},this.nodeInObject=e=>{if("string"==typeof e&&""!==e)for(let t=0;t<this.children.length;t++)return this.nodeInObjectRecursion(this.children[t],e)},this.nodeInObjectRecursion=(e,t)=>{if(t&&e)if("ModelItem"===e.type){if(e.children.length>0)for(let r=0;r<e.children.length;r++)if(this.modelItemRecursion(e.children[r],t))return e}else if("FolderItem"===e.type)for(let r=0;r<e.children.length;r++)return this.nodeInObjectRecursion(e.children[r],t)},this.modelItemRecursion=(e,t)=>{if(e.name===t)return!0;if(e.children.length>0)for(let r=0;r<e.children.length;r++)return this.modelItemRecursion(e.children[r],t)},this.objectTreeRemove=(e,t)=>{if(t&&e)for(let r=e.length-1;r>=0;r--)e[r].name===t?e.splice(r,1):this.objectTreeRemove(e[r],t)},this.removeAsset=(e,t)=>{e&&this.removeAssetRecursion(this.children,e,t)},this.removeAssetRecursion=(e,t,r)=>{for(let n=0;n<e.length;n++)if("IconAsset"===e[n].type){if(e[n].name===t)return _context.scene.models.remove(_context.scene.models.getObjectByName(e[n].name)),e.splice(n,1),void(r&&r(1,"删除成功"))}else"BuildingItem"===e[n].type&&e[n].children.length>0&&this.removeAssetRecursion(e[n].children,t,r)},this.removeItem=(e,t)=>{e&&this.removeItemRecursion(this.children,e,t)},this.removeItemRecursion=(e,t,r)=>{for(let n=0;n<e.length;n++)if("ModelItem"===e[n].type){if(e[n].name===t)return _context.scene.models.remove(_context.scene.models.getObjectByName(e[n].name)),e.splice(n,1),void(r&&r(1,"删除成功"))}else if("FolderItem"===e[n].type||"BuildingItem"===e[n].type){if(e[n].name===t)return _context.scene.models.remove(_context.scene.models.getObjectByName(e[n].name)),e.splice(n,1),void(r&&r(1,"删除成功"));e[n].children.length>0&&this.removeItemRecursion(e[n].children,t,r)}},this.getItemByName=e=>{if("string"==typeof e&&""!==e)for(let t=0;t<this.children.length;t++){let r=this.itemRecursion(this.children[t],e);if(r)return r}},this.itemRecursion=(e,t)=>{if(t&&e){if(e.name===t)return e;if(("FolderItem"===e.type||"BuildingItem"===e.type||"BuildingFloorItem"===e.type)&&e.children.length>0)for(let r=0;r<e.children.length;r++){let n=this.itemRecursion(e.children[r],t);if(n)return n}}},this.getItemByUUID=e=>{if("string"==typeof e&&""!==e)for(let t=0;t<this.children.length;t++){let r=this.getItemByUUIDRecursion(this.children[t],e);if(r)return r}},this.getItemByUUIDRecursion=(e,t)=>{if(t&&e)if(e.getGroup){if(e.getGroup()&&e.getGroup().uuid===t)return e;if(e.children.length>0)for(let r=0;r<e.children.length;r++){let n=this.getItemByUUIDRecursion(e.children[r],t);if(n)return n}}else{if(e.id===t)return e;if(e.children&&e.children.length>0)for(let r=0;r<e.children.length;r++){let n=this.getItemByUUIDRecursion(e.children[r],t);if(n)return n}}},this.getSettings=()=>JSON.parse(JSON.stringify({children:util$1.getSettingsRecursively(this.children)})),this.applySettings=(e,t,r)=>{if(!e)return void logger.error("无效的模型设置。");if(!e.children)return void logger.error("无效的模型设置。");if(!e.children.map)return void logger.error("无效的模型设置。");let n=this;e.children.map((e=>{let t=n.getItemByName(e.name);if(t){if("BuildingItem"===e.type)e.children.forEach((e=>{if("ModelItem"===e.type){var r=n.findMaterialRecursion(t,e.name);r&&r.materialStore&&r.materialStore.applySettings(e.materials),r&&r.hide&&!e.isVisible?r.hide():r&&r.show&&e.isVisible&&r.show()}else"BuildingFloorItem"===e.type&&e.children.forEach((e=>{if("ModelItem"===e.type){var r=n.findMaterialRecursion(t,e.name);r&&r.materialStore&&r.materialStore.applySettings(e.materials)}}))}));else if("ModelItem"===e.type){util$1.setArticulation(e,t),n.findMaterialRecursion(t,e.name)&&t.materialStore&&t.materialStore.applySettings(e.materials)}if(e.isVisible?t.show():t.hide(),t._setLock(e.isLock),e.animations instanceof Array)for(let t of e.animations){let r=[];for(let e of t.tracks){let t;switch(e.type){case"bool":t=new BooleanKeyframeTrack(e.name,e.times,e.values);break;case"color":t=new ColorKeyframeTrack(e.name,e.times,e.values);break;case"number":t=new NumberKeyframeTrack(e.name,e.times,e.values);break;case"quaternion":t=new QuaternionKeyframeTrack(e.name,e.times,e.values);break;case"string":t=new StringKeyframeTrack(e.name,e.times,e.values);break;case"vector":t=new VectorKeyframeTrack(e.name,e.times,e.values);break;default:t=KeyframeTrack(e.name,e.times,e.values)}r.push(t)}let i=new AnimationClip(t.name,t.duration,r);n._models[e.name].animations.push(i)}void 0!==e.floor&&(t.floor=e.floor),util$1.setNode(e,t,this._nodeSelection,!0),e.isVisible?t.show():t.hide()}}))}}}class Effect{constructor(e){this.enabled=!1,this.type=e,this.name=name,this.paused=!1,this.visible=!0,this.tags=[]}createHelper(e,t,r="#ffff00"){if(this.mesh.getObjectByName("__helper"))this.updateHelper(e,t,r);else{const n=new Box3;n.setFromCenterAndSize(e,t);const i=new Box3Helper(n,new Color(r));i.name="__helper",i.visible=!1,this.mesh.add(i)}}showHelper(){if(!this.mesh)return;let e=this.mesh.getObjectByName("__helper");e&&(e.visible=!0)}hideHelper(){if(!this.mesh)return;let e=this.mesh.getObjectByName("__helper");e&&(e.visible=!1)}updateHelper(e,t,r){if(!this.mesh)return;let n=this.mesh.getObjectByName("__helper");n&&(n.box.setFromCenterAndSize(e,t),void 0!==r&&(n.material.color=r))}}var shaderSource="\n#ifdef TEXTURE_PRECISION_HIGH\n\n\tuniform mediump sampler2D map;\n\n#else\n\n\tuniform lowp sampler2D map;\n\n#endif\n\nvoid mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){\n  vec4 texel = texture2D(map, uv);\n  outputColor = mix(inputColor, texel, texel.a);\n}";class WatermarkEffect extends Effect$1{constructor(e={}){const t=Object.assign({blendFunction:BlendFunction.NORMAL,map:null},e);super("WatermarkEffect",shaderSource,{blendFunction:t.blendFunction,uniforms:new Map([["map",new Uniform(t.map)]])})}setMap(e){this.uniforms.get("map").value=e}}const vertexShader$1="\nvarying vec2 vUv;\n\nvoid main() {\n\tvUv = uv;\n\tgl_Position = vec4(position.xy, 1.0, 1.0);\n}\n",fragmentShader$1="\n#ifdef FRAMEBUFFER_PRECISION_HIGH\n\tuniform mediump sampler2D inputBuffer;\n#else\n\tuniform lowp sampler2D inputBuffer;\n#endif\n\nuniform float radius;\nuniform vec2 texelSize;\nuniform vec2 halfTexelSize;\nuniform float kernel;\nuniform float scale;\n\nvarying vec2 vUv;\n\nvoid main() {\n\n\tfloat d = distance(vec2(0.5, 0.5), vUv) - radius / 2.0;\n\tif (d <= 0.0) {\n\t\tgl_FragColor = texture2D(inputBuffer, vUv);\n\t} else {\n\t\tvec2 dUv = (texelSize * vec2(kernel) + halfTexelSize) * scale;\n\t\tdUv *= (d * 4.0);\n\t\t// Sample top left, top right, bottom left, bottom right texels.\n\t\tvec4 sum = texture2D(inputBuffer, vec2(vUv.x - dUv.x, vUv.y + dUv.y)) \n\t\t\t+ texture2D(inputBuffer, vec2(vUv.x + dUv.x, vUv.y + dUv.y))\n\t\t\t+ texture2D(inputBuffer, vec2(vUv.x + dUv.x, vUv.y - dUv.y))\n\t\t\t+ texture2D(inputBuffer, vec2(vUv.x - dUv.x, vUv.y - dUv.y));\n\t\t// Compute the average.\n\t\tgl_FragColor = sum * 0.25;\n\t\n\t\t#ifdef DITHERING\n\t\n\t\t\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n\t\n\t\t#endif\n\t}\n\t\n}\n";class EdgeBlurMaterial extends ShaderMaterial{constructor(e=new Vector2){super({type:"EdgeBlurMaterial",uniforms:{inputBuffer:new Uniform(null),radius:new Uniform(1),texelSize:new Uniform(new Vector2),halfTexelSize:new Uniform(new Vector2),kernel:new Uniform(0),scale:new Uniform(1)},fragmentShader:fragmentShader$1,vertexShader:vertexShader$1,blending:NoBlending,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.setTexelSize(e.x,e.y),this.kernelSize=KernelSize.LARGE}getKernel(){return kernelPresets[this.kernelSize]}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t),this.uniforms.halfTexelSize.value.set(e,t).multiplyScalar(.5)}}const kernelPresets=[new Float32Array([0,0]),new Float32Array([0,1,1]),new Float32Array([0,1,1,2]),new Float32Array([0,1,2,2,3]),new Float32Array([0,1,2,3,4,4,5]),new Float32Array([0,1,2,3,4,5,7,8,9,10])],KernelSize={VERY_SMALL:0,SMALL:1,MEDIUM:2,LARGE:3,VERY_LARGE:4,HUGE:5};class EdgeBlurPass extends Pass{constructor({radius:e=.8,scale:t=1,resolutionScale:r=1,width:n=Resizer.AUTO_SIZE,height:i=Resizer.AUTO_SIZE,kernelSize:a=KernelSize.LARGE}={}){super("EdgeBlurPass"),this.renderTargetA=new WebGLRenderTarget(1,1,{minFilter:LinearFilter,magFilter:LinearFilter,stencilBuffer:!1,depthBuffer:!1}),this.renderTargetA.texture.name="Blur.Target.A",this.renderTargetB=this.renderTargetA.clone(),this.renderTargetB.texture.name="Blur.Target.B",this.resolution=new Resizer(this,n,i,r),this.edgeBlurMaterial=new EdgeBlurMaterial,this.edgeBlurMaterial.uniforms.radius.value=e,this.edgeBlurMaterial.uniforms.scale.value=t,this.ditheredEdgeBlurMaterial=new EdgeBlurMaterial,this.ditheredEdgeBlurMaterial.dithering=!0,this.dithering=!1,this.kernelSize=a}get width(){return this.resolution.width}set width(e){this.resolution.width=e}get height(){return this.resolution.height}set height(e){this.resolution.height=e}get scale(){return this.edgeBlurMaterial.uniforms.scale.value}set scale(e){this.edgeBlurMaterial.uniforms.scale.value=e,this.ditheredEdgeBlurMaterial.uniforms.scale.value=e}get kernelSize(){return this.edgeBlurMaterial.kernelSize}set kernelSize(e){this.edgeBlurMaterial.kernelSize=e,this.ditheredEdgeBlurMaterial.kernelSize=e}get radius(){return this.edgeBlurMaterial.uniforms.radius.value}set radius(e){this.edgeBlurMaterial.uniforms.radius.value=e}render(e,t,r,n,i){const a=this.scene,o=this.camera,s=this.renderTargetA,l=this.renderTargetB;let c=this.edgeBlurMaterial,h=c.uniforms;const u=c.getKernel();let d,p,f,m=t;for(this.setFullscreenMaterial(c),p=0,f=u.length-1;p<f;++p)d=0==(1&p)?s:l,h.kernel.value=u[p],h.inputBuffer.value=m.texture,e.setRenderTarget(d),e.render(a,o),m=d;this.dithering&&(c=this.ditheredEdgeBlurMaterial,h=c.uniforms,this.setFullscreenMaterial(c)),h.kernel.value=u[p],h.inputBuffer.value=m.texture,e.setRenderTarget(this.renderToScreen?null:r),e.render(a,o)}setSize(e,t){const r=this.resolution;r.base.set(e,t);const n=r.width,i=r.height;this.renderTargetA.setSize(n,i),this.renderTargetB.setSize(n,i),this.edgeBlurMaterial.setTexelSize(1/n,1/i),this.ditheredEdgeBlurMaterial.setTexelSize(1/n,1/i)}initialize(e,t,r){if(t||r!==UnsignedByteType||(this.renderTargetA.texture.format=RGBFormat,this.renderTargetB.texture.format=RGBFormat),void 0!==r&&(this.renderTargetA.texture.type=r,this.renderTargetB.texture.type=r,r!==UnsignedByteType)){const e=this.edgeBlurMaterial,t=this.ditheredEdgeBlurMaterial;e.defines.FRAMEBUFFER_PRECISION_HIGH="1",t.defines.FRAMEBUFFER_PRECISION_HIGH="1"}}static get AUTO_SIZE(){return Resizer.AUTO_SIZE}}var FireflyShader={defines:{DEPTH_PACKING:1,PERSPECTIVE_CAMERA:1},uniforms:{time:{value:0},speed:{value:1},color:{value:new Color(1,1,1)},brightness:{value:1},size:{value:1}},vertexShader:["precision highp float;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float time;","uniform float speed;","uniform float size;","attribute vec3 position;","attribute vec2 uv;","attribute vec3 translate;","varying vec2 vUv;","varying float vScale;","void main() {","vec4 pos=vec4(translate, 1.0 );","pos.x=pos.x+sin(pos.x+time*speed)*50.0;","pos.y=pos.y+sin(pos.y+time*speed)*50.0;","pos.z=pos.z+sin(pos.z+time*speed)*50.0;","vec4 mvPosition = modelViewMatrix * pos;","vec3 trTime = vec3(translate.x + time,translate.y + time,translate.z + time);","float scale = sin( trTime.x * 0.21 * 2.0 );","vScale = scale;","scale = scale * 10.0 + 10.0;","mvPosition.xyz += position*size/10.0;//* scale","vUv = uv;","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["precision highp float;","uniform sampler2D map;","uniform vec3 color;","uniform float brightness;","varying vec2 vUv;","varying float vScale;","vec3 HUEtoRGB(float H){","H = mod(H,1.0);","float R = abs(H * 6.0 - 3.0) - 1.0;","float G = 2.0 - abs(H * 6.0 - 2.0);","float B = 2.0 - abs(H * 6.0 - 4.0);","return clamp(vec3(R,G,B),0.0,1.0);","}","vec3 HSLtoRGB(vec3 HSL){","vec3 RGB = HUEtoRGB(HSL.x);","float C = (1.0 - abs(2.0 * HSL.z - 1.0)) * HSL.y;","return (RGB - 0.5) * C + HSL.z;","}","void main() {","vec4 diffuseColor = texture2D( map, vUv );","gl_FragColor = vec4( diffuseColor.r * color.r, diffuseColor.g * color.g, diffuseColor.b * color.b, brightness * abs(vScale) * diffuseColor.a );","//gl_FragColor = vec4( 10,0,0, brightness * vScale * diffuseColor.w );","}"].join("\n")},HeatmapShader={uniforms:{map:{value:null},bgMap:{value:null},color:{value:new Color(1,1,1)},brightness:{value:1}},vertexShader:["precision highp float;","varying vec2 vUvv;","varying vec2 pUv;","void main() {","\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );","   vUvv=uv;","   pUv=vec2(worldPosition.x,worldPosition.z);","\tgl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform sampler2D map;","uniform sampler2D bgMap;","uniform vec4 color;","uniform float brightness;","varying vec2 vUvv;","varying vec2 pUv;","void main() {","\tvec4 dColor = texture2D( map, vUvv);","   vec2 bguv=pUv;","   bguv.x*=0.1;","   bguv.y*=0.1;","\tvec4 bgColor =texture2D(bgMap,bguv);","\tvec4 finalColor =mix(dColor,bgColor,bgColor.a);//(dColor+bgColor）*color*brightness;","\tgl_FragColor =vec4(finalColor.rgb,dColor.a);","   //gl_FragColor=vec4(vReflectionFactor,vReflectionFactor,vReflectionFactor,1.0);","}"].join("\n")};const LensDistortionShader={defines:{BAND_MODE:2,CHROMA_SAMPLES:1},uniforms:{tDiffuse:{value:null},baseIor:{value:.075},bandOffset:{value:.003},jitterIntensity:{value:1},jitterOffset:{value:0}},vertexShader:"\n\t\tvarying vec2 vUv; \n\t\tvarying vec3 viewDir;\n\t\tvoid main() {\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\tviewDir = normalize( ( modelViewMatrix * vec4( position, 1.0 ) ).xyz );\n\t\t}\n\t",fragmentShader:"\n\t\tvarying vec2 vUv;\n\t\tvarying vec3 viewDir;\n\t\tuniform float baseIor;\n\t\tuniform float bandOffset;\n\t\tuniform float jitterIntensity;\n\t\tuniform float jitterOffset;\n\t\tuniform sampler2D tDiffuse;\n\n\t\t#include <common>\n\t\tvoid main() {\n\n\t\t\tvec3 normal = vec3( ( 2.0 * vUv - vec2( 1.0 ) ), 1.0 );\n\t\t\tnormal.z = 1.0;\n\t\t\tnormal = normalize( normal );\n\n\t\t\tvec3 color;\n\n\t\t\t// if NO BANDS\n\t\t\t#if BAND_MODE == 0\n\n\t\t\tvec3 refracted = refract( vec3( 0.0, 0.0, - 1.0 ), normal, baseIor );\n\t\t\tcolor = texture2D( tDiffuse, vUv + refracted.xy ).rgb;\n\n\t\t\t// if RGB or RYGCBV BANDS\n\t\t\t#else\n\n\t\t\tfloat index, randValue, offsetValue;\n\t\t\tfloat r, g, b, r_ior, g_ior, b_ior;\n\t\t\tvec3 r_refracted, g_refracted, b_refracted;\n\t\t\tvec4 r_sample, g_sample, b_sample;\n\n\t\t\t#if BAND_MODE == 2\n\t\t\tfloat y, c, v, y_ior, c_ior, v_ior;\n\t\t\tvec3 y_refracted, c_refracted, v_refracted;\n\t\t\tvec4 y_sample, c_sample, v_sample;\n\t\t\t#endif\n\n\t\t\tfor ( int i = 0; i < CHROMA_SAMPLES; i ++ ) {\n\t\t\t\tindex = float( i );\n\t\t\t\trandValue = rand( sin( index + 1. ) * gl_FragCoord.xy + vec2( jitterOffset, - jitterOffset ) ) - 0.5;\n\t\t\t\toffsetValue = index / float( CHROMA_SAMPLES ) + randValue * jitterIntensity;\n\t\t\t\t#if BAND_MODE == 1\n\t\t\t\trandValue *= 2.0;\n\t\t\t\t#endif\n\n\t\t\t\t// Paper describing functions for creating yellow, cyan, and violet bands and reforming\n\t\t\t\t// them into RGB:\n\t\t\t\t// https://web.archive.org/web/20061108181225/http://home.iitk.ac.in/~shankars/reports/dispersionraytrace.pdf\n\t\t\t\tr_ior = 1.0 + bandOffset * ( 0.0 + offsetValue );\n\t\t\t\tg_ior = 1.0 + bandOffset * ( 2.0 + offsetValue );\n\t\t\t\tb_ior = 1.0 + bandOffset * ( 4.0 + offsetValue );\n\n\t\t\t\tr_refracted = refract( vec3( 0.0, 0.0, - 1.0 ), normal, baseIor / r_ior );\n\t\t\t\tg_refracted = refract( vec3( 0.0, 0.0, - 1.0 ), normal, baseIor / g_ior );\n\t\t\t\tb_refracted = refract( vec3( 0.0, 0.0, - 1.0 ), normal, baseIor / b_ior );\n\n\t\t\t\tr_sample = texture2D( tDiffuse, vUv + r_refracted.xy );\n\t\t\t\tg_sample = texture2D( tDiffuse, vUv + g_refracted.xy );\n\t\t\t\tb_sample = texture2D( tDiffuse, vUv + b_refracted.xy );\n\n\t\t\t\t#if BAND_MODE == 2\n\t\t\t\ty_ior = 1.0 + bandOffset * ( 1.0 + offsetValue );\n\t\t\t\tc_ior = 1.0 + bandOffset * ( 3.0 + offsetValue );\n\t\t\t\tv_ior = 1.0 + bandOffset * ( 5.0 + offsetValue );\n\n\t\t\t\ty_refracted = refract( vec3( 0.0, 0.0, - 1.0 ), normal, baseIor / y_ior );\n\t\t\t\tc_refracted = refract( vec3( 0.0, 0.0, - 1.0 ), normal, baseIor / c_ior );\n\t\t\t\tv_refracted = refract( vec3( 0.0, 0.0, - 1.0 ), normal, baseIor / v_ior );\n\n\t\t\t\ty_sample = texture2D( tDiffuse, vUv + y_refracted.xy );\n\t\t\t\tc_sample = texture2D( tDiffuse, vUv + c_refracted.xy );\n\t\t\t\tv_sample = texture2D( tDiffuse, vUv + v_refracted.xy );\n\n\t\t\t\tr = r_sample.r / 2.0;\n\t\t\t\ty = ( 2.0 * y_sample.r + 2.0 * y_sample.g - y_sample.b ) / 6.0;\n\t\t\t\tg = g_sample.g / 2.0;\n\t\t\t\tc = ( 2.0 * c_sample.g + 2.0 * c_sample.b - c_sample.r ) / 6.0;\n\t\t\t\tb = b_sample.b / 2.0;\n\t\t\t\tv = ( 2.0 * v_sample.b + 2.0 * v_sample.r - v_sample.g ) / 6.0;\n\n\t\t\t\tcolor.r += r + ( 2.0 * v + 2.0 * y - c ) / 3.0;\n\t\t\t\tcolor.g += g + ( 2.0 * y + 2.0 * c - v ) / 3.0;\n\t\t\t\tcolor.b += b + ( 2.0 * c + 2.0 * v - y ) / 3.0;\n\t\t\t\t#else\n\t\t\t\tcolor.r += r_sample.r;\n\t\t\t\tcolor.g += g_sample.g;\n\t\t\t\tcolor.b += b_sample.b;\n\t\t\t\t#endif\n\t\t\t}\n\t\t\tcolor /= float( CHROMA_SAMPLES );\n\t\t\t#endif\n\t\t\tgl_FragColor = vec4( color, 1.0 );\n\t\t}\n\t"};var THREE_MeshLine=createCommonjsModule((function(e,t){(function(){var r=void 0!==commonjsRequire,n=this.THREE||r&&require$$0;if(!n)throw new Error("MeshLine requires three.js");function i(){n.BufferGeometry.call(this),this.type="MeshLine",this.positions=[],this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[],this.counters=[],this._points=[],this._geom=null,this.widthCallback=null,this.matrixWorld=new n.Matrix4,Object.defineProperties(this,{geometry:{enumerable:!0,get:function(){return this}},geom:{enumerable:!0,get:function(){return this._geom},set:function(e){this.setGeometry(e,this.widthCallback)}},points:{enumerable:!0,get:function(){return this._points},set:function(e){this.setPoints(e,this.widthCallback)}}})}function a(e,t){var r=new n.Matrix4,i=new n.Ray,a=new n.Sphere,o=new n.Vector3,s=this.geometry;if(a.copy(s.boundingSphere),a.applyMatrix4(this.matrixWorld),!1!==e.ray.intersectSphere(a,o)){r.copy(this.matrixWorld).invert(),i.copy(e.ray).applyMatrix4(r);var l=new n.Vector3,c=new n.Vector3,h=new n.Vector3,u=this instanceof n.LineSegments?2:1,d=s.index,p=s.attributes;if(null!==d)for(var f=d.array,m=p.position.array,g=p.width.array,y=0,v=f.length-1;y<v;y+=u){var b=f[y],_=f[y+1];l.fromArray(m,3*b),c.fromArray(m,3*_);var x=null!=g[Math.floor(y/3)]?g[Math.floor(y/3)]:1,w=e.params.Line.threshold+this.material.lineWidth*x/2,S=w*w;if(!(i.distanceSqToSegment(l,c,o,h)>S)){o.applyMatrix4(this.matrixWorld);var M=e.ray.origin.distanceTo(o);M<e.near||M>e.far||(t.push({distance:M,point:h.clone().applyMatrix4(this.matrixWorld),index:y,face:null,faceIndex:null,object:this}),y=v)}}}}function o(e,t,r,n,i){var a;if(e=e.subarray||e.slice?e:e.buffer,r=r.subarray||r.slice?r:r.buffer,e=t?e.subarray?e.subarray(t,i&&t+i):e.slice(t,i&&t+i):e,r.set)r.set(e,n);else for(a=0;a<e.length;a++)r[a+n]=e[a];return r}function s(e){n.ShaderMaterial.call(this,{uniforms:Object.assign({},n.UniformsLib.fog,{lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},maskMap:{value:null},useMaskMap:{value:0},color:{value:new n.Color(16777215)},opacity:{value:1},resolution:{value:new n.Vector2(1,1)},sizeAttenuation:{value:1},dashArray:{value:0},dashOffset:{value:0},dashRatio:{value:.5},useDash:{value:0},visibility:{value:1},alphaTest:{value:0},repeat:{value:new n.Vector2(1,1)},offset:{value:new n.Vector2(0,0)},colorPass:{value:new n.Color(16777215)},pass:{value:0},passRange:{value:.05},faceUp:{value:!1}}),vertexShader:n.ShaderChunk.meshline_vert,fragmentShader:n.ShaderChunk.meshline_frag}),this.type="MeshLineMaterial",Object.defineProperties(this,{lineWidth:{enumerable:!0,get:function(){return this.uniforms.lineWidth.value},set:function(e){this.uniforms.lineWidth.value=e}},map:{enumerable:!0,get:function(){return this.uniforms.map.value},set:function(e){this.uniforms.map.value=e}},useMap:{enumerable:!0,get:function(){return this.uniforms.useMap.value},set:function(e){this.uniforms.useMap.value=e}},alphaMap:{enumerable:!0,get:function(){return this.uniforms.alphaMap.value},set:function(e){this.uniforms.alphaMap.value=e}},useAlphaMap:{enumerable:!0,get:function(){return this.uniforms.useAlphaMap.value},set:function(e){this.uniforms.useAlphaMap.value=e}},maskMap:{enumerable:!0,get:function(){return this.uniforms.maskMap.value},set:function(e){this.uniforms.maskMap.value=e}},useMaskMap:{enumerable:!0,get:function(){return this.uniforms.useMaskMap.value},set:function(e){this.uniforms.useMaskMap.value=e}},color:{enumerable:!0,get:function(){return this.uniforms.color.value},set:function(e){this.uniforms.color.value=e}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}},sizeAttenuation:{enumerable:!0,get:function(){return this.uniforms.sizeAttenuation.value},set:function(e){this.uniforms.sizeAttenuation.value=e}},dashArray:{enumerable:!0,get:function(){return this.uniforms.dashArray.value},set:function(e){this.uniforms.dashArray.value=e,this.useDash=0!==e?1:0}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},dashRatio:{enumerable:!0,get:function(){return this.uniforms.dashRatio.value},set:function(e){this.uniforms.dashRatio.value=e}},useDash:{enumerable:!0,get:function(){return this.uniforms.useDash.value},set:function(e){this.uniforms.useDash.value=e}},visibility:{enumerable:!0,get:function(){return this.uniforms.visibility.value},set:function(e){this.uniforms.visibility.value=e}},alphaTest:{enumerable:!0,get:function(){return this.uniforms.alphaTest.value},set:function(e){this.uniforms.alphaTest.value=e}},repeat:{enumerable:!0,get:function(){return this.uniforms.repeat.value},set:function(e){this.uniforms.repeat.value.copy(e)}},offset:{enumerable:!0,get:function(){return this.uniforms.offset.value},set:function(e){this.uniforms.offset.value.copy(e)}},colorPass:{enumerable:!0,get:function(){return this.uniforms.colorPass.value},set:function(e){this.uniforms.colorPass.value.copy(e)}},pass:{enumerable:!0,get:function(){return this.uniforms.pass.value},set:function(e){this.uniforms.pass.value=e}},passRange:{enumerable:!0,get:function(){return this.uniforms.passRange.value},set:function(e){this.uniforms.passRange.value=e}},faceUp:{enumerable:!0,get:function(){return this.uniforms.faceUp.value},set:function(e){this.uniforms.faceUp.value=e}}}),this.setValues(e)}i.prototype=Object.create(n.BufferGeometry.prototype),i.prototype.constructor=i,i.prototype.isMeshLine=!0,i.prototype.setMatrixWorld=function(e){this.matrixWorld=e},i.prototype.setGeometry=function(e,t){this._geometry=e,e instanceof n.BufferGeometry?this.setPoints(e.getAttribute("position").array,t):this.setPoints(e,t)},i.prototype.setPoints=function(e,t){if(e instanceof Float32Array||e instanceof Array){if(this._points=e,this.widthCallback=t,this.positions=[],this.counters=[],e.length&&e[0]instanceof n.Vector3)for(var r=0;r<e.length;r++){var i=e[r],a=r/e.length;this.positions.push(i.x,i.y,i.z),this.positions.push(i.x,i.y,i.z),this.counters.push(a),this.counters.push(a)}else for(r=0;r<e.length;r+=3){a=r/e.length;this.positions.push(e[r],e[r+1],e[r+2]),this.positions.push(e[r],e[r+1],e[r+2]),this.counters.push(a),this.counters.push(a)}this.process()}else logger.error("ERROR: The BufferArray of points is not instancied correctly.")},i.prototype.raycast=a,i.prototype.compareV3=function(e,t){var r=6*e,n=6*t;return this.positions[r]===this.positions[n]&&this.positions[r+1]===this.positions[n+1]&&this.positions[r+2]===this.positions[n+2]},i.prototype.copyV3=function(e){var t=6*e;return[this.positions[t],this.positions[t+1],this.positions[t+2]]},i.prototype.process=function(){var e,t,r=this.positions.length/6;this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[],t=this.compareV3(0,r-1)?this.copyV3(r-2):this.copyV3(0),this.previous.push(t[0],t[1],t[2]),this.previous.push(t[0],t[1],t[2]);for(var i=0;i<r;i++){if(this.side.push(1),this.side.push(-1),e=this.widthCallback?this.widthCallback(i/(r-1)):1,this.width.push(e),this.width.push(e),this.uvs.push(i/(r-1),0),this.uvs.push(i/(r-1),1),i<r-1){t=this.copyV3(i),this.previous.push(t[0],t[1],t[2]),this.previous.push(t[0],t[1],t[2]);var a=2*i;this.indices_array.push(a,a+1,a+2),this.indices_array.push(a+2,a+1,a+3)}i>0&&(t=this.copyV3(i),this.next.push(t[0],t[1],t[2]),this.next.push(t[0],t[1],t[2]))}t=this.compareV3(r-1,0)?this.copyV3(1):this.copyV3(r-1),this.next.push(t[0],t[1],t[2]),this.next.push(t[0],t[1],t[2]),this._attributes&&this._attributes.position.count===this.positions.length?(this._attributes.position.copyArray(new Float32Array(this.positions)),this._attributes.position.needsUpdate=!0,this._attributes.previous.copyArray(new Float32Array(this.previous)),this._attributes.previous.needsUpdate=!0,this._attributes.next.copyArray(new Float32Array(this.next)),this._attributes.next.needsUpdate=!0,this._attributes.side.copyArray(new Float32Array(this.side)),this._attributes.side.needsUpdate=!0,this._attributes.width.copyArray(new Float32Array(this.width)),this._attributes.width.needsUpdate=!0,this._attributes.uv.copyArray(new Float32Array(this.uvs)),this._attributes.uv.needsUpdate=!0,this._attributes.index.copyArray(new Uint16Array(this.indices_array)),this._attributes.index.needsUpdate=!0):this._attributes={position:new n.BufferAttribute(new Float32Array(this.positions),3),previous:new n.BufferAttribute(new Float32Array(this.previous),3),next:new n.BufferAttribute(new Float32Array(this.next),3),side:new n.BufferAttribute(new Float32Array(this.side),1),width:new n.BufferAttribute(new Float32Array(this.width),1),uv:new n.BufferAttribute(new Float32Array(this.uvs),2),index:new n.BufferAttribute(new Uint16Array(this.indices_array),1),counters:new n.BufferAttribute(new Float32Array(this.counters),1)},this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setIndex(this._attributes.index),this.computeBoundingSphere(),this.computeBoundingBox()},i.prototype.advance=function(e){var t=this._attributes.position.array,r=this._attributes.previous.array,n=this._attributes.next.array,i=t.length;o(t,0,r,0,i),o(t,6,t,0,i-6),t[i-6]=e.x,t[i-5]=e.y,t[i-4]=e.z,t[i-3]=e.x,t[i-2]=e.y,t[i-1]=e.z,o(t,6,n,0,i-6),n[i-6]=e.x,n[i-5]=e.y,n[i-4]=e.z,n[i-3]=e.x,n[i-2]=e.y,n[i-1]=e.z,this._attributes.position.needsUpdate=!0,this._attributes.previous.needsUpdate=!0,this._attributes.next.needsUpdate=!0},n.ShaderChunk.meshline_vert=["",n.ShaderChunk.logdepthbuf_pars_vertex,n.ShaderChunk.fog_pars_vertex,"","attribute vec3 previous;","attribute vec3 next;","attribute float side;","attribute float width;","attribute float counters;","","uniform vec2 resolution;","uniform float lineWidth;","uniform vec3 color;","uniform vec3 colorPass;","uniform float opacity;","uniform float sizeAttenuation;","uniform bool faceUp;","","varying vec2 vUV;","varying vec4 vColor;","varying vec4 vColorPass;","varying float vCounters;","","vec2 fix( vec4 i, float aspect ) {","","    vec2 res = i.xy / i.w;","    res.x *= aspect;","\t   vCounters = counters;","    return res;","","}","","void main() {","","    float aspect = resolution.x / resolution.y;","","    vColor = vec4( color, opacity );","    vColorPass = vec4( colorPass, opacity );","    vUV = uv;","    vec4 finalPosition;","    mat4 m = projectionMatrix * modelViewMatrix;","","    if (faceUp) {","        vec2 dir;","        float angel = 0.0;","        if( next == position ) dir = normalize( position.xz  - previous.xz );","        else if( previous == position ) dir = normalize( next.xz - position.xz );","        else {","            vec2 dir1 = normalize( position.xz - previous.xz );","            vec2 dir2 = normalize( next.xz - position.xz );","            dir = normalize( dir1 + dir2 );","            angel = acos(dot(dir1, dir2) / (sqrt(dir1.x * dir1.x + dir1.y * dir1.y) + sqrt(dir2.x * dir2.x + dir2.y * dir2.y)));","            vec2 perp = vec2( -dir1.y, dir1.x );","            vec2 miter = vec2( -dir.y, dir.x );","            //w = clamp( w / dot( miter, perp ), 0., 4. * lineWidth * width );","","        }","        vec4 normal = vec4( -dir.y, 0., dir.x, 1. );","        vec4 positionP = vec4( position, 1.0 );","        float widthRatio = mix( 1.0, 2.0 , (3.1415926535897 - angel) / 3.1415926535897);","        if( 3.1415926535897 - angel > 3.1415926535897 / 2.0 ) {","            widthRatio = lineWidth * sin((3.1415926535897 - angel) / 2.0);","        } else {","            widthRatio = lineWidth / sin((3.1415926535897 - angel) / 2.0);","        }","        if (angel == 0.0) {","            widthRatio = lineWidth;","            widthRatio /= 2.0;","        }","        positionP.xz += normal.xz * side * widthRatio;","        finalPosition = m * positionP;","    } else {","        finalPosition = m * vec4( position, 1.0 );","        vec4 prevPos = m * vec4( previous, 1.0 );","        vec4 nextPos = m * vec4( next, 1.0 );","","        vec2 currentP = fix( finalPosition, aspect );","        vec2 prevP = fix( prevPos, aspect );","        vec2 nextP = fix( nextPos, aspect );","","        float w = lineWidth * width;","","        vec2 dir;","        if( nextP == currentP ) dir = normalize( currentP - prevP );","        else if( prevP == currentP ) dir = normalize( nextP - currentP );","        else {","            vec2 dir1 = normalize( currentP - prevP );","            vec2 dir2 = normalize( nextP - currentP );","            dir = normalize( dir1 + dir2 );","","            vec2 perp = vec2( -dir1.y, dir1.x );","            vec2 miter = vec2( -dir.y, dir.x );","            //w = clamp( w / dot( miter, perp ), 0., 4. * lineWidth * width );","","        }","","        vec4 normal = vec4( -dir.y, dir.x, 0., 1. );","        normal.xy *= .5 * w;","        normal *= projectionMatrix;","        if( sizeAttenuation == 0. ) {","            normal.xy *= finalPosition.w;","            normal.xy /= ( vec4( resolution, 0., 1. ) * projectionMatrix ).xy;","        }","        finalPosition.xy += normal.xy * side;","    }","    gl_Position = finalPosition;","",n.ShaderChunk.logdepthbuf_vertex,n.ShaderChunk.fog_vertex&&"    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",n.ShaderChunk.fog_vertex,"}"].join("\n"),n.ShaderChunk.meshline_frag=["",n.ShaderChunk.fog_pars_fragment,n.ShaderChunk.logdepthbuf_pars_fragment,"","uniform sampler2D map;","uniform sampler2D alphaMap;","uniform sampler2D maskMap;","uniform float useMap;","uniform float useAlphaMap;","uniform float useMaskMap;","uniform float useDash;","uniform float dashArray;","uniform float dashOffset;","uniform float dashRatio;","uniform float visibility;","uniform float alphaTest;","uniform vec2 repeat;","uniform vec2 offset;","uniform float pass;","uniform float passRange;","","varying vec2 vUV;","varying vec4 vColor;","varying vec4 vColorPass;","varying float vCounters;","","void main() {","",n.ShaderChunk.logdepthbuf_fragment,"","    vec4 c;","    if (vUV.x < pass - passRange) {","        c = vColorPass;","    } else if (vUV.x > pass + passRange){","        c = vColor;","    } else {","        c = mix(vColorPass, vColor, (vUV.x - (pass - passRange)) / (passRange * 2.0));","    }","    vec2 vUV2 = vUV + offset;","    if( useMap == 1. ) c *= texture2D( map, vUV2 * repeat );","    if( useAlphaMap == 1. ) c.a *= texture2D( alphaMap, vUV2 * repeat ).a;","    if( useMaskMap == 1. ) {","        vec4 mask = texture2D( maskMap, vUV2 * repeat );","        c.a *= (( mask.r + mask.g + mask.b ) / 3.0 );","    }","    if( c.a < alphaTest ) discard;","    if( useDash == 1. ){","        c.a *= ceil(mod(vCounters + dashOffset, dashArray) - (dashArray * dashRatio));","    }","    gl_FragColor = c;","    gl_FragColor.a *= step(vCounters, visibility);","",n.ShaderChunk.fog_fragment,"}"].join("\n"),s.prototype=Object.create(n.ShaderMaterial.prototype),s.prototype.constructor=s,s.prototype.isMeshLineMaterial=!0,s.prototype.copy=function(e){return n.ShaderMaterial.prototype.copy.call(this,e),this.lineWidth=e.lineWidth,this.map=e.map,this.useMap=e.useMap,this.alphaMap=e.alphaMap,this.useAlphaMap=e.useAlphaMap,this.maskMap=e.maskMap,this.useMaskMap=e.useMaskMap,this.color.copy(e.color),this.opacity=e.opacity,this.resolution.copy(e.resolution),this.sizeAttenuation=e.sizeAttenuation,this.dashArray.copy(e.dashArray),this.dashOffset.copy(e.dashOffset),this.dashRatio.copy(e.dashRatio),this.useDash=e.useDash,this.visibility=e.visibility,this.alphaTest=e.alphaTest,this.repeat.copy(e.repeat),this.offset.copy(e.offset),this.colorPass.copy(e.colorPass),this.pass=e.pass,this.passRange=e.passRange,this},e.exports&&(t=e.exports={MeshLine:i,MeshLineMaterial:s,MeshLineRaycast:a}),t.MeshLine=i,t.MeshLineMaterial=s,t.MeshLineRaycast=a}).call(commonjsGlobal)})),RainlineShader={defines:{DEPTH_PACKING:1,PERSPECTIVE_CAMERA:1},uniforms:{time:{value:0},speed:{value:1},color:{value:new Color(1,1,1)},brightness:{value:1},width:{value:1},height:{value:1}},vertexShader:["precision highp float;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float time;","uniform float speed;","uniform float width;","uniform float height;","attribute vec3 position;","attribute vec2 uv;","attribute vec3 translate;","varying vec2 vUv;","varying float vScale;","void main() {","vec4 pos=vec4(translate, 1.0 );","pos.y+=position.y*height;","vec4 mvPosition =  modelViewMatrix * pos;","vec3 trTime = vec3(translate.x - time,translate.y - time,translate.z - time);","float scale =  (trTime.x+trTime.y+trTime.z)*0.33*speed;","vScale = scale;","mvPosition.xyz += vec3(position.x*width,0,position.z*width);//* scale","vUv = uv;","gl_Position = projectionMatrix *mvPosition;","}"].join("\n"),fragmentShader:["precision highp float;","uniform sampler2D map;","uniform vec3 color;","uniform float brightness;","uniform float opacity;","varying vec2 vUv;","varying float vScale;","vec3 HUEtoRGB(float H){","H = mod(H,1.0);","float R = abs(H * 6.0 - 3.0) - 1.0;","float G = 2.0 - abs(H * 6.0 - 2.0);","float B = 2.0 - abs(H * 6.0 - 4.0);","return clamp(vec3(R,G,B),0.0,1.0);","}","vec3 HSLtoRGB(vec3 HSL){","vec3 RGB = HUEtoRGB(HSL.x);","float C = (1.0 - abs(2.0 * HSL.z - 1.0)) * HSL.y;","return (RGB - 0.5) * C + HSL.z;","}","void main() {","vec2 uv=vUv;","//uv.y+=vScale;","uv.y=uv.y+mod(vScale,20.0)*0.1-1.0;","vec4 diffuseColor = texture2D( map, uv );","float alpha=diffuseColor.w;","if(uv.y>=1.0||uv.y<=0.0){","alpha=0.0;","}","gl_FragColor = vec4( diffuseColor.xyz * color *brightness , alpha*opacity );","}"].join("\n")};const SharpenShader={uniforms:{tDiffuse:{type:"t",value:null},width:{type:"f",value:0},height:{type:"f",value:0},kernel:{type:"fv1",value:[-1,-1,-1,-1,9,-1,-1,-1,-1]},intensity:{type:"f",value:.1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","uniform float width;","uniform float height;","uniform float kernel[9];","uniform float intensity;","void main(void)","{","float step_w = intensity/width;","float step_h = intensity/height;","vec2 offset[9];","offset[0] = vec2(-step_w, -step_h);","offset[1] = vec2(0.0, -step_h);","offset[2] = vec2(step_w, -step_h);","offset[3] = vec2(-step_w, 0.0);","offset[4] = vec2(0.0, 0.0);","offset[5] = vec2(step_w, 0.0);","offset[6] = vec2(-step_w, step_h);","offset[7] = vec2(0.0, step_h);","offset[8] = vec2(step_w, step_h);","vec3 sum = vec3(0.0);","for( int i=0; i<9; i++ )","sum += texture2D(tDiffuse, vUv + offset[i]).rgb * kernel[i];","gl_FragColor = vec4(sum,1.0);","}"].join("\n")},vertexShader="\nvarying vec2 vUv;\n\nvoid mainSupport(const in vec2 uv) {\n\n  vUv = uv;\n\n}\n",fragmentShader="\nvarying vec2 vUv;\n\nuniform sampler2D tDiffuse;\nuniform sampler2D tDepth;\nuniform sampler2D tNormal;\nuniform sampler2D tMetalness;\nuniform float cameraNear;\nuniform float cameraFar;\nuniform mat4 cameraProjectionMatrix;\nuniform mat4 cameraInverseProjectionMatrix;\nuniform float maxDistance;\nuniform float thickness;\nuniform float opacity;\nuniform float resolutionScale;\n\nfloat pointToLineDistance(vec3 x0, vec3 x1, vec3 x2) {\n  return length(cross(x0 - x1, x0 - x2)) / length(x2 - x1);\n}\n\nfloat pointPlaneDistance(vec3 point, vec3 planePoint, vec3 planeNormal) {\n  float a = planeNormal.x, b = planeNormal.y, c = planeNormal.z;\n  float x0 = point.x, y0 = point.y, z0 = point.z;\n  float x = planePoint.x, y = planePoint.y, z = planePoint.z;\n  float d = -(a * x + b * y + c * z);\n  float distance = (a * x0 + b * y0 + c * z0 + d) / sqrt(a * a + b * b + c * c);\n  return distance;\n}\n\nfloat getDepth(vec2 uv) {\n  return unpackRGBAToDepth(texture2D(tDepth, uv));\n}\n\nfloat getViewZ(const in float depth){\n  return perspectiveDepthToViewZ(depth, cameraNear, cameraFar);\n}\n\nvec3 getViewPosition(const in vec2 uv, const in float depth, const in float clipW){\n  vec4 clipPosition = vec4((vec3(uv,depth) - .5) * 2., 1.);\n  clipPosition *= clipW;\n  return (cameraInverseProjectionMatrix * clipPosition).xyz;\n}\n\nvec3 getViewNormal(const in vec2 uv){\n    return unpackRGBToNormal(texture2D(tNormal, uv).xyz);\n}\n\nvec2 viewPositionToXY(vec3 viewPosition){\n    vec2 xy;\n    vec4 clip = cameraProjectionMatrix * vec4(viewPosition, 1);\n    xy = clip.xy;\n    float clipW = clip.w;\n    xy /= clipW;\n    xy = (xy + 1.) / 2.;\n    xy *= resolution;\n    return xy;\n}\n\nvoid mainImage(const in vec4 inputColor, const in vec2 uv, const in float depth, out vec4 outputColor) {\n\n  // outputColor = texture2D(tMetalness, uv);\n  // return;\n\n  vec4 normalValue = vec4(unpackRGBToNormal(texture2D(tNormal, uv).xyz), 1.0);\n  float snowRatio = normalValue.g - normalValue.r - normalValue.b;\n  if (snowRatio < 0.0) {\n    snowRatio = 0.0;\n  }\n  // normalValue = cameraInverseProjectionMatrix * normalValue;\n  // outputColor = normalValue;\n  // return;\n\n  float metalness = texture2D(tMetalness, uv).r;\n  if (metalness == 0.) {\n    outputColor = inputColor;\n    return;\n  }\n\n  vec4 reflectColor;\n  float depthValue = getDepth(uv);\n  float viewZ = getViewZ(depthValue);\n\n    if(-viewZ >= cameraFar) {\n    outputColor = inputColor;\n    return;\n  }\n  \n  float clipW = cameraProjectionMatrix[2][3] * viewZ + cameraProjectionMatrix[3][3];\n  vec3 viewPosition = getViewPosition(vUv, depthValue, clipW);\n\n  vec2 d0 = gl_FragCoord.xy;\n  vec2 d1;\n\n  vec3 viewNormal = getViewNormal(vUv);\n    \n#ifdef PERSPECTIVE_CAMERA\n  vec3 viewIncidentDir = normalize(viewPosition);\n  vec3 viewReflectDir = reflect(viewIncidentDir, viewNormal);\n#else\n  vec3 viewIncidentDir = vec3(0, 0, -1);\n  vec3 viewReflectDir = reflect(viewIncidentDir, viewNormal);\n#endif\n    \n  float maxReflectRayLen = maxDistance / dot(-viewIncidentDir, viewNormal);\n    \n  vec3 d1viewPosition = viewPosition + viewReflectDir * maxReflectRayLen;\n\n#ifdef PERSPECTIVE_CAMERA\n  if(d1viewPosition.z > -cameraNear){\n    float t = (-cameraNear-viewPosition.z) / viewReflectDir.z;\n    d1viewPosition = viewPosition + viewReflectDir * t;\n  }\n#endif\n\n  d1 = viewPositionToXY(d1viewPosition);\n\n  float totalLen = length(d1 - d0);\n  float xLen = d1.x - d0.x;\n  float yLen = d1.y - d0.y;\n  float totalStep = max(abs(xLen), abs(yLen));\n  float xSpan = xLen / totalStep;\n  float ySpan = yLen / totalStep;\n\n  for(float i = 0.0; i < float(768); i++){\n    if(i >= totalStep) {\n      break;\n    }\n    vec2 xy = vec2(d0.x + i * xSpan, d0.y + i * ySpan);\n    if(xy.x < 0. || xy.x > resolution.x || xy.y < 0. || xy.y > resolution.y) {\n      break;\n    }\n    float s = length(xy - d0) / totalLen;\n    vec2 uv = xy / resolution;\n    float d = getDepth(uv);\n    float vZ = getViewZ(d);\n    if(-vZ >= cameraFar) {\n      continue;\n    }\n    float cW = cameraProjectionMatrix[2][3] * vZ + cameraProjectionMatrix[3][3];\n    vec3 vP = getViewPosition(uv, d, cW);\n        \n#ifdef PERSPECTIVE_CAMERA\n    float recipVPZ = 1. / viewPosition.z;\n    float viewReflectRayZ = 1. / (recipVPZ + s * (1. / d1viewPosition.z - recipVPZ));\n#else\n    float viewReflectRayZ = viewPosition.z + s * (d1viewPosition.z - viewPosition.z);\n#endif\n    \n    if(viewReflectRayZ <= vZ) {\n\n      bool hit;\n\n      float away=pointToLineDistance(vP, viewPosition, d1viewPosition);\n\n      float minThickness;\n      vec2 xyNeighbor = xy;\n      xyNeighbor.x += 1.;\n      vec2 uvNeighbor = xyNeighbor / resolution;\n      vec3 vPNeighbor = getViewPosition(uvNeighbor, d, cW);\n      minThickness = vPNeighbor.x - vP.x;\n      minThickness *= 3.;\n      float tk = max(minThickness, thickness);\n\n      hit = away <= tk;\n      \n      if(hit) {\n        vec3 vN = getViewNormal(uv);\n        \n        if(dot(viewReflectDir,vN) >= 0.) {\n          continue;\n        }\n        \n        float distance = pointPlaneDistance(vP, viewPosition, viewNormal);\n        \n        if(distance > maxDistance) {\n          break;\n        }\n        \n        float op = opacity;\n\n\n        float ratio = 1.0 - (distance / maxDistance);\n        float attenuation = ratio * ratio;\n        op = opacity * attenuation;\n\n\n\n        float fresnelCoe = (dot(viewIncidentDir, viewReflectDir) + 1.) / 2.;\n\t\t\t\top *= fresnelCoe;\n\n        reflectColor = texture2D(tDiffuse, uv);\n        reflectColor.a = op;\n        break;\n      }\n    }\n  }\n\n  outputColor = mix(inputColor, reflectColor, reflectColor.a);\n  // outputColor = mix(outputColor, vec4(1.0, 1.0, 1.0, 1.0), snowRatio);\n\n}\n";class SSREffect extends Effect$1{constructor(e,{blendFunction:t=BlendFunction.NORMAL,normalBuffer:r=null,depthBuffer:n=null,selects:i=null,width:a=Resizer.AUTO_SIZE,height:o=Resizer.AUTO_SIZE,scene:s,opacity:l=.5,groundReflector:c}={}){super("SSREffect",fragmentShader,{blendFunction:t,attributes:EffectAttribute.DEPTH,uniforms:new Map([["tDiffuse",new Uniform(null)],["tNormal",new Uniform(r)],["tDepth",new Uniform(n)],["tMetalness",new Uniform(null)],["cameraNear",new Uniform(e.near)],["cameraFar",new Uniform(e.far)],["cameraProjectionMatrix",new Uniform(e.projectionMatrix)],["cameraInverseProjectionMatrix",new Uniform(e.projectionMatrixInverse)],["maxDistance",new Uniform(10)],["thickness",new Uniform(.1)],["opacity",new Uniform(l)],["resolutionScale",new Uniform(1)]]),vertexShader:vertexShader}),this.groundReflector=c,this.scene3D=s,this._selects=i,this.selective=Array.isArray(this._selects),Object.defineProperty(this,"selects",{get(){return this._selects},set(e){this._selects!==e&&(this._selects=e,Array.isArray(e)?(this.selective=!0,this.defines.SELECTIVE=!0,this.needsUpdate=!0):(this.selective=!1,this.defines.SELECTIVE=!1,this.needsUpdate=!0))}}),this.camera=e,this.originalClearColor=new Color,this.metalnessOnMaterial=new MeshBasicMaterial({color:"white"}),this.metalnessOffMaterial=new MeshBasicMaterial({color:"black"}),this.metalnessRenderTarget=new WebGLRenderTarget(a,o,{minFilter:NearestFilter,magFilter:NearestFilter,format:RGBAFormat}),this.uniforms.get("tMetalness").value=this.metalnessRenderTarget.texture}update(e,t,r){this.uniforms.get("tDiffuse").value=t.texture,this.selective&&this.renderMetalness(e,this.metalnessOnMaterial,this.metalnessRenderTarget,0,0)}initialize(e,t,r){}renderMetalness(e,t,r,n,i){e.getClearColor(this.originalClearColor);const a=e.getClearAlpha(),o=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,n=t.clearColor||n,i=t.clearAlpha||i,null!=n&&(e.setClearColor(n),e.setClearAlpha(i||0),e.clear()),this.scene3D.traverseVisible((e=>{if(e.isMesh)if(e.material instanceof Array?(e._SSRPassBackupMaterial=[],e._SSRPassBackupMaterial.push(...e.material)):e._SSRPassBackupMaterial=e.material,this._selects.includes(e))if(e.material instanceof Array)for(let t in e.material)e.material[t].disableSSR?e.material[t]=this.metalnessOffMaterial:e.material[t]=this.metalnessOnMaterial;else e.material.disableSSR?e.material=this.metalnessOffMaterial:e.material=this.metalnessOnMaterial;else e.material=this.metalnessOffMaterial})),e.render(this.scene3D,this.camera),this.scene3D.traverseVisible((e=>{e.isMesh&&(e._SSRPassBackupMaterial instanceof Array?(e.material=[],e.material.push(...e._SSRPassBackupMaterial)):e.material=e._SSRPassBackupMaterial)})),e.autoClear=o,e.setClearColor(this.originalClearColor),e.setClearAlpha(a)}}class Firefly extends Effect{constructor(e){super("Firefly"),this.option=e,this.name=e.name,this.mesh=null,this.visible=!0;var t=new PlaneGeometry(10,10),r=new InstancedBufferGeometry;r.index=t.index,r.attributes=t.attributes;for(var n=new Float32Array(3*this.option.density),i=0;i<this.option.density;i++){let e=Math.random()*this.option.radius*2-this.option.radius,t=Math.random()*this.option.radius*2-this.option.radius,r=Math.random()*(this.option.endHeight-this.option.beginHeight)+this.option.beginHeight;n[3*i]=e,n[3*i+1]=r,n[3*i+2]=t}r.setAttribute("translate",new InstancedBufferAttribute(n,3));var a=new RawShaderMaterial({uniforms:{map:{value:(new TextureLoader).load(util$1.url(_context.instance.resourceBasePath,"texture/effects/firefly.png"))},time:{value:0},speed:{value:this.option.speed/100},color:{value:new Color(this.option.color)},brightness:{value:this.option.brightness},size:{value:this.option.size},radius:{value:(this.option.endHeight-this.option.beginHeight)/10}},vertexShader:FireflyShader.vertexShader,fragmentShader:FireflyShader.fragmentShader,blending:NormalBlending,transparent:!0,alphaTest:.2});this.mesh=new Mesh(r,a),this.mesh.position.set(Number(this.option.position.x)+Number(this.option.offset.x),Number(this.option.position.y)+Number(this.option.offset.y),Number(this.option.position.z)+Number(this.option.offset.z)),this.mesh.name=this.option.name,_context.scene.spaceEffects.add(this.mesh);let o=_context.animationStore.findLayerAnimation(this.option.name,FireflyAnimationController.type);if(o&&_context.animationStore.remove(o),o=new FireflyAnimationController(a),o.name=this.option.name,_context.animationStore.add(o),null!=this.option.enableAutoHidebyDistance&&(this.mesh.activeVisible=!0,this.mesh.enableAutoHidebyDistance=this.option.enableAutoHidebyDistance,this.mesh.minDistance=this.option.minDistance,this.mesh.maxDistance=this.option.maxDistance,_context.animationStore.addDistance(this.option.name,DistanceController,_context.camera,this.mesh)),null==e.visible?(this.visible=!0,this.mesh.activeVisible=!0,this.mesh.visible=!0,this.option.visible=!0):(e.visible,this.visible=e.visible,this.mesh.activeVisible=e.visible,this.mesh.visible=e.visible,this.option.visible=e.visible),"function"==typeof this.createHelper){let e=(this.option.endHeight+this.option.beginHeight)/2,t=this.option.endHeight-this.option.beginHeight;this.createHelper(new Vector3(0,e,0),new Vector3(2*this.option.radius,t,2*this.option.radius))}}update(e){for(let t in e)null!=this.option[t]?this.option[t]!==e[t]&&(this.option[t]=e[t]):logger.warn(t+"属性不存在");let t=new PlaneGeometry(10,10),r=new InstancedBufferGeometry;r.index=t.index,r.attributes=t.attributes;let n=new Float32Array(3*this.option.density);for(let e=0;e<this.option.density;e++){let t=Math.random()*this.option.radius*2-this.option.radius,r=Math.random()*this.option.radius*2-this.option.radius,i=Math.random()*(this.option.endHeight-this.option.beginHeight)+this.option.beginHeight;n[3*e]=t,n[3*e+1]=i,n[3*e+2]=r}r.setAttribute("translate",new InstancedBufferAttribute(n,3));let i=new RawShaderMaterial({uniforms:{map:{value:(new TextureLoader).load(util$1.url(_context.instance.resourceBasePath,"texture/effects/firefly.png"))},time:{value:0},speed:{value:this.option.speed/100},color:{value:new Color(this.option.color)},brightness:{value:this.option.brightness},size:{value:this.option.size}},vertexShader:FireflyShader.vertexShader,fragmentShader:FireflyShader.fragmentShader,transparent:!0,alphaTest:.2}),a=_context.animationStore.findLayerAnimation(e.name,FireflyAnimationController.type);if(a&&_context.animationStore.remove(a),a=new FireflyAnimationController(i),a.name=e.name,_context.animationStore.add(a),null!=this.option.enableAutoHidebyDistance&&(this.mesh.enableAutoHidebyDistance=this.option.enableAutoHidebyDistance,this.mesh.minDistance=this.option.minDistance,this.mesh.maxDistance=this.option.maxDistance,_context.animationStore.addDistance(this.option.name,DistanceController,_context.camera,this.mesh)),this.mesh.position.x=Number(this.option.position.x)+Number(this.option.offset.x),this.mesh.position.y=Number(this.option.position.y)+Number(this.option.offset.y),this.mesh.position.z=Number(this.option.position.z)+Number(this.option.offset.z),this.mesh.geometry.dispose&&this.mesh.geometry.dispose(),this.mesh.geometry=r,this.mesh.material=i,"function"==typeof this.updateHelper){let e=(this.option.endHeight+this.option.beginHeight)/2,t=this.option.endHeight-this.option.beginHeight;this.updateHelper(new Vector3(0,e,0),new Vector3(2*this.option.radius,t,2*this.option.radius))}}hide(){this.visible=!1,this.mesh.visible=!1,this.mesh.activeVisible=!1,this.option.visible=!1}show(){this.visible=!0,this.mesh.visible=!0,this.mesh.activeVisible=!0,this.option.visible=!0}remove(){let e=_context.animationStore.findLayerAnimation(this.option.name,FireflyAnimationController.type),t=_context.animationStore.findLayerAnimation(this.option.name,"DistanceController");e&&_context.animationStore.remove(e),t&&_context.animationStore.remove(t),_context.scene.spaceEffects.remove(this.mesh),delete this.mesh}}class Rainline extends Effect{constructor(e){super("Rainline"),this.option=e,this.name=e.name,this.mesh=null,this.visible=!0;var t=new PlaneGeometry(1,1),r=new InstancedBufferGeometry;r.index=t.index,r.attributes=t.attributes;for(var n=new Float32Array(3*this.option.density),i=0;i<this.option.density;i++){let e=Math.random()*this.option.radius*2-this.option.radius,t=Math.random()*this.option.radius*2-this.option.radius,r=.5*this.option.endHeight;n[3*i]=e,n[3*i+1]=r,n[3*i+2]=t}r.setAttribute("translate",new InstancedBufferAttribute(n,3));var a=new RawShaderMaterial({uniforms:{map:{value:(new TextureLoader).load(util$1.url(_context.instance.resourceBasePath,"texture/effects/rainline.png"))},time:{value:0},speed:{value:this.option.speed},color:{value:new Color(this.option.color)},brightness:{value:this.option.brightness},opacity:{value:this.option.opacity},width:{value:this.option.lineWidth},height:{value:this.option.endHeight-this.option.beginHeight}},vertexShader:RainlineShader.vertexShader,fragmentShader:RainlineShader.fragmentShader,depthTest:!0,depthWrite:!0,transparent:!0,alphaTest:.2});this.mesh=new Mesh(r,a),this.mesh.position.set(Number(this.option.position.x)+Number(this.option.offset.x),Number(this.option.position.y)+Number(this.option.offset.y),Number(this.option.position.z)+Number(this.option.offset.z)),this.mesh.name=this.option.name,this.mesh.renderOrder=101,_context.scene.spaceEffects.add(this.mesh);let o=_context.animationStore.findLayerAnimation(this.option.name,RainlineAnimationController.type);if(o&&_context.animationStore.remove(o),o=new RainlineAnimationController(a),o.name=this.option.name,_context.animationStore.add(o),null!=this.option.enableAutoHidebyDistance&&(this.mesh.activeVisible=!0,this.mesh.enableAutoHidebyDistance=this.option.enableAutoHidebyDistance,this.mesh.minDistance=this.option.minDistance,this.mesh.maxDistance=this.option.maxDistance,_context.animationStore.addDistance(this.option.name,DistanceController,_context.camera,this.mesh)),null==e.visible?(this.visible=!0,this.option.visible=!0):(e.visible,this.visible=e.visible,this.mesh.activeVisible=e.visible,this.mesh.visible=e.visible,this.option.visible=e.visible),"function"==typeof this.createHelper){let e=(this.option.endHeight+this.option.beginHeight)/2,t=this.mesh.material.uniforms.height.value;this.createHelper(new Vector3(0,e,0),new Vector3(2*this.option.radius,t,2*this.option.radius))}}update(e){for(let t in e)null!=this.option[t]?this.option[t]!==e[t]&&(this.option[t]=e[t]):logger.warn(t+"属性不存在");let t=new PlaneGeometry(1,1),r=new InstancedBufferGeometry;r.index=t.index,r.attributes=t.attributes;let n=new Float32Array(3*this.option.density);for(let e=0;e<this.option.density;e++){let t=Math.random()*this.option.radius*2-this.option.radius,r=Math.random()*this.option.radius*2-this.option.radius,i=.5*(this.option.endHeight-this.option.beginHeight+this.option.beginHeight);n[3*e]=t,n[3*e+1]=i,n[3*e+2]=r}r.setAttribute("translate",new InstancedBufferAttribute(n,3));let i=new RawShaderMaterial({uniforms:{map:{value:(new TextureLoader).load(util$1.url(_context.instance.resourceBasePath,"texture/effects/rainline.png"))},time:{value:0},speed:{value:this.option.speed},color:{value:new Color(this.option.color)},brightness:{value:this.option.brightness},opacity:{value:this.option.opacity},width:{value:this.option.lineWidth},height:{value:this.option.endHeight-this.option.beginHeight}},vertexShader:RainlineShader.vertexShader,fragmentShader:RainlineShader.fragmentShader,blending:NormalBlending,depthTest:!0,depthWrite:!0,transparent:!0,alphaTest:.2}),a=_context.animationStore.findLayerAnimation(e.name,RainlineAnimationController.type);if(a&&_context.animationStore.remove(a),a=new RainlineAnimationController(i),a.name=e.name,_context.animationStore.add(a),null!=this.option.enableAutoHidebyDistance&&(this.mesh.enableAutoHidebyDistance=this.option.enableAutoHidebyDistance,this.mesh.minDistance=this.option.minDistance,this.mesh.maxDistance=this.option.maxDistance,_context.animationStore.addDistance(this.option.name,DistanceController,_context.camera,this.mesh)),this.mesh.position.x=Number(this.option.position.x)+Number(this.option.offset.x),this.mesh.position.y=Number(this.option.position.y)+Number(this.option.offset.y),this.mesh.position.z=Number(this.option.position.z)+Number(this.option.offset.z),this.mesh.geometry.dispose&&this.mesh.geometry.dispose(),this.mesh.geometry=r,this.mesh.material=i,"function"==typeof this.updateHelper){let e=(this.option.endHeight+this.option.beginHeight)/2,t=this.mesh.material.uniforms.height.value;this.updateHelper(new Vector3(0,e,0),new Vector3(2*this.option.radius,t,2*this.option.radius))}}hide(){this.visible=!1,this.mesh.visible=!1,this.mesh.activeVisible=!1,this.option.visible=!1}show(){this.visible=!0,this.mesh.visible=!0,this.mesh.activeVisible=!0,this.option.visible=!0}remove(){let e=_context.animationStore.findLayerAnimation(this.option.name,RainlineAnimationController.type),t=_context.animationStore.findLayerAnimation(this.option.name,"DistanceController");e&&_context.animationStore.remove(e),t&&_context.animationStore.remove(t),_context.scene.spaceEffects.remove(this.mesh),delete this.mesh}}class Fireworks extends Effect{constructor(e){super("Fireworks"),this.mesh=new Group,this.mesh.position.set(e.centerPos.x,e.centerPos.y,e.centerPos.z),this.mesh.name=e.name,this.option=e,this.name=e.name,this.visible=!0,this.mapTex=(new TextureLoader).load(util$1.url(_context.instance.resourceBasePath,"texture/effects/firefly.png")),this.addFireworks(e,e.radius),_context.scene.spaceEffects.add(this.mesh);let t=_context.animationStore.findLayerAnimation(e.name,FireworksAnimationController.type);if(t&&_context.animationStore.remove(t),t=new FireworksAnimationController(this.mesh,e),t.name=e.name,_context.animationStore.add(t),null!=e.enableAutoHidebyDistance&&(this.mesh.activeVisible=!0,this.mesh.enableAutoHidebyDistance=e.enableAutoHidebyDistance,this.mesh.minDistance=e.minDistance,this.mesh.maxDistance=e.maxDistance,_context.animationStore.addDistance(e.name,DistanceController,_context.camera,this.mesh)),null==e.visible?(this.visible=!0,this.option.visible=!0):(e.visible,this.visible=e.visible,this.mesh.activeVisible=e.visible,this.mesh.visible=e.visible,this.option.visible=e.visible),"function"==typeof this.createHelper){let e=this.option.topHeight+this.option.bottomHeight,t=this.option.topHeight-this.option.bottomHeight+this.option.centerPos.y+this.option.offset.y;this.createHelper(new Vector3(0,e,0),new Vector3(2*(this.option.range+this.option.size+this.option.radius+this.option.topHeight+this.option.bottomHeight),2*t,2*(this.option.range+this.option.size+this.option.radius+this.option.topHeight+this.option.bottomHeight)))}}addFireworks(e,t){for(let r=0;r<t;r++){let t=new Group;t.pos={};let r=e.centerPos.x+Number(e.offset.x)+2*e.range*Math.random()-e.range,n=Number(e.offset.y)+e.bottomHeight+(e.topHeight-e.bottomHeight)*Math.random(),i=e.centerPos.z+Number(e.offset.z)+2*e.range*Math.random()-e.range;t.pos.x=r,t.pos.y=n,t.pos.z=i,t.position.x=r,t.position.y=n,t.position.z=i,t.speed=e.speed+e.speedR*Math.random(),t.lifetime=e.lifetime+e.lifetimeR*Math.random(),t.leaveTime=0,t.currentTime=0;let a=new SpriteMaterial({opacity:0,color:new Color(e.color),transparent:!0,map:this.mapTex});a.blending=NormalBlending;for(let r=0;r<100;r++){let r=new Sprite(a);r.scale.set(e.size,e.size,e.size),r.position.set(t.pos.x,t.pos.y,t.pos.z),r.dir=new Vector3(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1).normalize(),t.add(r)}this.mesh.add(t)}}update(e){this.mesh.position.set(e.centerPos.x,e.centerPos.y,e.centerPos.z),this.mesh.name=e.name;for(let t in e)null!=this.option[t]?this.option[t]!==e[t]&&(this.option[t]=e[t]):logger.warn(t+"属性不存在");if(this.mesh.children.length>this.option.radius)for(var t=this.mesh.children.length-1;this.mesh.children.length>this.option.radius+1;t--)"Box3Helper"!==this.mesh.children[t].type&&this.mesh.children.splice(t,1);else if(this.mesh.children.length<this.option.radius+1){let e=this.option.radius-this.mesh.children.length+1;this.addFireworks(this.option,e)}for(t=0;t<this.mesh.children.length;t++){if("Box3Helper"===this.mesh.children[t].type)continue;this.mesh.children[t].pos={};let n=this.option.centerPos.x+Number(this.option.offset.x)+2*this.option.range*Math.random()-this.option.range,i=Number(e.offset.y)+this.option.bottomHeight+(this.option.topHeight-this.option.bottomHeight)*Math.random(),a=this.option.centerPos.z+Number(this.option.offset.z)+2*this.option.range*Math.random()-this.option.range;this.mesh.children[t].pos.x=n,this.mesh.children[t].pos.y=i,this.mesh.children[t].pos.z=a,this.mesh.children[t].position.x=n,this.mesh.children[t].position.y=i,this.mesh.children[t].position.z=a,this.mesh.children[t].speed=this.option.speed+this.option.speedR*Math.random(),this.mesh.children[t].lifetime=this.option.lifetime+this.option.lifetimeR*Math.random(),this.mesh.children[t].color=this.option.color;let o=util$1.colorToRGBAObject(this.option.color);for(var r=0;r<this.mesh.children[t].children.length;r++)this.mesh.children[t].children[r].material.color.r=o.r,this.mesh.children[t].children[r].material.color.g=o.g,this.mesh.children[t].children[r].material.color.b=o.b,this.mesh.children[t].children[r].scale.set(this.option.size,this.option.size,this.option.size)}let n=_context.animationStore.findLayerAnimation(this.option.name,FireworksAnimationController.type);if(n&&_context.animationStore.remove(n),n=new FireworksAnimationController(this.mesh,this.option),n.name=this.option.name,_context.animationStore.add(n),null!=this.option.enableAutoHidebyDistance&&(this.mesh.enableAutoHidebyDistance=this.option.enableAutoHidebyDistance,this.mesh.minDistance=this.option.minDistance,this.mesh.maxDistance=this.option.maxDistance,_context.animationStore.addDistance(this.option.name,DistanceController,_context.camera,this.mesh)),"function"==typeof this.createHelper){let e=this.option.topHeight+this.option.bottomHeight,t=this.option.topHeight-this.option.bottomHeight+this.option.centerPos.y+this.option.offset.y;this.updateHelper(new Vector3(0,e,0),new Vector3(2*(this.option.range+this.option.size+this.option.radius+this.option.topHeight+this.option.bottomHeight),2*t,2*(this.option.range+this.option.size+this.option.radius+this.option.topHeight+this.option.bottomHeight)))}}hide(){this.visible=!1,this.mesh.visible=!1,this.mesh.activeVisible=!1,this.option.visible=!1}show(){this.visible=!0,this.mesh.visible=!0,this.mesh.activeVisible=!0,this.option.visible=!0}remove(){let e=_context.animationStore.findLayerAnimation(this.mesh.name,FireworksAnimationController.type),t=_context.animationStore.findLayerAnimation(this.option.name,"DistanceController");e&&_context.animationStore.remove(e),t&&_context.animationStore.remove(t),_context.scene.spaceEffects.remove(this.mesh),delete this.mesh}}class Rain extends Effect{constructor(e){super("Rain"),this.name=e.name,this.mesh=new Group,this.mesh.name=e.name,this.mesh.renderOrder=102,this.visible=!0,this.option=e;for(var t=new BufferGeometry,r=[],n=[],i=(new TextureLoader).load(util$1.url(_context.instance.resourceBasePath,"texture/effects/rain.png")),a=0;a<e.density;a++){var o=2e3*(Math.random()-.5),s=1e3*(Math.random()-.5),l=2e3*(Math.random()-.5);r.push(o,s,l)}t.setAttribute("position",new Float32BufferAttribute(r,3));var c=[[[1,.2,.5],i,e.size],[[1,.2,.2],i,e.size],[[.95,.1,.5],i,e.size]];for(a=0;a<c.length;a++){c[a][0];i=c[a][1];var h=c[a][2];n[a]=new PointsMaterial({size:h,map:i,blending:NormalBlending,depthWrite:!1,transparent:!0,color:new Color("#ffffff")});var u=new Points(t,n[a]);u.visible=!0,u.rotation.x=6*Math.random(),u.rotation.y=6*Math.random(),u.rotation.z=6*Math.random(),u.position.y=500*Math.random()-250,this.mesh.add(u)}this.mesh.rotation.z=MathUtils.degToRad(this.option.direction),this.mesh.position.x=e.offset.x,this.mesh.position.y=e.offset.y,this.mesh.position.z=e.offset.z,_context.scene.spaceEffects.add(this.mesh);let d=_context.animationStore.findLayerAnimation(e.name,RainAnimationController.type);d&&_context.animationStore.remove(d),d=new RainAnimationController(this.mesh,e.followCamera),d.name=e.name,_context.animationStore.add(d),null!=e.enableAutoHidebyDistance&&(this.mesh.activeVisible=!0,this.mesh.enableAutoHidebyDistance=e.enableAutoHidebyDistance,this.mesh.minDistance=e.minDistance,this.mesh.maxDistance=e.maxDistance,_context.animationStore.addDistance(e.name,DistanceController,_context.camera,this.mesh)),null==e.visible?(this.visible=!0,this.option.visible=!0):(e.visible,this.visible=e.visible,this.mesh.activeVisible=e.visible,this.mesh.visible=e.visible,this.option.visible=e.visible)}update(e){for(let t in e)null!=this.option[t]?this.option[t]!==e[t]&&(this.option[t]=e[t]):logger.warn(t+"属性不存在");for(var t=new BufferGeometry,r=[],n=(new TextureLoader).load(util$1.url(_context.instance.resourceBasePath,"texture/effects/rain.png")),i=0;i<this.option.density;i++){var a=2e3*Math.random()-1e3,o=1e3*Math.random(),s=2e3*Math.random()-1e3;r.push(a,o,s)}t.setAttribute("position",new Float32BufferAttribute(r,3));n=(new TextureLoader).load(util$1.url(_context.instance.resourceBasePath,"texture/effects/rain.png"));var l=this.option.size,c=new PointsMaterial({size:l,map:n,blending:NormalBlending,depthWrite:!1,transparent:!0,color:new Color("#ffffff")});for(i=0;i<this.mesh.children.length;i++)this.mesh.children[i].geometry.dispose&&this.mesh.children[i].geometry.dispose(),this.mesh.children[i].geometry=t,this.mesh.children[i].material=c;this.mesh.rotation.z=MathUtils.degToRad(this.option.direction),this.mesh.position.x=this.option.offset.x,this.mesh.position.y=this.option.offset.y,this.mesh.position.z=this.option.offset.z;let h=_context.animationStore.findLayerAnimation(this.option.name,RainAnimationController.type);h&&_context.animationStore.remove(h),h=new RainAnimationController(this.mesh),h.name=this.option.name,_context.animationStore.add(h),null!=this.option.enableAutoHidebyDistance&&(this.mesh.enableAutoHidebyDistance=this.option.enableAutoHidebyDistance,this.mesh.minDistance=this.option.minDistance,this.mesh.maxDistance=this.option.maxDistance,_context.animationStore.addDistance(this.option.name,DistanceController,_context.camera,this.mesh))}hide(){this.visible=!1,this.mesh.visible=!1,this.mesh.activeVisible=!1,this.option.visible=!1}show(){this.visible=!0,this.mesh.visible=!0,this.mesh.activeVisible=!0,this.option.visible=!0}remove(){let e=_context.animationStore.findLayerAnimation(this.option.name,RainAnimationController.type),t=_context.animationStore.findLayerAnimation(this.option.name,"DistanceController");e&&_context.animationStore.remove(e),t&&_context.animationStore.remove(t),_context.scene.spaceEffects.remove(this.mesh),delete this.mesh}}class Snow extends Effect{constructor(e){super("Snow"),this.name=e.name,this.mesh=new Group,this.mesh.name=e.name,this.mesh.renderOrder=103,this.visible=!0,this.option=e;for(var t=new BufferGeometry,r=[],n=[],i=(new TextureLoader).load(util$1.url(_context.instance.resourceBasePath,"texture/effects/snow.png")),a=0;a<e.density;a++){var o=2e3*(Math.random()-.5),s=1e3*(Math.random()-.5),l=2e3*(Math.random()-.5);r.push(o,s,l)}t.setAttribute("position",new Float32BufferAttribute(r,3));var c=[[[1,.2,.5],i,e.size],[[1,.2,.2],i,e.size],[[.95,.1,.5],i,e.size]];for(a=0;a<c.length;a++){c[a][0];i=c[a][1];var h=c[a][2];n[a]=new PointsMaterial({size:h,map:i,blending:NormalBlending,depthWrite:!1,transparent:!0,color:new Color("#ffffff")});var u=new Points(t,n[a]);u.visible=!0,u.rotation.x=6*Math.random(),u.rotation.y=6*Math.random(),u.rotation.z=6*Math.random(),u.position.y=500*Math.random()-250,this.mesh.add(u)}this.mesh.rotation.z=MathUtils.degToRad(this.option.direction),this.mesh.position.x=e.offset.x,this.mesh.position.y=e.offset.y,this.mesh.position.z=e.offset.z,_context.scene.spaceEffects.add(this.mesh);let d=_context.animationStore.findLayerAnimation(e.name,SnowAnimationController.type);d&&_context.animationStore.remove(d),d=new SnowAnimationController(this.mesh,e.followCamera),d.name=e.name,_context.animationStore.add(d),null!=e.enableAutoHidebyDistance&&(this.mesh.activeVisible=!0,this.mesh.enableAutoHidebyDistance=e.enableAutoHidebyDistance,this.mesh.minDistance=e.minDistance,this.mesh.maxDistance=e.maxDistance,_context.animationStore.addDistance(e.name,DistanceController,_context.camera,this.mesh)),null==e.visible?(this.visible=!0,this.option.visible=!0):(e.visible,this.visible=e.visible,this.mesh.activeVisible=e.visible,this.mesh.visible=e.visible,this.option.visible=e.visible)}update(e){for(let t in e)null!=this.option[t]?this.option[t]!==e[t]&&(this.option[t]=e[t]):logger.warn(t+"属性不存在");for(var t=new BufferGeometry,r=[],n=0;n<this.option.density;n++){var i=2e3*Math.random()-1e3,a=1e3*Math.random(),o=2e3*Math.random()-1e3;r.push(i,a,o)}t.setAttribute("position",new Float32BufferAttribute(r,3));var s=(new TextureLoader).load(util$1.url(_context.instance.resourceBasePath,"texture/effects/snow.png")),l=this.option.size,c=new PointsMaterial({size:l,map:s,blending:NormalBlending,depthWrite:!1,transparent:!0,color:new Color("#ffffff")});for(n=0;n<this.mesh.children.length;n++)this.mesh.children[n].geometry.dispose&&this.mesh.children[n].geometry.dispose(),this.mesh.children[n].geometry=t,this.mesh.children[n].material=c;this.mesh.rotation.z=MathUtils.degToRad(this.option.direction),this.mesh.position.x=this.option.offset.x,this.mesh.position.y=this.option.offset.y,this.mesh.position.z=this.option.offset.z;let h=_context.animationStore.findLayerAnimation(this.option.name,SnowAnimationController.type);h&&_context.animationStore.remove(h),h=new SnowAnimationController(this.mesh),h.name=this.option.name,_context.animationStore.add(h),null!=this.option.enableAutoHidebyDistance&&(this.mesh.enableAutoHidebyDistance=this.option.enableAutoHidebyDistance,this.mesh.minDistance=this.option.minDistance,this.mesh.maxDistance=this.option.maxDistance,_context.animationStore.addDistance(this.option.name,DistanceController,_context.camera,this.mesh))}hide(){this.visible=!1,this.mesh.visible=!1,this.mesh.activeVisible=!1,this.option.visible=!1}show(){this.visible=!0,this.mesh.visible=!0,this.mesh.activeVisible=!0,this.option.visible=!0}remove(){let e=_context.animationStore.findLayerAnimation(this.mesh.name,SnowAnimationController.type),t=_context.animationStore.findLayerAnimation(this.option.name,"DistanceController");e&&_context.animationStore.remove(e),t&&_context.animationStore.remove(t),_context.scene.spaceEffects.remove(this.mesh),delete this.mesh}}class SpaceEffect{constructor(){this._enabled=void 0,this._effects=[],_context.scene.spaceEffects=new Group("__spaceEffects"),_context.scene.spaceEffects.name="__spaceEffects",_context.scene.add(_context.scene.spaceEffects)}get enabled(){return this._enabled}set enabled(e){util$1.isBoolean(e)}addEffect(e){if(void 0!==this.findEffect(e.name)&&this.findEffect(e.name))logger.warn("name为"+e.name+"的特效已存在");else if("firefly"==e.type){let t=new Firefly(e);this._effects.push(t)}else if("rainline"==e.type){let t=new Rainline(e);this._effects.push(t)}else if("fireworks"==e.type){let t=new Fireworks(e);this._effects.push(t)}else if("rain"==e.type){let t=new Rain(e);this._effects.push(t)}else if("snow"==e.type){let t=new Snow(e);this._effects.push(t)}}findEffect(e){return this._effects.find((t=>e===t.name))}updateEffect(e,t){void 0!==this.findEffect(e)&&this.findEffect(e)?this.findEffect(e).update(t):logger.warn("name为"+e+"的特效不存在")}removeEffect(e){for(let t=0;t<this._effects.length;t++)if(e===this._effects[t].name){util$1.disposeThreeObject(this._effects[t].mesh),this._effects[t].remove(),this._effects.splice(t,1);break}}renameEffect(e,t){if(void 0!==this.findEffect(t)&&this.findEffect(t))if(this.findEffect(e))logger.warn("name为"+e+"的特效已存在");else{let r=this.findEffect(t);r.name=e,r.mesh.name=e,r.option.name=e}else logger.warn("name为"+t+"的特效不存在")}hideEffect(e){void 0!==this.findEffect(e)&&this.findEffect(e)?this.findEffect(e).hide():logger.warn("name为"+e+"的特效不存在")}showEffect(e){void 0!==this.findEffect(e)&&this.findEffect(e)?this.findEffect(e).show():logger.warn("name为"+e+"的特效不存在")}hideHelpers(){for(let e=0;e<this._effects.length;e++)this._effects[e]&&"function"==typeof this._effects[e].hideHelper&&this._effects[e].hideHelper()}getSettings(){let e=[];for(let t=0;t<this._effects.length;t++)e.push(JSON.parse(JSON.stringify(this._effects[t])));return e.map((e=>{delete e.mesh})),e}applySettings(e){if(this._effects&&this._effects.length>0)for(let e=this._effects.length-1;e>=0;e--)this.removeEffect(this._effects[e].name);!e||!e.length>0||e.map((e=>{if("firefly"===e.option.type){let t=new Firefly(e.option);this._effects.push(t)}else if("rainline"===e.option.type){let t=new Rainline(e.option);this._effects.push(t)}else if("fireworks"===e.option.type){let t=new Fireworks(e.option);this._effects.push(t)}else if("rain"==e.option.type){let t=new Rain(e.option);this._effects.push(t)}else if("snow"==e.option.type){let t=new Snow(e.option);this._effects.push(t)}}))}}class Statistics{constructor(){let e=Date.now(),t=e,r=0,n=0;this.start=()=>{e=Date.now()},this.stop=()=>{r++;var e=Date.now();return e>=t+1e3&&(n=Math.round(1e3*r/(e-t)),t=e,r=0),e},this.update=()=>{e=this.stop()},this.getRendererInfo=e=>({fps:n,geometries:e.info.memory.geometries,textures:e.info.memory.textures,calls:e.info.render.calls,faces:Math.floor((e.info.render.triangles-36)/3),vertices:e.info.render.triangles-36})}}class View{constructor({id:e=util$1.guid(),name:t=""}={},r){this._id=e,this._name=t,this._camera={positionX:0,positionY:0,positionZ:0,azimuth:0,inclination:0,inclinationMin:0,inclinationMax:90,fov:45,distance:1500,distanceMin:350,distanceMax:2e3,viewDistanceMin:350,viewDistanceMax:2e3,viewLimitRadius:1e8,autoRotate:!1,autoRotateSpeed:1,autoRotateDirection:"CW"},this._boundary={enabled:!1},this._cameraPath={enabled:!1},this._context=r}get camera(){return this._camera}set camera(e){this._camera=e,this._context}getSettings(){return this._camera.positionX=this._context.orbitControl.object.position.x,this._camera.positionY=this._context.orbitControl.object.position.y,this._camera.positionZ=this._context.orbitControl.object.position.z,this._camera.azimuth=this._context.orbitControl.getAzimuthalAngle()/Math.PI*180,this._camera.inclination=this._context.orbitControl.getPolarAngle()/(Math.PI/2)*90-90,this._camera.inclinationMin=this._context.minInclination,this._camera.inclinationMax=this._context.maxInclination,this._camera.fov=this._context.orbitControl.object.fov,this._camera.distance=Math.abs(this._context.orbitControl.object.position.clone().sub(this._context.orbitControl.target).length()),this._camera.distanceMin=this._context.orbitControl.minDistance,this._camera.distanceMax=this._context.orbitControl.maxDistance,this._camera.viewDistanceMin=this._context.orbitControl.object.near,this._camera.viewDistanceMax=this._context.orbitControl.object.far,this._camera.targetX=this._context.orbitControl.target.x,this._camera.targetY=this._context.orbitControl.target.y,this._camera.targetZ=this._context.orbitControl.target.z,this._camera.inclinationAngleMin=this._context.orbitControl.minPolarAngle/Math.PI*180-90,this._camera.inclinationAngleMax=this._context.orbitControl.maxPolarAngle/Math.PI*180-90,this._camera.viewLimitRadius=this._camera.viewLimitRadius,this._camera.autoRotate=this._camera.autoRotate,this._camera.autoRotateSpeed=this._camera.autoRotateSpeed,this._camera.autoRotateDirection=this._camera.autoRotateDirection,{camera:this._camera}}applySettings(e,t,r){if(logger.debug(e),!e)return void logger.error("无效的视野设置。");this._camera={...this._camera,...e.camera};let n=this._context.orbitControl.object,i=this._camera.distanceMax,a=this._camera.distanceMin;n.fov=util$1.numberOrDefault(this._camera.fov,n.fov),n.near=util$1.numberOrDefault(this._camera.viewDistanceMin,n.near),n.far=util$1.numberOrDefault(this._camera.viewDistanceMax,n.far),this._context.orbitControl.minDistance=0,this._context.orbitControl.maxDistance=1e6,null!=e.camera.inclinationAngleMin&&(this._context.orbitControl.minPolarAngle=(e.camera.inclinationAngleMin+90)/180*Math.PI),null!=e.camera.inclinationAngleMax&&(this._context.orbitControl.maxPolarAngle=(e.camera.inclinationAngleMax+90)/180*Math.PI),n.updateProjectionMatrix(),this._context.orbitControl.defaultTargetPosition=new Vector3(this._camera.targetX,this._camera.targetY,this._camera.targetZ),this._context.orbitControl.viewLimitRadius=this._camera.viewLimitRadius,this._context.zoomTo(new Vector3(this._camera.targetX,this._camera.targetY,this._camera.targetZ),this._camera.azimuth,this._camera.inclination,this._camera.distance,r?0:this._camera.duration||0,!0,(()=>{this._context.minInclination=util$1.numberOrDefault(this._camera.inclinationMin,this._context.minInclination),this._context.maxInclination=util$1.numberOrDefault(this._camera.inclinationMax,this._context.maxInclination),this._context.orbitControl.minDistance=util$1.numberOrDefault(a,this._context.minDistance),this._context.orbitControl.maxDistance=util$1.numberOrDefault(i,this._context.maxDistance),t&&t(1)})),this._context.orbitControl.update()}}View._fromThreeObject=function(e){if(!e)return new View;return new View};class VisualEffect{constructor(){this._enabled=void 0,this._size=new Vector2(0,0),_context.renderer.getSize(this._size),this._passes={},this._enableSSR=!1,this._ssrIntensity=1,this._ssrQuality=1,this._ssrOpacity=1,this._ssrThickness=1,this._ssrMaxDistance=10,this._enableSSAO=!1,this._ssaoRadius=5,this._ssaoIntensity=1,this._ssaoQuality=.5,this._ssaoKernelRadius=5,this._ssaoMinDistance=0,this._ssaoMaxDistance=10,this._enableGrain=!1,this._grainIntensity=.2,this._enableEdgeBlur=!1,this._edgeBlurRadius=.2,this._edgeBlurIntensity=1,this._enableDOF=!1,this._dofDistanceForground=10,this._dofDistanceBackground=100,this._dofQuality=.5,this._dofFocus="manual",this._dofFocusTarget=new Vector3(0,0,0),this._dofFocusDistance=0,this._dofFocalDistance=.5,this._enableSharpen=!1,this._sharpenIntensity=.1,this._enableChromaticAberration=!1,this._chromaticAberrationIntensity=.2,this._enableBloom=!1,this._bloomThreshold=1,this._bloomBrightness=1,this._bloomRadius=1,this._enableToneMapping=!1,this._toneMappingExposure=1,this._toneMappingBrightness=0,this._toneMappingContrast=0,this._toneMappingHue=0,this._toneMappingSaturation=0,this._enableColorBalance=!1,this._colorBalanceHue=1,this._colorBalanceR=1,this._colorBalanceG=1,this._colorBalanceB=1,this._enableFog=!1,this._fogDistance=100,this._fogIntensity=1,this._fogDistanceNear=10,this._fogDistanceFar=200,this._fogColor=void 0,this._fogColor0=void 0,this._fogColorFromSkybox=void 0,this._fogAutoColor=!0,this._enableAntialias=!1,this._antialiasType="SMAA",this._antialiasSampleCount=8,this._antialiasColorDiff=!0,this._antialiasPixelReject=!0,this._enableLUT=!1,this._lutIntensity=1,this._lutSelected="Arabica 12",this._lutCustom="",this._lutCustomName="",this._enableWatermark=!0,this._watermark="";const e=new WatermarkEffect;let t=new OutlineEffect(_context.scene,_context.camera,{blendFunction:BlendFunction.SCREEN,edgeStrength:32,pulseSpeed:0,visibleEdgeColor:16772608,hiddenEdgeColor:14522624,height:540,blur:!1,xRay:!0});this._passes.outlinePass=new EffectPass(_context.camera,t),this._passes.outlinePass.name="OutlinePass",this._passes.outlinePass.outlineEffect=t;let r=new OutlineEffect(_context.scene,_context.camera,{blendFunction:BlendFunction.SCREEN,edgeStrength:32,pulseSpeed:0,height:1080,blur:!1,xRay:!0});r.blur=!0,r.blurPass.kernelSize=1,this._passes.articulationOutlinePass=new EffectPass(_context.camera,r),this._passes.articulationOutlinePass.name="ArticulationOutlineEffect",this._passes.articulationOutlinePass.articulationOutlineEffect=r,this._lutMap={"Arabica 12":null,"Chemical 168":null,"Clayton 33":null,"Django 25":null,"Faded 47":null,"Fusion 88":null,"Hyla 68":null,"Lenox 340":null,"Lucky 64":null,"Paladin 1875":null,"Pasadena 21":null,"Pitaya 15":null,"Sprocket 231":null,"Teigen 28":null,"Zeke 39":null},this._passes.normalPass=new NormalPass(_context.scene.models,_context.camera);const n=new DepthDownsamplingPass({normalBuffer:this._passes.normalPass.texture,resolutionScale:.5}),i=_context.renderer.capabilities.isWebGL2?n.texture:null;let a=new SSAOEffect(_context.camera,this._passes.normalPass.texture,{blendFunction:BlendFunction.MULTIPLY,distanceScaling:!1,depthAwareUpsampling:!0,normalDepthBuffer:i,samples:9,rings:7,distanceThreshold:100/(_context.camera.far-_context.camera.near),distanceFalloff:25/(_context.camera.far-_context.camera.near),rangeThreshold:1/(_context.camera.far-_context.camera.near),rangeFalloff:.3/(_context.camera.far-_context.camera.near),luminanceInfluence:.7,minRadiusScale:.33,radius:.1,intensity:1,bias:.025,fade:.01,color:new Color(0),resolutionScale:.5});a.blendMode.opacity.value=0;const o=new NoiseEffect({blendFunction:BlendFunction.COLOR_DODGE});o.blendMode.opacity.value=0;const s=new DepthOfFieldEffect(_context.camera,{blendFunction:BlendFunction.SKIP,focusDistance:0,focalLength:.048,bokehScale:2,height:720});s.blurPass.kernelSize=5,s.circleOfConfusionMaterial.uniforms.focusDistance.value=0,s.circleOfConfusionMaterial.uniforms.focalLength.value=.048;const l=new DepthEffect({blendFunction:BlendFunction.SKIP}),c=new TextureEffect({blendFunction:BlendFunction.SKIP,texture:s.renderTargetCoC.texture});let h=new ShaderMaterial(SharpenShader);h.uniforms.width.value=this._size.width,h.uniforms.height.value=this._size.height,h.uniforms.intensity.value=1,this._passes.sharpenPass=new ShaderPass(h,"tDiffuse"),this._passes.sharpenPass.name="SharpenPass",this._passes.sharpenPass.sharpenMaterial=h,this._passes.sharpenPass.enabled=!1;let u=new ShaderMaterial(LensDistortionShader);u.shaderType="LensDistortionShader",u.defines.BAND_MODE=2,u.defines.CHROMA_SAMPLES=16,u.uniforms.baseIor.value=1,u.uniforms.bandOffset.value=0,u.uniforms.jitterIntensity.value=.5,this._passes.distortPass=new ShaderPass(u,"tDiffuse"),this._passes.distortPass.name="ChromaticAberrationPass",this._passes.distortPass.distortMaterial=u;let d=new BloomEffect({blendFunction:BlendFunction.SCREEN,kernelSize:KernelSize$1.MEDIUM,luminanceThreshold:.4,luminanceSmoothing:.1,height:480});d.blendMode.opacity.value=0,this._enableFog=!1,this._fogDistance=100,this._fogIntensity=1,this._fogDistanceNear=10,this._fogDistanceFar=200,this._fogColor=void 0,this._fogColor0=void 0,this._fogColorFromSkybox=void 0,this._fogAutoColor=!0;new SMAAImageLoader(_context.defaultLoadingManager).load((([e,t])=>{const r=new SMAAEffect(e,t,SMAAPreset.ULTRA,EdgeDetectionMode.COLOR);r.edgeDetectionMaterial.setLocalContrastAdaptationFactor(2.5),r.edgeDetectionMaterial.setEdgeDetectionThreshold(.02),r.edgeDetectionMaterial.setPredicationMode(PredicationMode.DEPTH),r.edgeDetectionMaterial.setPredicationThreshold(.02),r.edgeDetectionMaterial.setPredicationScale(1),r.blendMode.opacity.value=0,this._passes.smaaPass=new EffectPass(_context.camera,r),this._passes.smaaPass.name="SMAAPass",this._passes.smaaPass.smaaEffect=r,this._passes.smaaPass.renderToScreen=!0,this._passes.smaaPass.encodeOutput=!0,_context.composer.addPass(this._passes.smaaPass)}));let p=new BrightnessContrastEffect({blendFunction:BlendFunction.NORMAL}),f=new HueSaturationEffect({blendFunction:BlendFunction.NORMAL});p.uniforms.get("brightness").value=0,p.uniforms.get("contrast").value=0,f.setHue(0),f.uniforms.get("saturation").value=0,this._passes.colorGradingPass=new EffectPass(_context.camera,p,f),this._passes.colorGradingPass.name="colorGradingPass",this._passes.colorGradingPass.brightnessContrastEffect=p,this._passes.colorGradingPass.hueSaturationEffect=f,_context.renderer.capabilities.isWebGL2&&_context.composer.addPass(n),this._passes.compositePassSSAOBloom=new EffectPass(_context.camera,a,d),this._passes.compositePassSSAOBloom.name="CompositePassSSAOBloom",this._passes.compositePassSSAOBloom.ssaoEffect=a,this._passes.compositePassSSAOBloom.bloomEffect=d,_context.composer.addPass(this._passes.normalPass),_context.composer.addPass(this._passes.compositePassSSAOBloom),this._passes.ssrDepthPass=new DepthPass(_context.scene.models,_context.camera);const m=new SSREffect(_context.camera,{depthBuffer:this._passes.ssrDepthPass.texture,normalBuffer:this._passes.normalPass.texture,width:window.innerWidth,height:window.innerHeight,scene:_context.scene.models,opacity:1});this._passes.ssrPass=new EffectPass(_context.camera,m),this._passes.ssrPass.ssrEffect=m,this._passes.ssrDepthPass.enabled=!1,this._passes.ssrPass.enabled=!1,_context.composer.addPass(this._passes.ssrDepthPass),_context.composer.addPass(this._passes.ssrPass),this._passes.dofPass=new EffectPass(_context.camera,s,e,c,l),this._passes.dofPass.depthOfFieldEffect=s,this._passes.dofPass.cocTextureEffect=c,this._passes.dofPass.depthEffect=l,this._passes.dofPass.watermarkEffect=e,_context.composer.addPass(this._passes.dofPass),_context.composer.addPass(this._passes.distortPass),_context.composer.addPass(this._passes.sharpenPass),this._passes.grainPass=new EffectPass(_context.camera,o),this._passes.grainPass.name="GrainPass",_context.composer.addPass(this._passes.grainPass),_context.composer.addPass(this._passes.colorGradingPass),_context.composer.addPass(this._passes.outlinePass),_context.composer.addPass(this._passes.articulationOutlinePass),_context.BlendFunction=BlendFunction,this._passes.edgeBlurPass=new EdgeBlurPass,this._passes.edgeBlurPass.name="EdgeBlurPass",this._passes.edgeBlurPass.enabled=!1,_context.composer.addPass(this._passes.edgeBlurPass)}get enabled(){return this._enabled}set enabled(e){util$1.isBoolean(e)&&(this.enableWatermark=this.enableSSR=this.enableSSAO=this.enableGrain=this.enableDOF=this.enableSharpness=this.enableChromaticAberration=this.enableBloom=this.enableToneMapping=this.enableColorBalance=this.enableFog=this.enableAntialias=this._enabled=e)}get enableWatermark(){return this._enableWatermark}set enableWatermark(e){if(!util$1.isBoolean(e))return;let t=this._enableWatermark=e,r=this._passes.dofPass.watermarkEffect,n=t?BlendFunction.NORMAL:BlendFunction.SKIP;r.blendMode.setBlendFunction(n)}get watermark(){return this._watermark}set watermark(e){_context.loaders.textureLoader.load(e,(t=>{this._passes.dofPass.watermarkEffect.setMap(t),this._watermark=e}))}get enableSSR(){return this._enableSSR}set enableSSR(e){util$1.isBoolean(e)&&(this._enableSSR=e,this._passes.ssrDepthPass.enabled=this._enableSSR,this._passes.ssrPass.enabled=this._enableSSR)}get ssrOpacity(){return this._ssrOpacity}set ssrOpacity(e){"number"!=typeof e||e<0||e>1||(this._ssrOpacity=e,this._passes.ssrPass.ssrEffect.uniforms.get("opacity").value=this._ssrOpacity)}get ssrThickness(){return this._ssrThickness}set ssrThickness(e){"number"!=typeof e||e<0||(this._ssrThickness=e,this._passes.ssrPass.ssrEffect.uniforms.get("thickness").value=this._ssrThickness)}get ssrMaxDistance(){return this._ssrMaxDistance}set ssrMaxDistance(e){"number"!=typeof e||e<0||(this._ssrMaxDistance=e,this._passes.ssrPass.ssrEffect.uniforms.get("maxDistance").value=this._ssrMaxDistance)}get ssrIntensity(){return this._ssrIntensity}set ssrIntensity(e){"number"!=typeof e||e<0||e>1||(this._ssrIntensity=e,this._passes.ssrPass.ssrEffect.uniforms.get("opacity").value=this._ssrIntensity)}get ssrQuality(){return this._ssrQuality}set ssrQuality(e){"number"!=typeof e||e<0||(this._ssrQuality=e,this._passes.ssrPass.ssrEffect.uniforms.get("maxDistance").value=this._ssrQuality)}get enableSSAO(){return this._enableSSAO}set enableSSAO(e){if(!util$1.isBoolean(e))return;this._passes.compositePassSSAOBloom.ssaoEffect.blendMode.setBlendFunction((this._enableSSAO=e)?BlendFunction.MULTIPLY:BlendFunction.SKIP);let t=9;this._ssaoQuality<=.5&&this._ssaoQuality>=0?t=this._ssaoQuality/.5*8+1:this._ssaoQuality>.5&&this._ssaoQuality<=1&&(t=(this._ssaoQuality-.5)/.5*91+9),this._passes.compositePassSSAOBloom.ssaoEffect.samples=t,this._passes.compositePassSSAOBloom.ssaoEffect.blendMode.opacity.value=this._ssaoIntensity;let r=this._ssaoMaxDistance/(_context.camera.far-_context.camera.near),n=r/4;this._passes.compositePassSSAOBloom.ssaoEffect.setDistanceCutoff(r,n)}get ssaoKernelRadius(){return this._ssaoKernelRadius}set ssaoKernelRadius(e){if("number"!=typeof e)return;this._passes.compositePassSSAOBloom.ssaoEffect.blendMode.setBlendFunction((this._enableSSAO=this.enableSSAO)?BlendFunction.MULTIPLY:BlendFunction.SKIP),this._ssaoKernelRadius=Math.max(e,0);let t=this._ssaoKernelRadius/(_context.camera.far-_context.camera.near),r=t/3;this._passes.compositePassSSAOBloom.ssaoEffect.setProximityCutoff(t,r)}get ssaoMinDistance(){return this._ssaoMinDistance}set ssaoMinDistance(e){this._passes.compositePassSSAOBloom.ssaoEffect.blendMode.setBlendFunction((this._enableSSAO=this.enableSSAO)?BlendFunction.MULTIPLY:BlendFunction.SKIP),this._ssaoMinDistance=e}get ssaoMaxDistance(){return this._ssaoMaxDistance}set ssaoMaxDistance(e){if("number"!=typeof e)return;this._passes.compositePassSSAOBloom.ssaoEffect.blendMode.setBlendFunction((this._enableSSAO=this.enableSSAO)?BlendFunction.MULTIPLY:BlendFunction.SKIP),this._ssaoMaxDistance=Math.max(e,0);let t=this._ssaoMaxDistance/(_context.camera.far-_context.camera.near),r=t/4;this._passes.compositePassSSAOBloom.ssaoEffect.setDistanceCutoff(t,r)}get ssaoRadius(){return this._ssaoRadius}set ssaoRadius(e){this._passes.compositePassSSAOBloom.ssaoEffect.blendMode.setBlendFunction((this._enableSSAO=this.enableSSAO)?BlendFunction.MULTIPLY:BlendFunction.SKIP),this._ssaoRadius=e}get ssaoIntensity(){return this._ssaoIntensity}set ssaoIntensity(e){"number"==typeof e&&(this._passes.compositePassSSAOBloom.ssaoEffect.blendMode.setBlendFunction((this._enableSSAO=this.enableSSAO)?BlendFunction.MULTIPLY:BlendFunction.SKIP),this._ssaoIntensity=Math.min(Math.max(e,0),5),this._passes.compositePassSSAOBloom.ssaoEffect.blendMode.opacity.value=this._ssaoIntensity)}get ssaoQuality(){return this._ssaoQuality}set ssaoQuality(e){this._passes.compositePassSSAOBloom.ssaoEffect.blendMode.setBlendFunction((this._enableSSAO=this.enableSSAO)?BlendFunction.MULTIPLY:BlendFunction.SKIP),this._ssaoQuality=e;let t=9;this._ssaoQuality<=.5&&this._ssaoQuality>=0?t=this._ssaoQuality/.5*8+1:this._ssaoQuality>.5&&this._ssaoQuality<=1&&(t=(this._ssaoQuality-.5)/.5*91+9),this._passes.compositePassSSAOBloom.ssaoEffect.samples=t}get enableGrain(){return this._enableGrain}set enableGrain(e){util$1.isBoolean(e)&&(this._passes.grainPass.enabled=this._enableGrain=e)}get grainIntensity(){return this._grainIntensity}set grainIntensity(e){this._passes.grainPass.enabled=this._enableGrain;let t=util$1.numberOrDefault(e,this._grainIntensity);this._grainIntensity=t,this._passes.grainPass.effects[0].blendMode.opacity.value=this._grainIntensity/2}get enableEdgeBlur(){return this._enableEdgeBlur}set enableEdgeBlur(e){util$1.isBoolean(e)&&(this._enableEdgeBlur=e,this._passes.edgeBlurPass.enabled=e)}get edgeBlurRadius(){return this._edgeBlurRadius}set edgeBlurRadius(e){"number"==typeof e&&(e<0&&(e=0),e>1&&(e=1),this._edgeBlurRadius=e,this._passes.edgeBlurPass&&(this._passes.edgeBlurPass.radius=1-e))}get edgeBlurIntensity(){return this._edgeBlurIntensity}set edgeBlurIntensity(e){"number"==typeof e&&(e<0&&(e=0),e>1&&(e=1),this._edgeBlurIntensity=e,this._passes.edgeBlurPass&&(this._passes.edgeBlurPass.scale=e))}get enableDOF(){return this._enableDOF}set enableDOF(e){util$1.isBoolean(e)&&this._passes.dofPass.depthOfFieldEffect.blendMode.setBlendFunction((this._enableDOF=e)?BlendFunction.NORMAL:BlendFunction.SKIP)}get dofQuality(){return this._dofQuality}set dofQuality(e){"number"==typeof e&&(e<0&&(e=0),e>1&&(e=1),this._dofQuality=e,this._passes.dofPass&&this._passes.dofPass.depthOfFieldEffect&&(this._passes.dofPass.depthOfFieldEffect.bokehScale=5*this._dofQuality))}get dofFocus(){return this._dofFocus}set dofFocus(e){"string"==typeof e&&"auto"===e&&"manual"===e&&(this._dofFocus=e)}get dofFocusTarget(){return this._dofFocusTarget}set dofFocusTarget(e){}get dofFocusDistance(){return this._dofFocusDistance}set dofFocusDistance(e){"number"==typeof e&&(this._dofFocusDistance=e,this._passes.dofPass.depthOfFieldEffect.circleOfConfusionMaterial.uniforms.focusDistance.value=e)}get dofFocalDistance(){return this._dofFocalDistance}set dofFocalDistance(e){"number"==typeof e&&(this._dofFocalDistance=e,this._passes.dofPass&&this._passes.dofPass.depthOfFieldEffect&&(this._passes.dofPass.depthOfFieldEffect.circleOfConfusionMaterial.uniforms.focalLength.value=Math.pow(Math.E,10*this._dofFocalDistance)/(_context.camera.far-_context.camera.near)))}get enableSharpen(){return this._enableSharpen}set enableSharpen(e){util$1.isBoolean(e)&&(this._passes.sharpenPass.enabled=this._enableSharpen=e)}get sharpenIntensity(){return this._sharpenIntensity}set sharpenIntensity(e){let t=util$1.numberOrDefault(e,this._sharpenIntensity);this._sharpenIntensity=t,this._passes.sharpenPass.sharpenMaterial.uniforms.intensity.value=this._sharpenIntensity}get enableChromaticAberration(){return this._enableChromaticAberration}set enableChromaticAberration(e){util$1.isBoolean(e)&&(this._passes.distortPass.distortMaterial.uniforms.bandOffset.value=(this._enableChromaticAberration=e)?.005*this._chromaticAberrationIntensity:0)}get chromaticAberrationIntensity(){return this._chromaticAberrationIntensity}set chromaticAberrationIntensity(e){!util$1.isNumber(e)||e<0||(this._chromaticAberrationIntensity=e,this._enableChromaticAberration&&(this._passes.distortPass.distortMaterial.uniforms.bandOffset.value=.005*this._chromaticAberrationIntensity))}get enableBloom(){return this._enableBloom}set enableBloom(e){util$1.isBoolean(e)&&(this._passes.compositePassSSAOBloom.effects[1].blendMode.opacity.value=(this._enableBloom=e)?1:0)}get bloomThreshold(){return this._bloomThreshold}set bloomThreshold(e){this._bloomThreshold=e,this._passes.compositePassSSAOBloom.effects[1].luminanceMaterial.uniforms.threshold.value=this._bloomThreshold=e}get bloomBrightness(){return this._bloomBrightness}set bloomBrightness(e){this._passes.compositePassSSAOBloom&&(this._passes.compositePassSSAOBloom.effects[1].intensity=this._bloomBrightness=e)}get bloomRadius(){return this._bloomRadius}set bloomRadius(e){this._passes.compositePassSSAOBloom.effects[1].kernelSize=Math.round(5*(this._bloomRadius=e))}get enableToneMapping(){return this._enableToneMapping}set enableToneMapping(e){util$1.isBoolean(e)&&this._passes.colorGradingPass&&this._passes.colorGradingPass.brightnessContrastEffect&&this._passes.colorGradingPass.hueSaturationEffect&&(this._passes.colorGradingPass.brightnessContrastEffect.blendMode.setBlendFunction((this._enableToneMapping=e)?BlendFunction.NORMAL:BlendFunction.SKIP),this._passes.colorGradingPass.hueSaturationEffect.blendMode.setBlendFunction((this._enableToneMapping=e)?BlendFunction.NORMAL:BlendFunction.SKIP))}get toneMappingExposure(){return this._toneMappingExposure}set toneMappingExposure(e){this.enableToneMapping=this._enableToneMapping,this._toneMappingExposure=e}get toneMappingBrightness(){return this._toneMappingBrightness}set toneMappingBrightness(e){this.enableToneMapping=this._enableToneMapping,this._passes.colorGradingPass&&this._passes.colorGradingPass.brightnessContrastEffect&&("number"!=typeof e||e<-1||e>1||(this._passes.colorGradingPass.brightnessContrastEffect.uniforms.get("brightness").value=this._toneMappingBrightness=e))}get toneMappingContrast(){return this._toneMappingContrast}set toneMappingContrast(e){this.enableToneMapping=this._enableToneMapping,this._passes.colorGradingPass&&this._passes.colorGradingPass.brightnessContrastEffect&&("number"!=typeof e||e<-1||e>1||(e>.99&&(e=.99),this._passes.colorGradingPass.brightnessContrastEffect.uniforms.get("contrast").value=this._toneMappingContrast=e))}get toneMappingHue(){return this._toneMappingHue}set toneMappingHue(e){this.enableToneMapping=this._enableToneMapping,this._passes.colorGradingPass&&this._passes.colorGradingPass.hueSaturationEffect&&("number"!=typeof e||e<-180||e>180||this._passes.colorGradingPass.hueSaturationEffect.setHue(MathUtils.degToRad(this._toneMappingHue=e)))}get toneMappingSaturation(){return this._toneMappingSaturation}set toneMappingSaturation(e){this.enableToneMapping=this._enableToneMapping,this._passes.colorGradingPass&&this._passes.colorGradingPass.hueSaturationEffect&&("number"!=typeof e||e<-1||e>1||(this._passes.colorGradingPass.hueSaturationEffect.uniforms.get("saturation").value=this._toneMappingSaturation=e))}get enableFog(){return this._enableFog}set enableFog(e){util$1.isBoolean(e)&&(this._enableFog=e,this._setFog())}get fogDistanceNear(){return this._fogDistanceNear}set fogDistanceNear(e){"number"!=typeof e||e<0||(this._fogDistanceNear=e,this._setFog())}get fogDistanceFar(){return this._fogDistanceFar}set fogDistanceFar(e){"number"!=typeof e||e<0||(this._fogDistanceFar=e,this._setFog())}get fogAutoColor(){return this._fogAutoColor}set fogAutoColor(e){util$1.isBoolean(e)&&(this._fogAutoColor=e,this._setFog())}get fogColor(){return this._fogColor}set fogColor(e){util$1.isCSSColor(e)&&(this._fogColor=e,this._setFog())}_setFog(){_context.scene.fog=null,util$1.isCSSColor(this._fogColor)||util$1.isCSSColor(this._fogColor0)||(this._fogColor="#cccccc"),this._enableFog?this._fogAutoColor?_context.scene.fog=new Fog(this._fogColorFromSkybox,this._fogDistanceNear,this._fogDistanceFar):_context.scene.fog=new Fog(this._fogColor,this._fogDistanceNear,this._fogDistanceFar):this._fogAutoColor?_context.scene.fog=new Fog(this._fogColorFromSkybox,5e8,500000001):_context.scene.fog=new Fog(this._fogColor,5e8,500000001)}get enableAntialias(){return this._enableAntialias}set enableAntialias(e){this._passes.smaaPass&&util$1.isBoolean(e)&&(this._passes.smaaPass.effects[0].blendMode.opacity.value=(this._enableAntialias=e)?1:0)}get antialiasType(){return this._antialiasType}set antialiasType(e){this._antialiasType=e}get antialiasSampleCount(){return this._antialiasSampleCount}set antialiasSampleCount(e){this._antialiasSampleCount=e,this._setAntialias()}get antialiasColorDiff(){return this._antialiasColorDiff}set antialiasColorDiff(e){this._antialiasColorDiff=e,this._setAntialias()}get antialiasPixelReject(){return this._antialiasPixelReject}set antialiasPixelReject(e){this._antialiasPixelReject=e,this._setAntialias()}_setAntialias(){}get enableLUT(){return this._enableLUT}set enableLUT(e){let t=this._enableLUT;this._enableLUT=e,this._passes.lutPass&&(t!=e&&(_context.instance.crossfadeFreeze(),_context.instance.crossfade(1e3)),this._passes.lutPass.enabled=this._enableLUT)}get availableLUTs(){let e=[];for(let t in this._lutMap)e.push(t);return e}get lutIntensity(){return this._lutIntensity}set lutIntensity(e){if(!util$1.isNumber(e))return;e<0&&(e=0),e>1&&(e=1);let t=this._lutIntensity;this._lutIntensity=e,this._passes.lutPass&&(t!=e&&_context.instance.crossfadeFreeze(),this._passes.lutPass.effects[0].blendMode.opacity.value=this._lutIntensity,t!=e&&_context.instance.crossfade(1e3))}get lutSelected(){return this._lutSelected}set lutSelected(e){if("CUSTOM"===e){if(!this._lutCustom)return;this._addLUTCube(this._lutCustom,"CUSTOM")}else e.indexOf(".CUBE")>0&&(e=e.replace(".CUBE","")),this._lutMap.hasOwnProperty(e)||(e="Arabica 12"),this._addLUTCube(util$1.url(_context.instance.resourceBasePath,`texture/luts/${e}.CUBE`),e)}get lutCustom(){return this._lutCustom}set lutCustom(e){if(this._lutCustom=e,""!==e)try{this._addLUTCube(e,"CUSTOM")}catch(t){e=""}"CUSTOM"===this._lutSelected&&""===e&&(this._passes.lutPass&&(this._passes.lutPass.enabled=!1,this._passes.lutPass=null),delete this._lutMap.CUSTOM)}get lutCustomName(){return this.lutCustomName}set lutCustomName(e){this._lutCustomName=e}nextLUT(){if(!this._enableLUT)return;if("Zeke 39"===this.lutSelected)return this.lutSelected="Arabica 12","Arabica 12";let e="";for(let t in this._lutMap){if(""!==e){this.lutSelected=t;break}this._lutMap[t]===this._passes.lutPass.effects[0].getLUT()&&(e=t)}return this.lutSelected}_addLUTCube(e,t){if(this._lutSelected=t,this._lutMap[t]&&this._lutMap[t].image&&"string"!=typeof this._lutMap[t].image&&this._passes.lutPass)this._passes.lutPass.effects[0].setLUT(this._lutMap[t]);else if(this._passes.lutPass)try{new LUTCubeLoader(_context.defaultLoadingManager).load(e,(e=>{if(_context.instance.crossfadeFreeze(),!this._passes.lutPass)return;const r=LookupTexture3D.from(e);this._passes.lutPass.effects[0].setLUT(r),this._lutMap[t]=r,_context.instance.crossfade(1e3)}))}catch(e){logger.warn("无效的 3D LUT 文件。"),_context.instance.crossfade(1e3)}else new LUTCubeLoader(_context.defaultLoadingManager).load(e,(e=>{_context.instance.crossfadeFreeze();try{const r=LookupTexture3D.from(e);let n=_context.renderer.capabilities.isWebGL2?new LUTEffect(r):new LUTEffect(r.convertToUint8().toDataTexture());this._passes.lutPass?this._lutSelected===t&&this._passes.lutPass.effects[0].setLUT(this._lutMap[t]):this._lutSelected===t&&(this._passes.lutPass=new EffectPass(_context.camera,n),this._passes.lutPass.name="lutPass",this._passes.lutPass.enabled=this._enableLUT,this._passes.lutPass.effects[0].blendMode.opacity.value=this._lutIntensity,_context.composer.addPass(this._passes.lutPass,6),this._lutMap[t]=r),_context.instance.crossfade(1e3)}catch(e){logger.warn("无效的 3D LUT 文件。",e),_context.instance.crossfade(1e3)}}),(e=>{}),(e=>{logger.warn("无效的 3D LUT 文件。",e),_context.instance.crossfade(1e3)}))}_updateDOFCameraProjection(e){this._updateCameraProjection(e)}_updateCameraProjection(e){e&&"number"==typeof e.far&&"number"==typeof e.near&&(this._passes.dofPass&&this._passes.dofPass.depthOfFieldEffect&&(this._passes.dofPass.depthOfFieldEffect.circleOfConfusionMaterial.adoptCameraSettings(e),this.dofFocalDistance=this._dofFocalDistance),this._passes.compositePassSSAOBloom&&this._passes.compositePassSSAOBloom.ssaoEffect&&(this._passes.compositePassSSAOBloom.ssaoEffect.ssaoMaterial.adoptCameraSettings(e),this.ssaoKernelRadius=this._ssaoKernelRadius,this.ssaoMaxDistance=this._ssaoMaxDistance))}getSettings(){let e={};for(let t in this)"_composer"!==t&&"_context"!==t&&"_scene"!==t&&"_renderer"!==t&&"_camera"!==t&&"_cameraControl"!==t&&"_context"!==t&&"_enabled"!==t&&"_size"!==t&&"_passes"!==t&&"function"!=typeof this[t]&&(e[t.replace("_","")]=this[t]);return e}applySettings(e){if(e){for(let t in e)if(this[t]=e[t],"lutMap"===t)for(let r in e[t])for(let n in this._lutMap)n===r&&(this._lutMap[n]||(this._lutMap[n]=e[t][r]))}else logger.error("无效的场景特效设置。")}}var OrbitControls=function(e,t,r=!0){var n,i,a,o,s,l;void 0===t&&logger.warn('THREE.OrbitControls: The second parameter "domElement" is now mandatory.'),t===document&&logger.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.coordLimit={limitHeight:[-999999999,999999999],center:[0,0],radius:999999999},this.object=e,this.domElement=t,this.enabled=!0,this.target=new Vector3,this.minDistance=3,this.maxDistance=this.object.far,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=r,this.zoomSpeed=1,this.enableRotate=r,this.rotateSpeed=1,this.enablePan=r,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={LEFT:MOUSE.ROTATE,MIDDLE:MOUSE.DOLLY,RIGHT:MOUSE.PAN},this.touches={ONE:TOUCH.ROTATE,TWO:TOUCH.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.keyOperate=null,this.getPolarAngle=function(){return g.phi},this.getAzimuthalAngle=function(){return g.theta},this.listenToKeyEvents=function(e){e.addEventListener("keydown",ee),this._domElementKeyEvents=e},this.saveState=function(){c.target0.copy(c.target),c.position0.copy(c.object.position),c.zoom0=c.object.zoom},this.reset=function(){c.target.copy(c.target0),c.object.position.copy(c.position0),c.object.zoom=c.zoom0,c.object.updateProjectionMatrix(),c.dispatchEvent(h),c.update(),f=p.NONE},this.update=(n=new Vector3,i=(new Quaternion).setFromUnitVectors(e.up,new Vector3(0,1,0)),a=i.clone().invert(),o=new Vector3,s=new Quaternion,l=2*Math.PI,function(e){if(function(){if(!c.coordLimit)return!1;var e=c.object.position;let t=e.x,r=e.y,n=e.z;r<c.coordLimit.limitHeight[0]&&(r=c.coordLimit.limitHeight[0]),r>c.coordLimit.limitHeight[1]&&(r=c.coordLimit.limitHeight[1]);let i=new Vector2(e.x,e.z),a=new Vector2(c.coordLimit.center[0],c.coordLimit.center[1]);if(i.distanceTo(a)>c.coordLimit.radius){let n=Math.atan2(e.x-c.coordLimit.center[0],e.z-c.coordLimit.center[1]);t=c.coordLimit.center[0]+c.coordLimit.radius*Math.cos(n),r=c.coordLimit.center[1]+c.coordLimit.radius*Math.sin(n)}return e.set(t,r,n),!0}()){var t=c.object.position;n.copy(t).sub(c.target),n.applyQuaternion(i),g.setFromVector3(n),c.autoRotate&&f===p.NONE&&R(function(e){return e?2*Math.PI/60/60*c.autoRotateSpeed*e/.0167:2*Math.PI/60/60*c.autoRotateSpeed}(e)),c.enableDamping?(g.theta+=y.theta*c.dampingFactor,g.phi+=y.phi*c.dampingFactor):(g.theta+=y.theta,g.phi+=y.phi);var r=c.minAzimuthAngle,u=c.maxAzimuthAngle;return isFinite(r)&&isFinite(u)&&(r<-Math.PI?r+=l:r>Math.PI&&(r-=l),u<-Math.PI?u+=l:u>Math.PI&&(u-=l),g.theta=r<=u?Math.max(r,Math.min(u,g.theta)):g.theta>(r+u)/2?Math.max(r,g.theta):Math.min(u,g.theta)),g.phi=Math.max(c.minPolarAngle,Math.min(c.maxPolarAngle,g.phi)),g.makeSafe(),g.radius*=v,g.radius=Math.max(c.minDistance,Math.min(c.maxDistance,g.radius)),!0===c.enableDamping?c.target.addScaledVector(b,c.dampingFactor):c.target.add(b),n.setFromSpherical(g),n.applyQuaternion(a),t.copy(c.target).add(n),c.object.lookAt(c.target),!0===c.enableDamping?(y.theta*=1-c.dampingFactor,y.phi*=1-c.dampingFactor,b.multiplyScalar(1-c.dampingFactor)):(y.set(0,0,0),b.set(0,0,0)),v=1,!!(_||o.distanceToSquared(c.object.position)>m||8*(1-s.dot(c.object.quaternion))>m)&&(c.dispatchEvent(h),o.copy(c.object.position),s.copy(c.object.quaternion),_=!1,!0)}}),this.dispose=function(){c.domElement.removeEventListener("contextmenu",ie),c.domElement.removeEventListener("pointerdown",$),c.domElement.removeEventListener("wheel",K),c.domElement.removeEventListener("touchstart",te),c.domElement.removeEventListener("touchend",ne),c.domElement.removeEventListener("touchmove",re),c.domElement.ownerDocument.removeEventListener("pointermove",Z),c.domElement.ownerDocument.removeEventListener("pointerup",q),null!==c._domElementKeyEvents&&c._domElementKeyEvents.removeEventListener("keydown",ee)};var c=this,h={type:"change"},u={type:"start"},d={type:"end"},p={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},f=p.NONE,m=1e-6,g=new Spherical,y=new Spherical,v=1,b=new Vector3,_=!1,x=new Vector2,w=new Vector2,S=new Vector2,M=new Vector2,T=new Vector2,A=new Vector2,E=new Vector2,C=new Vector2,L=new Vector2;function D(){return Math.pow(.95,c.zoomSpeed)}function R(e){y.theta-=e}function P(e){y.phi-=e}var O,I=(O=new Vector3,function(e,t){O.setFromMatrixColumn(t,0),O.multiplyScalar(-e),b.add(O)}),k=function(){var e=new Vector3;return function(t,r){!0===c.screenSpacePanning?e.setFromMatrixColumn(r,1):(e.setFromMatrixColumn(r,0),e.crossVectors(c.object.up,e)),e.multiplyScalar(t),b.add(e)}}(),B=function(){var e=new Vector3;return function(t,r){var n=c.domElement;if(c.object.isPerspectiveCamera){var i=c.object.position;e.copy(i).sub(c.target);var a=e.length();a*=Math.tan(c.object.fov/2*Math.PI/180),I(2*t*a/n.clientHeight,c.object.matrix),k(2*r*a/n.clientHeight,c.object.matrix);let o=c.target.clone();if(o.add(b),c.defaultTargetPosition&&0!=c.viewLimitRadius&&c.viewLimitRadius){o.distanceTo(c.defaultTargetPosition)>c.viewLimitRadius&&b.set(0,0,0)}}else c.object.isOrthographicCamera?(I(t*(c.object.right-c.object.left)/c.object.zoom/n.clientWidth,c.object.matrix),k(r*(c.object.top-c.object.bottom)/c.object.zoom/n.clientHeight,c.object.matrix)):(logger.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),c.enablePan=!1)}}();function N(e){if(c.object.isPerspectiveCamera)v/=e;else if(c.object.isOrthographicCamera){if("scene"===c.zoomCenter){let t=c.object.position.clone(),r=c.object.zoom;c.object.zoom=Math.max(c.minZoom,Math.min(c.maxZoom,c.object.zoom*e)),t.multiplyScalar(r/c.object.zoom),c.object.position.set(t.x,c.object.position.y,t.z),c.target.set(t.x,0,t.z),c.update()}else c.object.zoom=Math.max(c.minZoom,Math.min(c.maxZoom,c.object.zoom*e));c.object.updateProjectionMatrix(),_=!0}else logger.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),c.enableZoom=!1}function F(e){if(c.object.isPerspectiveCamera)v*=e;else if(c.object.isOrthographicCamera){if("scene"===c.zoomCenter){let t=c.object.position.clone(),r=c.object.zoom;c.object.zoom=Math.max(c.minZoom,Math.min(c.maxZoom,c.object.zoom/e)),t.multiplyScalar(r/c.object.zoom),c.object.position.set(t.x,c.object.position.y,t.z),c.target.set(t.x,0,t.z),c.update()}else c.object.zoom=Math.max(c.minZoom,Math.min(c.maxZoom,c.object.zoom/e));c.object.updateProjectionMatrix(),_=!0}else logger.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),c.enableZoom=!1}function U(e){x.set(e.clientX,e.clientY)}function z(e){E.set(e.clientX,e.clientY)}function H(e){M.set(e.clientX,e.clientY)}function G(e){if(1==e.touches.length)x.set(e.touches[0].pageX,e.touches[0].pageY);else{var t=.5*(e.touches[0].pageX+e.touches[1].pageX),r=.5*(e.touches[0].pageY+e.touches[1].pageY);x.set(t,r)}}function V(e){if(1==e.touches.length)M.set(e.touches[0].pageX,e.touches[0].pageY);else{var t=.5*(e.touches[0].pageX+e.touches[1].pageX),r=.5*(e.touches[0].pageY+e.touches[1].pageY);M.set(t,r)}}function j(e){var t=e.touches[0].pageX-e.touches[1].pageX,r=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(t*t+r*r);E.set(0,n)}function W(e){if(1==e.touches.length)w.set(e.touches[0].pageX,e.touches[0].pageY);else{var t=.5*(e.touches[0].pageX+e.touches[1].pageX),r=.5*(e.touches[0].pageY+e.touches[1].pageY);w.set(t,r)}S.subVectors(w,x).multiplyScalar(c.rotateSpeed);var n=c.domElement;R(2*Math.PI*S.x/n.clientHeight),P(2*Math.PI*S.y/n.clientHeight),x.copy(w)}function Y(e){if(1==e.touches.length)T.set(e.touches[0].pageX,e.touches[0].pageY);else{var t=.5*(e.touches[0].pageX+e.touches[1].pageX),r=.5*(e.touches[0].pageY+e.touches[1].pageY);T.set(t,r)}A.subVectors(T,M).multiplyScalar(c.panSpeed),B(A.x,A.y),M.copy(T)}function X(e){var t=e.touches[0].pageX-e.touches[1].pageX,r=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(t*t+r*r);C.set(0,n),L.set(0,Math.pow(C.y/E.y,c.zoomSpeed)),N(L.y),E.copy(C)}function $(e){if(!1!==c.enabled)switch(e.pointerType){case"mouse":case"pen":switch(c.keyOperate){case"translation":0===e.button&&J(e);break;case"rotate":0===e.button&&Q(e);break;case"zoom":0===e.button&&function(e){if(e.preventDefault(),c.domElement.focus?c.domElement.focus():window.focus(),!1===c.enableZoom)return;z(e),(f=p.DOLLY)!==p.NONE&&(c.domElement.ownerDocument.addEventListener("pointermove",Z),c.domElement.ownerDocument.addEventListener("pointerup",q),c.dispatchEvent(u))}(e);break;case"paint":2===e.button&&Q(e),1===e.button&&J(e);break;default:!function(e){var t;switch(e.preventDefault(),c.domElement.focus?c.domElement.focus():window.focus(),e.button){case 0:t=c.mouseButtons.LEFT;break;case 1:t=c.mouseButtons.MIDDLE;break;case 2:t=c.mouseButtons.RIGHT;break;default:t=-1}switch(t){case MOUSE.DOLLY:if(!1===c.enableZoom)return;z(e),f=p.DOLLY;break;case MOUSE.ROTATE:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===c.enablePan)return;H(e),f=p.PAN}else{if(!1===c.enableRotate)return;U(e),f=p.ROTATE}break;case MOUSE.PAN:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===c.enableRotate)return;U(e),f=p.ROTATE}else{if(!1===c.enablePan)return;H(e),f=p.PAN}break;default:f=p.NONE}f!==p.NONE&&(c.domElement.ownerDocument.addEventListener("pointermove",Z),c.domElement.ownerDocument.addEventListener("pointerup",q),c.dispatchEvent(u));"function"==typeof c.onPanStart&&c.onPanStart(e)}(e)}}}function Z(e){if(!1!==c.enabled)switch(e.pointerType){case"mouse":case"pen":!function(e){if(!1===c.enabled)return;switch(e.preventDefault(),f){case p.ROTATE:if(!1===c.enableRotate)return;!function(e){w.set(e.clientX,e.clientY),S.subVectors(w,x).multiplyScalar(c.rotateSpeed);var t=c.domElement;R(2*Math.PI*S.x/t.clientHeight),P(2*Math.PI*S.y/t.clientHeight),x.copy(w),c.update()}(e);break;case p.DOLLY:if(!1===c.enableZoom)return;!function(e){C.set(e.clientX,e.clientY),L.subVectors(C,E),L.y>0?N(D()):L.y<0&&F(D()),E.copy(C),c.update()}(e);break;case p.PAN:if(!1===c.enablePan)return;!function(e){T.set(e.clientX,e.clientY),A.subVectors(T,M).multiplyScalar(c.panSpeed),B(A.x,A.y),M.copy(T),c.update()}(e)}}(e)}}function q(e){switch(e.pointerType){case"mouse":case"pen":!function(e){if(c.domElement.ownerDocument.removeEventListener("pointermove",Z),c.domElement.ownerDocument.removeEventListener("pointerup",q),!1===c.enabled)return;c.dispatchEvent(d),f=p.NONE,"function"==typeof c.onPanEnd&&c.onPanEnd(e)}(e)}}function J(e){if(e.preventDefault(),c.domElement.focus?c.domElement.focus():window.focus(),e.ctrlKey||e.metaKey||e.shiftKey){if(!1===c.enableRotate)return;U(e),f=p.ROTATE}else{if(!1===c.enablePan)return;H(e),f=p.PAN}f!==p.NONE&&(c.domElement.ownerDocument.addEventListener("pointermove",Z),c.domElement.ownerDocument.addEventListener("pointerup",q),c.dispatchEvent(u))}function Q(e){if(e.preventDefault(),c.domElement.focus?c.domElement.focus():window.focus(),e.ctrlKey||e.metaKey||e.shiftKey){if(!1===c.enablePan)return;H(e),f=p.PAN}else{if(!1===c.enableRotate)return;U(e),f=p.ROTATE}f!==p.NONE&&(c.domElement.ownerDocument.addEventListener("pointermove",Z),c.domElement.ownerDocument.addEventListener("pointerup",q),c.dispatchEvent(u))}function K(e){!1===c.enabled||!1===c.enableZoom||f!==p.NONE&&f!==p.ROTATE||(e.preventDefault(),e.stopPropagation(),c.dispatchEvent(u),function(e){e.deltaY<0?F(D()):e.deltaY>0&&N(D()),c.update()}(e),c.dispatchEvent(d))}function ee(e){!1!==c.enabled&&!1!==c.enablePan&&function(e){var t=!1;switch(e.keyCode){case c.keys.UP:B(0,c.keyPanSpeed),t=!0;break;case c.keys.BOTTOM:B(0,-c.keyPanSpeed),t=!0;break;case c.keys.LEFT:B(c.keyPanSpeed,0),t=!0;break;case c.keys.RIGHT:B(-c.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),c.update())}(e)}function te(e){if(!1!==c.enabled){switch(e.preventDefault(),e.touches.length){case 1:switch(c.touches.ONE){case TOUCH.ROTATE:if(!1===c.enableRotate)return;G(e),f=p.TOUCH_ROTATE;break;case TOUCH.PAN:if(!1===c.enablePan)return;V(e),f=p.TOUCH_PAN;break;default:f=p.NONE}break;case 2:switch(c.touches.TWO){case TOUCH.DOLLY_PAN:if(!1===c.enableZoom&&!1===c.enablePan)return;!function(e){c.enableZoom&&j(e),c.enablePan&&V(e)}(e),f=p.TOUCH_DOLLY_PAN;break;case TOUCH.DOLLY_ROTATE:if(!1===c.enableZoom&&!1===c.enableRotate)return;!function(e){c.enableZoom&&j(e),c.enableRotate&&G(e)}(e),f=p.TOUCH_DOLLY_ROTATE;break;default:f=p.NONE}break;default:f=p.NONE}f!==p.NONE&&c.dispatchEvent(u)}}function re(e){if(!1!==c.enabled)switch(e.preventDefault(),e.stopPropagation(),f){case p.TOUCH_ROTATE:if(!1===c.enableRotate)return;W(e),c.update();break;case p.TOUCH_PAN:if(!1===c.enablePan)return;Y(e),c.update();break;case p.TOUCH_DOLLY_PAN:if(!1===c.enableZoom&&!1===c.enablePan)return;!function(e){c.enableZoom&&X(e),c.enablePan&&Y(e)}(e),c.update();break;case p.TOUCH_DOLLY_ROTATE:if(!1===c.enableZoom&&!1===c.enableRotate)return;!function(e){c.enableZoom&&X(e),c.enableRotate&&W(e)}(e),c.update();break;default:f=p.NONE}}function ne(e){!1!==c.enabled&&(c.dispatchEvent(d),f=p.NONE)}function ie(e){!1!==c.enabled&&e.preventDefault()}c.domElement.addEventListener("contextmenu",ie),c.domElement.addEventListener("pointerdown",$),c.domElement.addEventListener("wheel",K),c.domElement.addEventListener("touchstart",te),c.domElement.addEventListener("touchend",ne),c.domElement.addEventListener("touchmove",re),this.update()};OrbitControls.prototype=Object.create(EventDispatcher.prototype),OrbitControls.prototype.constructor=OrbitControls;var MapControls=function(e,t){OrbitControls.call(this,e,t),this.screenSpacePanning=!1,this.mouseButtons.LEFT=MOUSE.PAN,this.mouseButtons.RIGHT=MOUSE.ROTATE,this.touches.ONE=TOUCH.PAN,this.touches.TWO=TOUCH.DOLLY_ROTATE};MapControls.prototype=Object.create(EventDispatcher.prototype),MapControls.prototype.constructor=MapControls;class PaintControls{constructor(){let e,t,r,n,i,a=!1,o=!1,s=0,l="roam",c=!1,h=!1;const u=[];let d=null,p=!1,f=null,m=null,g=null;this.size=1,this.setSize=e=>{"number"==typeof e&&e>0&&(this.size=e,r.scale.set(e,.1*e,e))},this.handleKeys=e=>{219===e.keyCode&&this.setSize(this.size/1.1),221===e.keyCode&&this.setSize(1.1*this.size)},this.init=()=>{const i=new CylinderGeometry(1,1,1,32);n=new MeshLambertMaterial({color:16711935,opacity:.5,transparent:!0}),r=new Mesh(i,n),r.scale.set(5,.5,5),r.visible=!1,_context.scene.sysObjects.add(r),t=new Raycaster,e=new Vector2,document.addEventListener("pointermove",this.onPointerMove),document.addEventListener("pointerdown",this.onPointerDown),document.addEventListener("pointerup",this.onPointerUp),document.addEventListener("keydown",this.onDocumentKeyDown),document.addEventListener("keyup",this.onDocumentKeyUp)},this.destroy=()=>{document.removeEventListener("pointermove",this.onPointerMove),document.removeEventListener("pointerdown",this.onPointerDown),document.removeEventListener("pointerup",this.onPointerUp),document.removeEventListener("keydown",this.onDocumentKeyDown),document.removeEventListener("keyup",this.onDocumentKeyUp),document.removeEventListener("keydown",this.handleKeys)},this.getRand=function(e){return this.obj=e,this.init()},this.getRand.prototype.sum=function(e){var t=this.obj,r=0;for(var n in t)r+=t[n][e];return r},this.getRand.prototype.init=function(){var e=null,t=this.obj,r=this.sum("intensity");for(var n in t){if(parseFloat(Math.random()*r)<=t[n].intensity){e=t[n];break}r-=t[n].intensity}return e},this._paint=({x:e,y:t,z:r},n,i)=>{if(!a||!(this.assets instanceof Array&&this.assets.length>0))return;let o={};if(o=new this.getRand(this.assets),"paint"===l.toLowerCase()||"brush"===l.toLowerCase()){let a=Math.random()*Math.PI*2,o=Math.random()*this.size,s=new Vector3(Math.cos(a)*o,0,Math.sin(a)*o);if(n&&s.applyQuaternion(n),e+=s.x,t+=s.y,r+=s.z,i){let t=(new Box3).setFromObject(i);t&&t.min&&t.max&&(e=t.min.x>e?t.min.x:e,e=t.max.x<e?t.max.x:e,r=t.min.z>r?t.min.z:r,r=t.max.z<r?t.max.z:r)}}o.transform||(o.transform={position:{x:0,y:0,z:0},rotation:{_x:0,_y:0,_z:0,_order:"XYZ"},scale:{x:1,y:1,z:1}});let c=g.getGroup().position;if(0!=c.x||0!=c.y||0!=c.z){let n=(new Matrix4).makeTranslation(0-c.x,0-c.y,0-c.z),i=new Vector3(e,t,r).applyMatrix4(n);e=i.x,t=i.y,r=i.z}let h=[[e/(Number(o.transform.scale.x)||1),t/(Number(o.transform.scale.y)||1),r/(Number(o.transform.scale.z)||1)]];if("number"==typeof o.intensity&&o.intensity<0&&(o.intensity=0),0!==o.intensity&&!(s*o.probability<2))switch(s=0,o.type){case"ModelAsset":if(g.getItemByName(o.name)){o.drawRequested=void 0;let e=g.getItemByName(o.name);e.setRand(o.randomValues),e.addInstance(h,g)}else{if(1==o.drawRequested)break;o.drawRequested=!0;let e={name:o.name,gltf:o.gltf,path:o.param.path,transform:o.transform,randomValues:o.randomValues,points:h};g.childrenAdd(new InstancedObject(e,g,(e=>{f&&f({name:g.name}),this.setLayerName(g.name)}))),o.drawRequested=void 0}break;case"IconAsset":var u=JSON.parse(JSON.stringify(o));u.transform.position.x=h[0][0],u.transform.position.y=h[0][1],u.transform.position.z=h[0][2],u.name=util$1.getCopyName(u.name,null,g),u.isVisible=!0,u.index=_context.instance.defaultObjectTree.children.length,new IconItem(u,g,(e=>{f&&f({name:g.name})}))}},this.onPointerMove=n=>{if(!a||n.target!==_context.renderer.domElement)return;if(i&&(i=clearInterval(i),i=void 0),c=!0,s++,e.set(n.offsetX/_context.renderer.domElement.clientWidth*2-1,-n.offsetY/_context.renderer.domElement.clientHeight*2+1),h&&p){let e=[],r=_context.instance.defaultObjectTree.getItemByName(d);r&&r.getGroup().children.map((t=>{"IconGroup"===t.type?t.children.map((t=>{e.push(t)})):e.push(t)}));const n=t.intersectObjects(e);if(n.length>0)if("Mesh"===n[0].object.type){for(let e=0;e<r.children.length;e++)if(n[0].object.name.indexOf(r.children[e].name)>=0){let t=0,i=0;r.children[e].removeInstance(n[0].instanceId,(e=>{r.children.forEach((e=>{"ModelAsset"===e.type&&t++})),r.children.map((e=>{"ModelAsset"===e.type&&0===e.getMesh().count&&i++})),t===i&&t===r.children.length&&_context.defaultObjectTree.remove(r.name),f&&f(e,"删除成功")}))}}else if("IconBackground"===n[0].object.type||"IconAsset"===n[0].object.type)for(let e=0;e<r.children.length;e++){if(n[0].object.name.replace("底图","").replace("图标","").replace("文字","")===r.children[e].name){let t=0,n=0;r.remove(r.children[e].name,(e=>{r.children.forEach((e=>{"ModelAsset"===e.type&&t++})),r.children.map((e=>{"ModelAsset"===e.type&&0===e.getMesh().count&&n++})),t===n&&t===r.children.length&&_context.defaultObjectTree.remove(r.name),f&&f(e,"删除成功")}))}}}t.setFromCamera(e,_context.camera);const o=t.intersectObjects(u);if(o.length>0){const e=o[0];let t=e.face.normal.clone(),n=new Quaternion;e.object.matrixWorld.decompose({x:0,y:0,z:0},n,{x:0,y:0,z:0}),t.applyQuaternion(n),t.normalize(),r.position.copy(e.point).add(t.clone().multiplyScalar(r.scale.y/2));let i=util$1.calcQuaternionFromNormal(t);if(r.setRotationFromQuaternion(i),h){if("paint"!==l.toLowerCase()&&"brush"!==l.toLowerCase())return;if(0===this.assets.length)return;if(!(g instanceof GroupItem)){let e={name:util$1.getCopyName("Layer",null,_context.defaultObjectTree),index:_context.instance.defaultObjectTree.children.length,isVisible:!0};g=new GroupItem(e)}this._paint(e.point,i,e.object)}}},this.onPointerUp=r=>{if(a&&r.target===_context.renderer.domElement&&0===r.button)if(c&&f&&f({name:g?g.name:null}),h=!1,c=!1,i&&(i=clearInterval(i),i=void 0),e.set(r.offsetX/_context.renderer.domElement.clientWidth*2-1,-r.offsetY/_context.renderer.domElement.clientHeight*2+1),t.setFromCamera(e,_context.camera),o);else if(!h){const e=t.intersectObjects(u);if(e.length>0)if("plot"===l.toLowerCase()){if(0===this.assets.length)return;if(!(g instanceof GroupItem)){let e={name:util$1.getCopyName("Layer",null,_context.defaultObjectTree),index:_context.instance.defaultObjectTree.children.length,isVisible:!0};g=new GroupItem(e)}this._paint(e[0].point,null,e[0].object)}else"click"===l.toLowerCase()&&f&&f(e[0].name);else m&&m({type:"progress",total:1,loaded:1})}},this.onPointerDown=e=>{if(!a||e.target!==_context.renderer.domElement||0!==e.button)return;if(h=!0,c=!1,"paint"!==l.toLowerCase()&&"brush"!==l.toLowerCase())return;const r=t.intersectObjects(u);r.length>0&&(i||(i=setInterval((()=>{this._paint(r[0].point,null,r[0].object)}),500)))},this.onDocumentKeyDown=e=>{switch(e.keyCode){case 16:o=!0}},this.onDocumentKeyUp=e=>{switch(e.keyCode){case 16:o=!1}},this.setLayerName=e=>{d=e,g=_context.defaultObjectTree.getItemByName(d)},this.setMode=(e="roam",t,i,o,s)=>{g=null;let c=l;g=_context.defaultObjectTree.getItemByName(d);for(let e of i){if(!e.param||!e.param.path)continue;let t="";switch(e.type.toLowerCase()){case"iconasset":case"iconitem":t="texture";break;case"modelasset":default:t="glb"}_context.instance.preloadResource(e.param.path,t,(()=>{logger.debug("finish")}),s)}if(i.length>0){i.forEach((e=>{if(this.assets){this.assets.find((t=>t.name===e.name))||this.assets.push(e)}else this.assets=[],this.assets.push(e)}));for(let e=0;e<this.assets.length;e++){if(this.assets[e].gltfIsAdd=!1,i.find((t=>this.assets[e].name===t.name)))for(let e=0;e<i.length;e++)i[e].name===this.assets[e].name&&(this.assets[e].randomValues=i[e].randomValues,this.assets[e].intensity=i[e].intensity,this.assets[e].param=i[e].param,this.assets[e].probability=i[e].probability,this.assets[e].type=i[e].type,i[e].textParam&&(this.assets[e].textParam=i[e].textParam));else this.assets.splice(e,1),e--}}else this.assets=[];switch(l=e,l){case"roam":a=!1,p=!1,r.visible=!1,"editor"===_context.pointerMode?_context.orbitControls.keyOperate="paint":_context.orbitControls.keyOperate=null,_context.pointerDisabled=!1,document.removeEventListener("keydown",this.handleKeys);break;case"plot":case"paint":a=!0,p=!1,r.visible=!0,_context.orbitControls.keyOperate="paint",n.color=new Color("#ffb300"),_context.pointerDisabled=!0,document.addEventListener("keydown",this.handleKeys);break;case"remove":a=!0,p=!0,r.visible=!1,_context.orbitControls.keyOperate="paint",_context.pointerDisabled=!0,document.removeEventListener("keydown",this.handleKeys);break;case"click":a=!0,p=!1,r.visible=!1,_context.orbitControls.keyOperate="paint",_context.pointerDisabled=!0,document.removeEventListener("keydown",this.handleKeys);break;default:l=c}this.setSize(t),this.updateWorld(),o&&(f=o),s&&(m=s)},this.updateWorld=()=>{"click"===l&&d?(u.length=0,_context.defaultObjectTree.getItemByName(d).getGroup().traverse((function(e){e.parent.name===d&&e.children.forEach((e=>{u.push(e)}))}))):(u.length=0,_context.scene.children.map(((e,t)=>{"__models"===e.name&&e.traverse((function(e){!e.isMesh||e instanceof InstancedMesh||e.visible&&!0===e.visible&&0!=util$1.judegParentIsVisible(e)&&u.push(e)}))})))},this.setData=e=>{for(let t of this.assets){let r=_context.instancedObjectStore.findInstancedObject(t.name);r?r.addInstance(points):_context.instancedObjectStore.add(new InstancedObject({name:t.name,modelPath:t.modelPath,transform:t.transform,points:e}))}}}}var TargetCameraControls=function(e){this.orbitControl=e,this.enabled=!0,this.target=new Vector3,this.targetObject=void 0,this.viewDistance=100,this.minDistance=1,this.maxDistance=1e4,this.inclination=-45,this.maxInclination=90,this.minInclination=-90,this.azimuth=0,this.autoRotateEnable=!1,this.autoRotateSpeed=.1,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={LEFT:MOUSE.ROTATE,MIDDLE:MOUSE.PAN,RIGHT:MOUSE.DOLLY},this.touches={ONE:TOUCH.ROTATE,TWO:TOUCH.DOLLY_PAN},this.startPos=new Vector3(0,0,0),this.startInclination=0,this.startAzimuth=0,this.targetPos=new Vector3(0,0,0),this.targetInclination=0,this.targetAzimuth=0,this.currentTime=0,this.durationTime=0,this.startDistance=0,this.targetDistance=0,this.target0=this.target.clone(),this.position0=this.orbitControl.object.position.clone(),this.zoom0=this.orbitControl.object.zoom,this.enablePan=!0,this.enableRotate=!0,this.enableZoom=!0,this.callback=void 0;var t=!1,r=this;Object.defineProperty(r,"isZoomTo",{get:function(){return t}});function n(e,t,r,n){var i=t-e;return e+(i/=r)*n}this.zoomTo=function(e,n,i,a,o,s,l){n=(n+180)%360-180;let c=r.orbitControl.getAzimuthalAngle()/Math.PI*180;n-c>180&&(n-=360),n-c<-180&&(n+=360),r.targetPos=e,r.targetAzimuth=n,r.targetInclination=i,r.durationTime=o,r.enablePan=s,r.targetDistance=a;var h=r.orbitControl.object.position.clone().divideScalar(-1),u=r.orbitControl.target.clone().add(h).length(),d=180*r.orbitControl.getAzimuthalAngle()/Math.PI,p=180*r.orbitControl.getPolarAngle()/Math.PI;r.startDistance=u,r.currentTime=0,r.startPos=r.orbitControl.target.clone(),r.startInclination=p-90,r.startAzimuth=d,t=!0,l&&(this.callback&&this.callback({isInterrupt:!0}),this.callback=l)},this.update=function(e){if(t){if(r.durationTime-r.currentTime>1e-6){var i=n(r.startPos.x,r.targetPos.x,r.durationTime,r.currentTime),a=n(r.startPos.y,r.targetPos.y,r.durationTime,r.currentTime),o=n(r.startPos.z,r.targetPos.z,r.durationTime,r.currentTime);r.target=new Vector3(i,a,o),r.inclination=n(r.startInclination,r.targetInclination,r.durationTime,r.currentTime),r.azimuth=n(r.startAzimuth,r.targetAzimuth,r.durationTime,r.currentTime),r.viewDistance=n(r.startDistance,r.targetDistance,r.durationTime,r.currentTime),r.currentTime+=e}else t=!1,r.target=r.targetPos,r.inclination=r.targetInclination,r.azimuth=r.targetAzimuth,r.viewDistance=r.targetDistance,this.callback&&(util$1.markObjectsNeedsUpdate(),this.callback(),this.callback=void 0);var s=new Vector3(0,0,r.viewDistance),l=new Matrix4;l.identity(),l.makeRotationX(r.inclination*Math.PI/180);var c=new Matrix4;c.identity(),c.makeRotationY(r.azimuth*Math.PI/180);var h=new Matrix4;h.identity(),h.makeRotationZ(0),c.multiply(l),c.multiply(h),s.applyMatrix4(c);var u=s.add(r.target);r.orbitControl.object.position.set(u.x,u.y,u.z),r.orbitControl.target.set(r.target.x,r.target.y,r.target.z),r.orbitControl.update(e)}r.autoRotateEnable&&(r.azimuth+=r.autoRotateSpeed*e)},this.dispose=function(){},this.update()};TargetCameraControls.prototype=Object.create(EventDispatcher.prototype),TargetCameraControls.prototype.constructor=TargetCameraControls;var TransformControls=function(e,t){void 0===t&&(logger.warn('THREE.TransformControls: The second parameter "domElement" is now mandatory.'),t=document),Object3D.call(this),this.visible=!1,this.domElement=t,this.scaleEqualProportion=!1;var r=new TransformControlsGizmo;this.add(r);var n=new TransformControlsPlane;this.add(n);var i=this;V("camera",e),V("object",void 0),V("enabled",!0),V("axis",null),V("mode","translate"),V("translationSnap",null),V("rotationSnap",null),V("scaleSnap",null),V("space","world"),V("size",1),V("dragging",!1),V("showX",!0),V("showY",!0),V("showZ",!0),V("showE",!0);var a={type:"change"},o={type:"mouseDown"},s={type:"mouseUp",mode:i.mode},l={type:"objectChange"},c={type:"translate"},h={type:"rotate"},u={type:"scale"},d=new Raycaster;function p(e,t,r){for(var n=t.intersectObject(e,!0),i=0;i<n.length;i++)if(n[i].object.visible||r)return n[i];return!1}var f=new Vector3,m=new Vector3,g=new Quaternion,y={X:new Vector3(1,0,0),Y:new Vector3(0,1,0),Z:new Vector3(0,0,1)},v=new Vector3,b=new Vector3,_=new Vector3,x=new Vector3,w=new Vector3,S=new Vector3,M=0,T=new Vector3,A=new Quaternion,E=new Vector3,C=new Vector3,L=new Quaternion,D=new Quaternion,R=new Vector3,P=new Vector3,O=new Quaternion,I=new Vector3,k=new Vector3,B=new Quaternion,N=new Quaternion,F=new Vector3,U=new Vector3,z=new Vector3,H=new Quaternion,G=new Vector3;function V(e,t){var o=t;Object.defineProperty(i,e,{get:function(){return void 0!==o?o:t},set:function(t){o!==t&&(o=t,n[e]=t,r[e]=t,i.dispatchEvent({type:e+"-changed",value:t}),i.dispatchEvent(a))}}),i[e]=t,n[e]=t,r[e]=t}function j(e){if(i.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:e.button};var r=e.changedTouches?e.changedTouches[0]:e,n=t.getBoundingClientRect();return{x:(r.clientX-n.left)/n.width*2-1,y:-(r.clientY-n.top)/n.height*2+1,button:e.button}}function W(e){if(i.enabled)switch(e.pointerType){case"mouse":case"pen":i.pointerHover(j(e))}}function Y(e){i.enabled&&(i.domElement.style.touchAction="none",i.domElement.ownerDocument.addEventListener("pointermove",X),i.pointerHover(j(e)),i.pointerDown(j(e)))}function X(e){i.enabled&&i.pointerMove(j(e))}function $(e){i.enabled&&(i.domElement.style.touchAction="",i.domElement.ownerDocument.removeEventListener("pointermove",X),i.pointerUp(j(e)))}V("worldPosition",k),V("worldPositionStart",P),V("worldQuaternion",B),V("worldQuaternionStart",O),V("cameraPosition",T),V("cameraQuaternion",A),V("pointStart",v),V("pointEnd",b),V("rotationAxis",x),V("rotationAngle",M),V("eye",U),t.addEventListener("pointerdown",Y),t.addEventListener("pointermove",W),i.domElement.ownerDocument.addEventListener("pointerup",$),this.dispose=function(){t.removeEventListener("pointerdown",Y),t.removeEventListener("pointermove",W),i.domElement.ownerDocument.removeEventListener("pointermove",X),i.domElement.ownerDocument.removeEventListener("pointerup",$),this.traverse((function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}))},this.attach=function(e){return this.object=e,this.visible=!0,this},this.detach=function(){return this.object=void 0,this.visible=!1,this.axis=null,this},this.updateMatrixWorld=function(){void 0!==this.object&&(this.object.updateMatrixWorld(),null===this.object.parent?logger.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(C,L,R),this.object.matrixWorld.decompose(k,B,F),D.copy(L).invert(),N.copy(B).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(T,A,E),U.copy(T).sub(k).normalize(),Object3D.prototype.updateMatrixWorld.call(this)},this.pointerHover=function(e){if(void 0!==this.object&&!0!==this.dragging){d.setFromCamera(e,this.camera);var t=p(r.picker[this.mode],d);this.axis=t?t.object.name:null}},this.pointerDown=function(e){if(void 0!==this.object&&!0!==this.dragging&&0===e.button&&null!==this.axis){d.setFromCamera(e,this.camera);var t=p(n,d,!0);if(t){var r=this.space;if("scale"===this.mode?r="local":"E"!==this.axis&&"XYZE"!==this.axis&&"XYZ"!==this.axis||(r="world"),"local"===r&&"rotate"===this.mode){var i=this.rotationSnap;"X"===this.axis&&i&&(this.object.rotation.x=Math.round(this.object.rotation.x/i)*i),"Y"===this.axis&&i&&(this.object.rotation.y=Math.round(this.object.rotation.y/i)*i),"Z"===this.axis&&i&&(this.object.rotation.z=Math.round(this.object.rotation.z/i)*i)}this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),z.copy(this.object.position),H.copy(this.object.quaternion),G.copy(this.object.scale),this.object.matrixWorld.decompose(P,O,I),v.copy(t.point).sub(P)}this.dragging=!0,this.rotationAngle=0,o.mode=this.mode,this.dispatchEvent(o)}},this.pointerMove=function(e){var t=this.axis,r=this.mode,o=this.object,s=this.space;if("scale"===r?s="local":"E"!==t&&"XYZE"!==t&&"XYZ"!==t||(s="world"),void 0!==o&&null!==t&&!1!==this.dragging&&-1===e.button){d.setFromCamera(e,this.camera);var T=p(n,d,!0);if(T){if(b.copy(T.point).sub(P),"translate"===r)_.copy(b).sub(v),"local"===s&&"XYZ"!==t&&_.applyQuaternion(N),-1===t.indexOf("X")&&(_.x=0),-1===t.indexOf("Y")&&(_.y=0),-1===t.indexOf("Z")&&(_.z=0),"local"===s&&"XYZ"!==t?_.applyQuaternion(H).divide(R):_.applyQuaternion(D).divide(R),o.position.copy(_).add(z),this.translationSnap&&("local"===s&&(o.position.applyQuaternion(g.copy(H).invert()),-1!==t.search("X")&&(o.position.x=Math.round(o.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(o.position.y=Math.round(o.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(o.position.z=Math.round(o.position.z/this.translationSnap)*this.translationSnap),o.position.applyQuaternion(H)),"world"===s&&(o.parent&&o.position.add(f.setFromMatrixPosition(o.parent.matrixWorld)),-1!==t.search("X")&&(o.position.x=Math.round(o.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(o.position.y=Math.round(o.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(o.position.z=Math.round(o.position.z/this.translationSnap)*this.translationSnap),o.parent&&o.position.sub(f.setFromMatrixPosition(o.parent.matrixWorld)))),c.object=o,i.dispatchEvent(c);else if("scale"===r){if(-1!==t.search("XYZ")||this.scaleEqualProportion){var A=b.length()/v.length();b.dot(v)<0&&(A*=-1),m.set(A,A,A)}else f.copy(v),m.copy(b),f.applyQuaternion(N),m.applyQuaternion(N),m.divide(f),-1===t.search("X")&&(m.x=1),-1===t.search("Y")&&(m.y=1),-1===t.search("Z")&&(m.z=1);o.scale.copy(G).multiply(m),this.scaleSnap&&(-1!==t.search("X")&&(o.scale.x=Math.round(o.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Y")&&(o.scale.y=Math.round(o.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Z")&&(o.scale.z=Math.round(o.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap)),u.object=o,i.dispatchEvent(u)}else if("rotate"===r){_.copy(b).sub(v);var E=20/k.distanceTo(f.setFromMatrixPosition(this.camera.matrixWorld));"E"===t?(x.copy(U),M=b.angleTo(v),w.copy(v).normalize(),S.copy(b).normalize(),M*=S.cross(w).dot(U)<0?1:-1):"XYZE"===t?(x.copy(_).cross(U).normalize(),M=_.dot(f.copy(x).cross(this.eye))*E):"X"!==t&&"Y"!==t&&"Z"!==t||(x.copy(y[t]),f.copy(y[t]),"local"===s&&f.applyQuaternion(B),M=_.dot(f.cross(U).normalize())*E),this.rotationSnap&&(M=Math.round(M/this.rotationSnap)*this.rotationSnap),this.rotationAngleDelta=M-this.rotationAngle,this.rotationAngle=M,"local"===s&&"E"!==t&&"XYZE"!==t?(o.quaternion.copy(H),o.quaternion.multiply(g.setFromAxisAngle(x,M)).normalize()):(x.applyQuaternion(D),o.quaternion.copy(g.setFromAxisAngle(x,M)),o.quaternion.multiply(H).normalize()),h.object=o,i.dispatchEvent(h)}this.dispatchEvent(a),this.dispatchEvent(l)}}},this.pointerUp=function(e){0===e.button&&(this.dragging&&null!==this.axis&&(s.mode=this.mode,this.dispatchEvent(s)),this.dragging=!1,this.axis=null)},this.getMode=function(){return i.mode},this.setMode=function(e){i.mode=e},this.setTranslationSnap=function(e){i.translationSnap=e},this.setRotationSnap=function(e){i.rotationSnap=e},this.setScaleSnap=function(e){i.scaleSnap=e},this.setSize=function(e){i.size=e},this.setSpace=function(e){i.space=e},this.update=function(){logger.warn("THREE.TransformControls: update function has no more functionality and therefore has been deprecated.")}};TransformControls.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:TransformControls,isTransformControls:!0});var TransformControlsGizmo=function(){Object3D.call(this),this.type="TransformControlsGizmo";var e=new MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,side:DoubleSide,fog:!1,toneMapped:!1}),t=new LineBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1,toneMapped:!1}),r=e.clone();r.opacity=.15;var n=e.clone();n.opacity=.33;var i=e.clone();i.color.set(16711680);var a=e.clone();a.color.set(65280);var o=e.clone();o.color.set(255);var s=e.clone();s.opacity=.25;var l=s.clone();l.color.set(16776960);var c=s.clone();c.color.set(65535);var h=s.clone();h.color.set(16711935),e.clone().color.set(16776960);var u=t.clone();u.color.set(16711680);var d=t.clone();d.color.set(65280);var p=t.clone();p.color.set(255);var f=t.clone();f.color.set(65535);var m=t.clone();m.color.set(16711935);var g=t.clone();g.color.set(16776960);var y=t.clone();y.color.set(7895160);var v=g.clone();v.opacity=.25;var b=new CylinderGeometry(0,.05,.2,12,1,!1),_=new BoxGeometry(.125,.125,.125),x=new BufferGeometry;x.setAttribute("position",new Float32BufferAttribute([0,0,0,1,0,0],3));var w=function(e,t){for(var r=new BufferGeometry,n=[],i=0;i<=64*t;++i)n.push(0,Math.cos(i/32*Math.PI)*e,Math.sin(i/32*Math.PI)*e);return r.setAttribute("position",new Float32BufferAttribute(n,3)),r},S={X:[[new Mesh(b,i),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new Mesh(b,i),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new Line(x,u)]],Y:[[new Mesh(b,a),[0,1,0],null,null,"fwd"],[new Mesh(b,a),[0,1,0],[Math.PI,0,0],null,"bwd"],[new Line(x,d),null,[0,0,Math.PI/2]]],Z:[[new Mesh(b,o),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new Mesh(b,o),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new Line(x,p),null,[0,-Math.PI/2,0]]],XYZ:[[new Mesh(new OctahedronGeometry(.1,0),s.clone()),[0,0,0],[0,0,0]]],XY:[[new Mesh(new PlaneGeometry(.295,.295),l.clone()),[.15,.15,0]],[new Line(x,g),[.18,.3,0],null,[.125,1,1]],[new Line(x,g),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new Mesh(new PlaneGeometry(.295,.295),c.clone()),[0,.15,.15],[0,Math.PI/2,0]],[new Line(x,f),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new Line(x,f),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new Mesh(new PlaneGeometry(.295,.295),h.clone()),[.15,0,.15],[-Math.PI/2,0,0]],[new Line(x,m),[.18,0,.3],null,[.125,1,1]],[new Line(x,m),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},M={X:[[new Mesh(new CylinderGeometry(.2,0,1,4,1,!1),r),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new Mesh(new CylinderGeometry(.2,0,1,4,1,!1),r),[0,.6,0]]],Z:[[new Mesh(new CylinderGeometry(.2,0,1,4,1,!1),r),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new Mesh(new OctahedronGeometry(.2,0),r)]],XY:[[new Mesh(new PlaneGeometry(.4,.4),r),[.2,.2,0]]],YZ:[[new Mesh(new PlaneGeometry(.4,.4),r),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new Mesh(new PlaneGeometry(.4,.4),r),[.2,0,.2],[-Math.PI/2,0,0]]]},T={START:[[new Mesh(new OctahedronGeometry(.01,2),n),null,null,null,"helper"]],END:[[new Mesh(new OctahedronGeometry(.01,2),n),null,null,null,"helper"]],DELTA:[[new Line(function(){var e=new BufferGeometry;return e.setAttribute("position",new Float32BufferAttribute([0,0,0,1,1,1],3)),e}(),n),null,null,null,"helper"]],X:[[new Line(x,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Line(x,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Line(x,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},A={X:[[new Line(w(1,.5),u)],[new Mesh(new OctahedronGeometry(.04,0),i),[0,0,.99],null,[1,3,1]]],Y:[[new Line(w(1,.5),d),null,[0,0,-Math.PI/2]],[new Mesh(new OctahedronGeometry(.04,0),a),[0,0,.99],null,[3,1,1]]],Z:[[new Line(w(1,.5),p),null,[0,Math.PI/2,0]],[new Mesh(new OctahedronGeometry(.04,0),o),[.99,0,0],null,[1,3,1]]],E:[[new Line(w(1.25,1),v),null,[0,Math.PI/2,0]],[new Mesh(new CylinderGeometry(.03,0,.15,4,1,!1),v),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new Mesh(new CylinderGeometry(.03,0,.15,4,1,!1),v),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new Mesh(new CylinderGeometry(.03,0,.15,4,1,!1),v),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new Mesh(new CylinderGeometry(.03,0,.15,4,1,!1),v),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new Line(w(1,1),y),null,[0,Math.PI/2,0]]]},E={AXIS:[[new Line(x,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},C={X:[[new Mesh(new TorusGeometry(1,.1,4,24),r),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new Mesh(new TorusGeometry(1,.1,4,24),r),[0,0,0],[Math.PI/2,0,0]]],Z:[[new Mesh(new TorusGeometry(1,.1,4,24),r),[0,0,0],[0,0,-Math.PI/2]]],E:[[new Mesh(new TorusGeometry(1.25,.1,2,24),r)]],XYZE:[[new Mesh(new SphereGeometry(.7,10,8),r)]]},L={X:[[new Mesh(_,i),[.8,0,0],[0,0,-Math.PI/2]],[new Line(x,u),null,null,[.8,1,1]]],Y:[[new Mesh(_,a),[0,.8,0]],[new Line(x,d),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new Mesh(_,o),[0,0,.8],[Math.PI/2,0,0]],[new Line(x,p),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new Mesh(_,l),[.85,.85,0],null,[2,2,.2]],[new Line(x,g),[.855,.98,0],null,[.125,1,1]],[new Line(x,g),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new Mesh(_,c),[0,.85,.85],null,[.2,2,2]],[new Line(x,f),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new Line(x,f),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new Mesh(_,h),[.85,0,.85],null,[2,.2,2]],[new Line(x,m),[.855,0,.98],null,[.125,1,1]],[new Line(x,m),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new Mesh(new BoxGeometry(.125,.125,.125),s.clone()),[1.1,0,0]]],XYZY:[[new Mesh(new BoxGeometry(.125,.125,.125),s.clone()),[0,1.1,0]]],XYZZ:[[new Mesh(new BoxGeometry(.125,.125,.125),s.clone()),[0,0,1.1]]]},D={X:[[new Mesh(new CylinderGeometry(.2,0,.8,4,1,!1),r),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new Mesh(new CylinderGeometry(.2,0,.8,4,1,!1),r),[0,.5,0]]],Z:[[new Mesh(new CylinderGeometry(.2,0,.8,4,1,!1),r),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new Mesh(_,r),[.85,.85,0],null,[3,3,.2]]],YZ:[[new Mesh(_,r),[0,.85,.85],null,[.2,3,3]]],XZ:[[new Mesh(_,r),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new Mesh(new BoxGeometry(.2,.2,.2),r),[1.1,0,0]]],XYZY:[[new Mesh(new BoxGeometry(.2,.2,.2),r),[0,1.1,0]]],XYZZ:[[new Mesh(new BoxGeometry(.2,.2,.2),r),[0,0,1.1]]]},R={X:[[new Line(x,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Line(x,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Line(x,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},P=function(e){var t=new Object3D;for(var r in e)for(var n=e[r].length;n--;){var i=e[r][n][0].clone(),a=e[r][n][1],o=e[r][n][2],s=e[r][n][3],l=e[r][n][4];i.name=r,i.tag=l,a&&i.position.set(a[0],a[1],a[2]),o&&i.rotation.set(o[0],o[1],o[2]),s&&i.scale.set(s[0],s[1],s[2]),i.updateMatrix();var c=i.geometry.clone();c.applyMatrix4(i.matrix),i.geometry=c,i.renderOrder=1/0,i.position.set(0,0,0),i.rotation.set(0,0,0),i.scale.set(1,1,1),t.add(i)}return t},O=new Vector3(0,0,0),I=new Euler,k=new Vector3(0,1,0),B=new Vector3(0,0,0),N=new Matrix4,F=new Quaternion,U=new Quaternion,z=new Quaternion,H=new Vector3(1,0,0),G=new Vector3(0,1,0),V=new Vector3(0,0,1);this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=P(S)),this.add(this.gizmo.rotate=P(A)),this.add(this.gizmo.scale=P(L)),this.add(this.picker.translate=P(M)),this.add(this.picker.rotate=P(C)),this.add(this.picker.scale=P(D)),this.add(this.helper.translate=P(T)),this.add(this.helper.rotate=P(E)),this.add(this.helper.scale=P(R)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1,this.updateMatrixWorld=function(){this.space;var e="local"===("scale"===this.mode?"local":this.space)?this.worldQuaternion:z;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;var t=[];t=(t=(t=t.concat(this.picker[this.mode].children)).concat(this.gizmo[this.mode].children)).concat(this.helper[this.mode].children);for(var r=0;r<t.length;r++){var n,i=t[r];if(i.visible=!0,i.rotation.set(0,0,0),i.position.copy(this.worldPosition),n=this.camera.isOrthographicCamera?(this.camera.top-this.camera.bottom)/this.camera.zoom:this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),i.scale.set(1,1,1).multiplyScalar(n*this.size/7),"helper"!==i.tag){if(i.quaternion.copy(e),"translate"===this.mode||"scale"===this.mode){var a=.99;"X"!==i.name&&"XYZX"!==i.name||Math.abs(k.copy(H).applyQuaternion(e).dot(this.eye))>a&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"Y"!==i.name&&"XYZY"!==i.name||Math.abs(k.copy(G).applyQuaternion(e).dot(this.eye))>a&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"Z"!==i.name&&"XYZZ"!==i.name||Math.abs(k.copy(V).applyQuaternion(e).dot(this.eye))>a&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"XY"===i.name&&Math.abs(k.copy(V).applyQuaternion(e).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"YZ"===i.name&&Math.abs(k.copy(H).applyQuaternion(e).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"XZ"===i.name&&Math.abs(k.copy(G).applyQuaternion(e).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),-1!==i.name.search("X")&&(k.copy(H).applyQuaternion(e).dot(this.eye)<0?"fwd"===i.tag?i.visible=!1:i.scale.x*=-1:"bwd"===i.tag&&(i.visible=!1)),-1!==i.name.search("Y")&&(k.copy(G).applyQuaternion(e).dot(this.eye)<0?"fwd"===i.tag?i.visible=!1:i.scale.y*=-1:"bwd"===i.tag&&(i.visible=!1)),-1!==i.name.search("Z")&&(k.copy(V).applyQuaternion(e).dot(this.eye)<0?"fwd"===i.tag?i.visible=!1:i.scale.z*=-1:"bwd"===i.tag&&(i.visible=!1))}else"rotate"===this.mode&&(U.copy(e),k.copy(this.eye).applyQuaternion(F.copy(e).invert()),-1!==i.name.search("E")&&i.quaternion.setFromRotationMatrix(N.lookAt(this.eye,B,G)),"X"===i.name&&(F.setFromAxisAngle(H,Math.atan2(-k.y,k.z)),F.multiplyQuaternions(U,F),i.quaternion.copy(F)),"Y"===i.name&&(F.setFromAxisAngle(G,Math.atan2(k.x,k.z)),F.multiplyQuaternions(U,F),i.quaternion.copy(F)),"Z"===i.name&&(F.setFromAxisAngle(V,Math.atan2(k.y,k.x)),F.multiplyQuaternions(U,F),i.quaternion.copy(F)));i.visible=i.visible&&(-1===i.name.indexOf("X")||this.showX),i.visible=i.visible&&(-1===i.name.indexOf("Y")||this.showY),i.visible=i.visible&&(-1===i.name.indexOf("Z")||this.showZ),i.visible=i.visible&&(-1===i.name.indexOf("E")||this.showE),i.material.color&&(i.material._opacity=i.material._opacity||i.material.opacity,i.material._color=i.material._color||i.material.color.clone(),i.material.color.copy(i.material._color),i.material.opacity=i.material._opacity,this.enabled?this.axis&&(i.name===this.axis||this.axis.split("").some((function(e){return i.name===e}))?(i.material.opacity=1,i.material.color.lerp(new Color(1,1,1),.5)):(i.material.opacity*=.25,i.material.color.lerp(new Color(1,1,1),.5))):(i.material.opacity*=.5,i.material.color.lerp(new Color(1,1,1),.5)))}else i.visible=!1,"AXIS"===i.name?(i.position.copy(this.worldPositionStart),i.visible=!!this.axis,"X"===this.axis&&(F.setFromEuler(I.set(0,0,0)),i.quaternion.copy(e).multiply(F),Math.abs(k.copy(H).applyQuaternion(e).dot(this.eye))>.9&&(i.visible=!1)),"Y"===this.axis&&(F.setFromEuler(I.set(0,0,Math.PI/2)),i.quaternion.copy(e).multiply(F),Math.abs(k.copy(G).applyQuaternion(e).dot(this.eye))>.9&&(i.visible=!1)),"Z"===this.axis&&(F.setFromEuler(I.set(0,Math.PI/2,0)),i.quaternion.copy(e).multiply(F),Math.abs(k.copy(V).applyQuaternion(e).dot(this.eye))>.9&&(i.visible=!1)),"XYZE"===this.axis&&(F.setFromEuler(I.set(0,Math.PI/2,0)),k.copy(this.rotationAxis),i.quaternion.setFromRotationMatrix(N.lookAt(B,k,G)),i.quaternion.multiply(F),i.visible=this.dragging),"E"===this.axis&&(i.visible=!1)):"START"===i.name?(i.position.copy(this.worldPositionStart),i.visible=this.dragging):"END"===i.name?(i.position.copy(this.worldPosition),i.visible=this.dragging):"DELTA"===i.name?(i.position.copy(this.worldPositionStart),i.quaternion.copy(this.worldQuaternionStart),O.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),O.applyQuaternion(this.worldQuaternionStart.clone().invert()),i.scale.copy(O),i.visible=this.dragging):(i.quaternion.copy(e),this.dragging?i.position.copy(this.worldPositionStart):i.position.copy(this.worldPosition),this.axis&&(i.visible=-1!==this.axis.search(i.name)))}Object3D.prototype.updateMatrixWorld.call(this)}};TransformControlsGizmo.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:TransformControlsGizmo,isTransformControlsGizmo:!0});var TransformControlsPlane=function(){Mesh.call(this,new PlaneGeometry(1e5,1e5,2,2),new MeshBasicMaterial({visible:!1,wireframe:!0,side:DoubleSide,transparent:!0,opacity:.1,toneMapped:!1})),this.type="TransformControlsPlane";var e=new Vector3(1,0,0),t=new Vector3(0,1,0),r=new Vector3(0,0,1),n=new Vector3,i=new Vector3,a=new Vector3,o=new Matrix4,s=new Quaternion;this.updateMatrixWorld=function(){var l=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(l="local"),e.set(1,0,0).applyQuaternion("local"===l?this.worldQuaternion:s),t.set(0,1,0).applyQuaternion("local"===l?this.worldQuaternion:s),r.set(0,0,1).applyQuaternion("local"===l?this.worldQuaternion:s),a.copy(t),this.mode){case"translate":case"scale":switch(this.axis){case"X":a.copy(this.eye).cross(e),i.copy(e).cross(a);break;case"Y":a.copy(this.eye).cross(t),i.copy(t).cross(a);break;case"Z":a.copy(this.eye).cross(r),i.copy(r).cross(a);break;case"XY":i.copy(r);break;case"YZ":i.copy(e);break;case"XZ":a.copy(r),i.copy(t);break;case"XYZ":case"E":i.set(0,0,0)}break;case"rotate":default:i.set(0,0,0)}0===i.length()?this.quaternion.copy(this.cameraQuaternion):(o.lookAt(n.set(0,0,0),i,a),this.quaternion.setFromRotationMatrix(o)),Object3D.prototype.updateMatrixWorld.call(this)}};TransformControlsPlane.prototype=Object.assign(Object.create(Mesh.prototype),{constructor:TransformControlsPlane,isTransformControlsPlane:!0});class SelectControls{constructor(){let e="select",t="rect",r="model",n={},i={},a=[],o=new Raycaster,s=[],l="select_div",c=[];this._onMouseDown=r=>{r.preventDefault(),_context.renderer&&r.target===_context.renderer.domElement&&"select"==e&&"polygon"!=t&&(document.addEventListener("pointermove",this._onMouseMove),n.x=r.offsetX,n.y=r.offsetY,o.setFromCamera(new Vector2(r.offsetX/_context.renderer.domElement.clientWidth*2-1,-r.offsetY/_context.renderer.domElement.clientHeight*2+1),_context.camera))},this._onMouseUp=r=>{if(r.preventDefault(),!_context.renderer||r.target!==_context.renderer.domElement)return;let n=new Vector2(r.offsetX/_context.renderer.domElement.clientWidth*2-1,-r.offsetY/_context.renderer.domElement.clientHeight*2+1);"select"==e?"polygon"!=t?(document.removeEventListener("pointermove",this._onMouseMove),i.x=r.offsetX,i.y=r.offsetY,o.setFromCamera(n,_context.camera),this._createSelectDiv(),this._hightlightSelected()):2==r.button?(a.length>1&&(a.push(a[0]),this._hightlightSelected()),a=[],this._clearSelectDiv()):(a.push({x:r.offsetX,y:r.offsetY}),this._createSelectDiv()):"pick"==e&&("click"==t&&o.setFromCamera(n,_context.camera),this._highLightObj(r))},this._onMouseMove=r=>{r.preventDefault(),r.target===_context.renderer.domElement&&(i.x=r.offsetX,i.y=r.offsetY,"select"==e?this._createSelectDiv():"pick"==e&&"hover"==t&&(o.setFromCamera(new Vector2(r.offsetX/_context.renderer.domElement.clientWidth*2-1,-r.offsetY/_context.renderer.domElement.clientHeight*2+1),_context.camera),this._highLightObj(r)))},this._createSelectDiv=()=>{this._clearSelectDiv(),_context.effectStore.highlightObject();let e=document.createElement("div");switch(e.setAttribute("id",l),t){case"rect":e.style=`position: absolute;\n            width: ${Math.abs(i.x-n.x)}px; \n            height:${Math.abs(i.y-n.y)}px; \n            left: ${i.x>n.x?n.x:i.x}px; \n            top: ${i.y>n.y?n.y:i.y}px;\n            background-color: rgba(0,0,0,0);\n            border: 2px red solid;\n            pointer-events: none`;break;case"circle":let t=Math.sqrt(Math.pow(i.x-n.x,2)+Math.pow(i.y-n.y,2));e.style=`position: absolute;\n            width: ${2*t}px; \n            height:${2*t}px; \n            left: ${i.x>n.x?n.x-t:i.x-t}px; \n            top: ${i.y>n.y?n.y-t:i.y-t}px;\n            background-color: rgba(0,0,0,0);\n            border: 2px red solid;\n            pointer-events: none;\n            border-radius: 50%;`;break;case"polygon":let r=document.createElement("canvas");e.appendChild(r);let o=Math.min(...a.map((e=>e.x))),s=Math.max(...a.map((e=>e.x))),l=Math.min(...a.map((e=>e.y))),c=Math.max(...a.map((e=>e.y))),h=s-o,u=c-l;r.width=h,r.height=u,e.style=`position: absolute;\n            width: "${h}px"; \n            height:"${u}px"; \n            left: ${o}px; \n            top: ${l}px;\n            background-color: rgba(0,0,0,0);\n            pointer-events: none`;let d=r.getContext("2d");d.strokeStyle="#FF0000",d.lineWidth=2,d.beginPath(),a.forEach(((e,t)=>{0==t&&d.moveTo(e.x-o,e.y-l),d.lineTo(e.x-o,e.y-l)})),d.stroke(),d.closePath()}_context.renderer.domElement.parentNode.appendChild(e)},this._clearSelectDiv=()=>{let e=document.getElementById(l);e&&_context.renderer.domElement.parentNode.removeChild(e)},this._xyzToLLA=(e,t)=>{if(t.point){let r=(new CoordinateConvertHelper).XYZToLLA({x:t.point.x,y:t.point.y,z:t.point.z},void 0);r&&(e.clickX=t.point.x,e.clickY=t.point.y,e.clickZ=t.point.z,e.longitude=r.x,e.latitude=r.y,e.altitude=r.z)}if(t.object.position){let e=(new CoordinateConvertHelper).XYZToLLA({x:t.object.position.x,y:t.object.position.y,z:t.object.position.z},void 0);e&&(t.object.positionLla={lon:e.x,lat:e.y,alt:e.z})}return t},this._getType=e=>e.object.name.substring(e.object.name.lastIndexOf("/")+1),this._judegDrawable=e=>"landmark图标"===this._getType(e)||"landmark底图"===this._getType(e)||"landmark文字"===this._getType(e)||"landmark"===this._getType(e)||"bubble"===this._getType(e)||"bar"===this._getType(e)||"odline"===this._getType(e)||"trail"===this._getType(e)||"area"===this._getType(e)||"path"===this._getType(e),this._highLightObj=e=>{let t=o.intersectObjects(s);if(t.length>0){let n=[];for(let r=0;r<t.length;r++){const i=t[r];if(!1===i.object.visible||!1===util$1.judegParentIsVisible(i.object))continue;let a=util$1.findObjectToBuilding(i.object.uuid);if(a){let e=_context.clippingStore.findCutBulidingByUUID(a.getGroup().uuid);if(e&&e.clippingController.pointClipTest(i.point))continue}if(!i.object.material.depthTest){n=[],n.push(this._xyzToLLA(e,i));break}i&&n.push(this._xyzToLLA(e,i))}let i=[];if(n.forEach((e=>{this._judegDrawable(e)||i.push(e)})),i.length>0){let e,t=_context.defaultObjectTree.findItemByObject3D(i[0].object)||{};if("ModelItem"===t.type&&"model"===r?e=t:"BuildingItem"===t.type&&"building"===r&&(e=util$1.getNodelFromModelItem(i[0].object)),e){let e=i[0].object||{};_context.effectStore.highlightObject(e,!1);let t={type:r,id:e.name,selected:!0};c&&c(t)}}}},this._throttle=(e,t=60)=>{let r=!0;return function(){r&&(r=!1,setTimeout((()=>{e.apply(this,arguments),r=!0}),t))}},this._inPolygon=(e,t)=>{let r,n=0,i=t[0],a=t.length;for(let o=1;o<=a;o++){if(r=t[o%a],e.y>(i.y>r.y?r.y:i.y)&&e.y<=(i.y<r.y?r.y:i.y)&&e.x<=(i.x>r.x?i.x:r.x)&&i.y!=r.y){let t=(e.y-i.y)*(r.x-i.x)/(r.y-i.y)+i.x;(i.x==r.x||e.x<=t)&&n++}i=r}return n%2!=0},this._inCircle=(e,t)=>Math.sqrt(Math.pow(e.x-t.centerPoint.x,2)+Math.pow(e.y-t.centerPoint.y,2))<t.r,this._hightlightSelected=()=>{_context.effectStore.highlightObject();let e="model"===r?"ModelItem":"BuildingItem",o=[];_context.scene.models.children.forEach((r=>{let s=_context.defaultObjectTree.findItemByObject3D(r)||{};if(s.getType&&s.getType()===e&&!0===r.visible){r.updateWorldMatrix();let e=(new Box3).setFromObject(r).getCenter(new Vector3),s=this._convertWorldToScreen(e);if("polygon"===t)this._inPolygon(s,a)&&o.push(r);else if("rect"===t){let e=n.x>i.x?i.x:n.x,t=n.x<i.x?i.x:n.x,a=n.y>i.y?i.y:n.y,l=n.y<i.y?i.y:n.y,c=[{x:e,y:l},{x:e,y:a},{x:t,y:a},{x:t,y:l}];this._inPolygon(s,c)&&o.push(r)}else if("circle"===t){let e=Math.sqrt(Math.pow(i.x-n.x,2)+Math.pow(i.y-n.y,2));this._inCircle(s,{centerPoint:n,r:e})&&o.push(r)}}}));let s=o.map((e=>({id:e.name})));c&&c({type:r,data:s}),this._clearSelectDiv(),o.forEach((e=>{let t=_context.defaultObjectTree.getItemByName(e.name).getGroup();_context.effectStore.highlightObject(t,!0)}))},this._convertWorldToScreen=e=>{var t=new Vector3(e.x,e.y,e.z).project(_context.camera),r=_context.renderer.domElement.parentNode.clientWidth/2,n=_context.renderer.domElement.parentNode.clientHeight/2;return{x:Math.round(t.x*r+r),y:Math.round(-t.y*n+n)}},this.startSelect=n=>{_context.scene.children.map((e=>{"__models"===e.name&&e.traverse((function(e){e.isMesh?s.push(e):"IconGroup"===e.type&&e.children.map((e=>{s.push(e)}))}))})),t=n.type,r=n.modelType,e=n.selectType,c=n.events,"select"==e&&(_context.orbitControls.enabled=!1),document.addEventListener("pointerdown",this._onMouseDown),document.addEventListener("pointerup",this._onMouseUp),"pick"==e&&"hover"==t&&document.addEventListener("pointermove",this._onMouseMove)},this.endSelect=()=>{_context.orbitControls.enabled=!0,this._clearSelectDiv(),_context.effectStore.highlightObject(),document.removeEventListener("pointerdown",this._onMouseDown),document.removeEventListener("pointerup",this._onMouseUp),document.removeEventListener("pointermove",this._onMouseMove),_context.eventHandlerStore.add()}}}const SELECTMODEL={RECT:"rect",CIRCLE:"circle",POLYGON:"polygon"};let _selectDivId="select_div",canMove=!0,_type=SELECTMODEL.RECT,_startScreenPoint={},_endScreenPoint={},_polygonPoints=[],_isMouseDown=!1,_selectedCallback;function _onMouseDown(e){if(e.preventDefault(),e.target===_context.renderer.domElement){if(2==e.button)return _polygonPoints.push(_polygonPoints[_polygonPoints.length-1]),_selectDrawable(_polygonPoints),_polygonPoints=[],void _clearSelectDiv();_isMouseDown=!0,_startScreenPoint.x=e.offsetX,_startScreenPoint.y=e.offsetY,_polygonPoints.push(JSON.parse(JSON.stringify(_startScreenPoint)))}}function _onMouseUp(e){e.preventDefault(),e.target===_context.renderer.domElement&&2!=e.button&&(_isMouseDown=!1,_endScreenPoint.x=e.offsetX,_endScreenPoint.y=e.offsetY,_polygonPoints.length>1&&(_polygonPoints[_polygonPoints.length-1]=JSON.parse(JSON.stringify(_endScreenPoint))),_drawSelectDiv())}function _onMouseMove(e){e.preventDefault(),e.target===_context.renderer.domElement&&_isMouseDown&&(_endScreenPoint.x=e.offsetX,_endScreenPoint.y=e.offsetY,_isMouseDown&&_polygonPoints.length>1&&(_polygonPoints[_polygonPoints.length-1]=JSON.parse(JSON.stringify(_endScreenPoint))),_drawSelectDiv())}function _onMouseMove_throttle(){canMove&&(canMove=!1,setTimeout((()=>{_onMouseMove(...arguments),canMove=!0}),60))}function _drawSelectDiv(){switch(_type){case SELECTMODEL.RECT:_drawRect();break;case SELECTMODEL.CIRCLE:_drawCircle();break;case SELECTMODEL.POLYGON:_drawPolygon()}}function _drawRect(){if(_clearSelectDiv(),!_isMouseDown){let e=_startScreenPoint.x>_endScreenPoint.x?_endScreenPoint.x:_startScreenPoint.x,t=_startScreenPoint.x<_endScreenPoint.x?_endScreenPoint.x:_startScreenPoint.x,r=_startScreenPoint.y>_endScreenPoint.y?_endScreenPoint.y:_startScreenPoint.y,n=_startScreenPoint.y<_endScreenPoint.y?_endScreenPoint.y:_startScreenPoint.y;return void _selectDrawable([{x:e,y:n},{x:e,y:r},{x:t,y:r},{x:t,y:n}])}let e=document.createElement("div");e.setAttribute("id",_selectDivId),e.style=`\n    position: absolute;\n    width: ${Math.abs(_endScreenPoint.x-_startScreenPoint.x)}px; \n    height:${Math.abs(_endScreenPoint.y-_startScreenPoint.y)}px; \n    left: ${_endScreenPoint.x>_startScreenPoint.x?_startScreenPoint.x:_endScreenPoint.x}px; \n    top: ${_endScreenPoint.y>_startScreenPoint.y?_startScreenPoint.y:_endScreenPoint.y}px;\n    background-color: rgba(0,0,0,0);\n    border: 2px red solid;\n    pointer-events: none;\n    `,_context.renderer.domElement.parentNode.appendChild(e)}function _drawCircle(){if(_clearSelectDiv(),!_isMouseDown){let e=Math.sqrt(Math.pow(_endScreenPoint.x-_startScreenPoint.x,2)+Math.pow(_endScreenPoint.y-_startScreenPoint.y,2));return void _selectDrawable({centerPoint:_startScreenPoint,r:e})}let e=document.createElement("div");e.setAttribute("id",_selectDivId);let t=Math.sqrt(Math.pow(_endScreenPoint.x-_startScreenPoint.x,2)+Math.pow(_endScreenPoint.y-_startScreenPoint.y,2));e.style=`position: absolute;\n    width: ${2*t}px;\n    height:${2*t}px;\n    left: ${_endScreenPoint.x>_startScreenPoint.x?_startScreenPoint.x-t:_endScreenPoint.x-t}px;\n    top: ${_endScreenPoint.y>_startScreenPoint.y?_startScreenPoint.y-t:_endScreenPoint.y-t}px;\n    background-color: rgba(0,0,0,0);\n    border: 2px red solid;\n    pointer-events: none;\n    border-radius: 50%;\n    `,_context.renderer.domElement.parentNode.appendChild(e)}function _drawPolygon(){_clearSelectDiv();let e=document.createElement("div");e.setAttribute("id",_selectDivId);let t=document.createElement("canvas");e.appendChild(t);let r=Math.min(..._polygonPoints.map((e=>e.x))),n=Math.max(..._polygonPoints.map((e=>e.x))),i=Math.min(..._polygonPoints.map((e=>e.y))),a=Math.max(..._polygonPoints.map((e=>e.y))),o=n-r,s=a-i;t.width=o,t.height=s,e.style=`position: absolute;\n    width: "${o}px"; \n    height:"${s}px"; \n    left: ${r}px; \n    top: ${i}px;\n    background-color: rgba(0,0,0,0);\n    pointer-events: none`;let l=t.getContext("2d");l.strokeStyle="#FF0000",l.lineWidth=2,l.beginPath(),_polygonPoints.forEach(((e,t)=>{0==t&&l.moveTo(e.x-r,e.y-i),l.lineTo(e.x-r,e.y-i)})),l.stroke(),l.closePath(),_context.renderer.domElement.parentNode.appendChild(e)}function _clearSelectDiv(){let e=document.getElementById(_selectDivId);e&&_context.renderer.domElement.parentNode.removeChild(e)}function _selectDrawable(e){let t=[];_context.scene.traverse((e=>e.userData.inView&&t.push(e)));let r=[];for(const n of t){n.updateWorldMatrix();let t=new Vector3;t.setFromMatrixPosition(n.matrixWorld);let i=_convertWorldToScreen(t);_type==SELECTMODEL.CIRCLE?_inCircle(i,e)&&r.push(n):_inPolygon(i,e)&&r.push(n)}_selectedCallback&&_selectedCallback(r)}function _convertWorldToScreen(e){var t=new Vector3(e.x,e.y,e.z).project(_context.camera),r=_context.renderer.domElement.parentNode.clientWidth/2,n=_context.renderer.domElement.parentNode.clientHeight/2;return{x:Math.round(t.x*r+r),y:Math.round(-t.y*n+n)}}function _inPolygon(e,t){let r,n=0,i=t[0],a=t.length;for(let o=1;o<=a;o++){if(r=t[o%a],e.y>(i.y>r.y?r.y:i.y)&&e.y<=(i.y<r.y?r.y:i.y)&&e.x<=(i.x>r.x?i.x:r.x)&&i.y!=r.y){let t=(e.y-i.y)*(r.x-i.x)/(r.y-i.y)+i.x;(i.x==r.x||e.x<=t)&&n++}i=r}return n%2!=0}function _inCircle(e,t){return Math.sqrt(Math.pow(e.x-t.centerPoint.x,2)+Math.pow(e.y-t.centerPoint.y,2))<t.r}SelectControls.prototype.startSelectDrawable=function({type:e},t){_context.orbitControls.enabled=!1,_clearSelectDiv(),_startScreenPoint={},_endScreenPoint={},_polygonPoints=[],document.removeEventListener("pointerdown",_onMouseDown),document.removeEventListener("pointerup",_onMouseUp),document.removeEventListener("pointermove",_onMouseMove_throttle),document.addEventListener("pointerdown",_onMouseDown),document.addEventListener("pointerup",_onMouseUp),document.addEventListener("pointermove",_onMouseMove_throttle),e&&SELECTMODEL[e.toUpperCase()]&&(_type=SELECTMODEL[e.toUpperCase()]),_selectedCallback=t},SelectControls.prototype.endSelectDrawable=function(){_selectedCallback=void 0,document.removeEventListener("pointerdown",_onMouseDown),document.removeEventListener("pointerup",_onMouseUp),document.removeEventListener("pointermove",_onMouseMove_throttle),_clearSelectDiv(),_context.orbitControls.enabled=!0};var browser=createCommonjsModule((function(e,t){e.exports=function e(t,r,n){function i(o,s){if(!r[o]){if(!t[o]){var l="function"==typeof commonjsRequire&&commonjsRequire;if(!s&&l)return l(o,!0);if(a)return a(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var h=r[o]={exports:{}};t[o][0].call(h.exports,(function(e){var r=t[o][1][e];return i(r||e)}),h,h.exports,e,t,r,n)}return r[o].exports}for(var a="function"==typeof commonjsRequire&&commonjsRequire,o=0;o<n.length;o++)i(n[o]);return i}({1:[function(e,t,r){(function(t){(function(){let n=e("./interlace"),i=[function(){},function(e,t,r,n){if(n===t.length)throw new Error("Ran out of data");let i=t[n];e[r]=i,e[r+1]=i,e[r+2]=i,e[r+3]=255},function(e,t,r,n){if(n+1>=t.length)throw new Error("Ran out of data");let i=t[n];e[r]=i,e[r+1]=i,e[r+2]=i,e[r+3]=t[n+1]},function(e,t,r,n){if(n+2>=t.length)throw new Error("Ran out of data");e[r]=t[n],e[r+1]=t[n+1],e[r+2]=t[n+2],e[r+3]=255},function(e,t,r,n){if(n+3>=t.length)throw new Error("Ran out of data");e[r]=t[n],e[r+1]=t[n+1],e[r+2]=t[n+2],e[r+3]=t[n+3]}],a=[function(){},function(e,t,r,n){let i=t[0];e[r]=i,e[r+1]=i,e[r+2]=i,e[r+3]=n},function(e,t,r){let n=t[0];e[r]=n,e[r+1]=n,e[r+2]=n,e[r+3]=t[1]},function(e,t,r,n){e[r]=t[0],e[r+1]=t[1],e[r+2]=t[2],e[r+3]=n},function(e,t,r){e[r]=t[0],e[r+1]=t[1],e[r+2]=t[2],e[r+3]=t[3]}];function o(e,t){let r=[],n=0;function i(){if(n===e.length)throw new Error("Ran out of data");let i,a,o,s,l,c,h,u,d=e[n];switch(n++,t){default:throw new Error("unrecognised depth");case 16:h=e[n],n++,r.push((d<<8)+h);break;case 4:h=15&d,u=d>>4,r.push(u,h);break;case 2:l=3&d,c=d>>2&3,h=d>>4&3,u=d>>6&3,r.push(u,h,c,l);break;case 1:i=1&d,a=d>>1&1,o=d>>2&1,s=d>>3&1,l=d>>4&1,c=d>>5&1,h=d>>6&1,u=d>>7&1,r.push(u,h,c,l,s,o,a,i)}}return{get:function(e){for(;r.length<e;)i();let t=r.slice(0,e);return r=r.slice(e),t},resetAfterLine:function(){r.length=0},end:function(){if(n!==e.length)throw new Error("extra data found")}}}function s(e,t,r,n,a,o){let s=e.width,l=e.height,c=e.index;for(let e=0;e<l;e++)for(let l=0;l<s;l++){let s=r(l,e,c);i[n](t,a,s,o),o+=n}return o}function l(e,t,r,n,i,o){let s=e.width,l=e.height,c=e.index;for(let e=0;e<l;e++){for(let l=0;l<s;l++){let s=i.get(n),h=r(l,e,c);a[n](t,s,h,o)}i.resetAfterLine()}}r.dataToBitMap=function(e,r){let i,a,c=r.width,h=r.height,u=r.depth,d=r.bpp,p=r.interlace;8!==u&&(i=o(e,u)),a=u<=8?t.alloc(c*h*4):new Uint16Array(c*h*4);let f,m,g=Math.pow(2,u)-1,y=0;if(p)f=n.getImagePasses(c,h),m=n.getInterlaceIterator(c,h);else{let e=0;m=function(){let t=e;return e+=4,t},f=[{width:c,height:h}]}for(let t=0;t<f.length;t++)8===u?y=s(f[t],a,m,d,e,y):l(f[t],a,m,d,i,g);if(8===u){if(y!==e.length)throw new Error("extra data found")}else i.end();return a}}).call(this)}).call(this,e("buffer").Buffer)},{"./interlace":11,buffer:33}],2:[function(e,t,r){(function(r){(function(){let n=e("./constants");t.exports=function(e,t,i,a){let o=-1!==[n.COLORTYPE_COLOR_ALPHA,n.COLORTYPE_ALPHA].indexOf(a.colorType);if(a.colorType===a.inputColorType){let t=function(){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256!==new Int16Array(e)[0]}();if(8===a.bitDepth||16===a.bitDepth&&t)return e}let s=16!==a.bitDepth?e:new Uint16Array(e.buffer),l=255,c=n.COLORTYPE_TO_BPP_MAP[a.inputColorType];4!==c||a.inputHasAlpha||(c=3);let h=n.COLORTYPE_TO_BPP_MAP[a.colorType];16===a.bitDepth&&(l=65535,h*=2);let u=r.alloc(t*i*h),d=0,p=0,f=a.bgColor||{};function m(){let e,t,r,i=l;switch(a.inputColorType){case n.COLORTYPE_COLOR_ALPHA:i=s[d+3],e=s[d],t=s[d+1],r=s[d+2];break;case n.COLORTYPE_COLOR:e=s[d],t=s[d+1],r=s[d+2];break;case n.COLORTYPE_ALPHA:i=s[d+1],e=s[d],t=e,r=e;break;case n.COLORTYPE_GRAYSCALE:e=s[d],t=e,r=e;break;default:throw new Error("input color type:"+a.inputColorType+" is not supported at present")}return a.inputHasAlpha&&(o||(i/=l,e=Math.min(Math.max(Math.round((1-i)*f.red+i*e),0),l),t=Math.min(Math.max(Math.round((1-i)*f.green+i*t),0),l),r=Math.min(Math.max(Math.round((1-i)*f.blue+i*r),0),l))),{red:e,green:t,blue:r,alpha:i}}void 0===f.red&&(f.red=l),void 0===f.green&&(f.green=l),void 0===f.blue&&(f.blue=l);for(let e=0;e<i;e++)for(let e=0;e<t;e++){let e=m();switch(a.colorType){case n.COLORTYPE_COLOR_ALPHA:case n.COLORTYPE_COLOR:8===a.bitDepth?(u[p]=e.red,u[p+1]=e.green,u[p+2]=e.blue,o&&(u[p+3]=e.alpha)):(u.writeUInt16BE(e.red,p),u.writeUInt16BE(e.green,p+2),u.writeUInt16BE(e.blue,p+4),o&&u.writeUInt16BE(e.alpha,p+6));break;case n.COLORTYPE_ALPHA:case n.COLORTYPE_GRAYSCALE:{let t=(e.red+e.green+e.blue)/3;8===a.bitDepth?(u[p]=t,o&&(u[p+1]=e.alpha)):(u.writeUInt16BE(t,p),o&&u.writeUInt16BE(e.alpha,p+2));break}default:throw new Error("unrecognised color Type "+a.colorType)}d+=c,p+=h}return u}}).call(this)}).call(this,e("buffer").Buffer)},{"./constants":4,buffer:33}],3:[function(e,t,r){(function(r,n){(function(){let i=e("util"),a=e("stream"),o=t.exports=function(){a.call(this),this._buffers=[],this._buffered=0,this._reads=[],this._paused=!1,this._encoding="utf8",this.writable=!0};i.inherits(o,a),o.prototype.read=function(e,t){this._reads.push({length:Math.abs(e),allowLess:e<0,func:t}),r.nextTick(function(){this._process(),this._paused&&this._reads&&this._reads.length>0&&(this._paused=!1,this.emit("drain"))}.bind(this))},o.prototype.write=function(e,t){if(!this.writable)return this.emit("error",new Error("Stream not writable")),!1;let r;return r=n.isBuffer(e)?e:n.from(e,t||this._encoding),this._buffers.push(r),this._buffered+=r.length,this._process(),this._reads&&0===this._reads.length&&(this._paused=!0),this.writable&&!this._paused},o.prototype.end=function(e,t){e&&this.write(e,t),this.writable=!1,this._buffers&&(0===this._buffers.length?this._end():(this._buffers.push(null),this._process()))},o.prototype.destroySoon=o.prototype.end,o.prototype._end=function(){this._reads.length>0&&this.emit("error",new Error("Unexpected end of input")),this.destroy()},o.prototype.destroy=function(){this._buffers&&(this.writable=!1,this._reads=null,this._buffers=null,this.emit("close"))},o.prototype._processReadAllowingLess=function(e){this._reads.shift();let t=this._buffers[0];t.length>e.length?(this._buffered-=e.length,this._buffers[0]=t.slice(e.length),e.func.call(this,t.slice(0,e.length))):(this._buffered-=t.length,this._buffers.shift(),e.func.call(this,t))},o.prototype._processRead=function(e){this._reads.shift();let t=0,r=0,i=n.alloc(e.length);for(;t<e.length;){let n=this._buffers[r++],a=Math.min(n.length,e.length-t);n.copy(i,t,0,a),t+=a,a!==n.length&&(this._buffers[--r]=n.slice(a))}r>0&&this._buffers.splice(0,r),this._buffered-=e.length,e.func.call(this,i)},o.prototype._process=function(){try{for(;this._buffered>0&&this._reads&&this._reads.length>0;){let e=this._reads[0];if(e.allowLess)this._processReadAllowingLess(e);else{if(!(this._buffered>=e.length))break;this._processRead(e)}}this._buffers&&!this.writable&&this._end()}catch(e){this.emit("error",e)}}}).call(this)}).call(this,e("_process"),e("buffer").Buffer)},{_process:60,buffer:33,stream:61,util:81}],4:[function(e,t,r){t.exports={PNG_SIGNATURE:[137,80,78,71,13,10,26,10],TYPE_IHDR:1229472850,TYPE_IEND:1229278788,TYPE_IDAT:1229209940,TYPE_PLTE:1347179589,TYPE_tRNS:1951551059,TYPE_gAMA:1732332865,COLORTYPE_GRAYSCALE:0,COLORTYPE_PALETTE:1,COLORTYPE_COLOR:2,COLORTYPE_ALPHA:4,COLORTYPE_PALETTE_COLOR:3,COLORTYPE_COLOR_ALPHA:6,COLORTYPE_TO_BPP_MAP:{0:1,2:3,3:1,4:2,6:4},GAMMA_DIVISION:1e5}},{}],5:[function(e,t,r){let n=[];!function(){for(let e=0;e<256;e++){let t=e;for(let e=0;e<8;e++)1&t?t=3988292384^t>>>1:t>>>=1;n[e]=t}}();let i=t.exports=function(){this._crc=-1};i.prototype.write=function(e){for(let t=0;t<e.length;t++)this._crc=n[255&(this._crc^e[t])]^this._crc>>>8;return!0},i.prototype.crc32=function(){return-1^this._crc},i.crc32=function(e){let t=-1;for(let r=0;r<e.length;r++)t=n[255&(t^e[r])]^t>>>8;return-1^t}},{}],6:[function(e,t,r){(function(r){(function(){let n=e("./paeth-predictor");function i(e,t,r,n,i){for(let a=0;a<r;a++)n[i+a]=e[t+a]}function a(e,t,r){let n=0,i=t+r;for(let r=t;r<i;r++)n+=Math.abs(e[r]);return n}function o(e,t,r,n,i,a){for(let o=0;o<r;o++){let r=o>=a?e[t+o-a]:0,s=e[t+o]-r;n[i+o]=s}}function s(e,t,r,n){let i=0;for(let a=0;a<r;a++){let r=a>=n?e[t+a-n]:0,o=e[t+a]-r;i+=Math.abs(o)}return i}function l(e,t,r,n,i){for(let a=0;a<r;a++){let o=t>0?e[t+a-r]:0,s=e[t+a]-o;n[i+a]=s}}function c(e,t,r){let n=0,i=t+r;for(let a=t;a<i;a++){let i=t>0?e[a-r]:0,o=e[a]-i;n+=Math.abs(o)}return n}function h(e,t,r,n,i,a){for(let o=0;o<r;o++){let s=o>=a?e[t+o-a]:0,l=t>0?e[t+o-r]:0,c=e[t+o]-(s+l>>1);n[i+o]=c}}function u(e,t,r,n){let i=0;for(let a=0;a<r;a++){let o=a>=n?e[t+a-n]:0,s=t>0?e[t+a-r]:0,l=e[t+a]-(o+s>>1);i+=Math.abs(l)}return i}function d(e,t,r,i,a,o){for(let s=0;s<r;s++){let l=s>=o?e[t+s-o]:0,c=t>0?e[t+s-r]:0,h=t>0&&s>=o?e[t+s-(r+o)]:0,u=e[t+s]-n(l,c,h);i[a+s]=u}}function p(e,t,r,i){let a=0;for(let o=0;o<r;o++){let s=o>=i?e[t+o-i]:0,l=t>0?e[t+o-r]:0,c=t>0&&o>=i?e[t+o-(r+i)]:0,h=e[t+o]-n(s,l,c);a+=Math.abs(h)}return a}let f={0:i,1:o,2:l,3:h,4:d},m={0:a,1:s,2:c,3:u,4:p};t.exports=function(e,t,n,i,a){let o;if("filterType"in i&&-1!==i.filterType){if("number"!=typeof i.filterType)throw new Error("unrecognised filter types");o=[i.filterType]}else o=[0,1,2,3,4];16===i.bitDepth&&(a*=2);let s=t*a,l=0,c=0,h=r.alloc((s+1)*n),u=o[0];for(let t=0;t<n;t++){if(o.length>1){let t=1/0;for(let r=0;r<o.length;r++){let n=m[o[r]](e,c,s,a);n<t&&(u=o[r],t=n)}}h[l]=u,l++,f[u](e,c,s,h,l,a),l+=s,c+=s}return h}}).call(this)}).call(this,e("buffer").Buffer)},{"./paeth-predictor":15,buffer:33}],7:[function(e,t,r){(function(r){(function(){let n=e("util"),i=e("./chunkstream"),a=e("./filter-parse"),o=t.exports=function(e){i.call(this);let t=[],n=this;this._filter=new a(e,{read:this.read.bind(this),write:function(e){t.push(e)},complete:function(){n.emit("complete",r.concat(t))}}),this._filter.start()};n.inherits(o,i)}).call(this)}).call(this,e("buffer").Buffer)},{"./chunkstream":3,"./filter-parse":9,buffer:33,util:81}],8:[function(e,t,r){(function(t){(function(){let n=e("./sync-reader"),i=e("./filter-parse");r.process=function(e,r){let a=[],o=new n(e);return new i(r,{read:o.read.bind(o),write:function(e){a.push(e)},complete:function(){}}).start(),o.process(),t.concat(a)}}).call(this)}).call(this,e("buffer").Buffer)},{"./filter-parse":9,"./sync-reader":22,buffer:33}],9:[function(e,t,r){(function(r){(function(){let n=e("./interlace"),i=e("./paeth-predictor");function a(e,t,r){let n=e*t;return 8!==r&&(n=Math.ceil(n/(8/r))),n}let o=t.exports=function(e,t){let r=e.width,i=e.height,o=e.interlace,s=e.bpp,l=e.depth;if(this.read=t.read,this.write=t.write,this.complete=t.complete,this._imageIndex=0,this._images=[],o){let e=n.getImagePasses(r,i);for(let t=0;t<e.length;t++)this._images.push({byteWidth:a(e[t].width,s,l),height:e[t].height,lineIndex:0})}else this._images.push({byteWidth:a(r,s,l),height:i,lineIndex:0});this._xComparison=8===l?s:16===l?2*s:1};o.prototype.start=function(){this.read(this._images[this._imageIndex].byteWidth+1,this._reverseFilterLine.bind(this))},o.prototype._unFilterType1=function(e,t,r){let n=this._xComparison,i=n-1;for(let a=0;a<r;a++){let r=e[1+a],o=a>i?t[a-n]:0;t[a]=r+o}},o.prototype._unFilterType2=function(e,t,r){let n=this._lastLine;for(let i=0;i<r;i++){let r=e[1+i],a=n?n[i]:0;t[i]=r+a}},o.prototype._unFilterType3=function(e,t,r){let n=this._xComparison,i=n-1,a=this._lastLine;for(let o=0;o<r;o++){let r=e[1+o],s=a?a[o]:0,l=o>i?t[o-n]:0,c=Math.floor((l+s)/2);t[o]=r+c}},o.prototype._unFilterType4=function(e,t,r){let n=this._xComparison,a=n-1,o=this._lastLine;for(let s=0;s<r;s++){let r=e[1+s],l=o?o[s]:0,c=s>a?t[s-n]:0,h=s>a&&o?o[s-n]:0,u=i(c,l,h);t[s]=r+u}},o.prototype._reverseFilterLine=function(e){let t,n=e[0],i=this._images[this._imageIndex],a=i.byteWidth;if(0===n)t=e.slice(1,a+1);else switch(t=r.alloc(a),n){case 1:this._unFilterType1(e,t,a);break;case 2:this._unFilterType2(e,t,a);break;case 3:this._unFilterType3(e,t,a);break;case 4:this._unFilterType4(e,t,a);break;default:throw new Error("Unrecognised filter type - "+n)}this.write(t),i.lineIndex++,i.lineIndex>=i.height?(this._lastLine=null,this._imageIndex++,i=this._images[this._imageIndex]):this._lastLine=t,i?this.read(i.byteWidth+1,this._reverseFilterLine.bind(this)):(this._lastLine=null,this.complete())}}).call(this)}).call(this,e("buffer").Buffer)},{"./interlace":11,"./paeth-predictor":15,buffer:33}],10:[function(e,t,r){(function(e){(function(){function r(e,t,r,n,i){let a=0;for(let o=0;o<n;o++)for(let n=0;n<r;n++){let r=i[e[a]];if(!r)throw new Error("index "+e[a]+" not in palette");for(let e=0;e<4;e++)t[a+e]=r[e];a+=4}}function n(e,t,r,n,i){let a=0;for(let o=0;o<n;o++)for(let n=0;n<r;n++){let r=!1;if(1===i.length?i[0]===e[a]&&(r=!0):i[0]===e[a]&&i[1]===e[a+1]&&i[2]===e[a+2]&&(r=!0),r)for(let e=0;e<4;e++)t[a+e]=0;a+=4}}function i(e,t,r,n,i){let a=255,o=Math.pow(2,i)-1,s=0;for(let i=0;i<n;i++)for(let n=0;n<r;n++){for(let r=0;r<4;r++)t[s+r]=Math.floor(e[s+r]*a/o+.5);s+=4}}t.exports=function(t,a,o=!1){let s=a.depth,l=a.width,c=a.height,h=a.colorType,u=a.transColor,d=a.palette,p=t;return 3===h?r(t,p,l,c,d):(u&&n(t,p,l,c,u),8===s||o||(16===s&&(p=e.alloc(l*c*4)),i(t,p,l,c,s))),p}}).call(this)}).call(this,e("buffer").Buffer)},{buffer:33}],11:[function(e,t,r){let n=[{x:[0],y:[0]},{x:[4],y:[0]},{x:[0,4],y:[4]},{x:[2,6],y:[0,4]},{x:[0,2,4,6],y:[2,6]},{x:[1,3,5,7],y:[0,2,4,6]},{x:[0,1,2,3,4,5,6,7],y:[1,3,5,7]}];r.getImagePasses=function(e,t){let r=[],i=e%8,a=t%8,o=(e-i)/8,s=(t-a)/8;for(let e=0;e<n.length;e++){let t=n[e],l=o*t.x.length,c=s*t.y.length;for(let e=0;e<t.x.length&&t.x[e]<i;e++)l++;for(let e=0;e<t.y.length&&t.y[e]<a;e++)c++;l>0&&c>0&&r.push({width:l,height:c,index:e})}return r},r.getInterlaceIterator=function(e){return function(t,r,i){let a=t%n[i].x.length,o=(t-a)/n[i].x.length*8+n[i].x[a],s=r%n[i].y.length;return 4*o+((r-s)/n[i].y.length*8+n[i].y[s])*e*4}}},{}],12:[function(e,t,r){(function(r){(function(){let n=e("util"),i=e("stream"),a=e("./constants"),o=e("./packer"),s=t.exports=function(e){i.call(this);let t=e||{};this._packer=new o(t),this._deflate=this._packer.createDeflate(),this.readable=!0};n.inherits(s,i),s.prototype.pack=function(e,t,n,i){this.emit("data",r.from(a.PNG_SIGNATURE)),this.emit("data",this._packer.packIHDR(t,n)),i&&this.emit("data",this._packer.packGAMA(i));let o=this._packer.filterData(e,t,n);this._deflate.on("error",this.emit.bind(this,"error")),this._deflate.on("data",function(e){this.emit("data",this._packer.packIDAT(e))}.bind(this)),this._deflate.on("end",function(){this.emit("data",this._packer.packIEND()),this.emit("end")}.bind(this)),this._deflate.end(o)}}).call(this)}).call(this,e("buffer").Buffer)},{"./constants":4,"./packer":14,buffer:33,stream:61,util:81}],13:[function(e,t,r){(function(r){(function(){let n=!0,i=e("zlib");i.deflateSync||(n=!1);let a=e("./constants"),o=e("./packer");t.exports=function(e,t){if(!n)throw new Error("To use the sync capability of this library in old node versions, please pin pngjs to v2.3.0");let s=new o(t||{}),l=[];l.push(r.from(a.PNG_SIGNATURE)),l.push(s.packIHDR(e.width,e.height)),e.gamma&&l.push(s.packGAMA(e.gamma));let c=s.filterData(e.data,e.width,e.height),h=i.deflateSync(c,s.getDeflateOptions());if(c=null,!h||!h.length)throw new Error("bad png - invalid compressed data response");return l.push(s.packIDAT(h)),l.push(s.packIEND()),r.concat(l)}}).call(this)}).call(this,e("buffer").Buffer)},{"./constants":4,"./packer":14,buffer:33,zlib:32}],14:[function(e,t,r){(function(r){(function(){let n=e("./constants"),i=e("./crc"),a=e("./bitpacker"),o=e("./filter-pack"),s=e("zlib"),l=t.exports=function(e){if(this._options=e,e.deflateChunkSize=e.deflateChunkSize||32768,e.deflateLevel=null!=e.deflateLevel?e.deflateLevel:9,e.deflateStrategy=null!=e.deflateStrategy?e.deflateStrategy:3,e.inputHasAlpha=null==e.inputHasAlpha||e.inputHasAlpha,e.deflateFactory=e.deflateFactory||s.createDeflate,e.bitDepth=e.bitDepth||8,e.colorType="number"==typeof e.colorType?e.colorType:n.COLORTYPE_COLOR_ALPHA,e.inputColorType="number"==typeof e.inputColorType?e.inputColorType:n.COLORTYPE_COLOR_ALPHA,-1===[n.COLORTYPE_GRAYSCALE,n.COLORTYPE_COLOR,n.COLORTYPE_COLOR_ALPHA,n.COLORTYPE_ALPHA].indexOf(e.colorType))throw new Error("option color type:"+e.colorType+" is not supported at present");if(-1===[n.COLORTYPE_GRAYSCALE,n.COLORTYPE_COLOR,n.COLORTYPE_COLOR_ALPHA,n.COLORTYPE_ALPHA].indexOf(e.inputColorType))throw new Error("option input color type:"+e.inputColorType+" is not supported at present");if(8!==e.bitDepth&&16!==e.bitDepth)throw new Error("option bit depth:"+e.bitDepth+" is not supported at present")};l.prototype.getDeflateOptions=function(){return{chunkSize:this._options.deflateChunkSize,level:this._options.deflateLevel,strategy:this._options.deflateStrategy}},l.prototype.createDeflate=function(){return this._options.deflateFactory(this.getDeflateOptions())},l.prototype.filterData=function(e,t,r){let i=a(e,t,r,this._options),s=n.COLORTYPE_TO_BPP_MAP[this._options.colorType];return o(i,t,r,this._options,s)},l.prototype._packChunk=function(e,t){let n=t?t.length:0,a=r.alloc(n+12);return a.writeUInt32BE(n,0),a.writeUInt32BE(e,4),t&&t.copy(a,8),a.writeInt32BE(i.crc32(a.slice(4,a.length-4)),a.length-4),a},l.prototype.packGAMA=function(e){let t=r.alloc(4);return t.writeUInt32BE(Math.floor(e*n.GAMMA_DIVISION),0),this._packChunk(n.TYPE_gAMA,t)},l.prototype.packIHDR=function(e,t){let i=r.alloc(13);return i.writeUInt32BE(e,0),i.writeUInt32BE(t,4),i[8]=this._options.bitDepth,i[9]=this._options.colorType,i[10]=0,i[11]=0,i[12]=0,this._packChunk(n.TYPE_IHDR,i)},l.prototype.packIDAT=function(e){return this._packChunk(n.TYPE_IDAT,e)},l.prototype.packIEND=function(){return this._packChunk(n.TYPE_IEND,null)}}).call(this)}).call(this,e("buffer").Buffer)},{"./bitpacker":2,"./constants":4,"./crc":5,"./filter-pack":6,buffer:33,zlib:32}],15:[function(e,t,r){t.exports=function(e,t,r){let n=e+t-r,i=Math.abs(n-e),a=Math.abs(n-t),o=Math.abs(n-r);return i<=a&&i<=o?e:a<=o?t:r}},{}],16:[function(e,t,r){let n=e("util"),i=e("zlib"),a=e("./chunkstream"),o=e("./filter-parse-async"),s=e("./parser"),l=e("./bitmapper"),c=e("./format-normaliser"),h=t.exports=function(e){a.call(this),this._parser=new s(e,{read:this.read.bind(this),error:this._handleError.bind(this),metadata:this._handleMetaData.bind(this),gamma:this.emit.bind(this,"gamma"),palette:this._handlePalette.bind(this),transColor:this._handleTransColor.bind(this),finished:this._finished.bind(this),inflateData:this._inflateData.bind(this),simpleTransparency:this._simpleTransparency.bind(this),headersFinished:this._headersFinished.bind(this)}),this._options=e,this.writable=!0,this._parser.start()};n.inherits(h,a),h.prototype._handleError=function(e){this.emit("error",e),this.writable=!1,this.destroy(),this._inflate&&this._inflate.destroy&&this._inflate.destroy(),this._filter&&(this._filter.destroy(),this._filter.on("error",(function(){}))),this.errord=!0},h.prototype._inflateData=function(e){if(!this._inflate)if(this._bitmapInfo.interlace)this._inflate=i.createInflate(),this._inflate.on("error",this.emit.bind(this,"error")),this._filter.on("complete",this._complete.bind(this)),this._inflate.pipe(this._filter);else{let e=(1+(this._bitmapInfo.width*this._bitmapInfo.bpp*this._bitmapInfo.depth+7>>3))*this._bitmapInfo.height,t=Math.max(e,i.Z_MIN_CHUNK);this._inflate=i.createInflate({chunkSize:t});let r=e,n=this.emit.bind(this,"error");this._inflate.on("error",(function(e){r&&n(e)})),this._filter.on("complete",this._complete.bind(this));let a=this._filter.write.bind(this._filter);this._inflate.on("data",(function(e){r&&(e.length>r&&(e=e.slice(0,r)),r-=e.length,a(e))})),this._inflate.on("end",this._filter.end.bind(this._filter))}this._inflate.write(e)},h.prototype._handleMetaData=function(e){this._metaData=e,this._bitmapInfo=Object.create(e),this._filter=new o(this._bitmapInfo)},h.prototype._handleTransColor=function(e){this._bitmapInfo.transColor=e},h.prototype._handlePalette=function(e){this._bitmapInfo.palette=e},h.prototype._simpleTransparency=function(){this._metaData.alpha=!0},h.prototype._headersFinished=function(){this.emit("metadata",this._metaData)},h.prototype._finished=function(){this.errord||(this._inflate?this._inflate.end():this.emit("error","No Inflate block"))},h.prototype._complete=function(e){if(this.errord)return;let t;try{let r=l.dataToBitMap(e,this._bitmapInfo);t=c(r,this._bitmapInfo,this._options.skipRescale),r=null}catch(e){return void this._handleError(e)}this.emit("parsed",t)}},{"./bitmapper":1,"./chunkstream":3,"./filter-parse-async":7,"./format-normaliser":10,"./parser":18,util:81,zlib:32}],17:[function(e,t,r){(function(r){(function(){let n=!0,i=e("zlib"),a=e("./sync-inflate");i.deflateSync||(n=!1);let o=e("./sync-reader"),s=e("./filter-parse-sync"),l=e("./parser"),c=e("./bitmapper"),h=e("./format-normaliser");t.exports=function(e,t){if(!n)throw new Error("To use the sync capability of this library in old node versions, please pin pngjs to v2.3.0");let u,d,p;function f(e){u=e}function m(e){d=e}function g(e){d.transColor=e}function y(e){d.palette=e}function v(){d.alpha=!0}function b(e){p=e}let _=[];function x(e){_.push(e)}let w=new o(e);if(new l(t,{read:w.read.bind(w),error:f,metadata:m,gamma:b,palette:y,transColor:g,inflateData:x,simpleTransparency:v}).start(),w.process(),u)throw u;let S,M=r.concat(_);if(_.length=0,d.interlace)S=i.inflateSync(M);else{let e=(1+(d.width*d.bpp*d.depth+7>>3))*d.height;S=a(M,{chunkSize:e,maxLength:e})}if(M=null,!S||!S.length)throw new Error("bad png - invalid inflate data response");let T=s.process(S,d);M=null;let A=c.dataToBitMap(T,d);T=null;let E=h(A,d,t.skipRescale);return d.data=E,d.gamma=p||0,d}}).call(this)}).call(this,e("buffer").Buffer)},{"./bitmapper":1,"./filter-parse-sync":8,"./format-normaliser":10,"./parser":18,"./sync-inflate":21,"./sync-reader":22,buffer:33,zlib:32}],18:[function(e,t,r){(function(r){(function(){let n=e("./constants"),i=e("./crc"),a=t.exports=function(e,t){this._options=e,e.checkCRC=!1!==e.checkCRC,this._hasIHDR=!1,this._hasIEND=!1,this._emittedHeadersFinished=!1,this._palette=[],this._colorType=0,this._chunks={},this._chunks[n.TYPE_IHDR]=this._handleIHDR.bind(this),this._chunks[n.TYPE_IEND]=this._handleIEND.bind(this),this._chunks[n.TYPE_IDAT]=this._handleIDAT.bind(this),this._chunks[n.TYPE_PLTE]=this._handlePLTE.bind(this),this._chunks[n.TYPE_tRNS]=this._handleTRNS.bind(this),this._chunks[n.TYPE_gAMA]=this._handleGAMA.bind(this),this.read=t.read,this.error=t.error,this.metadata=t.metadata,this.gamma=t.gamma,this.transColor=t.transColor,this.palette=t.palette,this.parsed=t.parsed,this.inflateData=t.inflateData,this.finished=t.finished,this.simpleTransparency=t.simpleTransparency,this.headersFinished=t.headersFinished||function(){}};a.prototype.start=function(){this.read(n.PNG_SIGNATURE.length,this._parseSignature.bind(this))},a.prototype._parseSignature=function(e){let t=n.PNG_SIGNATURE;for(let r=0;r<t.length;r++)if(e[r]!==t[r])return void this.error(new Error("Invalid file signature"));this.read(8,this._parseChunkBegin.bind(this))},a.prototype._parseChunkBegin=function(e){let t=e.readUInt32BE(0),a=e.readUInt32BE(4),o="";for(let t=4;t<8;t++)o+=String.fromCharCode(e[t]);let s=Boolean(32&e[4]);if(this._hasIHDR||a===n.TYPE_IHDR){if(this._crc=new i,this._crc.write(r.from(o)),this._chunks[a])return this._chunks[a](t);s?this.read(t+4,this._skipChunk.bind(this)):this.error(new Error("Unsupported critical chunk type "+o))}else this.error(new Error("Expected IHDR on beggining"))},a.prototype._skipChunk=function(){this.read(8,this._parseChunkBegin.bind(this))},a.prototype._handleChunkEnd=function(){this.read(4,this._parseChunkEnd.bind(this))},a.prototype._parseChunkEnd=function(e){let t=e.readInt32BE(0),r=this._crc.crc32();this._options.checkCRC&&r!==t?this.error(new Error("Crc error - "+t+" - "+r)):this._hasIEND||this.read(8,this._parseChunkBegin.bind(this))},a.prototype._handleIHDR=function(e){this.read(e,this._parseIHDR.bind(this))},a.prototype._parseIHDR=function(e){this._crc.write(e);let t=e.readUInt32BE(0),r=e.readUInt32BE(4),i=e[8],a=e[9],o=e[10],s=e[11],l=e[12];if(8!==i&&4!==i&&2!==i&&1!==i&&16!==i)return void this.error(new Error("Unsupported bit depth "+i));if(!(a in n.COLORTYPE_TO_BPP_MAP))return void this.error(new Error("Unsupported color type"));if(0!==o)return void this.error(new Error("Unsupported compression method"));if(0!==s)return void this.error(new Error("Unsupported filter method"));if(0!==l&&1!==l)return void this.error(new Error("Unsupported interlace method"));this._colorType=a;let c=n.COLORTYPE_TO_BPP_MAP[this._colorType];this._hasIHDR=!0,this.metadata({width:t,height:r,depth:i,interlace:Boolean(l),palette:Boolean(a&n.COLORTYPE_PALETTE),color:Boolean(a&n.COLORTYPE_COLOR),alpha:Boolean(a&n.COLORTYPE_ALPHA),bpp:c,colorType:a}),this._handleChunkEnd()},a.prototype._handlePLTE=function(e){this.read(e,this._parsePLTE.bind(this))},a.prototype._parsePLTE=function(e){this._crc.write(e);let t=Math.floor(e.length/3);for(let r=0;r<t;r++)this._palette.push([e[3*r],e[3*r+1],e[3*r+2],255]);this.palette(this._palette),this._handleChunkEnd()},a.prototype._handleTRNS=function(e){this.simpleTransparency(),this.read(e,this._parseTRNS.bind(this))},a.prototype._parseTRNS=function(e){if(this._crc.write(e),this._colorType===n.COLORTYPE_PALETTE_COLOR){if(0===this._palette.length)return void this.error(new Error("Transparency chunk must be after palette"));if(e.length>this._palette.length)return void this.error(new Error("More transparent colors than palette size"));for(let t=0;t<e.length;t++)this._palette[t][3]=e[t];this.palette(this._palette)}this._colorType===n.COLORTYPE_GRAYSCALE&&this.transColor([e.readUInt16BE(0)]),this._colorType===n.COLORTYPE_COLOR&&this.transColor([e.readUInt16BE(0),e.readUInt16BE(2),e.readUInt16BE(4)]),this._handleChunkEnd()},a.prototype._handleGAMA=function(e){this.read(e,this._parseGAMA.bind(this))},a.prototype._parseGAMA=function(e){this._crc.write(e),this.gamma(e.readUInt32BE(0)/n.GAMMA_DIVISION),this._handleChunkEnd()},a.prototype._handleIDAT=function(e){this._emittedHeadersFinished||(this._emittedHeadersFinished=!0,this.headersFinished()),this.read(-e,this._parseIDAT.bind(this,e))},a.prototype._parseIDAT=function(e,t){if(this._crc.write(t),this._colorType===n.COLORTYPE_PALETTE_COLOR&&0===this._palette.length)throw new Error("Expected palette not found");this.inflateData(t);let r=e-t.length;r>0?this._handleIDAT(r):this._handleChunkEnd()},a.prototype._handleIEND=function(e){this.read(e,this._parseIEND.bind(this))},a.prototype._parseIEND=function(e){this._crc.write(e),this._hasIEND=!0,this._handleChunkEnd(),this.finished&&this.finished()}}).call(this)}).call(this,e("buffer").Buffer)},{"./constants":4,"./crc":5,buffer:33}],19:[function(e,t,r){let n=e("./parser-sync"),i=e("./packer-sync");r.read=function(e,t){return n(e,t||{})},r.write=function(e,t){return i(e,t)}},{"./packer-sync":13,"./parser-sync":17}],20:[function(e,t,r){(function(t,n){(function(){let i=e("util"),a=e("stream"),o=e("./parser-async"),s=e("./packer-async"),l=e("./png-sync"),c=r.PNG=function(e){a.call(this),e=e||{},this.width=0|e.width,this.height=0|e.height,this.data=this.width>0&&this.height>0?n.alloc(4*this.width*this.height):null,e.fill&&this.data&&this.data.fill(0),this.gamma=0,this.readable=this.writable=!0,this._parser=new o(e),this._parser.on("error",this.emit.bind(this,"error")),this._parser.on("close",this._handleClose.bind(this)),this._parser.on("metadata",this._metadata.bind(this)),this._parser.on("gamma",this._gamma.bind(this)),this._parser.on("parsed",function(e){this.data=e,this.emit("parsed",e)}.bind(this)),this._packer=new s(e),this._packer.on("data",this.emit.bind(this,"data")),this._packer.on("end",this.emit.bind(this,"end")),this._parser.on("close",this._handleClose.bind(this)),this._packer.on("error",this.emit.bind(this,"error"))};i.inherits(c,a),c.sync=l,c.prototype.pack=function(){return this.data&&this.data.length?(t.nextTick(function(){this._packer.pack(this.data,this.width,this.height,this.gamma)}.bind(this)),this):(this.emit("error","No data provided"),this)},c.prototype.parse=function(e,t){if(t){let e,r;e=function(e){this.removeListener("error",r),this.data=e,t(null,this)}.bind(this),r=function(r){this.removeListener("parsed",e),t(r,null)}.bind(this),this.once("parsed",e),this.once("error",r)}return this.end(e),this},c.prototype.write=function(e){return this._parser.write(e),!0},c.prototype.end=function(e){this._parser.end(e)},c.prototype._metadata=function(e){this.width=e.width,this.height=e.height,this.emit("metadata",e)},c.prototype._gamma=function(e){this.gamma=e},c.prototype._handleClose=function(){this._parser.writable||this._packer.readable||this.emit("close")},c.bitblt=function(e,t,r,n,i,a,o,s){if(n|=0,i|=0,a|=0,o|=0,s|=0,(r|=0)>e.width||n>e.height||r+i>e.width||n+a>e.height)throw new Error("bitblt reading outside image");if(o>t.width||s>t.height||o+i>t.width||s+a>t.height)throw new Error("bitblt writing outside image");for(let l=0;l<a;l++)e.data.copy(t.data,(s+l)*t.width+o<<2,(n+l)*e.width+r<<2,(n+l)*e.width+r+i<<2)},c.prototype.bitblt=function(e,t,r,n,i,a,o){return c.bitblt(this,e,t,r,n,i,a,o),this},c.adjustGamma=function(e){if(e.gamma){for(let t=0;t<e.height;t++)for(let r=0;r<e.width;r++){let n=e.width*t+r<<2;for(let t=0;t<3;t++){let r=e.data[n+t]/255;r=Math.pow(r,1/2.2/e.gamma),e.data[n+t]=Math.round(255*r)}}e.gamma=0}},c.prototype.adjustGamma=function(){c.adjustGamma(this)}}).call(this)}).call(this,e("_process"),e("buffer").Buffer)},{"./packer-async":12,"./parser-async":16,"./png-sync":19,_process:60,buffer:33,stream:61,util:81}],21:[function(e,t,r){(function(n,i){(function(){let a=e("assert").ok,o=e("zlib"),s=e("util"),l=e("buffer").kMaxLength;function c(e){if(!(this instanceof c))return new c(e);e&&e.chunkSize<o.Z_MIN_CHUNK&&(e.chunkSize=o.Z_MIN_CHUNK),o.Inflate.call(this,e),this._offset=void 0===this._offset?this._outOffset:this._offset,this._buffer=this._buffer||this._outBuffer,e&&null!=e.maxLength&&(this._maxLength=e.maxLength)}function h(e){return new c(e)}function u(e,t){t&&n.nextTick(t),e._handle&&(e._handle.close(),e._handle=null)}function d(e,t){if("string"==typeof t&&(t=i.from(t)),!(t instanceof i))throw new TypeError("Not a string or buffer");let r=e._finishFlushFlag;return null==r&&(r=o.Z_FINISH),e._processChunk(t,r)}function p(e,t){return d(new c(t),e)}c.prototype._processChunk=function(e,t,r){if("function"==typeof r)return o.Inflate._processChunk.call(this,e,t,r);let n,s,c=this,h=e&&e.length,d=this._chunkSize-this._offset,p=this._maxLength,f=0,m=[],g=0;function y(e,t){if(c._hadError)return;let r=d-t;if(a(r>=0,"have should not go down"),r>0){let e=c._buffer.slice(c._offset,c._offset+r);if(c._offset+=r,e.length>p&&(e=e.slice(0,p)),m.push(e),g+=e.length,p-=e.length,0===p)return!1}return(0===t||c._offset>=c._chunkSize)&&(d=c._chunkSize,c._offset=0,c._buffer=i.allocUnsafe(c._chunkSize)),0===t&&(f+=h-e,h=e,!0)}this.on("error",(function(e){n=e})),a(this._handle,"zlib binding closed");do{s=this._handle.writeSync(t,e,f,h,this._buffer,this._offset,d),s=s||this._writeState}while(!this._hadError&&y(s[0],s[1]));if(this._hadError)throw n;if(g>=l)throw u(this),new RangeError("Cannot create final Buffer. It would be larger than 0x"+l.toString(16)+" bytes");let v=i.concat(m,g);return u(this),v},s.inherits(c,o.Inflate),t.exports=r=p,r.Inflate=c,r.createInflate=h,r.inflateSync=p}).call(this)}).call(this,e("_process"),e("buffer").Buffer)},{_process:60,assert:23,buffer:33,util:81,zlib:32}],22:[function(e,t,r){let n=t.exports=function(e){this._buffer=e,this._reads=[]};n.prototype.read=function(e,t){this._reads.push({length:Math.abs(e),allowLess:e<0,func:t})},n.prototype.process=function(){for(;this._reads.length>0&&this._buffer.length;){let e=this._reads[0];if(!this._buffer.length||!(this._buffer.length>=e.length||e.allowLess))break;{this._reads.shift();let t=this._buffer;this._buffer=t.slice(e.length),e.func.call(this,t.slice(0,e.length))}}if(this._reads.length>0)throw new Error("There are some read requests waitng on finished stream");if(this._buffer.length>0)throw new Error("unrecognised content at end of stream")}},{}],23:[function(e,t,r){(function(r){(function(){
/*!
   * The buffer module from node.js, for the browser.
   *
   * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
   * @license  MIT
   */
function n(e,t){if(e===t)return 0;for(var r=e.length,n=t.length,i=0,a=Math.min(r,n);i<a;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return r<n?-1:n<r?1:0}function i(e){return r.Buffer&&"function"==typeof r.Buffer.isBuffer?r.Buffer.isBuffer(e):!(null==e||!e._isBuffer)}var a=e("util/"),o=Object.prototype.hasOwnProperty,s=Array.prototype.slice,l="foo"===function(){}.name;function c(e){return Object.prototype.toString.call(e)}function h(e){return!i(e)&&"function"==typeof r.ArrayBuffer&&("function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):!!e&&(e instanceof DataView||!!(e.buffer&&e.buffer instanceof ArrayBuffer)))}var u=t.exports=v,d=/\s*function\s+([^\(\s]*)\s*/;function p(e){if(a.isFunction(e)){if(l)return e.name;var t=e.toString().match(d);return t&&t[1]}}function f(e,t){return"string"==typeof e?e.length<t?e:e.slice(0,t):e}function m(e){if(l||!a.isFunction(e))return a.inspect(e);var t=p(e);return"[Function"+(t?": "+t:"")+"]"}function g(e){return f(m(e.actual),128)+" "+e.operator+" "+f(m(e.expected),128)}function y(e,t,r,n,i){throw new u.AssertionError({message:r,actual:e,expected:t,operator:n,stackStartFunction:i})}function v(e,t){e||y(e,!0,t,"==",u.ok)}function b(e,t,r,o){if(e===t)return!0;if(i(e)&&i(t))return 0===n(e,t);if(a.isDate(e)&&a.isDate(t))return e.getTime()===t.getTime();if(a.isRegExp(e)&&a.isRegExp(t))return e.source===t.source&&e.global===t.global&&e.multiline===t.multiline&&e.lastIndex===t.lastIndex&&e.ignoreCase===t.ignoreCase;if(null!==e&&"object"==typeof e||null!==t&&"object"==typeof t){if(h(e)&&h(t)&&c(e)===c(t)&&!(e instanceof Float32Array||e instanceof Float64Array))return 0===n(new Uint8Array(e.buffer),new Uint8Array(t.buffer));if(i(e)!==i(t))return!1;var s=(o=o||{actual:[],expected:[]}).actual.indexOf(e);return-1!==s&&s===o.expected.indexOf(t)||(o.actual.push(e),o.expected.push(t),x(e,t,r,o))}return r?e===t:e==t}function _(e){return"[object Arguments]"==Object.prototype.toString.call(e)}function x(e,t,r,n){if(null==e||null==t)return!1;if(a.isPrimitive(e)||a.isPrimitive(t))return e===t;if(r&&Object.getPrototypeOf(e)!==Object.getPrototypeOf(t))return!1;var i=_(e),o=_(t);if(i&&!o||!i&&o)return!1;if(i)return b(e=s.call(e),t=s.call(t),r);var l,c,h=A(e),u=A(t);if(h.length!==u.length)return!1;for(h.sort(),u.sort(),c=h.length-1;c>=0;c--)if(h[c]!==u[c])return!1;for(c=h.length-1;c>=0;c--)if(!b(e[l=h[c]],t[l],r,n))return!1;return!0}function w(e,t,r){b(e,t,!0)&&y(e,t,r,"notDeepStrictEqual",w)}function S(e,t){if(!e||!t)return!1;if("[object RegExp]"==Object.prototype.toString.call(t))return t.test(e);try{if(e instanceof t)return!0}catch(e){}return!Error.isPrototypeOf(t)&&!0===t.call({},e)}function M(e){var t;try{e()}catch(e){t=e}return t}function T(e,t,r,n){var i;if("function"!=typeof t)throw new TypeError('"block" argument must be a function');"string"==typeof r&&(n=r,r=null),i=M(t),n=(r&&r.name?" ("+r.name+").":".")+(n?" "+n:"."),e&&!i&&y(i,r,"Missing expected exception"+n);var o="string"==typeof n,s=!e&&i&&!r;if((!e&&a.isError(i)&&o&&S(i,r)||s)&&y(i,r,"Got unwanted exception"+n),e&&i&&r&&!S(i,r)||!e&&i)throw i}u.AssertionError=function(e){this.name="AssertionError",this.actual=e.actual,this.expected=e.expected,this.operator=e.operator,e.message?(this.message=e.message,this.generatedMessage=!1):(this.message=g(this),this.generatedMessage=!0);var t=e.stackStartFunction||y;if(Error.captureStackTrace)Error.captureStackTrace(this,t);else{var r=new Error;if(r.stack){var n=r.stack,i=p(t),a=n.indexOf("\n"+i);if(a>=0){var o=n.indexOf("\n",a+1);n=n.substring(o+1)}this.stack=n}}},a.inherits(u.AssertionError,Error),u.fail=y,u.ok=v,u.equal=function(e,t,r){e!=t&&y(e,t,r,"==",u.equal)},u.notEqual=function(e,t,r){e==t&&y(e,t,r,"!=",u.notEqual)},u.deepEqual=function(e,t,r){b(e,t,!1)||y(e,t,r,"deepEqual",u.deepEqual)},u.deepStrictEqual=function(e,t,r){b(e,t,!0)||y(e,t,r,"deepStrictEqual",u.deepStrictEqual)},u.notDeepEqual=function(e,t,r){b(e,t,!1)&&y(e,t,r,"notDeepEqual",u.notDeepEqual)},u.notDeepStrictEqual=w,u.strictEqual=function(e,t,r){e!==t&&y(e,t,r,"===",u.strictEqual)},u.notStrictEqual=function(e,t,r){e===t&&y(e,t,r,"!==",u.notStrictEqual)},u.throws=function(e,t,r){T(!0,e,t,r)},u.doesNotThrow=function(e,t,r){T(!1,e,t,r)},u.ifError=function(e){if(e)throw e};var A=Object.keys||function(e){var t=[];for(var r in e)o.call(e,r)&&t.push(r);return t}}).call(this)}).call(this,void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"util/":26}],24:[function(e,t,r){"function"==typeof Object.create?t.exports=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:t.exports=function(e,t){e.super_=t;var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e}},{}],25:[function(e,t,r){t.exports=function(e){return e&&"object"==typeof e&&"function"==typeof e.copy&&"function"==typeof e.fill&&"function"==typeof e.readUInt8}},{}],26:[function(e,t,r){(function(t,n){(function(){var i=/%[sdj%]/g;r.format=function(e){if(!w(e)){for(var t=[],r=0;r<arguments.length;r++)t.push(s(arguments[r]));return t.join(" ")}r=1;for(var n=arguments,a=n.length,o=String(e).replace(i,(function(e){if("%%"===e)return"%";if(r>=a)return e;switch(e){case"%s":return String(n[r++]);case"%d":return Number(n[r++]);case"%j":try{return JSON.stringify(n[r++])}catch(e){return"[Circular]"}default:return e}})),l=n[r];r<a;l=n[++r])b(l)||!A(l)?o+=" "+l:o+=" "+s(l);return o},r.deprecate=function(e,i){if(M(n.process))return function(){return r.deprecate(e,i).apply(this,arguments)};if(!0===t.noDeprecation)return e;var a=!1;function o(){if(!a){if(t.throwDeprecation)throw new Error(i);t.traceDeprecation?console.trace(i):console.error(i),a=!0}return e.apply(this,arguments)}return o};var a,o={};function s(e,t){var n={seen:[],stylize:c};return arguments.length>=3&&(n.depth=arguments[2]),arguments.length>=4&&(n.colors=arguments[3]),v(t)?n.showHidden=t:t&&r._extend(n,t),M(n.showHidden)&&(n.showHidden=!1),M(n.depth)&&(n.depth=2),M(n.colors)&&(n.colors=!1),M(n.customInspect)&&(n.customInspect=!0),n.colors&&(n.stylize=l),u(n,e,n.depth)}function l(e,t){var r=s.styles[t];return r?"["+s.colors[r][0]+"m"+e+"["+s.colors[r][1]+"m":e}function c(e,t){return e}function h(e){var t={};return e.forEach((function(e,r){t[e]=!0})),t}function u(e,t,n){if(e.customInspect&&t&&L(t.inspect)&&t.inspect!==r.inspect&&(!t.constructor||t.constructor.prototype!==t)){var i=t.inspect(n,e);return w(i)||(i=u(e,i,n)),i}var a=d(e,t);if(a)return a;var o=Object.keys(t),s=h(o);if(e.showHidden&&(o=Object.getOwnPropertyNames(t)),C(t)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return p(t);if(0===o.length){if(L(t)){var l=t.name?": "+t.name:"";return e.stylize("[Function"+l+"]","special")}if(T(t))return e.stylize(RegExp.prototype.toString.call(t),"regexp");if(E(t))return e.stylize(Date.prototype.toString.call(t),"date");if(C(t))return p(t)}var c,v="",b=!1,_=["{","}"];return y(t)&&(b=!0,_=["[","]"]),L(t)&&(v=" [Function"+(t.name?": "+t.name:"")+"]"),T(t)&&(v=" "+RegExp.prototype.toString.call(t)),E(t)&&(v=" "+Date.prototype.toUTCString.call(t)),C(t)&&(v=" "+p(t)),0!==o.length||b&&0!=t.length?n<0?T(t)?e.stylize(RegExp.prototype.toString.call(t),"regexp"):e.stylize("[Object]","special"):(e.seen.push(t),c=b?f(e,t,n,s,o):o.map((function(r){return m(e,t,n,s,r,b)})),e.seen.pop(),g(c,v,_)):_[0]+v+_[1]}function d(e,t){if(M(t))return e.stylize("undefined","undefined");if(w(t)){var r="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(r,"string")}return x(t)?e.stylize(""+t,"number"):v(t)?e.stylize(""+t,"boolean"):b(t)?e.stylize("null","null"):void 0}function p(e){return"["+Error.prototype.toString.call(e)+"]"}function f(e,t,r,n,i){for(var a=[],o=0,s=t.length;o<s;++o)k(t,String(o))?a.push(m(e,t,r,n,String(o),!0)):a.push("");return i.forEach((function(i){i.match(/^\d+$/)||a.push(m(e,t,r,n,i,!0))})),a}function m(e,t,r,n,i,a){var o,s,l;if((l=Object.getOwnPropertyDescriptor(t,i)||{value:t[i]}).get?s=l.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):l.set&&(s=e.stylize("[Setter]","special")),k(n,i)||(o="["+i+"]"),s||(e.seen.indexOf(l.value)<0?(s=b(r)?u(e,l.value,null):u(e,l.value,r-1)).indexOf("\n")>-1&&(s=a?s.split("\n").map((function(e){return"  "+e})).join("\n").substr(2):"\n"+s.split("\n").map((function(e){return"   "+e})).join("\n")):s=e.stylize("[Circular]","special")),M(o)){if(a&&i.match(/^\d+$/))return s;(o=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(o=o.substr(1,o.length-2),o=e.stylize(o,"name")):(o=o.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),o=e.stylize(o,"string"))}return o+": "+s}function g(e,t,r){return e.reduce((function(e,t){return t.indexOf("\n"),e+t.replace(/\u001b\[\d\d?m/g,"").length+1}),0)>60?r[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+r[1]:r[0]+t+" "+e.join(", ")+" "+r[1]}function y(e){return Array.isArray(e)}function v(e){return"boolean"==typeof e}function b(e){return null===e}function _(e){return null==e}function x(e){return"number"==typeof e}function w(e){return"string"==typeof e}function S(e){return"symbol"==typeof e}function M(e){return void 0===e}function T(e){return A(e)&&"[object RegExp]"===R(e)}function A(e){return"object"==typeof e&&null!==e}function E(e){return A(e)&&"[object Date]"===R(e)}function C(e){return A(e)&&("[object Error]"===R(e)||e instanceof Error)}function L(e){return"function"==typeof e}function D(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e}function R(e){return Object.prototype.toString.call(e)}function P(e){return e<10?"0"+e.toString(10):e.toString(10)}r.debuglog=function(e){if(M(a)&&(a=t.env.NODE_DEBUG||""),e=e.toUpperCase(),!o[e])if(new RegExp("\\b"+e+"\\b","i").test(a)){var n=t.pid;o[e]=function(){var t=r.format.apply(r,arguments);console.error("%s %d: %s",e,n,t)}}else o[e]=function(){};return o[e]},r.inspect=s,s.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},s.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},r.isArray=y,r.isBoolean=v,r.isNull=b,r.isNullOrUndefined=_,r.isNumber=x,r.isString=w,r.isSymbol=S,r.isUndefined=M,r.isRegExp=T,r.isObject=A,r.isDate=E,r.isError=C,r.isFunction=L,r.isPrimitive=D,r.isBuffer=e("./support/isBuffer");var O=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function I(){var e=new Date,t=[P(e.getHours()),P(e.getMinutes()),P(e.getSeconds())].join(":");return[e.getDate(),O[e.getMonth()],t].join(" ")}function k(e,t){return Object.prototype.hasOwnProperty.call(e,t)}r.log=function(){console.log("%s - %s",I(),r.format.apply(r,arguments))},r.inherits=e("inherits"),r._extend=function(e,t){if(!t||!A(t))return e;for(var r=Object.keys(t),n=r.length;n--;)e[r[n]]=t[r[n]];return e}}).call(this)}).call(this,e("_process"),void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./support/isBuffer":25,_process:60,inherits:24}],27:[function(e,t,r){(function(r){(function(){var n=e("array-filter");t.exports=function(){return n(["BigInt64Array","BigUint64Array","Float32Array","Float64Array","Int16Array","Int32Array","Int8Array","Uint16Array","Uint32Array","Uint8Array","Uint8ClampedArray"],(function(e){return"function"==typeof r[e]}))}}).call(this)}).call(this,void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"array-filter":28}],28:[function(e,t,r){t.exports=function(e,t,r){if(e.filter)return e.filter(t,r);if(null==e)throw new TypeError;if("function"!=typeof t)throw new TypeError;for(var i=[],a=0;a<e.length;a++)if(n.call(e,a)){var o=e[a];t.call(r,o,a,e)&&i.push(o)}return i};var n=Object.prototype.hasOwnProperty},{}],29:[function(e,t,r){r.byteLength=h,r.toByteArray=d,r.fromByteArray=m;for(var n=[],i=[],a="undefined"!=typeof Uint8Array?Uint8Array:Array,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0,l=o.length;s<l;++s)n[s]=o[s],i[o.charCodeAt(s)]=s;function c(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function h(e){var t=c(e),r=t[0],n=t[1];return 3*(r+n)/4-n}function u(e,t,r){return 3*(t+r)/4-r}function d(e){var t,r,n=c(e),o=n[0],s=n[1],l=new a(u(e,o,s)),h=0,d=s>0?o-4:o;for(r=0;r<d;r+=4)t=i[e.charCodeAt(r)]<<18|i[e.charCodeAt(r+1)]<<12|i[e.charCodeAt(r+2)]<<6|i[e.charCodeAt(r+3)],l[h++]=t>>16&255,l[h++]=t>>8&255,l[h++]=255&t;return 2===s&&(t=i[e.charCodeAt(r)]<<2|i[e.charCodeAt(r+1)]>>4,l[h++]=255&t),1===s&&(t=i[e.charCodeAt(r)]<<10|i[e.charCodeAt(r+1)]<<4|i[e.charCodeAt(r+2)]>>2,l[h++]=t>>8&255,l[h++]=255&t),l}function p(e){return n[e>>18&63]+n[e>>12&63]+n[e>>6&63]+n[63&e]}function f(e,t,r){for(var n,i=[],a=t;a<r;a+=3)n=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),i.push(p(n));return i.join("")}function m(e){for(var t,r=e.length,i=r%3,a=[],o=16383,s=0,l=r-i;s<l;s+=o)a.push(f(e,s,s+o>l?l:s+o));return 1===i?(t=e[r-1],a.push(n[t>>2]+n[t<<4&63]+"==")):2===i&&(t=(e[r-2]<<8)+e[r-1],a.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"=")),a.join("")}i["-".charCodeAt(0)]=62,i["_".charCodeAt(0)]=63},{}],30:[function(e,t,r){},{}],31:[function(e,t,r){(function(t,n){(function(){var i=e("assert"),a=e("pako/lib/zlib/zstream"),o=e("pako/lib/zlib/deflate.js"),s=e("pako/lib/zlib/inflate.js"),l=e("pako/lib/zlib/constants");for(var c in l)r[c]=l[c];r.NONE=0,r.DEFLATE=1,r.INFLATE=2,r.GZIP=3,r.GUNZIP=4,r.DEFLATERAW=5,r.INFLATERAW=6,r.UNZIP=7;var h=31,u=139;function d(e){if("number"!=typeof e||e<r.DEFLATE||e>r.UNZIP)throw new TypeError("Bad argument");this.dictionary=null,this.err=0,this.flush=0,this.init_done=!1,this.level=0,this.memLevel=0,this.mode=e,this.strategy=0,this.windowBits=0,this.write_in_progress=!1,this.pending_close=!1,this.gzip_id_bytes_read=0}d.prototype.close=function(){this.write_in_progress?this.pending_close=!0:(this.pending_close=!1,i(this.init_done,"close before init"),i(this.mode<=r.UNZIP),this.mode===r.DEFLATE||this.mode===r.GZIP||this.mode===r.DEFLATERAW?o.deflateEnd(this.strm):this.mode!==r.INFLATE&&this.mode!==r.GUNZIP&&this.mode!==r.INFLATERAW&&this.mode!==r.UNZIP||s.inflateEnd(this.strm),this.mode=r.NONE,this.dictionary=null)},d.prototype.write=function(e,t,r,n,i,a,o){return this._write(!0,e,t,r,n,i,a,o)},d.prototype.writeSync=function(e,t,r,n,i,a,o){return this._write(!1,e,t,r,n,i,a,o)},d.prototype._write=function(e,a,o,s,l,c,h,u){if(i.equal(arguments.length,8),i(this.init_done,"write before init"),i(this.mode!==r.NONE,"already finalized"),i.equal(!1,this.write_in_progress,"write already in progress"),i.equal(!1,this.pending_close,"close is pending"),this.write_in_progress=!0,i.equal(!1,void 0===a,"must provide flush value"),this.write_in_progress=!0,a!==r.Z_NO_FLUSH&&a!==r.Z_PARTIAL_FLUSH&&a!==r.Z_SYNC_FLUSH&&a!==r.Z_FULL_FLUSH&&a!==r.Z_FINISH&&a!==r.Z_BLOCK)throw new Error("Invalid flush value");if(null==o&&(o=n.alloc(0),l=0,s=0),this.strm.avail_in=l,this.strm.input=o,this.strm.next_in=s,this.strm.avail_out=u,this.strm.output=c,this.strm.next_out=h,this.flush=a,!e)return this._process(),this._checkError()?this._afterSync():void 0;var d=this;return t.nextTick((function(){d._process(),d._after()})),this},d.prototype._afterSync=function(){var e=this.strm.avail_out,t=this.strm.avail_in;return this.write_in_progress=!1,[t,e]},d.prototype._process=function(){var e=null;switch(this.mode){case r.DEFLATE:case r.GZIP:case r.DEFLATERAW:this.err=o.deflate(this.strm,this.flush);break;case r.UNZIP:switch(this.strm.avail_in>0&&(e=this.strm.next_in),this.gzip_id_bytes_read){case 0:if(null===e)break;if(this.strm.input[e]!==h){this.mode=r.INFLATE;break}if(this.gzip_id_bytes_read=1,e++,1===this.strm.avail_in)break;case 1:if(null===e)break;this.strm.input[e]===u?(this.gzip_id_bytes_read=2,this.mode=r.GUNZIP):this.mode=r.INFLATE;break;default:throw new Error("invalid number of gzip magic number bytes read")}case r.INFLATE:case r.GUNZIP:case r.INFLATERAW:for(this.err=s.inflate(this.strm,this.flush),this.err===r.Z_NEED_DICT&&this.dictionary&&(this.err=s.inflateSetDictionary(this.strm,this.dictionary),this.err===r.Z_OK?this.err=s.inflate(this.strm,this.flush):this.err===r.Z_DATA_ERROR&&(this.err=r.Z_NEED_DICT));this.strm.avail_in>0&&this.mode===r.GUNZIP&&this.err===r.Z_STREAM_END&&0!==this.strm.next_in[0];)this.reset(),this.err=s.inflate(this.strm,this.flush);break;default:throw new Error("Unknown mode "+this.mode)}},d.prototype._checkError=function(){switch(this.err){case r.Z_OK:case r.Z_BUF_ERROR:if(0!==this.strm.avail_out&&this.flush===r.Z_FINISH)return this._error("unexpected end of file"),!1;break;case r.Z_STREAM_END:break;case r.Z_NEED_DICT:return null==this.dictionary?this._error("Missing dictionary"):this._error("Bad dictionary"),!1;default:return this._error("Zlib error"),!1}return!0},d.prototype._after=function(){if(this._checkError()){var e=this.strm.avail_out,t=this.strm.avail_in;this.write_in_progress=!1,this.callback(t,e),this.pending_close&&this.close()}},d.prototype._error=function(e){this.strm.msg&&(e=this.strm.msg),this.onerror(e,this.err),this.write_in_progress=!1,this.pending_close&&this.close()},d.prototype.init=function(e,t,n,a,o){i(4===arguments.length||5===arguments.length,"init(windowBits, level, memLevel, strategy, [dictionary])"),i(e>=8&&e<=15,"invalid windowBits"),i(t>=-1&&t<=9,"invalid compression level"),i(n>=1&&n<=9,"invalid memlevel"),i(a===r.Z_FILTERED||a===r.Z_HUFFMAN_ONLY||a===r.Z_RLE||a===r.Z_FIXED||a===r.Z_DEFAULT_STRATEGY,"invalid strategy"),this._init(t,e,n,a,o),this._setDictionary()},d.prototype.params=function(){throw new Error("deflateParams Not supported")},d.prototype.reset=function(){this._reset(),this._setDictionary()},d.prototype._init=function(e,t,n,i,l){switch(this.level=e,this.windowBits=t,this.memLevel=n,this.strategy=i,this.flush=r.Z_NO_FLUSH,this.err=r.Z_OK,this.mode!==r.GZIP&&this.mode!==r.GUNZIP||(this.windowBits+=16),this.mode===r.UNZIP&&(this.windowBits+=32),this.mode!==r.DEFLATERAW&&this.mode!==r.INFLATERAW||(this.windowBits=-1*this.windowBits),this.strm=new a,this.mode){case r.DEFLATE:case r.GZIP:case r.DEFLATERAW:this.err=o.deflateInit2(this.strm,this.level,r.Z_DEFLATED,this.windowBits,this.memLevel,this.strategy);break;case r.INFLATE:case r.GUNZIP:case r.INFLATERAW:case r.UNZIP:this.err=s.inflateInit2(this.strm,this.windowBits);break;default:throw new Error("Unknown mode "+this.mode)}this.err!==r.Z_OK&&this._error("Init error"),this.dictionary=l,this.write_in_progress=!1,this.init_done=!0},d.prototype._setDictionary=function(){if(null!=this.dictionary){switch(this.err=r.Z_OK,this.mode){case r.DEFLATE:case r.DEFLATERAW:this.err=o.deflateSetDictionary(this.strm,this.dictionary)}this.err!==r.Z_OK&&this._error("Failed to set dictionary")}},d.prototype._reset=function(){switch(this.err=r.Z_OK,this.mode){case r.DEFLATE:case r.DEFLATERAW:case r.GZIP:this.err=o.deflateReset(this.strm);break;case r.INFLATE:case r.INFLATERAW:case r.GUNZIP:this.err=s.inflateReset(this.strm)}this.err!==r.Z_OK&&this._error("Failed to reset stream")},r.Zlib=d}).call(this)}).call(this,e("_process"),e("buffer").Buffer)},{_process:60,assert:23,buffer:33,"pako/lib/zlib/constants":51,"pako/lib/zlib/deflate.js":53,"pako/lib/zlib/inflate.js":55,"pako/lib/zlib/zstream":59}],32:[function(e,t,r){(function(t){(function(){var n=e("buffer").Buffer,i=e("stream").Transform,a=e("./binding"),o=e("util"),s=e("assert").ok,l=e("buffer").kMaxLength,c="Cannot create final Buffer. It would be larger than 0x"+l.toString(16)+" bytes";a.Z_MIN_WINDOWBITS=8,a.Z_MAX_WINDOWBITS=15,a.Z_DEFAULT_WINDOWBITS=15,a.Z_MIN_CHUNK=64,a.Z_MAX_CHUNK=1/0,a.Z_DEFAULT_CHUNK=16384,a.Z_MIN_MEMLEVEL=1,a.Z_MAX_MEMLEVEL=9,a.Z_DEFAULT_MEMLEVEL=8,a.Z_MIN_LEVEL=-1,a.Z_MAX_LEVEL=9,a.Z_DEFAULT_LEVEL=a.Z_DEFAULT_COMPRESSION;for(var h=Object.keys(a),u=0;u<h.length;u++){var d=h[u];d.match(/^Z/)&&Object.defineProperty(r,d,{enumerable:!0,value:a[d],writable:!1})}for(var p={Z_OK:a.Z_OK,Z_STREAM_END:a.Z_STREAM_END,Z_NEED_DICT:a.Z_NEED_DICT,Z_ERRNO:a.Z_ERRNO,Z_STREAM_ERROR:a.Z_STREAM_ERROR,Z_DATA_ERROR:a.Z_DATA_ERROR,Z_MEM_ERROR:a.Z_MEM_ERROR,Z_BUF_ERROR:a.Z_BUF_ERROR,Z_VERSION_ERROR:a.Z_VERSION_ERROR},f=Object.keys(p),m=0;m<f.length;m++){var g=f[m];p[p[g]]=g}function y(e,t,r){var i=[],a=0;function o(){for(var t;null!==(t=e.read());)i.push(t),a+=t.length;e.once("readable",o)}function s(t){e.removeListener("end",h),e.removeListener("readable",o),r(t)}function h(){var t,o=null;a>=l?o=new RangeError(c):t=n.concat(i,a),i=[],e.close(),r(o,t)}e.on("error",s),e.on("end",h),e.end(t),o()}function v(e,t){if("string"==typeof t&&(t=n.from(t)),!n.isBuffer(t))throw new TypeError("Not a string or buffer");var r=e._finishFlushFlag;return e._processChunk(t,r)}function b(e){if(!(this instanceof b))return new b(e);E.call(this,e,a.DEFLATE)}function _(e){if(!(this instanceof _))return new _(e);E.call(this,e,a.INFLATE)}function x(e){if(!(this instanceof x))return new x(e);E.call(this,e,a.GZIP)}function w(e){if(!(this instanceof w))return new w(e);E.call(this,e,a.GUNZIP)}function S(e){if(!(this instanceof S))return new S(e);E.call(this,e,a.DEFLATERAW)}function M(e){if(!(this instanceof M))return new M(e);E.call(this,e,a.INFLATERAW)}function T(e){if(!(this instanceof T))return new T(e);E.call(this,e,a.UNZIP)}function A(e){return e===a.Z_NO_FLUSH||e===a.Z_PARTIAL_FLUSH||e===a.Z_SYNC_FLUSH||e===a.Z_FULL_FLUSH||e===a.Z_FINISH||e===a.Z_BLOCK}function E(e,t){var o=this;if(this._opts=e=e||{},this._chunkSize=e.chunkSize||r.Z_DEFAULT_CHUNK,i.call(this,e),e.flush&&!A(e.flush))throw new Error("Invalid flush flag: "+e.flush);if(e.finishFlush&&!A(e.finishFlush))throw new Error("Invalid flush flag: "+e.finishFlush);if(this._flushFlag=e.flush||a.Z_NO_FLUSH,this._finishFlushFlag=void 0!==e.finishFlush?e.finishFlush:a.Z_FINISH,e.chunkSize&&(e.chunkSize<r.Z_MIN_CHUNK||e.chunkSize>r.Z_MAX_CHUNK))throw new Error("Invalid chunk size: "+e.chunkSize);if(e.windowBits&&(e.windowBits<r.Z_MIN_WINDOWBITS||e.windowBits>r.Z_MAX_WINDOWBITS))throw new Error("Invalid windowBits: "+e.windowBits);if(e.level&&(e.level<r.Z_MIN_LEVEL||e.level>r.Z_MAX_LEVEL))throw new Error("Invalid compression level: "+e.level);if(e.memLevel&&(e.memLevel<r.Z_MIN_MEMLEVEL||e.memLevel>r.Z_MAX_MEMLEVEL))throw new Error("Invalid memLevel: "+e.memLevel);if(e.strategy&&e.strategy!=r.Z_FILTERED&&e.strategy!=r.Z_HUFFMAN_ONLY&&e.strategy!=r.Z_RLE&&e.strategy!=r.Z_FIXED&&e.strategy!=r.Z_DEFAULT_STRATEGY)throw new Error("Invalid strategy: "+e.strategy);if(e.dictionary&&!n.isBuffer(e.dictionary))throw new Error("Invalid dictionary: it should be a Buffer instance");this._handle=new a.Zlib(t);var s=this;this._hadError=!1,this._handle.onerror=function(e,t){C(s),s._hadError=!0;var n=new Error(e);n.errno=t,n.code=r.codes[t],s.emit("error",n)};var l=r.Z_DEFAULT_COMPRESSION;"number"==typeof e.level&&(l=e.level);var c=r.Z_DEFAULT_STRATEGY;"number"==typeof e.strategy&&(c=e.strategy),this._handle.init(e.windowBits||r.Z_DEFAULT_WINDOWBITS,l,e.memLevel||r.Z_DEFAULT_MEMLEVEL,c,e.dictionary),this._buffer=n.allocUnsafe(this._chunkSize),this._offset=0,this._level=l,this._strategy=c,this.once("end",this.close),Object.defineProperty(this,"_closed",{get:function(){return!o._handle},configurable:!0,enumerable:!0})}function C(e,r){r&&t.nextTick(r),e._handle&&(e._handle.close(),e._handle=null)}function L(e){e.emit("close")}Object.defineProperty(r,"codes",{enumerable:!0,value:Object.freeze(p),writable:!1}),r.Deflate=b,r.Inflate=_,r.Gzip=x,r.Gunzip=w,r.DeflateRaw=S,r.InflateRaw=M,r.Unzip=T,r.createDeflate=function(e){return new b(e)},r.createInflate=function(e){return new _(e)},r.createDeflateRaw=function(e){return new S(e)},r.createInflateRaw=function(e){return new M(e)},r.createGzip=function(e){return new x(e)},r.createGunzip=function(e){return new w(e)},r.createUnzip=function(e){return new T(e)},r.deflate=function(e,t,r){return"function"==typeof t&&(r=t,t={}),y(new b(t),e,r)},r.deflateSync=function(e,t){return v(new b(t),e)},r.gzip=function(e,t,r){return"function"==typeof t&&(r=t,t={}),y(new x(t),e,r)},r.gzipSync=function(e,t){return v(new x(t),e)},r.deflateRaw=function(e,t,r){return"function"==typeof t&&(r=t,t={}),y(new S(t),e,r)},r.deflateRawSync=function(e,t){return v(new S(t),e)},r.unzip=function(e,t,r){return"function"==typeof t&&(r=t,t={}),y(new T(t),e,r)},r.unzipSync=function(e,t){return v(new T(t),e)},r.inflate=function(e,t,r){return"function"==typeof t&&(r=t,t={}),y(new _(t),e,r)},r.inflateSync=function(e,t){return v(new _(t),e)},r.gunzip=function(e,t,r){return"function"==typeof t&&(r=t,t={}),y(new w(t),e,r)},r.gunzipSync=function(e,t){return v(new w(t),e)},r.inflateRaw=function(e,t,r){return"function"==typeof t&&(r=t,t={}),y(new M(t),e,r)},r.inflateRawSync=function(e,t){return v(new M(t),e)},o.inherits(E,i),E.prototype.params=function(e,n,i){if(e<r.Z_MIN_LEVEL||e>r.Z_MAX_LEVEL)throw new RangeError("Invalid compression level: "+e);if(n!=r.Z_FILTERED&&n!=r.Z_HUFFMAN_ONLY&&n!=r.Z_RLE&&n!=r.Z_FIXED&&n!=r.Z_DEFAULT_STRATEGY)throw new TypeError("Invalid strategy: "+n);if(this._level!==e||this._strategy!==n){var o=this;this.flush(a.Z_SYNC_FLUSH,(function(){s(o._handle,"zlib binding closed"),o._handle.params(e,n),o._hadError||(o._level=e,o._strategy=n,i&&i())}))}else t.nextTick(i)},E.prototype.reset=function(){return s(this._handle,"zlib binding closed"),this._handle.reset()},E.prototype._flush=function(e){this._transform(n.alloc(0),"",e)},E.prototype.flush=function(e,r){var i=this,o=this._writableState;("function"==typeof e||void 0===e&&!r)&&(r=e,e=a.Z_FULL_FLUSH),o.ended?r&&t.nextTick(r):o.ending?r&&this.once("end",r):o.needDrain?r&&this.once("drain",(function(){return i.flush(e,r)})):(this._flushFlag=e,this.write(n.alloc(0),"",r))},E.prototype.close=function(e){C(this,e),t.nextTick(L,this)},E.prototype._transform=function(e,t,r){var i,o=this._writableState,s=(o.ending||o.ended)&&(!e||o.length===e.length);return null===e||n.isBuffer(e)?this._handle?(s?i=this._finishFlushFlag:(i=this._flushFlag,e.length>=o.length&&(this._flushFlag=this._opts.flush||a.Z_NO_FLUSH)),void this._processChunk(e,i,r)):r(new Error("zlib binding closed")):r(new Error("invalid input"))},E.prototype._processChunk=function(e,t,r){var i=e&&e.length,a=this._chunkSize-this._offset,o=0,h=this,u="function"==typeof r;if(!u){var d,p=[],f=0;this.on("error",(function(e){d=e})),s(this._handle,"zlib binding closed");do{var m=this._handle.writeSync(t,e,o,i,this._buffer,this._offset,a)}while(!this._hadError&&v(m[0],m[1]));if(this._hadError)throw d;if(f>=l)throw C(this),new RangeError(c);var g=n.concat(p,f);return C(this),g}s(this._handle,"zlib binding closed");var y=this._handle.write(t,e,o,i,this._buffer,this._offset,a);function v(l,c){if(this&&(this.buffer=null,this.callback=null),!h._hadError){var d=a-c;if(s(d>=0,"have should not go down"),d>0){var m=h._buffer.slice(h._offset,h._offset+d);h._offset+=d,u?h.push(m):(p.push(m),f+=m.length)}if((0===c||h._offset>=h._chunkSize)&&(a=h._chunkSize,h._offset=0,h._buffer=n.allocUnsafe(h._chunkSize)),0===c){if(o+=i-l,i=l,!u)return!0;var g=h._handle.write(t,e,o,i,h._buffer,h._offset,h._chunkSize);return g.callback=v,void(g.buffer=e)}if(!u)return!1;r()}}y.buffer=e,y.callback=v},o.inherits(b,E),o.inherits(_,E),o.inherits(x,E),o.inherits(w,E),o.inherits(S,E),o.inherits(M,E),o.inherits(T,E)}).call(this)}).call(this,e("_process"))},{"./binding":31,_process:60,assert:23,buffer:33,stream:61,util:81}],33:[function(e,t,r){(function(t){(function(){var t=e("base64-js"),n=e("ieee754");r.Buffer=s,r.SlowBuffer=y,r.INSPECT_MAX_BYTES=50;var i=2147483647;function a(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()}catch(e){return!1}}function o(e){if(e>i)throw new RangeError('The value "'+e+'" is invalid for option "size"');var t=new Uint8Array(e);return t.__proto__=s.prototype,t}function s(e,t,r){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return u(e)}return l(e,t,r)}function l(e,t,r){if("string"==typeof e)return d(e,t);if(ArrayBuffer.isView(e))return p(e);if(null==e)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(q(e,ArrayBuffer)||e&&q(e.buffer,ArrayBuffer))return f(e,t,r);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');var n=e.valueOf&&e.valueOf();if(null!=n&&n!==e)return s.from(n,t,r);var i=m(e);if(i)return i;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return s.from(e[Symbol.toPrimitive]("string"),t,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function c(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function h(e,t,r){return c(e),e<=0?o(e):void 0!==t?"string"==typeof r?o(e).fill(t,r):o(e).fill(t):o(e)}function u(e){return c(e),o(e<0?0:0|g(e))}function d(e,t){if("string"==typeof t&&""!==t||(t="utf8"),!s.isEncoding(t))throw new TypeError("Unknown encoding: "+t);var r=0|v(e,t),n=o(r),i=n.write(e,t);return i!==r&&(n=n.slice(0,i)),n}function p(e){for(var t=e.length<0?0:0|g(e.length),r=o(t),n=0;n<t;n+=1)r[n]=255&e[n];return r}function f(e,t,r){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(r||0))throw new RangeError('"length" is outside of buffer bounds');var n;return(n=void 0===t&&void 0===r?new Uint8Array(e):void 0===r?new Uint8Array(e,t):new Uint8Array(e,t,r)).__proto__=s.prototype,n}function m(e){if(s.isBuffer(e)){var t=0|g(e.length),r=o(t);return 0===r.length||e.copy(r,0,0,t),r}return void 0!==e.length?"number"!=typeof e.length||J(e.length)?o(0):p(e):"Buffer"===e.type&&Array.isArray(e.data)?p(e.data):void 0}function g(e){if(e>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return 0|e}function y(e){return+e!=e&&(e=0),s.alloc(+e)}function v(e,t){if(s.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||q(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);var r=e.length,n=arguments.length>2&&!0===arguments[2];if(!n&&0===r)return 0;for(var i=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return W(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return $(e).length;default:if(i)return n?-1:W(e).length;t=(""+t).toLowerCase(),i=!0}}function b(e,t,r){var n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return k(this,t,r);case"utf8":case"utf-8":return D(this,t,r);case"ascii":return O(this,t,r);case"latin1":case"binary":return I(this,t,r);case"base64":return L(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return B(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function _(e,t,r){var n=e[t];e[t]=e[r],e[r]=n}function x(e,t,r,n,i){if(0===e.length)return-1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),J(r=+r)&&(r=i?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(i)return-1;r=e.length-1}else if(r<0){if(!i)return-1;r=0}if("string"==typeof t&&(t=s.from(t,n)),s.isBuffer(t))return 0===t.length?-1:w(e,t,r,n,i);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):w(e,[t],r,n,i);throw new TypeError("val must be string, number or Buffer")}function w(e,t,r,n,i){var a,o=1,s=e.length,l=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;o=2,s/=2,l/=2,r/=2}function c(e,t){return 1===o?e[t]:e.readUInt16BE(t*o)}if(i){var h=-1;for(a=r;a<s;a++)if(c(e,a)===c(t,-1===h?0:a-h)){if(-1===h&&(h=a),a-h+1===l)return h*o}else-1!==h&&(a-=a-h),h=-1}else for(r+l>s&&(r=s-l),a=r;a>=0;a--){for(var u=!0,d=0;d<l;d++)if(c(e,a+d)!==c(t,d)){u=!1;break}if(u)return a}return-1}function S(e,t,r,n){r=Number(r)||0;var i=e.length-r;n?(n=Number(n))>i&&(n=i):n=i;var a=t.length;n>a/2&&(n=a/2);for(var o=0;o<n;++o){var s=parseInt(t.substr(2*o,2),16);if(J(s))return o;e[r+o]=s}return o}function M(e,t,r,n){return Z(W(t,e.length-r),e,r,n)}function T(e,t,r,n){return Z(Y(t),e,r,n)}function A(e,t,r,n){return T(e,t,r,n)}function E(e,t,r,n){return Z($(t),e,r,n)}function C(e,t,r,n){return Z(X(t,e.length-r),e,r,n)}function L(e,r,n){return 0===r&&n===e.length?t.fromByteArray(e):t.fromByteArray(e.slice(r,n))}function D(e,t,r){r=Math.min(e.length,r);for(var n=[],i=t;i<r;){var a,o,s,l,c=e[i],h=null,u=c>239?4:c>223?3:c>191?2:1;if(i+u<=r)switch(u){case 1:c<128&&(h=c);break;case 2:128==(192&(a=e[i+1]))&&(l=(31&c)<<6|63&a)>127&&(h=l);break;case 3:a=e[i+1],o=e[i+2],128==(192&a)&&128==(192&o)&&(l=(15&c)<<12|(63&a)<<6|63&o)>2047&&(l<55296||l>57343)&&(h=l);break;case 4:a=e[i+1],o=e[i+2],s=e[i+3],128==(192&a)&&128==(192&o)&&128==(192&s)&&(l=(15&c)<<18|(63&a)<<12|(63&o)<<6|63&s)>65535&&l<1114112&&(h=l)}null===h?(h=65533,u=1):h>65535&&(h-=65536,n.push(h>>>10&1023|55296),h=56320|1023&h),n.push(h),i+=u}return P(n)}r.kMaxLength=i,s.TYPED_ARRAY_SUPPORT=a(),s.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(s.prototype,"parent",{enumerable:!0,get:function(){if(s.isBuffer(this))return this.buffer}}),Object.defineProperty(s.prototype,"offset",{enumerable:!0,get:function(){if(s.isBuffer(this))return this.byteOffset}}),"undefined"!=typeof Symbol&&null!=Symbol.species&&s[Symbol.species]===s&&Object.defineProperty(s,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),s.poolSize=8192,s.from=function(e,t,r){return l(e,t,r)},s.prototype.__proto__=Uint8Array.prototype,s.__proto__=Uint8Array,s.alloc=function(e,t,r){return h(e,t,r)},s.allocUnsafe=function(e){return u(e)},s.allocUnsafeSlow=function(e){return u(e)},s.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==s.prototype},s.compare=function(e,t){if(q(e,Uint8Array)&&(e=s.from(e,e.offset,e.byteLength)),q(t,Uint8Array)&&(t=s.from(t,t.offset,t.byteLength)),!s.isBuffer(e)||!s.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;for(var r=e.length,n=t.length,i=0,a=Math.min(r,n);i<a;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return r<n?-1:n<r?1:0},s.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},s.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return s.alloc(0);var r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;var n=s.allocUnsafe(t),i=0;for(r=0;r<e.length;++r){var a=e[r];if(q(a,Uint8Array)&&(a=s.from(a)),!s.isBuffer(a))throw new TypeError('"list" argument must be an Array of Buffers');a.copy(n,i),i+=a.length}return n},s.byteLength=v,s.prototype._isBuffer=!0,s.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)_(this,t,t+1);return this},s.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)_(this,t,t+3),_(this,t+1,t+2);return this},s.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)_(this,t,t+7),_(this,t+1,t+6),_(this,t+2,t+5),_(this,t+3,t+4);return this},s.prototype.toString=function(){var e=this.length;return 0===e?"":0===arguments.length?D(this,0,e):b.apply(this,arguments)},s.prototype.toLocaleString=s.prototype.toString,s.prototype.equals=function(e){if(!s.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===s.compare(this,e)},s.prototype.inspect=function(){var e="",t=r.INSPECT_MAX_BYTES;return e=this.toString("hex",0,t).replace(/(.{2})/g,"$1 ").trim(),this.length>t&&(e+=" ... "),"<Buffer "+e+">"},s.prototype.compare=function(e,t,r,n,i){if(q(e,Uint8Array)&&(e=s.from(e,e.offset,e.byteLength)),!s.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===i&&(i=this.length),t<0||r>e.length||n<0||i>this.length)throw new RangeError("out of range index");if(n>=i&&t>=r)return 0;if(n>=i)return-1;if(t>=r)return 1;if(this===e)return 0;for(var a=(i>>>=0)-(n>>>=0),o=(r>>>=0)-(t>>>=0),l=Math.min(a,o),c=this.slice(n,i),h=e.slice(t,r),u=0;u<l;++u)if(c[u]!==h[u]){a=c[u],o=h[u];break}return a<o?-1:o<a?1:0},s.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},s.prototype.indexOf=function(e,t,r){return x(this,e,t,r,!0)},s.prototype.lastIndexOf=function(e,t,r){return x(this,e,t,r,!1)},s.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(r)?(r>>>=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}var i=this.length-t;if((void 0===r||r>i)&&(r=i),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var a=!1;;)switch(n){case"hex":return S(this,e,t,r);case"utf8":case"utf-8":return M(this,e,t,r);case"ascii":return T(this,e,t,r);case"latin1":case"binary":return A(this,e,t,r);case"base64":return E(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C(this,e,t,r);default:if(a)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),a=!0}},s.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var R=4096;function P(e){var t=e.length;if(t<=R)return String.fromCharCode.apply(String,e);for(var r="",n=0;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=R));return r}function O(e,t,r){var n="";r=Math.min(e.length,r);for(var i=t;i<r;++i)n+=String.fromCharCode(127&e[i]);return n}function I(e,t,r){var n="";r=Math.min(e.length,r);for(var i=t;i<r;++i)n+=String.fromCharCode(e[i]);return n}function k(e,t,r){var n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);for(var i="",a=t;a<r;++a)i+=j(e[a]);return i}function B(e,t,r){for(var n=e.slice(t,r),i="",a=0;a<n.length;a+=2)i+=String.fromCharCode(n[a]+256*n[a+1]);return i}function N(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function F(e,t,r,n,i,a){if(!s.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<a)throw new RangeError('"value" argument is out of bounds');if(r+n>e.length)throw new RangeError("Index out of range")}function U(e,t,r,n,i,a){if(r+n>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function z(e,t,r,i,a){return t=+t,r>>>=0,a||U(e,t,r,4),n.write(e,t,r,i,23,4),r+4}function H(e,t,r,i,a){return t=+t,r>>>=0,a||U(e,t,r,8),n.write(e,t,r,i,52,8),r+8}s.prototype.slice=function(e,t){var r=this.length;(e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e);var n=this.subarray(e,t);return n.__proto__=s.prototype,n},s.prototype.readUIntLE=function(e,t,r){e>>>=0,t>>>=0,r||N(e,t,this.length);for(var n=this[e],i=1,a=0;++a<t&&(i*=256);)n+=this[e+a]*i;return n},s.prototype.readUIntBE=function(e,t,r){e>>>=0,t>>>=0,r||N(e,t,this.length);for(var n=this[e+--t],i=1;t>0&&(i*=256);)n+=this[e+--t]*i;return n},s.prototype.readUInt8=function(e,t){return e>>>=0,t||N(e,1,this.length),this[e]},s.prototype.readUInt16LE=function(e,t){return e>>>=0,t||N(e,2,this.length),this[e]|this[e+1]<<8},s.prototype.readUInt16BE=function(e,t){return e>>>=0,t||N(e,2,this.length),this[e]<<8|this[e+1]},s.prototype.readUInt32LE=function(e,t){return e>>>=0,t||N(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},s.prototype.readUInt32BE=function(e,t){return e>>>=0,t||N(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},s.prototype.readIntLE=function(e,t,r){e>>>=0,t>>>=0,r||N(e,t,this.length);for(var n=this[e],i=1,a=0;++a<t&&(i*=256);)n+=this[e+a]*i;return n>=(i*=128)&&(n-=Math.pow(2,8*t)),n},s.prototype.readIntBE=function(e,t,r){e>>>=0,t>>>=0,r||N(e,t,this.length);for(var n=t,i=1,a=this[e+--n];n>0&&(i*=256);)a+=this[e+--n]*i;return a>=(i*=128)&&(a-=Math.pow(2,8*t)),a},s.prototype.readInt8=function(e,t){return e>>>=0,t||N(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},s.prototype.readInt16LE=function(e,t){e>>>=0,t||N(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},s.prototype.readInt16BE=function(e,t){e>>>=0,t||N(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},s.prototype.readInt32LE=function(e,t){return e>>>=0,t||N(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},s.prototype.readInt32BE=function(e,t){return e>>>=0,t||N(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},s.prototype.readFloatLE=function(e,t){return e>>>=0,t||N(e,4,this.length),n.read(this,e,!0,23,4)},s.prototype.readFloatBE=function(e,t){return e>>>=0,t||N(e,4,this.length),n.read(this,e,!1,23,4)},s.prototype.readDoubleLE=function(e,t){return e>>>=0,t||N(e,8,this.length),n.read(this,e,!0,52,8)},s.prototype.readDoubleBE=function(e,t){return e>>>=0,t||N(e,8,this.length),n.read(this,e,!1,52,8)},s.prototype.writeUIntLE=function(e,t,r,n){e=+e,t>>>=0,r>>>=0,n||F(this,e,t,r,Math.pow(2,8*r)-1,0);var i=1,a=0;for(this[t]=255&e;++a<r&&(i*=256);)this[t+a]=e/i&255;return t+r},s.prototype.writeUIntBE=function(e,t,r,n){e=+e,t>>>=0,r>>>=0,n||F(this,e,t,r,Math.pow(2,8*r)-1,0);var i=r-1,a=1;for(this[t+i]=255&e;--i>=0&&(a*=256);)this[t+i]=e/a&255;return t+r},s.prototype.writeUInt8=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,1,255,0),this[t]=255&e,t+1},s.prototype.writeUInt16LE=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},s.prototype.writeUInt16BE=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},s.prototype.writeUInt32LE=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},s.prototype.writeUInt32BE=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},s.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t>>>=0,!n){var i=Math.pow(2,8*r-1);F(this,e,t,r,i-1,-i)}var a=0,o=1,s=0;for(this[t]=255&e;++a<r&&(o*=256);)e<0&&0===s&&0!==this[t+a-1]&&(s=1),this[t+a]=(e/o>>0)-s&255;return t+r},s.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t>>>=0,!n){var i=Math.pow(2,8*r-1);F(this,e,t,r,i-1,-i)}var a=r-1,o=1,s=0;for(this[t+a]=255&e;--a>=0&&(o*=256);)e<0&&0===s&&0!==this[t+a+1]&&(s=1),this[t+a]=(e/o>>0)-s&255;return t+r},s.prototype.writeInt8=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},s.prototype.writeInt16LE=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},s.prototype.writeInt16BE=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},s.prototype.writeInt32LE=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},s.prototype.writeInt32BE=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},s.prototype.writeFloatLE=function(e,t,r){return z(this,e,t,!0,r)},s.prototype.writeFloatBE=function(e,t,r){return z(this,e,t,!1,r)},s.prototype.writeDoubleLE=function(e,t,r){return H(this,e,t,!0,r)},s.prototype.writeDoubleBE=function(e,t,r){return H(this,e,t,!1,r)},s.prototype.copy=function(e,t,r,n){if(!s.isBuffer(e))throw new TypeError("argument should be a Buffer");if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);var i=n-r;if(this===e&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(t,r,n);else if(this===e&&r<t&&t<n)for(var a=i-1;a>=0;--a)e[a+t]=this[a+r];else Uint8Array.prototype.set.call(e,this.subarray(r,n),t);return i},s.prototype.fill=function(e,t,r,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!s.isEncoding(n))throw new TypeError("Unknown encoding: "+n);if(1===e.length){var i=e.charCodeAt(0);("utf8"===n&&i<128||"latin1"===n)&&(e=i)}}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;var a;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(a=t;a<r;++a)this[a]=e;else{var o=s.isBuffer(e)?e:s.from(e,n),l=o.length;if(0===l)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(a=0;a<r-t;++a)this[a+t]=o[a%l]}return this};var G=/[^+/0-9A-Za-z-_]/g;function V(e){if((e=(e=e.split("=")[0]).trim().replace(G,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}function j(e){return e<16?"0"+e.toString(16):e.toString(16)}function W(e,t){var r;t=t||1/0;for(var n=e.length,i=null,a=[],o=0;o<n;++o){if((r=e.charCodeAt(o))>55295&&r<57344){if(!i){if(r>56319){(t-=3)>-1&&a.push(239,191,189);continue}if(o+1===n){(t-=3)>-1&&a.push(239,191,189);continue}i=r;continue}if(r<56320){(t-=3)>-1&&a.push(239,191,189),i=r;continue}r=65536+(i-55296<<10|r-56320)}else i&&(t-=3)>-1&&a.push(239,191,189);if(i=null,r<128){if((t-=1)<0)break;a.push(r)}else if(r<2048){if((t-=2)<0)break;a.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;a.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;a.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return a}function Y(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}function X(e,t){for(var r,n,i,a=[],o=0;o<e.length&&!((t-=2)<0);++o)n=(r=e.charCodeAt(o))>>8,i=r%256,a.push(i),a.push(n);return a}function $(e){return t.toByteArray(V(e))}function Z(e,t,r,n){for(var i=0;i<n&&!(i+r>=t.length||i>=e.length);++i)t[i+r]=e[i];return i}function q(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function J(e){return e!=e}}).call(this)}).call(this,e("buffer").Buffer)},{"base64-js":29,buffer:33,ieee754:44}],34:[function(e,t,r){var n,i=TypeError,a=Object.getOwnPropertyDescriptor;if(a)try{a({},"")}catch(e){a=null}var o=function(){throw new i},s=a?function(){try{return o}catch(e){try{return a(arguments,"callee").get}catch(e){return o}}}():o,l=e("has-symbols")(),c=Object.getPrototypeOf||function(e){return e.__proto__},h=n,u=n,d=n,p="undefined"==typeof Uint8Array?n:c(Uint8Array),f={"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?n:ArrayBuffer,"%ArrayBufferPrototype%":"undefined"==typeof ArrayBuffer?n:ArrayBuffer.prototype,"%ArrayIteratorPrototype%":l?c([][Symbol.iterator]()):n,"%ArrayPrototype%":Array.prototype,"%ArrayProto_entries%":Array.prototype.entries,"%ArrayProto_forEach%":Array.prototype.forEach,"%ArrayProto_keys%":Array.prototype.keys,"%ArrayProto_values%":Array.prototype.values,"%AsyncFromSyncIteratorPrototype%":n,"%AsyncFunction%":u,"%AsyncFunctionPrototype%":n,"%AsyncGenerator%":n,"%AsyncGeneratorFunction%":d,"%AsyncGeneratorPrototype%":n,"%AsyncIteratorPrototype%":n,"%Atomics%":"undefined"==typeof Atomics?n:Atomics,"%Boolean%":Boolean,"%BooleanPrototype%":Boolean.prototype,"%DataView%":"undefined"==typeof DataView?n:DataView,"%DataViewPrototype%":"undefined"==typeof DataView?n:DataView.prototype,"%Date%":Date,"%DatePrototype%":Date.prototype,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":Error,"%ErrorPrototype%":Error.prototype,"%eval%":eval,"%EvalError%":EvalError,"%EvalErrorPrototype%":EvalError.prototype,"%Float32Array%":"undefined"==typeof Float32Array?n:Float32Array,"%Float32ArrayPrototype%":"undefined"==typeof Float32Array?n:Float32Array.prototype,"%Float64Array%":"undefined"==typeof Float64Array?n:Float64Array,"%Float64ArrayPrototype%":"undefined"==typeof Float64Array?n:Float64Array.prototype,"%Function%":Function,"%FunctionPrototype%":Function.prototype,"%Generator%":n,"%GeneratorFunction%":h,"%GeneratorPrototype%":n,"%Int8Array%":"undefined"==typeof Int8Array?n:Int8Array,"%Int8ArrayPrototype%":"undefined"==typeof Int8Array?n:Int8Array.prototype,"%Int16Array%":"undefined"==typeof Int16Array?n:Int16Array,"%Int16ArrayPrototype%":"undefined"==typeof Int16Array?n:Int8Array.prototype,"%Int32Array%":"undefined"==typeof Int32Array?n:Int32Array,"%Int32ArrayPrototype%":"undefined"==typeof Int32Array?n:Int32Array.prototype,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":l?c(c([][Symbol.iterator]())):n,"%JSON%":"object"==typeof JSON?JSON:n,"%JSONParse%":"object"==typeof JSON?JSON.parse:n,"%Map%":"undefined"==typeof Map?n:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&l?c((new Map)[Symbol.iterator]()):n,"%MapPrototype%":"undefined"==typeof Map?n:Map.prototype,"%Math%":Math,"%Number%":Number,"%NumberPrototype%":Number.prototype,"%Object%":Object,"%ObjectPrototype%":Object.prototype,"%ObjProto_toString%":Object.prototype.toString,"%ObjProto_valueOf%":Object.prototype.valueOf,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?n:Promise,"%PromisePrototype%":"undefined"==typeof Promise?n:Promise.prototype,"%PromiseProto_then%":"undefined"==typeof Promise?n:Promise.prototype.then,"%Promise_all%":"undefined"==typeof Promise?n:Promise.all,"%Promise_reject%":"undefined"==typeof Promise?n:Promise.reject,"%Promise_resolve%":"undefined"==typeof Promise?n:Promise.resolve,"%Proxy%":"undefined"==typeof Proxy?n:Proxy,"%RangeError%":RangeError,"%RangeErrorPrototype%":RangeError.prototype,"%ReferenceError%":ReferenceError,"%ReferenceErrorPrototype%":ReferenceError.prototype,"%Reflect%":"undefined"==typeof Reflect?n:Reflect,"%RegExp%":RegExp,"%RegExpPrototype%":RegExp.prototype,"%Set%":"undefined"==typeof Set?n:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&l?c((new Set)[Symbol.iterator]()):n,"%SetPrototype%":"undefined"==typeof Set?n:Set.prototype,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?n:SharedArrayBuffer,"%SharedArrayBufferPrototype%":"undefined"==typeof SharedArrayBuffer?n:SharedArrayBuffer.prototype,"%String%":String,"%StringIteratorPrototype%":l?c(""[Symbol.iterator]()):n,"%StringPrototype%":String.prototype,"%Symbol%":l?Symbol:n,"%SymbolPrototype%":l?Symbol.prototype:n,"%SyntaxError%":SyntaxError,"%SyntaxErrorPrototype%":SyntaxError.prototype,"%ThrowTypeError%":s,"%TypedArray%":p,"%TypedArrayPrototype%":p?p.prototype:n,"%TypeError%":i,"%TypeErrorPrototype%":i.prototype,"%Uint8Array%":"undefined"==typeof Uint8Array?n:Uint8Array,"%Uint8ArrayPrototype%":"undefined"==typeof Uint8Array?n:Uint8Array.prototype,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?n:Uint8ClampedArray,"%Uint8ClampedArrayPrototype%":"undefined"==typeof Uint8ClampedArray?n:Uint8ClampedArray.prototype,"%Uint16Array%":"undefined"==typeof Uint16Array?n:Uint16Array,"%Uint16ArrayPrototype%":"undefined"==typeof Uint16Array?n:Uint16Array.prototype,"%Uint32Array%":"undefined"==typeof Uint32Array?n:Uint32Array,"%Uint32ArrayPrototype%":"undefined"==typeof Uint32Array?n:Uint32Array.prototype,"%URIError%":URIError,"%URIErrorPrototype%":URIError.prototype,"%WeakMap%":"undefined"==typeof WeakMap?n:WeakMap,"%WeakMapPrototype%":"undefined"==typeof WeakMap?n:WeakMap.prototype,"%WeakSet%":"undefined"==typeof WeakSet?n:WeakSet,"%WeakSetPrototype%":"undefined"==typeof WeakSet?n:WeakSet.prototype},m=e("function-bind").call(Function.call,String.prototype.replace),g=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,y=/\\(\\)?/g,v=function(e){var t=[];return m(e,g,(function(e,r,n,i){t[t.length]=n?m(i,y,"$1"):r||e})),t},b=function(e,t){if(!(e in f))throw new SyntaxError("intrinsic "+e+" does not exist!");if(void 0===f[e]&&!t)throw new i("intrinsic "+e+" exists, but is not available. Please file an issue!");return f[e]};t.exports=function(e,t){if("string"!=typeof e||0===e.length)throw new TypeError("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof t)throw new TypeError('"allowMissing" argument must be a boolean');for(var r=v(e),n=b("%"+(r.length>0?r[0]:"")+"%",t),o=1;o<r.length;o+=1)if(null!=n)if(a&&o+1>=r.length){var s=a(n,r[o]);if(!t&&!(r[o]in n))throw new i("base intrinsic for "+e+" exists, but the property is not available.");n=s?s.get||s.value:n[r[o]]}else n=n[r[o]];return n}},{"function-bind":41,"has-symbols":42}],35:[function(e,t,r){var n=e("function-bind"),i=e("../GetIntrinsic")("%Function%"),a=i.apply,o=i.call;t.exports=function(){return n.apply(o,arguments)},t.exports.apply=function(){return n.apply(a,arguments)}},{"../GetIntrinsic":34,"function-bind":41}],36:[function(e,t,r){var n=e("../GetIntrinsic"),i=e("./callBind"),a=i(n("String.prototype.indexOf"));t.exports=function(e,t){var r=n(e,!!t);return"function"==typeof r&&a(e,".prototype.")?i(r):r}},{"../GetIntrinsic":34,"./callBind":35}],37:[function(e,t,r){var n=e("../GetIntrinsic")("%Object.getOwnPropertyDescriptor%");if(n)try{n([],"length")}catch(e){n=null}t.exports=n},{"../GetIntrinsic":34}],38:[function(e,t,r){var n,i="object"==typeof Reflect?Reflect:null,a=i&&"function"==typeof i.apply?i.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)};function o(e){console&&console.warn&&console.warn(e)}n=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function l(){l.init.call(this)}t.exports=l,t.exports.once=_,l.EventEmitter=l,l.prototype._events=void 0,l.prototype._eventsCount=0,l.prototype._maxListeners=void 0;var c=10;function h(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function u(e){return void 0===e._maxListeners?l.defaultMaxListeners:e._maxListeners}function d(e,t,r,n){var i,a,s;if(h(r),void 0===(a=e._events)?(a=e._events=Object.create(null),e._eventsCount=0):(void 0!==a.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),a=e._events),s=a[t]),void 0===s)s=a[t]=r,++e._eventsCount;else if("function"==typeof s?s=a[t]=n?[r,s]:[s,r]:n?s.unshift(r):s.push(r),(i=u(e))>0&&s.length>i&&!s.warned){s.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=s.length,o(l)}return e}function p(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function f(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=p.bind(n);return i.listener=r,n.wrapFn=i,i}function m(e,t,r){var n=e._events;if(void 0===n)return[];var i=n[t];return void 0===i?[]:"function"==typeof i?r?[i.listener||i]:[i]:r?b(i):y(i,i.length)}function g(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function y(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}function v(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function b(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}function _(e,t){return new Promise((function(r,n){function i(){void 0!==a&&e.removeListener("error",a),r([].slice.call(arguments))}var a;"error"!==t&&(a=function(r){e.removeListener(t,i),n(r)},e.once("error",a)),e.once(t,i)}))}Object.defineProperty(l,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");c=e}}),l.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},l.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},l.prototype.getMaxListeners=function(){return u(this)},l.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var n="error"===e,i=this._events;if(void 0!==i)n=n&&void 0===i.error;else if(!n)return!1;if(n){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var s=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw s.context=o,s}var l=i[e];if(void 0===l)return!1;if("function"==typeof l)a(l,this,t);else{var c=l.length,h=y(l,c);for(r=0;r<c;++r)a(h[r],this,t)}return!0},l.prototype.addListener=function(e,t){return d(this,e,t,!1)},l.prototype.on=l.prototype.addListener,l.prototype.prependListener=function(e,t){return d(this,e,t,!0)},l.prototype.once=function(e,t){return h(t),this.on(e,f(this,e,t)),this},l.prototype.prependOnceListener=function(e,t){return h(t),this.prependListener(e,f(this,e,t)),this},l.prototype.removeListener=function(e,t){var r,n,i,a,o;if(h(t),void 0===(n=this._events))return this;if(void 0===(r=n[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(i=-1,a=r.length-1;a>=0;a--)if(r[a]===t||r[a].listener===t){o=r[a].listener,i=a;break}if(i<0)return this;0===i?r.shift():v(r,i),1===r.length&&(n[e]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",e,o||t)}return this},l.prototype.off=l.prototype.removeListener,l.prototype.removeAllListeners=function(e){var t,r,n;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0===arguments.length){var i,a=Object.keys(r);for(n=0;n<a.length;++n)"removeListener"!==(i=a[n])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},l.prototype.listeners=function(e){return m(this,e,!0)},l.prototype.rawListeners=function(e){return m(this,e,!1)},l.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):g.call(e,t)},l.prototype.listenerCount=g,l.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]}},{}],39:[function(e,t,r){var n=Object.prototype.hasOwnProperty,i=Object.prototype.toString;t.exports=function(e,t,r){if("[object Function]"!==i.call(t))throw new TypeError("iterator must be a function");var a=e.length;if(a===+a)for(var o=0;o<a;o++)t.call(r,e[o],o,e);else for(var s in e)n.call(e,s)&&t.call(r,e[s],s,e)}},{}],40:[function(e,t,r){var n="Function.prototype.bind called on incompatible ",i=Array.prototype.slice,a=Object.prototype.toString,o="[object Function]";t.exports=function(e){var t=this;if("function"!=typeof t||a.call(t)!==o)throw new TypeError(n+t);for(var r,s=i.call(arguments,1),l=function(){if(this instanceof r){var n=t.apply(this,s.concat(i.call(arguments)));return Object(n)===n?n:this}return t.apply(e,s.concat(i.call(arguments)))},c=Math.max(0,t.length-s.length),h=[],u=0;u<c;u++)h.push("$"+u);if(r=Function("binder","return function ("+h.join(",")+"){ return binder.apply(this,arguments); }")(l),t.prototype){var d=function(){};d.prototype=t.prototype,r.prototype=new d,d.prototype=null}return r}},{}],41:[function(e,t,r){var n=e("./implementation");t.exports=Function.prototype.bind||n},{"./implementation":40}],42:[function(e,t,r){(function(r){(function(){var n=r.Symbol,i=e("./shams");t.exports=function(){return"function"==typeof n&&"function"==typeof Symbol&&"symbol"==typeof n("foo")&&"symbol"==typeof Symbol("bar")&&i()}}).call(this)}).call(this,void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./shams":43}],43:[function(e,t,r){t.exports=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),r=Object(t);if("string"==typeof t)return!1;if("[object Symbol]"!==Object.prototype.toString.call(t))return!1;if("[object Symbol]"!==Object.prototype.toString.call(r))return!1;var n=42;for(t in e[t]=n,e)return!1;if("function"==typeof Object.keys&&0!==Object.keys(e).length)return!1;if("function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var i=Object.getOwnPropertySymbols(e);if(1!==i.length||i[0]!==t)return!1;if(!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var a=Object.getOwnPropertyDescriptor(e,t);if(a.value!==n||!0!==a.enumerable)return!1}return!0}},{}],44:[function(e,t,r){r.read=function(e,t,r,n,i){var a,o,s=8*i-n-1,l=(1<<s)-1,c=l>>1,h=-7,u=r?i-1:0,d=r?-1:1,p=e[t+u];for(u+=d,a=p&(1<<-h)-1,p>>=-h,h+=s;h>0;a=256*a+e[t+u],u+=d,h-=8);for(o=a&(1<<-h)-1,a>>=-h,h+=n;h>0;o=256*o+e[t+u],u+=d,h-=8);if(0===a)a=1-c;else{if(a===l)return o?NaN:1/0*(p?-1:1);o+=Math.pow(2,n),a-=c}return(p?-1:1)*o*Math.pow(2,a-n)},r.write=function(e,t,r,n,i,a){var o,s,l,c=8*a-i-1,h=(1<<c)-1,u=h>>1,d=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,p=n?0:a-1,f=n?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(s=isNaN(t)?1:0,o=h):(o=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-o))<1&&(o--,l*=2),(t+=o+u>=1?d/l:d*Math.pow(2,1-u))*l>=2&&(o++,l/=2),o+u>=h?(s=0,o=h):o+u>=1?(s=(t*l-1)*Math.pow(2,i),o+=u):(s=t*Math.pow(2,u-1)*Math.pow(2,i),o=0));i>=8;e[r+p]=255&s,p+=f,s/=256,i-=8);for(o=o<<i|s,c+=i;c>0;e[r+p]=255&o,p+=f,o/=256,c-=8);e[r+p-f]|=128*m}},{}],45:[function(e,t,r){"function"==typeof Object.create?t.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:t.exports=function(e,t){if(t){e.super_=t;var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e}}},{}],46:[function(e,t,r){var n="function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag,i=Object.prototype.toString,a=function(e){return!(n&&e&&"object"==typeof e&&Symbol.toStringTag in e)&&"[object Arguments]"===i.call(e)},o=function(e){return!!a(e)||null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Array]"!==i.call(e)&&"[object Function]"===i.call(e.callee)},s=function(){return a(arguments)}();a.isLegacyArguments=o,t.exports=s?a:o},{}],47:[function(e,t,r){var n=Object.prototype.toString,i=Function.prototype.toString,a=/^\s*(?:function)?\*/,o="function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag,s=Object.getPrototypeOf,l=function(){if(!o)return!1;try{return Function("return function*() {}")()}catch(e){}}(),c=l?s(l):{};t.exports=function(e){return"function"==typeof e&&(!!a.test(i.call(e))||(o?s(e)===c:"[object GeneratorFunction]"===n.call(e)))}},{}],48:[function(e,t,r){(function(r){(function(){var n=e("foreach"),i=e("available-typed-arrays"),a=e("es-abstract/helpers/callBound"),o=a("Object.prototype.toString"),s=e("has-symbols")()&&"symbol"==typeof Symbol.toStringTag,l=i(),c=a("Array.prototype.indexOf",!0)||function(e,t){for(var r=0;r<e.length;r+=1)if(e[r]===t)return r;return-1},h=a("String.prototype.slice"),u={},d=e("es-abstract/helpers/getOwnPropertyDescriptor"),p=Object.getPrototypeOf;s&&d&&p&&n(l,(function(e){var t=new r[e];if(!(Symbol.toStringTag in t))throw new EvalError("this engine has support for Symbol.toStringTag, but "+e+" does not have the property! Please report this.");var n=p(t),i=d(n,Symbol.toStringTag);if(!i){var a=p(n);i=d(a,Symbol.toStringTag)}u[e]=i.get}));var f=function(e){var t=!1;return n(u,(function(r,n){if(!t)try{t=r.call(e)===n}catch(e){}})),t};t.exports=function(e){if(!e||"object"!=typeof e)return!1;if(!s){var t=h(o(e),8,-1);return c(l,t)>-1}return!!d&&f(e)}}).call(this)}).call(this,void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"available-typed-arrays":27,"es-abstract/helpers/callBound":36,"es-abstract/helpers/getOwnPropertyDescriptor":37,foreach:39,"has-symbols":42}],49:[function(e,t,r){var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function i(e,t){return Object.prototype.hasOwnProperty.call(e,t)}r.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var r=t.shift();if(r){if("object"!=typeof r)throw new TypeError(r+"must be non-object");for(var n in r)i(r,n)&&(e[n]=r[n])}}return e},r.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var a={arraySet:function(e,t,r,n,i){if(t.subarray&&e.subarray)e.set(t.subarray(r,r+n),i);else for(var a=0;a<n;a++)e[i+a]=t[r+a]},flattenChunks:function(e){var t,r,n,i,a,o;for(n=0,t=0,r=e.length;t<r;t++)n+=e[t].length;for(o=new Uint8Array(n),i=0,t=0,r=e.length;t<r;t++)a=e[t],o.set(a,i),i+=a.length;return o}},o={arraySet:function(e,t,r,n,i){for(var a=0;a<n;a++)e[i+a]=t[r+a]},flattenChunks:function(e){return[].concat.apply([],e)}};r.setTyped=function(e){e?(r.Buf8=Uint8Array,r.Buf16=Uint16Array,r.Buf32=Int32Array,r.assign(r,a)):(r.Buf8=Array,r.Buf16=Array,r.Buf32=Array,r.assign(r,o))},r.setTyped(n)},{}],50:[function(e,t,r){function n(e,t,r,n){for(var i=65535&e|0,a=e>>>16&65535|0,o=0;0!==r;){r-=o=r>2e3?2e3:r;do{a=a+(i=i+t[n++]|0)|0}while(--o);i%=65521,a%=65521}return i|a<<16|0}t.exports=n},{}],51:[function(e,t,r){t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],52:[function(e,t,r){function n(){for(var e,t=[],r=0;r<256;r++){e=r;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[r]=e}return t}var i=n();function a(e,t,r,n){var a=i,o=n+r;e^=-1;for(var s=n;s<o;s++)e=e>>>8^a[255&(e^t[s])];return-1^e}t.exports=a},{}],53:[function(e,t,r){var n,i=e("../utils/common"),a=e("./trees"),o=e("./adler32"),s=e("./crc32"),l=e("./messages"),c=0,h=1,u=3,d=4,p=5,f=0,m=1,g=-2,y=-3,v=-5,b=-1,_=1,x=2,w=3,S=4,M=0,T=2,A=8,E=9,C=15,L=8,D=286,R=30,P=19,O=2*D+1,I=15,k=3,B=258,N=B+k+1,F=32,U=42,z=69,H=73,G=91,V=103,j=113,W=666,Y=1,X=2,$=3,Z=4,q=3;function J(e,t){return e.msg=l[t],t}function Q(e){return(e<<1)-(e>4?9:0)}function K(e){for(var t=e.length;--t>=0;)e[t]=0}function ee(e){var t=e.state,r=t.pending;r>e.avail_out&&(r=e.avail_out),0!==r&&(i.arraySet(e.output,t.pending_buf,t.pending_out,r,e.next_out),e.next_out+=r,t.pending_out+=r,e.total_out+=r,e.avail_out-=r,t.pending-=r,0===t.pending&&(t.pending_out=0))}function te(e,t){a._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,ee(e.strm)}function re(e,t){e.pending_buf[e.pending++]=t}function ne(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function ie(e,t,r,n){var a=e.avail_in;return a>n&&(a=n),0===a?0:(e.avail_in-=a,i.arraySet(t,e.input,e.next_in,a,r),1===e.state.wrap?e.adler=o(e.adler,t,a,r):2===e.state.wrap&&(e.adler=s(e.adler,t,a,r)),e.next_in+=a,e.total_in+=a,a)}function ae(e,t){var r,n,i=e.max_chain_length,a=e.strstart,o=e.prev_length,s=e.nice_match,l=e.strstart>e.w_size-N?e.strstart-(e.w_size-N):0,c=e.window,h=e.w_mask,u=e.prev,d=e.strstart+B,p=c[a+o-1],f=c[a+o];e.prev_length>=e.good_match&&(i>>=2),s>e.lookahead&&(s=e.lookahead);do{if(c[(r=t)+o]===f&&c[r+o-1]===p&&c[r]===c[a]&&c[++r]===c[a+1]){a+=2,r++;do{}while(c[++a]===c[++r]&&c[++a]===c[++r]&&c[++a]===c[++r]&&c[++a]===c[++r]&&c[++a]===c[++r]&&c[++a]===c[++r]&&c[++a]===c[++r]&&c[++a]===c[++r]&&a<d);if(n=B-(d-a),a=d-B,n>o){if(e.match_start=t,o=n,n>=s)break;p=c[a+o-1],f=c[a+o]}}}while((t=u[t&h])>l&&0!=--i);return o<=e.lookahead?o:e.lookahead}function oe(e){var t,r,n,a,o,s=e.w_size;do{if(a=e.window_size-e.lookahead-e.strstart,e.strstart>=s+(s-N)){i.arraySet(e.window,e.window,s,s,0),e.match_start-=s,e.strstart-=s,e.block_start-=s,t=r=e.hash_size;do{n=e.head[--t],e.head[t]=n>=s?n-s:0}while(--r);t=r=s;do{n=e.prev[--t],e.prev[t]=n>=s?n-s:0}while(--r);a+=s}if(0===e.strm.avail_in)break;if(r=ie(e.strm,e.window,e.strstart+e.lookahead,a),e.lookahead+=r,e.lookahead+e.insert>=k)for(o=e.strstart-e.insert,e.ins_h=e.window[o],e.ins_h=(e.ins_h<<e.hash_shift^e.window[o+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[o+k-1])&e.hash_mask,e.prev[o&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=o,o++,e.insert--,!(e.lookahead+e.insert<k)););}while(e.lookahead<N&&0!==e.strm.avail_in)}function se(e,t){var r=65535;for(r>e.pending_buf_size-5&&(r=e.pending_buf_size-5);;){if(e.lookahead<=1){if(oe(e),0===e.lookahead&&t===c)return Y;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var n=e.block_start+r;if((0===e.strstart||e.strstart>=n)&&(e.lookahead=e.strstart-n,e.strstart=n,te(e,!1),0===e.strm.avail_out))return Y;if(e.strstart-e.block_start>=e.w_size-N&&(te(e,!1),0===e.strm.avail_out))return Y}return e.insert=0,t===d?(te(e,!0),0===e.strm.avail_out?$:Z):(e.strstart>e.block_start&&(te(e,!1),e.strm.avail_out),Y)}function le(e,t){for(var r,n;;){if(e.lookahead<N){if(oe(e),e.lookahead<N&&t===c)return Y;if(0===e.lookahead)break}if(r=0,e.lookahead>=k&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+k-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==r&&e.strstart-r<=e.w_size-N&&(e.match_length=ae(e,r)),e.match_length>=k)if(n=a._tr_tally(e,e.strstart-e.match_start,e.match_length-k),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=k){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+k-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else n=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(n&&(te(e,!1),0===e.strm.avail_out))return Y}return e.insert=e.strstart<k-1?e.strstart:k-1,t===d?(te(e,!0),0===e.strm.avail_out?$:Z):e.last_lit&&(te(e,!1),0===e.strm.avail_out)?Y:X}function ce(e,t){for(var r,n,i;;){if(e.lookahead<N){if(oe(e),e.lookahead<N&&t===c)return Y;if(0===e.lookahead)break}if(r=0,e.lookahead>=k&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+k-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=k-1,0!==r&&e.prev_length<e.max_lazy_match&&e.strstart-r<=e.w_size-N&&(e.match_length=ae(e,r),e.match_length<=5&&(e.strategy===_||e.match_length===k&&e.strstart-e.match_start>4096)&&(e.match_length=k-1)),e.prev_length>=k&&e.match_length<=e.prev_length){i=e.strstart+e.lookahead-k,n=a._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-k),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=i&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+k-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=k-1,e.strstart++,n&&(te(e,!1),0===e.strm.avail_out))return Y}else if(e.match_available){if((n=a._tr_tally(e,0,e.window[e.strstart-1]))&&te(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return Y}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(n=a._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<k-1?e.strstart:k-1,t===d?(te(e,!0),0===e.strm.avail_out?$:Z):e.last_lit&&(te(e,!1),0===e.strm.avail_out)?Y:X}function he(e,t){for(var r,n,i,o,s=e.window;;){if(e.lookahead<=B){if(oe(e),e.lookahead<=B&&t===c)return Y;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=k&&e.strstart>0&&(n=s[i=e.strstart-1])===s[++i]&&n===s[++i]&&n===s[++i]){o=e.strstart+B;do{}while(n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&i<o);e.match_length=B-(o-i),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=k?(r=a._tr_tally(e,1,e.match_length-k),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(r=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),r&&(te(e,!1),0===e.strm.avail_out))return Y}return e.insert=0,t===d?(te(e,!0),0===e.strm.avail_out?$:Z):e.last_lit&&(te(e,!1),0===e.strm.avail_out)?Y:X}function ue(e,t){for(var r;;){if(0===e.lookahead&&(oe(e),0===e.lookahead)){if(t===c)return Y;break}if(e.match_length=0,r=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,r&&(te(e,!1),0===e.strm.avail_out))return Y}return e.insert=0,t===d?(te(e,!0),0===e.strm.avail_out?$:Z):e.last_lit&&(te(e,!1),0===e.strm.avail_out)?Y:X}function de(e,t,r,n,i){this.good_length=e,this.max_lazy=t,this.nice_length=r,this.max_chain=n,this.func=i}function pe(e){e.window_size=2*e.w_size,K(e.head),e.max_lazy_match=n[e.level].max_lazy,e.good_match=n[e.level].good_length,e.nice_match=n[e.level].nice_length,e.max_chain_length=n[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=k-1,e.match_available=0,e.ins_h=0}function fe(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=A,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new i.Buf16(2*O),this.dyn_dtree=new i.Buf16(2*(2*R+1)),this.bl_tree=new i.Buf16(2*(2*P+1)),K(this.dyn_ltree),K(this.dyn_dtree),K(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new i.Buf16(I+1),this.heap=new i.Buf16(2*D+1),K(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new i.Buf16(2*D+1),K(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function me(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=T,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?U:j,e.adler=2===t.wrap?0:1,t.last_flush=c,a._tr_init(t),f):J(e,g)}function ge(e){var t=me(e);return t===f&&pe(e.state),t}function ye(e,t){return e&&e.state?2!==e.state.wrap?g:(e.state.gzhead=t,f):g}function ve(e,t,r,n,a,o){if(!e)return g;var s=1;if(t===b&&(t=6),n<0?(s=0,n=-n):n>15&&(s=2,n-=16),a<1||a>E||r!==A||n<8||n>15||t<0||t>9||o<0||o>S)return J(e,g);8===n&&(n=9);var l=new fe;return e.state=l,l.strm=e,l.wrap=s,l.gzhead=null,l.w_bits=n,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=a+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+k-1)/k),l.window=new i.Buf8(2*l.w_size),l.head=new i.Buf16(l.hash_size),l.prev=new i.Buf16(l.w_size),l.lit_bufsize=1<<a+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new i.Buf8(l.pending_buf_size),l.d_buf=1*l.lit_bufsize,l.l_buf=3*l.lit_bufsize,l.level=t,l.strategy=o,l.method=r,ge(e)}function be(e,t){return ve(e,t,A,C,L,M)}function _e(e,t){var r,i,o,l;if(!e||!e.state||t>p||t<0)return e?J(e,g):g;if(i=e.state,!e.output||!e.input&&0!==e.avail_in||i.status===W&&t!==d)return J(e,0===e.avail_out?v:g);if(i.strm=e,r=i.last_flush,i.last_flush=t,i.status===U)if(2===i.wrap)e.adler=0,re(i,31),re(i,139),re(i,8),i.gzhead?(re(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),re(i,255&i.gzhead.time),re(i,i.gzhead.time>>8&255),re(i,i.gzhead.time>>16&255),re(i,i.gzhead.time>>24&255),re(i,9===i.level?2:i.strategy>=x||i.level<2?4:0),re(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(re(i,255&i.gzhead.extra.length),re(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(e.adler=s(e.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=z):(re(i,0),re(i,0),re(i,0),re(i,0),re(i,0),re(i,9===i.level?2:i.strategy>=x||i.level<2?4:0),re(i,q),i.status=j);else{var y=A+(i.w_bits-8<<4)<<8;y|=(i.strategy>=x||i.level<2?0:i.level<6?1:6===i.level?2:3)<<6,0!==i.strstart&&(y|=F),y+=31-y%31,i.status=j,ne(i,y),0!==i.strstart&&(ne(i,e.adler>>>16),ne(i,65535&e.adler)),e.adler=1}if(i.status===z)if(i.gzhead.extra){for(o=i.pending;i.gzindex<(65535&i.gzhead.extra.length)&&(i.pending!==i.pending_buf_size||(i.gzhead.hcrc&&i.pending>o&&(e.adler=s(e.adler,i.pending_buf,i.pending-o,o)),ee(e),o=i.pending,i.pending!==i.pending_buf_size));)re(i,255&i.gzhead.extra[i.gzindex]),i.gzindex++;i.gzhead.hcrc&&i.pending>o&&(e.adler=s(e.adler,i.pending_buf,i.pending-o,o)),i.gzindex===i.gzhead.extra.length&&(i.gzindex=0,i.status=H)}else i.status=H;if(i.status===H)if(i.gzhead.name){o=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>o&&(e.adler=s(e.adler,i.pending_buf,i.pending-o,o)),ee(e),o=i.pending,i.pending===i.pending_buf_size)){l=1;break}l=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,re(i,l)}while(0!==l);i.gzhead.hcrc&&i.pending>o&&(e.adler=s(e.adler,i.pending_buf,i.pending-o,o)),0===l&&(i.gzindex=0,i.status=G)}else i.status=G;if(i.status===G)if(i.gzhead.comment){o=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>o&&(e.adler=s(e.adler,i.pending_buf,i.pending-o,o)),ee(e),o=i.pending,i.pending===i.pending_buf_size)){l=1;break}l=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,re(i,l)}while(0!==l);i.gzhead.hcrc&&i.pending>o&&(e.adler=s(e.adler,i.pending_buf,i.pending-o,o)),0===l&&(i.status=V)}else i.status=V;if(i.status===V&&(i.gzhead.hcrc?(i.pending+2>i.pending_buf_size&&ee(e),i.pending+2<=i.pending_buf_size&&(re(i,255&e.adler),re(i,e.adler>>8&255),e.adler=0,i.status=j)):i.status=j),0!==i.pending){if(ee(e),0===e.avail_out)return i.last_flush=-1,f}else if(0===e.avail_in&&Q(t)<=Q(r)&&t!==d)return J(e,v);if(i.status===W&&0!==e.avail_in)return J(e,v);if(0!==e.avail_in||0!==i.lookahead||t!==c&&i.status!==W){var b=i.strategy===x?ue(i,t):i.strategy===w?he(i,t):n[i.level].func(i,t);if(b!==$&&b!==Z||(i.status=W),b===Y||b===$)return 0===e.avail_out&&(i.last_flush=-1),f;if(b===X&&(t===h?a._tr_align(i):t!==p&&(a._tr_stored_block(i,0,0,!1),t===u&&(K(i.head),0===i.lookahead&&(i.strstart=0,i.block_start=0,i.insert=0))),ee(e),0===e.avail_out))return i.last_flush=-1,f}return t!==d?f:i.wrap<=0?m:(2===i.wrap?(re(i,255&e.adler),re(i,e.adler>>8&255),re(i,e.adler>>16&255),re(i,e.adler>>24&255),re(i,255&e.total_in),re(i,e.total_in>>8&255),re(i,e.total_in>>16&255),re(i,e.total_in>>24&255)):(ne(i,e.adler>>>16),ne(i,65535&e.adler)),ee(e),i.wrap>0&&(i.wrap=-i.wrap),0!==i.pending?f:m)}function xe(e){var t;return e&&e.state?(t=e.state.status)!==U&&t!==z&&t!==H&&t!==G&&t!==V&&t!==j&&t!==W?J(e,g):(e.state=null,t===j?J(e,y):f):g}function we(e,t){var r,n,a,s,l,c,h,u,d=t.length;if(!e||!e.state)return g;if(2===(s=(r=e.state).wrap)||1===s&&r.status!==U||r.lookahead)return g;for(1===s&&(e.adler=o(e.adler,t,d,0)),r.wrap=0,d>=r.w_size&&(0===s&&(K(r.head),r.strstart=0,r.block_start=0,r.insert=0),u=new i.Buf8(r.w_size),i.arraySet(u,t,d-r.w_size,r.w_size,0),t=u,d=r.w_size),l=e.avail_in,c=e.next_in,h=e.input,e.avail_in=d,e.next_in=0,e.input=t,oe(r);r.lookahead>=k;){n=r.strstart,a=r.lookahead-(k-1);do{r.ins_h=(r.ins_h<<r.hash_shift^r.window[n+k-1])&r.hash_mask,r.prev[n&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=n,n++}while(--a);r.strstart=n,r.lookahead=k-1,oe(r)}return r.strstart+=r.lookahead,r.block_start=r.strstart,r.insert=r.lookahead,r.lookahead=0,r.match_length=r.prev_length=k-1,r.match_available=0,e.next_in=c,e.input=h,e.avail_in=l,r.wrap=s,f}n=[new de(0,0,0,0,se),new de(4,4,8,4,le),new de(4,5,16,8,le),new de(4,6,32,32,le),new de(4,4,16,16,ce),new de(8,16,32,32,ce),new de(8,16,128,128,ce),new de(8,32,128,256,ce),new de(32,128,258,1024,ce),new de(32,258,258,4096,ce)],r.deflateInit=be,r.deflateInit2=ve,r.deflateReset=ge,r.deflateResetKeep=me,r.deflateSetHeader=ye,r.deflate=_e,r.deflateEnd=xe,r.deflateSetDictionary=we,r.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":49,"./adler32":50,"./crc32":52,"./messages":57,"./trees":58}],54:[function(e,t,r){var n=30,i=12;t.exports=function(e,t){var r,a,o,s,l,c,h,u,d,p,f,m,g,y,v,b,_,x,w,S,M,T,A,E,C;r=e.state,a=e.next_in,E=e.input,o=a+(e.avail_in-5),s=e.next_out,C=e.output,l=s-(t-e.avail_out),c=s+(e.avail_out-257),h=r.dmax,u=r.wsize,d=r.whave,p=r.wnext,f=r.window,m=r.hold,g=r.bits,y=r.lencode,v=r.distcode,b=(1<<r.lenbits)-1,_=(1<<r.distbits)-1;e:do{g<15&&(m+=E[a++]<<g,g+=8,m+=E[a++]<<g,g+=8),x=y[m&b];t:for(;;){if(m>>>=w=x>>>24,g-=w,0==(w=x>>>16&255))C[s++]=65535&x;else{if(!(16&w)){if(0==(64&w)){x=y[(65535&x)+(m&(1<<w)-1)];continue t}if(32&w){r.mode=i;break e}e.msg="invalid literal/length code",r.mode=n;break e}S=65535&x,(w&=15)&&(g<w&&(m+=E[a++]<<g,g+=8),S+=m&(1<<w)-1,m>>>=w,g-=w),g<15&&(m+=E[a++]<<g,g+=8,m+=E[a++]<<g,g+=8),x=v[m&_];r:for(;;){if(m>>>=w=x>>>24,g-=w,!(16&(w=x>>>16&255))){if(0==(64&w)){x=v[(65535&x)+(m&(1<<w)-1)];continue r}e.msg="invalid distance code",r.mode=n;break e}if(M=65535&x,g<(w&=15)&&(m+=E[a++]<<g,(g+=8)<w&&(m+=E[a++]<<g,g+=8)),(M+=m&(1<<w)-1)>h){e.msg="invalid distance too far back",r.mode=n;break e}if(m>>>=w,g-=w,M>(w=s-l)){if((w=M-w)>d&&r.sane){e.msg="invalid distance too far back",r.mode=n;break e}if(T=0,A=f,0===p){if(T+=u-w,w<S){S-=w;do{C[s++]=f[T++]}while(--w);T=s-M,A=C}}else if(p<w){if(T+=u+p-w,(w-=p)<S){S-=w;do{C[s++]=f[T++]}while(--w);if(T=0,p<S){S-=w=p;do{C[s++]=f[T++]}while(--w);T=s-M,A=C}}}else if(T+=p-w,w<S){S-=w;do{C[s++]=f[T++]}while(--w);T=s-M,A=C}for(;S>2;)C[s++]=A[T++],C[s++]=A[T++],C[s++]=A[T++],S-=3;S&&(C[s++]=A[T++],S>1&&(C[s++]=A[T++]))}else{T=s-M;do{C[s++]=C[T++],C[s++]=C[T++],C[s++]=C[T++],S-=3}while(S>2);S&&(C[s++]=C[T++],S>1&&(C[s++]=C[T++]))}break}}break}}while(a<o&&s<c);a-=S=g>>3,m&=(1<<(g-=S<<3))-1,e.next_in=a,e.next_out=s,e.avail_in=a<o?o-a+5:5-(a-o),e.avail_out=s<c?c-s+257:257-(s-c),r.hold=m,r.bits=g}},{}],55:[function(e,t,r){var n=e("../utils/common"),i=e("./adler32"),a=e("./crc32"),o=e("./inffast"),s=e("./inftrees"),l=0,c=1,h=2,u=4,d=5,p=6,f=0,m=1,g=2,y=-2,v=-3,b=-4,_=-5,x=8,w=1,S=2,M=3,T=4,A=5,E=6,C=7,L=8,D=9,R=10,P=11,O=12,I=13,k=14,B=15,N=16,F=17,U=18,z=19,H=20,G=21,V=22,j=23,W=24,Y=25,X=26,$=27,Z=28,q=29,J=30,Q=31,K=32,ee=852,te=592,re=15;function ne(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function ie(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new n.Buf16(320),this.work=new n.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function ae(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=w,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new n.Buf32(ee),t.distcode=t.distdyn=new n.Buf32(te),t.sane=1,t.back=-1,f):y}function oe(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,ae(e)):y}function se(e,t){var r,n;return e&&e.state?(n=e.state,t<0?(r=0,t=-t):(r=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?y:(null!==n.window&&n.wbits!==t&&(n.window=null),n.wrap=r,n.wbits=t,oe(e))):y}function le(e,t){var r,n;return e?(n=new ie,e.state=n,n.window=null,(r=se(e,t))!==f&&(e.state=null),r):y}function ce(e){return le(e,re)}var he,ue,de=!0;function pe(e){if(de){var t;for(he=new n.Buf32(512),ue=new n.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(s(c,e.lens,0,288,he,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;s(h,e.lens,0,32,ue,0,e.work,{bits:5}),de=!1}e.lencode=he,e.lenbits=9,e.distcode=ue,e.distbits=5}function fe(e,t,r,i){var a,o=e.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new n.Buf8(o.wsize)),i>=o.wsize?(n.arraySet(o.window,t,r-o.wsize,o.wsize,0),o.wnext=0,o.whave=o.wsize):((a=o.wsize-o.wnext)>i&&(a=i),n.arraySet(o.window,t,r-i,a,o.wnext),(i-=a)?(n.arraySet(o.window,t,r-i,i,0),o.wnext=i,o.whave=o.wsize):(o.wnext+=a,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=a))),0}function me(e,t){var r,ee,te,re,ie,ae,oe,se,le,ce,he,ue,de,me,ge,ye,ve,be,_e,xe,we,Se,Me,Te,Ae=0,Ee=new n.Buf8(4),Ce=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return y;(r=e.state).mode===O&&(r.mode=I),ie=e.next_out,te=e.output,oe=e.avail_out,re=e.next_in,ee=e.input,ae=e.avail_in,se=r.hold,le=r.bits,ce=ae,he=oe,Se=f;e:for(;;)switch(r.mode){case w:if(0===r.wrap){r.mode=I;break}for(;le<16;){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}if(2&r.wrap&&35615===se){r.check=0,Ee[0]=255&se,Ee[1]=se>>>8&255,r.check=a(r.check,Ee,2,0),se=0,le=0,r.mode=S;break}if(r.flags=0,r.head&&(r.head.done=!1),!(1&r.wrap)||(((255&se)<<8)+(se>>8))%31){e.msg="incorrect header check",r.mode=J;break}if((15&se)!==x){e.msg="unknown compression method",r.mode=J;break}if(le-=4,we=8+(15&(se>>>=4)),0===r.wbits)r.wbits=we;else if(we>r.wbits){e.msg="invalid window size",r.mode=J;break}r.dmax=1<<we,e.adler=r.check=1,r.mode=512&se?R:O,se=0,le=0;break;case S:for(;le<16;){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}if(r.flags=se,(255&r.flags)!==x){e.msg="unknown compression method",r.mode=J;break}if(57344&r.flags){e.msg="unknown header flags set",r.mode=J;break}r.head&&(r.head.text=se>>8&1),512&r.flags&&(Ee[0]=255&se,Ee[1]=se>>>8&255,r.check=a(r.check,Ee,2,0)),se=0,le=0,r.mode=M;case M:for(;le<32;){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}r.head&&(r.head.time=se),512&r.flags&&(Ee[0]=255&se,Ee[1]=se>>>8&255,Ee[2]=se>>>16&255,Ee[3]=se>>>24&255,r.check=a(r.check,Ee,4,0)),se=0,le=0,r.mode=T;case T:for(;le<16;){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}r.head&&(r.head.xflags=255&se,r.head.os=se>>8),512&r.flags&&(Ee[0]=255&se,Ee[1]=se>>>8&255,r.check=a(r.check,Ee,2,0)),se=0,le=0,r.mode=A;case A:if(1024&r.flags){for(;le<16;){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}r.length=se,r.head&&(r.head.extra_len=se),512&r.flags&&(Ee[0]=255&se,Ee[1]=se>>>8&255,r.check=a(r.check,Ee,2,0)),se=0,le=0}else r.head&&(r.head.extra=null);r.mode=E;case E:if(1024&r.flags&&((ue=r.length)>ae&&(ue=ae),ue&&(r.head&&(we=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Array(r.head.extra_len)),n.arraySet(r.head.extra,ee,re,ue,we)),512&r.flags&&(r.check=a(r.check,ee,ue,re)),ae-=ue,re+=ue,r.length-=ue),r.length))break e;r.length=0,r.mode=C;case C:if(2048&r.flags){if(0===ae)break e;ue=0;do{we=ee[re+ue++],r.head&&we&&r.length<65536&&(r.head.name+=String.fromCharCode(we))}while(we&&ue<ae);if(512&r.flags&&(r.check=a(r.check,ee,ue,re)),ae-=ue,re+=ue,we)break e}else r.head&&(r.head.name=null);r.length=0,r.mode=L;case L:if(4096&r.flags){if(0===ae)break e;ue=0;do{we=ee[re+ue++],r.head&&we&&r.length<65536&&(r.head.comment+=String.fromCharCode(we))}while(we&&ue<ae);if(512&r.flags&&(r.check=a(r.check,ee,ue,re)),ae-=ue,re+=ue,we)break e}else r.head&&(r.head.comment=null);r.mode=D;case D:if(512&r.flags){for(;le<16;){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}if(se!==(65535&r.check)){e.msg="header crc mismatch",r.mode=J;break}se=0,le=0}r.head&&(r.head.hcrc=r.flags>>9&1,r.head.done=!0),e.adler=r.check=0,r.mode=O;break;case R:for(;le<32;){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}e.adler=r.check=ne(se),se=0,le=0,r.mode=P;case P:if(0===r.havedict)return e.next_out=ie,e.avail_out=oe,e.next_in=re,e.avail_in=ae,r.hold=se,r.bits=le,g;e.adler=r.check=1,r.mode=O;case O:if(t===d||t===p)break e;case I:if(r.last){se>>>=7&le,le-=7&le,r.mode=$;break}for(;le<3;){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}switch(r.last=1&se,le-=1,3&(se>>>=1)){case 0:r.mode=k;break;case 1:if(pe(r),r.mode=H,t===p){se>>>=2,le-=2;break e}break;case 2:r.mode=F;break;case 3:e.msg="invalid block type",r.mode=J}se>>>=2,le-=2;break;case k:for(se>>>=7&le,le-=7&le;le<32;){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}if((65535&se)!=(se>>>16^65535)){e.msg="invalid stored block lengths",r.mode=J;break}if(r.length=65535&se,se=0,le=0,r.mode=B,t===p)break e;case B:r.mode=N;case N:if(ue=r.length){if(ue>ae&&(ue=ae),ue>oe&&(ue=oe),0===ue)break e;n.arraySet(te,ee,re,ue,ie),ae-=ue,re+=ue,oe-=ue,ie+=ue,r.length-=ue;break}r.mode=O;break;case F:for(;le<14;){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}if(r.nlen=257+(31&se),se>>>=5,le-=5,r.ndist=1+(31&se),se>>>=5,le-=5,r.ncode=4+(15&se),se>>>=4,le-=4,r.nlen>286||r.ndist>30){e.msg="too many length or distance symbols",r.mode=J;break}r.have=0,r.mode=U;case U:for(;r.have<r.ncode;){for(;le<3;){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}r.lens[Ce[r.have++]]=7&se,se>>>=3,le-=3}for(;r.have<19;)r.lens[Ce[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,Me={bits:r.lenbits},Se=s(l,r.lens,0,19,r.lencode,0,r.work,Me),r.lenbits=Me.bits,Se){e.msg="invalid code lengths set",r.mode=J;break}r.have=0,r.mode=z;case z:for(;r.have<r.nlen+r.ndist;){for(;ye=(Ae=r.lencode[se&(1<<r.lenbits)-1])>>>16&255,ve=65535&Ae,!((ge=Ae>>>24)<=le);){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}if(ve<16)se>>>=ge,le-=ge,r.lens[r.have++]=ve;else{if(16===ve){for(Te=ge+2;le<Te;){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}if(se>>>=ge,le-=ge,0===r.have){e.msg="invalid bit length repeat",r.mode=J;break}we=r.lens[r.have-1],ue=3+(3&se),se>>>=2,le-=2}else if(17===ve){for(Te=ge+3;le<Te;){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}le-=ge,we=0,ue=3+(7&(se>>>=ge)),se>>>=3,le-=3}else{for(Te=ge+7;le<Te;){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}le-=ge,we=0,ue=11+(127&(se>>>=ge)),se>>>=7,le-=7}if(r.have+ue>r.nlen+r.ndist){e.msg="invalid bit length repeat",r.mode=J;break}for(;ue--;)r.lens[r.have++]=we}}if(r.mode===J)break;if(0===r.lens[256]){e.msg="invalid code -- missing end-of-block",r.mode=J;break}if(r.lenbits=9,Me={bits:r.lenbits},Se=s(c,r.lens,0,r.nlen,r.lencode,0,r.work,Me),r.lenbits=Me.bits,Se){e.msg="invalid literal/lengths set",r.mode=J;break}if(r.distbits=6,r.distcode=r.distdyn,Me={bits:r.distbits},Se=s(h,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,Me),r.distbits=Me.bits,Se){e.msg="invalid distances set",r.mode=J;break}if(r.mode=H,t===p)break e;case H:r.mode=G;case G:if(ae>=6&&oe>=258){e.next_out=ie,e.avail_out=oe,e.next_in=re,e.avail_in=ae,r.hold=se,r.bits=le,o(e,he),ie=e.next_out,te=e.output,oe=e.avail_out,re=e.next_in,ee=e.input,ae=e.avail_in,se=r.hold,le=r.bits,r.mode===O&&(r.back=-1);break}for(r.back=0;ye=(Ae=r.lencode[se&(1<<r.lenbits)-1])>>>16&255,ve=65535&Ae,!((ge=Ae>>>24)<=le);){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}if(ye&&0==(240&ye)){for(be=ge,_e=ye,xe=ve;ye=(Ae=r.lencode[xe+((se&(1<<be+_e)-1)>>be)])>>>16&255,ve=65535&Ae,!(be+(ge=Ae>>>24)<=le);){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}se>>>=be,le-=be,r.back+=be}if(se>>>=ge,le-=ge,r.back+=ge,r.length=ve,0===ye){r.mode=X;break}if(32&ye){r.back=-1,r.mode=O;break}if(64&ye){e.msg="invalid literal/length code",r.mode=J;break}r.extra=15&ye,r.mode=V;case V:if(r.extra){for(Te=r.extra;le<Te;){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}r.length+=se&(1<<r.extra)-1,se>>>=r.extra,le-=r.extra,r.back+=r.extra}r.was=r.length,r.mode=j;case j:for(;ye=(Ae=r.distcode[se&(1<<r.distbits)-1])>>>16&255,ve=65535&Ae,!((ge=Ae>>>24)<=le);){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}if(0==(240&ye)){for(be=ge,_e=ye,xe=ve;ye=(Ae=r.distcode[xe+((se&(1<<be+_e)-1)>>be)])>>>16&255,ve=65535&Ae,!(be+(ge=Ae>>>24)<=le);){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}se>>>=be,le-=be,r.back+=be}if(se>>>=ge,le-=ge,r.back+=ge,64&ye){e.msg="invalid distance code",r.mode=J;break}r.offset=ve,r.extra=15&ye,r.mode=W;case W:if(r.extra){for(Te=r.extra;le<Te;){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}r.offset+=se&(1<<r.extra)-1,se>>>=r.extra,le-=r.extra,r.back+=r.extra}if(r.offset>r.dmax){e.msg="invalid distance too far back",r.mode=J;break}r.mode=Y;case Y:if(0===oe)break e;if(ue=he-oe,r.offset>ue){if((ue=r.offset-ue)>r.whave&&r.sane){e.msg="invalid distance too far back",r.mode=J;break}ue>r.wnext?(ue-=r.wnext,de=r.wsize-ue):de=r.wnext-ue,ue>r.length&&(ue=r.length),me=r.window}else me=te,de=ie-r.offset,ue=r.length;ue>oe&&(ue=oe),oe-=ue,r.length-=ue;do{te[ie++]=me[de++]}while(--ue);0===r.length&&(r.mode=G);break;case X:if(0===oe)break e;te[ie++]=r.length,oe--,r.mode=G;break;case $:if(r.wrap){for(;le<32;){if(0===ae)break e;ae--,se|=ee[re++]<<le,le+=8}if(he-=oe,e.total_out+=he,r.total+=he,he&&(e.adler=r.check=r.flags?a(r.check,te,he,ie-he):i(r.check,te,he,ie-he)),he=oe,(r.flags?se:ne(se))!==r.check){e.msg="incorrect data check",r.mode=J;break}se=0,le=0}r.mode=Z;case Z:if(r.wrap&&r.flags){for(;le<32;){if(0===ae)break e;ae--,se+=ee[re++]<<le,le+=8}if(se!==(4294967295&r.total)){e.msg="incorrect length check",r.mode=J;break}se=0,le=0}r.mode=q;case q:Se=m;break e;case J:Se=v;break e;case Q:return b;case K:default:return y}return e.next_out=ie,e.avail_out=oe,e.next_in=re,e.avail_in=ae,r.hold=se,r.bits=le,(r.wsize||he!==e.avail_out&&r.mode<J&&(r.mode<$||t!==u))&&fe(e,e.output,e.next_out,he-e.avail_out),ce-=e.avail_in,he-=e.avail_out,e.total_in+=ce,e.total_out+=he,r.total+=he,r.wrap&&he&&(e.adler=r.check=r.flags?a(r.check,te,he,e.next_out-he):i(r.check,te,he,e.next_out-he)),e.data_type=r.bits+(r.last?64:0)+(r.mode===O?128:0)+(r.mode===H||r.mode===B?256:0),(0===ce&&0===he||t===u)&&Se===f&&(Se=_),Se}function ge(e){if(!e||!e.state)return y;var t=e.state;return t.window&&(t.window=null),e.state=null,f}function ye(e,t){var r;return e&&e.state?0==(2&(r=e.state).wrap)?y:(r.head=t,t.done=!1,f):y}function ve(e,t){var r,n=t.length;return e&&e.state?0!==(r=e.state).wrap&&r.mode!==P?y:r.mode===P&&i(1,t,n,0)!==r.check?v:fe(e,t,n,n)?(r.mode=Q,b):(r.havedict=1,f):y}r.inflateReset=oe,r.inflateReset2=se,r.inflateResetKeep=ae,r.inflateInit=ce,r.inflateInit2=le,r.inflate=me,r.inflateEnd=ge,r.inflateGetHeader=ye,r.inflateSetDictionary=ve,r.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":49,"./adler32":50,"./crc32":52,"./inffast":54,"./inftrees":56}],56:[function(e,t,r){var n=e("../utils/common"),i=15,a=852,o=592,s=0,l=1,c=2,h=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],u=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],d=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],p=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(e,t,r,f,m,g,y,v){var b,_,x,w,S,M,T,A,E,C=v.bits,L=0,D=0,R=0,P=0,O=0,I=0,k=0,B=0,N=0,F=0,U=null,z=0,H=new n.Buf16(i+1),G=new n.Buf16(i+1),V=null,j=0;for(L=0;L<=i;L++)H[L]=0;for(D=0;D<f;D++)H[t[r+D]]++;for(O=C,P=i;P>=1&&0===H[P];P--);if(O>P&&(O=P),0===P)return m[g++]=20971520,m[g++]=20971520,v.bits=1,0;for(R=1;R<P&&0===H[R];R++);for(O<R&&(O=R),B=1,L=1;L<=i;L++)if(B<<=1,(B-=H[L])<0)return-1;if(B>0&&(e===s||1!==P))return-1;for(G[1]=0,L=1;L<i;L++)G[L+1]=G[L]+H[L];for(D=0;D<f;D++)0!==t[r+D]&&(y[G[t[r+D]]++]=D);if(e===s?(U=V=y,M=19):e===l?(U=h,z-=257,V=u,j-=257,M=256):(U=d,V=p,M=-1),F=0,D=0,L=R,S=g,I=O,k=0,x=-1,w=(N=1<<O)-1,e===l&&N>a||e===c&&N>o)return 1;for(;;){T=L-k,y[D]<M?(A=0,E=y[D]):y[D]>M?(A=V[j+y[D]],E=U[z+y[D]]):(A=96,E=0),b=1<<L-k,R=_=1<<I;do{m[S+(F>>k)+(_-=b)]=T<<24|A<<16|E|0}while(0!==_);for(b=1<<L-1;F&b;)b>>=1;if(0!==b?(F&=b-1,F+=b):F=0,D++,0==--H[L]){if(L===P)break;L=t[r+y[D]]}if(L>O&&(F&w)!==x){for(0===k&&(k=O),S+=R,B=1<<(I=L-k);I+k<P&&!((B-=H[I+k])<=0);)I++,B<<=1;if(N+=1<<I,e===l&&N>a||e===c&&N>o)return 1;m[x=F&w]=O<<24|I<<16|S-g|0}}return 0!==F&&(m[S+F]=L-k<<24|64<<16|0),v.bits=O,0}},{"../utils/common":49}],57:[function(e,t,r){t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],58:[function(e,t,r){var n=e("../utils/common"),i=4,a=0,o=1,s=2;function l(e){for(var t=e.length;--t>=0;)e[t]=0}var c=0,h=1,u=2,d=3,p=258,f=29,m=256,g=m+1+f,y=30,v=19,b=2*g+1,_=15,x=16,w=7,S=256,M=16,T=17,A=18,E=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],C=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],L=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],D=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],R=512,P=new Array(2*(g+2));l(P);var O=new Array(2*y);l(O);var I=new Array(R);l(I);var k=new Array(p-d+1);l(k);var B=new Array(f);l(B);var N,F,U,z=new Array(y);function H(e,t,r,n,i){this.static_tree=e,this.extra_bits=t,this.extra_base=r,this.elems=n,this.max_length=i,this.has_stree=e&&e.length}function G(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function V(e){return e<256?I[e]:I[256+(e>>>7)]}function j(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function W(e,t,r){e.bi_valid>x-r?(e.bi_buf|=t<<e.bi_valid&65535,j(e,e.bi_buf),e.bi_buf=t>>x-e.bi_valid,e.bi_valid+=r-x):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=r)}function Y(e,t,r){W(e,r[2*t],r[2*t+1])}function X(e,t){var r=0;do{r|=1&e,e>>>=1,r<<=1}while(--t>0);return r>>>1}function $(e){16===e.bi_valid?(j(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}function Z(e,t){var r,n,i,a,o,s,l=t.dyn_tree,c=t.max_code,h=t.stat_desc.static_tree,u=t.stat_desc.has_stree,d=t.stat_desc.extra_bits,p=t.stat_desc.extra_base,f=t.stat_desc.max_length,m=0;for(a=0;a<=_;a++)e.bl_count[a]=0;for(l[2*e.heap[e.heap_max]+1]=0,r=e.heap_max+1;r<b;r++)(a=l[2*l[2*(n=e.heap[r])+1]+1]+1)>f&&(a=f,m++),l[2*n+1]=a,n>c||(e.bl_count[a]++,o=0,n>=p&&(o=d[n-p]),s=l[2*n],e.opt_len+=s*(a+o),u&&(e.static_len+=s*(h[2*n+1]+o)));if(0!==m){do{for(a=f-1;0===e.bl_count[a];)a--;e.bl_count[a]--,e.bl_count[a+1]+=2,e.bl_count[f]--,m-=2}while(m>0);for(a=f;0!==a;a--)for(n=e.bl_count[a];0!==n;)(i=e.heap[--r])>c||(l[2*i+1]!==a&&(e.opt_len+=(a-l[2*i+1])*l[2*i],l[2*i+1]=a),n--)}}function q(e,t,r){var n,i,a=new Array(_+1),o=0;for(n=1;n<=_;n++)a[n]=o=o+r[n-1]<<1;for(i=0;i<=t;i++){var s=e[2*i+1];0!==s&&(e[2*i]=X(a[s]++,s))}}function J(){var e,t,r,n,i,a=new Array(_+1);for(r=0,n=0;n<f-1;n++)for(B[n]=r,e=0;e<1<<E[n];e++)k[r++]=n;for(k[r-1]=n,i=0,n=0;n<16;n++)for(z[n]=i,e=0;e<1<<C[n];e++)I[i++]=n;for(i>>=7;n<y;n++)for(z[n]=i<<7,e=0;e<1<<C[n]-7;e++)I[256+i++]=n;for(t=0;t<=_;t++)a[t]=0;for(e=0;e<=143;)P[2*e+1]=8,e++,a[8]++;for(;e<=255;)P[2*e+1]=9,e++,a[9]++;for(;e<=279;)P[2*e+1]=7,e++,a[7]++;for(;e<=287;)P[2*e+1]=8,e++,a[8]++;for(q(P,g+1,a),e=0;e<y;e++)O[2*e+1]=5,O[2*e]=X(e,5);N=new H(P,E,m+1,g,_),F=new H(O,C,0,y,_),U=new H(new Array(0),L,0,v,w)}function Q(e){var t;for(t=0;t<g;t++)e.dyn_ltree[2*t]=0;for(t=0;t<y;t++)e.dyn_dtree[2*t]=0;for(t=0;t<v;t++)e.bl_tree[2*t]=0;e.dyn_ltree[2*S]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function K(e){e.bi_valid>8?j(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function ee(e,t,r,i){K(e),i&&(j(e,r),j(e,~r)),n.arraySet(e.pending_buf,e.window,t,r,e.pending),e.pending+=r}function te(e,t,r,n){var i=2*t,a=2*r;return e[i]<e[a]||e[i]===e[a]&&n[t]<=n[r]}function re(e,t,r){for(var n=e.heap[r],i=r<<1;i<=e.heap_len&&(i<e.heap_len&&te(t,e.heap[i+1],e.heap[i],e.depth)&&i++,!te(t,n,e.heap[i],e.depth));)e.heap[r]=e.heap[i],r=i,i<<=1;e.heap[r]=n}function ne(e,t,r){var n,i,a,o,s=0;if(0!==e.last_lit)do{n=e.pending_buf[e.d_buf+2*s]<<8|e.pending_buf[e.d_buf+2*s+1],i=e.pending_buf[e.l_buf+s],s++,0===n?Y(e,i,t):(Y(e,(a=k[i])+m+1,t),0!==(o=E[a])&&W(e,i-=B[a],o),Y(e,a=V(--n),r),0!==(o=C[a])&&W(e,n-=z[a],o))}while(s<e.last_lit);Y(e,S,t)}function ie(e,t){var r,n,i,a=t.dyn_tree,o=t.stat_desc.static_tree,s=t.stat_desc.has_stree,l=t.stat_desc.elems,c=-1;for(e.heap_len=0,e.heap_max=b,r=0;r<l;r++)0!==a[2*r]?(e.heap[++e.heap_len]=c=r,e.depth[r]=0):a[2*r+1]=0;for(;e.heap_len<2;)a[2*(i=e.heap[++e.heap_len]=c<2?++c:0)]=1,e.depth[i]=0,e.opt_len--,s&&(e.static_len-=o[2*i+1]);for(t.max_code=c,r=e.heap_len>>1;r>=1;r--)re(e,a,r);i=l;do{r=e.heap[1],e.heap[1]=e.heap[e.heap_len--],re(e,a,1),n=e.heap[1],e.heap[--e.heap_max]=r,e.heap[--e.heap_max]=n,a[2*i]=a[2*r]+a[2*n],e.depth[i]=(e.depth[r]>=e.depth[n]?e.depth[r]:e.depth[n])+1,a[2*r+1]=a[2*n+1]=i,e.heap[1]=i++,re(e,a,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],Z(e,t),q(a,c,e.bl_count)}function ae(e,t,r){var n,i,a=-1,o=t[1],s=0,l=7,c=4;for(0===o&&(l=138,c=3),t[2*(r+1)+1]=65535,n=0;n<=r;n++)i=o,o=t[2*(n+1)+1],++s<l&&i===o||(s<c?e.bl_tree[2*i]+=s:0!==i?(i!==a&&e.bl_tree[2*i]++,e.bl_tree[2*M]++):s<=10?e.bl_tree[2*T]++:e.bl_tree[2*A]++,s=0,a=i,0===o?(l=138,c=3):i===o?(l=6,c=3):(l=7,c=4))}function oe(e,t,r){var n,i,a=-1,o=t[1],s=0,l=7,c=4;for(0===o&&(l=138,c=3),n=0;n<=r;n++)if(i=o,o=t[2*(n+1)+1],!(++s<l&&i===o)){if(s<c)do{Y(e,i,e.bl_tree)}while(0!=--s);else 0!==i?(i!==a&&(Y(e,i,e.bl_tree),s--),Y(e,M,e.bl_tree),W(e,s-3,2)):s<=10?(Y(e,T,e.bl_tree),W(e,s-3,3)):(Y(e,A,e.bl_tree),W(e,s-11,7));s=0,a=i,0===o?(l=138,c=3):i===o?(l=6,c=3):(l=7,c=4)}}function se(e){var t;for(ae(e,e.dyn_ltree,e.l_desc.max_code),ae(e,e.dyn_dtree,e.d_desc.max_code),ie(e,e.bl_desc),t=v-1;t>=3&&0===e.bl_tree[2*D[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}function le(e,t,r,n){var i;for(W(e,t-257,5),W(e,r-1,5),W(e,n-4,4),i=0;i<n;i++)W(e,e.bl_tree[2*D[i]+1],3);oe(e,e.dyn_ltree,t-1),oe(e,e.dyn_dtree,r-1)}function ce(e){var t,r=4093624447;for(t=0;t<=31;t++,r>>>=1)if(1&r&&0!==e.dyn_ltree[2*t])return a;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return o;for(t=32;t<m;t++)if(0!==e.dyn_ltree[2*t])return o;return a}l(z);var he=!1;function ue(e){he||(J(),he=!0),e.l_desc=new G(e.dyn_ltree,N),e.d_desc=new G(e.dyn_dtree,F),e.bl_desc=new G(e.bl_tree,U),e.bi_buf=0,e.bi_valid=0,Q(e)}function de(e,t,r,n){W(e,(c<<1)+(n?1:0),3),ee(e,t,r,!0)}function pe(e){W(e,h<<1,3),Y(e,S,P),$(e)}function fe(e,t,r,n){var a,o,l=0;e.level>0?(e.strm.data_type===s&&(e.strm.data_type=ce(e)),ie(e,e.l_desc),ie(e,e.d_desc),l=se(e),a=e.opt_len+3+7>>>3,(o=e.static_len+3+7>>>3)<=a&&(a=o)):a=o=r+5,r+4<=a&&-1!==t?de(e,t,r,n):e.strategy===i||o===a?(W(e,(h<<1)+(n?1:0),3),ne(e,P,O)):(W(e,(u<<1)+(n?1:0),3),le(e,e.l_desc.max_code+1,e.d_desc.max_code+1,l+1),ne(e,e.dyn_ltree,e.dyn_dtree)),Q(e),n&&K(e)}function me(e,t,r){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&r,e.last_lit++,0===t?e.dyn_ltree[2*r]++:(e.matches++,t--,e.dyn_ltree[2*(k[r]+m+1)]++,e.dyn_dtree[2*V(t)]++),e.last_lit===e.lit_bufsize-1}r._tr_init=ue,r._tr_stored_block=de,r._tr_flush_block=fe,r._tr_tally=me,r._tr_align=pe},{"../utils/common":49}],59:[function(e,t,r){function n(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}t.exports=n},{}],60:[function(e,t,r){var n,i,a=t.exports={};function o(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function l(e){if(n===setTimeout)return setTimeout(e,0);if((n===o||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}function c(e){if(i===clearTimeout)return clearTimeout(e);if((i===s||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(e);try{return i(e)}catch(t){try{return i.call(null,e)}catch(t){return i.call(this,e)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:o}catch(e){n=o}try{i="function"==typeof clearTimeout?clearTimeout:s}catch(e){i=s}}();var h,u=[],d=!1,p=-1;function f(){d&&h&&(d=!1,h.length?u=h.concat(u):p=-1,u.length&&m())}function m(){if(!d){var e=l(f);d=!0;for(var t=u.length;t;){for(h=u,u=[];++p<t;)h&&h[p].run();p=-1,t=u.length}h=null,d=!1,c(e)}}function g(e,t){this.fun=e,this.array=t}function y(){}a.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];u.push(new g(e,t)),1!==u.length||d||l(m)},g.prototype.run=function(){this.fun.apply(null,this.array)},a.title="browser",a.browser=!0,a.env={},a.argv=[],a.version="",a.versions={},a.on=y,a.addListener=y,a.once=y,a.off=y,a.removeListener=y,a.removeAllListeners=y,a.emit=y,a.prependListener=y,a.prependOnceListener=y,a.listeners=function(e){return[]},a.binding=function(e){throw new Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(e){throw new Error("process.chdir is not supported")},a.umask=function(){return 0}},{}],61:[function(e,t,r){t.exports=i;var n=e("events").EventEmitter;function i(){n.call(this)}e("inherits")(i,n),i.Readable=e("readable-stream/lib/_stream_readable.js"),i.Writable=e("readable-stream/lib/_stream_writable.js"),i.Duplex=e("readable-stream/lib/_stream_duplex.js"),i.Transform=e("readable-stream/lib/_stream_transform.js"),i.PassThrough=e("readable-stream/lib/_stream_passthrough.js"),i.finished=e("readable-stream/lib/internal/streams/end-of-stream.js"),i.pipeline=e("readable-stream/lib/internal/streams/pipeline.js"),i.Stream=i,i.prototype.pipe=function(e,t){var r=this;function i(t){e.writable&&!1===e.write(t)&&r.pause&&r.pause()}function a(){r.readable&&r.resume&&r.resume()}r.on("data",i),e.on("drain",a),e._isStdio||t&&!1===t.end||(r.on("end",s),r.on("close",l));var o=!1;function s(){o||(o=!0,e.end())}function l(){o||(o=!0,"function"==typeof e.destroy&&e.destroy())}function c(e){if(h(),0===n.listenerCount(this,"error"))throw e}function h(){r.removeListener("data",i),e.removeListener("drain",a),r.removeListener("end",s),r.removeListener("close",l),r.removeListener("error",c),e.removeListener("error",c),r.removeListener("end",h),r.removeListener("close",h),e.removeListener("close",h)}return r.on("error",c),e.on("error",c),r.on("end",h),r.on("close",h),e.on("close",h),e.emit("pipe",r),e}},{events:38,inherits:45,"readable-stream/lib/_stream_duplex.js":63,"readable-stream/lib/_stream_passthrough.js":64,"readable-stream/lib/_stream_readable.js":65,"readable-stream/lib/_stream_transform.js":66,"readable-stream/lib/_stream_writable.js":67,"readable-stream/lib/internal/streams/end-of-stream.js":71,"readable-stream/lib/internal/streams/pipeline.js":73}],62:[function(e,t,r){function n(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var i={};function a(e,t,r){function a(e,r,n){return"string"==typeof t?t:t(e,r,n)}r||(r=Error);var o=function(e){function t(t,r,n){return e.call(this,a(t,r,n))||this}return n(t,e),t}(r);o.prototype.name=r.name,o.prototype.code=e,i[e]=o}function o(e,t){if(Array.isArray(e)){var r=e.length;return e=e.map((function(e){return String(e)})),r>2?"one of ".concat(t," ").concat(e.slice(0,r-1).join(", "),", or ")+e[r-1]:2===r?"one of ".concat(t," ").concat(e[0]," or ").concat(e[1]):"of ".concat(t," ").concat(e[0])}return"of ".concat(t," ").concat(String(e))}function s(e,t,r){return e.substr(!r||r<0?0:+r,t.length)===t}function l(e,t,r){return(void 0===r||r>e.length)&&(r=e.length),e.substring(r-t.length,r)===t}function c(e,t,r){return"number"!=typeof r&&(r=0),!(r+t.length>e.length)&&-1!==e.indexOf(t,r)}a("ERR_INVALID_OPT_VALUE",(function(e,t){return'The value "'+t+'" is invalid for option "'+e+'"'}),TypeError),a("ERR_INVALID_ARG_TYPE",(function(e,t,r){var n,i;if("string"==typeof t&&s(t,"not ")?(n="must not be",t=t.replace(/^not /,"")):n="must be",l(e," argument"))i="The ".concat(e," ").concat(n," ").concat(o(t,"type"));else{var a=c(e,".")?"property":"argument";i='The "'.concat(e,'" ').concat(a," ").concat(n," ").concat(o(t,"type"))}return i+=". Received type ".concat(typeof r)}),TypeError),a("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),a("ERR_METHOD_NOT_IMPLEMENTED",(function(e){return"The "+e+" method is not implemented"})),a("ERR_STREAM_PREMATURE_CLOSE","Premature close"),a("ERR_STREAM_DESTROYED",(function(e){return"Cannot call "+e+" after a stream was destroyed"})),a("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),a("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),a("ERR_STREAM_WRITE_AFTER_END","write after end"),a("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),a("ERR_UNKNOWN_ENCODING",(function(e){return"Unknown encoding: "+e}),TypeError),a("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event"),t.exports.codes=i},{}],63:[function(e,t,r){(function(r){(function(){var n=Object.keys||function(e){var t=[];for(var r in e)t.push(r);return t};t.exports=c;var i=e("./_stream_readable"),a=e("./_stream_writable");e("inherits")(c,i);for(var o=n(a.prototype),s=0;s<o.length;s++){var l=o[s];c.prototype[l]||(c.prototype[l]=a.prototype[l])}function c(e){if(!(this instanceof c))return new c(e);i.call(this,e),a.call(this,e),this.allowHalfOpen=!0,e&&(!1===e.readable&&(this.readable=!1),!1===e.writable&&(this.writable=!1),!1===e.allowHalfOpen&&(this.allowHalfOpen=!1,this.once("end",h)))}function h(){this._writableState.ended||r.nextTick(u,this)}function u(e){e.end()}Object.defineProperty(c.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(c.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(c.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(c.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&this._readableState.destroyed&&this._writableState.destroyed},set:function(e){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=e,this._writableState.destroyed=e)}})}).call(this)}).call(this,e("_process"))},{"./_stream_readable":65,"./_stream_writable":67,_process:60,inherits:45}],64:[function(e,t,r){t.exports=i;var n=e("./_stream_transform");function i(e){if(!(this instanceof i))return new i(e);n.call(this,e)}e("inherits")(i,n),i.prototype._transform=function(e,t,r){r(null,e)}},{"./_stream_transform":66,inherits:45}],65:[function(e,t,r){(function(r,n){(function(){var i;t.exports=C,C.ReadableState=E,e("events").EventEmitter;var a=function(e,t){return e.listeners(t).length},o=e("./internal/streams/stream"),s=e("buffer").Buffer,l=n.Uint8Array||function(){};function c(e){return s.from(e)}function h(e){return s.isBuffer(e)||e instanceof l}var u,d=e("util");u=d&&d.debuglog?d.debuglog("stream"):function(){};var p,f,m,g=e("./internal/streams/buffer_list"),y=e("./internal/streams/destroy"),v=e("./internal/streams/state").getHighWaterMark,b=e("../errors").codes,_=b.ERR_INVALID_ARG_TYPE,x=b.ERR_STREAM_PUSH_AFTER_EOF,w=b.ERR_METHOD_NOT_IMPLEMENTED,S=b.ERR_STREAM_UNSHIFT_AFTER_END_EVENT;e("inherits")(C,o);var M=y.errorOrDestroy,T=["error","close","destroy","pause","resume"];function A(e,t,r){if("function"==typeof e.prependListener)return e.prependListener(t,r);e._events&&e._events[t]?Array.isArray(e._events[t])?e._events[t].unshift(r):e._events[t]=[r,e._events[t]]:e.on(t,r)}function E(t,r,n){i=i||e("./_stream_duplex"),t=t||{},"boolean"!=typeof n&&(n=r instanceof i),this.objectMode=!!t.objectMode,n&&(this.objectMode=this.objectMode||!!t.readableObjectMode),this.highWaterMark=v(this,t,"readableHighWaterMark",n),this.buffer=new g,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=!1!==t.emitClose,this.autoDestroy=!!t.autoDestroy,this.destroyed=!1,this.defaultEncoding=t.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,t.encoding&&(p||(p=e("string_decoder/").StringDecoder),this.decoder=new p(t.encoding),this.encoding=t.encoding)}function C(t){if(i=i||e("./_stream_duplex"),!(this instanceof C))return new C(t);var r=this instanceof i;this._readableState=new E(t,this,r),this.readable=!0,t&&("function"==typeof t.read&&(this._read=t.read),"function"==typeof t.destroy&&(this._destroy=t.destroy)),o.call(this)}function L(e,t,r,n,i){u("readableAddChunk",t);var a,o=e._readableState;if(null===t)o.reading=!1,k(e,o);else if(i||(a=R(o,t)),a)M(e,a);else if(o.objectMode||t&&t.length>0)if("string"==typeof t||o.objectMode||Object.getPrototypeOf(t)===s.prototype||(t=c(t)),n)o.endEmitted?M(e,new S):D(e,o,t,!0);else if(o.ended)M(e,new x);else{if(o.destroyed)return!1;o.reading=!1,o.decoder&&!r?(t=o.decoder.write(t),o.objectMode||0!==t.length?D(e,o,t,!1):F(e,o)):D(e,o,t,!1)}else n||(o.reading=!1,F(e,o));return!o.ended&&(o.length<o.highWaterMark||0===o.length)}function D(e,t,r,n){t.flowing&&0===t.length&&!t.sync?(t.awaitDrain=0,e.emit("data",r)):(t.length+=t.objectMode?1:r.length,n?t.buffer.unshift(r):t.buffer.push(r),t.needReadable&&B(e)),F(e,t)}function R(e,t){var r;return h(t)||"string"==typeof t||void 0===t||e.objectMode||(r=new _("chunk",["string","Buffer","Uint8Array"],t)),r}Object.defineProperty(C.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(e){this._readableState&&(this._readableState.destroyed=e)}}),C.prototype.destroy=y.destroy,C.prototype._undestroy=y.undestroy,C.prototype._destroy=function(e,t){t(e)},C.prototype.push=function(e,t){var r,n=this._readableState;return n.objectMode?r=!0:"string"==typeof e&&((t=t||n.defaultEncoding)!==n.encoding&&(e=s.from(e,t),t=""),r=!0),L(this,e,t,!1,r)},C.prototype.unshift=function(e){return L(this,e,null,!0,!1)},C.prototype.isPaused=function(){return!1===this._readableState.flowing},C.prototype.setEncoding=function(t){p||(p=e("string_decoder/").StringDecoder);var r=new p(t);this._readableState.decoder=r,this._readableState.encoding=this._readableState.decoder.encoding;for(var n=this._readableState.buffer.head,i="";null!==n;)i+=r.write(n.data),n=n.next;return this._readableState.buffer.clear(),""!==i&&this._readableState.buffer.push(i),this._readableState.length=i.length,this};var P=1073741824;function O(e){return e>=P?e=P:(e--,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e++),e}function I(e,t){return e<=0||0===t.length&&t.ended?0:t.objectMode?1:e!=e?t.flowing&&t.length?t.buffer.head.data.length:t.length:(e>t.highWaterMark&&(t.highWaterMark=O(e)),e<=t.length?e:t.ended?t.length:(t.needReadable=!0,0))}function k(e,t){if(u("onEofChunk"),!t.ended){if(t.decoder){var r=t.decoder.end();r&&r.length&&(t.buffer.push(r),t.length+=t.objectMode?1:r.length)}t.ended=!0,t.sync?B(e):(t.needReadable=!1,t.emittedReadable||(t.emittedReadable=!0,N(e)))}}function B(e){var t=e._readableState;u("emitReadable",t.needReadable,t.emittedReadable),t.needReadable=!1,t.emittedReadable||(u("emitReadable",t.flowing),t.emittedReadable=!0,r.nextTick(N,e))}function N(e){var t=e._readableState;u("emitReadable_",t.destroyed,t.length,t.ended),t.destroyed||!t.length&&!t.ended||(e.emit("readable"),t.emittedReadable=!1),t.needReadable=!t.flowing&&!t.ended&&t.length<=t.highWaterMark,W(e)}function F(e,t){t.readingMore||(t.readingMore=!0,r.nextTick(U,e,t))}function U(e,t){for(;!t.reading&&!t.ended&&(t.length<t.highWaterMark||t.flowing&&0===t.length);){var r=t.length;if(u("maybeReadMore read 0"),e.read(0),r===t.length)break}t.readingMore=!1}function z(e){return function(){var t=e._readableState;u("pipeOnDrain",t.awaitDrain),t.awaitDrain&&t.awaitDrain--,0===t.awaitDrain&&a(e,"data")&&(t.flowing=!0,W(e))}}function H(e){var t=e._readableState;t.readableListening=e.listenerCount("readable")>0,t.resumeScheduled&&!t.paused?t.flowing=!0:e.listenerCount("data")>0&&e.resume()}function G(e){u("readable nexttick read 0"),e.read(0)}function V(e,t){t.resumeScheduled||(t.resumeScheduled=!0,r.nextTick(j,e,t))}function j(e,t){u("resume",t.reading),t.reading||e.read(0),t.resumeScheduled=!1,e.emit("resume"),W(e),t.flowing&&!t.reading&&e.read(0)}function W(e){var t=e._readableState;for(u("flow",t.flowing);t.flowing&&null!==e.read(););}function Y(e,t){return 0===t.length?null:(t.objectMode?r=t.buffer.shift():!e||e>=t.length?(r=t.decoder?t.buffer.join(""):1===t.buffer.length?t.buffer.first():t.buffer.concat(t.length),t.buffer.clear()):r=t.buffer.consume(e,t.decoder),r);var r}function X(e){var t=e._readableState;u("endReadable",t.endEmitted),t.endEmitted||(t.ended=!0,r.nextTick($,t,e))}function $(e,t){if(u("endReadableNT",e.endEmitted,e.length),!e.endEmitted&&0===e.length&&(e.endEmitted=!0,t.readable=!1,t.emit("end"),e.autoDestroy)){var r=t._writableState;(!r||r.autoDestroy&&r.finished)&&t.destroy()}}function Z(e,t){for(var r=0,n=e.length;r<n;r++)if(e[r]===t)return r;return-1}C.prototype.read=function(e){u("read",e),e=parseInt(e,10);var t=this._readableState,r=e;if(0!==e&&(t.emittedReadable=!1),0===e&&t.needReadable&&((0!==t.highWaterMark?t.length>=t.highWaterMark:t.length>0)||t.ended))return u("read: emitReadable",t.length,t.ended),0===t.length&&t.ended?X(this):B(this),null;if(0===(e=I(e,t))&&t.ended)return 0===t.length&&X(this),null;var n,i=t.needReadable;return u("need readable",i),(0===t.length||t.length-e<t.highWaterMark)&&u("length less than watermark",i=!0),t.ended||t.reading?u("reading or ended",i=!1):i&&(u("do read"),t.reading=!0,t.sync=!0,0===t.length&&(t.needReadable=!0),this._read(t.highWaterMark),t.sync=!1,t.reading||(e=I(r,t))),null===(n=e>0?Y(e,t):null)?(t.needReadable=t.length<=t.highWaterMark,e=0):(t.length-=e,t.awaitDrain=0),0===t.length&&(t.ended||(t.needReadable=!0),r!==e&&t.ended&&X(this)),null!==n&&this.emit("data",n),n},C.prototype._read=function(e){M(this,new w("_read()"))},C.prototype.pipe=function(e,t){var n=this,i=this._readableState;switch(i.pipesCount){case 0:i.pipes=e;break;case 1:i.pipes=[i.pipes,e];break;default:i.pipes.push(e)}i.pipesCount+=1,u("pipe count=%d opts=%j",i.pipesCount,t);var o=t&&!1===t.end||e===r.stdout||e===r.stderr?y:l;function s(e,t){u("onunpipe"),e===n&&t&&!1===t.hasUnpiped&&(t.hasUnpiped=!0,d())}function l(){u("onend"),e.end()}i.endEmitted?r.nextTick(o):n.once("end",o),e.on("unpipe",s);var c=z(n);e.on("drain",c);var h=!1;function d(){u("cleanup"),e.removeListener("close",m),e.removeListener("finish",g),e.removeListener("drain",c),e.removeListener("error",f),e.removeListener("unpipe",s),n.removeListener("end",l),n.removeListener("end",y),n.removeListener("data",p),h=!0,!i.awaitDrain||e._writableState&&!e._writableState.needDrain||c()}function p(t){u("ondata");var r=e.write(t);u("dest.write",r),!1===r&&((1===i.pipesCount&&i.pipes===e||i.pipesCount>1&&-1!==Z(i.pipes,e))&&!h&&(u("false write response, pause",i.awaitDrain),i.awaitDrain++),n.pause())}function f(t){u("onerror",t),y(),e.removeListener("error",f),0===a(e,"error")&&M(e,t)}function m(){e.removeListener("finish",g),y()}function g(){u("onfinish"),e.removeListener("close",m),y()}function y(){u("unpipe"),n.unpipe(e)}return n.on("data",p),A(e,"error",f),e.once("close",m),e.once("finish",g),e.emit("pipe",n),i.flowing||(u("pipe resume"),n.resume()),e},C.prototype.unpipe=function(e){var t=this._readableState,r={hasUnpiped:!1};if(0===t.pipesCount)return this;if(1===t.pipesCount)return e&&e!==t.pipes||(e||(e=t.pipes),t.pipes=null,t.pipesCount=0,t.flowing=!1,e&&e.emit("unpipe",this,r)),this;if(!e){var n=t.pipes,i=t.pipesCount;t.pipes=null,t.pipesCount=0,t.flowing=!1;for(var a=0;a<i;a++)n[a].emit("unpipe",this,{hasUnpiped:!1});return this}var o=Z(t.pipes,e);return-1===o||(t.pipes.splice(o,1),t.pipesCount-=1,1===t.pipesCount&&(t.pipes=t.pipes[0]),e.emit("unpipe",this,r)),this},C.prototype.on=function(e,t){var n=o.prototype.on.call(this,e,t),i=this._readableState;return"data"===e?(i.readableListening=this.listenerCount("readable")>0,!1!==i.flowing&&this.resume()):"readable"===e&&(i.endEmitted||i.readableListening||(i.readableListening=i.needReadable=!0,i.flowing=!1,i.emittedReadable=!1,u("on readable",i.length,i.reading),i.length?B(this):i.reading||r.nextTick(G,this))),n},C.prototype.addListener=C.prototype.on,C.prototype.removeListener=function(e,t){var n=o.prototype.removeListener.call(this,e,t);return"readable"===e&&r.nextTick(H,this),n},C.prototype.removeAllListeners=function(e){var t=o.prototype.removeAllListeners.apply(this,arguments);return"readable"!==e&&void 0!==e||r.nextTick(H,this),t},C.prototype.resume=function(){var e=this._readableState;return e.flowing||(u("resume"),e.flowing=!e.readableListening,V(this,e)),e.paused=!1,this},C.prototype.pause=function(){return u("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(u("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this},C.prototype.wrap=function(e){var t=this,r=this._readableState,n=!1;for(var i in e.on("end",(function(){if(u("wrapped end"),r.decoder&&!r.ended){var e=r.decoder.end();e&&e.length&&t.push(e)}t.push(null)})),e.on("data",(function(i){u("wrapped data"),r.decoder&&(i=r.decoder.write(i)),r.objectMode&&null==i||(r.objectMode||i&&i.length)&&(t.push(i)||(n=!0,e.pause()))})),e)void 0===this[i]&&"function"==typeof e[i]&&(this[i]=function(t){return function(){return e[t].apply(e,arguments)}}(i));for(var a=0;a<T.length;a++)e.on(T[a],this.emit.bind(this,T[a]));return this._read=function(t){u("wrapped _read",t),n&&(n=!1,e.resume())},this},"function"==typeof Symbol&&(C.prototype[Symbol.asyncIterator]=function(){return void 0===f&&(f=e("./internal/streams/async_iterator")),f(this)}),Object.defineProperty(C.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(C.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(C.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(e){this._readableState&&(this._readableState.flowing=e)}}),C._fromList=Y,Object.defineProperty(C.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}}),"function"==typeof Symbol&&(C.from=function(t,r){return void 0===m&&(m=e("./internal/streams/from")),m(C,t,r)})}).call(this)}).call(this,e("_process"),void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../errors":62,"./_stream_duplex":63,"./internal/streams/async_iterator":68,"./internal/streams/buffer_list":69,"./internal/streams/destroy":70,"./internal/streams/from":72,"./internal/streams/state":74,"./internal/streams/stream":75,_process:60,buffer:33,events:38,inherits:45,"string_decoder/":76,util:30}],66:[function(e,t,r){t.exports=h;var n=e("../errors").codes,i=n.ERR_METHOD_NOT_IMPLEMENTED,a=n.ERR_MULTIPLE_CALLBACK,o=n.ERR_TRANSFORM_ALREADY_TRANSFORMING,s=n.ERR_TRANSFORM_WITH_LENGTH_0,l=e("./_stream_duplex");function c(e,t){var r=this._transformState;r.transforming=!1;var n=r.writecb;if(null===n)return this.emit("error",new a);r.writechunk=null,r.writecb=null,null!=t&&this.push(t),n(e);var i=this._readableState;i.reading=!1,(i.needReadable||i.length<i.highWaterMark)&&this._read(i.highWaterMark)}function h(e){if(!(this instanceof h))return new h(e);l.call(this,e),this._transformState={afterTransform:c.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,e&&("function"==typeof e.transform&&(this._transform=e.transform),"function"==typeof e.flush&&(this._flush=e.flush)),this.on("prefinish",u)}function u(){var e=this;"function"!=typeof this._flush||this._readableState.destroyed?d(this,null,null):this._flush((function(t,r){d(e,t,r)}))}function d(e,t,r){if(t)return e.emit("error",t);if(null!=r&&e.push(r),e._writableState.length)throw new s;if(e._transformState.transforming)throw new o;return e.push(null)}e("inherits")(h,l),h.prototype.push=function(e,t){return this._transformState.needTransform=!1,l.prototype.push.call(this,e,t)},h.prototype._transform=function(e,t,r){r(new i("_transform()"))},h.prototype._write=function(e,t,r){var n=this._transformState;if(n.writecb=r,n.writechunk=e,n.writeencoding=t,!n.transforming){var i=this._readableState;(n.needTransform||i.needReadable||i.length<i.highWaterMark)&&this._read(i.highWaterMark)}},h.prototype._read=function(e){var t=this._transformState;null===t.writechunk||t.transforming?t.needTransform=!0:(t.transforming=!0,this._transform(t.writechunk,t.writeencoding,t.afterTransform))},h.prototype._destroy=function(e,t){l.prototype._destroy.call(this,e,(function(e){t(e)}))}},{"../errors":62,"./_stream_duplex":63,inherits:45}],67:[function(e,t,r){(function(r,n){(function(){function i(e){var t=this;this.next=null,this.entry=null,this.finish=function(){j(t,e)}}var a;t.exports=E,E.WritableState=A;var o={deprecate:e("util-deprecate")},s=e("./internal/streams/stream"),l=e("buffer").Buffer,c=n.Uint8Array||function(){};function h(e){return l.from(e)}function u(e){return l.isBuffer(e)||e instanceof c}var d,p=e("./internal/streams/destroy"),f=e("./internal/streams/state").getHighWaterMark,m=e("../errors").codes,g=m.ERR_INVALID_ARG_TYPE,y=m.ERR_METHOD_NOT_IMPLEMENTED,v=m.ERR_MULTIPLE_CALLBACK,b=m.ERR_STREAM_CANNOT_PIPE,_=m.ERR_STREAM_DESTROYED,x=m.ERR_STREAM_NULL_VALUES,w=m.ERR_STREAM_WRITE_AFTER_END,S=m.ERR_UNKNOWN_ENCODING,M=p.errorOrDestroy;function T(){}function A(t,r,n){a=a||e("./_stream_duplex"),t=t||{},"boolean"!=typeof n&&(n=r instanceof a),this.objectMode=!!t.objectMode,n&&(this.objectMode=this.objectMode||!!t.writableObjectMode),this.highWaterMark=f(this,t,"writableHighWaterMark",n),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var o=!1===t.decodeStrings;this.decodeStrings=!o,this.defaultEncoding=t.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){k(r,e)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=!1!==t.emitClose,this.autoDestroy=!!t.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new i(this)}function E(t){var r=this instanceof(a=a||e("./_stream_duplex"));if(!r&&!d.call(E,this))return new E(t);this._writableState=new A(t,this,r),this.writable=!0,t&&("function"==typeof t.write&&(this._write=t.write),"function"==typeof t.writev&&(this._writev=t.writev),"function"==typeof t.destroy&&(this._destroy=t.destroy),"function"==typeof t.final&&(this._final=t.final)),s.call(this)}function C(e,t){var n=new w;M(e,n),r.nextTick(t,n)}function L(e,t,n,i){var a;return null===n?a=new x:"string"==typeof n||t.objectMode||(a=new g("chunk",["string","Buffer"],n)),!a||(M(e,a),r.nextTick(i,a),!1)}function D(e,t,r){return e.objectMode||!1===e.decodeStrings||"string"!=typeof t||(t=l.from(t,r)),t}function R(e,t,r,n,i,a){if(!r){var o=D(t,n,i);n!==o&&(r=!0,i="buffer",n=o)}var s=t.objectMode?1:n.length;t.length+=s;var l=t.length<t.highWaterMark;if(l||(t.needDrain=!0),t.writing||t.corked){var c=t.lastBufferedRequest;t.lastBufferedRequest={chunk:n,encoding:i,isBuf:r,callback:a,next:null},c?c.next=t.lastBufferedRequest:t.bufferedRequest=t.lastBufferedRequest,t.bufferedRequestCount+=1}else P(e,t,!1,s,n,i,a);return l}function P(e,t,r,n,i,a,o){t.writelen=n,t.writecb=o,t.writing=!0,t.sync=!0,t.destroyed?t.onwrite(new _("write")):r?e._writev(i,t.onwrite):e._write(i,a,t.onwrite),t.sync=!1}function O(e,t,n,i,a){--t.pendingcb,n?(r.nextTick(a,i),r.nextTick(G,e,t),e._writableState.errorEmitted=!0,M(e,i)):(a(i),e._writableState.errorEmitted=!0,M(e,i),G(e,t))}function I(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}function k(e,t){var n=e._writableState,i=n.sync,a=n.writecb;if("function"!=typeof a)throw new v;if(I(n),t)O(e,n,i,t,a);else{var o=U(n)||e.destroyed;o||n.corked||n.bufferProcessing||!n.bufferedRequest||F(e,n),i?r.nextTick(B,e,n,o,a):B(e,n,o,a)}}function B(e,t,r,n){r||N(e,t),t.pendingcb--,n(),G(e,t)}function N(e,t){0===t.length&&t.needDrain&&(t.needDrain=!1,e.emit("drain"))}function F(e,t){t.bufferProcessing=!0;var r=t.bufferedRequest;if(e._writev&&r&&r.next){var n=t.bufferedRequestCount,a=new Array(n),o=t.corkedRequestsFree;o.entry=r;for(var s=0,l=!0;r;)a[s]=r,r.isBuf||(l=!1),r=r.next,s+=1;a.allBuffers=l,P(e,t,!0,t.length,a,"",o.finish),t.pendingcb++,t.lastBufferedRequest=null,o.next?(t.corkedRequestsFree=o.next,o.next=null):t.corkedRequestsFree=new i(t),t.bufferedRequestCount=0}else{for(;r;){var c=r.chunk,h=r.encoding,u=r.callback;if(P(e,t,!1,t.objectMode?1:c.length,c,h,u),r=r.next,t.bufferedRequestCount--,t.writing)break}null===r&&(t.lastBufferedRequest=null)}t.bufferedRequest=r,t.bufferProcessing=!1}function U(e){return e.ending&&0===e.length&&null===e.bufferedRequest&&!e.finished&&!e.writing}function z(e,t){e._final((function(r){t.pendingcb--,r&&M(e,r),t.prefinished=!0,e.emit("prefinish"),G(e,t)}))}function H(e,t){t.prefinished||t.finalCalled||("function"!=typeof e._final||t.destroyed?(t.prefinished=!0,e.emit("prefinish")):(t.pendingcb++,t.finalCalled=!0,r.nextTick(z,e,t)))}function G(e,t){var r=U(t);if(r&&(H(e,t),0===t.pendingcb&&(t.finished=!0,e.emit("finish"),t.autoDestroy))){var n=e._readableState;(!n||n.autoDestroy&&n.endEmitted)&&e.destroy()}return r}function V(e,t,n){t.ending=!0,G(e,t),n&&(t.finished?r.nextTick(n):e.once("finish",n)),t.ended=!0,e.writable=!1}function j(e,t,r){var n=e.entry;for(e.entry=null;n;){var i=n.callback;t.pendingcb--,i(r),n=n.next}t.corkedRequestsFree.next=e}e("inherits")(E,s),A.prototype.getBuffer=function(){for(var e=this.bufferedRequest,t=[];e;)t.push(e),e=e.next;return t},function(){try{Object.defineProperty(A.prototype,"buffer",{get:o.deprecate((function(){return this.getBuffer()}),"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(e){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(d=Function.prototype[Symbol.hasInstance],Object.defineProperty(E,Symbol.hasInstance,{value:function(e){return!!d.call(this,e)||this===E&&e&&e._writableState instanceof A}})):d=function(e){return e instanceof this},E.prototype.pipe=function(){M(this,new b)},E.prototype.write=function(e,t,r){var n=this._writableState,i=!1,a=!n.objectMode&&u(e);return a&&!l.isBuffer(e)&&(e=h(e)),"function"==typeof t&&(r=t,t=null),a?t="buffer":t||(t=n.defaultEncoding),"function"!=typeof r&&(r=T),n.ending?C(this,r):(a||L(this,n,e,r))&&(n.pendingcb++,i=R(this,n,a,e,t,r)),i},E.prototype.cork=function(){this._writableState.corked++},E.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,e.writing||e.corked||e.bufferProcessing||!e.bufferedRequest||F(this,e))},E.prototype.setDefaultEncoding=function(e){if("string"==typeof e&&(e=e.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((e+"").toLowerCase())>-1))throw new S(e);return this._writableState.defaultEncoding=e,this},Object.defineProperty(E.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(E.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),E.prototype._write=function(e,t,r){r(new y("_write()"))},E.prototype._writev=null,E.prototype.end=function(e,t,r){var n=this._writableState;return"function"==typeof e?(r=e,e=null,t=null):"function"==typeof t&&(r=t,t=null),null!=e&&this.write(e,t),n.corked&&(n.corked=1,this.uncork()),n.ending||V(this,n,r),this},Object.defineProperty(E.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(E.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(e){this._writableState&&(this._writableState.destroyed=e)}}),E.prototype.destroy=p.destroy,E.prototype._undestroy=p.undestroy,E.prototype._destroy=function(e,t){t(e)}}).call(this)}).call(this,e("_process"),void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../errors":62,"./_stream_duplex":63,"./internal/streams/destroy":70,"./internal/streams/state":74,"./internal/streams/stream":75,_process:60,buffer:33,inherits:45,"util-deprecate":78}],68:[function(e,t,r){(function(r){(function(){var n;function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var a=e("./end-of-stream"),o=Symbol("lastResolve"),s=Symbol("lastReject"),l=Symbol("error"),c=Symbol("ended"),h=Symbol("lastPromise"),u=Symbol("handlePromise"),d=Symbol("stream");function p(e,t){return{value:e,done:t}}function f(e){var t=e[o];if(null!==t){var r=e[d].read();null!==r&&(e[h]=null,e[o]=null,e[s]=null,t(p(r,!1)))}}function m(e){r.nextTick(f,e)}function g(e,t){return function(r,n){e.then((function(){t[c]?r(p(void 0,!0)):t[u](r,n)}),n)}}var y=Object.getPrototypeOf((function(){})),v=Object.setPrototypeOf((i(n={get stream(){return this[d]},next:function(){var e=this,t=this[l];if(null!==t)return Promise.reject(t);if(this[c])return Promise.resolve(p(void 0,!0));if(this[d].destroyed)return new Promise((function(t,n){r.nextTick((function(){e[l]?n(e[l]):t(p(void 0,!0))}))}));var n,i=this[h];if(i)n=new Promise(g(i,this));else{var a=this[d].read();if(null!==a)return Promise.resolve(p(a,!1));n=new Promise(this[u])}return this[h]=n,n}},Symbol.asyncIterator,(function(){return this})),i(n,"return",(function(){var e=this;return new Promise((function(t,r){e[d].destroy(null,(function(e){e?r(e):t(p(void 0,!0))}))}))})),n),y),b=function(e){var t,r=Object.create(v,(i(t={},d,{value:e,writable:!0}),i(t,o,{value:null,writable:!0}),i(t,s,{value:null,writable:!0}),i(t,l,{value:null,writable:!0}),i(t,c,{value:e._readableState.endEmitted,writable:!0}),i(t,u,{value:function(e,t){var n=r[d].read();n?(r[h]=null,r[o]=null,r[s]=null,e(p(n,!1))):(r[o]=e,r[s]=t)},writable:!0}),t));return r[h]=null,a(e,(function(e){if(e&&"ERR_STREAM_PREMATURE_CLOSE"!==e.code){var t=r[s];return null!==t&&(r[h]=null,r[o]=null,r[s]=null,t(e)),void(r[l]=e)}var n=r[o];null!==n&&(r[h]=null,r[o]=null,r[s]=null,n(p(void 0,!0))),r[c]=!0})),e.on("readable",m.bind(null,r)),r};t.exports=b}).call(this)}).call(this,e("_process"))},{"./end-of-stream":71,_process:60}],69:[function(e,t,r){function n(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?n(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):n(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function l(e,t,r){return t&&s(e.prototype,t),r&&s(e,r),e}var c=e("buffer").Buffer,h=e("util").inspect,u=h&&h.custom||"inspect";function d(e,t,r){c.prototype.copy.call(e,t,r)}t.exports=function(){function e(){o(this,e),this.head=null,this.tail=null,this.length=0}return l(e,[{key:"push",value:function(e){var t={data:e,next:null};this.length>0?this.tail.next=t:this.head=t,this.tail=t,++this.length}},{key:"unshift",value:function(e){var t={data:e,next:this.head};0===this.length&&(this.tail=t),this.head=t,++this.length}},{key:"shift",value:function(){if(0!==this.length){var e=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,e}}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(e){if(0===this.length)return"";for(var t=this.head,r=""+t.data;t=t.next;)r+=e+t.data;return r}},{key:"concat",value:function(e){if(0===this.length)return c.alloc(0);for(var t=c.allocUnsafe(e>>>0),r=this.head,n=0;r;)d(r.data,t,n),n+=r.data.length,r=r.next;return t}},{key:"consume",value:function(e,t){var r;return e<this.head.data.length?(r=this.head.data.slice(0,e),this.head.data=this.head.data.slice(e)):r=e===this.head.data.length?this.shift():t?this._getString(e):this._getBuffer(e),r}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(e){var t=this.head,r=1,n=t.data;for(e-=n.length;t=t.next;){var i=t.data,a=e>i.length?i.length:e;if(a===i.length?n+=i:n+=i.slice(0,e),0==(e-=a)){a===i.length?(++r,t.next?this.head=t.next:this.head=this.tail=null):(this.head=t,t.data=i.slice(a));break}++r}return this.length-=r,n}},{key:"_getBuffer",value:function(e){var t=c.allocUnsafe(e),r=this.head,n=1;for(r.data.copy(t),e-=r.data.length;r=r.next;){var i=r.data,a=e>i.length?i.length:e;if(i.copy(t,t.length-e,0,a),0==(e-=a)){a===i.length?(++n,r.next?this.head=r.next:this.head=this.tail=null):(this.head=r,r.data=i.slice(a));break}++n}return this.length-=n,t}},{key:u,value:function(e,t){return h(this,i({},t,{depth:0,customInspect:!1}))}}]),e}()},{buffer:33,util:30}],70:[function(e,t,r){(function(e){(function(){function r(t,r){var a=this,s=this._readableState&&this._readableState.destroyed,l=this._writableState&&this._writableState.destroyed;return s||l?(r?r(t):t&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,e.nextTick(o,this,t)):e.nextTick(o,this,t)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(t||null,(function(t){!r&&t?a._writableState?a._writableState.errorEmitted?e.nextTick(i,a):(a._writableState.errorEmitted=!0,e.nextTick(n,a,t)):e.nextTick(n,a,t):r?(e.nextTick(i,a),r(t)):e.nextTick(i,a)})),this)}function n(e,t){o(e,t),i(e)}function i(e){e._writableState&&!e._writableState.emitClose||e._readableState&&!e._readableState.emitClose||e.emit("close")}function a(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}function o(e,t){e.emit("error",t)}function s(e,t){var r=e._readableState,n=e._writableState;r&&r.autoDestroy||n&&n.autoDestroy?e.destroy(t):e.emit("error",t)}t.exports={destroy:r,undestroy:a,errorOrDestroy:s}}).call(this)}).call(this,e("_process"))},{_process:60}],71:[function(e,t,r){var n=e("../../../errors").codes.ERR_STREAM_PREMATURE_CLOSE;function i(e){var t=!1;return function(){if(!t){t=!0;for(var r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];e.apply(this,n)}}}function a(){}function o(e){return e.setHeader&&"function"==typeof e.abort}function s(e,t,r){if("function"==typeof t)return s(e,null,t);t||(t={}),r=i(r||a);var l=t.readable||!1!==t.readable&&e.readable,c=t.writable||!1!==t.writable&&e.writable,h=function(){e.writable||d()},u=e._writableState&&e._writableState.finished,d=function(){c=!1,u=!0,l||r.call(e)},p=e._readableState&&e._readableState.endEmitted,f=function(){l=!1,p=!0,c||r.call(e)},m=function(t){r.call(e,t)},g=function(){var t;return l&&!p?(e._readableState&&e._readableState.ended||(t=new n),r.call(e,t)):c&&!u?(e._writableState&&e._writableState.ended||(t=new n),r.call(e,t)):void 0},y=function(){e.req.on("finish",d)};return o(e)?(e.on("complete",d),e.on("abort",g),e.req?y():e.on("request",y)):c&&!e._writableState&&(e.on("end",h),e.on("close",h)),e.on("end",f),e.on("finish",d),!1!==t.error&&e.on("error",m),e.on("close",g),function(){e.removeListener("complete",d),e.removeListener("abort",g),e.removeListener("request",y),e.req&&e.req.removeListener("finish",d),e.removeListener("end",h),e.removeListener("close",h),e.removeListener("finish",d),e.removeListener("end",f),e.removeListener("error",m),e.removeListener("close",g)}}t.exports=s},{"../../../errors":62}],72:[function(e,t,r){t.exports=function(){throw new Error("Readable.from is not available in the browser")}},{}],73:[function(e,t,r){var n;function i(e){var t=!1;return function(){t||(t=!0,e.apply(void 0,arguments))}}var a=e("../../../errors").codes,o=a.ERR_MISSING_ARGS,s=a.ERR_STREAM_DESTROYED;function l(e){if(e)throw e}function c(e){return e.setHeader&&"function"==typeof e.abort}function h(t,r,a,o){o=i(o);var l=!1;t.on("close",(function(){l=!0})),void 0===n&&(n=e("./end-of-stream")),n(t,{readable:r,writable:a},(function(e){if(e)return o(e);l=!0,o()}));var h=!1;return function(e){if(!l&&!h)return h=!0,c(t)?t.abort():"function"==typeof t.destroy?t.destroy():void o(e||new s("pipe"))}}function u(e){e()}function d(e,t){return e.pipe(t)}function p(e){return e.length?"function"!=typeof e[e.length-1]?l:e.pop():l}function f(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];var n,i=p(t);if(Array.isArray(t[0])&&(t=t[0]),t.length<2)throw new o("streams");var a=t.map((function(e,r){var o=r<t.length-1;return h(e,o,r>0,(function(e){n||(n=e),e&&a.forEach(u),o||(a.forEach(u),i(n))}))}));return t.reduce(d)}t.exports=f},{"../../../errors":62,"./end-of-stream":71}],74:[function(e,t,r){var n=e("../../../errors").codes.ERR_INVALID_OPT_VALUE;function i(e,t,r){return null!=e.highWaterMark?e.highWaterMark:t?e[r]:null}function a(e,t,r,a){var o=i(t,a,r);if(null!=o){if(!isFinite(o)||Math.floor(o)!==o||o<0)throw new n(a?r:"highWaterMark",o);return Math.floor(o)}return e.objectMode?16:16384}t.exports={getHighWaterMark:a}},{"../../../errors":62}],75:[function(e,t,r){t.exports=e("events").EventEmitter},{events:38}],76:[function(e,t,r){var n=e("safe-buffer").Buffer,i=n.isEncoding||function(e){switch((e=""+e)&&e.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function a(e){if(!e)return"utf8";for(var t;;)switch(e){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:if(t)return;e=(""+e).toLowerCase(),t=!0}}function o(e){var t=a(e);if("string"!=typeof t&&(n.isEncoding===i||!i(e)))throw new Error("Unknown encoding: "+e);return t||e}function s(e){var t;switch(this.encoding=o(e),this.encoding){case"utf16le":this.text=f,this.end=m,t=4;break;case"utf8":this.fillLast=u,t=4;break;case"base64":this.text=g,this.end=y,t=3;break;default:return this.write=v,void(this.end=b)}this.lastNeed=0,this.lastTotal=0,this.lastChar=n.allocUnsafe(t)}function l(e){return e<=127?0:e>>5==6?2:e>>4==14?3:e>>3==30?4:e>>6==2?-1:-2}function c(e,t,r){var n=t.length-1;if(n<r)return 0;var i=l(t[n]);return i>=0?(i>0&&(e.lastNeed=i-1),i):--n<r||-2===i?0:(i=l(t[n]))>=0?(i>0&&(e.lastNeed=i-2),i):--n<r||-2===i?0:(i=l(t[n]))>=0?(i>0&&(2===i?i=0:e.lastNeed=i-3),i):0}function h(e,t,r){if(128!=(192&t[0]))return e.lastNeed=0,"�";if(e.lastNeed>1&&t.length>1){if(128!=(192&t[1]))return e.lastNeed=1,"�";if(e.lastNeed>2&&t.length>2&&128!=(192&t[2]))return e.lastNeed=2,"�"}}function u(e){var t=this.lastTotal-this.lastNeed,r=h(this,e);return void 0!==r?r:this.lastNeed<=e.length?(e.copy(this.lastChar,t,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(e.copy(this.lastChar,t,0,e.length),void(this.lastNeed-=e.length))}function d(e,t){var r=c(this,e,t);if(!this.lastNeed)return e.toString("utf8",t);this.lastTotal=r;var n=e.length-(r-this.lastNeed);return e.copy(this.lastChar,0,n),e.toString("utf8",t,n)}function p(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+"�":t}function f(e,t){if((e.length-t)%2==0){var r=e.toString("utf16le",t);if(r){var n=r.charCodeAt(r.length-1);if(n>=55296&&n<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1],r.slice(0,-1)}return r}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=e[e.length-1],e.toString("utf16le",t,e.length-1)}function m(e){var t=e&&e.length?this.write(e):"";if(this.lastNeed){var r=this.lastTotal-this.lastNeed;return t+this.lastChar.toString("utf16le",0,r)}return t}function g(e,t){var r=(e.length-t)%3;return 0===r?e.toString("base64",t):(this.lastNeed=3-r,this.lastTotal=3,1===r?this.lastChar[0]=e[e.length-1]:(this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1]),e.toString("base64",t,e.length-r))}function y(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+this.lastChar.toString("base64",0,3-this.lastNeed):t}function v(e){return e.toString(this.encoding)}function b(e){return e&&e.length?this.write(e):""}r.StringDecoder=s,s.prototype.write=function(e){if(0===e.length)return"";var t,r;if(this.lastNeed){if(void 0===(t=this.fillLast(e)))return"";r=this.lastNeed,this.lastNeed=0}else r=0;return r<e.length?t?t+this.text(e,r):this.text(e,r):t||""},s.prototype.end=p,s.prototype.text=d,s.prototype.fillLast=function(e){if(this.lastNeed<=e.length)return e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,e.length),this.lastNeed-=e.length}},{"safe-buffer":77}],77:[function(e,t,r){/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */var n=e("buffer"),i=n.Buffer;function a(e,t){for(var r in e)t[r]=e[r]}function o(e,t,r){return i(e,t,r)}i.from&&i.alloc&&i.allocUnsafe&&i.allocUnsafeSlow?t.exports=n:(a(n,r),r.Buffer=o),o.prototype=Object.create(i.prototype),a(i,o),o.from=function(e,t,r){if("number"==typeof e)throw new TypeError("Argument must not be a number");return i(e,t,r)},o.alloc=function(e,t,r){if("number"!=typeof e)throw new TypeError("Argument must be a number");var n=i(e);return void 0!==t?"string"==typeof r?n.fill(t,r):n.fill(t):n.fill(0),n},o.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return i(e)},o.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return n.SlowBuffer(e)}},{buffer:33}],78:[function(e,t,r){(function(e){(function(){function r(e,t){if(n("noDeprecation"))return e;var r=!1;function i(){if(!r){if(n("throwDeprecation"))throw new Error(t);n("traceDeprecation")?console.trace(t):console.warn(t),r=!0}return e.apply(this,arguments)}return i}function n(t){try{if(!e.localStorage)return!1}catch(e){return!1}var r=e.localStorage[t];return null!=r&&"true"===String(r).toLowerCase()}t.exports=r}).call(this)}).call(this,void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],79:[function(e,t,r){arguments[4][25][0].apply(r,arguments)},{dup:25}],80:[function(e,t,r){var n=e("is-arguments"),i=e("is-generator-function"),a=e("which-typed-array"),o=e("is-typed-array");function s(e){return e.call.bind(e)}var l="undefined"!=typeof BigInt,c="undefined"!=typeof Symbol,h=s(Object.prototype.toString),u=s(Number.prototype.valueOf),d=s(String.prototype.valueOf),p=s(Boolean.prototype.valueOf);if(l)var f=s(BigInt.prototype.valueOf);if(c)var m=s(Symbol.prototype.valueOf);function g(e,t){if("object"!=typeof e)return!1;try{return t(e),!0}catch(e){return!1}}function y(e){return"undefined"!=typeof Promise&&e instanceof Promise||null!==e&&"object"==typeof e&&"function"==typeof e.then&&"function"==typeof e.catch}function v(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):o(e)||H(e)}function b(e){return"Uint8Array"===a(e)}function _(e){return"Uint8ClampedArray"===a(e)}function x(e){return"Uint16Array"===a(e)}function w(e){return"Uint32Array"===a(e)}function S(e){return"Int8Array"===a(e)}function M(e){return"Int16Array"===a(e)}function T(e){return"Int32Array"===a(e)}function A(e){return"Float32Array"===a(e)}function E(e){return"Float64Array"===a(e)}function C(e){return"BigInt64Array"===a(e)}function L(e){return"BigUint64Array"===a(e)}function D(e){return"[object Map]"===h(e)}function R(e){return"undefined"!=typeof Map&&(D.working?D(e):e instanceof Map)}function P(e){return"[object Set]"===h(e)}function O(e){return"undefined"!=typeof Set&&(P.working?P(e):e instanceof Set)}function I(e){return"[object WeakMap]"===h(e)}function k(e){return"undefined"!=typeof WeakMap&&(I.working?I(e):e instanceof WeakMap)}function B(e){return"[object WeakSet]"===h(e)}function N(e){return B(e)}function F(e){return"[object ArrayBuffer]"===h(e)}function U(e){return"undefined"!=typeof ArrayBuffer&&(F.working?F(e):e instanceof ArrayBuffer)}function z(e){return"[object DataView]"===h(e)}function H(e){return"undefined"!=typeof DataView&&(z.working?z(e):e instanceof DataView)}function G(e){return"[object SharedArrayBuffer]"===h(e)}function V(e){return"undefined"!=typeof SharedArrayBuffer&&(G.working?G(e):e instanceof SharedArrayBuffer)}function j(e){return"[object AsyncFunction]"===h(e)}function W(e){return"[object Map Iterator]"===h(e)}function Y(e){return"[object Set Iterator]"===h(e)}function X(e){return"[object Generator]"===h(e)}function $(e){return"[object WebAssembly.Module]"===h(e)}function Z(e){return g(e,u)}function q(e){return g(e,d)}function J(e){return g(e,p)}function Q(e){return l&&g(e,f)}function K(e){return c&&g(e,m)}function ee(e){return Z(e)||q(e)||J(e)||Q(e)||K(e)}function te(e){return"undefined"!=typeof Uint8Array&&(U(e)||V(e))}r.isArgumentsObject=n,r.isGeneratorFunction=i,r.isTypedArray=o,r.isPromise=y,r.isArrayBufferView=v,r.isUint8Array=b,r.isUint8ClampedArray=_,r.isUint16Array=x,r.isUint32Array=w,r.isInt8Array=S,r.isInt16Array=M,r.isInt32Array=T,r.isFloat32Array=A,r.isFloat64Array=E,r.isBigInt64Array=C,r.isBigUint64Array=L,D.working="undefined"!=typeof Map&&D(new Map),r.isMap=R,P.working="undefined"!=typeof Set&&P(new Set),r.isSet=O,I.working="undefined"!=typeof WeakMap&&I(new WeakMap),r.isWeakMap=k,B.working="undefined"!=typeof WeakSet&&B(new WeakSet),r.isWeakSet=N,F.working="undefined"!=typeof ArrayBuffer&&F(new ArrayBuffer),r.isArrayBuffer=U,z.working="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView&&z(new DataView(new ArrayBuffer(1),0,1)),r.isDataView=H,G.working="undefined"!=typeof SharedArrayBuffer&&G(new SharedArrayBuffer),r.isSharedArrayBuffer=V,r.isAsyncFunction=j,r.isMapIterator=W,r.isSetIterator=Y,r.isGeneratorObject=X,r.isWebAssemblyCompiledModule=$,r.isNumberObject=Z,r.isStringObject=q,r.isBooleanObject=J,r.isBigIntObject=Q,r.isSymbolObject=K,r.isBoxedPrimitive=ee,r.isAnyArrayBuffer=te,["isProxy","isExternal","isModuleNamespaceObject"].forEach((function(e){Object.defineProperty(r,e,{enumerable:!1,value:function(){throw new Error(e+" is not supported in userland")}})}))},{"is-arguments":46,"is-generator-function":47,"is-typed-array":48,"which-typed-array":82}],81:[function(e,t,r){(function(t){(function(){var n=Object.getOwnPropertyDescriptors||function(e){for(var t=Object.keys(e),r={},n=0;n<t.length;n++)r[t[n]]=Object.getOwnPropertyDescriptor(e,t[n]);return r},i=/%[sdj%]/g;r.format=function(e){if(!S(e)){for(var t=[],r=0;r<arguments.length;r++)t.push(l(arguments[r]));return t.join(" ")}r=1;for(var n=arguments,a=n.length,o=String(e).replace(i,(function(e){if("%%"===e)return"%";if(r>=a)return e;switch(e){case"%s":return String(n[r++]);case"%d":return Number(n[r++]);case"%j":try{return JSON.stringify(n[r++])}catch(e){return"[Circular]"}default:return e}})),s=n[r];r<a;s=n[++r])_(s)||!E(s)?o+=" "+s:o+=" "+l(s);return o},r.deprecate=function(e,n){if(void 0!==t&&!0===t.noDeprecation)return e;if(void 0===t)return function(){return r.deprecate(e,n).apply(this,arguments)};var i=!1;function a(){if(!i){if(t.throwDeprecation)throw new Error(n);t.traceDeprecation?console.trace(n):console.error(n),i=!0}return e.apply(this,arguments)}return a};var a={},o=/^$/;if(t.env.NODE_DEBUG){var s=t.env.NODE_DEBUG;s=s.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".*").replace(/,/g,"$|^").toUpperCase(),o=new RegExp("^"+s+"$","i")}function l(e,t){var n={seen:[],stylize:h};return arguments.length>=3&&(n.depth=arguments[2]),arguments.length>=4&&(n.colors=arguments[3]),b(t)?n.showHidden=t:t&&r._extend(n,t),T(n.showHidden)&&(n.showHidden=!1),T(n.depth)&&(n.depth=2),T(n.colors)&&(n.colors=!1),T(n.customInspect)&&(n.customInspect=!0),n.colors&&(n.stylize=c),d(n,e,n.depth)}function c(e,t){var r=l.styles[t];return r?"["+l.colors[r][0]+"m"+e+"["+l.colors[r][1]+"m":e}function h(e,t){return e}function u(e){var t={};return e.forEach((function(e,r){t[e]=!0})),t}function d(e,t,n){if(e.customInspect&&t&&D(t.inspect)&&t.inspect!==r.inspect&&(!t.constructor||t.constructor.prototype!==t)){var i=t.inspect(n,e);return S(i)||(i=d(e,i,n)),i}var a=p(e,t);if(a)return a;var o=Object.keys(t),s=u(o);if(e.showHidden&&(o=Object.getOwnPropertyNames(t)),L(t)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return f(t);if(0===o.length){if(D(t)){var l=t.name?": "+t.name:"";return e.stylize("[Function"+l+"]","special")}if(A(t))return e.stylize(RegExp.prototype.toString.call(t),"regexp");if(C(t))return e.stylize(Date.prototype.toString.call(t),"date");if(L(t))return f(t)}var c,h="",b=!1,_=["{","}"];return v(t)&&(b=!0,_=["[","]"]),D(t)&&(h=" [Function"+(t.name?": "+t.name:"")+"]"),A(t)&&(h=" "+RegExp.prototype.toString.call(t)),C(t)&&(h=" "+Date.prototype.toUTCString.call(t)),L(t)&&(h=" "+f(t)),0!==o.length||b&&0!=t.length?n<0?A(t)?e.stylize(RegExp.prototype.toString.call(t),"regexp"):e.stylize("[Object]","special"):(e.seen.push(t),c=b?m(e,t,n,s,o):o.map((function(r){return g(e,t,n,s,r,b)})),e.seen.pop(),y(c,h,_)):_[0]+h+_[1]}function p(e,t){if(T(t))return e.stylize("undefined","undefined");if(S(t)){var r="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(r,"string")}return w(t)?e.stylize(""+t,"number"):b(t)?e.stylize(""+t,"boolean"):_(t)?e.stylize("null","null"):void 0}function f(e){return"["+Error.prototype.toString.call(e)+"]"}function m(e,t,r,n,i){for(var a=[],o=0,s=t.length;o<s;++o)B(t,String(o))?a.push(g(e,t,r,n,String(o),!0)):a.push("");return i.forEach((function(i){i.match(/^\d+$/)||a.push(g(e,t,r,n,i,!0))})),a}function g(e,t,r,n,i,a){var o,s,l;if((l=Object.getOwnPropertyDescriptor(t,i)||{value:t[i]}).get?s=l.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):l.set&&(s=e.stylize("[Setter]","special")),B(n,i)||(o="["+i+"]"),s||(e.seen.indexOf(l.value)<0?(s=_(r)?d(e,l.value,null):d(e,l.value,r-1)).indexOf("\n")>-1&&(s=a?s.split("\n").map((function(e){return"  "+e})).join("\n").substr(2):"\n"+s.split("\n").map((function(e){return"   "+e})).join("\n")):s=e.stylize("[Circular]","special")),T(o)){if(a&&i.match(/^\d+$/))return s;(o=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(o=o.substr(1,o.length-2),o=e.stylize(o,"name")):(o=o.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),o=e.stylize(o,"string"))}return o+": "+s}function y(e,t,r){return e.reduce((function(e,t){return t.indexOf("\n"),e+t.replace(/\u001b\[\d\d?m/g,"").length+1}),0)>60?r[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+r[1]:r[0]+t+" "+e.join(", ")+" "+r[1]}function v(e){return Array.isArray(e)}function b(e){return"boolean"==typeof e}function _(e){return null===e}function x(e){return null==e}function w(e){return"number"==typeof e}function S(e){return"string"==typeof e}function M(e){return"symbol"==typeof e}function T(e){return void 0===e}function A(e){return E(e)&&"[object RegExp]"===P(e)}function E(e){return"object"==typeof e&&null!==e}function C(e){return E(e)&&"[object Date]"===P(e)}function L(e){return E(e)&&("[object Error]"===P(e)||e instanceof Error)}function D(e){return"function"==typeof e}function R(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e}function P(e){return Object.prototype.toString.call(e)}function O(e){return e<10?"0"+e.toString(10):e.toString(10)}r.debuglog=function(e){if(e=e.toUpperCase(),!a[e])if(o.test(e)){var n=t.pid;a[e]=function(){var t=r.format.apply(r,arguments);console.error("%s %d: %s",e,n,t)}}else a[e]=function(){};return a[e]},r.inspect=l,l.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},l.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},r.types=e("./support/types"),r.isArray=v,r.isBoolean=b,r.isNull=_,r.isNullOrUndefined=x,r.isNumber=w,r.isString=S,r.isSymbol=M,r.isUndefined=T,r.isRegExp=A,r.types.isRegExp=A,r.isObject=E,r.isDate=C,r.types.isDate=C,r.isError=L,r.types.isNativeError=L,r.isFunction=D,r.isPrimitive=R,r.isBuffer=e("./support/isBuffer");var I=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function k(){var e=new Date,t=[O(e.getHours()),O(e.getMinutes()),O(e.getSeconds())].join(":");return[e.getDate(),I[e.getMonth()],t].join(" ")}function B(e,t){return Object.prototype.hasOwnProperty.call(e,t)}r.log=function(){console.log("%s - %s",k(),r.format.apply(r,arguments))},r.inherits=e("inherits"),r._extend=function(e,t){if(!t||!E(t))return e;for(var r=Object.keys(t),n=r.length;n--;)e[r[n]]=t[r[n]];return e};var N="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function F(e,t){if(!e){var r=new Error("Promise was rejected with a falsy value");r.reason=e,e=r}return t(e)}function U(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');function r(){for(var r=[],n=0;n<arguments.length;n++)r.push(arguments[n]);var i=r.pop();if("function"!=typeof i)throw new TypeError("The last argument must be of type Function");var a=this,o=function(){return i.apply(a,arguments)};e.apply(this,r).then((function(e){t.nextTick(o.bind(null,null,e))}),(function(e){t.nextTick(F.bind(null,e,o))}))}return Object.setPrototypeOf(r,Object.getPrototypeOf(e)),Object.defineProperties(r,n(e)),r}r.promisify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');if(N&&e[N]){var t;if("function"!=typeof(t=e[N]))throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(t,N,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}function t(){for(var t,r,n=new Promise((function(e,n){t=e,r=n})),i=[],a=0;a<arguments.length;a++)i.push(arguments[a]);i.push((function(e,n){e?r(e):t(n)}));try{e.apply(this,i)}catch(e){r(e)}return n}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),N&&Object.defineProperty(t,N,{value:t,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(t,n(e))},r.promisify.custom=N,r.callbackify=U}).call(this)}).call(this,e("_process"))},{"./support/isBuffer":79,"./support/types":80,_process:60,inherits:45}],82:[function(e,t,r){(function(r){(function(){var n=e("foreach"),i=e("available-typed-arrays"),a=e("es-abstract/helpers/callBound"),o=a("Object.prototype.toString"),s=e("has-symbols")()&&"symbol"==typeof Symbol.toStringTag,l=i(),c=a("String.prototype.slice"),h={},u=e("es-abstract/helpers/getOwnPropertyDescriptor"),d=Object.getPrototypeOf;s&&u&&d&&n(l,(function(e){if("function"==typeof r[e]){var t=new r[e];if(!(Symbol.toStringTag in t))throw new EvalError("this engine has support for Symbol.toStringTag, but "+e+" does not have the property! Please report this.");var n=d(t),i=u(n,Symbol.toStringTag);if(!i){var a=d(n);i=u(a,Symbol.toStringTag)}h[e]=i.get}}));var p=function(e){var t=!1;return n(h,(function(r,n){if(!t)try{var i=r.call(e);i===n&&(t=i)}catch(e){}})),t},f=e("is-typed-array");t.exports=function(e){return!!f(e)&&(s?p(e):c(o(e),8,-1))}}).call(this)}).call(this,void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"available-typed-arrays":27,"es-abstract/helpers/callBound":36,"es-abstract/helpers/getOwnPropertyDescriptor":37,foreach:39,"has-symbols":42,"is-typed-array":48}]},{},[20])(20)}));function handleGL(e){let t=document.createElement("canvas").getContext("webgl2");t.activeTexture(t.TEXTURE0);let r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r);const n=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.drawBuffers([t.COLOR_ATTACHMENT0]);let i=new Uint8Array(e.width*e.height*4);return t.readPixels(0,0,e.width,e.height,t.RGBA,t.UNSIGNED_BYTE,i),i}class GLTFExporter{constructor(){this.pluginCallbacks=[],this.register((function(e){return new GLTFLightExtension(e)})),this.register((function(e){return new GLTFMaterialsUnlitExtension(e)})),this.register((function(e){return new GLTFMaterialsPBRSpecularGlossiness(e)}))}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,r){const n=new GLTFWriter,i=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)i.push(this.pluginCallbacks[e](n));n.setPlugins(i),n.write(e,t,r)}}const WEBGL_CONSTANTS={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,FLOAT:5126,UNSIGNED_INT:5125,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},THREE_TO_WEBGL={};THREE_TO_WEBGL[NearestFilter]=WEBGL_CONSTANTS.NEAREST,THREE_TO_WEBGL[NearestMipmapNearestFilter]=WEBGL_CONSTANTS.NEAREST_MIPMAP_NEAREST,THREE_TO_WEBGL[NearestMipmapLinearFilter]=WEBGL_CONSTANTS.NEAREST_MIPMAP_LINEAR,THREE_TO_WEBGL[LinearFilter]=WEBGL_CONSTANTS.LINEAR,THREE_TO_WEBGL[LinearMipmapNearestFilter]=WEBGL_CONSTANTS.LINEAR_MIPMAP_NEAREST,THREE_TO_WEBGL[LinearMipmapLinearFilter]=WEBGL_CONSTANTS.LINEAR_MIPMAP_LINEAR,THREE_TO_WEBGL[ClampToEdgeWrapping]=WEBGL_CONSTANTS.CLAMP_TO_EDGE,THREE_TO_WEBGL[RepeatWrapping]=WEBGL_CONSTANTS.REPEAT,THREE_TO_WEBGL[MirroredRepeatWrapping]=WEBGL_CONSTANTS.MIRRORED_REPEAT;const PATH_PROPERTIES={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},GLB_HEADER_BYTES=12,GLB_HEADER_MAGIC=1179937895,GLB_VERSION=2,GLB_CHUNK_PREFIX_BYTES=8,GLB_CHUNK_TYPE_JSON=1313821514,GLB_CHUNK_TYPE_BIN=5130562;function equalArray(e,t){return e.length===t.length&&e.every((function(e,r){return e===t[r]}))}function stringToArrayBuffer(e){if(void 0!==window.TextEncoder)return(new TextEncoder).encode(e).buffer;const t=new Uint8Array(new ArrayBuffer(e.length));for(let r=0,n=e.length;r<n;r++){const n=e.charCodeAt(r);t[r]=n>255?32:n}return t.buffer}function isIdentityMatrix(e){return equalArray(e.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function getMinMax(e,t,r){const n={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let i=t;i<t+r;i++)for(let t=0;t<e.itemSize;t++){let r;e.itemSize>4?r=e.array[i*e.itemSize+t]:0===t?r=e.getX(i):1===t?r=e.getY(i):2===t?r=e.getZ(i):3===t&&(r=e.getW(i)),n.min[t]=Math.min(n.min[t],r),n.max[t]=Math.max(n.max[t],r)}return n}function getPaddedBufferSize(e){return 4*Math.ceil(e/4)}function getPaddedArrayBuffer(e,t=0){const r=getPaddedBufferSize(e.byteLength);if(r!==e.byteLength){const n=new Uint8Array(r);if(n.set(new Uint8Array(e)),0!==t)for(let i=e.byteLength;i<r;i++)n[i]=t;return n.buffer}return e}let cachedCanvas=null;class GLTFWriter{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}setPlugins(e){this.plugins=e}write(e,t,r){this.options=Object.assign({},{binary:!1,trs:!1,onlyVisible:!0,truncateDrawRange:!0,embedImages:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},r),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e);const n=this;Promise.all(this.pending).then((function(){const e=n.buffers,r=n.json,i=n.options,a=n.extensionsUsed,o=new Blob(e,{type:"application/octet-stream"}),s=Object.keys(a);if(s.length>0&&(r.extensionsUsed=s),r.buffers&&r.buffers.length>0&&(r.buffers[0].byteLength=o.size),!0===i.binary){const e=new window.FileReader;e.readAsArrayBuffer(o),e.onloadend=function(){const n=getPaddedArrayBuffer(e.result),i=new DataView(new ArrayBuffer(GLB_CHUNK_PREFIX_BYTES));i.setUint32(0,n.byteLength,!0),i.setUint32(4,GLB_CHUNK_TYPE_BIN,!0);const a=getPaddedArrayBuffer(stringToArrayBuffer(JSON.stringify(r)),32),o=new DataView(new ArrayBuffer(GLB_CHUNK_PREFIX_BYTES));o.setUint32(0,a.byteLength,!0),o.setUint32(4,GLB_CHUNK_TYPE_JSON,!0);const s=new ArrayBuffer(GLB_HEADER_BYTES),l=new DataView(s);l.setUint32(0,GLB_HEADER_MAGIC,!0),l.setUint32(4,GLB_VERSION,!0);const c=GLB_HEADER_BYTES+o.byteLength+a.byteLength+i.byteLength+n.byteLength;l.setUint32(8,c,!0);const h=new Blob([s,o,a,i,n],{type:"application/octet-stream"}),u=new window.FileReader;u.readAsArrayBuffer(h),u.onloadend=function(){t(u.result)}}}else if(r.buffers&&r.buffers.length>0){const e=new window.FileReader;e.readAsDataURL(o),e.onloadend=function(){const n=e.result;r.buffers[0].uri=n,t(r)}}else t(r)}))}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;const r=this.options,n=this.extensionsUsed;try{const i=JSON.parse(JSON.stringify(e.userData));if(r.includeCustomExtensions&&i.gltfExtensions){void 0===t.extensions&&(t.extensions={});for(const e in i.gltfExtensions)t.extensions[e]=i.gltfExtensions[e],n[e]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(t){logger.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e){return this.uids.has(e)||this.uids.set(e,this.uid++),this.uids.get(e)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;const t=new Vector3;for(let r=0,n=e.count;r<n;r++)if(Math.abs(t.fromBufferAttribute(e,r).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){const t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);const r=e.clone(),n=new Vector3;for(let e=0,t=r.count;e<t;e++)n.fromBufferAttribute(r,e),0===n.x&&0===n.y&&0===n.z?n.setX(1):n.normalize(),r.setXYZ(e,n.x,n.y,n.z);return t.attributesNormalized.set(e,r),r}applyTextureTransform(e,t){let r=!1;const n={};0===t.offset.x&&0===t.offset.y||(n.offset=t.offset.toArray(),r=!0),0!==t.rotation&&(n.rotation=t.rotation,r=!0),1===t.repeat.x&&1===t.repeat.y||(n.scale=t.repeat.toArray(),r=!0),r&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=n,this.extensionsUsed.KHR_texture_transform=!0)}processBuffer(e){const t=this.json,r=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),r.push(e),0}processBufferView(e,t,r,n,i){const a=this.json;let o;a.bufferViews||(a.bufferViews=[]),o=t===WEBGL_CONSTANTS.UNSIGNED_BYTE?1:t===WEBGL_CONSTANTS.UNSIGNED_SHORT?2:4;const s=getPaddedBufferSize(n*e.itemSize*o),l=new DataView(new ArrayBuffer(s));let c=0;for(let i=r;i<r+n;i++)for(let r=0;r<e.itemSize;r++){let n;e.itemSize>4?n=e.array[i*e.itemSize+r]:0===r?n=e.getX(i):1===r?n=e.getY(i):2===r?n=e.getZ(i):3===r&&(n=e.getW(i)),t===WEBGL_CONSTANTS.FLOAT?l.setFloat32(c,n,!0):t===WEBGL_CONSTANTS.UNSIGNED_INT?l.setUint32(c,n,!0):t===WEBGL_CONSTANTS.UNSIGNED_SHORT?l.setUint16(c,n,!0):t===WEBGL_CONSTANTS.UNSIGNED_BYTE&&l.setUint8(c,n),c+=o}const h={buffer:this.processBuffer(l.buffer),byteOffset:this.byteOffset,byteLength:s};void 0!==i&&(h.target=i),i===WEBGL_CONSTANTS.ARRAY_BUFFER&&(h.byteStride=e.itemSize*o),this.byteOffset+=s,a.bufferViews.push(h);return{id:a.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){const t=this,r=t.json;return r.bufferViews||(r.bufferViews=[]),new Promise((function(n){const i=new window.FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){const e=getPaddedArrayBuffer(i.result),a={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,n(r.bufferViews.push(a)-1)}}))}processAccessor(e,t,r,n){const i=this.options,a=this.json;let o;if(e.array.constructor===Float32Array)o=WEBGL_CONSTANTS.FLOAT;else if(e.array.constructor===Uint32Array)o=WEBGL_CONSTANTS.UNSIGNED_INT;else if(e.array.constructor===Uint16Array)o=WEBGL_CONSTANTS.UNSIGNED_SHORT;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");o=WEBGL_CONSTANTS.UNSIGNED_BYTE}if(void 0===r&&(r=0),void 0===n&&(n=e.count),i.truncateDrawRange&&void 0!==t&&null===t.index){const i=r+n,a=t.drawRange.count===1/0?e.count:t.drawRange.start+t.drawRange.count;r=Math.max(r,t.drawRange.start),(n=Math.min(i,a)-r)<0&&(n=0)}if(0===n)return null;const s=getMinMax(e,r,n);let l;void 0!==t&&(l=e===t.index?WEBGL_CONSTANTS.ELEMENT_ARRAY_BUFFER:WEBGL_CONSTANTS.ARRAY_BUFFER);const c=this.processBufferView(e,o,r,n,l),h={bufferView:c.id,byteOffset:c.byteOffset,componentType:o,count:n,max:s.max,min:s.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(h.normalized=!0),a.accessors||(a.accessors=[]),a.accessors.push(h)-1}processImage(e,t,r){const n=this,i=n.cache,a=n.json,o=n.options,s=n.pending;i.images.has(e)||i.images.set(e,{});const l=i.images.get(e),c=t===RGBAFormat?"image/png":"image/jpeg",h=c+":flipY/"+r.toString();if(void 0!==l[h])return l[h];a.images||(a.images=[]);const u={mimeType:c};if(o.embedImages){const i=cachedCanvas=cachedCanvas||document.createElement("canvas");i.width=Math.min(e.width,o.maxTextureSize),i.height=Math.min(e.height,o.maxTextureSize);const a=i.getContext("2d");if(!0===r&&(a.translate(0,i.height),a.scale(1,-1)),"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap)a.drawImage(e,0,0,i.width,i.height);else{t!==RGBAFormat&&t!==RGBFormat&&logger.error("GLTFExporter: Only RGB and RGBA formats are supported."),(e.width>o.maxTextureSize||e.height>o.maxTextureSize)&&logger.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);let r=e.data;if(t===RGBFormat){r=new Uint8ClampedArray(e.height*e.width*4);for(let t=0,n=0;t<r.length;t+=4,n+=3)r[t+0]=e.data[n+0],r[t+1]=e.data[n+1],r[t+2]=e.data[n+2],r[t+3]=255}a.putImageData(new ImageData(r,e.width,e.height),0,0)}!0===o.binary?s.push(new Promise((function(t){i.toBlob((function(r){if("image/png"===r.type){let t=handleGL(e),n=new browser.PNG({width:e.width,height:e.height,filterType:4});for(let e=0;e<n.data.length;e+=4)n.data[e+0]=t[e+0],n.data[e+1]=t[e+1],n.data[e+2]=t[e+2],n.data[e+3]=t[e+3];n.pack();var i=browser.PNG.sync.write(n,{colorType:6});r=new Blob([i],{type:r.type})}n.processBufferViewImage(r).then((function(e){u.bufferView=e,t()}))}),c)}))):u.uri=i.toDataURL(c)}else u.uri=e.src;const d=a.images.push(u)-1;return l[h]=d,d}processSampler(e){const t=this.json;t.samplers||(t.samplers=[]);const r={magFilter:THREE_TO_WEBGL[e.magFilter],minFilter:THREE_TO_WEBGL[e.minFilter],wrapS:THREE_TO_WEBGL[e.wrapS],wrapT:THREE_TO_WEBGL[e.wrapT]};return t.samplers.push(r)-1}processTexture(e){const t=this.cache,r=this.json;if(t.textures.has(e))return t.textures.get(e);r.textures||(r.textures=[]);const n={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY)};e.name&&(n.name=e.name),this._invokeAll((function(t){t.writeTexture&&t.writeTexture(e,n)}));const i=r.textures.push(n)-1;return t.textures.set(e,i),i}processMaterial(e){const t=this.cache,r=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return logger.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;r.materials||(r.materials=[]);const n={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&logger.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const i=e.color.toArray().concat([e.opacity]);if(equalArray(i,[1,1,1,1])||(n.pbrMetallicRoughness.baseColorFactor=i),e.isMeshStandardMaterial?(n.pbrMetallicRoughness.metallicFactor=e.metalness,n.pbrMetallicRoughness.roughnessFactor=e.roughness):(n.pbrMetallicRoughness.metallicFactor=.5,n.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap)if(e.metalnessMap===e.roughnessMap||e.metalnessMap&&e.roughnessMap&&e.metalnessMap.name===e.roughnessMap.name){const t={index:this.processTexture(e.metalnessMap)};this.applyTextureTransform(t,e.metalnessMap),n.pbrMetallicRoughness.metallicRoughnessTexture=t}else logger.warn("THREE.GLTFExporter: Ignoring metalnessMap and roughnessMap because they are not the same Texture.");if(e.map){const t={index:this.processTexture(e.map)};this.applyTextureTransform(t,e.map),n.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){const t=e.emissive.clone().multiplyScalar(e.emissiveIntensity).toArray();if(equalArray(t,[0,0,0])||(n.emissiveFactor=t),e.emissiveMap){const t={index:this.processTexture(e.emissiveMap)};this.applyTextureTransform(t,e.emissiveMap),n.emissiveTexture=t}}if(e.normalMap){const t={index:this.processTexture(e.normalMap)};e.normalScale&&-1!==e.normalScale.x&&(e.normalScale.x!==e.normalScale.y&&logger.warn("THREE.GLTFExporter: Normal scale components are different, ignoring Y and exporting X."),t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),n.normalTexture=t}if(e.aoMap){const t={index:this.processTexture(e.aoMap),texCoord:1};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),n.occlusionTexture=t}e.transparent?n.alphaMode="BLEND":e.alphaTest>0&&(n.alphaMode="MASK",n.alphaCutoff=e.alphaTest),e.side===DoubleSide&&(n.doubleSided=!0),""!==e.name&&(n.name=e.name),this.serializeUserData(e,n),this._invokeAll((function(t){t.writeMaterial&&t.writeMaterial(e,n)}));const a=r.materials.push(n)-1;return t.materials.set(e,a),a}processMesh(e){const t=this.cache,r=this.json,n=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,r=e.material.length;t<r;t++)n.push(e.material[t].uuid);else n.push(e.material.uuid);const i=n.join(":");if(t.meshes.has(i))return t.meshes.get(i);const a=e.geometry;let o;if(o=e.isLineSegments?WEBGL_CONSTANTS.LINES:e.isLineLoop?WEBGL_CONSTANTS.LINE_LOOP:e.isLine?WEBGL_CONSTANTS.LINE_STRIP:e.isPoints?WEBGL_CONSTANTS.POINTS:e.material.wireframe?WEBGL_CONSTANTS.LINES:WEBGL_CONSTANTS.TRIANGLES,!0!==a.isBufferGeometry)throw new Error("THREE.GLTFExporter: Geometry is not of type THREE.BufferGeometry.");const s={},l={},c=[],h=[],u={uv:"TEXCOORD_0",uv2:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},d=a.getAttribute("normal");void 0===d||this.isNormalizedNormalAttribute(d)||(logger.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),a.setAttribute("normal",this.createNormalizedNormalAttribute(d)));let p=null;for(let e in a.attributes){if("morph"===e.substr(0,5))continue;const r=a.attributes[e];e=u[e]||e.toUpperCase();if(/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),t.attributes.has(this.getUID(r))){l[e]=t.attributes.get(this.getUID(r));continue}p=null;const n=r.array;"JOINTS_0"!==e||n instanceof Uint16Array||n instanceof Uint8Array||(logger.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),p=new BufferAttribute(new Uint16Array(n),r.itemSize,r.normalized));const i=this.processAccessor(p||r,a);null!==i&&(l[e]=i,t.attributes.set(this.getUID(r),i))}if(void 0!==d&&a.setAttribute("normal",d),0===Object.keys(l).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){const r=[],n=[],i={};if(void 0!==e.morphTargetDictionary)for(const t in e.morphTargetDictionary)i[e.morphTargetDictionary[t]]=t;for(let o=0;o<e.morphTargetInfluences.length;++o){const s={};let l=!1;for(const e in a.morphAttributes){if("position"!==e&&"normal"!==e){l||(logger.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),l=!0);continue}const r=a.morphAttributes[e][o],n=e.toUpperCase(),i=a.attributes[e];if(t.attributes.has(this.getUID(r))){s[n]=t.attributes.get(this.getUID(r));continue}const c=r.clone();if(!a.morphTargetsRelative)for(let e=0,t=r.count;e<t;e++)c.setXYZ(e,r.getX(e)-i.getX(e),r.getY(e)-i.getY(e),r.getZ(e)-i.getZ(e));s[n]=this.processAccessor(c,a),t.attributes.set(this.getUID(i),s[n])}h.push(s),r.push(e.morphTargetInfluences[o]),void 0!==e.morphTargetDictionary&&n.push(i[o])}s.weights=r,n.length>0&&(s.extras={},s.extras.targetNames=n)}const f=Array.isArray(e.material);if(f&&0===a.groups.length)return null;const m=f?e.material:[e.material],g=f?a.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,r=g.length;e<r;e++){const r={mode:o,attributes:l};if(this.serializeUserData(a,r),h.length>0&&(r.targets=h),null!==a.index){let n=this.getUID(a.index);void 0===g[e].start&&void 0===g[e].count||(n+=":"+g[e].start+":"+g[e].count),t.attributes.has(n)?r.indices=t.attributes.get(n):(r.indices=this.processAccessor(a.index,a,g[e].start,g[e].count),t.attributes.set(n,r.indices)),null===r.indices&&delete r.indices}const n=this.processMaterial(m[g[e].materialIndex]);null!==n&&(r.material=n),c.push(r)}s.primitives=c,r.meshes||(r.meshes=[]),this._invokeAll((function(t){t.writeMesh&&t.writeMesh(e,s)}));const y=r.meshes.push(s)-1;return t.meshes.set(i,y),y}processCamera(e){const t=this.json;t.cameras||(t.cameras=[]);const r=e.isOrthographicCamera,n={type:r?"orthographic":"perspective"};return r?n.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:n.perspective={aspectRatio:e.aspect,yfov:MathUtils.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(n.name=e.type),t.cameras.push(n)-1}processAnimation(e,t){const r=this.json,n=this.nodeMap;r.animations||(r.animations=[]);const i=(e=GLTFExporter.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,a=[],o=[];for(let e=0;e<i.length;++e){const r=i[e],s=PropertyBinding.parseTrackName(r.name);let l=PropertyBinding.findNode(t,s.nodeName);const c=PATH_PROPERTIES[s.propertyName];if("bones"===s.objectName&&(l=!0===l.isSkinnedMesh?l.skeleton.getBoneByName(s.objectIndex):void 0),!l||!c)return logger.warn('THREE.GLTFExporter: Could not export animation track "%s".',r.name),null;const h=1;let u,d=r.values.length/r.times.length;c===PATH_PROPERTIES.morphTargetInfluences&&(d/=l.morphTargetInfluences.length),!0===r.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(u="CUBICSPLINE",d/=3):u=r.getInterpolation()===InterpolateDiscrete?"STEP":"LINEAR",o.push({input:this.processAccessor(new BufferAttribute(r.times,h)),output:this.processAccessor(new BufferAttribute(r.values,d)),interpolation:u}),a.push({sampler:o.length-1,target:{node:n.get(l),path:c}})}return r.animations.push({name:e.name||"clip_"+r.animations.length,samplers:o,channels:a}),r.animations.length-1}processSkin(e){const t=this.json,r=this.nodeMap,n=t.nodes[r.get(e)],i=e.skeleton;if(void 0===i)return null;const a=e.skeleton.bones[0];if(void 0===a)return null;const o=[],s=new Float32Array(16*i.bones.length),l=new Matrix4;for(let t=0;t<i.bones.length;++t)o.push(r.get(i.bones[t])),l.copy(i.boneInverses[t]),l.multiply(e.bindMatrix).toArray(s,16*t);void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new BufferAttribute(s,16)),joints:o,skeleton:r.get(a)});return n.skin=t.skins.length-1}processNode(e){const t=this.json,r=this.options,n=this.nodeMap;t.nodes||(t.nodes=[]);const i={};if(r.trs){const t=e.quaternion.toArray(),r=e.position.toArray(),n=e.scale.toArray();equalArray(t,[0,0,0,1])||(i.rotation=t),equalArray(r,[0,0,0])||(i.translation=r),equalArray(n,[1,1,1])||(i.scale=n)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===isIdentityMatrix(e.matrix)&&(i.matrix=e.matrix.elements);if(""!==e.name&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){const t=this.processMesh(e);null!==t&&(i.mesh=t)}else e.isCamera&&(i.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){const t=[];for(let n=0,i=e.children.length;n<i;n++){const i=e.children[n];if(i.visible||!1===r.onlyVisible){const e=this.processNode(i);null!==e&&t.push(e)}}t.length>0&&(i.children=t)}this._invokeAll((function(t){t.writeNode&&t.writeNode(e,i)}));const a=t.nodes.push(i)-1;return n.set(e,a),a}processScene(e){const t=this.json,r=this.options;t.scenes||(t.scenes=[],t.scene=0);const n={};""!==e.name&&(n.name=e.name),t.scenes.push(n);const i=[];for(let t=0,n=e.children.length;t<n;t++){const n=e.children[t];if(n.visible||!1===r.onlyVisible){const e=this.processNode(n);null!==e&&i.push(e)}}i.length>0&&(n.nodes=i),this.serializeUserData(e,n)}processObjects(e){const t=new Scene;t.name="AuxScene";for(let r=0;r<e.length;r++)t.children.push(e[r]);this.processScene(t)}processInput(e){const t=this.options;e=e instanceof Array?e:[e],this._invokeAll((function(t){t.beforeParse&&t.beforeParse(e)}));const r=[];for(let t=0;t<e.length;t++)e[t]instanceof Scene?this.processScene(e[t]):r.push(e[t]);r.length>0&&this.processObjects(r);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let r=0;r<t.animations.length;++r)this.processAnimation(t.animations[r],e[0]);this._invokeAll((function(t){t.afterParse&&t.afterParse(e)}))}_invokeAll(e){for(let t=0,r=this.plugins.length;t<r;t++)e(this.plugins[t])}}class GLTFLightExtension{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void logger.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);const r=this.writer,n=r.json,i=r.extensionsUsed,a={};e.name&&(a.name=e.name),a.color=e.color.toArray(),a.intensity=e.intensity,e.isDirectionalLight?a.type="directional":e.isPointLight?(a.type="point",e.distance>0&&(a.range=e.distance)):e.isSpotLight&&(a.type="spot",e.distance>0&&(a.range=e.distance),a.spot={},a.spot.innerConeAngle=(e.penumbra-1)*e.angle*-1,a.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&logger.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),!e.target||e.target.parent===e&&0===e.target.position.x&&0===e.target.position.y&&-1===e.target.position.z||logger.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(n.extensions=n.extensions||{},n.extensions[this.name]={lights:[]},i[this.name]=!0);const o=n.extensions[this.name].lights;o.push(a),t.extensions=t.extensions||{},t.extensions[this.name]={light:o.length-1}}}class GLTFMaterialsUnlitExtension{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}writeMaterial(e,t){if(!e.isMeshBasicMaterial)return;const r=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},r[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class GLTFMaterialsPBRSpecularGlossiness{constructor(e){this.writer=e,this.name="KHR_materials_pbrSpecularGlossiness"}writeMaterial(e,t){if(!e.isGLTFSpecularGlossinessMaterial)return;const r=this.writer,n=r.extensionsUsed,i={};t.pbrMetallicRoughness.baseColorFactor&&(i.diffuseFactor=t.pbrMetallicRoughness.baseColorFactor);const a=[1,1,1];if(e.specular.toArray(a,0),i.specularFactor=a,i.glossinessFactor=e.glossiness,t.pbrMetallicRoughness.baseColorTexture&&(i.diffuseTexture=t.pbrMetallicRoughness.baseColorTexture),e.specularMap){const t={index:r.processTexture(e.specularMap)};r.applyTextureTransform(t,e.specularMap),i.specularGlossinessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}}GLTFExporter.Utils={insertKeyframe:function(e,t){const r=.001,n=e.getValueSize(),i=new e.TimeBufferType(e.times.length+1),a=new e.ValueBufferType(e.values.length+n),o=e.createInterpolant(new e.ValueBufferType(n));let s;if(0===e.times.length){i[0]=t;for(let e=0;e<n;e++)a[e]=0;s=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<r)return 0;i[0]=t,i.set(e.times,1),a.set(o.evaluate(t),0),a.set(e.values,n),s=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<r)return e.times.length-1;i[i.length-1]=t,i.set(e.times,0),a.set(e.values,0),a.set(o.evaluate(t),e.values.length),s=i.length-1}else for(let l=0;l<e.times.length;l++){if(Math.abs(e.times[l]-t)<r)return l;if(e.times[l]<t&&e.times[l+1]>t){i.set(e.times.slice(0,l+1),0),i[l+1]=t,i.set(e.times.slice(l+1),l+2),a.set(e.values.slice(0,(l+1)*n),0),a.set(o.evaluate(t),(l+1)*n),a.set(e.values.slice((l+1)*n),(l+2)*n),s=l+1;break}}return e.times=i,e.values=a,s},mergeMorphTargetTracks:function(e,t){const r=[],n={},i=e.tracks;for(let e=0;e<i.length;++e){let a=i[e];const o=PropertyBinding.parseTrackName(a.name),s=PropertyBinding.findNode(t,o.nodeName);if("morphTargetInfluences"!==o.propertyName||void 0===o.propertyIndex){r.push(a);continue}if(a.createInterpolant!==a.InterpolantFactoryMethodDiscrete&&a.createInterpolant!==a.InterpolantFactoryMethodLinear){if(a.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");logger.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),a=a.clone(),a.setInterpolation(InterpolateLinear)}const l=s.morphTargetInfluences.length,c=s.morphTargetDictionary[o.propertyIndex];if(void 0===c)throw new Error("THREE.GLTFExporter: Morph target name not found: "+o.propertyIndex);let h;if(void 0===n[s.uuid]){h=a.clone();const e=new h.ValueBufferType(l*h.times.length);for(let t=0;t<h.times.length;t++)e[t*l+c]=h.values[t];h.name=(o.nodeName||"")+".morphTargetInfluences",h.values=e,n[s.uuid]=h,r.push(h);continue}const u=a.createInterpolant(new a.ValueBufferType(1));h=n[s.uuid];for(let e=0;e<h.times.length;e++)h.values[e*l+c]=u.evaluate(h.times[e]);for(let e=0;e<a.times.length;e++){const t=this.insertKeyframe(h,a.times[e]);h.values[t*l+c]=a.values[e]}}return e.tracks=r,e}};let _arrayBufferToBlob=e=>new Blob([e],{type:"application/octet-stream"});class DHExporter{constructor(e,t){this._scene=e,this._context=t,this._gltfExporter=new GLTFExporter}concat(...e){let t=0;for(let r of e)t+=r.length;let r=new Uint8Array(t),n=0;for(let t of e)r.set(t,n),n+=t.length;return r}exportBlob({type:e="glb",maxTextureSize:t,onFinish:r,onError:n}){logger.debug(this._context.getSettings());let i=new Group,a=new ObjectTree(i);_context.instance.getResourceScene(_context.sceneSettings,(()=>{switch(i.userData.dhExtension=JSON.parse(JSON.stringify(_context.sceneSettings)),_context.cacheStore._cache.forEach(((e,t)=>{e.needExport&&(e.resource.userData={needExport:e.needExport,refCount:e.refCount,resourcePath:e.resourcePath,type:e.type},i.add(e.resource))})),e.toLowerCase()){case"glb":default:let e={trs:!0,onlyVisible:!1,truncateDrawRange:!0,binary:!0,forcePowerOfTwoTextures:!0,includeCustomExtensions:!0,maxTextureSize:t||1/0};this._gltfExporter.parse(i,(e=>{e instanceof ArrayBuffer&&r&&(r(_arrayBufferToBlob(e)),util$1.disposeThreeObject(i))}),e)}}),(()=>{}),i,a)}}const instanceOfAny=(e,t)=>t.some((t=>e instanceof t));let idbProxyableTypes,cursorAdvanceMethods;function getIdbProxyableTypes(){return idbProxyableTypes||(idbProxyableTypes=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function getCursorAdvanceMethods(){return cursorAdvanceMethods||(cursorAdvanceMethods=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const cursorRequestMap=new WeakMap,transactionDoneMap=new WeakMap,transactionStoreNamesMap=new WeakMap,transformCache=new WeakMap,reverseTransformCache=new WeakMap;function promisifyRequest(e){const t=new Promise(((t,r)=>{const n=()=>{e.removeEventListener("success",i),e.removeEventListener("error",a)},i=()=>{t(wrap(e.result)),n()},a=()=>{r(e.error),n()};e.addEventListener("success",i),e.addEventListener("error",a)}));return t.then((t=>{t instanceof IDBCursor&&cursorRequestMap.set(t,e)})).catch((()=>{})),reverseTransformCache.set(t,e),t}function cacheDonePromiseForTransaction(e){if(transactionDoneMap.has(e))return;const t=new Promise(((t,r)=>{const n=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",a),e.removeEventListener("abort",a)},i=()=>{t(),n()},a=()=>{r(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",i),e.addEventListener("error",a),e.addEventListener("abort",a)}));transactionDoneMap.set(e,t)}let idbProxyTraps={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return transactionDoneMap.get(e);if("objectStoreNames"===t)return e.objectStoreNames||transactionStoreNamesMap.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return wrap(e[t])},set:(e,t,r)=>(e[t]=r,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function replaceTraps(e){idbProxyTraps=e(idbProxyTraps)}function wrapFunction(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?getCursorAdvanceMethods().includes(e)?function(...t){return e.apply(unwrap(this),t),wrap(cursorRequestMap.get(this))}:function(...t){return wrap(e.apply(unwrap(this),t))}:function(t,...r){const n=e.call(unwrap(this),t,...r);return transactionStoreNamesMap.set(n,t.sort?t.sort():[t]),wrap(n)}}function transformCachableValue(e){return"function"==typeof e?wrapFunction(e):(e instanceof IDBTransaction&&cacheDonePromiseForTransaction(e),instanceOfAny(e,getIdbProxyableTypes())?new Proxy(e,idbProxyTraps):e)}function wrap(e){if(e instanceof IDBRequest)return promisifyRequest(e);if(transformCache.has(e))return transformCache.get(e);const t=transformCachableValue(e);return t!==e&&(transformCache.set(e,t),reverseTransformCache.set(t,e)),t}const unwrap=e=>reverseTransformCache.get(e);function openDB(e,t,{blocked:r,upgrade:n,blocking:i,terminated:a}={}){const o=indexedDB.open(e,t),s=wrap(o);return n&&o.addEventListener("upgradeneeded",(e=>{n(wrap(o.result),e.oldVersion,e.newVersion,wrap(o.transaction))})),r&&o.addEventListener("blocked",(()=>r())),s.then((e=>{a&&e.addEventListener("close",(()=>a())),i&&e.addEventListener("versionchange",(()=>i()))})).catch((()=>{})),s}const readMethods=["get","getKey","getAll","getAllKeys","count"],writeMethods=["put","add","delete","clear"],cachedMethods=new Map;function getMethod(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(cachedMethods.get(t))return cachedMethods.get(t);const r=t.replace(/FromIndex$/,""),n=t!==r,i=writeMethods.includes(r);if(!(r in(n?IDBIndex:IDBObjectStore).prototype)||!i&&!readMethods.includes(r))return;const a=async function(e,...t){const a=this.transaction(e,i?"readwrite":"readonly");let o=a.store;return n&&(o=o.index(t.shift())),(await Promise.all([o[r](...t),i&&a.done]))[0]};return cachedMethods.set(t,a),a}replaceTraps((e=>({...e,get:(t,r,n)=>getMethod(t,r)||e.get(t,r,n),has:(t,r)=>!!getMethod(t,r)||e.has(t,r)})));
/**
   * [js-md5]{@link https://github.com/emn178/js-md5}
   *
   * @namespace md5
   * @version 0.7.3
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2017
   * @license MIT
   */
var md5=createCommonjsModule((function(module){(function(){var ERROR="input is invalid type",WINDOW="object"==typeof window,root=WINDOW?window:{};root.JS_MD5_NO_WINDOW&&(WINDOW=!1);var WEB_WORKER=!WINDOW&&"object"==typeof self,NODE_JS=!root.JS_MD5_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;NODE_JS?root=commonjsGlobal:WEB_WORKER&&(root=self);var COMMON_JS=!root.JS_MD5_NO_COMMON_JS&&module.exports,ARRAY_BUFFER=!root.JS_MD5_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,HEX_CHARS="0123456789abcdef".split(""),EXTRA=[128,32768,8388608,-2147483648],SHIFT=[0,8,16,24],OUTPUT_TYPES=["hex","array","digest","buffer","arrayBuffer","base64"],BASE64_ENCODE_CHAR="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),blocks=[],buffer8;if(ARRAY_BUFFER){var buffer=new ArrayBuffer(68);buffer8=new Uint8Array(buffer),blocks=new Uint32Array(buffer)}!root.JS_MD5_NO_NODE_JS&&Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),!ARRAY_BUFFER||!root.JS_MD5_NO_ARRAY_BUFFER_IS_VIEW&&ArrayBuffer.isView||(ArrayBuffer.isView=function(e){return"object"==typeof e&&e.buffer&&e.buffer.constructor===ArrayBuffer});var createOutputMethod=function(e){return function(t){return new Md5(!0).update(t)[e]()}},createMethod=function(){var e=createOutputMethod("hex");NODE_JS&&(e=nodeWrap(e)),e.create=function(){return new Md5},e.update=function(t){return e.create().update(t)};for(var t=0;t<OUTPUT_TYPES.length;++t){var r=OUTPUT_TYPES[t];e[r]=createOutputMethod(r)}return e},nodeWrap=function(method){var crypto=eval("require('crypto')"),Buffer=eval("require('buffer').Buffer"),nodeMethod=function(e){if("string"==typeof e)return crypto.createHash("md5").update(e,"utf8").digest("hex");if(null==e)throw ERROR;return e.constructor===ArrayBuffer&&(e=new Uint8Array(e)),Array.isArray(e)||ArrayBuffer.isView(e)||e.constructor===Buffer?crypto.createHash("md5").update(new Buffer(e)).digest("hex"):method(e)};return nodeMethod};function Md5(e){if(e)blocks[0]=blocks[16]=blocks[1]=blocks[2]=blocks[3]=blocks[4]=blocks[5]=blocks[6]=blocks[7]=blocks[8]=blocks[9]=blocks[10]=blocks[11]=blocks[12]=blocks[13]=blocks[14]=blocks[15]=0,this.blocks=blocks,this.buffer8=buffer8;else if(ARRAY_BUFFER){var t=new ArrayBuffer(68);this.buffer8=new Uint8Array(t),this.blocks=new Uint32Array(t)}else this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.h0=this.h1=this.h2=this.h3=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Md5.prototype.update=function(e){if(!this.finalized){var t,r=typeof e;if("string"!==r){if("object"!==r)throw ERROR;if(null===e)throw ERROR;if(ARRAY_BUFFER&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!(Array.isArray(e)||ARRAY_BUFFER&&ArrayBuffer.isView(e)))throw ERROR;t=!0}for(var n,i,a=0,o=e.length,s=this.blocks,l=this.buffer8;a<o;){if(this.hashed&&(this.hashed=!1,s[0]=s[16],s[16]=s[1]=s[2]=s[3]=s[4]=s[5]=s[6]=s[7]=s[8]=s[9]=s[10]=s[11]=s[12]=s[13]=s[14]=s[15]=0),t)if(ARRAY_BUFFER)for(i=this.start;a<o&&i<64;++a)l[i++]=e[a];else for(i=this.start;a<o&&i<64;++a)s[i>>2]|=e[a]<<SHIFT[3&i++];else if(ARRAY_BUFFER)for(i=this.start;a<o&&i<64;++a)(n=e.charCodeAt(a))<128?l[i++]=n:n<2048?(l[i++]=192|n>>6,l[i++]=128|63&n):n<55296||n>=57344?(l[i++]=224|n>>12,l[i++]=128|n>>6&63,l[i++]=128|63&n):(n=65536+((1023&n)<<10|1023&e.charCodeAt(++a)),l[i++]=240|n>>18,l[i++]=128|n>>12&63,l[i++]=128|n>>6&63,l[i++]=128|63&n);else for(i=this.start;a<o&&i<64;++a)(n=e.charCodeAt(a))<128?s[i>>2]|=n<<SHIFT[3&i++]:n<2048?(s[i>>2]|=(192|n>>6)<<SHIFT[3&i++],s[i>>2]|=(128|63&n)<<SHIFT[3&i++]):n<55296||n>=57344?(s[i>>2]|=(224|n>>12)<<SHIFT[3&i++],s[i>>2]|=(128|n>>6&63)<<SHIFT[3&i++],s[i>>2]|=(128|63&n)<<SHIFT[3&i++]):(n=65536+((1023&n)<<10|1023&e.charCodeAt(++a)),s[i>>2]|=(240|n>>18)<<SHIFT[3&i++],s[i>>2]|=(128|n>>12&63)<<SHIFT[3&i++],s[i>>2]|=(128|n>>6&63)<<SHIFT[3&i++],s[i>>2]|=(128|63&n)<<SHIFT[3&i++]);this.lastByteIndex=i,this.bytes+=i-this.start,i>=64?(this.start=i-64,this.hash(),this.hashed=!0):this.start=i}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},Md5.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[t>>2]|=EXTRA[3&t],t>=56&&(this.hashed||this.hash(),e[0]=e[16],e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.bytes<<3,e[15]=this.hBytes<<3|this.bytes>>>29,this.hash()}},Md5.prototype.hash=function(){var e,t,r,n,i,a,o=this.blocks;this.first?t=((t=((e=((e=o[0]-680876937)<<7|e>>>25)-271733879<<0)^(r=((r=(-271733879^(n=((n=(-1732584194^2004318071&e)+o[1]-117830708)<<12|n>>>20)+e<<0)&(-271733879^e))+o[2]-1126478375)<<17|r>>>15)+n<<0)&(n^e))+o[3]-1316259209)<<22|t>>>10)+r<<0:(e=this.h0,t=this.h1,r=this.h2,t=((t+=((e=((e+=((n=this.h3)^t&(r^n))+o[0]-680876936)<<7|e>>>25)+t<<0)^(r=((r+=(t^(n=((n+=(r^e&(t^r))+o[1]-389564586)<<12|n>>>20)+e<<0)&(e^t))+o[2]+606105819)<<17|r>>>15)+n<<0)&(n^e))+o[3]-1044525330)<<22|t>>>10)+r<<0),t=((t+=((e=((e+=(n^t&(r^n))+o[4]-176418897)<<7|e>>>25)+t<<0)^(r=((r+=(t^(n=((n+=(r^e&(t^r))+o[5]+1200080426)<<12|n>>>20)+e<<0)&(e^t))+o[6]-1473231341)<<17|r>>>15)+n<<0)&(n^e))+o[7]-45705983)<<22|t>>>10)+r<<0,t=((t+=((e=((e+=(n^t&(r^n))+o[8]+1770035416)<<7|e>>>25)+t<<0)^(r=((r+=(t^(n=((n+=(r^e&(t^r))+o[9]-1958414417)<<12|n>>>20)+e<<0)&(e^t))+o[10]-42063)<<17|r>>>15)+n<<0)&(n^e))+o[11]-1990404162)<<22|t>>>10)+r<<0,t=((t+=((e=((e+=(n^t&(r^n))+o[12]+1804603682)<<7|e>>>25)+t<<0)^(r=((r+=(t^(n=((n+=(r^e&(t^r))+o[13]-40341101)<<12|n>>>20)+e<<0)&(e^t))+o[14]-1502002290)<<17|r>>>15)+n<<0)&(n^e))+o[15]+1236535329)<<22|t>>>10)+r<<0,t=((t+=((n=((n+=(t^r&((e=((e+=(r^n&(t^r))+o[1]-165796510)<<5|e>>>27)+t<<0)^t))+o[6]-1069501632)<<9|n>>>23)+e<<0)^e&((r=((r+=(e^t&(n^e))+o[11]+643717713)<<14|r>>>18)+n<<0)^n))+o[0]-373897302)<<20|t>>>12)+r<<0,t=((t+=((n=((n+=(t^r&((e=((e+=(r^n&(t^r))+o[5]-701558691)<<5|e>>>27)+t<<0)^t))+o[10]+38016083)<<9|n>>>23)+e<<0)^e&((r=((r+=(e^t&(n^e))+o[15]-660478335)<<14|r>>>18)+n<<0)^n))+o[4]-405537848)<<20|t>>>12)+r<<0,t=((t+=((n=((n+=(t^r&((e=((e+=(r^n&(t^r))+o[9]+568446438)<<5|e>>>27)+t<<0)^t))+o[14]-1019803690)<<9|n>>>23)+e<<0)^e&((r=((r+=(e^t&(n^e))+o[3]-187363961)<<14|r>>>18)+n<<0)^n))+o[8]+1163531501)<<20|t>>>12)+r<<0,t=((t+=((n=((n+=(t^r&((e=((e+=(r^n&(t^r))+o[13]-1444681467)<<5|e>>>27)+t<<0)^t))+o[2]-51403784)<<9|n>>>23)+e<<0)^e&((r=((r+=(e^t&(n^e))+o[7]+1735328473)<<14|r>>>18)+n<<0)^n))+o[12]-1926607734)<<20|t>>>12)+r<<0,t=((t+=((a=(n=((n+=((i=t^r)^(e=((e+=(i^n)+o[5]-378558)<<4|e>>>28)+t<<0))+o[8]-2022574463)<<11|n>>>21)+e<<0)^e)^(r=((r+=(a^t)+o[11]+1839030562)<<16|r>>>16)+n<<0))+o[14]-35309556)<<23|t>>>9)+r<<0,t=((t+=((a=(n=((n+=((i=t^r)^(e=((e+=(i^n)+o[1]-1530992060)<<4|e>>>28)+t<<0))+o[4]+1272893353)<<11|n>>>21)+e<<0)^e)^(r=((r+=(a^t)+o[7]-155497632)<<16|r>>>16)+n<<0))+o[10]-1094730640)<<23|t>>>9)+r<<0,t=((t+=((a=(n=((n+=((i=t^r)^(e=((e+=(i^n)+o[13]+681279174)<<4|e>>>28)+t<<0))+o[0]-358537222)<<11|n>>>21)+e<<0)^e)^(r=((r+=(a^t)+o[3]-722521979)<<16|r>>>16)+n<<0))+o[6]+76029189)<<23|t>>>9)+r<<0,t=((t+=((a=(n=((n+=((i=t^r)^(e=((e+=(i^n)+o[9]-640364487)<<4|e>>>28)+t<<0))+o[12]-421815835)<<11|n>>>21)+e<<0)^e)^(r=((r+=(a^t)+o[15]+530742520)<<16|r>>>16)+n<<0))+o[2]-995338651)<<23|t>>>9)+r<<0,t=((t+=((n=((n+=(t^((e=((e+=(r^(t|~n))+o[0]-198630844)<<6|e>>>26)+t<<0)|~r))+o[7]+1126891415)<<10|n>>>22)+e<<0)^((r=((r+=(e^(n|~t))+o[14]-1416354905)<<15|r>>>17)+n<<0)|~e))+o[5]-57434055)<<21|t>>>11)+r<<0,t=((t+=((n=((n+=(t^((e=((e+=(r^(t|~n))+o[12]+1700485571)<<6|e>>>26)+t<<0)|~r))+o[3]-1894986606)<<10|n>>>22)+e<<0)^((r=((r+=(e^(n|~t))+o[10]-1051523)<<15|r>>>17)+n<<0)|~e))+o[1]-2054922799)<<21|t>>>11)+r<<0,t=((t+=((n=((n+=(t^((e=((e+=(r^(t|~n))+o[8]+1873313359)<<6|e>>>26)+t<<0)|~r))+o[15]-30611744)<<10|n>>>22)+e<<0)^((r=((r+=(e^(n|~t))+o[6]-1560198380)<<15|r>>>17)+n<<0)|~e))+o[13]+1309151649)<<21|t>>>11)+r<<0,t=((t+=((n=((n+=(t^((e=((e+=(r^(t|~n))+o[4]-145523070)<<6|e>>>26)+t<<0)|~r))+o[11]-1120210379)<<10|n>>>22)+e<<0)^((r=((r+=(e^(n|~t))+o[2]+718787259)<<15|r>>>17)+n<<0)|~e))+o[9]-343485551)<<21|t>>>11)+r<<0,this.first?(this.h0=e+1732584193<<0,this.h1=t-271733879<<0,this.h2=r-1732584194<<0,this.h3=n+271733878<<0,this.first=!1):(this.h0=this.h0+e<<0,this.h1=this.h1+t<<0,this.h2=this.h2+r<<0,this.h3=this.h3+n<<0)},Md5.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,n=this.h3;return HEX_CHARS[e>>4&15]+HEX_CHARS[15&e]+HEX_CHARS[e>>12&15]+HEX_CHARS[e>>8&15]+HEX_CHARS[e>>20&15]+HEX_CHARS[e>>16&15]+HEX_CHARS[e>>28&15]+HEX_CHARS[e>>24&15]+HEX_CHARS[t>>4&15]+HEX_CHARS[15&t]+HEX_CHARS[t>>12&15]+HEX_CHARS[t>>8&15]+HEX_CHARS[t>>20&15]+HEX_CHARS[t>>16&15]+HEX_CHARS[t>>28&15]+HEX_CHARS[t>>24&15]+HEX_CHARS[r>>4&15]+HEX_CHARS[15&r]+HEX_CHARS[r>>12&15]+HEX_CHARS[r>>8&15]+HEX_CHARS[r>>20&15]+HEX_CHARS[r>>16&15]+HEX_CHARS[r>>28&15]+HEX_CHARS[r>>24&15]+HEX_CHARS[n>>4&15]+HEX_CHARS[15&n]+HEX_CHARS[n>>12&15]+HEX_CHARS[n>>8&15]+HEX_CHARS[n>>20&15]+HEX_CHARS[n>>16&15]+HEX_CHARS[n>>28&15]+HEX_CHARS[n>>24&15]},Md5.prototype.toString=Md5.prototype.hex,Md5.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,n=this.h3;return[255&e,e>>8&255,e>>16&255,e>>24&255,255&t,t>>8&255,t>>16&255,t>>24&255,255&r,r>>8&255,r>>16&255,r>>24&255,255&n,n>>8&255,n>>16&255,n>>24&255]},Md5.prototype.array=Md5.prototype.digest,Md5.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(16),t=new Uint32Array(e);return t[0]=this.h0,t[1]=this.h1,t[2]=this.h2,t[3]=this.h3,e},Md5.prototype.buffer=Md5.prototype.arrayBuffer,Md5.prototype.base64=function(){for(var e,t,r,n="",i=this.array(),a=0;a<15;)e=i[a++],t=i[a++],r=i[a++],n+=BASE64_ENCODE_CHAR[e>>>2]+BASE64_ENCODE_CHAR[63&(e<<4|t>>>4)]+BASE64_ENCODE_CHAR[63&(t<<2|r>>>6)]+BASE64_ENCODE_CHAR[63&r];return e=i[a],n+=BASE64_ENCODE_CHAR[e>>>2]+BASE64_ENCODE_CHAR[e<<4&63]+"=="};var exports=createMethod();COMMON_JS?module.exports=exports:root.md5=exports})()})),DHLoader=function(){function e(e){Loader.call(this,e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.dbPromise=openDB(INDEXED_DB_NAME,INDEXED_DB_VERSION,{upgrade(e,t,r,n){e.createObjectStore(INDEXED_DB_OBJECT_STORE)},blocked(){logger.warn("indexeddb request blocked.")},blocking(){logger.warn("indexeddb blocking another request.")},terminated(){logger.warn("indexeddb request terminated.")}}),this.register((function(e){return new a(e)})),this.register((function(e){return new s(e)})),this.register((function(e){return new l(e)})),this.register((function(e){return new o(e)})),this.register((function(e){return new n(e)})),this.register((function(e){return new c(e)}))}function t(){var e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}}}}e.prototype=Object.assign(Object.create(Loader.prototype),{constructor:e,load:function(e,t,r,n){var i,a=this;i=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:LoaderUtils.extractUrlBase(e),this.manager.itemStart(e);var o=function(t){n?n(t):logger.error(t),a.manager.itemError(e),a.manager.itemEnd(e)},s=new FileLoader(this.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials);let l=[];for(let e in this.requestHeader)l.push({key:e,value:this.requestHeader[e]});let c=util$1.fetchContentLastModified(e,l),h=md5(e);c.then((n=>{if("0"===n)return void s.load(e,(function(r){try{a.parse(r,i,(function(r){t(r),a.manager.itemEnd(e)}),o)}catch(e){o(e)}}),r,o);let l=md5(n);this.dbPromise.then((n=>{n.getAllKeys(INDEXED_DB_OBJECT_STORE).then((c=>{let u=!1;for(let s of c)if(0===s.indexOf(h)){s===`${h}:${l}`?(u=!0,n.get(INDEXED_DB_OBJECT_STORE,s).then((n=>{let s=n.byteLength;r&&r({type:"progress",total:s,loaded:s/2});try{a.parse(n,i,(function(n){r&&r({type:"progress",total:s,loaded:s}),t(n),a.manager.itemEnd(e)}),o)}catch(e){o(e)}}))):n.delete(INDEXED_DB_OBJECT_STORE,s).then((()=>{}));break}u||s.load(e,(function(r){try{a.parse(r,i,(function(r){t(r),a.manager.itemEnd(e)}),o),n.put(INDEXED_DB_OBJECT_STORE,r,`${h}:${l}`).then((()=>{logger.debug("db.put(CONST.INDEXED_DB_OBJECT_STORE, data, `${urlKey}:${lastModifiedKey}`)")}))}catch(e){o(e)}}),r,o)}))}))})).catch((()=>{s.load(e,(function(r){try{a.parse(r,i,(function(r){t(r),a.manager.itemEnd(e)}),o)}catch(e){o(e)}}),r,o)}))},setDRACOLoader:function(e){return this.dracoLoader=e,this},setDDSLoader:function(){throw new Error('THREE.DHLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')},setKTX2Loader:function(e){return this.ktx2Loader=e,this},setMeshoptDecoder:function(e){return this.meshoptDecoder=e,this},register:function(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this},unregister:function(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this},parse:function(e,t,n,a){var o,s={},l={};if("string"==typeof e)o=e;else{let t=new Uint8Array(e,0,AVW_HEADER.length);if(t[0]===AVW_HEADER[0]&&t[AVW_HEADER.length-1]===AVW_HEADER[AVW_HEADER.length-1]){e=e.slice(AVW_HEADER.length,e.byteLength);let t=new Uint8Array(e),r=8-AVW_STEP;for(let e=0;e<t.length;e++)t[e]=t[e]<<AVW_STEP|t[e]>>r}if(LoaderUtils.decodeText(new Uint8Array(e,0,4))===h){try{s[r.KHR_BINARY_GLTF]=new p(e)}catch(e){return void(a&&a(e))}o=s[r.KHR_BINARY_GLTF].content}else o=LoaderUtils.decodeText(new Uint8Array(e))}var c=JSON.parse(o);if(void 0===c.asset||c.asset.version[0]<2)a&&a(new Error("THREE.DHLoader: Unsupported asset. glTF versions >=2.0 are supported."));else{var u=new G(c,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});u.fileLoader.setRequestHeader(this.requestHeader);for(var d=0;d<this.pluginCallbacks.length;d++){var g=this.pluginCallbacks[d](u);l[g.name]=g,s[g.name]=!0}if(c.extensionsUsed)for(d=0;d<c.extensionsUsed.length;++d){var b=c.extensionsUsed[d],_=c.extensionsRequired||[];switch(b){case r.KHR_MATERIALS_UNLIT:s[b]=new i;break;case r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:s[b]=new y;break;case r.KHR_DRACO_MESH_COMPRESSION:s[b]=new f(c,this.dracoLoader);break;case r.KHR_TEXTURE_TRANSFORM:s[b]=new m;break;case r.KHR_MESH_QUANTIZATION:s[b]=new v;break;default:_.indexOf(b)>=0&&void 0===l[b]&&logger.warn('THREE.DHLoader: Unknown extension "'+b+'".')}}u.setExtensions(s),u.setPlugins(l),u.parse(n,a)}}});var r={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};function n(e){this.parser=e,this.name=r.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}function i(){this.name=r.KHR_MATERIALS_UNLIT}function a(e){this.parser=e,this.name=r.KHR_MATERIALS_CLEARCOAT}function o(e){this.parser=e,this.name=r.KHR_MATERIALS_TRANSMISSION}function s(e){this.parser=e,this.name=r.KHR_TEXTURE_BASISU}function l(e){this.parser=e,this.name=r.EXT_TEXTURE_WEBP,this.isSupported=null}function c(e){this.name=r.EXT_MESHOPT_COMPRESSION,this.parser=e}n.prototype._markDefs=function(){for(var e=this.parser,t=this.parser.json.nodes||[],r=0,n=t.length;r<n;r++){var i=t[r];i.extensions&&i.extensions[this.name]&&void 0!==i.extensions[this.name].light&&e._addNodeRef(this.cache,i.extensions[this.name].light)}},n.prototype._loadLight=function(e){var t=this.parser,r="light:"+e,n=t.cache.get(r);if(n)return n;var i,a=t.json,o=((a.extensions&&a.extensions[this.name]||{}).lights||[])[e],s=new Color(16777215);void 0!==o.color&&s.fromArray(o.color);var l=void 0!==o.range?o.range:0;switch(o.type){case"directional":(i=new DirectionalLight(s)).target.position.set(0,0,-1),i.add(i.target);break;case"point":(i=new PointLight(s)).distance=l;break;case"spot":(i=new SpotLight(s)).distance=l,o.spot=o.spot||{},o.spot.innerConeAngle=void 0!==o.spot.innerConeAngle?o.spot.innerConeAngle:0,o.spot.outerConeAngle=void 0!==o.spot.outerConeAngle?o.spot.outerConeAngle:Math.PI/4,i.angle=o.spot.outerConeAngle,i.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,i.target.position.set(0,0,-1),i.add(i.target);break;default:throw new Error("THREE.DHLoader: Unexpected light type: "+o.type)}return i.position.set(0,0,0),i.decay=2,void 0!==o.intensity&&(i.intensity=o.intensity),i.name=t.createUniqueName(o.name||"light_"+e),n=Promise.resolve(i),t.cache.add(r,n),n},n.prototype.createNodeAttachment=function(e){var t=this,r=this.parser,n=r.json.nodes[e],i=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then((function(e){return r._getNodeRef(t.cache,i,e)}))},i.prototype.getMaterialType=function(){return MeshBasicMaterial},i.prototype.extendParams=function(e,t,r){var n=[];e.color=new Color(1,1,1),e.opacity=1;var i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){var a=i.baseColorFactor;e.color.fromArray(a),e.opacity=a[3]}void 0!==i.baseColorTexture&&n.push(r.assignTexture(e,"map",i.baseColorTexture))}return Promise.all(n)},a.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null},a.prototype.extendMaterialParams=function(e,t){var r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var i=[],a=n.extensions[this.name];if(void 0!==a.clearcoatFactor&&(t.clearcoat=a.clearcoatFactor),void 0!==a.clearcoatTexture&&i.push(r.assignTexture(t,"clearcoatMap",a.clearcoatTexture)),void 0!==a.clearcoatRoughnessFactor&&(t.clearcoatRoughness=a.clearcoatRoughnessFactor),void 0!==a.clearcoatRoughnessTexture&&i.push(r.assignTexture(t,"clearcoatRoughnessMap",a.clearcoatRoughnessTexture)),void 0!==a.clearcoatNormalTexture&&(i.push(r.assignTexture(t,"clearcoatNormalMap",a.clearcoatNormalTexture)),void 0!==a.clearcoatNormalTexture.scale)){var o=a.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new Vector2(o,-o)}return Promise.all(i)},o.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null},o.prototype.extendMaterialParams=function(e,t){var r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var i=[],a=n.extensions[this.name];return void 0!==a.transmissionFactor&&(t.transmission=a.transmissionFactor),void 0!==a.transmissionTexture&&i.push(r.assignTexture(t,"transmissionMap",a.transmissionTexture)),Promise.all(i)},s.prototype.loadTexture=function(e){var t=this.parser,r=t.json,n=r.textures[e];if(!n.extensions||!n.extensions[this.name])return null;var i=n.extensions[this.name],a=r.images[i.source],o=t.options.ktx2Loader;if(!o){if(r.extensionsRequired&&r.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.DHLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,a,o)},l.prototype.loadTexture=function(e){var t=this.name,r=this.parser,n=r.json,i=n.textures[e];if(!i.extensions||!i.extensions[t])return null;var a=i.extensions[t],o=n.images[a.source],s=r.textureLoader;if(o.uri){var l=r.options.manager.getHandler(o.uri);null!==l&&(s=l)}return this.detectSupport().then((function(i){if(i)return r.loadTextureImage(e,o,s);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.DHLoader: WebP required by asset but unsupported.");return r.loadTexture(e)}))},l.prototype.detectSupport=function(){return this.isSupported||(this.isSupported=new Promise((function(e){var t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported},c.prototype.loadBufferView=function(e){var t=this.parser.json,r=t.bufferViews[e];if(r.extensions&&r.extensions[this.name]){var n=r.extensions[this.name],i=this.parser.getDependency("buffer",n.buffer),a=this.parser.options.meshoptDecoder;if(!a||!a.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.DHLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([i,a.ready]).then((function(e){var t=n.byteOffset||0,r=n.byteLength||0,i=n.count,o=n.byteStride,s=new ArrayBuffer(i*o),l=new Uint8Array(e[0],t,r);return a.decodeGltfBuffer(new Uint8Array(s),i,o,l,n.mode,n.filter),s}))}return null};var h="glTF",u=1313821514,d=5130562;function p(e){this.name=r.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,12);if(this.header={magic:LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==h)throw new Error("THREE.DHLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.DHLoader: Legacy binary file detected.");for(var n=this.header.length-12,i=new DataView(e,12),a=0;a<n;){var o=i.getUint32(a,!0);a+=4;var s=i.getUint32(a,!0);if(a+=4,s===u){var l=new Uint8Array(e,12+a,o);this.content=LoaderUtils.decodeText(l)}else if(s===d){var c=12+a;this.body=e.slice(c,c+o)}a+=o}if(null===this.content)throw new Error("THREE.DHLoader: JSON content not found.")}function f(e,t){if(!t)throw new Error("THREE.DHLoader: No DRACOLoader instance provided.");this.name=r.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}function m(){this.name=r.KHR_TEXTURE_TRANSFORM}function g(e){MeshStandardMaterial.call(this),this.isGLTFSpecularGlossinessMaterial=!0;var t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),r=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),i=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),a=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),o={specular:{value:(new Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=o,this.onBeforeCompile=function(e){for(var s in o)e.uniforms[s]=o[s];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",t).replace("#include <metalnessmap_pars_fragment>",r).replace("#include <roughnessmap_fragment>",n).replace("#include <metalnessmap_fragment>",i).replace("#include <lights_physical_fragment>",a)},Object.defineProperties(this,{specular:{get:function(){return o.specular.value},set:function(e){o.specular.value=e}},specularMap:{get:function(){return o.specularMap.value},set:function(e){o.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return o.glossiness.value},set:function(e){o.glossiness.value=e}},glossinessMap:{get:function(){return o.glossinessMap.value},set:function(e){o.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}function y(){return{name:r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return g},extendParams:function(e,t,r){var n=t.extensions[this.name];e.color=new Color(1,1,1),e.opacity=1;var i=[];if(Array.isArray(n.diffuseFactor)){var a=n.diffuseFactor;e.color.fromArray(a),e.opacity=a[3]}if(void 0!==n.diffuseTexture&&i.push(r.assignTexture(e,"map",n.diffuseTexture)),e.emissive=new Color(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new Color(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){var o=n.specularGlossinessTexture;i.push(r.assignTexture(e,"glossinessMap",o)),i.push(r.assignTexture(e,"specularMap",o))}return Promise.all(i)},createMaterial:function(e){var t=new g(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=TangentSpaceNormalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}}function v(){this.name=r.KHR_MESH_QUANTIZATION}function b(e,t,r,n){Interpolant.call(this,e,t,r,n)}f.prototype.decodePrimitive=function(e,t){var r=this.json,n=this.dracoLoader,i=e.extensions[this.name].bufferView,a=e.extensions[this.name].attributes,o={},s={},l={};for(var c in a){var h=R[c]||c.toLowerCase();o[h]=a[c]}for(c in e.attributes){h=R[c]||c.toLowerCase();if(void 0!==a[c]){var u=r.accessors[e.attributes[c]],d=E[u.componentType];l[h]=d,s[h]=!0===u.normalized}}return t.getDependency("bufferView",i).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(var r in e.attributes){var n=e.attributes[r],i=s[r];void 0!==i&&(n.normalized=i)}t(e)}),o,l)}))}))},m.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&logger.warn('THREE.DHLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},g.prototype=Object.create(MeshStandardMaterial.prototype),g.prototype.constructor=g,g.prototype.copy=function(e){return MeshStandardMaterial.prototype.copy.call(this,e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},b.prototype=Object.create(Interpolant.prototype),b.prototype.constructor=b,b.prototype.copySampleValue_=function(e){for(var t=this.resultBuffer,r=this.sampleValues,n=this.valueSize,i=e*n*3+n,a=0;a!==n;a++)t[a]=r[i+a];return t},b.prototype.beforeStart_=b.prototype.copySampleValue_,b.prototype.afterEnd_=b.prototype.copySampleValue_,b.prototype.interpolate_=function(e,t,r,n){for(var i=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=2*o,l=3*o,c=n-t,h=(r-t)/c,u=h*h,d=u*h,p=e*l,f=p-l,m=-2*d+3*u,g=d-u,y=1-m,v=g-u+h,b=0;b!==o;b++){var _=a[f+b+o],x=a[f+b+s]*c,w=a[p+b+o],S=a[p+b]*c;i[b]=y*_+v*x+m*w+g*S}return i};var _=0,x=1,w=2,S=3,M=4,T=5,A=6,E={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},C={9728:NearestFilter,9729:LinearFilter,9984:NearestMipmapNearestFilter,9985:LinearMipmapNearestFilter,9986:NearestMipmapLinearFilter,9987:LinearMipmapLinearFilter},L={33071:ClampToEdgeWrapping,33648:MirroredRepeatWrapping,10497:RepeatWrapping},D={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},R={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},P={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},O={CUBICSPLINE:void 0,LINEAR:InterpolateLinear,STEP:InterpolateDiscrete},I="OPAQUE",k="MASK",B="BLEND";function N(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function F(e,t,r){for(var n in r.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=r.extensions[n])}function U(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):logger.warn("THREE.DHLoader: Ignoring primitive type .extras, "+t.extras))}function z(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var r=0,n=t.weights.length;r<n;r++)e.morphTargetInfluences[r]=t.weights[r];if(t.extras&&Array.isArray(t.extras.targetNames)){var i=t.extras.targetNames;if(e.morphTargetInfluences.length===i.length){e.morphTargetDictionary={};for(r=0,n=i.length;r<n;r++)e.morphTargetDictionary[i[r]]=r}else logger.warn("THREE.DHLoader: Invalid extras.targetNames length. Ignoring names.")}}function H(e){for(var t="",r=Object.keys(e).sort(),n=0,i=r.length;n<i;n++)t+=r[n]+":"+e[r[n]]+";";return t}function G(e,r){this.json=e||{},this.extensions={},this.plugins={},this.options=r||{},this.cache=new t,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new ImageBitmapLoader(this.options.manager):this.textureLoader=new TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function V(e,t,r){var n=t.attributes,i=[];function a(t,n){return r.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}))}for(var o in n){var s=R[o]||o.toLowerCase();s in e.attributes||i.push(a(n[o],s))}if(void 0!==t.indices&&!e.index){var l=r.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));i.push(l)}return U(e,t),function(e,t,r){var n=t.attributes,i=new Box3;if(void 0!==n.POSITION){var a=(d=r.json.accessors[n.POSITION]).min,o=d.max;if(void 0!==a&&void 0!==o){i.set(new Vector3(a[0],a[1],a[2]),new Vector3(o[0],o[1],o[2]));var s=t.targets;if(void 0!==s){for(var l=new Vector3,c=new Vector3,h=0,u=s.length;h<u;h++){var d,p=s[h];if(void 0!==p.POSITION)a=(d=r.json.accessors[p.POSITION]).min,o=d.max,void 0!==a&&void 0!==o?(c.setX(Math.max(Math.abs(a[0]),Math.abs(o[0]))),c.setY(Math.max(Math.abs(a[1]),Math.abs(o[1]))),c.setZ(Math.max(Math.abs(a[2]),Math.abs(o[2]))),l.max(c)):logger.warn("THREE.DHLoader: Missing min/max properties for accessor POSITION.")}i.expandByVector(l)}e.boundingBox=i;var f=new Sphere;i.getCenter(f.center),f.radius=i.min.distanceTo(i.max)/2,e.boundingSphere=f}else logger.warn("THREE.DHLoader: Missing min/max properties for accessor POSITION.")}}(e,t,r),Promise.all(i).then((function(){return void 0!==t.targets?function(e,t,r){for(var n=!1,i=!1,a=0,o=t.length;a<o&&(void 0!==(c=t[a]).POSITION&&(n=!0),void 0!==c.NORMAL&&(i=!0),!n||!i);a++);if(!n&&!i)return Promise.resolve(e);var s=[],l=[];for(a=0,o=t.length;a<o;a++){var c=t[a];if(n){var h=void 0!==c.POSITION?r.getDependency("accessor",c.POSITION):e.attributes.position;s.push(h)}i&&(h=void 0!==c.NORMAL?r.getDependency("accessor",c.NORMAL):e.attributes.normal,l.push(h))}return Promise.all([Promise.all(s),Promise.all(l)]).then((function(t){var r=t[0],a=t[1];return n&&(e.morphAttributes.position=r),i&&(e.morphAttributes.normal=a),e.morphTargetsRelative=!0,e}))}(e,t.targets,r):e}))}function j(e,t){var r=e.getIndex();if(null===r){var n=[],i=e.getAttribute("position");if(void 0===i)return logger.error("THREE.DHLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(var a=0;a<i.count;a++)n.push(a);e.setIndex(n),r=e.getIndex()}var o=r.count-2,s=[];if(t===TriangleFanDrawMode)for(a=1;a<=o;a++)s.push(r.getX(0)),s.push(r.getX(a)),s.push(r.getX(a+1));else for(a=0;a<o;a++)a%2==0?(s.push(r.getX(a)),s.push(r.getX(a+1)),s.push(r.getX(a+2))):(s.push(r.getX(a+2)),s.push(r.getX(a+1)),s.push(r.getX(a)));s.length/3!==o&&logger.error("THREE.DHLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var l=e.clone();return l.setIndex(s),l}return G.prototype.setExtensions=function(e){this.extensions=e},G.prototype.setPlugins=function(e){this.plugins=e},G.prototype.parse=function(e,t){var r=this,n=this.json,i=this.extensions;this.cache.removeAll(),this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([r.getDependencies("scene"),r.getDependencies("animation"),r.getDependencies("camera")])})).then((function(t){var a={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:r,userData:{}};F(i,a,n),U(a,n),Promise.all(r._invokeAll((function(e){return e.afterRoot&&e.afterRoot(a)}))).then((function(){e(a)}))})).catch(t)},G.prototype._markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[],n=0,i=t.length;n<i;n++)for(var a=t[n].joints,o=0,s=a.length;o<s;o++)e[a[o]].isBone=!0;for(var l=0,c=e.length;l<c;l++){var h=e[l];void 0!==h.mesh&&(this._addNodeRef(this.meshCache,h.mesh),void 0!==h.skin&&(r[h.mesh].isSkinnedMesh=!0)),void 0!==h.camera&&this._addNodeRef(this.cameraCache,h.camera)}},G.prototype._addNodeRef=function(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)},G.prototype._getNodeRef=function(e,t,r){if(e.refs[t]<=1)return r;var n=r.clone();return n.name+="_instance_"+e.uses[t]++,n},G.prototype._invokeOne=function(e){var t=Object.values(this.plugins);t.push(this);for(var r=0;r<t.length;r++){var n=e(t[r]);if(n)return n}},G.prototype._invokeAll=function(e){var t=Object.values(this.plugins);t.unshift(this);for(var r=[],n=0;n<t.length;n++){var i=e(t[n]);i&&r.push(i)}return r},G.prototype.getDependency=function(e,t){var r=e+":"+t,n=this.cache.get(r);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this.loadNode(t);break;case"mesh":n=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":n=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":n=this.loadSkin(t);break;case"animation":n=this.loadAnimation(t);break;case"camera":n=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(r,n)}return n},G.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var r=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map((function(t,n){return r.getDependency(e,n)}))),this.cache.add(e,t)}return t},G.prototype.loadBuffer=function(e){var t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.DHLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[r.KHR_BINARY_GLTF].body);var i=this.options;return new Promise((function(e,r){n.load(N(t.uri,i.path),e,void 0,(function(){r(new Error('THREE.DHLoader: Failed to load buffer "'+t.uri+'".'))}))}))},G.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){var r=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+r)}))},G.prototype.loadAccessor=function(e){var t=this,r=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);var i=[];return void 0!==n.bufferView?i.push(this.getDependency("bufferView",n.bufferView)):i.push(null),void 0!==n.sparse&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then((function(e){var i,a=e[0],o=D[n.type],s=E[n.componentType],l=s.BYTES_PER_ELEMENT,c=l*o,h=n.byteOffset||0,u=void 0!==n.bufferView?r.bufferViews[n.bufferView].byteStride:void 0,d=!0===n.normalized;if(u&&u!==c){var p=Math.floor(h/u),f="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+p+":"+n.count,m=t.cache.get(f);m||(m=new InterleavedBuffer(new s(a,p*u,n.count*u/l),u/l),t.cache.add(f,m)),i=new InterleavedBufferAttribute(m,o,h%u/l,d)}else i=new BufferAttribute(null===a?new s(n.count*o):new s(a,h,n.count*o),o,d);if(void 0!==n.sparse){var g=D.SCALAR,y=E[n.sparse.indices.componentType],v=n.sparse.indices.byteOffset||0,b=n.sparse.values.byteOffset||0,_=new y(e[1],v,n.sparse.count*g),x=new s(e[2],b,n.sparse.count*o);null!==a&&(i=new BufferAttribute(i.array.slice(),i.itemSize,i.normalized));for(var w=0,S=_.length;w<S;w++){var M=_[w];if(i.setX(M,x[w*o]),o>=2&&i.setY(M,x[w*o+1]),o>=3&&i.setZ(M,x[w*o+2]),o>=4&&i.setW(M,x[w*o+3]),o>=5)throw new Error("THREE.DHLoader: Unsupported itemSize in sparse BufferAttribute.")}}return i}))},G.prototype.loadTexture=function(e){var t=this.json,r=this.options,n=t.textures[e],i=t.images[n.source],a=this.textureLoader;if(i.uri){var o=r.manager.getHandler(i.uri);null!==o&&(a=o)}return this.loadTextureImage(e,i,a)},G.prototype.loadTextureImage=function(e,t,r){var n=this,i=this.json,a=this.options,o=i.textures[e],s=self.URL||self.webkitURL,l=t.uri,c=!1,h=!0;if("image/jpeg"===t.mimeType&&(h=!1),void 0!==t.bufferView)l=n.getDependency("bufferView",t.bufferView).then((function(e){if("image/png"===t.mimeType){var r=new DataView(e,25,1).getUint8(0,!1);h=6===r||4===r||3===r}c=!0;var n=new Blob([e],{type:t.mimeType});return l=s.createObjectURL(n)}));else if(void 0===t.uri)throw new Error("THREE.DHLoader: Image "+e+" is missing URI and bufferView");return Promise.resolve(l).then((function(e){return new Promise((function(t,n){var i=t;!0===r.isImageBitmapLoader&&(i=function(e){t(new CanvasTexture(e))}),r.load(N(e,a.path),i,void 0,n)}))})).then((function(t){!0===c&&s.revokeObjectURL(l),t.flipY=!1,o.name&&(t.name=o.name),h||(t.format=RGBFormat);var r=(i.samplers||{})[o.sampler]||{};return t.magFilter=C[r.magFilter]||LinearFilter,t.minFilter=C[r.minFilter]||LinearMipmapLinearFilter,t.wrapS=L[r.wrapS]||RepeatWrapping,t.wrapT=L[r.wrapT]||RepeatWrapping,n.associations.set(t,{type:"textures",index:e}),t}))},G.prototype.assignTexture=function(e,t,n){var i=this;return this.getDependency("texture",n.index).then((function(a){if(void 0===n.texCoord||0==n.texCoord||"aoMap"===t&&1==n.texCoord||logger.warn("THREE.DHLoader: Custom UV set "+n.texCoord+" for texture "+t+" not yet supported."),i.extensions[r.KHR_TEXTURE_TRANSFORM]){var o=void 0!==n.extensions?n.extensions[r.KHR_TEXTURE_TRANSFORM]:void 0;if(o){var s=i.associations.get(a);a=i.extensions[r.KHR_TEXTURE_TRANSFORM].extendTexture(a,o),i.associations.set(a,s)}}e[t]=a}))},G.prototype.assignFinalMaterial=function(e){var t=e.geometry,r=e.material,n=void 0!==t.attributes.tangent,i=void 0!==t.attributes.color,a=void 0===t.attributes.normal,o=!0===e.isSkinnedMesh,s=Object.keys(t.morphAttributes).length>0,l=s&&void 0!==t.morphAttributes.normal;if(e.isPoints){var c="PointsMaterial:"+r.uuid,h=this.cache.get(c);h||(h=new PointsMaterial,Material$1.prototype.copy.call(h,r),h.color.copy(r.color),h.map=r.map,h.sizeAttenuation=!1,this.cache.add(c,h)),r=h}else if(e.isLine){c="LineBasicMaterial:"+r.uuid;var u=this.cache.get(c);u||(u=new LineBasicMaterial,Material$1.prototype.copy.call(u,r),u.color.copy(r.color),this.cache.add(c,u)),r=u}if(n||i||a||o||s){c="ClonedMaterial:"+r.uuid+":";r.isGLTFSpecularGlossinessMaterial&&(c+="specular-glossiness:"),o&&(c+="skinning:"),n&&(c+="vertex-tangents:"),i&&(c+="vertex-colors:"),a&&(c+="flat-shading:"),s&&(c+="morph-targets:"),l&&(c+="morph-normals:");var d=this.cache.get(c);d||(d=r.clone(),o&&(d.skinning=!0),i&&(d.vertexColors=!0),a&&(d.flatShading=!0),s&&(d.morphTargets=!0),l&&(d.morphNormals=!0),n&&(d.vertexTangents=!0,d.normalScale&&(d.normalScale.y*=-1),d.clearcoatNormalScale&&(d.clearcoatNormalScale.y*=-1)),this.cache.add(c,d),this.associations.set(d,this.associations.get(r))),r=d}r.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=r},G.prototype.getMaterialType=function(){return MeshStandardMaterial},G.prototype.loadMaterial=function(e){var t,n=this,i=this.json,a=this.extensions,o=i.materials[e],s={},l=o.extensions||{},c=[];if(l[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var h=a[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=h.getMaterialType(),c.push(h.extendParams(s,o,n))}else if(l[r.KHR_MATERIALS_UNLIT]){var u=a[r.KHR_MATERIALS_UNLIT];t=u.getMaterialType(),c.push(u.extendParams(s,o,n))}else{var d=o.pbrMetallicRoughness||{};if(s.color=new Color(1,1,1),s.opacity=1,Array.isArray(d.baseColorFactor)){var p=d.baseColorFactor;s.color.fromArray(p),s.opacity=p[3]}void 0!==d.baseColorTexture&&c.push(n.assignTexture(s,"map",d.baseColorTexture)),s.metalness=void 0!==d.metallicFactor?d.metallicFactor:1,s.roughness=void 0!==d.roughnessFactor?d.roughnessFactor:1,void 0!==d.metallicRoughnessTexture&&(c.push(n.assignTexture(s,"metalnessMap",d.metallicRoughnessTexture)),c.push(n.assignTexture(s,"roughnessMap",d.metallicRoughnessTexture))),t=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),c.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,s)}))))}!0===o.doubleSided&&(s.side=DoubleSide);var f=o.alphaMode||I;return f===B?(s.transparent=!0,s.depthWrite=!1):(s.transparent=!1,f===k&&(s.alphaTest=void 0!==o.alphaCutoff?o.alphaCutoff:.5)),void 0!==o.normalTexture&&t!==MeshBasicMaterial&&(c.push(n.assignTexture(s,"normalMap",o.normalTexture)),s.normalScale=new Vector2(1,-1),void 0!==o.normalTexture.scale&&s.normalScale.set(o.normalTexture.scale,-o.normalTexture.scale)),void 0!==o.occlusionTexture&&t!==MeshBasicMaterial&&(c.push(n.assignTexture(s,"aoMap",o.occlusionTexture)),void 0!==o.occlusionTexture.strength&&(s.aoMapIntensity=o.occlusionTexture.strength)),void 0!==o.emissiveFactor&&t!==MeshBasicMaterial&&(s.emissive=(new Color).fromArray(o.emissiveFactor)),void 0!==o.emissiveTexture&&t!==MeshBasicMaterial&&c.push(n.assignTexture(s,"emissiveMap",o.emissiveTexture)),Promise.all(c).then((function(){var i;return i=t===g?a[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(s):new t(s),o.name&&(i.name=o.name),i.map&&(i.map.encoding=sRGBEncoding),i.emissiveMap&&(i.emissiveMap.encoding=sRGBEncoding),U(i,o),n.associations.set(i,{type:"materials",index:e}),o.extensions&&F(a,i,o),i}))},G.prototype.createUniqueName=function(e){for(var t=PropertyBinding.sanitizeNodeName(e||""),r=t,n=1;this.nodeNamesUsed[r];++n)r=t+"_"+n;return this.nodeNamesUsed[r]=!0,r},G.prototype.loadGeometries=function(e){var t=this,n=this.extensions,i=this.primitiveCache;function a(e){return n[r.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(r){return V(r,e,t)}))}for(var o,s,l=[],c=0,h=e.length;c<h;c++){var u,d=e[c],p=(s=void 0,(s=(o=d).extensions&&o.extensions[r.KHR_DRACO_MESH_COMPRESSION])?"draco:"+s.bufferView+":"+s.indices+":"+H(s.attributes):o.indices+":"+H(o.attributes)+":"+o.mode),f=i[p];if(f)l.push(f.promise);else u=d.extensions&&d.extensions[r.KHR_DRACO_MESH_COMPRESSION]?a(d):V(new BufferGeometry,d,t),i[p]={primitive:d,promise:u},l.push(u)}return Promise.all(l)},G.prototype.loadMesh=function(e){for(var t,r=this,n=this.json,i=this.extensions,a=n.meshes[e],o=a.primitives,s=[],l=0,c=o.length;l<c;l++){var h=void 0===o[l].material?(void 0===(t=this.cache).DefaultMaterial&&(t.DefaultMaterial=new MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:FrontSide})),t.DefaultMaterial):this.getDependency("material",o[l].material);s.push(h)}return s.push(r.loadGeometries(o)),Promise.all(s).then((function(t){for(var n=t.slice(0,t.length-1),s=t[t.length-1],l=[],c=0,h=s.length;c<h;c++){var u,d=s[c],p=o[c],f=n[c];if(p.mode===M||p.mode===T||p.mode===A||void 0===p.mode)!0!==(u=!0===a.isSkinnedMesh?new SkinnedMesh(d,f):new Mesh(d,f)).isSkinnedMesh||u.geometry.attributes.skinWeight.normalized||u.normalizeSkinWeights(),p.mode===T?u.geometry=j(u.geometry,TriangleStripDrawMode):p.mode===A&&(u.geometry=j(u.geometry,TriangleFanDrawMode));else if(p.mode===x)u=new LineSegments(d,f);else if(p.mode===S)u=new Line(d,f);else if(p.mode===w)u=new LineLoop(d,f);else{if(p.mode!==_)throw new Error("THREE.DHLoader: Primitive mode unsupported: "+p.mode);u=new Points(d,f)}Object.keys(u.geometry.morphAttributes).length>0&&z(u,a),u.name=r.createUniqueName(a.name||"mesh_"+e),U(u,a),p.extensions&&F(i,u,p),r.assignFinalMaterial(u),l.push(u)}if(1===l.length)return l[0];var m=new Group;for(c=0,h=l.length;c<h;c++)m.add(l[c]);return m}))},G.prototype.loadCamera=function(e){var t,r=this.json.cameras[e],n=r[r.type];if(n)return"perspective"===r.type?t=new PerspectiveCamera(MathUtils.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===r.type&&(t=new OrthographicCamera(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),r.name&&(t.name=this.createUniqueName(r.name)),U(t,r),Promise.resolve(t);logger.warn("THREE.DHLoader: Missing camera parameters.")},G.prototype.loadSkin=function(e){var t=this.json.skins[e],r={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(r):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return r.inverseBindMatrices=e,r}))},G.prototype.loadAnimation=function(e){for(var t=this.json.animations[e],r=[],n=[],i=[],a=[],o=[],s=0,l=t.channels.length;s<l;s++){var c=t.channels[s],h=t.samplers[c.sampler],u=c.target,d=void 0!==u.node?u.node:u.id,p=void 0!==t.parameters?t.parameters[h.input]:h.input,f=void 0!==t.parameters?t.parameters[h.output]:h.output;r.push(this.getDependency("node",d)),n.push(this.getDependency("accessor",p)),i.push(this.getDependency("accessor",f)),a.push(h),o.push(u)}return Promise.all([Promise.all(r),Promise.all(n),Promise.all(i),Promise.all(a),Promise.all(o)]).then((function(r){for(var n=r[0],i=r[1],a=r[2],o=r[3],s=r[4],l=[],c=0,h=n.length;c<h;c++){var u=n[c],d=i[c],p=a[c],f=o[c],m=s[c];if(void 0!==u){var g;switch(u.updateMatrix(),u.matrixAutoUpdate=!0,P[m.path]){case P.weights:g=NumberKeyframeTrack;break;case P.rotation:g=QuaternionKeyframeTrack;break;case P.position:case P.scale:default:g=VectorKeyframeTrack}var y=u.name?u.name:u.uuid,v=void 0!==f.interpolation?O[f.interpolation]:InterpolateLinear,_=[];P[m.path]===P.weights?u.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&_.push(e.name?e.name:e.uuid)})):_.push(y);var x=p.array;if(p.normalized){var w;if(x.constructor===Int8Array)w=1/127;else if(x.constructor===Uint8Array)w=1/255;else if(x.constructor==Int16Array)w=1/32767;else{if(x.constructor!==Uint16Array)throw new Error("THREE.DHLoader: Unsupported output accessor component type.");w=1/65535}for(var S=new Float32Array(x.length),M=0,T=x.length;M<T;M++)S[M]=x[M]*w;x=S}for(M=0,T=_.length;M<T;M++){var A=new g(_[M]+"."+P[m.path],d.array,x,v);"CUBICSPLINE"===f.interpolation&&(A.createInterpolant=function(e){return new b(this.times,this.values,this.getValueSize()/3,e)},A.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(A)}}}var E=t.name?t.name:"animation_"+e;return new AnimationClip(E,void 0,l)}))},G.prototype.loadNode=function(e){var t,r=this.json,n=this.extensions,i=this,a=r.nodes[e],o=a.name?i.createUniqueName(a.name):"";return(t=[],void 0!==a.mesh&&t.push(i.getDependency("mesh",a.mesh).then((function(e){var t=i._getNodeRef(i.meshCache,a.mesh,e);return void 0!==a.weights&&t.traverse((function(e){if(e.isMesh)for(var t=0,r=a.weights.length;t<r;t++)e.morphTargetInfluences[t]=a.weights[t]})),t}))),void 0!==a.camera&&t.push(i.getDependency("camera",a.camera).then((function(e){return i._getNodeRef(i.cameraCache,a.camera,e)}))),i._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)).then((function(t){var r;if((r=!0===a.isBone?new Bone:t.length>1?new Group:1===t.length?t[0]:new Object3D)!==t[0])for(var s=0,l=t.length;s<l;s++)r.add(t[s]);if(a.name&&(r.userData.name=a.name,r.name=o),U(r,a),a.extensions&&F(n,r,a),void 0!==a.matrix){var c=new Matrix4;c.fromArray(a.matrix),r.applyMatrix4(c)}else void 0!==a.translation&&r.position.fromArray(a.translation),void 0!==a.rotation&&r.quaternion.fromArray(a.rotation),void 0!==a.scale&&r.scale.fromArray(a.scale);return i.associations.set(r,{type:"nodes",index:e}),r}))},G.prototype.loadScene=function(){function e(t,r,n,i){var a=n.nodes[t];return i.getDependency("node",t).then((function(e){return void 0===a.skin?e:i.getDependency("skin",a.skin).then((function(e){for(var r=[],n=0,a=(t=e).joints.length;n<a;n++)r.push(i.getDependency("node",t.joints[n]));return Promise.all(r)})).then((function(r){return e.traverse((function(e){if(e.isMesh){for(var n=[],i=[],a=0,o=r.length;a<o;a++){var s=r[a];if(s){n.push(s);var l=new Matrix4;void 0!==t.inverseBindMatrices&&l.fromArray(t.inverseBindMatrices.array,16*a),i.push(l)}else logger.warn('THREE.DHLoader: Joint "%s" could not be found.',t.joints[a])}e.bind(new Skeleton(n,i),e.matrixWorld)}})),e}));var t})).then((function(t){r.add(t);var o=[];if(a.children)for(var s=a.children,l=0,c=s.length;l<c;l++){var h=s[l];o.push(e(h,t,n,i))}return Promise.all(o)}))}return function(t){var r=this.json,n=this.extensions,i=this.json.scenes[t],a=new Group;i.name&&(a.name=this.createUniqueName(i.name)),U(a,i),i.extensions&&F(n,a,i);for(var o=i.nodes||[],s=[],l=0,c=o.length;l<c;l++)s.push(e(o[l],a,r,this));return Promise.all(s).then((function(){return a}))}}(),e}(),DHLoaderAVWS=function(){function e(e){Loader.call(this,e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.dbPromise=openDB(INDEXED_DB_NAME,INDEXED_DB_VERSION,{upgrade(e,t,r,n){e.createObjectStore(INDEXED_DB_OBJECT_STORE)},blocked(){logger.warn("indexeddb request blocked.")},blocking(){logger.warn("indexeddb blocking another request.")},terminated(){logger.warn("indexeddb request terminated.")}}),this.register((function(e){return new a(e)})),this.register((function(e){return new s(e)})),this.register((function(e){return new l(e)})),this.register((function(e){return new o(e)})),this.register((function(e){return new n(e)})),this.register((function(e){return new c(e)}))}function t(){var e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}}}}e.prototype=Object.assign(Object.create(Loader.prototype),{constructor:e,load:function(e,t,r,n){var i,a=this;i=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:LoaderUtils.extractUrlBase(e),this.manager.itemStart(e);var o=function(t){n?n(t):logger.error(t),a.manager.itemError(e),a.manager.itemEnd(e)},s=new FileLoader(this.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials);let l=[];for(let e in this.requestHeader)l.push({key:e,value:this.requestHeader[e]});let c=util$1.fetchContentLastModified(e,l),h=md5(e);c.then((n=>{if("0"===n)return void s.load(e,(function(r){try{a.parse(r,i,(function(r){t(r),a.manager.itemEnd(e)}),o)}catch(e){o(e)}}),r,o);let l=md5(n);this.dbPromise.then((n=>{n.getAllKeys(INDEXED_DB_OBJECT_STORE).then((c=>{let u=!1;for(let s of c)if(0===s.indexOf(h)){s===`${h}:${l}`?(u=!0,n.get(INDEXED_DB_OBJECT_STORE,s).then((n=>{let s=n.byteLength;r&&r({type:"progress",total:s,loaded:s/2});try{a.parse(n,i,(function(n){r&&r({type:"progress",total:s,loaded:s}),t(n),a.manager.itemEnd(e)}),o)}catch(e){o(e)}}))):n.delete(INDEXED_DB_OBJECT_STORE,s).then((()=>{}));break}u||s.load(e,(function(r){try{a.parse(r,i,(function(r){t(r),a.manager.itemEnd(e)}),o),n.put(INDEXED_DB_OBJECT_STORE,r,`${h}:${l}`).then((()=>{logger.debug("db.put(CONST.INDEXED_DB_OBJECT_STORE, data, `${urlKey}:${lastModifiedKey}`)")}))}catch(e){o(e)}}),r,o)}))}))})).catch((()=>{s.load(e,(function(r){try{a.parse(r,i,(function(r){t(r),a.manager.itemEnd(e)}),o)}catch(e){o(e)}}),r,o)}))},setDRACOLoader:function(e){return this.dracoLoader=e,this},setDDSLoader:function(){throw new Error('THREE.DHLoaderAVWS: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')},setKTX2Loader:function(e){return this.ktx2Loader=e,this},setMeshoptDecoder:function(e){return this.meshoptDecoder=e,this},register:function(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this},unregister:function(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this},parse:function(e,t,n,a){var o,s={},l={};if("string"==typeof e)o=e;else{let t=new Uint8Array(e,0,AVW_HEADER.length);if(t[0]===AVW_HEADER[0]&&t[AVW_HEADER.length-1]===AVW_HEADER[AVW_HEADER.length-1]){e=e.slice(AVW_HEADER.length,e.byteLength);let t=new Uint8Array(e),r=8-AVW_STEP;for(let e=0;e<t.length;e++)t[e]=t[e]<<AVW_STEP|t[e]>>r}if(LoaderUtils.decodeText(new Uint8Array(e,0,4))===h){try{s[r.KHR_BINARY_GLTF]=new p(e)}catch(e){return void(a&&a(e))}o=s[r.KHR_BINARY_GLTF].content}else o=LoaderUtils.decodeText(new Uint8Array(e))}var c=JSON.parse(o);if(void 0===c.asset||c.asset.version[0]<2)a&&a(new Error("THREE.DHLoaderAVWS: Unsupported asset. glTF versions >=2.0 are supported."));else{var u=new G(c,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});u.fileLoader.setRequestHeader(this.requestHeader);for(var d=0;d<this.pluginCallbacks.length;d++){var g=this.pluginCallbacks[d](u);l[g.name]=g,s[g.name]=!0}if(c.extensionsUsed)for(d=0;d<c.extensionsUsed.length;++d){var b=c.extensionsUsed[d],_=c.extensionsRequired||[];switch(b){case r.KHR_MATERIALS_UNLIT:s[b]=new i;break;case r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:s[b]=new y;break;case r.KHR_DRACO_MESH_COMPRESSION:s[b]=new f(c,this.dracoLoader);break;case r.KHR_TEXTURE_TRANSFORM:s[b]=new m;break;case r.KHR_MESH_QUANTIZATION:s[b]=new v;break;default:_.indexOf(b)>=0&&void 0===l[b]&&logger.warn('THREE.DHLoaderAVWS: Unknown extension "'+b+'".')}}u.setExtensions(s),u.setPlugins(l),u.parse(n,a)}}});var r={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};function n(e){this.parser=e,this.name=r.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}function i(){this.name=r.KHR_MATERIALS_UNLIT}function a(e){this.parser=e,this.name=r.KHR_MATERIALS_CLEARCOAT}function o(e){this.parser=e,this.name=r.KHR_MATERIALS_TRANSMISSION}function s(e){this.parser=e,this.name=r.KHR_TEXTURE_BASISU}function l(e){this.parser=e,this.name=r.EXT_TEXTURE_WEBP,this.isSupported=null}function c(e){this.name=r.EXT_MESHOPT_COMPRESSION,this.parser=e}n.prototype._markDefs=function(){for(var e=this.parser,t=this.parser.json.nodes||[],r=0,n=t.length;r<n;r++){var i=t[r];i.extensions&&i.extensions[this.name]&&void 0!==i.extensions[this.name].light&&e._addNodeRef(this.cache,i.extensions[this.name].light)}},n.prototype._loadLight=function(e){var t=this.parser,r="light:"+e,n=t.cache.get(r);if(n)return n;var i,a=t.json,o=((a.extensions&&a.extensions[this.name]||{}).lights||[])[e],s=new Color(16777215);void 0!==o.color&&s.fromArray(o.color);var l=void 0!==o.range?o.range:0;switch(o.type){case"directional":(i=new DirectionalLight(s)).target.position.set(0,0,-1),i.add(i.target);break;case"point":(i=new PointLight(s)).distance=l;break;case"spot":(i=new SpotLight(s)).distance=l,o.spot=o.spot||{},o.spot.innerConeAngle=void 0!==o.spot.innerConeAngle?o.spot.innerConeAngle:0,o.spot.outerConeAngle=void 0!==o.spot.outerConeAngle?o.spot.outerConeAngle:Math.PI/4,i.angle=o.spot.outerConeAngle,i.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,i.target.position.set(0,0,-1),i.add(i.target);break;default:throw new Error("THREE.DHLoaderAVWS: Unexpected light type: "+o.type)}return i.position.set(0,0,0),i.decay=2,void 0!==o.intensity&&(i.intensity=o.intensity),i.name=t.createUniqueName(o.name||"light_"+e),n=Promise.resolve(i),t.cache.add(r,n),n},n.prototype.createNodeAttachment=function(e){var t=this,r=this.parser,n=r.json.nodes[e],i=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then((function(e){return r._getNodeRef(t.cache,i,e)}))},i.prototype.getMaterialType=function(){return MeshBasicMaterial},i.prototype.extendParams=function(e,t,r){var n=[];e.color=new Color(1,1,1),e.opacity=1;var i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){var a=i.baseColorFactor;e.color.fromArray(a),e.opacity=a[3]}void 0!==i.baseColorTexture&&n.push(r.assignTexture(e,"map",i.baseColorTexture))}return Promise.all(n)},a.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null},a.prototype.extendMaterialParams=function(e,t){var r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var i=[],a=n.extensions[this.name];if(void 0!==a.clearcoatFactor&&(t.clearcoat=a.clearcoatFactor),void 0!==a.clearcoatTexture&&i.push(r.assignTexture(t,"clearcoatMap",a.clearcoatTexture)),void 0!==a.clearcoatRoughnessFactor&&(t.clearcoatRoughness=a.clearcoatRoughnessFactor),void 0!==a.clearcoatRoughnessTexture&&i.push(r.assignTexture(t,"clearcoatRoughnessMap",a.clearcoatRoughnessTexture)),void 0!==a.clearcoatNormalTexture&&(i.push(r.assignTexture(t,"clearcoatNormalMap",a.clearcoatNormalTexture)),void 0!==a.clearcoatNormalTexture.scale)){var o=a.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new Vector2(o,-o)}return Promise.all(i)},o.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null},o.prototype.extendMaterialParams=function(e,t){var r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var i=[],a=n.extensions[this.name];return void 0!==a.transmissionFactor&&(t.transmission=a.transmissionFactor),void 0!==a.transmissionTexture&&i.push(r.assignTexture(t,"transmissionMap",a.transmissionTexture)),Promise.all(i)},s.prototype.loadTexture=function(e){var t=this.parser,r=t.json,n=r.textures[e];if(!n.extensions||!n.extensions[this.name])return null;var i=n.extensions[this.name],a=r.images[i.source],o=t.options.ktx2Loader;if(!o){if(r.extensionsRequired&&r.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.DHLoaderAVWS: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,a,o)},l.prototype.loadTexture=function(e){var t=this.name,r=this.parser,n=r.json,i=n.textures[e];if(!i.extensions||!i.extensions[t])return null;var a=i.extensions[t],o=n.images[a.source],s=r.textureLoader;if(o.uri){var l=r.options.manager.getHandler(o.uri);null!==l&&(s=l)}return this.detectSupport().then((function(i){if(i)return r.loadTextureImage(e,o,s);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.DHLoaderAVWS: WebP required by asset but unsupported.");return r.loadTexture(e)}))},l.prototype.detectSupport=function(){return this.isSupported||(this.isSupported=new Promise((function(e){var t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported},c.prototype.loadBufferView=function(e){var t=this.parser.json,r=t.bufferViews[e];if(r.extensions&&r.extensions[this.name]){var n=r.extensions[this.name],i=this.parser.getDependency("buffer",n.buffer),a=this.parser.options.meshoptDecoder;if(!a||!a.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.DHLoaderAVWS: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([i,a.ready]).then((function(e){var t=n.byteOffset||0,r=n.byteLength||0,i=n.count,o=n.byteStride,s=new ArrayBuffer(i*o),l=new Uint8Array(e[0],t,r);return a.decodeGltfBuffer(new Uint8Array(s),i,o,l,n.mode,n.filter),s}))}return null};var h="glTF",u=1313821514,d=5130562;function p(e){this.name=r.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,12);if(this.header={magic:LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==h)throw new Error("THREE.DHLoaderAVWS: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.DHLoaderAVWS: Legacy binary file detected.");for(var n=this.header.length-12,i=new DataView(e,12),a=0;a<n;){var o=i.getUint32(a,!0);a+=4;var s=i.getUint32(a,!0);if(a+=4,s===u){var l=new Uint8Array(e,12+a,o);this.content=LoaderUtils.decodeText(l)}else if(s===d){var c=12+a;this.body=e.slice(c,c+o)}a+=o}if(null===this.content)throw new Error("THREE.DHLoaderAVWS: JSON content not found.")}function f(e,t){if(!t)throw new Error("THREE.DHLoaderAVWS: No DRACOLoader instance provided.");this.name=r.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}function m(){this.name=r.KHR_TEXTURE_TRANSFORM}function g(e){MeshStandardMaterial.call(this),this.isGLTFSpecularGlossinessMaterial=!0;var t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),r=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),i=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),a=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),o={specular:{value:(new Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=o,this.onBeforeCompile=function(e){for(var s in o)e.uniforms[s]=o[s];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",t).replace("#include <metalnessmap_pars_fragment>",r).replace("#include <roughnessmap_fragment>",n).replace("#include <metalnessmap_fragment>",i).replace("#include <lights_physical_fragment>",a)},Object.defineProperties(this,{specular:{get:function(){return o.specular.value},set:function(e){o.specular.value=e}},specularMap:{get:function(){return o.specularMap.value},set:function(e){o.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return o.glossiness.value},set:function(e){o.glossiness.value=e}},glossinessMap:{get:function(){return o.glossinessMap.value},set:function(e){o.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}function y(){return{name:r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return g},extendParams:function(e,t,r){var n=t.extensions[this.name];e.color=new Color(1,1,1),e.opacity=1;var i=[];if(Array.isArray(n.diffuseFactor)){var a=n.diffuseFactor;e.color.fromArray(a),e.opacity=a[3]}if(void 0!==n.diffuseTexture&&i.push(r.assignTexture(e,"map",n.diffuseTexture)),e.emissive=new Color(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new Color(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){var o=n.specularGlossinessTexture;i.push(r.assignTexture(e,"glossinessMap",o)),i.push(r.assignTexture(e,"specularMap",o))}return Promise.all(i)},createMaterial:function(e){var t=new g(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=TangentSpaceNormalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}}function v(){this.name=r.KHR_MESH_QUANTIZATION}function b(e,t,r,n){Interpolant.call(this,e,t,r,n)}f.prototype.decodePrimitive=function(e,t){var r=this.json,n=this.dracoLoader,i=e.extensions[this.name].bufferView,a=e.extensions[this.name].attributes,o={},s={},l={};for(var c in a){var h=R[c]||c.toLowerCase();o[h]=a[c]}for(c in e.attributes){h=R[c]||c.toLowerCase();if(void 0!==a[c]){var u=r.accessors[e.attributes[c]],d=E[u.componentType];l[h]=d,s[h]=!0===u.normalized}}return t.getDependency("bufferView",i).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(var r in e.attributes){var n=e.attributes[r],i=s[r];void 0!==i&&(n.normalized=i)}t(e)}),o,l)}))}))},m.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&logger.warn('THREE.DHLoaderAVWS: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},g.prototype=Object.create(MeshStandardMaterial.prototype),g.prototype.constructor=g,g.prototype.copy=function(e){return MeshStandardMaterial.prototype.copy.call(this,e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},b.prototype=Object.create(Interpolant.prototype),b.prototype.constructor=b,b.prototype.copySampleValue_=function(e){for(var t=this.resultBuffer,r=this.sampleValues,n=this.valueSize,i=e*n*3+n,a=0;a!==n;a++)t[a]=r[i+a];return t},b.prototype.beforeStart_=b.prototype.copySampleValue_,b.prototype.afterEnd_=b.prototype.copySampleValue_,b.prototype.interpolate_=function(e,t,r,n){for(var i=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=2*o,l=3*o,c=n-t,h=(r-t)/c,u=h*h,d=u*h,p=e*l,f=p-l,m=-2*d+3*u,g=d-u,y=1-m,v=g-u+h,b=0;b!==o;b++){var _=a[f+b+o],x=a[f+b+s]*c,w=a[p+b+o],S=a[p+b]*c;i[b]=y*_+v*x+m*w+g*S}return i};var _=0,x=1,w=2,S=3,M=4,T=5,A=6,E={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},C={9728:NearestFilter,9729:LinearFilter,9984:NearestMipmapNearestFilter,9985:LinearMipmapNearestFilter,9986:NearestMipmapLinearFilter,9987:LinearMipmapLinearFilter},L={33071:ClampToEdgeWrapping,33648:MirroredRepeatWrapping,10497:RepeatWrapping},D={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},R={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},P={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},O={CUBICSPLINE:void 0,LINEAR:InterpolateLinear,STEP:InterpolateDiscrete},I="OPAQUE",k="MASK",B="BLEND";function N(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function F(e,t,r){for(var n in r.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=r.extensions[n])}function U(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):logger.warn("THREE.DHLoaderAVWS: Ignoring primitive type .extras, "+t.extras))}function z(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var r=0,n=t.weights.length;r<n;r++)e.morphTargetInfluences[r]=t.weights[r];if(t.extras&&Array.isArray(t.extras.targetNames)){var i=t.extras.targetNames;if(e.morphTargetInfluences.length===i.length){e.morphTargetDictionary={};for(r=0,n=i.length;r<n;r++)e.morphTargetDictionary[i[r]]=r}else logger.warn("THREE.DHLoaderAVWS: Invalid extras.targetNames length. Ignoring names.")}}function H(e){for(var t="",r=Object.keys(e).sort(),n=0,i=r.length;n<i;n++)t+=r[n]+":"+e[r[n]]+";";return t}function G(e,r){this.json=e||{},this.extensions={},this.plugins={},this.options=r||{},this.cache=new t,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new ImageBitmapLoader(this.options.manager):this.textureLoader=new TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function V(e,t,r){var n=t.attributes,i=[];function a(t,n){return r.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}))}for(var o in n){var s=R[o]||o.toLowerCase();s in e.attributes||i.push(a(n[o],s))}if(void 0!==t.indices&&!e.index){var l=r.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));i.push(l)}return U(e,t),function(e,t,r){var n=t.attributes,i=new Box3;if(void 0!==n.POSITION){var a=(d=r.json.accessors[n.POSITION]).min,o=d.max;if(void 0!==a&&void 0!==o){i.set(new Vector3(a[0],a[1],a[2]),new Vector3(o[0],o[1],o[2]));var s=t.targets;if(void 0!==s){for(var l=new Vector3,c=new Vector3,h=0,u=s.length;h<u;h++){var d,p=s[h];if(void 0!==p.POSITION)a=(d=r.json.accessors[p.POSITION]).min,o=d.max,void 0!==a&&void 0!==o?(c.setX(Math.max(Math.abs(a[0]),Math.abs(o[0]))),c.setY(Math.max(Math.abs(a[1]),Math.abs(o[1]))),c.setZ(Math.max(Math.abs(a[2]),Math.abs(o[2]))),l.max(c)):logger.warn("THREE.DHLoaderAVWS: Missing min/max properties for accessor POSITION.")}i.expandByVector(l)}e.boundingBox=i;var f=new Sphere;i.getCenter(f.center),f.radius=i.min.distanceTo(i.max)/2,e.boundingSphere=f}else logger.warn("THREE.DHLoaderAVWS: Missing min/max properties for accessor POSITION.")}}(e,t,r),Promise.all(i).then((function(){return void 0!==t.targets?function(e,t,r){for(var n=!1,i=!1,a=0,o=t.length;a<o&&(void 0!==(c=t[a]).POSITION&&(n=!0),void 0!==c.NORMAL&&(i=!0),!n||!i);a++);if(!n&&!i)return Promise.resolve(e);var s=[],l=[];for(a=0,o=t.length;a<o;a++){var c=t[a];if(n){var h=void 0!==c.POSITION?r.getDependency("accessor",c.POSITION):e.attributes.position;s.push(h)}i&&(h=void 0!==c.NORMAL?r.getDependency("accessor",c.NORMAL):e.attributes.normal,l.push(h))}return Promise.all([Promise.all(s),Promise.all(l)]).then((function(t){var r=t[0],a=t[1];return n&&(e.morphAttributes.position=r),i&&(e.morphAttributes.normal=a),e.morphTargetsRelative=!0,e}))}(e,t.targets,r):e}))}function j(e,t){var r=e.getIndex();if(null===r){var n=[],i=e.getAttribute("position");if(void 0===i)return logger.error("THREE.DHLoaderAVWS.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(var a=0;a<i.count;a++)n.push(a);e.setIndex(n),r=e.getIndex()}var o=r.count-2,s=[];if(t===TriangleFanDrawMode)for(a=1;a<=o;a++)s.push(r.getX(0)),s.push(r.getX(a)),s.push(r.getX(a+1));else for(a=0;a<o;a++)a%2==0?(s.push(r.getX(a)),s.push(r.getX(a+1)),s.push(r.getX(a+2))):(s.push(r.getX(a+2)),s.push(r.getX(a+1)),s.push(r.getX(a)));s.length/3!==o&&logger.error("THREE.DHLoaderAVWS.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var l=e.clone();return l.setIndex(s),l}return G.prototype.setExtensions=function(e){this.extensions=e},G.prototype.setPlugins=function(e){this.plugins=e},G.prototype.parse=function(e,t){var r=this,n=this.json,i=this.extensions;this.cache.removeAll(),this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([r.getDependencies("scene"),r.getDependencies("animation"),r.getDependencies("camera")])})).then((function(t){var a={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:r,userData:{}};F(i,a,n),U(a,n),Promise.all(r._invokeAll((function(e){return e.afterRoot&&e.afterRoot(a)}))).then((function(){e(a)}))})).catch(t)},G.prototype._markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[],n=0,i=t.length;n<i;n++)for(var a=t[n].joints,o=0,s=a.length;o<s;o++)e[a[o]].isBone=!0;for(var l=0,c=e.length;l<c;l++){var h=e[l];void 0!==h.mesh&&(this._addNodeRef(this.meshCache,h.mesh),void 0!==h.skin&&(r[h.mesh].isSkinnedMesh=!0)),void 0!==h.camera&&this._addNodeRef(this.cameraCache,h.camera)}},G.prototype._addNodeRef=function(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)},G.prototype._getNodeRef=function(e,t,r){if(e.refs[t]<=1)return r;var n=r.clone();return n.name+="_instance_"+e.uses[t]++,n},G.prototype._invokeOne=function(e){var t=Object.values(this.plugins);t.push(this);for(var r=0;r<t.length;r++){var n=e(t[r]);if(n)return n}},G.prototype._invokeAll=function(e){var t=Object.values(this.plugins);t.unshift(this);for(var r=[],n=0;n<t.length;n++){var i=e(t[n]);i&&r.push(i)}return r},G.prototype.getDependency=function(e,t){var r=e+":"+t,n=this.cache.get(r);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this.loadNode(t);break;case"mesh":n=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":n=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":n=this.loadSkin(t);break;case"animation":n=this.loadAnimation(t);break;case"camera":n=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(r,n)}return n},G.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var r=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map((function(t,n){return r.getDependency(e,n)}))),this.cache.add(e,t)}return t},G.prototype.loadBuffer=function(e){var t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.DHLoaderAVWS: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[r.KHR_BINARY_GLTF].body);var i=this.options;return new Promise((function(e,r){n.load(N(t.uri,i.path),e,void 0,(function(){r(new Error('THREE.DHLoaderAVWS: Failed to load buffer "'+t.uri+'".'))}))}))},G.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){var r=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+r)}))},G.prototype.loadAccessor=function(e){var t=this,r=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);var i=[];return void 0!==n.bufferView?i.push(this.getDependency("bufferView",n.bufferView)):i.push(null),void 0!==n.sparse&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then((function(e){var i,a=e[0],o=D[n.type],s=E[n.componentType],l=s.BYTES_PER_ELEMENT,c=l*o,h=n.byteOffset||0,u=void 0!==n.bufferView?r.bufferViews[n.bufferView].byteStride:void 0,d=!0===n.normalized;if(u&&u!==c){var p=Math.floor(h/u),f="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+p+":"+n.count,m=t.cache.get(f);m||(m=new InterleavedBuffer(new s(a,p*u,n.count*u/l),u/l),t.cache.add(f,m)),i=new InterleavedBufferAttribute(m,o,h%u/l,d)}else i=new BufferAttribute(null===a?new s(n.count*o):new s(a,h,n.count*o),o,d);if(void 0!==n.sparse){var g=D.SCALAR,y=E[n.sparse.indices.componentType],v=n.sparse.indices.byteOffset||0,b=n.sparse.values.byteOffset||0,_=new y(e[1],v,n.sparse.count*g),x=new s(e[2],b,n.sparse.count*o);null!==a&&(i=new BufferAttribute(i.array.slice(),i.itemSize,i.normalized));for(var w=0,S=_.length;w<S;w++){var M=_[w];if(i.setX(M,x[w*o]),o>=2&&i.setY(M,x[w*o+1]),o>=3&&i.setZ(M,x[w*o+2]),o>=4&&i.setW(M,x[w*o+3]),o>=5)throw new Error("THREE.DHLoaderAVWS: Unsupported itemSize in sparse BufferAttribute.")}}return i}))},G.prototype.loadTexture=function(e){var t=this.json,r=this.options,n=t.textures[e],i=t.images[n.source],a=this.textureLoader;if(i.uri){var o=r.manager.getHandler(i.uri);null!==o&&(a=o)}return this.loadTextureImage(e,i,a)},G.prototype.loadTextureImage=function(e,t,r){var n=this,i=this.json,a=this.options,o=i.textures[e],s=self.URL||self.webkitURL,l=t.uri,c=!1,h=!0;if("image/jpeg"===t.mimeType&&(h=!1),void 0!==t.bufferView)l=n.getDependency("bufferView",t.bufferView).then((function(e){if("image/png"===t.mimeType){var r=new DataView(e,25,1).getUint8(0,!1);h=6===r||4===r||3===r}c=!0;var n=new Blob([e],{type:t.mimeType});return l=s.createObjectURL(n)}));else if(void 0===t.uri)throw new Error("THREE.DHLoaderAVWS: Image "+e+" is missing URI and bufferView");return Promise.resolve(l).then((function(e){return new Promise((function(t,n){var i=t;!0===r.isImageBitmapLoader&&(i=function(e){t(new CanvasTexture(e))}),r.load(N(e,a.path),i,void 0,n)}))})).then((function(t){!0===c&&s.revokeObjectURL(l),t.flipY=!1,o.name&&(t.name=o.name),h||(t.format=RGBFormat);var r=(i.samplers||{})[o.sampler]||{};return t.magFilter=C[r.magFilter]||LinearFilter,t.minFilter=C[r.minFilter]||LinearMipmapLinearFilter,t.wrapS=L[r.wrapS]||RepeatWrapping,t.wrapT=L[r.wrapT]||RepeatWrapping,n.associations.set(t,{type:"textures",index:e}),t}))},G.prototype.assignTexture=function(e,t,n){var i=this;return this.getDependency("texture",n.index).then((function(a){if(void 0===n.texCoord||0==n.texCoord||"aoMap"===t&&1==n.texCoord||logger.warn("THREE.DHLoaderAVWS: Custom UV set "+n.texCoord+" for texture "+t+" not yet supported."),i.extensions[r.KHR_TEXTURE_TRANSFORM]){var o=void 0!==n.extensions?n.extensions[r.KHR_TEXTURE_TRANSFORM]:void 0;if(o){var s=i.associations.get(a);a=i.extensions[r.KHR_TEXTURE_TRANSFORM].extendTexture(a,o),i.associations.set(a,s)}}e[t]=a}))},G.prototype.assignFinalMaterial=function(e){var t=e.geometry,r=e.material,n=void 0!==t.attributes.tangent,i=void 0!==t.attributes.color,a=void 0===t.attributes.normal,o=!0===e.isSkinnedMesh,s=Object.keys(t.morphAttributes).length>0,l=s&&void 0!==t.morphAttributes.normal;if(e.isPoints){var c="PointsMaterial:"+r.uuid,h=this.cache.get(c);h||(h=new PointsMaterial,Material$1.prototype.copy.call(h,r),h.color.copy(r.color),h.map=r.map,h.sizeAttenuation=!1,this.cache.add(c,h)),r=h}else if(e.isLine){c="LineBasicMaterial:"+r.uuid;var u=this.cache.get(c);u||(u=new LineBasicMaterial,Material$1.prototype.copy.call(u,r),u.color.copy(r.color),this.cache.add(c,u)),r=u}if(n||i||a||o||s){c="ClonedMaterial:"+r.uuid+":";r.isGLTFSpecularGlossinessMaterial&&(c+="specular-glossiness:"),o&&(c+="skinning:"),n&&(c+="vertex-tangents:"),i&&(c+="vertex-colors:"),a&&(c+="flat-shading:"),s&&(c+="morph-targets:"),l&&(c+="morph-normals:");var d=this.cache.get(c);d||(d=r.clone(),o&&(d.skinning=!0),i&&(d.vertexColors=!0),a&&(d.flatShading=!0),s&&(d.morphTargets=!0),l&&(d.morphNormals=!0),n&&(d.vertexTangents=!0,d.normalScale&&(d.normalScale.y*=-1),d.clearcoatNormalScale&&(d.clearcoatNormalScale.y*=-1)),this.cache.add(c,d),this.associations.set(d,this.associations.get(r))),r=d}r.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=r},G.prototype.getMaterialType=function(){return MeshStandardMaterial},G.prototype.loadMaterial=function(e){var t,n=this,i=this.json,a=this.extensions,o=i.materials[e],s={},l=o.extensions||{},c=[];if(l[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var h=a[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=h.getMaterialType(),c.push(h.extendParams(s,o,n))}else if(l[r.KHR_MATERIALS_UNLIT]){var u=a[r.KHR_MATERIALS_UNLIT];t=u.getMaterialType(),c.push(u.extendParams(s,o,n))}else{var d=o.pbrMetallicRoughness||{};if(s.color=new Color(1,1,1),s.opacity=1,Array.isArray(d.baseColorFactor)){var p=d.baseColorFactor;s.color.fromArray(p),s.opacity=p[3]}void 0!==d.baseColorTexture&&c.push(n.assignTexture(s,"map",d.baseColorTexture)),s.metalness=void 0!==d.metallicFactor?d.metallicFactor:1,s.roughness=void 0!==d.roughnessFactor?d.roughnessFactor:1,void 0!==d.metallicRoughnessTexture&&(c.push(n.assignTexture(s,"metalnessMap",d.metallicRoughnessTexture)),c.push(n.assignTexture(s,"roughnessMap",d.metallicRoughnessTexture))),t=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),c.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,s)}))))}!0===o.doubleSided&&(s.side=DoubleSide);var f=o.alphaMode||I;return f===B?(s.transparent=!0,s.depthWrite=!1):(s.transparent=!1,f===k&&(s.alphaTest=void 0!==o.alphaCutoff?o.alphaCutoff:.5)),void 0!==o.normalTexture&&t!==MeshBasicMaterial&&(c.push(n.assignTexture(s,"normalMap",o.normalTexture)),s.normalScale=new Vector2(1,-1),void 0!==o.normalTexture.scale&&s.normalScale.set(o.normalTexture.scale,-o.normalTexture.scale)),void 0!==o.occlusionTexture&&t!==MeshBasicMaterial&&(c.push(n.assignTexture(s,"aoMap",o.occlusionTexture)),void 0!==o.occlusionTexture.strength&&(s.aoMapIntensity=o.occlusionTexture.strength)),void 0!==o.emissiveFactor&&t!==MeshBasicMaterial&&(s.emissive=(new Color).fromArray(o.emissiveFactor)),void 0!==o.emissiveTexture&&t!==MeshBasicMaterial&&c.push(n.assignTexture(s,"emissiveMap",o.emissiveTexture)),Promise.all(c).then((function(){var i;return i=t===g?a[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(s):new t(s),o.name&&(i.name=o.name),i.map&&(i.map.encoding=sRGBEncoding),i.emissiveMap&&(i.emissiveMap.encoding=sRGBEncoding),U(i,o),n.associations.set(i,{type:"materials",index:e}),o.extensions&&F(a,i,o),i}))},G.prototype.createUniqueName=function(e){return e},G.prototype.loadGeometries=function(e){var t=this,n=this.extensions,i=this.primitiveCache;function a(e){return n[r.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(r){return V(r,e,t)}))}for(var o,s,l=[],c=0,h=e.length;c<h;c++){var u,d=e[c],p=(s=void 0,(s=(o=d).extensions&&o.extensions[r.KHR_DRACO_MESH_COMPRESSION])?"draco:"+s.bufferView+":"+s.indices+":"+H(s.attributes):o.indices+":"+H(o.attributes)+":"+o.mode),f=i[p];if(f)l.push(f.promise);else u=d.extensions&&d.extensions[r.KHR_DRACO_MESH_COMPRESSION]?a(d):V(new BufferGeometry,d,t),i[p]={primitive:d,promise:u},l.push(u)}return Promise.all(l)},G.prototype.loadMesh=function(e){for(var t,r=this,n=this.json,i=this.extensions,a=n.meshes[e],o=a.primitives,s=[],l=0,c=o.length;l<c;l++){var h=void 0===o[l].material?(void 0===(t=this.cache).DefaultMaterial&&(t.DefaultMaterial=new MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:FrontSide})),t.DefaultMaterial):this.getDependency("material",o[l].material);s.push(h)}return s.push(r.loadGeometries(o)),Promise.all(s).then((function(t){for(var n=t.slice(0,t.length-1),s=t[t.length-1],l=[],c=0,h=s.length;c<h;c++){var u,d=s[c],p=o[c],f=n[c];if(p.mode===M||p.mode===T||p.mode===A||void 0===p.mode)!0!==(u=!0===a.isSkinnedMesh?new SkinnedMesh(d,f):new Mesh(d,f)).isSkinnedMesh||u.geometry.attributes.skinWeight.normalized||u.normalizeSkinWeights(),p.mode===T?u.geometry=j(u.geometry,TriangleStripDrawMode):p.mode===A&&(u.geometry=j(u.geometry,TriangleFanDrawMode));else if(p.mode===x)u=new LineSegments(d,f);else if(p.mode===S)u=new Line(d,f);else if(p.mode===w)u=new LineLoop(d,f);else{if(p.mode!==_)throw new Error("THREE.DHLoaderAVWS: Primitive mode unsupported: "+p.mode);u=new Points(d,f)}Object.keys(u.geometry.morphAttributes).length>0&&z(u,a),u.name=r.createUniqueName(a.name||"mesh_"+e),U(u,a),p.extensions&&F(i,u,p),r.assignFinalMaterial(u),l.push(u)}if(1===l.length)return l[0];var m=new Group;for(c=0,h=l.length;c<h;c++)m.add(l[c]);return m}))},G.prototype.loadCamera=function(e){var t,r=this.json.cameras[e],n=r[r.type];if(n)return"perspective"===r.type?t=new PerspectiveCamera(MathUtils.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===r.type&&(t=new OrthographicCamera(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),r.name&&(t.name=this.createUniqueName(r.name)),U(t,r),Promise.resolve(t);logger.warn("THREE.DHLoaderAVWS: Missing camera parameters.")},G.prototype.loadSkin=function(e){var t=this.json.skins[e],r={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(r):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return r.inverseBindMatrices=e,r}))},G.prototype.loadAnimation=function(e){for(var t=this.json.animations[e],r=[],n=[],i=[],a=[],o=[],s=0,l=t.channels.length;s<l;s++){var c=t.channels[s],h=t.samplers[c.sampler],u=c.target,d=void 0!==u.node?u.node:u.id,p=void 0!==t.parameters?t.parameters[h.input]:h.input,f=void 0!==t.parameters?t.parameters[h.output]:h.output;r.push(this.getDependency("node",d)),n.push(this.getDependency("accessor",p)),i.push(this.getDependency("accessor",f)),a.push(h),o.push(u)}return Promise.all([Promise.all(r),Promise.all(n),Promise.all(i),Promise.all(a),Promise.all(o)]).then((function(r){for(var n=r[0],i=r[1],a=r[2],o=r[3],s=r[4],l=[],c=0,h=n.length;c<h;c++){var u=n[c],d=i[c],p=a[c],f=o[c],m=s[c];if(void 0!==u){var g;switch(u.updateMatrix(),u.matrixAutoUpdate=!0,P[m.path]){case P.weights:g=NumberKeyframeTrack;break;case P.rotation:g=QuaternionKeyframeTrack;break;case P.position:case P.scale:default:g=VectorKeyframeTrack}var y=u.name?u.name:u.uuid,v=void 0!==f.interpolation?O[f.interpolation]:InterpolateLinear,_=[];P[m.path]===P.weights?u.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&_.push(e.name?e.name:e.uuid)})):_.push(y);var x=p.array;if(p.normalized){var w;if(x.constructor===Int8Array)w=1/127;else if(x.constructor===Uint8Array)w=1/255;else if(x.constructor==Int16Array)w=1/32767;else{if(x.constructor!==Uint16Array)throw new Error("THREE.DHLoaderAVWS: Unsupported output accessor component type.");w=1/65535}for(var S=new Float32Array(x.length),M=0,T=x.length;M<T;M++)S[M]=x[M]*w;x=S}for(M=0,T=_.length;M<T;M++){var A=new g(_[M]+"."+P[m.path],d.array,x,v);"CUBICSPLINE"===f.interpolation&&(A.createInterpolant=function(e){return new b(this.times,this.values,this.getValueSize()/3,e)},A.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(A)}}}var E=t.name?t.name:"animation_"+e;return new AnimationClip(E,void 0,l)}))},G.prototype.loadNode=function(e){var t,r=this.json,n=this.extensions,i=this,a=r.nodes[e],o=a.name?i.createUniqueName(a.name):"";return(t=[],void 0!==a.mesh&&t.push(i.getDependency("mesh",a.mesh).then((function(e){var t=i._getNodeRef(i.meshCache,a.mesh,e);return void 0!==a.weights&&t.traverse((function(e){if(e.isMesh)for(var t=0,r=a.weights.length;t<r;t++)e.morphTargetInfluences[t]=a.weights[t]})),t}))),void 0!==a.camera&&t.push(i.getDependency("camera",a.camera).then((function(e){return i._getNodeRef(i.cameraCache,a.camera,e)}))),i._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)).then((function(t){var r;if((r=!0===a.isBone?new Bone:t.length>1?new Group:1===t.length?t[0]:new Object3D)!==t[0])for(var s=0,l=t.length;s<l;s++)r.add(t[s]);if(a.name&&(r.userData.name=a.name,r.name=o),U(r,a),a.extensions&&F(n,r,a),void 0!==a.matrix){var c=new Matrix4;c.fromArray(a.matrix),r.applyMatrix4(c)}else void 0!==a.translation&&r.position.fromArray(a.translation),void 0!==a.rotation&&r.quaternion.fromArray(a.rotation),void 0!==a.scale&&r.scale.fromArray(a.scale);return i.associations.set(r,{type:"nodes",index:e}),r}))},G.prototype.loadScene=function(){function e(t,r,n,i){var a=n.nodes[t];return i.getDependency("node",t).then((function(e){return void 0===a.skin?e:i.getDependency("skin",a.skin).then((function(e){for(var r=[],n=0,a=(t=e).joints.length;n<a;n++)r.push(i.getDependency("node",t.joints[n]));return Promise.all(r)})).then((function(r){return e.traverse((function(e){if(e.isMesh){for(var n=[],i=[],a=0,o=r.length;a<o;a++){var s=r[a];if(s){n.push(s);var l=new Matrix4;void 0!==t.inverseBindMatrices&&l.fromArray(t.inverseBindMatrices.array,16*a),i.push(l)}else logger.warn('THREE.DHLoaderAVWS: Joint "%s" could not be found.',t.joints[a])}e.bind(new Skeleton(n,i),e.matrixWorld)}})),e}));var t})).then((function(t){r.add(t);var o=[];if(a.children)for(var s=a.children,l=0,c=s.length;l<c;l++){var h=s[l];o.push(e(h,t,n,i))}return Promise.all(o)}))}return function(t){var r=this.json,n=this.extensions,i=this.json.scenes[t],a=new Group;i.name&&(a.name=this.createUniqueName(i.name)),U(a,i),i.extensions&&F(n,a,i);for(var o=i.nodes||[],s=[],l=0,c=o.length;l<c;l++)s.push(e(o[l],a,r,this));return Promise.all(s).then((function(){return a}))}}(),e}(),heatmap=createCommonjsModule((function(e){var t,r;t=commonjsGlobal,r=function(){var e,t={defaultRadius:40,defaultRenderer:"canvas2d",defaultGradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},defaultMaxOpacity:1,defaultMinOpacity:0,defaultBlur:.85,defaultXField:"x",defaultYField:"y",defaultValueField:"value",plugins:{}},r=function(){var e=function(e){this._coordinator={},this._data=[],this._radi=[],this._min=10,this._max=1,this._xField=e.xField||e.defaultXField,this._yField=e.yField||e.defaultYField,this._valueField=e.valueField||e.defaultValueField,e.radius&&(this._cfgRadius=e.radius)},r=t.defaultRadius;return e.prototype={_organiseData:function(e,t){var n=e[this._xField],i=e[this._yField],a=this._radi,o=this._data,s=this._max,l=this._min,c=e[this._valueField]||1,h=e.radius||this._cfgRadius||r;o[n]||(o[n]=[],a[n]=[]),o[n][i]?o[n][i]+=c:(o[n][i]=c,a[n][i]=h);var u=o[n][i];return u>s?(t?this.setDataMax(u):this._max=u,!1):u<l?(t?this.setDataMin(u):this._min=u,!1):{x:n,y:i,value:c,radius:h,min:l,max:s}},_unOrganizeData:function(){var e=[],t=this._data,r=this._radi;for(var n in t)for(var i in t[n])e.push({x:n,y:i,radius:r[n][i],value:t[n][i]});return{min:this._min,max:this._max,data:e}},_onExtremaChange:function(){this._coordinator.emit("extremachange",{min:this._min,max:this._max})},addData:function(){if(arguments[0].length>0)for(var e=arguments[0],t=e.length;t--;)this.addData.call(this,e[t]);else{var r=this._organiseData(arguments[0],!0);r&&(0===this._data.length&&(this._min=this._max=r.value),this._coordinator.emit("renderpartial",{min:this._min,max:this._max,data:[r]}))}return this},setData:function(e){var t=e.data,r=t.length;this._data=[],this._radi=[];for(var n=0;n<r;n++)this._organiseData(t[n],!1);return this._max=e.max,this._min=e.min||0,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},removeData:function(){},setDataMax:function(e){return this._max=e,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setDataMin:function(e){return this._min=e,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setCoordinator:function(e){this._coordinator=e},_getInternalData:function(){return{max:this._max,min:this._min,data:this._data,radi:this._radi}},getData:function(){return this._unOrganizeData()}},e}(),n=function(){var e=function(e){var t=e.gradient||e.defaultGradient,r=document.createElement("canvas"),n=r.getContext("2d");r.width=256,r.height=1;var i=n.createLinearGradient(0,0,256,1);for(var a in t)i.addColorStop(a,t[a]);return n.fillStyle=i,n.fillRect(0,0,256,1),n.getImageData(0,0,256,1).data},t=function(e,t){var r=document.createElement("canvas"),n=r.getContext("2d"),i=e,a=e;if(r.width=r.height=2*e,1==t)n.beginPath(),n.arc(i,a,e,0,2*Math.PI,!1),n.fillStyle="rgba(0,0,0,1)",n.fill();else{var o=n.createRadialGradient(i,a,e*t,i,a,e);o.addColorStop(0,"rgba(0,0,0,1)"),o.addColorStop(1,"rgba(0,0,0,0)"),n.fillStyle=o,n.fillRect(0,0,2*e,2*e)}return r};function r(t){var r=t.container,n=this.shadowCanvas=document.createElement("canvas"),i=this.canvas=t.canvas||document.createElement("canvas");this._renderBoundaries=[1e4,1e4,0,0];var a=getComputedStyle(t.container)||{};i.className="heatmap-canvas",this._width=i.width=n.width=t.width||+a.width.replace(/px/,""),this._height=i.height=n.height=t.height||+a.height.replace(/px/,""),this.shadowCtx=n.getContext("2d"),this.ctx=i.getContext("2d"),i.style.cssText=n.style.cssText="position:absolute;left:0;top:0;",r.style.position="relative",r.appendChild(i),this._palette=e(t),this._templates={},this._setStyles(t)}return r.prototype={renderPartial:function(e){e.data.length>0&&(this._drawAlpha(e),this._colorize())},renderAll:function(e){this._clear(),e.data.length>0&&(this._drawAlpha(function(e){for(var t=[],r=e.min,n=e.max,i=e.radi,a=(e=e.data,Object.keys(e)),o=a.length;o--;)for(var s=a[o],l=Object.keys(e[s]),c=l.length;c--;){var h=l[c],u=e[s][h],d=i[s][h];t.push({x:s,y:h,value:u,radius:d})}return{min:r,max:n,data:t}}(e)),this._colorize())},_updateGradient:function(t){this._palette=e(t)},updateConfig:function(e){e.gradient&&this._updateGradient(e),this._setStyles(e)},setDimensions:function(e,t){this._width=e,this._height=t,this.canvas.width=this.shadowCanvas.width=e,this.canvas.height=this.shadowCanvas.height=t},_clear:function(){this.shadowCtx.clearRect(0,0,this._width,this._height),this.ctx.clearRect(0,0,this._width,this._height)},_setStyles:function(e){this._blur=0==e.blur?0:e.blur||e.defaultBlur,e.backgroundColor&&(this.canvas.style.backgroundColor=e.backgroundColor),this._width=this.canvas.width=this.shadowCanvas.width=e.width||this._width,this._height=this.canvas.height=this.shadowCanvas.height=e.height||this._height,this._opacity=255*(e.opacity||0),this._maxOpacity=255*(e.maxOpacity||e.defaultMaxOpacity),this._minOpacity=255*(e.minOpacity||e.defaultMinOpacity),this._useGradientOpacity=!!e.useGradientOpacity},_drawAlpha:function(e){for(var r=this._min=e.min,n=this._max=e.max,i=(e=e.data||[]).length,a=1-this._blur;i--;){var o,s=e[i],l=s.x,c=s.y,h=s.radius,u=Math.min(s.value,n),d=l-h,p=c-h,f=this.shadowCtx;this._templates[h]?o=this._templates[h]:this._templates[h]=o=t(h,a);var m=(u-r)/(n-r);f.globalAlpha=m<.01?.01:m,f.drawImage(o,d,p),d<this._renderBoundaries[0]&&(this._renderBoundaries[0]=d),p<this._renderBoundaries[1]&&(this._renderBoundaries[1]=p),d+2*h>this._renderBoundaries[2]&&(this._renderBoundaries[2]=d+2*h),p+2*h>this._renderBoundaries[3]&&(this._renderBoundaries[3]=p+2*h)}},_colorize:function(){var e=this._renderBoundaries[0],t=this._renderBoundaries[1],r=this._renderBoundaries[2]-e,n=this._renderBoundaries[3]-t,i=this._width,a=this._height,o=this._opacity,s=this._maxOpacity,l=this._minOpacity,c=this._useGradientOpacity;e<0&&(e=0),t<0&&(t=0),e+r>i&&(r=i-e),t+n>a&&(n=a-t);for(var h=this.shadowCtx.getImageData(e,t,r,n),u=h.data,d=u.length,p=this._palette,f=3;f<d;f+=4){var m,g=u[f],y=4*g;y&&(m=o>0?o:g<s?g<l?l:g:s,u[f-3]=p[y],u[f-2]=p[y+1],u[f-1]=p[y+2],u[f]=c?p[y+3]:m)}this.ctx.putImageData(h,e,t),this._renderBoundaries=[1e3,1e3,0,0]},getValueAt:function(e){var t=this.shadowCtx.getImageData(e.x,e.y,1,1).data[3],r=this._max,n=this._min;return Math.abs(r-n)*(t/255)>>0},getDataURL:function(){return this.canvas.toDataURL()}},r}(),i=(e=!1,"canvas2d"===t.defaultRenderer&&(e=n),e),a=function(){for(var e={},t=arguments.length,r=0;r<t;r++){var n=arguments[r];for(var i in n)e[i]=n[i]}return e},o=function(){var e=function(){function e(){this.cStore={}}return e.prototype={on:function(e,t,r){var n=this.cStore;n[e]||(n[e]=[]),n[e].push((function(e){return t.call(r,e)}))},emit:function(e,t){var r=this.cStore;if(r[e])for(var n=r[e].length,i=0;i<n;i++)(0,r[e][i])(t)}},e}(),n=function(e){var t=e._renderer,r=e._coordinator,n=e._store;r.on("renderpartial",t.renderPartial,t),r.on("renderall",t.renderAll,t),r.on("extremachange",(function(t){e._config.onExtremaChange&&e._config.onExtremaChange({min:t.min,max:t.max,gradient:e._config.gradient||e._config.defaultGradient})})),n.setCoordinator(r)};function o(){var o=this._config=a(t,arguments[0]||{});if(this._coordinator=new e,o.plugin){var s=o.plugin;if(!t.plugins[s])throw new Error("Plugin '"+s+"' not found. Maybe it was not registered.");var l=t.plugins[s];this._renderer=new l.renderer(o),this._store=new l.store(o)}else this._renderer=new i(o),this._store=new r(o);n(this)}return o.prototype={addData:function(){return this._store.addData.apply(this._store,arguments),this},removeData:function(){return this._store.removeData&&this._store.removeData.apply(this._store,arguments),this},setData:function(){return this._store.setData.apply(this._store,arguments),this},setDataMax:function(){return this._store.setDataMax.apply(this._store,arguments),this},setDataMin:function(){return this._store.setDataMin.apply(this._store,arguments),this},configure:function(e){return this._config=a(this._config,e),this._renderer.updateConfig(this._config),this._coordinator.emit("renderall",this._store._getInternalData()),this},repaint:function(){return this._coordinator.emit("renderall",this._store._getInternalData()),this},getData:function(){return this._store.getData()},getDataURL:function(){return this._renderer.getDataURL()},getValueAt:function(e){return this._store.getValueAt?this._store.getValueAt(e):this._renderer.getValueAt?this._renderer.getValueAt(e):null}},o}();return{create:function(e){return new o(e)},register:function(e,r){t.plugins[e]=r}}},e.exports?e.exports=r():t.h337=r()}));class AnimationStore{constructor(){var e=[],t=!1;this.add=t=>{e.push(t)},this.findMaterialAnimation=(t,r)=>{let n=e.find((e=>e.material?e.material===t:e._material===t));if(n&&n.type===r)return n},this.findNodeAnimation=(t,r)=>{for(let n=0;n<e.length;n++)if(e[n].animationObject===t&&e[n]&&e[n].type===r)return e[n]},this.findInstancedAnimation=(t,r,n)=>{for(let i=0;i<e.length;i++)if(e[i].instancedMesh===t&&e[i]&&e[i].type===n&&e[i]&&e[i].instanceId===r)return e[i]},this.findDrawableAnimation=(t,r)=>{let n=e.find((e=>e.object===t));if(n&&n.type===r)return n},this.findLayerAnimation=(t,r)=>{let n=e.find((e=>e.name===t&&e._type===r));if(n)return n},this.findAnimation=(t,r)=>{let n=e.find((e=>r?e.name===t&&e._type===r:e.name===t));if(n)return n},this.findAnimationByPathId=(t,r)=>e.filter((e=>t&&e.pathId===t&&e._type===r)),this.pause=()=>{t=!0},this.remove=t=>{for(let r=e.length-1;r>=0;r--)e[r]===t&&(e[r].dispose(),e[r]=null,e.splice(r,1))},this.resume=()=>{t=!1},this.update=r=>{if(!t)for(let t of e)t.needsRemove?this.remove(t):t.update(r)},this.addDistance=(e,t,r,n,i)=>{let a=this.findLayerAnimation(e,t.type);a&&(this.remove(a),a=null),a=new t(r,n,e,i),this.add(a)},this.getAnimations=()=>e}}class CacheStore{constructor(){this._cache||(this._cache=new Map),this.helper=new CacheStoreHelper}load({path:e,type:t,onLoad:r,onProgress:n,onError:i}={}){if(!e||""===e)return;let a;if(e instanceof Array){let t="";for(let r of e)t+=r;a=md5(t)}else a=md5(e);-1!=e.indexOf("[[origin]]")&&(e=e.replace("[[origin]]",_context.origin));let o=this._cache.get(a);if(o)if("function"==typeof r)r(this.helper.cloneNode(o));else switch(t.toLowerCase()){case"texture":case"cubetexture":return this.helper.cloneNode(o)}else switch(this._cache.set(a,null),t.toLowerCase()){case"avws":_context.loaders.gltfLoaderAVWS.load(e,(e=>{if(0===e.animations.length){let t=this.helper.autoMerge(e.scene);this._cache.set(a,t)}else this._cache.set(a,e.scene);"function"==typeof r&&r(this._cache.get(a))}),n,i);break;case"glb":case"gltf":_context.loaders.gltfLoader.load(e,(e=>{if(0===e.animations.length){let t=this.helper.autoMerge(e.scene);this._cache.set(a,t)}else this._cache.set(a,e.scene);"function"==typeof r&&r(this.helper.cloneNode(this._cache.get(a)))}),n,i);break;case"texture":return _context.loaders.textureLoader.load(e,(e=>{this._cache.set(a,e),"function"==typeof r&&r(this._cache.get(a))}),n,i);case"cubetexture":return _context.loaders.cubeTextureLoader.load(e,(e=>{this._cache.set(a,e),"function"==typeof r&&r(this._cache.get(a))}),n,i)}}clear(){this._scene}destroy(){this._cache.forEach((e=>{util$1.disposeThreeObject(e)}))}find(e){if(e)return this._cache.get(md5(e))}remove(e,t){this._scene}copy(e,t){}getSettings(){}applySettings(e){e||logger.error("无效的模型设置。")}}class CacheStoreHelper{constructor(){this.cloneNode=e=>{let t=e.clone();return e instanceof Texture$1||e instanceof CubeTexture||t.traverse((e=>{if(e.isMesh){if(e.material instanceof Array){let t=[];for(let r of e.material){let e=r.clone();for(let t in e)e[t]instanceof Texture$1&&(e[t]=e[t].clone());t.push(e)}e.material=t}else if(e.material instanceof Material$1){e.material=e.material.clone();for(let t in e.material)e.material[t]instanceof Texture$1&&(e.material[t]=e.material[t].clone())}e.geometry instanceof BufferGeometry&&(e.geometry=e.geometry.clone())}})),t},this.autoMerge=e=>{if(e.isGroup)return this.recurse(e),e},this.recurse=e=>{if(this.checkCapableToMerge(e))this.doMerge(e);else if(this.checkGroupCapableToMerge(e))this.doGroupMerge(e);else for(let t=e.children.length-1;t>=0;t--)this.recurse(e.children[t])},this.doMerge=e=>{let t=[],r=[],n=[];for(let i of e.children)if(isNaN(Number(i.name.replace(e.name+"_",""))))t.push(i);else if(i.isMesh){r.push(i.geometry);let e=i.material.clone();e.vertexColors=!1,n.push(e)}let i=BufferGeometryUtils.mergeBufferGeometries(r),a=0,o=0;for(let e of r)i.addGroup(a,e.index.count,o),a+=e.index.count,o++;let s=new Mesh(i,n);s.name=e.name,s.visible=e.visible,s.castShadow=!0,s.receiveShadow=!0,s.position.copy(e.position),s.rotation.copy(e.rotation),s.scale.copy(e.scale);for(let e of t)s.add(e);this.recurse(s),util$1.disposeThreeObject(e),e.parent.add(s),e.parent.remove(e)},this.doGroupMerge=e=>{let t=[],r=[],n=[],i=[];for(let a of e.children)if(a.name.indexOf("_water_")<0)if(isNaN(Number(a.name.replace("mesh_",""))))t.push(a);else if(a.isMesh){n.push(a.geometry.index),r.push(a.geometry.toNonIndexed());let e=a.material.clone();e.vertexColors=!1,i.push(e)}let a=BufferGeometryUtils.mergeBufferGeometries(r),o=0,s=0;for(let e of n)a.addGroup(o,e.count,s),o+=e.count,s++;let l=new Mesh(a,i);l.name=e.name,l.visible=e.visible,l.castShadow=!0,l.receiveShadow=!0,l.position.copy(e.position),l.rotation.copy(e.rotation),l.scale.copy(e.scale);for(let e of t)l.add(e);this.recurse(l),util$1.disposeThreeObject(e),e.parent.add(l),e.parent.remove(e)},this.checkCapableToMerge=e=>{if(!e.isGroup||""===e.name)return!1;if(!(e.children instanceof Array)||e.children.length<2)return!1;let t=0;for(let r of e.children)r.name.indexOf(e.name+"_")>-1&&(t+=1);return t>=2||void 0},this.checkGroupCapableToMerge=e=>{if(!e.isGroup||""===e.name)return!1;if(!(e.children instanceof Array)||e.children.length<2)return!1;e.children[0].name;let t=0;for(let r of e.children)r.name.indexOf("mesh_")>-1&&(t+=1);return t>=2||void 0}}}class ClippingStore{constructor(){var e=[];this.add=(t,r,n,i,a,o)=>{let s;this.findCutBulidingByUUID(t)&&this.remove(t),_context.scene.models.traverse((e=>{e.uuid===t&&(s=e)})),s||(s=_context.scene.getObjectByName(t));var l={uuid:t,clippingController:new ClippingController({meshes:[s],clippingPlanes:[{nx:r,ny:n,nz:i,d:a}]})};e.push(l),o&&o(1,"成功")},this.remove=(t,r)=>{let n=this.findCutBulidingByUUID(t);if(n){n.clippingController.clear();for(let r=0;r<e.length;r++)e[r].uuid===t&&(delete e[r].clippingController,e.splice(r,1),r--);r&&r(1,"删除成功")}else r&&r(0,"不存在的裁剪建筑")},this.findCutBulidingByUUID=(t,r)=>{var n=e.find((e=>e.uuid===t));if(n)return r&&r(1,"成功"),n;r&&r(0,"不存在的裁剪建筑")}}}class EffectStore{constructor(){this._effects={},this._lutPassEnabled=!1,_context.composer=new EffectComposer(_context.renderer,{frameBufferType:HalfFloatType}),_context.composer.multisampling=Math.min(4,_context.renderer.getContext().getParameter(_context.renderer.getContext().MAX_SAMPLES));let e=new RenderPass(_context.scene,_context.camera);_context.composer.addPass(e),this.visualEffect=new VisualEffect,this.spaceEffect=new SpaceEffect}setSize(e,t){_context.composer.setSize(e,t)}setLut(e="disabled"){this.lutMap[e]?(this.lutPass.enabled=!0,this.lutPass.intensity=1,this.lutPass.lut=this.lutMap[e].texture3D):(this.lutPass.enabled=!1,this.lutPass.lut=null)}enableLut(){return this._lutPassEnabled=!0,this.lutPass&&(this.lutPass.enabled=!0),!!this.lutPass&&this.lutPass.enabled}disableLut(){return this._lutPassEnabled=!1,this.lutPass&&(this.lutPass.enabled=!1),!!this.lutPass&&this.lutPass.enabled}nextLut(){this.lutPass.enabled||this.enableLut(),this.lutSelected="";for(let e in this.lutMap){if(""!==this.lutSelected){this.lutSelected=e,this.lutPass.lut=this.lutMap[this.lutSelected].texture3D;break}if(this.lutMap[e].texture3D===this.lutPass.lut&&(this.lutSelected=e,"Zeke 39.CUBE"===this.lutSelected)){this.lutSelected="Arabica 12.CUBE",this.lutPass.lut=this.lutMap[this.lutSelected].texture3D;break}}return this.lutSelected}render(e){_context.composer.render(e)}takeSnapshot({targetWidth:e=258,targetHeight:t=160,targetEncoder:r=.3}={}){let n=_context.renderer.getSize(),i=_context.camera.fov,a=_context.camera.aspect;e/t>_context.camera.aspect?_context.camera.aspect=e/t:(_context.camera.aspect=e/t,_context.camera.fov=Math.atan(a/_context.camera.aspect*Math.tan(i/180*Math.PI/2))/Math.PI*180*2),_context.camera.updateProjectionMatrix(),_context.composer.setSize(e,t),_context.composer.render();let o=_context.renderer.domElement.toDataURL("image/jpeg",r);return _context.camera.aspect=a,_context.camera.fov=i,_context.camera.updateProjectionMatrix(),_context.composer.setSize(n.width,n.height),o}highlightObject(e,t){if(!this.visualEffect._passes.outlinePass||!this.visualEffect._passes.outlinePass.outlineEffect)return;if(!e){if(this.visualEffect._passes.outlinePass.outlineEffect.selection.clear(),this.visualEffect._passes.outlinePass.outlineEffect.time=1e4,!_context.composer.passes.find((e=>"ArticulationOutlineEffect"==e.name))){let e=_context.composer.passes.findIndex((e=>"OutlinePass"==e.name)),t=Array.from(this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection);this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection.clear(),_context.composer.addPass(this.visualEffect._passes.articulationOutlinePass,e+1),t.forEach((e=>{this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection.add(e)}))}return}var r=this;let n=_context.composer.passes.find((e=>"ArticulationOutlineEffect"==e.name));n&&_context.composer.removePass(n),e.children.length>0?(t||(this.visualEffect._passes.outlinePass.outlineEffect.selection.clear(),this.visualEffect._passes.outlinePass.outlineEffect.time=1e4),e.traverse((function(e){"IconAsset"!==e.type&&"IconBackground"!==e.type&&r.visualEffect._passes.outlinePass.outlineEffect.selection.add(e)}))):t?(this.visualEffect._passes.outlinePass.outlineEffect.selection.add(e),"IconAsset"!==e.type&&"IconBackground"!==e.type&&r.visualEffect._passes.outlinePass.outlineEffect.selection.add(e)):(this.visualEffect._passes.outlinePass.outlineEffect.selection.clear(),this.visualEffect._passes.outlinePass.outlineEffect.time=1e4,"IconAsset"!==e.type&&"IconBackground"!==e.type&&r.visualEffect._passes.outlinePass.outlineEffect.selection.add(e))}cancleHighlightObject(e){if(!this.visualEffect._passes.outlinePass||!this.visualEffect._passes.outlinePass.outlineEffect)return;if(!_context.composer.passes.find((e=>"ArticulationOutlineEffect"==e.name))){let e=_context.composer.passes.findIndex((e=>"OutlinePass"==e.name));_context.composer.addPass(this.visualEffect._passes.articulationOutlinePass,e+1)}var t=this;if(e.children.length>0?e.traverse((function(e){t.visualEffect._passes.outlinePass.outlineEffect.selection.delete(e)})):this.visualEffect._passes.outlinePass.outlineEffect.selection.delete(e),this.visualEffect._passes.outlinePass.outlineEffect.selection.size<=0){if(!_context.composer.passes.find((e=>"ArticulationOutlineEffect"==e.name))){let e=_context.composer.passes.findIndex((e=>"OutlinePass"==e.name)),t=Array.from(this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection);this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection.clear(),_context.composer.addPass(this.visualEffect._passes.articulationOutlinePass,e+1),t.forEach((e=>{this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection.add(e)}))}}}initOutlinePass(e,t,r){if(!this.visualEffect._passes.articulationOutlinePass||!this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect)return;if(!e)return this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection.clear(),void(this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.time=1e4);if(!_context.composer.passes.find((e=>"ArticulationOutlineEffect"==e.name))&&this.visualEffect._passes.outlinePass.outlineEffect.selection.size<=0){let e=_context.composer.passes.findIndex((e=>"OutlinePass"==e.name));_context.composer.addPass(this.visualEffect._passes.articulationOutlinePass,e+1)}this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.uniforms.get("hiddenEdgeColor").value=r.color,this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.uniforms.get("visibleEdgeColor").value=r.color,this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.blendMode.opacity.value=void 0===r.alpha?1:r.alpha,t||(this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection.clear(),this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.time=1e4);var n=this;e.children.length>0?e.traverse((function(e){n.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection.add(e)})):this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection.add(e)}applySettings(e){e?(this.visualEffect.applySettings(e.visualEffect),this.spaceEffect.applySettings(e.spaceEffect)):logger.error("无效的特效设置。")}}EffectStore.TYPE={SSAO:Symbol("SSAO"),SMAA:Symbol("SMAA")};class EventHandlerStore{constructor(e,t,r){this._renderer=e,this._scene=t,this._camera=r,this._debounceTimer=0,this._debounceDelay=1e3,this._cameraStopTimeout=void 0,this._handlers={lodchange:{default:[]},cameramove:{default:[]},camerazoom:{default:[]},camerazoomstop:{default:[]},click:{default:[],byType:{sprite:[],billboard:[],landmark:[],bubble:[],bar:[],odLine:[],trail:[],area:[],drawable:[],model:[],building:[],scene:[]}},dblclick:{default:[],byType:{sprite:[],billboard:[],model:[]}},mousedown:{default:[],byType:{sprite:[],billboard:[],model:[]}},mousehover:{default:[],byType:{sprite:[],billboard:[],landmark:[],bubble:[],bar:[],odLine:[],trail:[],area:[],drawable:[],model:[],building:[],scene:[]}},unmousehover:{default:[],byType:{sprite:[],billboard:[],landmark:[],bubble:[],bar:[],odLine:[],trail:[],area:[],drawable:[],model:[],building:[],scene:[]}},mouseup:{default:[],byType:{sprite:[],billboard:[],model:[]}},trailmove:{default:[]}},this._raycaster=new Raycaster,this._mouse=new Vector2,this._lastMouseHoverDrawable=null,this._lastMouseHoverModel=null}update(){}cameraMove(e){this._handlers.cameramove.default.length>0&&this._handlers.cameramove.default.map((t=>{t.handler(e)}))}add(e,t,r,n){e&&r&&(""==(t=t||"")?this._handlers[e].default.push({handler:r,options:n}):this._handlers[e].byType[t].push({handler:r,options:n}))}remove(e,t,r){t&&""!==t?(""!==r&&r||(this._handlers[e].byType[t]=[]),this._handlers[e].byType[t].map(((n,i)=>{n.handler===r&&this._handlers[e].byType[t].splice(i,1)}))):""!==r&&r?this._handlers[e].default.map(((t,n)=>{t.handler===r&&this._handlers[e].default.splice(n,1)})):this._handlers[e].default=[]}onClick(e,t,r){this._mouse.set(e.offsetX/this._renderer.domElement.clientWidth*2-1,-e.offsetY/this._renderer.domElement.clientHeight*2+1),this._raycaster.setFromCamera(this._mouse,this._camera);var n=[];t._scene.children.map(((e,t)=>{"__models"===e.name&&e.traverse((function(e){e.isMesh?n.push(e):"IconGroup"===e.type&&e.children.map((e=>{n.push(e)}))}))})),t._sceneObjects.traverse((function(e){n.push(e)}));var i=this._raycaster.intersectObjects(n);n=null;var a=null,o=[];if(i.length>0){for(let t=0;t<i.length;t++){if(!1===(a=i[t]).object.visible||!1===util$1.judegParentIsVisible(a.object))continue;let n=util$1.findObjectToBuilding(a.object.uuid);if(n){let e=_context.clippingStore.findCutBulidingByUUID(n.getGroup().uuid);if(e&&e.clippingController.pointClipTest(a.point))continue}if(util$1.isDepthTestDisabled(a.object.material)){(o=[]).push(this._xyzToLLA(e,a,r));break}if(a)o.push(this._xyzToLLA(e,a,r));else if(this._handlers.click.byType.scene.length>0){var s={type:"background"};this._handlers.click.byType.scene.map(((t,r)=>{t.handler(e,s,r)}))}if(this._handlers.click.default.length>0){let t=this._raycaster.intersectObjects(this._scene.children,!0);if(t.length>0)(a=t[0]).point&&(e.clickX=a.point.x,e.clickY=a.point.y,e.clickZ=a.point.z),a.object.position,this._invoke(this._handlers.background.default,e),a.object&&a.object.material instanceof Array&&(e.materialIndex=a.face.materialIndex),this._invoke(this._handlers.click.default,e,a.object);else this._invoke(this._handlers.background.default,e)}}0===o.length&&this._handlers.click.byType.model.length>0&&this._handlers.click.byType.model.map((e=>{e.handler(null)}));let t=[],n=[],l=[],c=[],h=[],u=[],d=[],p=[],f=[];if(o.forEach((e=>{"landmark"!==this._getType(e)&&"landmark图标"!==this._getType(e)&&"landmark底图"!==this._getType(e)&&"landmark文字"!==this._getType(e)||t.push(e),"bubble"!==this._getType(e)&&"instancedbubble"!==this._getType(e)||n.push(e),"bar"===this._getType(e)&&l.push(e),"odLine"===this._getType(e)&&c.push(e),"trail"===this._getType(e)&&h.push(e),"area"===this._getType(e)&&u.push(e),this._judegDrawable(e)&&d.push(e),this._judegDrawable(e)&&"IconAsset"!==e.type||p.push(e),f.push(e)})),this._handlers.click.byType.landmark.length>0&&this._handlers.click.byType.landmark.map(((r,n)=>{t[0]&&(this._coordinatePass(t[0],e),r.handler(e,t[0].object,n))})),this._handlers.click.byType.bubble.length>0&&this._handlers.click.byType.bubble.map(((t,r)=>{n[0]&&(this._coordinatePass(n[0],e),t.handler(e,n[0].object,r))})),this._handlers.click.byType.bar.length>0&&this._handlers.click.byType.bar.map(((t,r)=>{l[0]&&(this._coordinatePass(l[0],e),t.handler(e,l[0].object,r))})),this._handlers.click.byType.odLine.length>0&&this._handlers.click.byType.odLine.map(((t,r)=>{c[0]&&(this._coordinatePass(c[0],e),t.handler(e,c[0].object,r))})),this._handlers.click.byType.trail.length>0&&this._handlers.click.byType.trail.map(((t,r)=>{h[0]&&(this._coordinatePass(h[0],e),t.handler(e,h[0].object,r))})),this._handlers.click.byType.area.length>0&&this._handlers.click.byType.area.map(((t,r)=>{u[0]&&(this._coordinatePass(u[0],e),t.handler(e,u[0].object,r))})),this._handlers.click.byType.drawable.length>0&&this._handlers.click.byType.drawable.map(((t,r)=>{d[0]&&(this._coordinatePass(d[0],e),"number"==typeof d[0].instanceId&&(d[0].object.instanceId=d[0].instanceId),t.handler(e,d[0].object,r))})),this._handlers.click.byType.model.length>0&&this._handlers.click.byType.model.map(((t,r)=>{if(p.length>0){let i;this._coordinatePass(p[0],e);let a=_context.defaultObjectTree.findItemByObject3D(p[0].object)||{};if("ModelItem"===a.type||"IconAsset"===a.type||"ModelAsset"===a.type||"GroupItem"===a.type){var n=a;i=a}else if("BuildingItem"===a.type){n=util$1.getNodelFromModelItem(p[0].object);i=util$1.findObjectToBuilding(p[0].object.uuid)}let o=p[0].object||{};p[0].object&&p[0].object.material instanceof Array&&(e.materialIndex=p[0].face.materialIndex),n&&t.handler(e,{name:o.name,node:o,position:o.position?{x:o.position.x,y:o.position.y,z:o.position.z}:void 0,model:{name:null!=n.name?n.name:o.name,position:null!=n.name&&n.getSettings?n.getSettings().transform.position?{x:n.getSettings().transform.position.x,y:n.getSettings().transform.position.y,z:n.getSettings().transform.position.z}:void 0:null,uuid:null!=n.getGroup?n.getGroup().uuid:n.id},parentModel:{name:null!=a.name?a.name:n.name,uuid:a.getGroup&&null!=a.getGroup().uuid?a.getGroup().uuid:n.uuid,position:null!=a.name?a.getSettings().transform.position?{x:a.getSettings().transform.position.x,y:a.getSettings().transform.position.y,z:a.getSettings().transform.position.z}:void 0:null},_name:i.name,_model:{name:i.name,uuid:null!=i.getGroup?i.getGroup().uuid:n.id}},r)}})),this._handlers.click.byType.building.length>0&&p.length>0){let t;if(this._coordinatePass(p[0],e),"BuildingItem"===(_context.defaultObjectTree.findItemByObject3D(p[0].object)||{}).type){let r=_context.defaultObjectTree.getParentIds(p[0].object)||{};t=util$1.findObjectToFloor(r),t?this._handlers.click.byType.building.map(((r,n)=>{let i=t;r.handler(e,{name:i.name,model:{name:null!=t.name?t.name:i.name,uuid:null!=t.getGroup?t.getGroup().uuid:t.id},selectedType:"BuildingFloorItem"},n)})):(t=util$1.findObjectToBuilding(p[0].object.uuid),this._handlers.click.byType.building.map(((r,n)=>{let i=t;r.handler(e,{name:i.name,model:{name:null!=t.name?t.name:i.name,uuid:null!=t.getGroup?t.getGroup().uuid:t.id},selectedType:"BuildingItem"},n)})))}}this._handlers.click.byType.scene.length>0&&this._handlers.click.byType.scene.map(((t,r)=>{f[0].object&&f[0].object.material instanceof Array&&(e.materialIndex=f[0].face.materialIndex),this._coordinatePass(f[0],e),t.handler(e,f[0].object,r)}))}else this._handlers.click.byType.model.length>0&&this._handlers.click.byType.model.map((e=>{e.handler(null)}))}mouseHoverTest(){let e=this._handlers.mousehover.default.length>0;if(!1===e&&(e=this._handlers.unmousehover.default.length>0),!1===e)for(const t in this._handlers.mousehover.byType)if(e=this._handlers.mousehover.byType[t].length>0,!0===e)break;if(!1===e)for(const t in this._handlers.unmousehover.byType)if(e=this._handlers.mousehover.byType[t].length>0,!0===e)break;!1!==e&&(clearTimeout(this._mouseHoverTimeout),this._mouseHoverTimeout=setTimeout((()=>{this._mouseHoverTest(...arguments)}),60))}_mouseHoverTest(e,t,r){this._mouse.set(e.offsetX/this._renderer.domElement.clientWidth*2-1,-e.offsetY/this._renderer.domElement.clientHeight*2+1),this._raycaster.setFromCamera(this._mouse,this._camera);var n=[];t._scene.children.map(((e,t)=>{"__models"===e.name&&e.traverse((function(e){e.isMesh?n.push(e):"IconGroup"===e.type&&e.children.map((e=>{n.push(e)}))}))})),t._sceneObjects.traverse((function(e){n.push(e)}));var i=this._raycaster.intersectObjects(n,!0);n=null;var a=null,o=[];if(i.length>0){for(let t=0;t<i.length;t++)if(!1!==i[t].object.visible&&!1!==util$1.judegParentIsVisible(i[t].object)){if(a=i[t])o.push(this._xyzToLLA(e,a,r));else if(this._handlers.mousehover.byType.scene.length>0){var s={type:"background"};this._handlers.mousehover.byType.scene.map(((t,r)=>{t.handler(e,s,r)}))}if(this._handlers.mousehover.default.length>0){let t=this._raycaster.intersectObjects(this._scene.children,!0);if(t.length>0)(a=t[0]).point&&(e.clickX=a.point.x,e.clickY=a.point.y,e.clickZ=a.point.z),a.object.position,this._invoke(this._handlers.background.default,e),this._invoke(this._handlers.mousehover.default,e,a.object);else this._invoke(this._handlers.background.default,e)}}let t=[],n=[],l=[],c=[],h=[],u=[],d=[],p=[],f=[];o.forEach((e=>{"landmark"!==this._getType(e)&&"landmark图标"!==this._getType(e)&&"landmark底图"!==this._getType(e)&&"landmark文字"!==this._getType(e)||t.push(e),"bubble"!==this._getType(e)&&"instancedbubble"!==this._getType(e)||n.push(e),"bar"===this._getType(e)&&l.push(e),"odLine"===this._getType(e)&&c.push(e),"trail"===this._getType(e)&&h.push(e),"area"===this._getType(e)&&u.push(e),this._judegDrawable(e)&&d.push(e),this._judegDrawable(e)&&"IconAsset"!==e.type||p.push(e),f.push(e)}));let m=null;if(d[0]&&(m=d[0].object,m.instanceId=d[0].instanceId),!this._lastMouseHoverDrawable&&m)this._handlers.mousehover.byType.drawable.map(((t,r)=>{t.handler(e,m,r)})),this._lastMouseHoverDrawable=m;else if(this._lastMouseHoverDrawable&&!m)this._handlers.unmousehover.byType.drawable.map(((t,r)=>{t.handler(e,this._lastMouseHoverDrawable,r)})),this._lastMouseHoverDrawable=m;else if(this._lastMouseHoverDrawable&&m&&this._lastMouseHoverDrawable!==m){let t=this._lastMouseHoverDrawable;this._lastMouseHoverDrawable=m,this._handlers.unmousehover.byType.drawable.map(((r,n)=>{r.handler(e,t,n)})),this._handlers.mousehover.byType.drawable.map(((t,r)=>{t.handler(e,m,r)}))}if(p.length>0){let t,r=_context.defaultObjectTree.findItemByObject3D(p[0].object)||{};if("ModelItem"===r.type)t=r;else if("BuildingItem"===r.type){let e=_context.defaultObjectTree.getParentIds(p[0].object)||{};t=util$1.findObjectToFloor(e),t?t.selectedType="BuildingFloorItem":(t=util$1.findObjectToBuilding(p[0].object.uuid),t.selectedType="BuildingItem")}t&&(this._handlers.unmousehover.byType.model.length>0&&this._lastMouseHoverModel&&t.name!=this._lastMouseHoverModel.name&&(this._handlers.unmousehover.byType.model.map(((t,r)=>{t.handler(e,this._lastMouseHoverModel,r)})),this._handlers.unmousehover.byType.building.length<=0&&(this._lastMouseHoverModel=null)),"BuildingItem"!==t.type&&"BuildingFloorItem"!==t.type||this._handlers.unmousehover.byType.building.length>0&&this._lastMouseHoverModel&&t.name!=this._lastMouseHoverModel.name&&(this._handlers.unmousehover.byType.building.map(((t,r)=>{t.handler(e,this._lastMouseHoverModel,r)})),this._lastMouseHoverModel=null),(null==this._lastMouseHoverModel||this._lastMouseHoverModel&&this._lastMouseHoverModel.name!=t.name)&&(this._handlers.mousehover.byType.model.length>0&&this._handlers.mousehover.byType.model.map(((r,n)=>{r.handler(e,t,n)})),"BuildingItem"!==r.type&&"BuildingFloorItem"!==t.type||this._handlers.mousehover.byType.building.length>0&&this._handlers.mousehover.byType.building.map(((r,n)=>{r.handler(e,t,n)}))),this._lastMouseHoverModel=t)}else this._lastMouseHoverModel&&this._handlers.unmousehover.byType.model.length>0&&this._handlers.unmousehover.byType.model.map(((t,r)=>{t.handler(e,this._lastMouseHoverModel,r)})),this._lastMouseHoverModel&&this._handlers.unmousehover.byType.building.length>0&&this._handlers.unmousehover.byType.building.map(((t,r)=>{t.handler(e,this._lastMouseHoverModel,r)})),this._lastMouseHoverModel=null;this._handlers.mousehover.byType.landmark.length>0&&this._handlers.mousehover.byType.landmark.map(((r,n)=>{t[0]&&r.handler(e,t[0].object,n)})),this._handlers.mousehover.byType.bubble.length>0&&this._handlers.mousehover.byType.bubble.map(((t,r)=>{n[0]&&t.handler(e,n[0].object,r)})),this._handlers.mousehover.byType.bar.length>0&&this._handlers.mousehover.byType.bar.map(((t,r)=>{l[0]&&t.handler(e,l[0].object,r)})),this._handlers.mousehover.byType.odLine.length>0&&this._handlers.mousehover.byType.odLine.map(((t,r)=>{c[0]&&t.handler(e,c[0].object,r)})),this._handlers.mousehover.byType.trail.length>0&&this._handlers.mousehover.byType.trail.map(((t,r)=>{h[0]&&t.handler(e,h[0].object,r)})),this._handlers.mousehover.byType.area.length>0&&this._handlers.mousehover.byType.area.map(((t,r)=>{u[0]&&t.handler(e,u[0].object,r)})),this._handlers.mousehover.byType.scene.length>0&&this._handlers.mousehover.byType.scene.map(((t,r)=>{t.handler(e,f[0].object,r)}))}else this._handlers.mousehover.byType.model.length>0&&this._handlers.mousehover.byType.model.map((e=>{e.handler(null)})),this._lastMouseHoverModel&&this._handlers.unmousehover.byType.model.length>0&&this._handlers.unmousehover.byType.model.map(((t,r)=>{t.handler(e,this._lastMouseHoverModel,r)})),this._lastMouseHoverModel&&this._handlers.unmousehover.byType.building.length>0&&this._handlers.unmousehover.byType.building.map(((t,r)=>{t.handler(e,this._lastMouseHoverModel,r)})),this._lastMouseHoverModel=null}onWheel(e){this._handlers.camerazoom.default.length>0&&this._invoke(this._handlers.camerazoom.default,e),this._handlers.camerazoomstop.default.length>0&&(this._cameraStopTimeout&&clearTimeout(this._cameraStopTimeout),this._cameraStopTimeout=setTimeout((()=>{this._invoke(this._handlers.camerazoomstop.default,e)}),this._debounceDelay)),this._handlers.cameramove.default.length>0&&this._handlers.cameramove.default.map((t=>{t.handler(e)}))}trailmove(e){this._handlers.trailmove.default.length>0&&this._handlers.trailmove.default.map(((t,r)=>{t.handler(e,r)}))}_invoke(e,t,r){if(e.length>0)for(let n of e)n.handler(t,r)}_xyzToLLA(e,t,r){if(t.point){let n=r.XYZToLLA({x:t.point.x,y:t.point.y,z:t.point.z},void 0);n&&(e.clickX=t.point.x,e.clickY=t.point.y,e.clickZ=t.point.z,e.longitude=n.x,e.latitude=n.y,e.altitude=n.z,t.point.longitude=n.x,t.point.latitude=n.y,t.point.altitude=n.z)}if(t.object.position){let e=r.XYZToLLA({x:t.object.position.x,y:t.object.position.y,z:t.object.position.z},void 0);e&&(t.object.positionLla={lon:e.x,lat:e.y,alt:e.z})}return t}_coordinatePass(e,t){t.clickX=e.point.x,t.clickY=e.point.y,t.clickZ=e.point.z,t.longitude=e.point.longitude,t.latitude=e.point.latitude,t.altitude=e.point.altitude}_getType(e){let t=e.object.name,r=t.lastIndexOf("/");return-1==r&&(t=e.object.parent.parent.name,r=t.lastIndexOf("/"),-1==r)?t:t.substring(r+1)}_judegDrawable(e){return"landmark图标"===this._getType(e)||"landmark底图"===this._getType(e)||"landmark文字"===this._getType(e)||"landmark"===this._getType(e)||"bubble"===this._getType(e)||"instancedbubble"===this._getType(e)||"bar"===this._getType(e)||"odline"===this._getType(e)||"trail"===this._getType(e)||"area"===this._getType(e)||"path"===this._getType(e)||"heatmap"===this._getType(e)||"3dmarker"===this._getType(e)}}class InstancedObjectStore{constructor(){var e=[];this.add=t=>{e.push(t)},this.findInstancedObject=t=>e.find((e=>e.name===t))||void 0,this.getInstancedObject=()=>e,this.remove=t=>{for(let r=e.length-1;r>=0;r--)e[r]===t&&(e[r].dispose&&e[r].dispose(),e[r]=null,e.splice(r,1))},this.resume=()=>{_isPaused=!1},this.update=t=>{if(!_isPaused)for(let r of e)r.update(t)}}}var LightProbeGenerator={fromCubeTexture:function(e){for(var t,r,n,i=0,a=new Vector3,o=new Vector3,s=new Color,l=[0,0,0,0,0,0,0,0,0],c=new SphericalHarmonics3,h=c.coefficients,u=0;u<6;u++){var d=e.image[u],p=d.width,f=d.height,m=document.createElement("canvas");m.width=p,m.height=f;var g=m.getContext("2d");g.drawImage(d,0,0,p,f);for(var y=g.getImageData(0,0,p,f),v=y.data,b=y.width,_=2/b,x=0,w=v.length;x<w;x+=4){s.setRGB(v[x]/255,v[x+1]/255,v[x+2]/255),convertColorToLinear(s,e.encoding);var S=x/4,M=(S%b+.5)*_-1,T=1-(Math.floor(S/b)+.5)*_;switch(u){case 0:a.set(-1,T,-M);break;case 1:a.set(1,T,M);break;case 2:a.set(-M,1,-T);break;case 3:a.set(-M,-1,T);break;case 4:a.set(-M,T,1);break;case 5:a.set(M,T,-1)}r=a.lengthSq(),i+=n=4/(Math.sqrt(r)*r),o.copy(a).normalize(),SphericalHarmonics3.getBasisAt(o,l);for(var A=0;A<9;A++)h[A].x+=l[A]*s.r*n,h[A].y+=l[A]*s.g*n,h[A].z+=l[A]*s.b*n}}t=4*Math.PI/i;for(A=0;A<9;A++)h[A].x*=t,h[A].y*=t,h[A].z*=t;return new LightProbe(c)},fromCubeRenderTarget:function(e,t){for(var r,n,i,a=0,o=new Vector3,s=new Vector3,l=new Color,c=[0,0,0,0,0,0,0,0,0],h=new SphericalHarmonics3,u=h.coefficients,d=0;d<6;d++){var p=t.width,f=new Uint8Array(p*p*4);e.readRenderTargetPixels(t,0,0,p,p,f,d);for(var m=2/p,g=0,y=f.length;g<y;g+=4){l.setRGB(f[g]/255,f[g+1]/255,f[g+2]/255),convertColorToLinear(l,t.texture.encoding);var v=g/4,b=(v%p+.5)*m-1,_=1-(Math.floor(v/p)+.5)*m;switch(d){case 0:o.set(1,_,-b);break;case 1:o.set(-1,_,b);break;case 2:o.set(b,1,-_);break;case 3:o.set(b,-1,_);break;case 4:o.set(b,_,1);break;case 5:o.set(-b,_,-1)}n=o.lengthSq(),a+=i=4/(Math.sqrt(n)*n),s.copy(o).normalize(),SphericalHarmonics3.getBasisAt(s,c);for(var x=0;x<9;x++)u[x].x+=c[x]*l.r*i,u[x].y+=c[x]*l.g*i,u[x].z+=c[x]*l.b*i}}r=4*Math.PI/a;for(x=0;x<9;x++)u[x].x*=r,u[x].y*=r,u[x].z*=r;return new LightProbe(h)}},convertColorToLinear=function(e,t){switch(t){case sRGBEncoding:e.convertSRGBToLinear();break;case LinearEncoding:break;default:console.warn("WARNING: LightProbeGenerator convertColorToLinear() encountered an unsupported encoding.")}return e};class LightStore{constructor(e,t){if(this._scene=e,this._context=t,this._lightGroupId="",this._showingHelpers=!1,this._azimuthAngleOffset=0,this._scene){this._ambientLight=new AmbientLight(16777215,1),this._ambientLight.name="__ambientLight",this._ambientLightProbe=new AmbientLightProbe(16777215,0),this._ambientLightProbe.name="__ambientLightProbe",this._ambientLightProbeEnabled=!1;let e=new Group;e.name="__lightGroup",e.add(this._ambientLight),e.add(this._ambientLightProbe),this._lightGroupId=e.id,this._scene.add(e)}this._directionalLights=new Object}enableLightProbe(){this._scene.background instanceof CubeTexture&&(this._ambientLightProbe.copy(LightProbeGenerator.fromCubeTexture(this._scene.background)),this._ambientLightProbe.intensity=this._ambientLight.intensity+LIGHT_PROBE_INTENSITY_OFFSET,this._ambientLightProbeEnabled=!0,this._ambientLight.intensity=this._ambientLight.intensity+LIGHT_INTENSITY_OFFSET,this._ambientLight.visible=!1)}disableLightProbe(){this._ambientLightProbe&&(this._ambientLightProbe.visible=!1,this._ambientLightProbeEnabled=!1,this._ambientLight.visible=!0,this._ambientLight.intensity=this._ambientLight.intensity+LIGHT_INTENSITY_OFFSET)}showLightHelpers(){this._showingHelpers=!0,this._getLightGroup().traverse((e=>{e instanceof DirectionalLightHelper&&(e.visible=!e.getLight||e.getLight().visible),e instanceof CameraHelper&&(e.visible=!e.getLight||e.getLight().visible&&e.getLight().castShadow&&e.getLight().shadow&&e.getLight().shadow.camera)}))}hideLightHelpers(){this._showingHelpers=!1,this._getLightGroup().traverse((e=>{(e instanceof DirectionalLightHelper||e instanceof CameraHelper)&&(e.visible=!1)}))}updateLightHelpers(e=!0,t=!0){this._getLightGroup().traverse((t=>{e&&t instanceof DirectionalLightHelper&&(t.light.updateMatrixWorld(),t.updateMatrixWorld(),t.update()),e&&t instanceof CameraHelper&&t.update()}))}setAmbientLight(e,t){this._scene&&"number"==typeof t&&(t*=LIGHT_INTENSITY_RATIO,this._ambientLight.color=new Color(e)||this._ambientLight.color,this._ambientLightProbeEnabled?this._ambientLight.intensity=t+LIGHT_INTENSITY_OFFSET:this._ambientLight.intensity=t,this._ambientLightProbe&&(this._ambientLightProbe.intensity=this._ambientLight.intensity+LIGHT_PROBE_INTENSITY_OFFSET))}getAmbientLight(){if(this._scene)return this._ambientLight}setAmbientLightProbe(e,t){this._scene&&(this._ambientLight.color=new Color(e)||this._ambientLight.color,this._ambientLight.intensity=util$1.numberOrDefault(t+LIGHT_PROBE_INTENSITY_OFFSET,this._ambientLight.intensity+LIGHT_PROBE_INTENSITY_OFFSET))}getAmbientLightProbe(){if(this._scene)return this._ambientLight}setDirectionalLight(e,t=0){if(logger.debug("TRACE: LightStore.setDirectionalLight() - Entering.",e),!this._scene||!e)return void logger.debug("TRACE: LightStore.setDirectionalLight() - Exiting.");let r=this.findDirectionalLight(e.name),n=!1;if(r)for(let i in e)switch(i){case"color":util$1.isCSSColor(e[i])&&r.color.setStyle(e[i]);break;case"position":if(e[i]instanceof Array&&3===e[i].length)if(t<.05)r.position.set(e[i][0],e[i][1],e[i][2]);else{let n=_context.animationStore.findAnimation("LightTransformAnimation");n&&(logger.warn("Light transform animation has been interrupted by another animation."),_context.animationStore.remove(n));let a=new SmoothTransformController(r,{position:new Vector3(e[i][0],e[i][1],e[i][2])},t);a.name="LightTransformAnimation",_context.animationStore.add(a)}break;case"shadow":let a=e[i].camera;a&&(r.shadow.camera.top=util$1.numberOrDefault(a.top,r.shadow.camera.top),r.shadow.camera.bottom=util$1.numberOrDefault(a.bottom,r.shadow.camera.bottom),r.shadow.camera.left=util$1.numberOrDefault(a.left,r.shadow.camera.left),r.shadow.camera.right=util$1.numberOrDefault(a.right,r.shadow.camera.right),r.shadow.camera.near=util$1.numberOrDefault(a.near,r.shadow.camera.near),r.shadow.camera.far=util$1.numberOrDefault(a.far,r.shadow.camera.far),r.shadow.camera.updateProjectionMatrix(),n=!0),e[i].mapSize&&(e[i].mapSize instanceof Array?(r.shadow.mapSize.width=util$1.numberOrDefault(e[i].mapSize[0],r.shadow.mapSize.width),r.shadow.mapSize.height=util$1.numberOrDefault(e[i].mapSize[1],r.shadow.mapSize.height),r.shadow.map&&(r.shadow.map.dispose(),r.shadow.map=null)):e[i].mapSize instanceof Object&&(r.shadow.mapSize.width=util$1.numberOrDefault(e[i].mapSize.width||e[i].mapSize.x,r.shadow.mapSize.width),r.shadow.mapSize.height=util$1.numberOrDefault(e[i].mapSize.height||e[i].mapSize.y,r.shadow.mapSize.height),r.shadow.map&&(r.shadow.map.dispose(),r.shadow.map=null))),r.shadow.bias=util$1.numberOrDefault(e[i].bias,0);break;case"castShadow":case"visible":if(r[i]===e[i])break;r[i]=e[i];let o=this._showingHelpers&&r.visible;o&&!r.getDirectionalLightHelper&&this._createDirectionalLightHelper(r),r.getDirectionalLightHelper&&(this._getLightGroup().getObjectByName(e.name+".helper").visible=o);let s=r.shadow&&r.shadow.camera&&r.castShadow&&!r.getShadowCameraHelper,l=this._showingHelpers&&r.visible&&r.castShadow&&r.shadow&&r.shadow.camera;s&&this._createShadowCameraHelper(r),r.getShadowCameraHelper&&(r.getShadowCameraHelper().visible=l);break;case"rotation":case"scale":case"getShadowCameraHelper":case"getDirectionalLightHelper":break;case"intensity":r[i]=e[i]*LIGHT_INTENSITY_RATIO;break;default:r[i]=e[i]}else r=this._createDirectionalLight(e),this._getLightGroup()&&(r.target&&(r.target.name=`${r.name}.target`,this._getLightGroup().add(r.target)),this._createDirectionalLightHelper(r),r.shadow&&r.shadow.camera&&r.castShadow&&this._createShadowCameraHelper(r),this._getLightGroup().add(r),this._directionalLights[e.name]=r);this.updateLightHelpers(!0,n),"number"==typeof e.azimuthAngleOffset&&(this._azimuthAngleOffset=e.azimuthAngleOffset),"number"==typeof e.azimuthAngle&&(r.azimuthAngle=e.azimuthAngle),"number"==typeof e.inclinationAngle&&(r.inclinationAngle=e.inclinationAngle),logger.debug("TRACE: LightStore.setDirectionalLight() - Exiting.")}updateDirectionalLight(e,t){this._scene&&e&&t&&(this.findDirectionalLight(e)?logger.warn(`DirectionalLight with name "${e}" already exists.`):(t.name=e,this._getLightGroup()&&(this._getLightGroup().add(t),this._directionalLights[e]=t)))}clearDirectionalLight(){if(this._scene)for(let e in this._directionalLights)this._getLightGroup()&&(this._getLightGroup().remove(this._directionalLights[e]),delete this._directionalLights[e])}getDirectionalLights(){return this._directionalLights}findDirectionalLight(e){if(this._scene&&e)return this._directionalLights[e]}removeDirectionalLight(e){this._scene&&e&&(this._getLightGroup().remove(this._getLightGroup().getObjectByName(e)),this._getLightGroup().remove(this._getLightGroup().getObjectByName(e+".helper")),this._getLightGroup().remove(this._getLightGroup().getObjectByName(e+".target")),delete this._directionalLights[e])}hideDirectionalLight(e){this._scene}showDirectionalLight(e){this._scene}findDirectionalLightHelper(e){if(this._scene&&e)return this._directionalLights[e]&&this._directionalLights[e].getDirectionalLightHelper?this._directionalLights[e].getDirectionalLightHelper():void 0}_getLightGroup(){return this._lightGroupId?this._scene.getObjectById(this._lightGroupId):void 0}_createDirectionalLight({name:e,visible:t,color:r="#ffffff",position:n=[100,100,100],castShadow:i=!0,shadow:a={},intensity:o=1*LIGHT_INTENSITY_RATIO,type:s,distance:l,label:c}){let h=new DirectionalLight(r);h.name=e,h.visible="boolean"!=typeof t||t,h.position.set(n[0],n[1],n[2]),h.castShadow=i,h.distance=l,h.label=c,a.camera&&(h.shadow.camera.top=util$1.numberOrDefault(a.camera.top,100),h.shadow.camera.bottom=util$1.numberOrDefault(a.camera.bottom,-100),h.shadow.camera.left=util$1.numberOrDefault(a.camera.left,-100),h.shadow.camera.right=util$1.numberOrDefault(a.camera.right,100),h.shadow.camera.near=util$1.numberOrDefault(a.camera.near,.1),h.shadow.camera.far=util$1.numberOrDefault(a.camera.far,200)),a.mapSize&&(a.mapSize instanceof Array?(h.shadow.mapSize.width=util$1.numberOrDefault(a.mapSize[0],2048),h.shadow.mapSize.height=util$1.numberOrDefault(a.mapSize[1],2048)):a.mapSize instanceof Object&&(h.shadow.mapSize.width=util$1.numberOrDefault(a.mapSize.width||a.mapSize.x,2048),h.shadow.mapSize.height=util$1.numberOrDefault(a.mapSize.height||a.mapSize.y,2048))),"number"==typeof a.bias&&(h.shadow.bias=a.bias);let u=new Object3D;return h.target=u,"supplemental"===s?u.position.set(0,n[1],0):u.position.set(0,-.01,0),h.intensity=o*LIGHT_INTENSITY_RATIO,h}_createDirectionalLightHelper(e,t=5){var r=new DirectionalLightHelper(e,t);r.name=`${e.name}.helper`,r.visible=e.visible&&this._showingHelpers,r.getLight=function(){return e},e.getDirectionalLightHelper=function(){return r},this._getLightGroup().add(r)}_createShadowCameraHelper(e){let t=new CameraHelper(e.shadow.camera);t.name=`${e.name}.shadowHelper`,t.visible=this._showingHelpers&&e.castShadow,t.getLight=function(){return e},e.getShadowCameraHelper=function(){return t},this._getLightGroup().add(t)}getSettings(){logger.debug("TRACE: LightStore.getSettings() - Entering.");let e={ambientLight:{},directionalLights:{},azimuthAngleOffset:this._azimuthAngleOffset};for(let t in this._ambientLight)"uuid"!==t&&"parent"!==t&&"quaternion"!==t&&"matrix"!==t&&"matrixWorld"!==t&&"matrixAutoUpdate"!==t&&"matrixWorldNeedsUpdate"!==t&&"layers"!==t&&"target"!==t&&"layers"!==t&&"userData"!==t&&"isDirectionalLight"!==t&&"isLight"!==t&&"isObject3D"!==t&&"animation"!==t&&"function"!=typeof this._ambientLight[t]&&(this._ambientLight[t],e.ambientLight[t.replace("_","")]=this._ambientLight[t]);for(let t in this._directionalLights){let r={};for(let e in this._directionalLights[t])if("uuid"!==e&&"parent"!==e&&"quaternion"!==e&&"matrix"!==e&&"matrixWorld"!==e&&"matrixAutoUpdate"!==e&&"matrixWorldNeedsUpdate"!==e&&"layers"!==e&&"target"!==e&&"layers"!==e&&"userData"!==e&&"isDirectionalLight"!==e&&"isLight"!==e&&"isObject3D"!==e&&"animation"!==e&&"function"!=typeof this._ambientLight[e])switch(e){case"color":r[e.replace("_","")]=`#${this._directionalLights[t][e].getHexString()}`;break;case"position":r[e.replace("_","")]=[this._directionalLights[t][e].x,this._directionalLights[t][e].y,this._directionalLights[t][e].z];break;case"shadow":r[e.replace("_","")]=JSON.parse(JSON.stringify(this._directionalLights[t][e])),r[e.replace("_","")].mapSize=JSON.parse(JSON.stringify(this._directionalLights[t][e].mapSize)),r[e.replace("_","")].camera&&delete r[e.replace("_","")].camera.uuid;break;default:r[e.replace("_","")]=this._directionalLights[t][e]}e.directionalLights[t]=r}return logger.debug("TRACE: LightStore.getSettings() - Exiting.",e),e}applySettings(e,t,r){if(logger.debug("TRACE: LightStore.getSettings() - Entering.",e),e)if(this._context){for(let t in this._directionalLights)null==e.directionalLights[t]&&(this.removeDirectionalLight(t),delete this._directionalLights[t]);e.directionalLights.GlobalDirectionalLight.duration=r,this._context.setGlobalIllumination({skybox:e.skybox,ambientLight:e.ambientLight,directionalLight:e.directionalLights.GlobalDirectionalLight},(e=>{t&&t(e)}));for(let t in e.directionalLights)"GlobalDirectionalLight"!==t&&this.setDirectionalLight(e.directionalLights[t]);"number"==typeof e.azimuthAngleOffset&&(this._azimuthAngleOffset=e.azimuthAngleOffset),logger.debug("TRACE: LightStore.applySettings() - Exiting.")}else logger.error("无效的上下文设置。");else logger.error("无效的灯光设置。")}}class ModelStore{constructor(e){this._scene=e,this._scene.models||(this._scene.models=new Group("__models"),this._scene.models.name="__models",this._scene.add(this._scene.models)),this._models=new Object,this._nodeSelection=new NodeSelection(e),this._animationMixers=[],this._states={}}add(e,t,r,n){this._scene&&e&&n&&(this.find(e)||(n.index="number"==typeof r?r:this._scene.models.children.length,n.name=e,n.url=t,this._scene.models.add(n),this._models[e]=n,this._animationMixers.push(new AnimationMixer(n))))}clear(){if(this._scene)for(let e in this._models)this._scene.models.remove(this._models[e]),delete this._models[e]}find(e){if(!this._scene||!e)return;return this.getModels().find((t=>t.name===e))}rename(e,t,r){if(this._scene&&e&&t){_context.modelStore.find(t).name=e;for(let n=0;n<this._scene.models.children.length;n++)this._scene.models.children[n].name===t&&(this._scene.models.children[n].name=e,r&&r(1));for(let r in this._models)r===t&&(this._models[e]=this._models[r],delete this._models[r])}}getModels(){let e=[];for(let t in this._models){let r=new Model({name:this._models[t].name,url:this._models[t].url,animations:this._models[t].animations,isVisible:this._models[t].visible,index:this._models[t].index});r.children=Node._fromThreeObject(this._models[t]).children,e.push(r)}return e}loadScene(e,t){if(t.inBackground)for(let r of e.children)e.userData.dhExtension&&(r.userData.dhExtension=e.userData.dhExtension),t.translate instanceof Array&&(r.translateX(t.translate[0]||0),r.translateY(t.translate[1]||0),r.translateZ(t.translate[2]||0)),r.visible=!1,this._scene.models.add(r),this._models[r.name]=r;else{e.name="__models",this._scene.remove(this._scene.models),this._scene.models=e,this._scene.add(e);for(let t of e.children)e.userData.dhExtension&&(t.userData.dhExtension=e.userData.dhExtension),this._models[t.name]=t}}remove(e,t){let r=null;if(this._scene&&e){for(let n in this._models)this._models[n].name==e&&(r=this._models[n].index,this._scene.models.remove(this._models[n]),delete this._models[this._models[n].name],t&&t(1));for(let e in this._models)r<this._models[e].index&&(this._models[e].index-=1)}}copy(e,t){if(this._scene&&e)for(let i in this._models)if(this._models[i].name==e){var r=this._models[i].clone();r.url=this._models[i].url;var n=new Date;n.toLocaleDateString(),r.name=r.name+"_副本_"+(n.getMonth()+1<10?"0"+(n.getMonth()+1):n.getMonth()+1)+(n.getDate()<10?"0"+n.getDate():n.getDate())+(n.getHours()<10?"0"+n.getHours():n.getHours())+(n.getMinutes()<10?"0"+n.getMinutes():n.getMinutes())+(n.getSeconds()<10?"0"+n.getSeconds():n.getSeconds()),this._scene.models.add(r),this._models[r.name]=r,t&&t(1)}}hide(e,t={}){if(!this._scene||!e||!this.find(e))return;let r=this._models[e];if(r instanceof Object3D&&(r.visible=!1,this._scene.children.map((t=>{"__sysObjectsWater"===t.name&&t.children.map((t=>{t.userData.modelName===e&&(t.visible=!1)}))})),""!==_context.stateStore.getCurrentState())){let t=_context.stateStore.findState(_context.stateStore.getCurrentState());t.settings.models=t.settings.models||{},t.settings.models[e]=t.settings.models[e]||{},t.settings.models[e].visible=!1}}show(e,t={}){if(!this._scene||!e||!this.find(e))return;let r=this._models[e];if(t.exlusively)for(let t in this._models)this._models[t].name!==e&&(this._models[t].visible=!1);if(t.withSettings&&r.userData.dhExtension&&(_context.materialStore.applySettings(r.userData.dhExtension.materials),_context.lightStore.applySettings(r.userData.dhExtension.lights),r.userData.dhExtension.view.duration=t.duration||0,_context.instance.defaultView.applySettings(r.userData.dhExtension.view),_context.instance.defaultEffectStore.applySettings(r.userData.dhExtension.effects)),r instanceof Object3D&&(r.visible=!0,this._scene.children.map((t=>{"__sysObjectsWater"===t.name&&t.children.map((t=>{t.userData.modelName===e&&(t.visible=!0)}))})),""!==_context.stateStore.getCurrentState())){let t=_context.stateStore.findState(_context.stateStore.getCurrentState());t.settings.models=t.settings.models||{},t.settings.models[e]=t.settings.models[e]||{},t.settings.models[e].visible=!0}}hideNode(e,t){if(!(this._scene&&e&&t&&this.find(e)))return;let r=this._models[e];if(r instanceof Object3D){let e;r.traverse((function(r){r.name===t&&(e=r)})),e&&(e.visible=!1,e.traverse((function(e){typeof e.name===t&&"boolean"==typeof e.visible&&(e.visible=!1)})))}}showNode(e,t){if(!(this._scene&&e&&t&&this.find(e)))return;let r=this._models[e];if(r instanceof Object3D){let e;r.traverse((function(r){r.name===t&&(e=r)})),e&&(e.visible=!0,e.traverse((function(e){typeof e.name===t&&"boolean"==typeof e.visible&&(e.visible=!0)})))}}rankUp(e,t){let r=this;this._scene.models.children.map(((n,i)=>{n.name===e&&(0===n.index?t&&t(0,"已是第一名无法上移"):(n.index-=1,r._scene.models.children.map((e=>{e.index===n.index&&e.name!=n.name&&(e.index+=1)})),t&&t(1,"成功")))}))}rankDown(e,t){let r=this;this._scene.models.children.map(((n,i)=>{n.name===e&&(n.index===r._scene.models.children.length-1?t&&t(0,"已是最后一名无法下移"):(n.index+=1,r._scene.models.children.map((e=>{e.index===n.index&&e.name!=n.name&&(e.index-=1)})),t&&t(1,"成功")))}))}findAnimationClipAction(e,t){if(!this._models[e])return;let r=this._animationMixers.find((t=>t.getRoot().name===this._models[e].name));if(!r)return;let n=this._models[e].animations.find((e=>e.name===t));return n?r.clipAction(n):void 0}stopAnimation(e,t){let r=this.findAnimationClipAction(e,t);r&&r.stop()}playAnimation(e,t,r){let n=this.findAnimationClipAction(e,t);"number"==typeof r&&(n.timeScale=r),n&&n.play()}updateAnimation(e){for(let t=0;t<this._animationMixers.length;t++)this._animationMixers[t].update(e)}applyState(e){}getSettings(){let e=this.getModels();return _traverse_0_6_6_traverse(e).forEach((function(){this.node&&this.node.id&&delete this.node.id})),this.result=e.sort(((e,t)=>e.index-t.index)),this.transformRecursion(e,this._models),e}transformRecursion(e,t){for(let r=0;r<e.length;r++)if(e[r].transform={},t instanceof Array)for(let n=0;n<t.length;n++)e[r].name===t[n].name&&(e[r].transform.position=t[n].position,e[r].transform.rotation=t[n].rotation,e[r].transform.scale=t[n].scale,e[r].children.length>0&&this.transformRecursion(e[r].children,t[n].children));else if(t instanceof Object)for(let n in t)t[n].name===e[r].name&&(e[r].transform.position=t[n].position,e[r].transform.rotation=t[n].rotation,e[r].transform.scale=t[n].scale,e[r].children.length>0&&this.transformRecursion(e[r].children,t[n].children))}setTransformRecursion(e,t){if(t instanceof Array)for(let r=0;r<e.length;r++)for(let n=0;n<t.length;n++)e[r].transform&&t[n].name===e[r].name&&(t[n].position.x=e[r].transform.position.x,t[n].position.y=e[r].transform.position.y,t[n].position.z=e[r].transform.position.z,t[n].rotation.order=e[r].transform.rotation._order,t[n].rotation.x=e[r].transform.rotation._x,t[n].rotation.y=e[r].transform.rotation._y,t[n].rotation.z=e[r].transform.rotation._z,t[n].scale.x=e[r].transform.scale.x,t[n].scale.y=e[r].transform.scale.y,t[n].scale.z=e[r].transform.scale.z,t[r].children.length>0&&this.setTransformRecursion(e[r].children,t[n].children));else if(t instanceof Object)for(let r=0;r<e.length;r++)for(let n in t)e[r].transform&&t[n].name===e[r].name&&(t[n].position.x=e[r].transform.position.x,t[n].position.y=e[r].transform.position.y,t[n].position.z=e[r].transform.position.z,t[n].rotation.order=e[r].transform.rotation._order,t[n].rotation.x=e[r].transform.rotation._x,t[n].rotation.y=e[r].transform.rotation._y,t[n].rotation.z=e[r].transform.rotation._z,t[n].scale.x=e[r].transform.scale.x,t[n].scale.y=e[r].transform.scale.y,t[n].scale.z=e[r].transform.scale.z,t[n].children.length>0&&this.setTransformRecursion(e[r].children,t[n].children))}applySettings(e){if(!e)return void logger.error("无效的模型设置。");this.setTransformRecursion(e,this._models);let t=this._nodeSelection;for(let r of e){let e=this.find(r.name);if(e){if(r.animations instanceof Array)for(let e of r.animations){let t=[];for(let r of e.tracks){let e;switch(r.type){case"bool":e=new BooleanKeyframeTrack(r.name,r.times,r.values);break;case"color":e=new ColorKeyframeTrack(r.name,r.times,r.values);break;case"number":e=new NumberKeyframeTrack(r.name,r.times,r.values);break;case"quaternion":e=new QuaternionKeyframeTrack(r.name,r.times,r.values);break;case"string":e=new StringKeyframeTrack(r.name,r.times,r.values);break;case"vector":e=new VectorKeyframeTrack(r.name,r.times,r.values);break;default:e=new KeyframeTrack(r.name,r.times,r.values)}t.push(e)}let n=new AnimationClip(e.name,e.duration,t);this._models[r.name].animations.push(n)}this._models[r.name].visible=r.isVisible,r.transform&&(this._models[r.name].position.x=r.transform.position.x,this._models[r.name].position.y=r.transform.position.y,this._models[r.name].position.z=r.transform.position.z,this._models[r.name].rotation._order=r.transform.rotation._order,this._models[r.name].rotation._x=r.transform.rotation._x,this._models[r.name].rotation._y=r.transform.rotation._y,this._models[r.name].rotation._z=r.transform.rotation._z,this._models[r.name].scale.x=r.transform.scale.x,this._models[r.name].scale.y=r.transform.scale.y,this._models[r.name].scale.z=r.transform.scale.z),this._animationMixers.push(new AnimationMixer(this._models[r.name])),_traverse_0_6_6_traverse(r.children).forEach((function(){if(this.node&&this.node.isNode&&e.findNode){t.selectNodes([e.findNode(this.node.name)]);for(let e in this.node)"children"!==e&&"isNode"!==e&&"material"!==e&&"name"!==e&&t.setProperty(e,this.node[e])}}))}}}}class ObjectStore{constructor(e){this._scene=e,this._sceneObjects=new Group,this._sceneObjects.name="__objects",this._scene.add(this._sceneObjects),this._objects=new Object}add(e,t){this._sceneObjects&&e&&t&&(this.find(e)||(t.name=e,this._sceneObjects.add(t),this._objects[e]=t))}clear(){if(this._sceneObjects)for(let e in this._objects)this._sceneObjects.remove(this._objects[e]),delete this._objects[e]}find(e){if(this._sceneObjects&&e)return this._objects[e]}remove(e){if(!this._sceneObjects||!e)return;let t=this.find(e);t&&(t.userData.mesh&&(t.userData.mesh.geometry.dispose(),t.userData.mesh.material.dispose()),t.traverse&&t.traverse((e=>{if(e instanceof Mesh)if(e.geometry.dispose(),e.material instanceof Array)for(let t=0;t<e.material.length;t++){if(!e.material[t])return;for(let r in e.material[t])e.material[t][r]instanceof Texture$1&&e.material[t][r].dispose();e.material[t].dispose()}else{for(let t in e.material)e.material[t]instanceof Texture$1&&e.material[t].dispose();e.material.dispose()}else if(e instanceof Sprite){for(let t in e.material)e.material[t]instanceof Texture$1&&e.material[t].dispose();e.material.dispose()}})),this._sceneObjects.remove(t),delete this._objects[t.name])}hide(e){this._sceneObjects&&e&&(this._objects[e].visible=!1,this._objects[e].activeVisible=!1)}show(e){this._sceneObjects&&e&&(this._objects[e].visible=!0,this._objects[e].activeVisible=!0)}forEach(e){if(!util$1.isFunction(e))return!1;for(let t in this._objects)e(this._objects[t])}}class StateStore{constructor(e){this._defaultState={},this._states=[],this._currentState="",this._nodeSelection=new NodeSelection(e),this._camera={}}isDefaultState(){return""===this._currentState}add(e){if(!e||this.find(e))return;let t={};return t.id=util$1.guid(),t.name=e,_context.instance.notState?t.settings=JSON.parse(JSON.stringify(_context.instance.notState)):(t.settings=JSON.parse(JSON.stringify(_context.instance.getSettings())),_context.instance._notView&&(t.settings.view=_context.instance._notView)),delete t.settings.sceneModelTransform,delete t.settings.datumShiftModel,delete t.settings.states,delete t.settings.cache,!window.firstLoadEnd&&_context.sceneSettings&&(t.settings.view.camera=_context.sceneSettings.view.camera),0===this._states.length?t.defaultState=!0:t.defaultState=!1,this._states.push(t),t.name}clear(){this._states=[],this._currentState}find(e){if(e&&""!==e)return this._states.find((t=>t.name===e))}getStates(){let e=[];for(let r of this._states)if(r.defaultState){t={name:r.name,default:r.defaultState};e.unshift(t)}else{var t={name:r.name,default:r.defaultState};e.push(t)}return e}remove(e){if(e)for(let t=0;t<this._states.length;t++)if(this._states[t].name===e&&!this._states[t].defaultState){this._states.splice(t,1);break}}update(e,t){if(e&&t){for(let r=0;r<this._states.length;r++)if(this._states[r].name===e){this._states[r].name=t;break}this._currentState===e&&(this._currentState=t)}}copyState(e,t){let r={};r.id=util$1.guid(),r.name=t;let n=this._states.find((t=>t.name==e));return r.settings=n?JSON.parse(JSON.stringify(n.settings)):JSON.parse(JSON.stringify(_context.instance.getSettings())),delete r.settings.sceneModelTransform,delete r.settings.datumShiftModel,delete r.settings.states,delete r.settings.cache,r.defaultState=!1,this._states.push(r),r}getCurrentState(){return this._currentState}saveCurrentStateSettings(){let e=this.find(this._currentState);e&&(e.settings=JSON.parse(JSON.stringify(_context.instance.getSettings())),delete e.settings.sceneModelTransform,delete e.settings.datumShiftModel,delete e.settings.states,delete e.settings.cache,e.settings.view.camera.azimuth=this._camera.azimuthAngle,e.settings.view.camera.viewLimitRadius=this._camera.viewLimitRadius,e.settings.view.camera.inclination=this._camera.inclinationAngle,e.settings.view.camera.fov=this._camera.fov,e.settings.view.camera.distance=this._camera.viewDistance,e.settings.view.camera.distanceMax=this._camera.distanceMax,e.settings.view.camera.distanceMin=this._camera.distanceMin,e.settings.view.camera.viewDistanceMin=this._camera.near,e.settings.view.camera.viewDistanceMax=this._camera.far,e.settings.view.camera.targetX=this._camera.targetX,e.settings.view.camera.targetY=this._camera.targetY,e.settings.view.camera.targetZ=this._camera.targetZ,e.settings.view.camera.inclinationAngleMin=this._camera.inclinationAngleMin,e.settings.view.camera.inclinationAngleMax=this._camera.inclinationAngleMax,e.settings.view.camera.duration=null!=this._camera.duration?this._camera.duration:1.5,e.settings.view.camera.autoRotate=this._camera.autoRotate,e.settings.view.camera.autoRotateSpeed=this._camera.autoRotateSpeed,e.settings.view.camera.autoRotateDirection=this._camera.autoRotateDirection,_context.instance.saveSceneSettings(JSON.parse(JSON.stringify(_context.instance.getSettings()))))}saveCameraParam(e,t){_context.orbitControls.defaultTargetPosition=new Vector3(e.targetX,e.targetY,e.targetZ),_context.orbitControls.viewLimitRadius=e.viewLimitRadius,_context.instance.setAutoRotate(!1,0),_context.instance.nextRender((()=>{_context.instance.setAutoRotate(e.autoRotate,util$1.getAutoRotateTime(e.autoRotateSpeed,e.autoRotateDirection))})),this._camera=JSON.parse(JSON.stringify(e)),this._camera.duration=t,this.saveCurrentStateSettings()}selectState(e="",t,r){if(""!==e&&!this.find(e))return void(t&&t(0,"名为"+e+"的状态不存在"));this._currentState=e;let n=this.find(e);return n?(null!=n.settings.view.camera.azimuth&&(void 0===n.settings.view.camera.duration&&(n.settings.view.camera.duration=1.5),0==n.settings.view.camera.viewLimitRadius||n.settings.view.camera.viewLimitRadius||(n.settings.view.camera.viewLimitRadius=1e8),this._camera.viewLimitRadius=n.settings.view.camera.viewLimitRadius,this._camera.azimuthAngle=n.settings.view.camera.azimuth,this._camera.inclinationAngle=n.settings.view.camera.inclination,this._camera.fov=n.settings.view.camera.fov,this._camera.viewDistance=n.settings.view.camera.distance,this._camera.distanceMax=n.settings.view.camera.distanceMax,this._camera.distanceMin=n.settings.view.camera.distanceMin,this._camera.near=n.settings.view.camera.viewDistanceMin,this._camera.far=n.settings.view.camera.viewDistanceMax,this._camera.targetX=n.settings.view.camera.targetX,this._camera.targetY=n.settings.view.camera.targetY,this._camera.targetZ=n.settings.view.camera.targetZ,this._camera.inclinationAngleMin=n.settings.view.camera.inclinationAngleMin,this._camera.inclinationAngleMax=n.settings.view.camera.inclinationAngleMax,this._camera.duration=n.settings.view.camera.duration,this._camera.autoRotate=n.settings.view.camera.autoRotate,this._camera.autoRotateSpeed=n.settings.view.camera.autoRotateSpeed,this._camera.autoRotateDirection=n.settings.view.camera.autoRotateDirection),_context.instance.applySceneSettings(n.settings,t),this._states.filter((t=>t.name!==e)).forEach((e=>{e.settings.objectTree.children&&e.settings.objectTree.children.forEach&&e.settings.objectTree.children.forEach((e=>{let t=_context.instance.getDefaultObjectTree().getItemByName(e.name);t&&(e.articulationAnimations&&e.articulationAnimations.filter((e=>e.isEnable)).forEach((e=>{setTimeout((()=>{t.resetArticulationAnimation(e.animationName)}))})),e.articulations&&e.articulations.forEach((e=>{let r=t.articulations.find((t=>t._name==e._name));r&&r.type==ArticulationTypes.text&&r.deleteArticulation()})),e.articulations&&e.articulations.filter((e=>e.isEnable)).forEach((e=>{let r=t.articulations.find((t=>t._name==e._name));setTimeout((()=>{r&&r.set(e.value)}))})),setTimeout((()=>{_context.effectStore.initOutlinePass()})))}))})),n.settings.objectTree.children&&n.settings.objectTree.children.forEach&&n.settings.objectTree.children.forEach((e=>{let t=_context.instance.getDefaultObjectTree().getItemByName(e.name);t&&(e.articulations&&e.articulations.forEach((e=>{let r=t.articulations.find((t=>t._name==e._name));r&&r.type==ArticulationTypes.text&&r.deleteArticulation()})),e.articulations&&e.articulations.filter((e=>e.isEnable)).forEach((e=>{let r=t.articulations.find((t=>t._name==e._name));r&&(r.type==ArticulationTypes.text?r.addOrUpdateTextArticulation():setTimeout((()=>{r.set(e.value)})))})),e.articulationAnimationTimeOut&&clearTimeout(e.articulationAnimationTimeOut),e.articulationAnimationTimeOut=setTimeout((()=>{e.articulationAnimations&&e.articulationAnimations.filter((e=>e.isEnable)).forEach((e=>{t.resetArticulationAnimation(e.animationName),t.playArticulationAnimation(e.animationName)}))}),1e3))})),r&&r({name:e,default:n.defaultState}),n.settings):void 0}setCamera(e){this.find(this._currentState)&&(this.find(this._currentState).camera=e)}setGlobalIlluminationInCurrentState(e){this.find(this._currentState)&&(this.find(this._currentState).globalIllumination=e)}getSettings(){let e=[];return this._states.map((t=>{e.push(t)})),e}setNotState(){this._currentState=""}setDefaultState(e){this._states.forEach((e=>{e.defaultState=!1})),this._states.forEach((t=>{t.name===e&&(t.defaultState=!0)}))}applySettings(e){e&&e.map((e=>{0===this._states.filter((t=>t.name===e.name)).length&&this._states.push(e)}))}synchronizaArticulation(){_context.instance.getSettings().objectTree.children.forEach((e=>{this._states.forEach((t=>{let r=t.settings.objectTree.children.find((t=>t.name===e.name));if(r&&r.articulations){let t={};r.articulations.forEach((e=>{t[e._name]={},t[e._name].isEnable=e.isEnable})),r.articulations=[],r.articulations=JSON.parse(JSON.stringify(e.articulations)),r.articulations.forEach((e=>{t[e._name]&&(e.isEnable=t[e._name].isEnable)}))}}))}))}synchronizaAnimation(){_context.instance.getSettings().objectTree.children.forEach((e=>{this._states.forEach((t=>{let r=t.settings.objectTree.children.find((t=>t.name===e.name));if(r&&r.articulationAnimations){let t={};r.articulationAnimations.forEach((e=>{t[e.animationName]={},t[e.animationName].isEnable=e.isEnable})),r.articulationAnimations=[],r.articulationAnimations=JSON.parse(JSON.stringify(e.articulationAnimations)),r.articulationAnimations.forEach((e=>{t[e.animationName]&&(e.isEnable=t[e.animationName].isEnable)}))}}))}))}getCurrentStateSetting(){return""!==this._currentState&&this._states.find((e=>e.name==this._currentState)).settings}}class SysObjectStore{constructor(e){this._scene=e,this.sysObjectStore=new Group,this.sysObjectStore.name="__sysObjectsWater",this._scene.add(this.sysObjectStore)}add(e,t){this.sysObjectStore&&e&&t&&(this.find(e)||(t.name=e,this.sysObjectStore.add(t)))}clear(){this.sysObjectStore&&this.sysObjectStore.traverse((e=>{this.sysObjectStore.remove(e)}))}find(e){if(this.sysObjectStore&&e){var t=null;return this.sysObjectStore.traverse((r=>{r.name===e&&(t=r)})),t}}remove(e){if(!this.sysObjectStore||!e)return;let t=this.find(e);t&&this.sysObjectStore.remove(t)}hide(e){this.sysObjectStore&&e&&this.sysObjectStore.traverse((t=>{t.name===e&&(t.visible=!1,t.activeVisible=!1)}))}show(e){this.sysObjectStore&&e&&this.sysObjectStore.traverse((t=>{t.name===e&&(t.visible=!0,t.activeVisible=!0)}))}}class TextureStore{constructor(){this._textures=new Object}add(e,t){e&&t&&(this.find(e)||(t.name=e,this._textures[e]=Texture._fromThreeObject(t)))}clear(){for(let e in this._textures)delete this._textures[e]}find(e){if(e)return this._textures[e]}remove(e){if(!e)return;let t=this.find(e);t&&delete this._textures[t.name]}textureSort(e){e.sort(((e,t)=>e.name.localeCompare(t.name)))}getAll(){if(!this._textures)return[];let e=[];for(let t in this._textures)e.push(this._textures[t]);return this.textureSort(e),e}}var objectChangeEvent={type:"objectChange"},stateChangeEvent={type:"stateChange"},historyMoveEvent={type:"historyMove"};class TransformStore extends EventDispatcher{constructor(e){super("TransformStore");let t=this;this.mode="model",this.transformControls=e,this.transformHistory={model:[],node:[]},this._historyState={model:0,node:0},this._historyType={model:"new",node:"new"},this._selectionType={model:"defaultModelSelection",node:"defaultNodeSelection"};let r=[];this.controlState={redo:!1,undo:!1},this.mouseDown=e=>{if(r=[],_context.instance[this._selectionType[this.mode]].getSelectionList().length)_context.instance[this._selectionType[this.mode]].getSelectionList().forEach((e=>{let t={},n=_context.scene.getObjectByProperty("uuid",e),i={};n&&(i.position=JSON.parse(JSON.stringify(n.position)),i.rotation=JSON.parse(JSON.stringify(n.rotation)),i.rotation.x=i.rotation._x,i.rotation.y=i.rotation._y,i.rotation.z=i.rotation._z,i.scale=JSON.parse(JSON.stringify(n.scale)),i.rotation.x=i.rotation._x=MathUtils.radToDeg(i.rotation._x),i.rotation.y=i.rotation._y=MathUtils.radToDeg(i.rotation._y),i.rotation.z=i.rotation._z=MathUtils.radToDeg(i.rotation._z)),t.object=n,t.oldTransform=i,r.push(t)}));else{let t={},n=e.target.object,i={};n&&(i.position=JSON.parse(JSON.stringify(n.position)),i.rotation=JSON.parse(JSON.stringify(n.rotation)),i.rotation.x=i.rotation._x,i.rotation.y=i.rotation._y,i.rotation.z=i.rotation._z,i.scale=JSON.parse(JSON.stringify(n.scale)),i.rotation.x=i.rotation._x=MathUtils.radToDeg(i.rotation._x),i.rotation.y=i.rotation._y=MathUtils.radToDeg(i.rotation._y),i.rotation.z=i.rotation._z=MathUtils.radToDeg(i.rotation._z)),t.object=n,t.oldTransform=i,r.push(t)}},this.mouseUp=e=>{let n=new Map;if(_context.instance[this._selectionType[this.mode]].getSelectionList().length)_context.instance[this._selectionType[this.mode]].getSelectionList().forEach((e=>{let t=_context.scene.getObjectByProperty("uuid",e),r={};t&&(r.position=JSON.parse(JSON.stringify(t.position)),r.rotation=JSON.parse(JSON.stringify(t.rotation)),r.rotation.x=r.rotation._x,r.rotation.y=r.rotation._y,r.rotation.z=r.rotation._z,r.scale=JSON.parse(JSON.stringify(t.scale)),r.rotation.x=r.rotation._x=MathUtils.radToDeg(r.rotation._x),r.rotation.y=r.rotation._y=MathUtils.radToDeg(r.rotation._y),r.rotation.z=r.rotation._z=MathUtils.radToDeg(r.rotation._z),n.set(t,r))}));else{let t=e.target.object,r={};t&&(r.position=JSON.parse(JSON.stringify(t.position)),r.rotation=JSON.parse(JSON.stringify(t.rotation)),r.rotation.x=r.rotation._x,r.rotation.y=r.rotation._y,r.rotation.z=r.rotation._z,r.scale=JSON.parse(JSON.stringify(t.scale)),r.rotation.x=r.rotation._x=MathUtils.radToDeg(r.rotation._x),r.rotation.y=r.rotation._y=MathUtils.radToDeg(r.rotation._y),r.rotation.z=r.rotation._z=MathUtils.radToDeg(r.rotation._z),n.set(t,r))}let i=r.map((e=>e.oldTransform)),a=r.map((e=>e.object)).map((e=>n.get(e)));if(i.length===a.length&&JSON.stringify(i)!=JSON.stringify(a)){let e;r.forEach((e=>{e.newTransform=n.get(e.object)})),e="new"==t.historyType[this.mode]?t.historyState[this.mode]+1:t.historyState[this.mode],t.transformHistory[this.mode].splice(e),t.transformHistory[this.mode].push(r),t.historyState[this.mode]=t.transformHistory[this.mode].length-1,t.historyType[this.mode]="new",r=[],this.historyState=this.historyState,this.historyType=this.historyType}},this.transformControls.addEventListener("mouseDown",this.mouseDown),this.transformControls.addEventListener("mouseUp",this.mouseUp)}onGoHistory(e,t){if(e.length>1){let r=e.map((e=>(_context.instance.setModelTransformByUUID(e.object.uuid,e[t]),e.object.uuid)));_context.instance[this._selectionType[this.mode]].selectObjectByUUID(r),_context.instance[this._selectionType[this.mode]].enableTransformControl(),historyMoveEvent.object=r,historyMoveEvent.eventType="multiple",this.dispatchEvent(historyMoveEvent)}else e.forEach((e=>{_context.instance.setModelTransformByUUID(e.object.uuid,e[t]),historyMoveEvent.object=e.object,historyMoveEvent.eventType="radio",this.dispatchEvent(historyMoveEvent)}))}advance(){if(this.controlState.redo&&!(this.transformHistory[this.mode].length<=0)){if(this.historyState[this.mode]<this.transformHistory[this.mode].length-1)if("new"==this.historyType[this.mode]){let e=this.transformHistory[this.mode][this.historyState[this.mode]+1];this.onGoHistory(e,"newTransform"),this.historyState[this.mode]=this.historyState[this.mode]+1,this.historyType[this.mode]="new"}else{let e=this.transformHistory[this.mode][this.historyState[this.mode]];this.onGoHistory(e,"newTransform"),this.historyType[this.mode]="new"}if(this.historyState[this.mode]==this.transformHistory[this.mode].length-1&&"old"==this.historyType[this.mode]){let e=this.transformHistory[this.mode][this.historyState[this.mode]];this.onGoHistory(e,"newTransform"),this.historyType[this.mode]="new"}this.historyState=this.historyState,this.historyType=this.historyType,this.transformControls.object&&this.transformControls.dispatchEvent(objectChangeEvent)}}backOff(){if(this.controlState.undo&&!(this.transformHistory[this.mode].length<=0)){if(this.historyState[this.mode]>0)if("old"==this.historyType[this.mode]){let e=this.transformHistory[this.mode][this.historyState[this.mode]-1];this.onGoHistory(e,"oldTransform"),this.historyState[this.mode]=this.historyState[this.mode]-1,this.historyType[this.mode]="old"}else{let e=this.transformHistory[this.mode][this.historyState[this.mode]];this.onGoHistory(e,"oldTransform"),this.historyType[this.mode]="old"}if(0==this.historyState[this.mode]&&"new"==this.historyType[this.mode]){let e=this.transformHistory[this.mode][this.historyState[this.mode]];this.onGoHistory(e,"oldTransform"),this.historyType[this.mode]="old"}this.historyState=this.historyState,this.historyType=this.historyType,this.transformControls.object&&this.transformControls.dispatchEvent(objectChangeEvent)}}clear(){this.transformHistory[this.mode]=[],this.historyState[this.mode]=0,this.historyState=this.historyState,this.historyType[this.mode]="new",this.historyType=this.historyType}destroy(){this.transformControls.removeEventListener("mouseDown",this.mouseDown),this.transformControls.removeEventListener("mouseUp",this.mouseUp),this.transformControls=null,this.transformHistory=null,this.historyState=null,this.historyType=null}returnChangeState(){if(!this.historyState)return;if(null===this.historyState[this.mode])return;if(null===this.historyType[this.mode])return;let e={redo:!1,undo:!1};this.transformHistory[this.mode].length>0&&("old"==this.historyType[this.mode]?(this.historyState[this.mode]>0&&(e.undo=!0),this.historyState[this.mode]<=this.transformHistory[this.mode].length-1&&(e.redo=!0)):"new"==this.historyType[this.mode]&&(this.historyState[this.mode]>=0&&(e.undo=!0),this.historyState[this.mode]<this.transformHistory[this.mode].length-1&&(e.redo=!0))),this.controlState=e,this.dispatchEvent(stateChangeEvent)}setMode(e){this.mode=e,this.historyState=this.historyState,this.historyType=this.historyType}get historyState(){return this._historyState}set historyState(e){this._historyState=e,this.returnChangeState()}get historyType(){return this._historyType}set historyType(e){this._historyType=e,this.returnChangeState()}}const HARDWARE_MODEL_LIST={Independence:["GeForce GTX","GeForce RTX","AMD Radeon"],browser:["Google","Intel","Apple"]},SUGGEST=[{img:"suggest-one",text:"进入“windows设置”，选择“系统”项"},{img:"suggest-two",text:"在“显示”里面找到“图形设置”进行性能首选项设置"},{img:"suggest-three",text:"点击“浏览”"},{img:"suggest-four",text:"选择谷歌浏览器的应用程序即安装位置，并添加"},{img:"suggest-five",text:"添加完成后，点击“选项”"},{img:"suggest-six",text:"在图形规格中选择“高性能”，并保存。"}];class UpgradeSuggest{static onUpgradeSuggest(){let e=document.getElementsByTagName("body")[0];this.body=e;let t=document.createElement("div");t.setAttribute("id","SuggestTip"),t.className="SuggestTip",t.innerHTML='\n          <span class="suggestTip-text">性能优化建议</span>\n        ';let r="";for(var n=0;n<=10;n++)r=`${r}${10*n}% {\n        background:linear-gradient(90deg, transparent,rgba(255,0,0,${.5+.05*n}),transparent);\n      }`;let i=document.createElement("style");i.innerText=`@keyframes suggest {\n      ${r}\n    }\n    .SuggestTip {\n      animation: suggest 1s linear infinite alternate;\n    }`,t.appendChild(i);let a=document.createElement("div");a.innerText="×",a.className="SuggestTipCancel",a.style="border-radius:1px;\n                                  width: 15px;\n                                  height: 15px;\n                                  border:1px solid #FFB973;\n                                  background: #822403;\n                                  color: #FEB772;\n                                  display:flex;\n                                  justify-content: center;\n                                  align-items:center;\n                                  margin-left:8px;\n                                  font-size: 20px;\n                                  cursor: pointer;\n                                  box-sizing:border-box;\n                                  padding: 0 1px 1px 0;\n                                  font-weight: 900;",t.appendChild(a),a.addEventListener("click",this.offUpgradeSuggest);let o=document.createElement("style");o.innerText=".SuggestTipCancel:hover { opacity: .7 }",t.appendChild(o),t.style="background:linear-gradient(90deg, transparent,red,transparent);\n                            font-size: 15px;\n                            color: #FFE599;\n                            display:flex;\n                            justify-content: center;\n                            align-items:center;\n                            position:absolute;\n                            top: 10px;\n                            left: 50%;\n                            transform:translateX(-50%);\n                            width: 267px;\n                            height: 28px;\n                            cursor:pointer;\n                            z-index: 999;\n                            ",_context.instance.container.appendChild(t),t.addEventListener("click",this.onUpgradeSuggestPanel),this.SuggestTip=t}static offUpgradeSuggest(e){let t=UpgradeSuggest;e&&e.stopPropagation(),_context.instance.container&&_context.instance.container.removeChild(t.SuggestTip),t.SuggestTip=null}static getExtension(){let e=document.createElement("canvas").getContext("experimental-webgl"),t=e.getExtension("WEBGL_debug_renderer_info");return{renderer:e.getParameter(t.UNMASKED_RENDERER_WEBGL),vendor:e.getParameter(t.UNMASKED_VENDOR_WEBGL)}}static onUpgradeSuggestPanel(e){let t=UpgradeSuggest;if(e&&e.stopPropagation(),t.upgradeSuggestPanel)return;let r=document.getElementsByTagName("body")[0];t.body=r;let n=document.createElement("div");n.style="width: 100%;\n                                 height: 100%;\n                                 position:absolute;\n                                 top:0;\n                                 left:0;\n                                 z-index: 9999999;",n.tabIndex=0,r.addEventListener("keydown",t.keyDownEvent),r.appendChild(n),t.upgradeSuggestPanel=n;let i=document.createElement("div");i.style="width: 706px;\n                      height: 541px;\n                      position: absolute;\n                      top: 50%;\n                      left: 50%;\n                      transform:translate(-50%,-50%);\n                      background: #18181b;\n                      border: 1px solid #606374;\n                      display:flex;\n                      flex-direction:column;\n                      ",n.appendChild(i),this.resizeResetPanelStyle=()=>{let e=window.document.documentElement.clientWidth;if(e<706){let t=e/706;i.style.transform=`scale(${t})translate(-${50/t}%,-${50/t}%)`}else i.style.transform="translate(-50%,-50%)"},this.resizeResetPanelStyle(),window.addEventListener("resize",this.resizeResetPanelStyle);let a=document.createElement("div");a.style="width: 100%;\n                            height: 32px;\n                            background: #333437;\n                            margin-bottom: 1px;\n                            display:flex;\n                            align-items:center;\n                            position:relative",i.appendChild(a);let o=document.createElement("div");o.innerText="!",o.style="box-sizing:border-box;\n                         width: 18px;\n                         height:18px;\n                         border-radius:50%;\n                         border: 2px solid #FF5C26;\n                         margin-left:10px;\n                         display:flex;\n                         align-items:center;\n                         justify-content: center;\n                         color: #FF5C26;\n                         font-weight: 900;\n                         font-size: 12px;",a.appendChild(o);let s=document.createElement("span");s.innerText="性能优化建议",s.style="font-size:14px;\n                       color: #CCCCCC;\n                       margin-left:10px;",a.appendChild(s);let l=document.createElement("span");l.innerText="×",l.className="suggest-cancelIcon",l.style="position:absolute;\n                        right: 10px;\n                        font-size: 26px;\n                        color:#D7DBE8;\n                        cursor: pointer;\n                        top: -2px;",l.addEventListener("click",t.offUpgradeSuggestPanel),a.appendChild(l);let c=document.createElement("style");c.innerText=".suggest-cancelIcon:hover { opacity: .7 }",a.appendChild(c);let h=document.createElement("div");h.style="flex:1;\n                       border-top: 1px solid #424653;\n                       background:#2b2c2f;\n                       display:flex;\n                       flex-direction:column;",i.appendChild(h);let u=document.createElement("div");u.className="upgradeSuggest-body-top-text-box",u.innerHTML='<p class="upgradeSuggest-body-top-text-box-title">您的显卡GPU性能无法满足三维渲染要求，为获得更好的浏览体验，请按如下方法优化系统：</p>\n                                <p class="upgradeSuggest-body-top-text-box-levelOne">如果您使用的是PC，请使用型号为NVIDIA GTX 960同级别或以上级别的独立显卡。</p>\n                                <p class="upgradeSuggest-body-top-text-box-levelOne">如果您使用的是有独立显卡的笔记本电脑，请进行如下设置：</p>',h.appendChild(u);let d=document.createElement("style");d.innerText=".upgradeSuggest-body-top-text-box {\n                                       padding:20px 35px;\n                                       color:#CCCCCC; \n                                       font-size: 14px;\n                                      }\n                                      .upgradeSuggest-body-top-text-box > p {\n                                        line-height: 28px;\n                                      }\n                                     .upgradeSuggest-body-top-text-box\n                                      > .upgradeSuggest-body-top-text-box-levelOne {\n                                        font-weight: 500;\n                                        padding-left: 18px;\n                                        position: relative;\n                                      }\n                                      .upgradeSuggest-body-top-text-box\n                                       > .upgradeSuggest-body-top-text-box-levelOne::before {\n                                         content: '';\n                                         display: block;\n                                         width: 5px;\n                                         height: 5px;\n                                         background: #FF5C26;\n                                         border-radius: 50%;\n                                         position: absolute;\n                                         left: 3px;\n                                         top: 50%;\n                                         transform: translateY(-50%);\n                                      }",u.appendChild(d);let p=0,f=document.createElement("div");f.className="suggest-bodyBottomBox",f.style="display:flex;\n                           justify-content:space-between;\n                           align-items:center;\n                           padding:0 35px 20px 35px;\n                           flex:1;\n                           user-select: none;\n                           position:relative;";let m=document.createElement("span");m.innerText="<",m.style.opacity="0.2";let g=document.createElement("div"),y=document.createElement("img");y.src=`${_context.instance.resourceBasePath}texture/ui/${SUGGEST[p].img}.png`;let v=document.createElement("p");v.innerHTML=`${SUGGEST[p].text}${SUGGEST[p].linkText?`<a target="_blank" href="${SUGGEST[p].linkUrl}" >${SUGGEST[p].linkText}</a>`:""}`,v.style="font-size: 16px;\n                            color:#ccc;\n                            text-align:center;",g.appendChild(y),g.appendChild(v);let b=document.createElement("span");b.innerText=">";let _=document.createElement("span");_.innerText=`${p+1}/${SUGGEST.length}`,_.style="position:absolute;\n                          right: 32px;\n                          bottom: 45px;\n                          color: #FF5B26;\n                          font-size: 24px;\n                          transform: scale(1);";let x=document.createElement("style");x.innerText=".suggest-bodyBottomBox > span { font-size: 40px;color:#EEEEEE;transform: scaleY(2.1);cursor:pointer }",m.addEventListener("click",(e=>{e&&e.stopPropagation(),p<=0||(p--,m.style.opacity=p<=0?"0.2":"1",p>=SUGGEST.length-1?b.style.opacity="0.2":b.style.opacity="1",_.innerText=`${p+1}/${SUGGEST.length}`,y.src=`${_context.instance.resourceBasePath}texture/ui/${SUGGEST[p].img}.png`,v.innerHTML=`${SUGGEST[p].text}${SUGGEST[p].linkText?`<a target="_blank" href="${SUGGEST[p].linkUrl}" >${SUGGEST[p].linkText}</a>`:""}`)})),b.addEventListener("click",(e=>{e&&e.stopPropagation(),p>=SUGGEST.length-1||(p++,m.style.opacity=p<=0?"0.2":"1",p>=SUGGEST.length-1?b.style.opacity="0.2":b.style.opacity="1",_.innerText=`${p+1}/${SUGGEST.length}`,y.src=`${_context.instance.resourceBasePath}texture/ui/${SUGGEST[p].img}.png`,v.innerHTML=`${SUGGEST[p].text}${SUGGEST[p].linkText?`<a style="color:#27b1df;" target="_blank" href="${SUGGEST[p].linkUrl}" >${SUGGEST[p].linkText}</a>`:""}`)})),f.appendChild(m),f.appendChild(g),f.appendChild(b),f.appendChild(x),f.appendChild(_),h.appendChild(f);let w=document.createElement("div");w.style="width: 100%;\n                         height: 39px;\n                         margin-top:1px;\n                         background: #313235;\n                         position:relative;\n                         display:flex;\n                         justify-content: flex-end;\n                         align-items:center",i.appendChild(w);let S=document.createElement("span");S.innerText="确定",S.className="suggest-button-ok",S.style="width: 48px;\n                      height: 24px;\n                      background:#1B66F0;\n                      color: #FFFFFF;\n                      font-size: 12px;\n                      display:flex;\n                      justify-content: center;\n                      align-items:center;\n                      margin-right: 10px;\n                      cursor: pointer;\n                      border-radius:2px;",S.addEventListener("click",t.offUpgradeSuggestPanel),w.appendChild(S);let M=document.createElement("style");M.innerText=".suggest-button-ok:hover { opacity: .7 }",w.appendChild(M)}static offUpgradeSuggestPanel(e){let t=UpgradeSuggest;e&&e.stopPropagation(),window.removeEventListener("resize",this.resizeResetPanelStyle),t.body.removeChild(t.upgradeSuggestPanel),t.upgradeSuggestPanel=null}static checkSuggestOn(){let{renderer:e,vendor:t}=this.getExtension();HARDWARE_MODEL_LIST.browser.forEach((t=>{e.indexOf(t)>-1&&this.onUpgradeSuggest()}))}static keyDownEvent(e){let t=UpgradeSuggest;13==e.keyCode&&(t.offUpgradeSuggestPanel(),t.body.removeEventListener("keydown",UpgradeSuggest.keyDownEvent))}}function BespokeThenable(){var e,t=0,r=[],n=0,i=0;var a=d((function(e){i||s(1,e)})),o=d((function(e){i||s(-1,e)}));function s(r,n){i++;var a=0;try{n===m&&p();var o=r>0&&u(n);o?o.call(n,d((function(e){a++,s(1,e)})),d((function(e){a++,s(-1,e)}))):(t=r,e=n,l())}catch(e){t||a||s(-1,e)}}function l(){n||(setTimeout(c,0),n=1)}function c(){var e=r;n=0,r=[],e.forEach(h)}function h(e){e()}function u(e){var t=e&&(f(e)||"object"==typeof e)&&e.then;return f(t)&&t}function d(e){var t=0;return function(){for(var r=[],n=arguments.length;n--;)r[n]=arguments[n];t++||e.apply(this,r)}}function p(){throw new TypeError("Chaining cycle detected")}var f=function(e){return"function"==typeof e},m={then:function(n,i){var a=BespokeThenable();return r.push((function(){var r=t>0?n:i;if(f(r))try{var o=r(e);o===a&&p();var s=u(o);s?s.call(o,a.resolve,a.reject):a.resolve(o)}catch(e){a.reject(e)}else a[t>0?"resolve":"reject"](e)})),t&&l(),a},resolve:a,reject:o};return m}function NativePromiseThenable(){var e,t,r=new Promise((function(r,n){e=r,t=n}));return{then:r.then.bind(r),resolve:e,reject:t}}BespokeThenable.all=NativePromiseThenable.all=function(e){var t=0,r=[],n=DefaultThenable();return 0===e.length?n.resolve([]):e.forEach((function(i,a){var o=DefaultThenable();o.resolve(i),o.then((function(i){t++,r[a]=i,t===e.length&&n.resolve(r)}),n.reject)})),n};var DefaultThenable="function"==typeof Promise?NativePromiseThenable:BespokeThenable;function workerBootstrap(){var e=Object.create(null);function t(n,i){var a=n.id,o=n.name,s=n.dependencies;void 0===s&&(s=[]);var l=n.init;void 0===l&&(l=function(){});var c=n.getTransferables;if(void 0===c&&(c=null),!e[a])try{s=s.map((function(r){return r&&r.isWorkerModule&&(t(r,(function(e){if(e instanceof Error)throw e})),r=e[r.id].value),r})),l=r("<"+o+">.init",l),c&&(c=r("<"+o+">.getTransferables",c));var h=null;"function"==typeof l?h=l.apply(void 0,s):console.error("worker module init function failed to rehydrate"),e[a]={id:a,value:h,getTransferables:c},i(h)}catch(e){e&&e.noLog||console.error(e),i(e)}}function r(e,t){var r=void 0;self.troikaDefine=function(e){return r=e};var n=URL.createObjectURL(new Blob(["/** "+e.replace(/\*/g,"")+" **/\n\ntroikaDefine(\n"+t+"\n)"],{type:"application/javascript"}));try{importScripts(n)}catch(e){console.error(e)}return URL.revokeObjectURL(n),delete self.troikaDefine,r}self.addEventListener("message",(function(r){var n=r.data,i=n.messageId,a=n.action,o=n.data;try{"registerModule"===a&&t(o,(function(e){e instanceof Error?postMessage({messageId:i,success:!1,error:e.message}):postMessage({messageId:i,success:!0,result:{isCallable:"function"==typeof e}})})),"callModule"===a&&function(t,r){var n,i=t.id,a=t.args;e[i]&&"function"==typeof e[i].value||r(new Error("Worker module "+i+": not found or its 'init' did not return a function"));try{var o=(n=e[i]).value.apply(n,a);o&&"function"==typeof o.then?o.then(s,(function(e){return r(e instanceof Error?e:new Error(""+e))})):s(o)}catch(e){r(e)}function s(t){try{var n=e[i].getTransferables&&e[i].getTransferables(t);n&&Array.isArray(n)&&n.length||(n=void 0),r(t,n)}catch(e){console.error(e),r(e)}}}(o,(function(e,t){e instanceof Error?postMessage({messageId:i,success:!1,error:e.message}):postMessage({messageId:i,success:!0,result:e},t||void 0)}))}catch(e){postMessage({messageId:i,success:!1,error:e.stack})}}))}function defineMainThreadModule(e){var t=function(){for(var e=[],r=arguments.length;r--;)e[r]=arguments[r];return t._getInitResult().then((function(t){if("function"==typeof t)return t.apply(void 0,e);throw new Error("Worker module function was called but `init` did not return a callable function")}))};return t._getInitResult=function(){var r=e.dependencies,n=e.init;r=Array.isArray(r)?r.map((function(e){return e&&e._getInitResult?e._getInitResult():e})):[];var i=DefaultThenable.all(r).then((function(e){return n.apply(null,e)}));return t._getInitResult=function(){return i},i},t}var supportsWorkers=function(){var e=!1;if("undefined"!=typeof window&&void 0!==window.document)try{new Worker(URL.createObjectURL(new Blob([""],{type:"application/javascript"}))).terminate(),e=!0}catch(e){"undefined"!=typeof process&&"test"===process.env.NODE_ENV||console.log("Troika createWorkerModule: web workers not allowed; falling back to main thread execution. Cause: ["+e.message+"]")}return supportsWorkers=function(){return e},e},_workerModuleId=0,_messageId=0,_allowInitAsString=!1,workers=Object.create(null),openRequests=function(){var e=Object.create(null);return e._count=0,e}();function defineWorkerModule(e){if(!(e&&"function"==typeof e.init||_allowInitAsString))throw new Error("requires `options.init` function");var t=e.dependencies,r=e.init,n=e.getTransferables,i=e.workerId;if(!supportsWorkers())return defineMainThreadModule(e);null==i&&(i="#default");var a="workerModule"+ ++_workerModuleId,o=e.name||a,s=null;function l(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return s||(s=callWorker(i,"registerModule",l.workerModuleData)),s.then((function(t){if(t.isCallable)return callWorker(i,"callModule",{id:a,args:e});throw new Error("Worker module function was called but `init` did not return a callable function")}))}return t=t&&t.map((function(e){return"function"!=typeof e||e.workerModuleData||(_allowInitAsString=!0,e=defineWorkerModule({workerId:i,name:"<"+o+"> function dependency: "+e.name,init:"function(){return (\n"+stringifyFunction(e)+"\n)}"}),_allowInitAsString=!1),e&&e.workerModuleData&&(e=e.workerModuleData),e})),l.workerModuleData={isWorkerModule:!0,id:a,name:o,dependencies:t,init:stringifyFunction(r),getTransferables:n&&stringifyFunction(n)},l}function stringifyFunction(e){var t=e.toString();return!/^function/.test(t)&&/^\w+\s*\(/.test(t)&&(t="function "+t),t}function getWorker(e){var t=workers[e];if(!t){var r=stringifyFunction(workerBootstrap);(t=workers[e]=new Worker(URL.createObjectURL(new Blob(["/** Worker Module Bootstrap: "+e.replace(/\*/g,"")+" **/\n\n;("+r+")()"],{type:"application/javascript"})))).onmessage=function(e){var t=e.data,r=t.messageId,n=openRequests[r];if(!n)throw new Error("WorkerModule response with empty or unknown messageId");delete openRequests[r],openRequests._count--,n(t)}}return t}function callWorker(e,t,r){var n=DefaultThenable(),i=++_messageId;return openRequests[i]=function(e){e.success?n.resolve(e.result):n.reject(new Error("Error in worker "+t+" call: "+e.error))},openRequests._count++,openRequests._count>1e3&&console.warn("Large number of open WorkerModule requests, some may not be returning"),getWorker(e).postMessage({messageId:i,action:t,data:r}),n}var ThenableWorkerModule=defineWorkerModule({name:"Thenable",dependencies:[DefaultThenable],init:function(e){return e}});function bidiFactory(){return function(e){var t={R:"13k,1a,2,3,3,2+1j,ch+16,a+1,5+2,2+n,5,a,4,6+16,4+3,h+1b,4mo,179q,2+9,2+11,2i9+7y,2+68,4,3+4,5+13,4+3,2+4k,3+29,8+cf,1t+7z,w+17,3+3m,1t+3z,16o1+5r,8+30,8+mc,29+1r,29+4v,75+73",EN:"1c+9,3d+1,6,187+9,513,4+5,7+9,sf+j,175h+9,qw+q,161f+1d,4xt+a,25i+9",ES:"17,2,6dp+1,f+1,av,16vr,mx+1,4o,2",ET:"z+2,3h+3,b+1,ym,3e+1,2o,p4+1,8,6u,7c,g6,1wc,1n9+4,30+1b,2n,6d,qhx+1,h0m,a+1,49+2,63+1,4+1,6bb+3,12jj",AN:"16o+5,2j+9,2+1,35,ed,1ff2+9,87+u",CS:"18,2+1,b,2u,12k,55v,l,17v0,2,3,53,2+1,b",B:"a,3,f+2,2v,690",S:"9,2,k",WS:"c,k,4f4,1vk+a,u,1j,335",ON:"x+1,4+4,h+5,r+5,r+3,z,5+3,2+1,2+1,5,2+2,3+4,o,w,ci+1,8+d,3+d,6+8,2+g,39+1,9,6+1,2,33,b8,3+1,3c+1,7+1,5r,b,7h+3,sa+5,2,3i+6,jg+3,ur+9,2v,ij+1,9g+9,7+a,8m,4+1,49+x,14u,2+2,c+2,e+2,e+2,e+1,i+n,e+e,2+p,u+2,e+2,36+1,2+3,2+1,b,2+2,6+5,2,2,2,h+1,5+4,6+3,3+f,16+2,5+3l,3+81,1y+p,2+40,q+a,m+13,2r+ch,2+9e,75+hf,3+v,2+2w,6e+5,f+6,75+2a,1a+p,2+2g,d+5x,r+b,6+3,4+o,g,6+1,6+2,2k+1,4,2j,5h+z,1m+1,1e+f,t+2,1f+e,d+3,4o+3,2s+1,w,535+1r,h3l+1i,93+2,2s,b+1,3l+x,2v,4g+3,21+3,kz+1,g5v+1,5a,j+9,n+v,2,3,2+8,2+1,3+2,2,3,46+1,4+4,h+5,r+5,r+a,3h+2,4+6,b+4,78,1r+24,4+c,4,1hb,ey+6,103+j,16j+c,1ux+7,5+g,fsh,jdq+1t,4,57+2e,p1,1m,1m,1m,1m,4kt+1,7j+17,5+2r,d+e,3+e,2+e,2+10,m+4,w,1n+5,1q,4z+5,4b+rb,9+c,4+c,4+37,d+2g,8+b,l+b,5+1j,9+9,7+13,9+t,3+1,27+3c,2+29,2+3q,d+d,3+4,4+2,6+6,a+o,8+6,a+2,e+6,16+42,2+1i",BN:"0+8,6+d,2s+5,2+p,e,4m9,1kt+2,2b+5,5+5,17q9+v,7k,6p+8,6+1,119d+3,440+7,96s+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+75,6p+2rz,1ben+1,1ekf+1,1ekf+1",NSM:"lc+33,7o+6,7c+18,2,2+1,2+1,2,21+a,1d+k,h,2u+6,3+5,3+1,2+3,10,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,g+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+g,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,k1+w,2db+2,3y,2p+v,ff+3,30+1,n9x+3,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,r2,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+5,3+1,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2d+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,f0c+4,1o+6,t5,1s+3,2a,f5l+1,43t+2,i+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,gzhy+6n",AL:"16w,3,2,e+1b,z+2,2+2s,g+1,8+1,b+m,2+t,s+2i,c+e,4h+f,1d+1e,1bwe+dp,3+3z,x+c,2+1,35+3y,2rm+z,5+7,b+5,dt+l,c+u,17nl+27,1t+27,4x+6n,3+d",LRO:"6ct",RLO:"6cu",LRE:"6cq",RLE:"6cr",PDF:"6cs",LRI:"6ee",RLI:"6ef",FSI:"6eg",PDI:"6eh"},r={},n={};r.L=1,n[1]="L",Object.keys(t).forEach((function(e,t){r[e]=1<<t+1,n[r[e]]=e})),Object.freeze(r);var i=r.LRI|r.RLI|r.FSI,a=r.L|r.R|r.AL,o=r.B|r.S|r.WS|r.ON|r.FSI|r.LRI|r.RLI|r.PDI,s=r.BN|r.RLE|r.LRE|r.RLO|r.LRO|r.PDF,l=r.S|r.WS|r.B|i|r.PDI|s,c=null;function h(e){return function(){if(!c){c=new Map;var e=function(e){if(t.hasOwnProperty(e)){var n=0;t[e].split(",").forEach((function(t){var i=t.split("+"),a=i[0],o=i[1];a=parseInt(a,36),o=o?parseInt(o,36):0,c.set(n+=a,r[e]);for(var s=0;s<o;s++)c.set(++n,r[e])}))}};for(var n in t)e(n)}}(),c.get(e.codePointAt(0))||r.L}var u,d,p,f="14>1,1e>2,u>2,2wt>1,1>1,1ge>1,1wp>1,1j>1,f>1,hm>1,1>1,u>1,u6>1,1>1,+5,28>1,w>1,1>1,+3,b8>1,1>1,+3,1>3,-1>-1,3>1,1>1,+2,1s>1,1>1,x>1,th>1,1>1,+2,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,4q>1,1e>2,u>2,2>1,+1",m="6f1>-6dx,6dy>-6dx,6ec>-6ed,6ee>-6ed,6ww>2jj,-2ji>2jj,14r4>-1e7l,1e7m>-1e7l,1e7m>-1e5c,1e5d>-1e5b,1e5c>-14qx,14qy>-14qx,14vn>-1ecg,1ech>-1ecg,1edu>-1ecg,1eci>-1ecg,1eda>-1ecg,1eci>-1ecg,1eci>-168q,168r>-168q,168s>-14ye,14yf>-14ye";function g(e,t){var r,n=0,i=new Map,a=t&&new Map;return e.split(",").forEach((function e(o){if(-1!==o.indexOf("+"))for(var s=+o;s--;)e(r);else{r=o;var l=o.split(">"),c=l[0],h=l[1];c=String.fromCodePoint(n+=parseInt(c,36)),h=String.fromCodePoint(n+=parseInt(h,36)),i.set(c,h),t&&a.set(h,c)}})),{map:i,reverseMap:a}}function y(){if(!u){var e=g(f,!0),t=e.map,r=e.reverseMap;u=t,d=r,p=g(m,!1).map}}function v(e){return y(),u.get(e)||null}function b(e){return y(),d.get(e)||null}function _(e){return y(),p.get(e)||null}var x=r.L,w=r.R,S=r.EN,M=r.ES,T=r.ET,A=r.AN,E=r.CS,C=r.B,L=r.S,D=r.ON,R=r.BN,P=r.NSM,O=r.AL,I=r.LRO,k=r.RLO,B=r.LRE,N=r.RLE,F=r.PDF,U=r.LRI,z=r.RLI,H=r.FSI,G=r.PDI;var V;function j(e){return function(){if(!V){var e=g("14>1,j>2,t>2,u>2,1a>g,2v3>1,1>1,1ge>1,1wd>1,b>1,1j>1,f>1,ai>3,-2>3,+1,8>1k0,-1jq>1y7,-1y6>1hf,-1he>1h6,-1h5>1ha,-1h8>1qi,-1pu>1,6>3u,-3s>7,6>1,1>1,f>1,1>1,+2,3>1,1>1,+13,4>1,1>1,6>1eo,-1ee>1,3>1mg,-1me>1mk,-1mj>1mi,-1mg>1mi,-1md>1,1>1,+2,1>10k,-103>1,1>1,4>1,5>1,1>1,+10,3>1,1>8,-7>8,+1,-6>7,+1,a>1,1>1,u>1,u6>1,1>1,+5,26>1,1>1,2>1,2>2,8>1,7>1,4>1,1>1,+5,b8>1,1>1,+3,1>3,-2>1,2>1,1>1,+2,c>1,3>1,1>1,+2,h>1,3>1,a>1,1>1,2>1,3>1,1>1,d>1,f>1,3>1,1a>1,1>1,6>1,7>1,13>1,k>1,1>1,+19,4>1,1>1,+2,2>1,1>1,+18,m>1,a>1,1>1,lk>1,1>1,4>1,2>1,f>1,3>1,1>1,+3,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,6>1,4j>1,j>2,t>2,u>2,2>1,+1",!0),t=e.map;e.reverseMap.forEach((function(e,r){t.set(r,e)})),V=t}}(),V.get(e)||null}function W(e,t,r,n){var i=e.length;r=Math.max(0,null==r?0:+r),n=Math.min(i-1,null==n?i-1:+n);var a=[];return t.paragraphs.forEach((function(i){var o=Math.max(r,i.start),s=Math.min(n,i.end);if(o<s){for(var c=t.levels.slice(o,s+1),u=s;u>=o&&h(e[u])&l;u--)c[u]=i.level;for(var d=i.level,p=1/0,f=0;f<c.length;f++){var m=c[f];m>d&&(d=m),m<p&&(p=1|m)}for(var g=d;g>=p;g--)for(var y=0;y<c.length;y++)if(c[y]>=g){for(var v=y;y+1<c.length&&c[y+1]>=g;)y++;y>v&&a.push([v+r,y+r])}}})),a}function Y(e,t,r,n){for(var i=W(e,t,r,n),a=[],o=0;o<e.length;o++)a[o]=o;return i.forEach((function(e){for(var t=e[0],r=e[1],n=a.slice(t,r+1),i=n.length;i--;)a[r-i]=n[i]})),a}return e.closingToOpeningBracket=b,e.getBidiCharType=h,e.getBidiCharTypeName=function(e){return n[h(e)]},e.getCanonicalBracket=_,e.getEmbeddingLevels=function(e,t){for(var r=new Uint32Array(e.length),n=0;n<e.length;n++)r[n]=h(e[n]);var c=new Map;function u(e,t){var n=r[e];r[e]=t,c.set(n,c.get(n)-1),n&o&&c.set(o,c.get(o)-1),c.set(t,(c.get(t)||0)+1),t&o&&c.set(o,(c.get(o)||0)+1)}for(var d=new Uint8Array(e.length),p=new Map,f=[],m=null,g=0;g<e.length;g++)m||f.push(m={start:g,end:e.length-1,level:"rtl"===t?1:"ltr"===t?0:Ht(g,!1)}),r[g]&C&&(m.end=g,m=null);for(var y=N|B|k|I|i|G|F|C,V=function(e){return e+(1&e?1:2)},j=function(e){return e+(1&e?2:1)},W=0;W<f.length;W++){var Y=[{_level:(m=f[W]).level,_override:0,_isolate:0}],X=void 0,$=0,Z=0,q=0;c.clear();for(var J=m.start;J<=m.end;J++){var Q=r[J];if(X=Y[Y.length-1],c.set(Q,(c.get(Q)||0)+1),Q&o&&c.set(o,(c.get(o)||0)+1),Q&y)if(Q&(N|B)){d[J]=X._level;var K=(Q===N?j:V)(X._level);K<=125&&!$&&!Z?Y.push({_level:K,_override:0,_isolate:0}):$||Z++}else if(Q&(k|I)){d[J]=X._level;var ee=(Q===k?j:V)(X._level);ee<=125&&!$&&!Z?Y.push({_level:ee,_override:Q&k?w:x,_isolate:0}):$||Z++}else if(Q&i){Q&H&&(Q=1===Ht(J+1,!0)?z:U),d[J]=X._level,X._override&&u(J,X._override);var te=(Q===z?j:V)(X._level);te<=125&&0===$&&0===Z?(q++,Y.push({_level:te,_override:0,_isolate:1,_isolInitIndex:J})):$++}else if(Q&G){if($>0)$--;else if(q>0){for(Z=0;!Y[Y.length-1]._isolate;)Y.pop();var re=Y[Y.length-1]._isolInitIndex;null!=re&&(p.set(re,J),p.set(J,re)),Y.pop(),q--}X=Y[Y.length-1],d[J]=X._level,X._override&&u(J,X._override)}else Q&F?(0===$&&(Z>0?Z--:!X._isolate&&Y.length>1&&(Y.pop(),X=Y[Y.length-1])),d[J]=X._level):Q&C&&(d[J]=m.level);else d[J]=X._level,X._override&&Q!==R&&u(J,X._override)}for(var ne=[],ie=null,ae=m.start;ae<=m.end;ae++){var oe=r[ae];if(!(oe&s)){var se=d[ae],le=oe&i,ce=oe===G;ie&&se===ie._level?(ie._end=ae,ie._endsWithIsolInit=le):ne.push(ie={_start:ae,_end:ae,_level:se,_startsWithPDI:ce,_endsWithIsolInit:le})}}for(var he=[],ue=0;ue<ne.length;ue++){var de=ne[ue];if(!de._startsWithPDI||de._startsWithPDI&&!p.has(de._start)){for(var pe=[ie=de],fe=void 0;ie&&ie._endsWithIsolInit&&null!=(fe=p.get(ie._end));)for(var me=ue+1;me<ne.length;me++)if(ne[me]._start===fe){pe.push(ie=ne[me]);break}for(var ge=[],ye=0;ye<pe.length;ye++)for(var ve=pe[ye],be=ve._start;be<=ve._end;be++)ge.push(be);for(var _e=d[ge[0]],xe=m.level,we=ge[0]-1;we>=0;we--)if(!(r[we]&s)){xe=d[we];break}var Se=ge[ge.length-1],Me=d[Se],Te=m.level;if(!(r[Se]&i))for(var Ae=Se+1;Ae<=m.end;Ae++)if(!(r[Ae]&s)){Te=d[Ae];break}he.push({_seqIndices:ge,_sosType:Math.max(xe,_e)%2?w:x,_eosType:Math.max(Te,Me)%2?w:x})}}for(var Ee=0;Ee<he.length;Ee++){var Ce=he[Ee],Le=Ce._seqIndices,De=Ce._sosType,Re=Ce._eosType;if(c.get(P))for(var Pe=0;Pe<Le.length;Pe++){var Oe=Le[Pe];if(r[Oe]&P){for(var Ie=De,ke=Pe-1;ke>=0;ke--)if(!(r[Le[ke]]&s)){Ie=r[Le[ke]];break}u(Oe,Ie&(i|G)?D:Ie)}}if(c.get(S))for(var Be=0;Be<Le.length;Be++){var Ne=Le[Be];if(r[Ne]&S)for(var Fe=Be-1;Fe>=-1;Fe--){var Ue=-1===Fe?De:r[Le[Fe]];if(Ue&a){Ue===O&&u(Ne,A);break}}}if(c.get(O))for(var ze=0;ze<Le.length;ze++){var He=Le[ze];r[He]&O&&u(He,w)}if(c.get(M)||c.get(E))for(var Ge=1;Ge<Le.length-1;Ge++){var Ve=Le[Ge];if(r[Ve]&(M|E)){for(var je=0,We=0,Ye=Ge-1;Ye>=0&&(je=r[Le[Ye]])&s;Ye--);for(var Xe=Ge+1;Xe<Le.length&&(We=r[Le[Xe]])&s;Xe++);je===We&&(r[Ve]===M?je===S:je&(S|A))&&u(Ve,je)}}if(c.get(S))for(var $e=0;$e<Le.length;$e++){var Ze=Le[$e];if(r[Ze]&S){for(var qe=$e-1;qe>=0&&r[Le[qe]]&(T|s);qe--)u(Le[qe],S);for(var Je=$e+1;Je<Le.length&&r[Le[Je]]&(T|s);Je++)u(Le[Je],S)}}if(c.get(T)||c.get(M)||c.get(E))for(var Qe=0;Qe<Le.length;Qe++){var Ke=Le[Qe];if(r[Ke]&(T|M|E)){u(Ke,D);for(var et=Qe-1;et>=0&&r[Le[et]]&s;et--)u(Le[et],D);for(var tt=Qe+1;tt<Le.length&&r[Le[tt]]&s;tt++)u(Le[tt],D)}}if(c.get(S))for(var rt=0,nt=De;rt<Le.length;rt++){var it=Le[rt],at=r[it];at&S?nt===x&&u(it,x):at&a&&(nt=at)}if(c.get(o)){for(var ot=w|S|A,st=ot|x,lt=[],ct=[],ht=0;ht<Le.length;ht++)if(r[Le[ht]]&o){var ut=e[Le[ht]],dt=void 0;if(null!==v(ut)){if(!(ct.length<63))break;ct.push({char:ut,seqIndex:ht})}else if(null!==(dt=b(ut)))for(var pt=ct.length-1;pt>=0;pt--){var ft=ct[pt].char;if(ft===dt||ft===b(_(ut))||v(_(ft))===ut){lt.push([ct[pt].seqIndex,ht]),ct.length=pt;break}}}lt.sort((function(e,t){return e[0]-t[0]}));for(var mt=0;mt<lt.length;mt++){for(var gt=lt[mt],yt=gt[0],vt=gt[1],bt=!1,_t=0,xt=yt+1;xt<vt;xt++){var wt=Le[xt];if(r[wt]&st){bt=!0;var St=r[wt]&ot?w:x;if(St===Vt(wt)){_t=St;break}}}if(bt&&!_t){_t=De;for(var Mt=yt-1;Mt>=0;Mt--){var Tt=Le[Mt];if(r[Tt]&st){var At=r[Tt]&ot?w:x;_t=At!==Vt(Tt)?At:Vt(Tt);break}}}if(_t){if(r[Le[yt]]=r[Le[vt]]=_t,_t!==Vt(Le[yt]))for(var Et=yt+1;Et<Le.length;Et++)if(!(r[Le[Et]]&s)){h(e[Le[Et]])&P&&(r[Le[Et]]=_t);break}if(_t!==Vt(Le[vt]))for(var Ct=vt+1;Ct<Le.length;Ct++)if(!(r[Le[Ct]]&s)){h(e[Le[Ct]])&P&&(r[Le[Ct]]=_t);break}}}for(var Lt=0;Lt<Le.length;Lt++)if(r[Le[Lt]]&o){for(var Dt=Lt,Rt=Lt,Pt=De,Ot=Lt-1;Ot>=0;Ot--){if(!(r[Le[Ot]]&s)){Pt=r[Le[Ot]]&ot?w:x;break}Dt=Ot}for(var It=Re,kt=Lt+1;kt<Le.length;kt++){if(!(r[Le[kt]]&(o|s))){It=r[Le[kt]]&ot?w:x;break}Rt=kt}for(var Bt=Dt;Bt<=Rt;Bt++)r[Le[Bt]]=Pt===It?Pt:Vt(Le[Bt]);Lt=Rt}}}for(var Nt=m.start;Nt<=m.end;Nt++){var Ft=d[Nt],Ut=r[Nt];if(1&Ft?Ut&(x|S|A)&&d[Nt]++:Ut&w?d[Nt]++:Ut&(A|S)&&(d[Nt]+=2),Ut&s&&(d[Nt]=0===Nt?m.level:d[Nt-1]),Nt===m.end||h(e[Nt])&(L|C))for(var zt=Nt;zt>=0&&h(e[zt])&l;zt--)d[zt]=m.level}}return{levels:d,paragraphs:f};function Ht(t,n){for(var a=t;a<e.length;a++){var o=r[a];if(o&(w|O))return 1;if(o&(C|x)||n&&o===G)return 0;if(o&i){var s=Gt(a);a=-1===s?e.length:s}}return 0}function Gt(t){for(var n=1,a=t+1;a<e.length;a++){var o=r[a];if(o&C)break;if(o&G){if(0==--n)return a}else o&i&&n++}return-1}function Vt(e){return 1&d[e]?w:x}},e.getMirroredCharacter=j,e.getMirroredCharactersMap=function(e,t,r,n){var i=e.length;r=Math.max(0,null==r?0:+r),n=Math.min(i-1,null==n?i-1:+n);for(var a=new Map,o=r;o<=n;o++)if(1&t[o]){var s=j(e[o]);null!==s&&a.set(o,s)}return a},e.getReorderSegments=W,e.getReorderedIndices=Y,e.getReorderedString=function(e,t,r,n){var i=Y(e,t,r,n),a=[].concat(e);return i.forEach((function(r,n){a[n]=(1&t.levels[r]?j(e[r]):null)||e[r]})),a.join("")},e.openingToClosingBracket=v,Object.defineProperty(e,"__esModule",{value:!0}),e}({})}const voidMainRegExp=/\bvoid\s+main\s*\(\s*\)\s*{/g;function expandShaderIncludes(e){return e.replace(/^[ \t]*#include +<([\w\d./]+)>/gm,(function(e,t){let r=ShaderChunk[t];return r?expandShaderIncludes(r):e}))}const _lut=[];for(let e=0;e<256;e++)_lut[e]=(e<16?"0":"")+e.toString(16);function generateUUID(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,r=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return(_lut[255&e]+_lut[e>>8&255]+_lut[e>>16&255]+_lut[e>>24&255]+"-"+_lut[255&t]+_lut[t>>8&255]+"-"+_lut[t>>16&15|64]+_lut[t>>24&255]+"-"+_lut[63&r|128]+_lut[r>>8&255]+"-"+_lut[r>>16&255]+_lut[r>>24&255]+_lut[255&n]+_lut[n>>8&255]+_lut[n>>16&255]+_lut[n>>24&255]).toUpperCase()}const assign$1=Object.assign||function(){let e=arguments[0];for(let t=1,r=arguments.length;t<r;t++){let r=arguments[t];if(r)for(let t in r)r.hasOwnProperty(t)&&(e[t]=r[t])}return e},epoch=Date.now(),CONSTRUCTOR_CACHE=new WeakMap,SHADER_UPGRADE_CACHE=new Map;let materialInstanceId=1e10;function createDerivedMaterial(e,t){const r=getKeyForOptions(t);let n=CONSTRUCTOR_CACHE.get(e);if(n||CONSTRUCTOR_CACHE.set(e,n=Object.create(null)),n[r])return new n[r];const i=`_onBeforeCompile${r}`,a=function(n){e.onBeforeCompile.call(this,n);const a=r+"|||"+n.vertexShader+"|||"+n.fragmentShader;let o=SHADER_UPGRADE_CACHE[a];if(!o){const e=upgradeShaders(n,t,r);o=SHADER_UPGRADE_CACHE[a]=e}n.vertexShader=o.vertexShader,n.fragmentShader=o.fragmentShader,assign$1(n.uniforms,this.uniforms),t.timeUniform&&(n.uniforms[t.timeUniform]={get value(){return Date.now()-epoch}}),this[i]&&this[i](n)},o=function(){return s(t.chained?e:e.clone())},s=function(n){const i=Object.create(n,l);return Object.defineProperty(i,"baseMaterial",{value:e}),Object.defineProperty(i,"id",{value:materialInstanceId++}),i.uuid=generateUUID(),i.uniforms=assign$1({},n.uniforms,t.uniforms),i.defines=assign$1({},n.defines,t.defines),i.defines[`TROIKA_DERIVED_MATERIAL_${r}`]="",i.extensions=assign$1({},n.extensions,t.extensions),i._listeners=void 0,i},l={constructor:{value:o},isDerivedMaterial:{value:!0},customProgramCacheKey:{writable:!0,configurable:!0,value:function(){return r}},onBeforeCompile:{get:()=>a,set(e){this[i]=e}},copy:{writable:!0,configurable:!0,value:function(t){return e.copy.call(this,t),e.isShaderMaterial||e.isDerivedMaterial||(assign$1(this.extensions,t.extensions),assign$1(this.defines,t.defines),assign$1(this.uniforms,UniformsUtils.clone(t.uniforms))),this}},clone:{writable:!0,configurable:!0,value:function(){const t=new e.constructor;return s(t).copy(this)}},getDepthMaterial:{writable:!0,configurable:!0,value:function(){let r=this._depthMaterial;return r||(r=this._depthMaterial=createDerivedMaterial(e.isDerivedMaterial?e.getDepthMaterial():new MeshDepthMaterial({depthPacking:RGBADepthPacking}),t),r.defines.IS_DEPTH_MATERIAL="",r.uniforms=this.uniforms),r}},getDistanceMaterial:{writable:!0,configurable:!0,value:function(){let r=this._distanceMaterial;return r||(r=this._distanceMaterial=createDerivedMaterial(e.isDerivedMaterial?e.getDistanceMaterial():new MeshDistanceMaterial,t),r.defines.IS_DISTANCE_MATERIAL="",r.uniforms=this.uniforms),r}},dispose:{writable:!0,configurable:!0,value(){const{_depthMaterial:t,_distanceMaterial:r}=this;t&&t.dispose(),r&&r.dispose(),e.dispose.call(this)}}};return n[r]=o,new o}function upgradeShaders({vertexShader:e,fragmentShader:t},r,n){let{vertexDefs:i,vertexMainIntro:a,vertexMainOutro:o,vertexTransform:s,fragmentDefs:l,fragmentMainIntro:c,fragmentMainOutro:h,fragmentColorTransform:u,customRewriter:d,timeUniform:p}=r;if(i=i||"",a=a||"",o=o||"",l=l||"",c=c||"",h=h||"",(s||d)&&(e=expandShaderIncludes(e)),(u||d)&&(t=expandShaderIncludes(t=t.replace(/^[ \t]*#include <((?:tonemapping|encodings|fog|premultiplied_alpha|dithering)_fragment)>/gm,"\n//!BEGIN_POST_CHUNK $1\n$&\n//!END_POST_CHUNK\n"))),d){let r=d({vertexShader:e,fragmentShader:t});e=r.vertexShader,t=r.fragmentShader}if(u){let e=[];t=t.replace(/^\/\/!BEGIN_POST_CHUNK[^]+?^\/\/!END_POST_CHUNK/gm,(t=>(e.push(t),""))),h=`${u}\n${e.join("\n")}\n${h}`}if(p){const e=`\nuniform float ${p};\n`;i=e+i,l=e+l}return s&&(i=`${i}\nvoid troikaVertexTransform${n}(inout vec3 position, inout vec3 normal, inout vec2 uv) {\n  ${s}\n}\n`,a=`\ntroika_position_${n} = vec3(position);\ntroika_normal_${n} = vec3(normal);\ntroika_uv_${n} = vec2(uv);\ntroikaVertexTransform${n}(troika_position_${n}, troika_normal_${n}, troika_uv_${n});\n${a}\n`,e=(e=`vec3 troika_position_${n};\nvec3 troika_normal_${n};\nvec2 troika_uv_${n};\n${e}\n`).replace(/\b(position|normal|uv)\b/g,((e,t,r,i)=>/\battribute\s+vec[23]\s+$/.test(i.substr(0,r))?t:`troika_${t}_${n}`))),{vertexShader:e=injectIntoShaderCode(e,n,i,a,o),fragmentShader:t=injectIntoShaderCode(t,n,l,c,h)}}function injectIntoShaderCode(e,t,r,n,i){return(n||i||r)&&(e=e.replace(voidMainRegExp,`\n${r}\nvoid troikaOrigMain${t}() {`),e+=`\nvoid main() {\n  ${n}\n  troikaOrigMain${t}();\n  ${i}\n}`),e}function optionsJsonReplacer(e,t){return"uniforms"===e?void 0:"function"==typeof t?t.toString():t}let _idCtr=0;const optionsHashesToIds=new Map;function getKeyForOptions(e){const t=JSON.stringify(e,optionsJsonReplacer);let r=optionsHashesToIds.get(t);return null==r&&optionsHashesToIds.set(t,r=++_idCtr),r}function createSDFGenerator(e,t){const{sdfExponent:r,sdfMargin:n}=t;function i(e,t,r,n,i,a,o){const s=1-o;return{x:s*s*e+2*s*o*r+o*o*i,y:s*s*t+2*s*o*n+o*o*a}}function a(e,t,r,n,i,a,o,s,l){const c=1-l;return{x:c*c*c*e+3*c*c*l*r+3*c*l*l*i+l*l*l*o,y:c*c*c*t+3*c*c*l*n+3*c*l*l*a+l*l*l*s}}return function(t,o){const s=new Uint8Array(o*o),l=t.xMax-t.xMin,c=t.yMax-t.yMin,h=Math.max(l,c),u=Math.max(l,c)/o*(n*o+.5),d=t.xMin-u,p=t.yMin-u,f=t.xMax+u,m=t.yMax+u,g=f-d,y=m-p,v=Math.max(g,y);if(t.pathCommandCount){const n=e(t);let l,c,u,f;t.forEachPathCommand(((e,t,r,o,s,h,d)=>{switch(e){case"M":u=l=t,f=c=r;break;case"L":t===u&&r===f||n.addLineSegment(u,f,u=t,f=r);break;case"Q":{let e={x:u,y:f};for(let a=1;a<16;a++){let l=i(u,f,t,r,o,s,a/15);n.addLineSegment(e.x,e.y,l.x,l.y),e=l}u=o,f=s;break}case"C":{let e={x:u,y:f};for(let i=1;i<16;i++){let l=a(u,f,t,r,o,s,h,d,i/15);n.addLineSegment(e.x,e.y,l.x,l.y),e=l}u=h,f=d;break}case"Z":u===l&&f===c||n.addLineSegment(u,f,l,c)}}));for(let e=0;e<o;e++)for(let t=0;t<o;t++){const i=n.findNearestSignedDistance(d+g*(e+.5)/o,p+y*(t+.5)/o,h);let a=Math.pow(1-Math.abs(i)/v,r)/2;i<0&&(a=1-a),a=Math.max(0,Math.min(255,Math.round(255*a))),s[t*o+e]=a}}return{textureData:s,renderingBounds:[d,p,f,m]}}}function createFontProcessor(e,t,r,n){const{defaultFontURL:i}=n,a=Object.create(null),o=Object.create(null),s=1/0,l=/[\u00AD\u034F\u061C\u115F-\u1160\u17B4-\u17B5\u180B-\u180E\u200B-\u200F\u202A-\u202E\u2060-\u206F\u3164\uFE00-\uFE0F\uFEFF\uFFA0\uFFF0-\uFFF8]/;function c(t,r){t||(t=i);let n=o[t];n?n.pending?n.pending.push(r):r(n):(o[t]={pending:[r]},function(t,r){!function n(){const a=e=>{console.error(`Failure loading font ${t}${t===i?"":"; trying fallback"}`,e),t!==i&&(t=i,n())};try{const n=new XMLHttpRequest;n.open("get",t,!0),n.responseType="arraybuffer",n.onload=function(){if(n.status>=400)a(new Error(n.statusText));else if(n.status>0)try{const t=e(n.response);r(t)}catch(e){a(e)}},n.onerror=a,n.send()}catch(e){a(e)}}()}(t,(e=>{let r=o[t].pending;o[t]=e,r.forEach((t=>t(e)))})))}function h({text:e="",font:n=i,sdfGlyphSize:o=64,fontSize:h=1,letterSpacing:f=0,lineHeight:m="normal",maxWidth:g=s,direction:y,textAlign:v="left",textIndent:b=0,whiteSpace:_="normal",overflowWrap:x="normal",anchorX:w=0,anchorY:S=0,includeCaretPositions:M=!1,chunkedBoundsSize:T=8192,colorRanges:A=null},E,C=!1){const L=d(),D={total:0,fontLoad:0,layout:0,sdf:{},sdfTotal:0};e.indexOf("\r")>-1&&(console.warn("FontProcessor.process: got text with \\r chars; normalizing to \\n"),e=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n")),h=+h,f=+f,g=+g,m=m||"normal",b=+b,function(e,t,r){e||(e=i);let n=`${e}@${t}`,o=a[n];o?r(o):c(e,(e=>{o=a[n]||(a[n]={fontObj:e,glyphs:{},glyphCount:0}),r(o)}))}(n,o,(n=>{const i=n.fontObj,a=isFinite(g);let c=null,R=null,P=null,O=null,I=null,k=null,B=null,N=0,F=0,U="nowrap"!==_;const{ascender:z,descender:H,unitsPerEm:G}=i;D.fontLoad=d()-L;const V=d(),j=h/G;"normal"===m&&(m=(z-H)/G);const W=((m*=h)-(z-H)*j)/2,Y=-(z*j+W),X=Math.min(m,(z-H)*j),$=(z+H)/2*j-X/2;let Z=b,q=new p;const J=[q];i.forEachGlyph(e,h,f,((t,r,n)=>{const i=e.charAt(n),o=t.advanceWidth*j,s=q.count;let c;if("isEmpty"in t||(t.isWhitespace=!!i&&/\s/.test(i),t.isEmpty=t.xMin===t.xMax||t.yMin===t.yMax||l.test(i)),t.isWhitespace||t.isEmpty||F++,U&&a&&!t.isWhitespace&&r+o+Z>g&&s){if(q.glyphAt(s-1).glyphObj.isWhitespace)c=new p,Z=-r;else for(let e=s;e--;){if(0===e&&"break-word"===x){c=new p,Z=-r;break}if(q.glyphAt(e).glyphObj.isWhitespace){c=q.splitAt(e+1);const t=c.glyphAt(0).x;Z-=t;for(let e=c.count;e--;)c.glyphAt(e).x-=t;break}}c&&(q.isSoftWrapped=!0,q=c,J.push(q),N=g)}let u=q.glyphAt(q.count);u.glyphObj=t,u.x=r+Z,u.width=o,u.charIndex=n,"\n"===i&&(q=new p,J.push(q),Z=-(r+o+f*h)+b)})),J.forEach((e=>{for(let t=e.count;t--;){let{glyphObj:r,x:n,width:i}=e.glyphAt(t);if(!r.isWhitespace)return e.width=n+i,void(e.width>N&&(N=e.width))}}));let Q=0,K=0;if(w&&("number"==typeof w?Q=-w:"string"==typeof w&&(Q=-N*("left"===w?0:"center"===w?.5:"right"===w?1:u(w)))),S)if("number"==typeof S)K=-S;else if("string"==typeof S){let e=J.length*m;K="top"===S?0:"top-baseline"===S?-Y:"middle"===S?e/2:"bottom"===S?e:"bottom-baseline"===S?e-W+H*j:u(S)*e}if(!C){const a=r.getEmbeddingLevels(e,y);R=new Float32Array(4*F),P=new Float32Array(F),k=[s,s,-1/0,-1/0],B=[];let l=Y;M&&(I=new Float32Array(3*e.length)),A&&(O=new Uint8Array(3*F));let h,u,p=0,f=-1,g=-1;J.forEach(((y,b)=>{let{count:_,width:x}=y;if(_>0){let m=0;for(let e=_;e--&&y.glyphAt(e).glyphObj.isWhitespace;)m++;let b=0,w=0;if("center"===v)b=(N-x)/2;else if("right"===v)b=N-x;else if("justify"===v&&y.isSoftWrapped){let e=0;for(let t=_-m;t--;)y.glyphAt(t).glyphObj.isWhitespace&&e++;w=(N-x)/e}if(w||b){let e=0;for(let t=0;t<_;t++){let r=y.glyphAt(t);const n=r.glyphObj;r.x+=b+e,0!==w&&n.isWhitespace&&t<_-m&&(e+=w,r.width+=w)}}const S=r.getReorderSegments(e,a,y.glyphAt(0).charIndex,y.glyphAt(y.count-1).charIndex);for(let e=0;e<S.length;e++){const[t,r]=S[e];let n=1/0,i=-1/0;for(let e=0;e<_;e++)if(y.glyphAt(e).charIndex>=t){let t=e,a=e;for(;a<_;a++){let e=y.glyphAt(a);if(e.charIndex>r)break;a<_-m&&(n=Math.min(n,e.x),i=Math.max(i,e.x+e.width))}for(let e=t;e<a;e++){const t=y.glyphAt(e);t.x=i-(t.x+t.width-n)}break}}let E;const C=e=>E=e;for(let m=0;m<_;m++){let v=y.glyphAt(m);E=v.glyphObj;const b=1&a.levels[v.charIndex];if(b){const t=r.getMirroredCharacter(e[v.charIndex]);t&&i.forEachGlyph(t,0,0,C)}if(M){const{charIndex:e}=v,t=v.x+Q,r=v.x+v.width+Q;for(I[3*e]=b?r:t,I[3*e+1]=b?t:r,I[3*e+2]=l+$+K;e-f>1;)I[3*(f+1)]=I[3*f],I[3*(f+1)+1]=I[3*f+1],I[3*(f+1)+2]=I[3*f+2],f++;f=e}if(A){const{charIndex:e}=v;for(;e>g;)g++,A.hasOwnProperty(g)&&(u=A[g])}if(!E.isWhitespace&&!E.isEmpty){const r=p++;let i=n.glyphs[E.index];if(!i){const r=d(),a=t(E,o);D.sdf[e.charAt(v.charIndex)]=d()-r,a.atlasIndex=n.glyphCount++,c||(c=[]),c.push(a),i=n.glyphs[E.index]={atlasIndex:a.atlasIndex,glyphObj:E,renderingBounds:a.renderingBounds}}const a=i.renderingBounds,f=4*r,m=v.x+Q,g=l+K;R[f]=m+a[0]*j,R[f+1]=g+a[1]*j,R[f+2]=m+a[2]*j,R[f+3]=g+a[3]*j;const y=m+E.xMin*j,b=g+E.yMin*j,_=m+E.xMax*j,x=g+E.yMax*j;y<k[0]&&(k[0]=y),b<k[1]&&(k[1]=b),_>k[2]&&(k[2]=_),x>k[3]&&(k[3]=x),r%T==0&&(h={start:r,end:r,rect:[s,s,-1/0,-1/0]},B.push(h)),h.end++;const w=h.rect;if(y<w[0]&&(w[0]=y),b<w[1]&&(w[1]=b),_>w[2]&&(w[2]=_),x>w[3]&&(w[3]=x),P[r]=i.atlasIndex,A){const e=3*r;O[e]=u>>16&255,O[e+1]=u>>8&255,O[e+2]=255&u}}}}l-=m}))}for(let e in D.sdf)D.sdfTotal+=D.sdf[e];D.layout=d()-V-D.sdfTotal,D.total=d()-L,E({glyphBounds:R,glyphAtlasIndices:P,caretPositions:I,caretHeight:X,glyphColors:O,chunkedBounds:B,ascender:z*j,descender:H*j,lineHeight:m,topBaseline:Y,blockBounds:[Q,K-J.length*m,Q+N,K],visibleBounds:k,newGlyphSDFs:c,timings:D})}))}function u(e){let t=e.match(/^([\d.]+)%$/),r=t?parseFloat(t[1]):NaN;return isNaN(r)?0:r/100}function d(){return(self.performance||Date).now()}function p(){this.data=[]}const f=["glyphObj","x","width","charIndex"];return p.prototype={width:0,isSoftWrapped:!1,get count(){return Math.ceil(this.data.length/f.length)},glyphAt(e){let t=p.flyweight;return t.data=this.data,t.index=e,t},splitAt(e){let t=new p;return t.data=this.data.splice(e*f.length),t}},p.flyweight=f.reduce(((e,t,r,n)=>(Object.defineProperty(e,t,{get(){return this.data[this.index*f.length+r]},set(e){this.data[this.index*f.length+r]=e}}),e)),{data:null,index:0}),{process:h,measure:function(e,t){h(e,(e=>{const[r,n,i,a]=e.blockBounds;t({width:i-r,height:a-n})}),{metricsOnly:!0})},loadFont:c}}function createGlyphSegmentsIndex(){let e=!1;const t=[];function r(){e&&(t.sort((function(e,t){return e.maxX-t.maxX})),e=!1)}function n(e,t,r,n,i,a){const o=i-r,s=a-n,l=o*o+s*s,c=l?Math.max(0,Math.min(1,((e-r)*o+(t-n)*s)/l)):0,h=e-(r+c*o),u=t-(n+c*s);return h*h+u*u}return{addLineSegment:function(r,n,i,a){const o={x0:r,y0:n,x1:i,y1:a,minX:Math.min(r,i),minY:Math.min(n,a),maxX:Math.max(r,i),maxY:Math.max(n,a)};t.push(o),e=!0},findNearestSignedDistance:function(e,i){r();let a=1/0,o=1/0;for(let r=t.length;r--;){const s=t[r];if(s.maxX+o<=e)break;if(e+o>s.minX&&i-o<s.maxY&&i+o>s.minY){const t=n(e,i,s.x0,s.y0,s.x1,s.y1);t<a&&(a=t,o=Math.sqrt(a))}}return function(e,n){r();let i=!1;for(let r=t.length;r--;){const a=t[r];if(a.maxX<=e)break;if(a.minY<n&&a.maxY>n){a.y0>n!=a.y1>n&&e<(a.x1-a.x0)*(n-a.y0)/(a.y1-a.y0)+a.x0&&(i=!i)}}return i}(e,i)&&(o=-o),o}}}
/*!
  Custom build of Typr.ts (https://github.com/fredli74/Typr.ts) for use in Troika text rendering.
  Original MIT license applies: https://github.com/fredli74/Typr.ts/blob/master/LICENSE
  */function typrFactory(){return"undefined"==typeof window&&(self.window=self),function(e){var t={parse:function(e){var r=t._bin,n=new Uint8Array(e);if("ttcf"==r.readASCII(n,0,4)){var i=4;r.readUshort(n,i),i+=2,r.readUshort(n,i),i+=2;var a=r.readUint(n,i);i+=4;for(var o=[],s=0;s<a;s++){var l=r.readUint(n,i);i+=4,o.push(t._readFont(n,l))}return o}return[t._readFont(n,0)]},_readFont:function(e,r){var n=t._bin,i=r;n.readFixed(e,r),r+=4;var a=n.readUshort(e,r);r+=2,n.readUshort(e,r),r+=2,n.readUshort(e,r),r+=2,n.readUshort(e,r),r+=2;for(var o=["cmap","head","hhea","maxp","hmtx","name","OS/2","post","loca","glyf","kern","CFF ","GPOS","GSUB","SVG "],s={_data:e,_offset:i},l={},c=0;c<a;c++){var h=n.readASCII(e,r,4);r+=4,n.readUint(e,r),r+=4;var u=n.readUint(e,r);r+=4;var d=n.readUint(e,r);r+=4,l[h]={offset:u,length:d}}for(c=0;c<o.length;c++){var p=o[c];l[p]&&(s[p.trim()]=t[p.trim()].parse(e,l[p].offset,l[p].length,s))}return s},_tabOffset:function(e,r,n){for(var i=t._bin,a=i.readUshort(e,n+4),o=n+12,s=0;s<a;s++){var l=i.readASCII(e,o,4);o+=4,i.readUint(e,o),o+=4;var c=i.readUint(e,o);if(o+=4,i.readUint(e,o),o+=4,l==r)return c}return 0}};t._bin={readFixed:function(e,t){return(e[t]<<8|e[t+1])+(e[t+2]<<8|e[t+3])/65540},readF2dot14:function(e,r){return t._bin.readShort(e,r)/16384},readInt:function(e,r){var n=t._bin.t.uint8;return n[0]=e[r+3],n[1]=e[r+2],n[2]=e[r+1],n[3]=e[r],t._bin.t.int32[0]},readInt8:function(e,r){return t._bin.t.uint8[0]=e[r],t._bin.t.int8[0]},readShort:function(e,r){var n=t._bin.t.uint8;return n[1]=e[r],n[0]=e[r+1],t._bin.t.int16[0]},readUshort:function(e,t){return e[t]<<8|e[t+1]},readUshorts:function(e,r,n){for(var i=[],a=0;a<n;a++)i.push(t._bin.readUshort(e,r+2*a));return i},readUint:function(e,r){var n=t._bin.t.uint8;return n[3]=e[r],n[2]=e[r+1],n[1]=e[r+2],n[0]=e[r+3],t._bin.t.uint32[0]},readUint64:function(e,r){return 4294967296*t._bin.readUint(e,r)+t._bin.readUint(e,r+4)},readASCII:function(e,t,r){for(var n="",i=0;i<r;i++)n+=String.fromCharCode(e[t+i]);return n},readUnicode:function(e,t,r){for(var n="",i=0;i<r;i++){var a=e[t++]<<8|e[t++];n+=String.fromCharCode(a)}return n},_tdec:"undefined"!=typeof window&&window.TextDecoder?new window.TextDecoder:null,readUTF8:function(e,r,n){var i=t._bin._tdec;return i&&0==r&&n==e.length?i.decode(e):t._bin.readASCII(e,r,n)},readBytes:function(e,t,r){for(var n=[],i=0;i<r;i++)n.push(e[t+i]);return n},readASCIIArray:function(e,t,r){for(var n=[],i=0;i<r;i++)n.push(String.fromCharCode(e[t+i]));return n}},t._bin.t={buff:new ArrayBuffer(8)},t._bin.t.int8=new Int8Array(t._bin.t.buff),t._bin.t.uint8=new Uint8Array(t._bin.t.buff),t._bin.t.int16=new Int16Array(t._bin.t.buff),t._bin.t.uint16=new Uint16Array(t._bin.t.buff),t._bin.t.int32=new Int32Array(t._bin.t.buff),t._bin.t.uint32=new Uint32Array(t._bin.t.buff),t._lctf={},t._lctf.parse=function(e,r,n,i,a){var o=t._bin,s={},l=r;o.readFixed(e,r),r+=4;var c=o.readUshort(e,r);r+=2;var h=o.readUshort(e,r);r+=2;var u=o.readUshort(e,r);return r+=2,s.scriptList=t._lctf.readScriptList(e,l+c),s.featureList=t._lctf.readFeatureList(e,l+h),s.lookupList=t._lctf.readLookupList(e,l+u,a),s},t._lctf.readLookupList=function(e,r,n){var i=t._bin,a=r,o=[],s=i.readUshort(e,r);r+=2;for(var l=0;l<s;l++){var c=i.readUshort(e,r);r+=2;var h=t._lctf.readLookupTable(e,a+c,n);o.push(h)}return o},t._lctf.readLookupTable=function(e,r,n){var i=t._bin,a=r,o={tabs:[]};o.ltype=i.readUshort(e,r),r+=2,o.flag=i.readUshort(e,r),r+=2;var s=i.readUshort(e,r);r+=2;for(var l=o.ltype,c=0;c<s;c++){var h=i.readUshort(e,r);r+=2;var u=n(e,l,a+h,o);o.tabs.push(u)}return o},t._lctf.numOfOnes=function(e){for(var t=0,r=0;r<32;r++)0!=(e>>>r&1)&&t++;return t},t._lctf.readClassDef=function(e,r){var n=t._bin,i=[],a=n.readUshort(e,r);if(r+=2,1==a){var o=n.readUshort(e,r);r+=2;var s=n.readUshort(e,r);r+=2;for(var l=0;l<s;l++)i.push(o+l),i.push(o+l),i.push(n.readUshort(e,r)),r+=2}if(2==a){var c=n.readUshort(e,r);for(r+=2,l=0;l<c;l++)i.push(n.readUshort(e,r)),r+=2,i.push(n.readUshort(e,r)),r+=2,i.push(n.readUshort(e,r)),r+=2}return i},t._lctf.getInterval=function(e,t){for(var r=0;r<e.length;r+=3){var n=e[r],i=e[r+1];if(e[r+2],n<=t&&t<=i)return r}return-1},t._lctf.readCoverage=function(e,r){var n=t._bin,i={};i.fmt=n.readUshort(e,r),r+=2;var a=n.readUshort(e,r);return r+=2,1==i.fmt&&(i.tab=n.readUshorts(e,r,a)),2==i.fmt&&(i.tab=n.readUshorts(e,r,3*a)),i},t._lctf.coverageIndex=function(e,r){var n=e.tab;if(1==e.fmt)return n.indexOf(r);if(2==e.fmt){var i=t._lctf.getInterval(n,r);if(-1!=i)return n[i+2]+(r-n[i])}return-1},t._lctf.readFeatureList=function(e,r){var n=t._bin,i=r,a=[],o=n.readUshort(e,r);r+=2;for(var s=0;s<o;s++){var l=n.readASCII(e,r,4);r+=4;var c=n.readUshort(e,r);r+=2;var h=t._lctf.readFeatureTable(e,i+c);h.tag=l.trim(),a.push(h)}return a},t._lctf.readFeatureTable=function(e,r){var n=t._bin,i=r,a={},o=n.readUshort(e,r);r+=2,o>0&&(a.featureParams=i+o);var s=n.readUshort(e,r);r+=2,a.tab=[];for(var l=0;l<s;l++)a.tab.push(n.readUshort(e,r+2*l));return a},t._lctf.readScriptList=function(e,r){var n=t._bin,i=r,a={},o=n.readUshort(e,r);r+=2;for(var s=0;s<o;s++){var l=n.readASCII(e,r,4);r+=4;var c=n.readUshort(e,r);r+=2,a[l.trim()]=t._lctf.readScriptTable(e,i+c)}return a},t._lctf.readScriptTable=function(e,r){var n=t._bin,i=r,a={},o=n.readUshort(e,r);r+=2,a.default=t._lctf.readLangSysTable(e,i+o);var s=n.readUshort(e,r);r+=2;for(var l=0;l<s;l++){var c=n.readASCII(e,r,4);r+=4;var h=n.readUshort(e,r);r+=2,a[c.trim()]=t._lctf.readLangSysTable(e,i+h)}return a},t._lctf.readLangSysTable=function(e,r){var n=t._bin,i={};n.readUshort(e,r),r+=2,i.reqFeature=n.readUshort(e,r),r+=2;var a=n.readUshort(e,r);return r+=2,i.features=n.readUshorts(e,r,a),i},t.CFF={},t.CFF.parse=function(e,r,n){var i=t._bin;(e=new Uint8Array(e.buffer,r,n))[r=0],e[++r],e[++r],e[++r],r++;var a=[];r=t.CFF.readIndex(e,r,a);for(var o=[],s=0;s<a.length-1;s++)o.push(i.readASCII(e,r+a[s],a[s+1]-a[s]));r+=a[a.length-1];var l=[];r=t.CFF.readIndex(e,r,l);var c=[];for(s=0;s<l.length-1;s++)c.push(t.CFF.readDict(e,r+l[s],r+l[s+1]));r+=l[l.length-1];var h=c[0],u=[];r=t.CFF.readIndex(e,r,u);var d=[];for(s=0;s<u.length-1;s++)d.push(i.readASCII(e,r+u[s],u[s+1]-u[s]));if(r+=u[u.length-1],t.CFF.readSubrs(e,r,h),h.CharStrings){r=h.CharStrings,u=[],r=t.CFF.readIndex(e,r,u);var p=[];for(s=0;s<u.length-1;s++)p.push(i.readBytes(e,r+u[s],u[s+1]-u[s]));h.CharStrings=p}if(h.ROS){r=h.FDArray;var f=[];for(r=t.CFF.readIndex(e,r,f),h.FDArray=[],s=0;s<f.length-1;s++){var m=t.CFF.readDict(e,r+f[s],r+f[s+1]);t.CFF._readFDict(e,m,d),h.FDArray.push(m)}r+=f[f.length-1],r=h.FDSelect,h.FDSelect=[];var g=e[r];if(r++,3!=g)throw g;var y=i.readUshort(e,r);for(r+=2,s=0;s<y+1;s++)h.FDSelect.push(i.readUshort(e,r),e[r+2]),r+=3}return h.Encoding&&(h.Encoding=t.CFF.readEncoding(e,h.Encoding,h.CharStrings.length)),h.charset&&(h.charset=t.CFF.readCharset(e,h.charset,h.CharStrings.length)),t.CFF._readFDict(e,h,d),h},t.CFF._readFDict=function(e,r,n){var i;for(var a in r.Private&&(i=r.Private[1],r.Private=t.CFF.readDict(e,i,i+r.Private[0]),r.Private.Subrs&&t.CFF.readSubrs(e,i+r.Private.Subrs,r.Private)),r)-1!=["FamilyName","FontName","FullName","Notice","version","Copyright"].indexOf(a)&&(r[a]=n[r[a]-426+35])},t.CFF.readSubrs=function(e,r,n){var i=t._bin,a=[];r=t.CFF.readIndex(e,r,a);var o,s=a.length;o=s<1240?107:s<33900?1131:32768,n.Bias=o,n.Subrs=[];for(var l=0;l<a.length-1;l++)n.Subrs.push(i.readBytes(e,r+a[l],a[l+1]-a[l]))},t.CFF.tableSE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,0,111,112,113,114,0,115,116,117,118,119,120,121,122,0,123,0,124,125,126,127,128,129,130,131,0,132,133,0,134,135,136,137,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,138,0,139,0,0,0,0,140,141,142,143,0,0,0,0,0,144,0,0,0,145,0,0,146,147,148,149,0,0,0,0],t.CFF.glyphByUnicode=function(e,t){for(var r=0;r<e.charset.length;r++)if(e.charset[r]==t)return r;return-1},t.CFF.glyphBySE=function(e,r){return r<0||r>255?-1:t.CFF.glyphByUnicode(e,t.CFF.tableSE[r])},t.CFF.readEncoding=function(e,r,n){t._bin;var i=[".notdef"],a=e[r];if(r++,0!=a)throw"error: unknown encoding format: "+a;var o=e[r];r++;for(var s=0;s<o;s++)i.push(e[r+s]);return i},t.CFF.readCharset=function(e,r,n){var i=t._bin,a=[".notdef"],o=e[r];if(r++,0==o)for(var s=0;s<n;s++){var l=i.readUshort(e,r);r+=2,a.push(l)}else{if(1!=o&&2!=o)throw"error: format: "+o;for(;a.length<n;){l=i.readUshort(e,r),r+=2;var c=0;for(1==o?(c=e[r],r++):(c=i.readUshort(e,r),r+=2),s=0;s<=c;s++)a.push(l),l++}}return a},t.CFF.readIndex=function(e,r,n){var i=t._bin,a=i.readUshort(e,r)+1,o=e[r+=2];if(r++,1==o)for(var s=0;s<a;s++)n.push(e[r+s]);else if(2==o)for(s=0;s<a;s++)n.push(i.readUshort(e,r+2*s));else if(3==o)for(s=0;s<a;s++)n.push(16777215&i.readUint(e,r+3*s-1));else if(1!=a)throw"unsupported offset size: "+o+", count: "+a;return(r+=a*o)-1},t.CFF.getCharString=function(e,r,n){var i=t._bin,a=e[r],o=e[r+1];e[r+2],e[r+3],e[r+4];var s=1,l=null,c=null;a<=20&&(l=a,s=1),12==a&&(l=100*a+o,s=2),21<=a&&a<=27&&(l=a,s=1),28==a&&(c=i.readShort(e,r+1),s=3),29<=a&&a<=31&&(l=a,s=1),32<=a&&a<=246&&(c=a-139,s=1),247<=a&&a<=250&&(c=256*(a-247)+o+108,s=2),251<=a&&a<=254&&(c=256*-(a-251)-o-108,s=2),255==a&&(c=i.readInt(e,r+1)/65535,s=5),n.val=null!=c?c:"o"+l,n.size=s},t.CFF.readCharString=function(e,r,n){for(var i=r+n,a=t._bin,o=[];r<i;){var s=e[r],l=e[r+1];e[r+2],e[r+3],e[r+4];var c=1,h=null,u=null;s<=20&&(h=s,c=1),12==s&&(h=100*s+l,c=2),19!=s&&20!=s||(h=s,c=2),21<=s&&s<=27&&(h=s,c=1),28==s&&(u=a.readShort(e,r+1),c=3),29<=s&&s<=31&&(h=s,c=1),32<=s&&s<=246&&(u=s-139,c=1),247<=s&&s<=250&&(u=256*(s-247)+l+108,c=2),251<=s&&s<=254&&(u=256*-(s-251)-l-108,c=2),255==s&&(u=a.readInt(e,r+1)/65535,c=5),o.push(null!=u?u:"o"+h),r+=c}return o},t.CFF.readDict=function(e,r,n){for(var i=t._bin,a={},o=[];r<n;){var s=e[r],l=e[r+1];e[r+2],e[r+3],e[r+4];var c=1,h=null,u=null;if(28==s&&(u=i.readShort(e,r+1),c=3),29==s&&(u=i.readInt(e,r+1),c=5),32<=s&&s<=246&&(u=s-139,c=1),247<=s&&s<=250&&(u=256*(s-247)+l+108,c=2),251<=s&&s<=254&&(u=256*-(s-251)-l-108,c=2),255==s)throw u=i.readInt(e,r+1)/65535,c=5,"unknown number";if(30==s){var d=[];for(c=1;;){var p=e[r+c];c++;var f=p>>4,m=15&p;if(15!=f&&d.push(f),15!=m&&d.push(m),15==m)break}for(var g="",y=[0,1,2,3,4,5,6,7,8,9,".","e","e-","reserved","-","endOfNumber"],v=0;v<d.length;v++)g+=y[d[v]];u=parseFloat(g)}s<=21&&(h=["version","Notice","FullName","FamilyName","Weight","FontBBox","BlueValues","OtherBlues","FamilyBlues","FamilyOtherBlues","StdHW","StdVW","escape","UniqueID","XUID","charset","Encoding","CharStrings","Private","Subrs","defaultWidthX","nominalWidthX"][s],c=1,12==s&&(h=["Copyright","isFixedPitch","ItalicAngle","UnderlinePosition","UnderlineThickness","PaintType","CharstringType","FontMatrix","StrokeWidth","BlueScale","BlueShift","BlueFuzz","StemSnapH","StemSnapV","ForceBold",0,0,"LanguageGroup","ExpansionFactor","initialRandomSeed","SyntheticBase","PostScript","BaseFontName","BaseFontBlend",0,0,0,0,0,0,"ROS","CIDFontVersion","CIDFontRevision","CIDFontType","CIDCount","UIDBase","FDArray","FDSelect","FontName"][l],c=2)),null!=h?(a[h]=1==o.length?o[0]:o,o=[]):o.push(u),r+=c}return a},t.cmap={},t.cmap.parse=function(e,r,n){e=new Uint8Array(e.buffer,r,n),r=0;var i=t._bin,a={};i.readUshort(e,r),r+=2;var o=i.readUshort(e,r);r+=2;var s=[];a.tables=[];for(var l=0;l<o;l++){var c=i.readUshort(e,r);r+=2;var h=i.readUshort(e,r);r+=2;var u=i.readUint(e,r);r+=4;var d="p"+c+"e"+h,p=s.indexOf(u);if(-1==p){var f;p=a.tables.length,s.push(u);var m=i.readUshort(e,u);0==m?f=t.cmap.parse0(e,u):4==m?f=t.cmap.parse4(e,u):6==m?f=t.cmap.parse6(e,u):12==m?f=t.cmap.parse12(e,u):console.debug("unknown format: "+m,c,h,u),a.tables.push(f)}if(null!=a[d])throw"multiple tables for one platform+encoding";a[d]=p}return a},t.cmap.parse0=function(e,r){var n=t._bin,i={};i.format=n.readUshort(e,r),r+=2;var a=n.readUshort(e,r);r+=2,n.readUshort(e,r),r+=2,i.map=[];for(var o=0;o<a-6;o++)i.map.push(e[r+o]);return i},t.cmap.parse4=function(e,r){var n=t._bin,i=r,a={};a.format=n.readUshort(e,r),r+=2;var o=n.readUshort(e,r);r+=2,n.readUshort(e,r),r+=2;var s=n.readUshort(e,r);r+=2;var l=s/2;a.searchRange=n.readUshort(e,r),r+=2,a.entrySelector=n.readUshort(e,r),r+=2,a.rangeShift=n.readUshort(e,r),r+=2,a.endCount=n.readUshorts(e,r,l),r+=2*l,r+=2,a.startCount=n.readUshorts(e,r,l),r+=2*l,a.idDelta=[];for(var c=0;c<l;c++)a.idDelta.push(n.readShort(e,r)),r+=2;for(a.idRangeOffset=n.readUshorts(e,r,l),r+=2*l,a.glyphIdArray=[];r<i+o;)a.glyphIdArray.push(n.readUshort(e,r)),r+=2;return a},t.cmap.parse6=function(e,r){var n=t._bin,i={};i.format=n.readUshort(e,r),r+=2,n.readUshort(e,r),r+=2,n.readUshort(e,r),r+=2,i.firstCode=n.readUshort(e,r),r+=2;var a=n.readUshort(e,r);r+=2,i.glyphIdArray=[];for(var o=0;o<a;o++)i.glyphIdArray.push(n.readUshort(e,r)),r+=2;return i},t.cmap.parse12=function(e,r){var n=t._bin,i={};i.format=n.readUshort(e,r),r+=2,r+=2,n.readUint(e,r),r+=4,n.readUint(e,r),r+=4;var a=n.readUint(e,r);r+=4,i.groups=[];for(var o=0;o<a;o++){var s=r+12*o,l=n.readUint(e,s+0),c=n.readUint(e,s+4),h=n.readUint(e,s+8);i.groups.push([l,c,h])}return i},t.glyf={},t.glyf.parse=function(e,t,r,n){for(var i=[],a=0;a<n.maxp.numGlyphs;a++)i.push(null);return i},t.glyf._parseGlyf=function(e,r){var n=t._bin,i=e._data,a=t._tabOffset(i,"glyf",e._offset)+e.loca[r];if(e.loca[r]==e.loca[r+1])return null;var o={};if(o.noc=n.readShort(i,a),a+=2,o.xMin=n.readShort(i,a),a+=2,o.yMin=n.readShort(i,a),a+=2,o.xMax=n.readShort(i,a),a+=2,o.yMax=n.readShort(i,a),a+=2,o.xMin>=o.xMax||o.yMin>=o.yMax)return null;if(o.noc>0){o.endPts=[];for(var s=0;s<o.noc;s++)o.endPts.push(n.readUshort(i,a)),a+=2;var l=n.readUshort(i,a);if(a+=2,i.length-a<l)return null;o.instructions=n.readBytes(i,a,l),a+=l;var c=o.endPts[o.noc-1]+1;for(o.flags=[],s=0;s<c;s++){var h=i[a];if(a++,o.flags.push(h),0!=(8&h)){var u=i[a];a++;for(var d=0;d<u;d++)o.flags.push(h),s++}}for(o.xs=[],s=0;s<c;s++){var p=0!=(2&o.flags[s]),f=0!=(16&o.flags[s]);p?(o.xs.push(f?i[a]:-i[a]),a++):f?o.xs.push(0):(o.xs.push(n.readShort(i,a)),a+=2)}for(o.ys=[],s=0;s<c;s++)p=0!=(4&o.flags[s]),f=0!=(32&o.flags[s]),p?(o.ys.push(f?i[a]:-i[a]),a++):f?o.ys.push(0):(o.ys.push(n.readShort(i,a)),a+=2);var m=0,g=0;for(s=0;s<c;s++)m+=o.xs[s],g+=o.ys[s],o.xs[s]=m,o.ys[s]=g}else{var y;o.parts=[];do{y=n.readUshort(i,a),a+=2;var v={m:{a:1,b:0,c:0,d:1,tx:0,ty:0},p1:-1,p2:-1};if(o.parts.push(v),v.glyphIndex=n.readUshort(i,a),a+=2,1&y){var b=n.readShort(i,a);a+=2;var _=n.readShort(i,a);a+=2}else b=n.readInt8(i,a),a++,_=n.readInt8(i,a),a++;2&y?(v.m.tx=b,v.m.ty=_):(v.p1=b,v.p2=_),8&y?(v.m.a=v.m.d=n.readF2dot14(i,a),a+=2):64&y?(v.m.a=n.readF2dot14(i,a),a+=2,v.m.d=n.readF2dot14(i,a),a+=2):128&y&&(v.m.a=n.readF2dot14(i,a),a+=2,v.m.b=n.readF2dot14(i,a),a+=2,v.m.c=n.readF2dot14(i,a),a+=2,v.m.d=n.readF2dot14(i,a),a+=2)}while(32&y);if(256&y){var x=n.readUshort(i,a);for(a+=2,o.instr=[],s=0;s<x;s++)o.instr.push(i[a]),a++}}return o},t.GPOS={},t.GPOS.parse=function(e,r,n,i){return t._lctf.parse(e,r,n,i,t.GPOS.subt)},t.GPOS.subt=function(e,r,n,i){var a=t._bin,o=n,s={};if(s.fmt=a.readUshort(e,n),n+=2,1==r||2==r||3==r||7==r||8==r&&s.fmt<=2){var l=a.readUshort(e,n);n+=2,s.coverage=t._lctf.readCoverage(e,l+o)}if(1==r&&1==s.fmt){var c=a.readUshort(e,n);n+=2;var h=t._lctf.numOfOnes(c);0!=c&&(s.pos=t.GPOS.readValueRecord(e,n,c))}else if(2==r&&s.fmt>=1&&s.fmt<=2){c=a.readUshort(e,n),n+=2;var u=a.readUshort(e,n);n+=2,h=t._lctf.numOfOnes(c);var d=t._lctf.numOfOnes(u);if(1==s.fmt){s.pairsets=[];var p=a.readUshort(e,n);n+=2;for(var f=0;f<p;f++){var m=o+a.readUshort(e,n);n+=2;var g=a.readUshort(e,m);m+=2;for(var y=[],v=0;v<g;v++){var b=a.readUshort(e,m);m+=2,0!=c&&(T=t.GPOS.readValueRecord(e,m,c),m+=2*h),0!=u&&(A=t.GPOS.readValueRecord(e,m,u),m+=2*d),y.push({gid2:b,val1:T,val2:A})}s.pairsets.push(y)}}if(2==s.fmt){var _=a.readUshort(e,n);n+=2;var x=a.readUshort(e,n);n+=2;var w=a.readUshort(e,n);n+=2;var S=a.readUshort(e,n);for(n+=2,s.classDef1=t._lctf.readClassDef(e,o+_),s.classDef2=t._lctf.readClassDef(e,o+x),s.matrix=[],f=0;f<w;f++){var M=[];for(v=0;v<S;v++){var T=null,A=null;0!=c&&(T=t.GPOS.readValueRecord(e,n,c),n+=2*h),0!=u&&(A=t.GPOS.readValueRecord(e,n,u),n+=2*d),M.push({val1:T,val2:A})}s.matrix.push(M)}}}else{if(9==r&&1==s.fmt){var E=a.readUshort(e,n);n+=2;var C=a.readUint(e,n);if(n+=4,9==i.ltype)i.ltype=E;else if(i.ltype!=E)throw"invalid extension substitution";return t.GPOS.subt(e,i.ltype,o+C)}console.debug("unsupported GPOS table LookupType",r,"format",s.fmt)}return s},t.GPOS.readValueRecord=function(e,r,n){var i=t._bin,a=[];return a.push(1&n?i.readShort(e,r):0),r+=1&n?2:0,a.push(2&n?i.readShort(e,r):0),r+=2&n?2:0,a.push(4&n?i.readShort(e,r):0),r+=4&n?2:0,a.push(8&n?i.readShort(e,r):0),r+=8&n?2:0,a},t.GSUB={},t.GSUB.parse=function(e,r,n,i){return t._lctf.parse(e,r,n,i,t.GSUB.subt)},t.GSUB.subt=function(e,r,n,i){var a=t._bin,o=n,s={};if(s.fmt=a.readUshort(e,n),n+=2,1!=r&&4!=r&&5!=r&&6!=r)return null;if(1==r||4==r||5==r&&s.fmt<=2||6==r&&s.fmt<=2){var l=a.readUshort(e,n);n+=2,s.coverage=t._lctf.readCoverage(e,o+l)}if(1==r&&s.fmt>=1&&s.fmt<=2){if(1==s.fmt)s.delta=a.readShort(e,n),n+=2;else if(2==s.fmt){var c=a.readUshort(e,n);n+=2,s.newg=a.readUshorts(e,n,c),n+=2*s.newg.length}}else if(4==r){s.vals=[],c=a.readUshort(e,n),n+=2;for(var h=0;h<c;h++){var u=a.readUshort(e,n);n+=2,s.vals.push(t.GSUB.readLigatureSet(e,o+u))}}else if(5==r&&2==s.fmt){if(2==s.fmt){var d=a.readUshort(e,n);n+=2,s.cDef=t._lctf.readClassDef(e,o+d),s.scset=[];var p=a.readUshort(e,n);for(n+=2,h=0;h<p;h++){var f=a.readUshort(e,n);n+=2,s.scset.push(0==f?null:t.GSUB.readSubClassSet(e,o+f))}}}else if(6==r&&3==s.fmt){if(3==s.fmt){for(h=0;h<3;h++){c=a.readUshort(e,n),n+=2;for(var m=[],g=0;g<c;g++)m.push(t._lctf.readCoverage(e,o+a.readUshort(e,n+2*g)));n+=2*c,0==h&&(s.backCvg=m),1==h&&(s.inptCvg=m),2==h&&(s.ahedCvg=m)}c=a.readUshort(e,n),n+=2,s.lookupRec=t.GSUB.readSubstLookupRecords(e,n,c)}}else{if(7==r&&1==s.fmt){var y=a.readUshort(e,n);n+=2;var v=a.readUint(e,n);if(n+=4,9==i.ltype)i.ltype=y;else if(i.ltype!=y)throw"invalid extension substitution";return t.GSUB.subt(e,i.ltype,o+v)}console.debug("unsupported GSUB table LookupType",r,"format",s.fmt)}return s},t.GSUB.readSubClassSet=function(e,r){var n=t._bin.readUshort,i=r,a=[],o=n(e,r);r+=2;for(var s=0;s<o;s++){var l=n(e,r);r+=2,a.push(t.GSUB.readSubClassRule(e,i+l))}return a},t.GSUB.readSubClassRule=function(e,r){var n=t._bin.readUshort,i={},a=n(e,r),o=n(e,r+=2);r+=2,i.input=[];for(var s=0;s<a-1;s++)i.input.push(n(e,r)),r+=2;return i.substLookupRecords=t.GSUB.readSubstLookupRecords(e,r,o),i},t.GSUB.readSubstLookupRecords=function(e,r,n){for(var i=t._bin.readUshort,a=[],o=0;o<n;o++)a.push(i(e,r),i(e,r+2)),r+=4;return a},t.GSUB.readChainSubClassSet=function(e,r){var n=t._bin,i=r,a=[],o=n.readUshort(e,r);r+=2;for(var s=0;s<o;s++){var l=n.readUshort(e,r);r+=2,a.push(t.GSUB.readChainSubClassRule(e,i+l))}return a},t.GSUB.readChainSubClassRule=function(e,r){for(var n=t._bin,i={},a=["backtrack","input","lookahead"],o=0;o<a.length;o++){var s=n.readUshort(e,r);r+=2,1==o&&s--,i[a[o]]=n.readUshorts(e,r,s),r+=2*i[a[o]].length}return s=n.readUshort(e,r),r+=2,i.subst=n.readUshorts(e,r,2*s),r+=2*i.subst.length,i},t.GSUB.readLigatureSet=function(e,r){var n=t._bin,i=r,a=[],o=n.readUshort(e,r);r+=2;for(var s=0;s<o;s++){var l=n.readUshort(e,r);r+=2,a.push(t.GSUB.readLigature(e,i+l))}return a},t.GSUB.readLigature=function(e,r){var n=t._bin,i={chain:[]};i.nglyph=n.readUshort(e,r),r+=2;var a=n.readUshort(e,r);r+=2;for(var o=0;o<a-1;o++)i.chain.push(n.readUshort(e,r)),r+=2;return i},t.head={},t.head.parse=function(e,r,n){var i=t._bin,a={};return i.readFixed(e,r),r+=4,a.fontRevision=i.readFixed(e,r),r+=4,i.readUint(e,r),r+=4,i.readUint(e,r),r+=4,a.flags=i.readUshort(e,r),r+=2,a.unitsPerEm=i.readUshort(e,r),r+=2,a.created=i.readUint64(e,r),r+=8,a.modified=i.readUint64(e,r),r+=8,a.xMin=i.readShort(e,r),r+=2,a.yMin=i.readShort(e,r),r+=2,a.xMax=i.readShort(e,r),r+=2,a.yMax=i.readShort(e,r),r+=2,a.macStyle=i.readUshort(e,r),r+=2,a.lowestRecPPEM=i.readUshort(e,r),r+=2,a.fontDirectionHint=i.readShort(e,r),r+=2,a.indexToLocFormat=i.readShort(e,r),r+=2,a.glyphDataFormat=i.readShort(e,r),r+=2,a},t.hhea={},t.hhea.parse=function(e,r,n){var i=t._bin,a={};return i.readFixed(e,r),r+=4,a.ascender=i.readShort(e,r),r+=2,a.descender=i.readShort(e,r),r+=2,a.lineGap=i.readShort(e,r),r+=2,a.advanceWidthMax=i.readUshort(e,r),r+=2,a.minLeftSideBearing=i.readShort(e,r),r+=2,a.minRightSideBearing=i.readShort(e,r),r+=2,a.xMaxExtent=i.readShort(e,r),r+=2,a.caretSlopeRise=i.readShort(e,r),r+=2,a.caretSlopeRun=i.readShort(e,r),r+=2,a.caretOffset=i.readShort(e,r),r+=2,r+=8,a.metricDataFormat=i.readShort(e,r),r+=2,a.numberOfHMetrics=i.readUshort(e,r),r+=2,a},t.hmtx={},t.hmtx.parse=function(e,r,n,i){for(var a=t._bin,o={aWidth:[],lsBearing:[]},s=0,l=0,c=0;c<i.maxp.numGlyphs;c++)c<i.hhea.numberOfHMetrics&&(s=a.readUshort(e,r),r+=2,l=a.readShort(e,r),r+=2),o.aWidth.push(s),o.lsBearing.push(l);return o},t.kern={},t.kern.parse=function(e,r,n,i){var a=t._bin,o=a.readUshort(e,r);if(r+=2,1==o)return t.kern.parseV1(e,r-2,n,i);var s=a.readUshort(e,r);r+=2;for(var l={glyph1:[],rval:[]},c=0;c<s;c++){r+=2,n=a.readUshort(e,r),r+=2;var h=a.readUshort(e,r);r+=2;var u=h>>>8;if(0!=(u&=15))throw"unknown kern table format: "+u;r=t.kern.readFormat0(e,r,l)}return l},t.kern.parseV1=function(e,r,n,i){var a=t._bin;a.readFixed(e,r),r+=4;var o=a.readUint(e,r);r+=4;for(var s={glyph1:[],rval:[]},l=0;l<o;l++){a.readUint(e,r),r+=4;var c=a.readUshort(e,r);r+=2,a.readUshort(e,r),r+=2;var h=c>>>8;if(0!=(h&=15))throw"unknown kern table format: "+h;r=t.kern.readFormat0(e,r,s)}return s},t.kern.readFormat0=function(e,r,n){var i=t._bin,a=-1,o=i.readUshort(e,r);r+=2,i.readUshort(e,r),r+=2,i.readUshort(e,r),r+=2,i.readUshort(e,r),r+=2;for(var s=0;s<o;s++){var l=i.readUshort(e,r);r+=2;var c=i.readUshort(e,r);r+=2;var h=i.readShort(e,r);r+=2,l!=a&&(n.glyph1.push(l),n.rval.push({glyph2:[],vals:[]}));var u=n.rval[n.rval.length-1];u.glyph2.push(c),u.vals.push(h),a=l}return r},t.loca={},t.loca.parse=function(e,r,n,i){var a=t._bin,o=[],s=i.head.indexToLocFormat,l=i.maxp.numGlyphs+1;if(0==s)for(var c=0;c<l;c++)o.push(a.readUshort(e,r+(c<<1))<<1);if(1==s)for(c=0;c<l;c++)o.push(a.readUint(e,r+(c<<2)));return o},t.maxp={},t.maxp.parse=function(e,r,n){var i=t._bin,a={},o=i.readUint(e,r);return r+=4,a.numGlyphs=i.readUshort(e,r),r+=2,65536==o&&(a.maxPoints=i.readUshort(e,r),r+=2,a.maxContours=i.readUshort(e,r),r+=2,a.maxCompositePoints=i.readUshort(e,r),r+=2,a.maxCompositeContours=i.readUshort(e,r),r+=2,a.maxZones=i.readUshort(e,r),r+=2,a.maxTwilightPoints=i.readUshort(e,r),r+=2,a.maxStorage=i.readUshort(e,r),r+=2,a.maxFunctionDefs=i.readUshort(e,r),r+=2,a.maxInstructionDefs=i.readUshort(e,r),r+=2,a.maxStackElements=i.readUshort(e,r),r+=2,a.maxSizeOfInstructions=i.readUshort(e,r),r+=2,a.maxComponentElements=i.readUshort(e,r),r+=2,a.maxComponentDepth=i.readUshort(e,r),r+=2),a},t.name={},t.name.parse=function(e,r,n){var i=t._bin,a={};i.readUshort(e,r),r+=2;var o=i.readUshort(e,r);r+=2,i.readUshort(e,r);for(var s,l=["copyright","fontFamily","fontSubfamily","ID","fullName","version","postScriptName","trademark","manufacturer","designer","description","urlVendor","urlDesigner","licence","licenceURL","---","typoFamilyName","typoSubfamilyName","compatibleFull","sampleText","postScriptCID","wwsFamilyName","wwsSubfamilyName","lightPalette","darkPalette"],c=r+=2,h=0;h<o;h++){var u=i.readUshort(e,r);r+=2;var d=i.readUshort(e,r);r+=2;var p=i.readUshort(e,r);r+=2;var f=i.readUshort(e,r);r+=2;var m=i.readUshort(e,r);r+=2;var g=i.readUshort(e,r);r+=2;var y,v=l[f],b=c+12*o+g;if(0==u)y=i.readUnicode(e,b,m/2);else if(3==u&&0==d)y=i.readUnicode(e,b,m/2);else if(0==d)y=i.readASCII(e,b,m);else if(1==d)y=i.readUnicode(e,b,m/2);else if(3==d)y=i.readUnicode(e,b,m/2);else{if(1!=u)throw"unknown encoding "+d+", platformID: "+u;y=i.readASCII(e,b,m),console.debug("reading unknown MAC encoding "+d+" as ASCII")}var _="p"+u+","+p.toString(16);null==a[_]&&(a[_]={}),a[_][void 0!==v?v:f]=y,a[_]._lang=p}for(var x in a)if(null!=a[x].postScriptName&&1033==a[x]._lang)return a[x];for(var x in a)if(null!=a[x].postScriptName&&0==a[x]._lang)return a[x];for(var x in a)if(null!=a[x].postScriptName&&3084==a[x]._lang)return a[x];for(var x in a)if(null!=a[x].postScriptName)return a[x];for(var x in a){s=x;break}return console.debug("returning name table with languageID "+a[s]._lang),a[s]},t["OS/2"]={},t["OS/2"].parse=function(e,r,n){var i=t._bin.readUshort(e,r);r+=2;var a={};if(0==i)t["OS/2"].version0(e,r,a);else if(1==i)t["OS/2"].version1(e,r,a);else if(2==i||3==i||4==i)t["OS/2"].version2(e,r,a);else{if(5!=i)throw"unknown OS/2 table version: "+i;t["OS/2"].version5(e,r,a)}return a},t["OS/2"].version0=function(e,r,n){var i=t._bin;return n.xAvgCharWidth=i.readShort(e,r),r+=2,n.usWeightClass=i.readUshort(e,r),r+=2,n.usWidthClass=i.readUshort(e,r),r+=2,n.fsType=i.readUshort(e,r),r+=2,n.ySubscriptXSize=i.readShort(e,r),r+=2,n.ySubscriptYSize=i.readShort(e,r),r+=2,n.ySubscriptXOffset=i.readShort(e,r),r+=2,n.ySubscriptYOffset=i.readShort(e,r),r+=2,n.ySuperscriptXSize=i.readShort(e,r),r+=2,n.ySuperscriptYSize=i.readShort(e,r),r+=2,n.ySuperscriptXOffset=i.readShort(e,r),r+=2,n.ySuperscriptYOffset=i.readShort(e,r),r+=2,n.yStrikeoutSize=i.readShort(e,r),r+=2,n.yStrikeoutPosition=i.readShort(e,r),r+=2,n.sFamilyClass=i.readShort(e,r),r+=2,n.panose=i.readBytes(e,r,10),r+=10,n.ulUnicodeRange1=i.readUint(e,r),r+=4,n.ulUnicodeRange2=i.readUint(e,r),r+=4,n.ulUnicodeRange3=i.readUint(e,r),r+=4,n.ulUnicodeRange4=i.readUint(e,r),r+=4,n.achVendID=[i.readInt8(e,r),i.readInt8(e,r+1),i.readInt8(e,r+2),i.readInt8(e,r+3)],r+=4,n.fsSelection=i.readUshort(e,r),r+=2,n.usFirstCharIndex=i.readUshort(e,r),r+=2,n.usLastCharIndex=i.readUshort(e,r),r+=2,n.sTypoAscender=i.readShort(e,r),r+=2,n.sTypoDescender=i.readShort(e,r),r+=2,n.sTypoLineGap=i.readShort(e,r),r+=2,n.usWinAscent=i.readUshort(e,r),r+=2,n.usWinDescent=i.readUshort(e,r),r+2},t["OS/2"].version1=function(e,r,n){var i=t._bin;return r=t["OS/2"].version0(e,r,n),n.ulCodePageRange1=i.readUint(e,r),r+=4,n.ulCodePageRange2=i.readUint(e,r),r+4},t["OS/2"].version2=function(e,r,n){var i=t._bin;return r=t["OS/2"].version1(e,r,n),n.sxHeight=i.readShort(e,r),r+=2,n.sCapHeight=i.readShort(e,r),r+=2,n.usDefault=i.readUshort(e,r),r+=2,n.usBreak=i.readUshort(e,r),r+=2,n.usMaxContext=i.readUshort(e,r),r+2},t["OS/2"].version5=function(e,r,n){var i=t._bin;return r=t["OS/2"].version2(e,r,n),n.usLowerOpticalPointSize=i.readUshort(e,r),r+=2,n.usUpperOpticalPointSize=i.readUshort(e,r),r+2},t.post={},t.post.parse=function(e,r,n){var i=t._bin,a={};return a.version=i.readFixed(e,r),r+=4,a.italicAngle=i.readFixed(e,r),r+=4,a.underlinePosition=i.readShort(e,r),r+=2,a.underlineThickness=i.readShort(e,r),r+=2,a},null==t&&(t={}),null==t.U&&(t.U={}),t.U.codeToGlyph=function(e,t){var r=e.cmap,n=-1;if(null!=r.p0e4?n=r.p0e4:null!=r.p3e1?n=r.p3e1:null!=r.p1e0?n=r.p1e0:null!=r.p0e3&&(n=r.p0e3),-1==n)throw"no familiar platform and encoding!";var i=r.tables[n];if(0==i.format)return t>=i.map.length?0:i.map[t];if(4==i.format){for(var a=-1,o=0;o<i.endCount.length;o++)if(t<=i.endCount[o]){a=o;break}return-1==a||i.startCount[a]>t?0:65535&(0!=i.idRangeOffset[a]?i.glyphIdArray[t-i.startCount[a]+(i.idRangeOffset[a]>>1)-(i.idRangeOffset.length-a)]:t+i.idDelta[a])}if(12==i.format){if(t>i.groups[i.groups.length-1][1])return 0;for(o=0;o<i.groups.length;o++){var s=i.groups[o];if(s[0]<=t&&t<=s[1])return s[2]+(t-s[0])}return 0}throw"unknown cmap table format "+i.format},t.U.glyphToPath=function(e,r){var n={cmds:[],crds:[]};if(e.SVG&&e.SVG.entries[r]){var i=e.SVG.entries[r];return null==i?n:("string"==typeof i&&(i=t.SVG.toPath(i),e.SVG.entries[r]=i),i)}if(e.CFF){var a={x:0,y:0,stack:[],nStems:0,haveWidth:!1,width:e.CFF.Private?e.CFF.Private.defaultWidthX:0,open:!1},o=e.CFF,s=e.CFF.Private;if(o.ROS){for(var l=0;o.FDSelect[l+2]<=r;)l+=2;s=o.FDArray[o.FDSelect[l+1]].Private}t.U._drawCFF(e.CFF.CharStrings[r],a,o,s,n)}else e.glyf&&t.U._drawGlyf(r,e,n);return n},t.U._drawGlyf=function(e,r,n){var i=r.glyf[e];null==i&&(i=r.glyf[e]=t.glyf._parseGlyf(r,e)),null!=i&&(i.noc>-1?t.U._simpleGlyph(i,n):t.U._compoGlyph(i,r,n))},t.U._simpleGlyph=function(e,r){for(var n=0;n<e.noc;n++){for(var i=0==n?0:e.endPts[n-1]+1,a=e.endPts[n],o=i;o<=a;o++){var s=o==i?a:o-1,l=o==a?i:o+1,c=1&e.flags[o],h=1&e.flags[s],u=1&e.flags[l],d=e.xs[o],p=e.ys[o];if(o==i)if(c){if(!h){t.U.P.moveTo(r,d,p);continue}t.U.P.moveTo(r,e.xs[s],e.ys[s])}else h?t.U.P.moveTo(r,e.xs[s],e.ys[s]):t.U.P.moveTo(r,(e.xs[s]+d)/2,(e.ys[s]+p)/2);c?h&&t.U.P.lineTo(r,d,p):u?t.U.P.qcurveTo(r,d,p,e.xs[l],e.ys[l]):t.U.P.qcurveTo(r,d,p,(d+e.xs[l])/2,(p+e.ys[l])/2)}t.U.P.closePath(r)}},t.U._compoGlyph=function(e,r,n){for(var i=0;i<e.parts.length;i++){var a={cmds:[],crds:[]},o=e.parts[i];t.U._drawGlyf(o.glyphIndex,r,a);for(var s=o.m,l=0;l<a.crds.length;l+=2){var c=a.crds[l],h=a.crds[l+1];n.crds.push(c*s.a+h*s.b+s.tx),n.crds.push(c*s.c+h*s.d+s.ty)}for(l=0;l<a.cmds.length;l++)n.cmds.push(a.cmds[l])}},t.U._getGlyphClass=function(e,r){var n=t._lctf.getInterval(r,e);return-1==n?0:r[n+2]},t.U.getPairAdjustment=function(e,r,n){var i=0;if(e.GPOS)for(var a=e.GPOS,o=a.lookupList,s=a.featureList,l=[],c=0;c<s.length;c++){var h=s[c];if("kern"==h.tag)for(var u=0;u<h.tab.length;u++)if(!l[h.tab[u]]){l[h.tab[u]]=!0;for(var d=o[h.tab[u]],p=0;p<d.tabs.length;p++)if(null!=d.tabs[p]){var f,m=d.tabs[p];if(!m.coverage||-1!=(f=t._lctf.coverageIndex(m.coverage,r)))if(1==d.ltype);else if(2==d.ltype){var g;if(1==m.fmt){var y=m.pairsets[f];for(c=0;c<y.length;c++)y[c].gid2==n&&(g=y[c])}else if(2==m.fmt){var v=t.U._getGlyphClass(r,m.classDef1),b=t.U._getGlyphClass(n,m.classDef2);g=m.matrix[v][b]}g&&g.val1&&g.val1[2]&&(i+=g.val1[2]),g&&g.val2&&g.val2[0]&&(i+=g.val2[0])}}}}if(e.kern){var _=e.kern.glyph1.indexOf(r);if(-1!=_){var x=e.kern.rval[_].glyph2.indexOf(n);-1!=x&&(i+=e.kern.rval[_].vals[x])}}return i},t.U._applySubs=function(e,r,n,i){for(var a=e.length-r-1,o=0;o<n.tabs.length;o++)if(null!=n.tabs[o]){var s,l=n.tabs[o];if(!l.coverage||-1!=(s=t._lctf.coverageIndex(l.coverage,e[r])))if(1==n.ltype)e[r],1==l.fmt?e[r]=e[r]+l.delta:e[r]=l.newg[s];else if(4==n.ltype)for(var c=l.vals[s],h=0;h<c.length;h++){var u=c[h],d=u.chain.length;if(!(d>a)){for(var p=!0,f=0,m=0;m<d;m++){for(;-1==e[r+f+(1+m)];)f++;u.chain[m]!=e[r+f+(1+m)]&&(p=!1)}if(p){for(e[r]=u.nglyph,m=0;m<d+f;m++)e[r+m+1]=-1;break}}}else if(5==n.ltype&&2==l.fmt)for(var g=t._lctf.getInterval(l.cDef,e[r]),y=l.cDef[g+2],v=l.scset[y],b=0;b<v.length;b++){var _=v[b],x=_.input;if(!(x.length>a)){for(p=!0,m=0;m<x.length;m++){var w=t._lctf.getInterval(l.cDef,e[r+1+m]);if(-1==g&&l.cDef[w+2]!=x[m]){p=!1;break}}if(p){var S=_.substLookupRecords;for(h=0;h<S.length;h+=2)S[h],S[h+1]}}}else if(6==n.ltype&&3==l.fmt){if(!t.U._glsCovered(e,l.backCvg,r-l.backCvg.length))continue;if(!t.U._glsCovered(e,l.inptCvg,r))continue;if(!t.U._glsCovered(e,l.ahedCvg,r+l.inptCvg.length))continue;var M=l.lookupRec;for(b=0;b<M.length;b+=2){g=M[b];var T=i[M[b+1]];t.U._applySubs(e,r+g,T,i)}}}},t.U._glsCovered=function(e,r,n){for(var i=0;i<r.length;i++)if(-1==t._lctf.coverageIndex(r[i],e[n+i]))return!1;return!0},t.U.glyphsToPath=function(e,r,n){for(var i={cmds:[],crds:[]},a=0,o=0;o<r.length;o++){var s=r[o];if(-1!=s){for(var l=o<r.length-1&&-1!=r[o+1]?r[o+1]:0,c=t.U.glyphToPath(e,s),h=0;h<c.crds.length;h+=2)i.crds.push(c.crds[h]+a),i.crds.push(c.crds[h+1]);for(n&&i.cmds.push(n),h=0;h<c.cmds.length;h++)i.cmds.push(c.cmds[h]);n&&i.cmds.push("X"),a+=e.hmtx.aWidth[s],o<r.length-1&&(a+=t.U.getPairAdjustment(e,s,l))}}return i},t.U.P={},t.U.P.moveTo=function(e,t,r){e.cmds.push("M"),e.crds.push(t,r)},t.U.P.lineTo=function(e,t,r){e.cmds.push("L"),e.crds.push(t,r)},t.U.P.curveTo=function(e,t,r,n,i,a,o){e.cmds.push("C"),e.crds.push(t,r,n,i,a,o)},t.U.P.qcurveTo=function(e,t,r,n,i){e.cmds.push("Q"),e.crds.push(t,r,n,i)},t.U.P.closePath=function(e){e.cmds.push("Z")},t.U._drawCFF=function(e,r,n,i,a){for(var o=r.stack,s=r.nStems,l=r.haveWidth,c=r.width,h=r.open,u=0,d=r.x,p=r.y,f=0,m=0,g=0,y=0,v=0,b=0,_=0,x=0,w=0,S=0,M={val:0,size:0};u<e.length;){t.CFF.getCharString(e,u,M);var T=M.val;if(u+=M.size,"o1"==T||"o18"==T)o.length%2!=0&&!l&&(c=o.shift()+i.nominalWidthX),s+=o.length>>1,o.length=0,l=!0;else if("o3"==T||"o23"==T)o.length%2!=0&&!l&&(c=o.shift()+i.nominalWidthX),s+=o.length>>1,o.length=0,l=!0;else if("o4"==T)o.length>1&&!l&&(c=o.shift()+i.nominalWidthX,l=!0),h&&t.U.P.closePath(a),p+=o.pop(),t.U.P.moveTo(a,d,p),h=!0;else if("o5"==T)for(;o.length>0;)d+=o.shift(),p+=o.shift(),t.U.P.lineTo(a,d,p);else if("o6"==T||"o7"==T)for(var A=o.length,E="o6"==T,C=0;C<A;C++){var L=o.shift();E?d+=L:p+=L,E=!E,t.U.P.lineTo(a,d,p)}else if("o8"==T||"o24"==T){A=o.length;for(var D=0;D+6<=A;)f=d+o.shift(),m=p+o.shift(),g=f+o.shift(),y=m+o.shift(),d=g+o.shift(),p=y+o.shift(),t.U.P.curveTo(a,f,m,g,y,d,p),D+=6;"o24"==T&&(d+=o.shift(),p+=o.shift(),t.U.P.lineTo(a,d,p))}else{if("o11"==T)break;if("o1234"==T||"o1235"==T||"o1236"==T||"o1237"==T)"o1234"==T&&(m=p,g=(f=d+o.shift())+o.shift(),S=y=m+o.shift(),b=y,x=p,d=(_=(v=(w=g+o.shift())+o.shift())+o.shift())+o.shift(),t.U.P.curveTo(a,f,m,g,y,w,S),t.U.P.curveTo(a,v,b,_,x,d,p)),"o1235"==T&&(f=d+o.shift(),m=p+o.shift(),g=f+o.shift(),y=m+o.shift(),w=g+o.shift(),S=y+o.shift(),v=w+o.shift(),b=S+o.shift(),_=v+o.shift(),x=b+o.shift(),d=_+o.shift(),p=x+o.shift(),o.shift(),t.U.P.curveTo(a,f,m,g,y,w,S),t.U.P.curveTo(a,v,b,_,x,d,p)),"o1236"==T&&(f=d+o.shift(),m=p+o.shift(),g=f+o.shift(),S=y=m+o.shift(),b=y,_=(v=(w=g+o.shift())+o.shift())+o.shift(),x=b+o.shift(),d=_+o.shift(),t.U.P.curveTo(a,f,m,g,y,w,S),t.U.P.curveTo(a,v,b,_,x,d,p)),"o1237"==T&&(f=d+o.shift(),m=p+o.shift(),g=f+o.shift(),y=m+o.shift(),w=g+o.shift(),S=y+o.shift(),v=w+o.shift(),b=S+o.shift(),_=v+o.shift(),x=b+o.shift(),Math.abs(_-d)>Math.abs(x-p)?d=_+o.shift():p=x+o.shift(),t.U.P.curveTo(a,f,m,g,y,w,S),t.U.P.curveTo(a,v,b,_,x,d,p));else if("o14"==T){if(o.length>0&&!l&&(c=o.shift()+n.nominalWidthX,l=!0),4==o.length){var R=o.shift(),P=o.shift(),O=o.shift(),I=o.shift(),k=t.CFF.glyphBySE(n,O),B=t.CFF.glyphBySE(n,I);t.U._drawCFF(n.CharStrings[k],r,n,i,a),r.x=R,r.y=P,t.U._drawCFF(n.CharStrings[B],r,n,i,a)}h&&(t.U.P.closePath(a),h=!1)}else if("o19"==T||"o20"==T)o.length%2!=0&&!l&&(c=o.shift()+i.nominalWidthX),s+=o.length>>1,o.length=0,l=!0,u+=s+7>>3;else if("o21"==T)o.length>2&&!l&&(c=o.shift()+i.nominalWidthX,l=!0),p+=o.pop(),d+=o.pop(),h&&t.U.P.closePath(a),t.U.P.moveTo(a,d,p),h=!0;else if("o22"==T)o.length>1&&!l&&(c=o.shift()+i.nominalWidthX,l=!0),d+=o.pop(),h&&t.U.P.closePath(a),t.U.P.moveTo(a,d,p),h=!0;else if("o25"==T){for(;o.length>6;)d+=o.shift(),p+=o.shift(),t.U.P.lineTo(a,d,p);f=d+o.shift(),m=p+o.shift(),g=f+o.shift(),y=m+o.shift(),d=g+o.shift(),p=y+o.shift(),t.U.P.curveTo(a,f,m,g,y,d,p)}else if("o26"==T)for(o.length%2&&(d+=o.shift());o.length>0;)f=d,m=p+o.shift(),d=g=f+o.shift(),p=(y=m+o.shift())+o.shift(),t.U.P.curveTo(a,f,m,g,y,d,p);else if("o27"==T)for(o.length%2&&(p+=o.shift());o.length>0;)m=p,g=(f=d+o.shift())+o.shift(),y=m+o.shift(),d=g+o.shift(),p=y,t.U.P.curveTo(a,f,m,g,y,d,p);else if("o10"==T||"o29"==T){var N="o10"==T?i:n;if(0==o.length)console.debug("error: empty stack");else{var F=o.pop(),U=N.Subrs[F+N.Bias];r.x=d,r.y=p,r.nStems=s,r.haveWidth=l,r.width=c,r.open=h,t.U._drawCFF(U,r,n,i,a),d=r.x,p=r.y,s=r.nStems,l=r.haveWidth,c=r.width,h=r.open}}else if("o30"==T||"o31"==T){var z=o.length,H=(D=0,"o31"==T);for(D+=z-(A=-3&z);D<A;)H?(m=p,g=(f=d+o.shift())+o.shift(),p=(y=m+o.shift())+o.shift(),A-D==5?(d=g+o.shift(),D++):d=g,H=!1):(f=d,m=p+o.shift(),g=f+o.shift(),y=m+o.shift(),d=g+o.shift(),A-D==5?(p=y+o.shift(),D++):p=y,H=!0),t.U.P.curveTo(a,f,m,g,y,d,p),D+=4}else{if("o"==(T+"").charAt(0))throw console.debug("Unknown operation: "+T,e),T;o.push(T)}}}r.x=d,r.y=p,r.nStems=s,r.haveWidth=l,r.width=c,r.open=h};var r=t,n={Typr:r};return e.Typr=r,e.default=n,Object.defineProperty(e,"__esModule",{value:!0}),e}({}).Typr
/*!
  Custom bundle of woff2otf (https://github.com/arty-name/woff2otf) with fflate
  (https://github.com/101arrowz/fflate) for use in Troika text rendering. 
  Original licenses apply: 
  - fflate: https://github.com/101arrowz/fflate/blob/master/LICENSE (MIT)
  - woff2otf.js: https://github.com/arty-name/woff2otf/blob/master/woff2otf.js (Apache2)
  */}function woff2otfFactory(){return function(e){var t=Uint8Array,r=Uint16Array,n=Uint32Array,i=new t([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),a=new t([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),o=new t([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),s=function(e,t){for(var i=new r(31),a=0;a<31;++a)i[a]=t+=1<<e[a-1];var o=new n(i[30]);for(a=1;a<30;++a)for(var s=i[a];s<i[a+1];++s)o[s]=s-i[a]<<5|a;return[i,o]},l=s(i,2),c=l[0],h=l[1];c[28]=258,h[258]=28;for(var u=s(a,0)[0],d=new r(32768),p=0;p<32768;++p){var f=(43690&p)>>>1|(21845&p)<<1;f=(61680&(f=(52428&f)>>>2|(13107&f)<<2))>>>4|(3855&f)<<4,d[p]=((65280&f)>>>8|(255&f)<<8)>>>1}var m=function(e,t,n){for(var i=e.length,a=0,o=new r(t);a<i;++a)++o[e[a]-1];var s,l=new r(t);for(a=0;a<t;++a)l[a]=l[a-1]+o[a-1]<<1;if(n){s=new r(1<<t);var c=15-t;for(a=0;a<i;++a)if(e[a])for(var h=a<<4|e[a],u=t-e[a],p=l[e[a]-1]++<<u,f=p|(1<<u)-1;p<=f;++p)s[d[p]>>>c]=h}else for(s=new r(i),a=0;a<i;++a)s[a]=d[l[e[a]-1]++]>>>15-e[a];return s},g=new t(288);for(p=0;p<144;++p)g[p]=8;for(p=144;p<256;++p)g[p]=9;for(p=256;p<280;++p)g[p]=7;for(p=280;p<288;++p)g[p]=8;var y=new t(32);for(p=0;p<32;++p)y[p]=5;var v=m(g,9,1),b=m(y,5,1),_=function(e){for(var t=e[0],r=1;r<e.length;++r)e[r]>t&&(t=e[r]);return t},x=function(e,t,r){var n=t/8>>0;return(e[n]|e[n+1]<<8)>>>(7&t)&r},w=function(e,t){var r=t/8>>0;return(e[r]|e[r+1]<<8|e[r+2]<<16)>>>(7&t)},S=function(e,s,l){var h=e.length,d=!s||l,p=!l||l.i;l||(l={}),s||(s=new t(3*h));var f,g=function(e){var r=s.length;if(e>r){var n=new t(Math.max(2*r,e));n.set(s),s=n}},y=l.f||0,S=l.p||0,M=l.b||0,T=l.l,A=l.d,E=l.m,C=l.n,L=8*h;do{if(!T){l.f=y=x(e,S,1);var D=x(e,S+1,3);if(S+=3,!D){var R=e[(G=((f=S)/8>>0)+(7&f&&1)+4)-4]|e[G-3]<<8,P=G+R;if(P>h){if(p)throw"unexpected EOF";break}d&&g(M+R),s.set(e.subarray(G,P),M),l.b=M+=R,l.p=S=8*P;continue}if(1==D)T=v,A=b,E=9,C=5;else{if(2!=D)throw"invalid block type";var O=x(e,S,31)+257,I=x(e,S+10,15)+4,k=O+x(e,S+5,31)+1;S+=14;for(var B=new t(k),N=new t(19),F=0;F<I;++F)N[o[F]]=x(e,S+3*F,7);S+=3*I;var U=_(N),z=(1<<U)-1;if(!p&&S+k*(U+7)>L)break;var H=m(N,U,1);for(F=0;F<k;){var G,V=H[x(e,S,z)];if(S+=15&V,(G=V>>>4)<16)B[F++]=G;else{var j=0,W=0;for(16==G?(W=3+x(e,S,3),S+=2,j=B[F-1]):17==G?(W=3+x(e,S,7),S+=3):18==G&&(W=11+x(e,S,127),S+=7);W--;)B[F++]=j}}var Y=B.subarray(0,O),X=B.subarray(O);E=_(Y),C=_(X),T=m(Y,E,1),A=m(X,C,1)}if(S>L)throw"unexpected EOF"}d&&g(M+131072);for(var $=(1<<E)-1,Z=(1<<C)-1,q=E+C+18;p||S+q<L;){var J=(j=T[w(e,S)&$])>>>4;if((S+=15&j)>L)throw"unexpected EOF";if(!j)throw"invalid length/literal";if(J<256)s[M++]=J;else{if(256==J){T=null;break}var Q=J-254;if(J>264){var K=i[F=J-257];Q=x(e,S,(1<<K)-1)+c[F],S+=K}var ee=A[w(e,S)&Z],te=ee>>>4;if(!ee)throw"invalid distance";if(S+=15&ee,X=u[te],te>3&&(K=a[te],X+=w(e,S)&(1<<K)-1,S+=K),S>L)throw"unexpected EOF";d&&g(M+131072);for(var re=M+Q;M<re;M+=4)s[M]=s[M-X],s[M+1]=s[M+1-X],s[M+2]=s[M+2-X],s[M+3]=s[M+3-X];M=re}}l.l=T,l.p=S,l.b=M,T&&(y=1,l.m=E,l.d=A,l.n=C)}while(!y);return M==s.length?s:function(e,i,a){(null==i||i<0)&&(i=0),(null==a||a>e.length)&&(a=e.length);var o=new(e instanceof r?r:e instanceof n?n:t)(a-i);return o.set(e.subarray(i,a)),o}(s,0,M)};return e.convert_streams=function(e){var t=new DataView(e),r=0;function n(){var e=t.getUint16(r);return r+=2,e}function i(){var e=t.getUint32(r);return r+=4,e}function a(e){y.setUint16(v,e),v+=2}function o(e){y.setUint32(v,e),v+=4}for(var s={signature:i(),flavor:i(),length:i(),numTables:n(),reserved:n(),totalSfntSize:i(),majorVersion:n(),minorVersion:n(),metaOffset:i(),metaLength:i(),metaOrigLength:i(),privOffset:i(),privLength:i()},l=0;Math.pow(2,l)<=s.numTables;)l++;l--;for(var c=16*Math.pow(2,l),h=16*s.numTables-c,u=12,d=[],p=0;p<s.numTables;p++)d.push({tag:i(),offset:i(),compLength:i(),origLength:i(),origChecksum:i()}),u+=16;var f,m=new Uint8Array(12+16*d.length+d.reduce((function(e,t){return e+t.origLength+4}),0)),g=m.buffer,y=new DataView(g),v=0;return o(s.flavor),a(s.numTables),a(c),a(l),a(h),d.forEach((function(e){o(e.tag),o(e.origChecksum),o(u),o(e.origLength),e.outOffset=u,(u+=e.origLength)%4!=0&&(u+=4-u%4)})),d.forEach((function(t){var r,n=e.slice(t.offset,t.offset+t.compLength);if(t.compLength!=t.origLength){var i=new Uint8Array(t.origLength);r=new Uint8Array(n,2),S(r,i)}else i=new Uint8Array(n);m.set(i,t.outOffset);var a=0;(u=t.outOffset+t.origLength)%4!=0&&(a=4-u%4),m.set(new Uint8Array(a).buffer,t.outOffset+t.origLength),f=u+a})),g.slice(0,f)},e}({}).convert_streams}function parserFactory(e,t){const r={M:2,L:2,Q:4,C:6,Z:0},n={C:"18g,ca,368,1kz",D:"17k,6,2,2+4,5+c,2+6,2+1,10+1,9+f,j+11,2+1,a,2,2+1,15+2,3,j+2,6+3,2+8,2,2,2+1,w+a,4+e,3+3,2,3+2,3+5,23+w,2f+4,3,2+9,2,b,2+3,3,1k+9,6+1,3+1,2+2,2+d,30g,p+y,1,1+1g,f+x,2,sd2+1d,jf3+4,f+3,2+4,2+2,b+3,42,2,4+2,2+1,2,3,t+1,9f+w,2,el+2,2+g,d+2,2l,2+1,5,3+1,2+1,2,3,6,16wm+1v",R:"17m+3,2,2,6+3,m,15+2,2+2,h+h,13,3+8,2,2,3+1,2,p+1,x,5+4,5,a,2,2,3,u,c+2,g+1,5,2+1,4+1,5j,6+1,2,b,2+2,f,2+1,1s+2,2,3+1,7,1ez0,2,2+1,4+4,b,4,3,b,42,2+2,4,3,2+1,2,o+3,ae,ep,x,2o+2,3+1,3,5+1,6",L:"x9u,jff,a,fd,jv",T:"4t,gj+33,7o+4,1+1,7c+18,2,2+1,2+1,2,21+a,2,1b+k,h,2u+6,3+5,3+1,2+3,y,2,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,3,7,6+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+d,1,1+1,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,ek,3+1,r+4,1e+4,6+5,2p+c,1+3,1,1+2,1+b,2db+2,3y,2p+v,ff+3,30+1,n9x,1+2,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,5s,6y+2,ea,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+9,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2,2b+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,470+8,at4+4,1o+6,t5,1s+3,2a,f5l+1,2+3,43o+2,a+7,1+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,1,gzau,v+2n,3l+6n"};let i;function a(e){if(!i){const e={R:2,L:1,D:4,C:16,U:32,T:8};i=new Map;for(let t in n){let r=0;n[t].split(",").forEach((n=>{let[a,o]=n.split("+");a=parseInt(a,36),o=o?parseInt(o,36):0,i.set(r+=a,e[t]);for(let n=o;n--;)i.set(++r,e[t])}))}}return i.get(e)||32}const o=[null,"isol","init","fina","medi"];function s(e){const t=new Uint8Array(e.length);let r=32,n=1,i=-1;for(let o=0;o<e.length;o++){const s=e.codePointAt(o);let l=0|a(s),c=1;8&l||(21&r?22&l?(c=3,1!==n&&3!==n||t[i]++):33&l&&(2!==n&&4!==n||t[i]--):34&r&&(2!==n&&4!==n||t[i]--),n=t[o]=c,r=l,i=o,s>65535&&o++)}return t}function l(t){const n=Object.create(null),i={unitsPerEm:t.head.unitsPerEm,ascender:t.hhea.ascender,descender:t.hhea.descender,forEachGlyph(a,l,c,h){let u=0;const d=1/i.unitsPerEm*l,p=function(t,r){const n=[];for(let i=0;i<r.length;i++){const a=r.codePointAt(i);a>65535&&i++,n.push(e.U.codeToGlyph(t,a))}const i=t.GSUB;if(i){const{lookupList:t,featureList:a}=i;let l;const c=/^(rlig|liga|mset|isol|init|fina|medi|half|pres|blws)$/,h=[];a.forEach((i=>{if(c.test(i.tag))for(let a=0;a<i.tab.length;a++){if(h[i.tab[a]])continue;h[i.tab[a]]=!0;const c=t[i.tab[a]],u=/^(isol|init|fina|medi)$/.test(i.tag);u&&!l&&(l=s(r));for(let r=0;r<n.length;r++)l&&u&&o[l[r]]!==i.tag||e.U._applySubs(n,r,c,t)}}))}return n}(t,a);let f=0,m=-1;return p.forEach(((i,o)=>{if(-1!==i){let a=n[i];if(!a){const{cmds:o,crds:s}=e.U.glyphToPath(t,i);let l,c,h,u;if(s.length){l=c=1/0,h=u=-1/0;for(let e=0,t=s.length;e<t;e+=2){let t=s[e],r=s[e+1];t<l&&(l=t),r<c&&(c=r),t>h&&(h=t),r>u&&(u=r)}}else l=h=c=u=0;a=n[i]={index:i,advanceWidth:t.hmtx.aWidth[i],xMin:l,yMin:c,xMax:h,yMax:u,pathCommandCount:o.length,forEachPathCommand(e){let t=0;const n=[];for(let i=0,a=o.length;i<a;i++){const a=r[o[i]];n.length=1+a,n[0]=o[i];for(let e=1;e<=a;e++)n[e]=s[t++];e.apply(null,n)}}}}-1!==m&&(u+=e.U.getPairAdjustment(t,m,i)*d),h.call(null,a,u,f),a.advanceWidth&&(u+=a.advanceWidth*d),c&&(u+=c*l),m=i}f+=a.codePointAt(f)>65535?2:1})),u}};return i}return function(r){const n=new Uint8Array(r,0,4),i=e._bin.readASCII(n,0,4);if("wOFF"===i)r=t(r);else if("wOF2"===i)throw new Error("woff2 fonts not supported");return l(e.parse(r)[0])}}const workerModule=defineWorkerModule({name:"Typr Font Parser",dependencies:[typrFactory,woff2otfFactory,parserFactory],init:(e,t,r)=>r(e(),t())}),CONFIG={defaultFontURL:"https://fonts.gstatic.com/s/roboto/v18/KFOmCnqEu92Fr1Mu4mxM.woff",sdfGlyphSize:64,sdfMargin:1/16,sdfExponent:9,textureWidth:2048},tempColor=new Color,atlases=Object.create(null);function getTextRenderInfo(e,t){if((e=assign({},e)).font=toAbsoluteURL(e.font||CONFIG.defaultFontURL),e.text=""+e.text,e.sdfGlyphSize=e.sdfGlyphSize||CONFIG.sdfGlyphSize,null!=e.colorRanges){let t={};for(let r in e.colorRanges)if(e.colorRanges.hasOwnProperty(r)){let n=e.colorRanges[r];"number"!=typeof n&&(n=tempColor.set(n).getHex()),t[r]=n}e.colorRanges=t}Object.freeze(e);const{textureWidth:r,sdfExponent:n}=CONFIG,{sdfGlyphSize:i}=e;let a=`${e.font}@${i}`,o=atlases[a];o||(o=atlases[a]={sdfTexture:new DataTexture(new Uint8Array(i*r*4),r,i,RGBAFormat,void 0,void 0,void 0,void 0,LinearFilter,LinearFilter)},o.sdfTexture.font=e.font),processInWorker(e).then((r=>{r.newGlyphSDFs&&(r.newGlyphSDFs.forEach((({textureData:e,atlasIndex:t})=>{const r=o.sdfTexture.image;for(;r.data.length<(t+1)*i*i;){const e=new Uint8Array(2*r.data.length);e.set(r.data),r.data=e,r.height*=2}const n=Math.floor(t/4),a=r.width/i,s=Math.floor(n/a)*r.width*i*4+n%a*i*4+t%4;for(let t=0;t<i;t++){const n=t*i,a=s+t*r.width*4;for(let t=0;t<i;t++)r.data[a+4*t]=e[n+t]}})),o.sdfTexture.needsUpdate=!0),t(Object.freeze({parameters:e,sdfTexture:o.sdfTexture,sdfGlyphSize:i,sdfExponent:n,glyphBounds:r.glyphBounds,glyphAtlasIndices:r.glyphAtlasIndices,glyphColors:r.glyphColors,caretPositions:r.caretPositions,caretHeight:r.caretHeight,chunkedBounds:r.chunkedBounds,ascender:r.ascender,descender:r.descender,lineHeight:r.lineHeight,topBaseline:r.topBaseline,blockBounds:r.blockBounds,visibleBounds:r.visibleBounds,timings:r.timings,get totalBounds(){return console.log("totalBounds deprecated, use blockBounds instead"),r.blockBounds},get totalBlockSize(){console.log("totalBlockSize deprecated, use blockBounds instead");const[e,t,n,i]=r.blockBounds;return[n-e,i-t]}}))}))}function assign(e,t){for(let r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);return e}let linkEl;function toAbsoluteURL(e){return linkEl||(linkEl="undefined"==typeof document?{}:document.createElement("a")),linkEl.href=e,linkEl.href}const fontProcessorWorkerModule=defineWorkerModule({name:"FontProcessor",dependencies:[CONFIG,workerModule,createGlyphSegmentsIndex,createSDFGenerator,createFontProcessor,bidiFactory],init(e,t,r,n,i,a){const{sdfExponent:o,sdfMargin:s,defaultFontURL:l}=e;return i(t,n(r,{sdfExponent:o,sdfMargin:s}),a(),{defaultFontURL:l})}}),processInWorker=defineWorkerModule({name:"TextBuilder",dependencies:[fontProcessorWorkerModule,ThenableWorkerModule],init:(e,t)=>function(r){const n=new t;return e.process(r,n.resolve),n},getTransferables(e){const t=[e.glyphBounds.buffer,e.glyphAtlasIndices.buffer];return e.caretPositions&&t.push(e.caretPositions.buffer),e.newGlyphSDFs&&e.newGlyphSDFs.forEach((e=>{t.push(e.textureData.buffer)})),t}}),GlyphsGeometry=(()=>{const e={};const t="aTroikaGlyphIndex";class r extends InstancedBufferGeometry{constructor(){super(),this.detail=1,this.curveRadius=0,this.groups=[{start:0,count:1/0,materialIndex:0},{start:0,count:1/0,materialIndex:1}],this.boundingSphere=new Sphere,this.boundingBox=new Box3}computeBoundingSphere(){}computeBoundingBox(){}set detail(t){if(t!==this._detail){this._detail=t,("number"!=typeof t||t<1)&&(t=1);let r=function(t){let r=e[t];return r||(r=e[t]=new PlaneGeometry(1,1,t,t).translate(.5,.5,0)),r}(t);["position","normal","uv"].forEach((e=>{this.attributes[e]=r.attributes[e].clone()})),this.setIndex(r.getIndex().clone())}}get detail(){return this._detail}set curveRadius(e){e!==this._curveRadius&&(this._curveRadius=e,this._updateBounds())}get curveRadius(){return this._curveRadius}updateGlyphs(e,r,a,o,s){n(this,"aTroikaGlyphBounds",e,4),n(this,t,r,1),n(this,"aTroikaGlyphColor",s,3),this._blockBounds=a,this._chunkedBounds=o,i(this,r.length),this._updateBounds()}_updateBounds(){const e=this._blockBounds;if(e){const{curveRadius:t,boundingBox:r}=this;if(t){const{PI:n,floor:i,min:a,max:o,sin:s,cos:l}=Math,c=n/2,h=2*n,u=Math.abs(t),d=e[0]/u,p=e[2]/u,f=i((d+c)/h)!==i((p+c)/h)?-u:a(s(d)*u,s(p)*u),m=i((d-c)/h)!==i((p-c)/h)?u:o(s(d)*u,s(p)*u),g=i((d+n)/h)!==i((p+n)/h)?2*u:o(u-l(d)*u,u-l(p)*u);r.min.set(f,e[1],t<0?-g:0),r.max.set(m,e[3],t<0?0:g)}else r.min.set(e[0],e[1],0),r.max.set(e[2],e[3],0);r.getBoundingSphere(this.boundingSphere)}}applyClipRect(e){let r=this.getAttribute(t).count,n=this._chunkedBounds;if(n)for(let t=n.length;t--;){r=n[t].end;let i=n[t].rect;if(i[1]<e.w&&i[3]>e.y&&i[0]<e.z&&i[2]>e.x)break}i(this,r)}}function n(e,t,r,n){const i=e.getAttribute(t);r?i&&i.array.length===r.length?(i.array.set(r),i.needsUpdate=!0):(e.setAttribute(t,new InstancedBufferAttribute(r,n)),delete e._maxInstanceCount,e.dispose()):i&&e.deleteAttribute(t)}function i(e,t){e[e.hasOwnProperty("instanceCount")?"instanceCount":"maxInstancedCount"]=t}return r.prototype.setAttribute||(r.prototype.setAttribute=function(e,t){return this.attributes[e]=t,this}),r})(),VERTEX_DEFS="\nuniform vec2 uTroikaSDFTextureSize;\nuniform float uTroikaSDFGlyphSize;\nuniform vec4 uTroikaTotalBounds;\nuniform vec4 uTroikaClipRect;\nuniform mat3 uTroikaOrient;\nuniform bool uTroikaUseGlyphColors;\nuniform float uTroikaDistanceOffset;\nuniform float uTroikaBlurRadius;\nuniform vec2 uTroikaPositionOffset;\nuniform float uTroikaCurveRadius;\nattribute vec4 aTroikaGlyphBounds;\nattribute float aTroikaGlyphIndex;\nattribute vec3 aTroikaGlyphColor;\nvarying vec2 vTroikaGlyphUV;\nvarying vec4 vTroikaTextureUVBounds;\nvarying float vTroikaTextureChannel;\nvarying vec3 vTroikaGlyphColor;\nvarying vec2 vTroikaGlyphDimensions;\n",VERTEX_TRANSFORM="\nvec4 bounds = aTroikaGlyphBounds;\nbounds.xz += uTroikaPositionOffset.x;\nbounds.yw -= uTroikaPositionOffset.y;\n\nvec4 outlineBounds = vec4(\n  bounds.xy - uTroikaDistanceOffset - uTroikaBlurRadius,\n  bounds.zw + uTroikaDistanceOffset + uTroikaBlurRadius\n);\nvec4 clippedBounds = vec4(\n  clamp(outlineBounds.xy, uTroikaClipRect.xy, uTroikaClipRect.zw),\n  clamp(outlineBounds.zw, uTroikaClipRect.xy, uTroikaClipRect.zw)\n);\n\nvec2 clippedXY = (mix(clippedBounds.xy, clippedBounds.zw, position.xy) - bounds.xy) / (bounds.zw - bounds.xy);\n\nposition.xy = mix(bounds.xy, bounds.zw, clippedXY);\n\nuv = (position.xy - uTroikaTotalBounds.xy) / (uTroikaTotalBounds.zw - uTroikaTotalBounds.xy);\n\nfloat rad = uTroikaCurveRadius;\nif (rad != 0.0) {\n  float angle = position.x / rad;\n  position.xz = vec2(sin(angle) * rad, rad - cos(angle) * rad);\n  normal.xz = vec2(sin(angle), cos(angle));\n}\n  \nposition = uTroikaOrient * position;\nnormal = uTroikaOrient * normal;\n\nvTroikaGlyphUV = clippedXY.xy;\nvTroikaGlyphDimensions = vec2(bounds[2] - bounds[0], bounds[3] - bounds[1]);\n\n\nfloat txCols = uTroikaSDFTextureSize.x / uTroikaSDFGlyphSize;\nvec2 txUvPerSquare = uTroikaSDFGlyphSize / uTroikaSDFTextureSize;\nvec2 txStartUV = txUvPerSquare * vec2(\n  mod(floor(aTroikaGlyphIndex / 4.0), txCols),\n  floor(floor(aTroikaGlyphIndex / 4.0) / txCols)\n);\nvTroikaTextureUVBounds = vec4(txStartUV, vec2(txStartUV) + txUvPerSquare);\nvTroikaTextureChannel = mod(aTroikaGlyphIndex, 4.0);\n",FRAGMENT_DEFS="\nuniform sampler2D uTroikaSDFTexture;\nuniform vec2 uTroikaSDFTextureSize;\nuniform float uTroikaSDFGlyphSize;\nuniform float uTroikaSDFExponent;\nuniform float uTroikaDistanceOffset;\nuniform float uTroikaFillOpacity;\nuniform float uTroikaOutlineOpacity;\nuniform float uTroikaBlurRadius;\nuniform vec3 uTroikaStrokeColor;\nuniform float uTroikaStrokeWidth;\nuniform float uTroikaStrokeOpacity;\nuniform bool uTroikaSDFDebug;\nvarying vec2 vTroikaGlyphUV;\nvarying vec4 vTroikaTextureUVBounds;\nvarying float vTroikaTextureChannel;\nvarying vec2 vTroikaGlyphDimensions;\n\nfloat troikaSdfValueToSignedDistance(float alpha) {\n  // Inverse of encoding in SDFGenerator.js\n  \n  float maxDimension = max(vTroikaGlyphDimensions.x, vTroikaGlyphDimensions.y);\n  float absDist = (1.0 - pow(2.0 * (alpha > 0.5 ? 1.0 - alpha : alpha), 1.0 / uTroikaSDFExponent)) * maxDimension;\n  float signedDist = absDist * (alpha > 0.5 ? -1.0 : 1.0);\n  return signedDist;\n}\n\nfloat troikaGlyphUvToSdfValue(vec2 glyphUV) {\n  vec2 textureUV = mix(vTroikaTextureUVBounds.xy, vTroikaTextureUVBounds.zw, glyphUV);\n  vec4 rgba = texture2D(uTroikaSDFTexture, textureUV);\n  float ch = floor(vTroikaTextureChannel + 0.5); //NOTE: can't use round() in WebGL1\n  return ch == 0.0 ? rgba.r : ch == 1.0 ? rgba.g : ch == 2.0 ? rgba.b : rgba.a;\n}\n\nfloat troikaGlyphUvToDistance(vec2 uv) {\n  return troikaSdfValueToSignedDistance(troikaGlyphUvToSdfValue(uv));\n}\n\nfloat troikaGetAADist() {\n  \n  #if defined(GL_OES_standard_derivatives) || __VERSION__ >= 300\n  return length(fwidth(vTroikaGlyphUV * vTroikaGlyphDimensions)) * 0.5;\n  #else\n  return vTroikaGlyphDimensions.x / 64.0;\n  #endif\n}\n\nfloat troikaGetFragDistValue() {\n  vec2 clampedGlyphUV = clamp(vTroikaGlyphUV, 0.5 / uTroikaSDFGlyphSize, 1.0 - 0.5 / uTroikaSDFGlyphSize);\n  float distance = troikaGlyphUvToDistance(clampedGlyphUV);\n \n  // Extrapolate distance when outside bounds:\n  distance += clampedGlyphUV == vTroikaGlyphUV ? 0.0 : \n    length((vTroikaGlyphUV - clampedGlyphUV) * vTroikaGlyphDimensions);\n\n  \n\n  return distance;\n}\n\nfloat troikaGetEdgeAlpha(float distance, float distanceOffset, float aaDist) {\n  #if defined(IS_DEPTH_MATERIAL) || defined(IS_DISTANCE_MATERIAL)\n  float alpha = step(-distanceOffset, -distance);\n  #else\n\n  float alpha = smoothstep(\n    distanceOffset + aaDist,\n    distanceOffset - aaDist,\n    distance\n  );\n  #endif\n\n  return alpha;\n}\n",FRAGMENT_TRANSFORM="\nfloat aaDist = troikaGetAADist();\nfloat distance = troikaGetFragDistValue();\nfloat edgeAlpha = uTroikaSDFDebug ?\n  troikaGlyphUvToSdfValue(vTroikaGlyphUV) :\n  troikaGetEdgeAlpha(distance, uTroikaDistanceOffset, max(aaDist, uTroikaBlurRadius));\n\n#if !defined(IS_DEPTH_MATERIAL) && !defined(IS_DISTANCE_MATERIAL)\nvec4 fillRGBA = gl_FragColor;\nfillRGBA.a *= uTroikaFillOpacity;\nvec4 strokeRGBA = uTroikaStrokeWidth == 0.0 ? fillRGBA : vec4(uTroikaStrokeColor, uTroikaStrokeOpacity);\nif (fillRGBA.a == 0.0) fillRGBA.rgb = strokeRGBA.rgb;\ngl_FragColor = mix(fillRGBA, strokeRGBA, smoothstep(\n  -uTroikaStrokeWidth - aaDist,\n  -uTroikaStrokeWidth + aaDist,\n  distance\n));\ngl_FragColor.a *= edgeAlpha;\n#endif\n\nif (edgeAlpha == 0.0) {\n  discard;\n}\n";function createTextDerivedMaterial(e){const t=createDerivedMaterial(e,{chained:!0,extensions:{derivatives:!0},uniforms:{uTroikaSDFTexture:{value:null},uTroikaSDFTextureSize:{value:new Vector2},uTroikaSDFGlyphSize:{value:0},uTroikaSDFExponent:{value:0},uTroikaTotalBounds:{value:new Vector4(0,0,0,0)},uTroikaClipRect:{value:new Vector4(0,0,0,0)},uTroikaDistanceOffset:{value:0},uTroikaOutlineOpacity:{value:0},uTroikaFillOpacity:{value:1},uTroikaPositionOffset:{value:new Vector2},uTroikaCurveRadius:{value:0},uTroikaBlurRadius:{value:0},uTroikaStrokeWidth:{value:0},uTroikaStrokeColor:{value:new Color},uTroikaStrokeOpacity:{value:1},uTroikaOrient:{value:new Matrix3},uTroikaUseGlyphColors:{value:!0},uTroikaSDFDebug:{value:!1}},vertexDefs:VERTEX_DEFS,vertexTransform:VERTEX_TRANSFORM,fragmentDefs:FRAGMENT_DEFS,fragmentColorTransform:FRAGMENT_TRANSFORM,customRewriter({vertexShader:e,fragmentShader:t}){let r=/\buniform\s+vec3\s+diffuse\b/;return r.test(t)&&(t=t.replace(r,"varying vec3 vTroikaGlyphColor").replace(/\bdiffuse\b/g,"vTroikaGlyphColor"),r.test(e)||(e=e.replace(voidMainRegExp,"uniform vec3 diffuse;\n$&\nvTroikaGlyphColor = uTroikaUseGlyphColors ? aTroikaGlyphColor / 255.0 : diffuse;\n"))),{vertexShader:e,fragmentShader:t}}});return t.transparent=!0,Object.defineProperties(t,{isTroikaTextMaterial:{value:!0},shadowSide:{get(){return this.side},set(){}}}),t}const Text=(()=>{const e=new MeshBasicMaterial({color:16777215,side:DoubleSide,transparent:!0}),t=8421504,r=new Matrix4,n=new Vector3,i=new Vector3,a=[],o=new Vector3,s="+x+y";function l(e){return Array.isArray(e)?e[0]:e}let c=()=>{const t=new Mesh(new PlaneGeometry(1,1),e);return c=()=>t,t},h=()=>{const t=new Mesh(new PlaneGeometry(1,1,32,1),e);return h=()=>t,t};const u={type:"syncstart"},d={type:"synccomplete"},p=["font","fontSize","letterSpacing","lineHeight","maxWidth","overflowWrap","text","direction","textAlign","textIndent","whiteSpace","anchorX","anchorY","colorRanges","sdfGlyphSize"],f=p.concat("material","color","depthOffset","clipRect","curveRadius","orientation","glyphGeometryDetail");class m extends Mesh{constructor(){super(new GlyphsGeometry,null),this.text="",this.anchorX=0,this.anchorY=0,this.curveRadius=0,this.direction="auto",this.font=null,this.fontSize=.1,this.letterSpacing=0,this.lineHeight="normal",this.maxWidth=1/0,this.overflowWrap="normal",this.textAlign="left",this.textIndent=0,this.whiteSpace="normal",this.material=null,this.color=null,this.colorRanges=null,this.outlineWidth=0,this.outlineColor=0,this.outlineOpacity=1,this.outlineBlur=0,this.outlineOffsetX=0,this.outlineOffsetY=0,this.strokeWidth=0,this.strokeColor=t,this.strokeOpacity=1,this.fillOpacity=1,this.depthOffset=0,this.clipRect=null,this.orientation=s,this.glyphGeometryDetail=1,this.sdfGlyphSize=null,this.debugSDF=!1}sync(e){this._needsSync&&(this._needsSync=!1,this._isSyncing?(this._queuedSyncs||(this._queuedSyncs=[])).push(e):(this._isSyncing=!0,this.dispatchEvent(u),getTextRenderInfo({text:this.text,font:this.font,fontSize:this.fontSize||.1,letterSpacing:this.letterSpacing||0,lineHeight:this.lineHeight||"normal",maxWidth:this.maxWidth,direction:this.direction||"auto",textAlign:this.textAlign,textIndent:this.textIndent,whiteSpace:this.whiteSpace,overflowWrap:this.overflowWrap,anchorX:this.anchorX,anchorY:this.anchorY,colorRanges:this.colorRanges,includeCaretPositions:!0,sdfGlyphSize:this.sdfGlyphSize},(t=>{this._isSyncing=!1,this._textRenderInfo=t,this.geometry.updateGlyphs(t.glyphBounds,t.glyphAtlasIndices,t.blockBounds,t.chunkedBounds,t.glyphColors);const r=this._queuedSyncs;r&&(this._queuedSyncs=null,this._needsSync=!0,this.sync((()=>{r.forEach((e=>e&&e()))}))),this.dispatchEvent(d),e&&e()}))))}onBeforeRender(e,t,r,n,i,a){this.sync(),i.isTroikaTextMaterial&&this._prepareForRender(i)}dispose(){this.geometry.dispose()}get textRenderInfo(){return this._textRenderInfo||null}get material(){let t=this._derivedMaterial;const r=this._baseMaterial||this._defaultMaterial||(this._defaultMaterial=e.clone());if(t&&t.baseMaterial===r||(t=this._derivedMaterial=createTextDerivedMaterial(r),r.addEventListener("dispose",(function e(){r.removeEventListener("dispose",e),t.dispose()}))),this.outlineWidth||this.outlineBlur||this.outlineOffsetX||this.outlineOffsetY){let e=t._outlineMtl;return e||(e=t._outlineMtl=Object.create(t,{id:{value:t.id+.1}}),e.isTextOutlineMaterial=!0,e.depthWrite=!1,e.map=null,t.addEventListener("dispose",(function r(){t.removeEventListener("dispose",r),e.dispose()}))),[e,t]}return t}set material(e){e&&e.isTroikaTextMaterial?(this._derivedMaterial=e,this._baseMaterial=e.baseMaterial):this._baseMaterial=e}get glyphGeometryDetail(){return this.geometry.detail}set glyphGeometryDetail(e){this.geometry.detail=e}get curveRadius(){return this.geometry.curveRadius}set curveRadius(e){this.geometry.curveRadius=e}get customDepthMaterial(){return l(this.material).getDepthMaterial()}get customDistanceMaterial(){return l(this.material).getDistanceMaterial()}_prepareForRender(e){const a=e.isTextOutlineMaterial,l=e.uniforms,c=this.textRenderInfo;if(c){const{sdfTexture:e,blockBounds:r}=c;l.uTroikaSDFTexture.value=e,l.uTroikaSDFTextureSize.value.set(e.image.width,e.image.height),l.uTroikaSDFGlyphSize.value=c.sdfGlyphSize,l.uTroikaSDFExponent.value=c.sdfExponent,l.uTroikaTotalBounds.value.fromArray(r),l.uTroikaUseGlyphColors.value=!a&&!!c.glyphColors;let n,i,o,s=0,h=0,u=0,d=0,p=0;if(a){let{outlineWidth:e,outlineOffsetX:t,outlineOffsetY:r,outlineBlur:i,outlineOpacity:a}=this;s=this._parsePercent(e)||0,h=Math.max(0,this._parsePercent(i)||0),n=a,d=this._parsePercent(t)||0,p=this._parsePercent(r)||0}else u=Math.max(0,this._parsePercent(this.strokeWidth)||0),u&&(o=this.strokeColor,l.uTroikaStrokeColor.value.set(null==o?t:o),i=this.strokeOpacity,null==i&&(i=1)),n=this.fillOpacity;l.uTroikaDistanceOffset.value=s,l.uTroikaPositionOffset.value.set(d,p),l.uTroikaBlurRadius.value=h,l.uTroikaStrokeWidth.value=u,l.uTroikaStrokeOpacity.value=i,l.uTroikaFillOpacity.value=null==n?1:n,l.uTroikaCurveRadius.value=this.curveRadius||0;let f=this.clipRect;if(f&&Array.isArray(f)&&4===f.length)l.uTroikaClipRect.value.fromArray(f);else{const e=100*(this.fontSize||.1);l.uTroikaClipRect.value.set(r[0]-e,r[1]-e,r[2]+e,r[3]+e)}this.geometry.applyClipRect(l.uTroikaClipRect.value)}l.uTroikaSDFDebug.value=!!this.debugSDF,e.polygonOffset=!!this.depthOffset,e.polygonOffsetFactor=e.polygonOffsetUnits=this.depthOffset||0;const h=a?this.outlineColor||0:this.color;if(null==h)delete e.color;else{const t=e.hasOwnProperty("color")?e.color:e.color=new Color;h===t._input&&"object"!=typeof h||t.set(t._input=h)}let u=this.orientation||s;if(u!==e._orientation){let t=l.uTroikaOrient.value;u=u.replace(/[^-+xyz]/g,"");let a=u!==s&&u.match(/^([-+])([xyz])([-+])([xyz])$/);if(a){let[,e,s,l,c]=a;n.set(0,0,0)[s]="-"===e?1:-1,i.set(0,0,0)[c]="-"===l?-1:1,r.lookAt(o,n.cross(i),i),t.setFromMatrix4(r)}else t.identity();e._orientation=u}}_parsePercent(e){if("string"==typeof e){let t=e.match(/^(-?[\d.]+)%$/),r=t?parseFloat(t[1]):NaN;e=(isNaN(r)?0:r/100)*this.fontSize}return e}localPositionToTextCoords(e,t=new Vector2){t.copy(e);const r=this.curveRadius;return r&&(t.x=Math.atan2(e.x,Math.abs(r)-Math.abs(e.z))*Math.abs(r)),t}worldPositionToTextCoords(e,t=new Vector2){return n.copy(e),this.localPositionToTextCoords(this.worldToLocal(n),t)}raycast(e,t){const{textRenderInfo:r,curveRadius:n}=this;if(r){const i=r.blockBounds,o=n?h():c(),s=o.geometry,{position:l,uv:u}=s.attributes;for(let e=0;e<u.count;e++){let t=i[0]+u.getX(e)*(i[2]-i[0]);const r=i[1]+u.getY(e)*(i[3]-i[1]);let a=0;n&&(a=n-Math.cos(t/n)*n,t=Math.sin(t/n)*n),l.setXYZ(e,t,r,a)}s.boundingSphere=this.geometry.boundingSphere,s.boundingBox=this.geometry.boundingBox,o.matrixWorld=this.matrixWorld,o.material.side=this.material.side,a.length=0,o.raycast(e,a);for(let e=0;e<a.length;e++)a[e].object=this,t.push(a[e])}}copy(e){const t=this.geometry;return super.copy(e),this.geometry=t,f.forEach((t=>{this[t]=e[t]})),this}clone(){return(new this.constructor).copy(this)}}p.forEach((e=>{const t="_private_"+e;Object.defineProperty(m.prototype,e,{get(){return this[t]},set(e){e!==this[t]&&(this[t]=e,this._needsSync=!0)}})}));let g=!1;return Object.defineProperty(m.prototype,"anchor",{get(){return this._deprecated_anchor},set(e){this._deprecated_anchor=e,g||(console.warn("TextMesh: `anchor` has been deprecated; use `anchorX` and `anchorY` instead."),g=!0),Array.isArray(e)?(this.anchorX=100*(+e[0]||0)+"%",this.anchorY=100*(+e[1]||0)+"%"):this.anchorX=this.anchorY=0}}),m})();class AreaGeometry extends BufferGeometry{constructor(e=[],t=1,r=1,n=!1,i){super(),this.type="AreaGeometry",this.faceType=i,this.parameters={points:e,height:t,steps:r,openEnded:n};const a=this;t=Math.floor(t),r=Math.floor(r);const o=e.length;let s=[0],l=0;this.min={x:1/0,y:1/0},this.max={x:-1/0,y:-1/0};for(let t=1;t<e.length;t++){e[t].x>this.max.x&&(this.max.x=e[t].x),e[t].x<this.min.x&&(this.min.x=e[t].x),e[t].y>this.max.y&&(this.max.y=e[t].y),e[t].y<this.min.y&&(this.min.y=e[t].y);let r=Math.sqrt((e[t].x-e[t-1].x)*(e[t].x-e[t-1].x)+(e[t].y-e[t-1].y)*(e[t].y-e[t-1].y));l+=r,s.push(l)}if(this.max.x===this.min.x||this.max.y===this.min.y)return;this.center={x:(this.max.x-this.min.x)/2+this.min.x,y:(this.max.y-this.min.y)/2+this.min.y},this.sideWallSegments=l/t;const c=[],h=[],u=[],d=[];let p=0;const f=[];let m=0;!function(){const n=new Vector3,i=new Vector3;let g=0;for(let a=0;a<=r;a++){const c=[],m=a/r;for(let r=0;r<o;r++)i.x=e[r].x,i.y=m*t,i.z=-e[r].y,h.push(i.x,i.y,i.z),n.set(i.x,0,i.z).normalize(),u.push(n.x,n.y,n.z),d.push(s[r]/l,1-m),c.push(p++);f.push(c)}for(let e=0;e<o;e++)for(let t=0;t<r;t++){const r=f[t][e],n=f[t+1][e],i=f[t+1][e+1],a=f[t][e+1];c.push(r,n,a),c.push(n,i,a),g+=6}a.addGroup(m,g,0),m+=g}();const g=[];let y=new Shape;y.setFromPoints(e);const v=y.extractPoints(12);let b=v.shape;const _=v.holes;if(!ShapeUtils.isClockWise(b)){b=b.reverse();for(let e=0,t=_.length;e<t;e++){const t=_[e];ShapeUtils.isClockWise(t)&&(_[e]=t.reverse())}}const x=ShapeUtils.triangulateShape(b,_);for(let e=0,t=_.length;e<t;e++){const t=_[e];b=b.concat(t)}const w=b.length,S=x.length;for(let e=0;e<w;e++){const r=b[e];M(r.x,r.y,t)}for(let e=0;e<w;e++){const t=b[e];M(t.x,t.y,0)}function M(e,t,r){g.push(e),g.push(t),g.push(r)}function T(e,t,r){A(e),A(t),A(r)}function A(e){h.push(g[3*e+0]),h.push(g[3*e+2]),h.push(-g[3*e+1]),u.push(0,g[3*e+2]>0?1:-1,0);let t=new Vector2;var r;t.x=(g[3*e+0]-a.min.x)/(a.max.x-a.min.x),t.y=(g[3*e+1]-a.min.y)/(a.max.y-a.min.y),r=t,d.push(r.x),d.push(r.y),c.push(p),p++}!function(e){if(0===e)return;const t=p;let r=!1;if(1===e||2===e){r=!0;for(let e=0;e<S;e++){const t=x[e];T(t[0],t[1],t[2])}a.addGroup(3*t,p-t,1)}if(-1===e||2===e){const e=2*t+p;for(let e=0;e<S;e++){const t=x[e];T(t[2]+w,t[1]+w,t[0]+w)}a.addGroup(e,p-e+2*t,r?2:1)}}(this.faceType),this.setIndex(c),this.setAttribute("position",new Float32BufferAttribute(h,3)),this.setAttribute("normal",new Float32BufferAttribute(u,3)),this.setAttribute("uv",new Float32BufferAttribute(d,2))}}class AnimatedSprite extends Sprite{constructor(e,t={}){if(!e||!e.map)return void console.warn("AnimatedSprite 必须在构造时提供材质和基本帖图。");super(e);let r=t.dimension instanceof Array?t.dimension:[1,1],n="number"==typeof t.duration?t.duration:1;this.loop=!!t.loop,this.destroyOnFinish=!!t.destroyOnFinish,e.map.wrapS=RepeatWrapping,e.map.wrapT=RepeatWrapping,e.map.repeat.set(1/r[0],1/r[1]),e.map.offset.set(0,1-1/r[1]);let i=e.opacity,a=!1,o=r[0]*r[1],s=n/o,l=0,c=1;this.fadeInFrame="number"==typeof t.fadeInFrame?Math.floor(t.fadeInFrame):-1,this.fadeOutFrame="number"==typeof t.fadeOutFrame?Math.floor(t.fadeOutFrame):-1,this.needsRemove=!1,this.play=()=>{this.material.map.offset.set(0,1-1/r[1]),this.material.opacity=i,a=!0},this.stop=()=>{a=!1},this.update=e=>{if(a&&(l+=e=e||1/60,l>=s)){if(c++,l=0,c>o&&(c=1,!this.loop))return a=!1,void(this.destroyOnFinish&&(this.needsRemove=!0));this.material.opacity=i,this.fadeInFrame>0&&c<this.fadeInFrame&&(this.material.transparent=!0,this.material.opacity=i*(c/this.fadeInFrame+1)),this.fadeOutFrame>0&&c>this.fadeOutFrame&&(this.material.transparent=!0,this.material.opacity=i*(o-c)/(o-this.fadeOutFrame+1));let e=(c-1)%r[0]/r[0],t=Math.floor((o-c)/r[0])/r[1];this.material.map.offset.set(e,t)}},this.dispose=()=>{this.material.map.dispose(),this.material.dispose(),this.parent&&this.parent.remove(this)}}get isPlaying(){return _isPlaying}get dimension(){return _dimension}set dimension(e){e instanceof Array&&e.length>=2&&(_dimension=e,_frameCount=_dimension[0]*_dimension[1],_frameDuration=_duration/_frameCount,this.material.map.repeat.set(1/_dimension[0],1/_dimension[1]),this.material.map.offset.set(0,1-1/_dimension[1]))}get duration(){return _duration}set duration(e){"number"==typeof e&&(_duration=e,_frameDuration=_duration/_frameCount)}}class Core{constructor(){let e,t;logger.debug("avw.scene.Core constructed.");let r,n,i,a=!0,o=!1,s=!1,l=!1,c={},h=!0,u=!0,d=!1,p=null,f={},m={},g=1,y=-1,v=new Vector3(0,0,0),b=new Vector2(0,0),_=new Raycaster,x=0,w=new Raycaster,S="",M=0,T=!1,A=null,E=null,C=new Vector3,L=!1,D={},R=null,P=null,O=null,I=null,k={position:{x:0,y:0,z:0},rotation:{_x:0,_y:0,_z:0,_order:"XYZ"},scale:{x:1,y:1,z:1}},B=[],N=null,F=[],U=null,z=null;_context.sceneName="",_context.currentMeshs=[],_context.objectStore=e,_context.eventHandlerStore=t,_context.exporters=f,_context.loaders=m,_context.instance=this,_context.background={},_context.sceneSettings=null,_context.ssr=[],_context.envMapIntensity=[],_context.copyModel=null,_context.worldScale=1,_context.drawableDepthTest=!1;this.container=void 0,this.resourceBasePath="./",this.defaultNodeSelection,this.defaultModelSelection,this.defaultEffectStore,this.defaultView,this.sysObjectStore,this.allState,this.notState;var H=[];this.nextRender=function(e,t=1){H.push({frameCount:t,callback:e})},this.onNextRender=function(){H.forEach((e=>{e.frameCount-=1,e.frameCount<0&&e.callback()}))},this.destroyNextRender=function(){H=H.filter((e=>e.frameCount>=0))};var G=()=>{_context.scene.traverse((e=>e.userData.inView=!1)),c.rS&&c.rS("frame").start(),c.rS&&c.rS("rAF").tick(),c.rS&&c.rS("FPS").frame(),c.rS&&c.rS("setup").start(),s&&r.update(_context.deltaA);for(let e of _context.animationMixers)e.update(_context.deltaA);if(_context.animationStore.update(_context.deltaA),_context.modelStore.updateAnimation(_context.deltaA),T)_context.alpha&&_context.renderer.getContext().clearColor(0,0,0,0),c.rS&&c.rS("setup").end(),_context.renderer.render(_context.scene,_context.cameraOrtho);else{if(_context.instancedObjectStore){let e=_context.instancedObjectStore.findInstancedObject("tree");if(e&&e.points instanceof Array){let t=.01+.02*Math.random();e.setPoints(t)}}t.update(),_context.targetCameraControls.update(_context.deltaA),_context.orbitControls.update(_context.deltaA),c.rS&&c.rS("setup").end(),_context.composer.render(_context.deltaA)}c.rS&&c.rS("focus").start(),_context.effectStore.visualEffect.enableDOF&&"auto"===_context.effectStore.visualEffect.dofFocus&&(x+=_context.deltaA,x>=1&&(x=0,this.focus())),c.rS&&c.rS("focus").end(),c.rS&&c.rS("frame").end(),c.rS&&c.rS("rStats").start(),c.rS&&c.rS().update(),c.rS&&c.rS("rStats").end(),_context.statistics.update(),_context.rendererInfo=_context.statistics.getRendererInfo(_context.renderer),_context.renderer.info.reset(),_context.deltaA=0},V=()=>{if(a)return;let e=_context.clock.getDelta();_context.deltaA+=e,_context.deltaA<_context.frameTimeLimit||(G(),_context.instance.onNextRender(),_context.instance.destroyNextRender()),requestAnimationFrame(V.bind(this))};let j=()=>{_.setFromCamera(b,_context.camera);let e=_.intersectObjects(_context.scene.models.children,!0);if(logger.debug(`Picked ${e.length} objects at ${b.x}, ${b.y}.`),e.length>0){var t=e[0];t.distance>=0?(v.set(t.point.x,t.point.y,t.point.z),y=t.distance):(v.set(0,0,0),y=-1)}else v.set(0,0,0),y=-1;return b.set(0,0),y};this._pausePickInFocusObject=()=>{},this._resumePickInFocusObject=()=>{},this.pickObjectInFocus=()=>{j()};let W=(e,t)=>{let r=document.createElement("a");r.style.display="none",document.body.appendChild(r),r.href=URL.createObjectURL(e),r.download=t,r.click(),document.body.removeChild(r)},Y=e=>`${this.resourceBasePath}///${e}`.replace("/////","/").replace("////","/").replace("///","/");this._exportScene=e=>{switch((e=e||"gltf").toLowerCase()){case"gltf":default:let e={trs:!0,onlyVisible:!1,truncateDrawRange:!1,binary:!0,forcePowerOfTwoTextures:!0,includeCustomExtensions:!0,maxTextureSize:1/0};logger.debug(_context.scene),f.gltfExporter.parse(_context.scene,(e=>{var t;e instanceof ArrayBuffer?(t="scene.glb",W(new Blob([e],{type:"application/octet-stream"}),t)):((e,t)=>{W(new Blob([e],{type:"text/plain"}),t)})(JSON.stringify(e,null,2),"scene.gltf")}),e)}};let X=(t,r)=>{var n;if(null!=r){var i=r.canvas,a=new CanvasTexture(i),o=new SpriteMaterial({map:a,color:16777215,fog:DRAWABLE_FOG,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest,sizeAttenuation:r.sizeAttenuation});return(n=new Sprite(o)).onBeforeRender=function(){this.userData.inView=!0},n.scale.set(r.width,r.height,1),n.center=new Vector2(r.offsetV,r.offsetH),n.visible=r.enableText,t?t.add(n):e.add(n),n}},$=e=>"#"==e.charAt(0)?e.substring(1,7):"0"==e.charAt(0)&&"x"==e.charAt(1)?e.substring(2,8):e,Z=function(t,r,n,i){e.remove(t);var a=new Group;a.name=t,a.renderOrder=DRAWABLE_RENDER_ORDER_BASE+("number"==typeof r.renderOrder?r.renderOrder:0);for(var o=[],s=0;s<r.point.length;s+=2)o.push(new Vector2(r.point[s],r.point[s+1]));o.push(new Vector2(r.point[0],r.point[1])),r.fillRepeat=r.fillRepeat||[1,1];let l=new Color(r.color),c=l,h=0;switch(r.fillType){case"top":h=1;break;case"bottom":h=-1;break;case"both":h=2;break;case"none":h=0}const u=new AreaGeometry(o,r.depth*_context.worldScale,1,!1,h);(e=>{if(r.fillArea&&"none"!==r.fillArea){let t=`texture/area/fill/${r.fillArea.toLowerCase()}.jpg`;_context.loaders.textureLoader.load(util$1.url(this.resourceBasePath,t),(t=>{t.wrapS=RepeatWrapping,t.wrapT=RepeatWrapping;let n=o[0].x,i=o[0].x;for(let e of o)e.x>n?n=e.x:e.x<i&&(i=e.x);let a=new Vector2(n,0).distanceTo(new Vector2(i,0));t.repeat.set(a/t.image.height*2,1);let s=new MeshPhongMaterial({map:t,alphaMap:t,transparent:!0,fog:DRAWABLE_FOG,color:l,opacity:r.alpha,side:DoubleSide,emissive:c,emissiveIntensity:"number"!=typeof r.brightness?.5:r.brightness,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest});s.name="AreaFillMaterial",r.depth,_context.worldScale,util$1.interpolate(r.point,2,50,!0);let h=0,u=0;"Gradient01"===r.fillArea||"Gradient02"===r.fillArea?h=-1/6:"Grid01"===r.fillArea?h=1/6:"Grid02"===r.fillArea||"Segment01"===r.fillArea?h=-1/6:"Segment02"===r.fillArea&&(u=-1/6);let d=new UVAnimationController(s,!0,!0,-h,u);_context.animationStore.add(d),e(s)}))}else{let t=new MeshBasicMaterial({fog:DRAWABLE_FOG,side:DoubleSide,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest});t.name="AreaFillMaterial",t.visible=!1,e(t)}})((n=>{let o=`texture/area/${r.areaType.toLowerCase()}.jpg`;_context.loaders.textureLoader.load(util$1.url(this.resourceBasePath,o),(o=>{o.flipY=!1,o.wrapS=RepeatWrapping,o.wrapT=RepeatWrapping,o.repeat.set(Math.ceil(u.sideWallSegments)||1,1),"arrow01"===r.areaType.toLowerCase()?o.repeat.set(Math.ceil(u.sideWallSegments)||1,1):"segment01"===r.areaType.toLowerCase()&&(o.wrapS=MirroredRepeatWrapping,o.repeat.set(Math.ceil(u.sideWallSegments)||1,1));let s=new MeshPhongMaterial({map:o,fog:DRAWABLE_FOG,alphaMap:o,transparent:!0,color:l,opacity:r.alpha,side:DoubleSide,emissive:c,emissiveIntensity:"number"!=typeof r.brightness?.5:r.brightness,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest});s.name="AreaSideMaterial",r.depth,_context.worldScale,util$1.interpolate(r.point,2,50,!0);let h=0,d=0;"Arrow01"===r.areaType?h=1/6:"Gradient01"===r.areaType||("Gradient02"===r.areaType?d=1/6:"Gradient03"===r.areaType||"Grid01"===r.areaType||("Grid02"===r.areaType?d=-1/6:"Grid03"===r.areaType?d=1/6:"Grid04"===r.areaType?d=-1/6:"Grid05"===r.areaType?d=1/6:"Segment01"===r.areaType?h=1/6:"Segment02"===r.areaType?d=1/6:"Segment03"===r.areaType&&(h=1/6)));let p=new UVAnimationController(s,!0,!0,-h,d);_context.animationStore.add(p);let f=null;switch(r.fillType){case"top":case"bottom":f=new Mesh(u,[s,n]);break;case"both":f=new Mesh(u,[s,n,n]);break;case"none":f=new Mesh(u,[s])}f.onBeforeRender=function(){this.userData.inView=!0},f.name=t,a.add(f),r.offset&&a.position.set(r.lonOffset,r.altOffset,r.latOffset),a.visible=r.isShow,a.activeVisible=r.isShow,e.add(t,a),null!=r.enableAutoHidebyDistance&&(a.enableAutoHidebyDistance=r.enableAutoHidebyDistance,a.minDistance=r.minDistance*_context.worldScale,a.maxDistance=r.maxDistance*_context.worldScale,_context.animationStore.addDistance(t,DistanceController,_context.camera,a)),u.computeBoundingSphere();let m=u.boundingSphere.center;a.position.x+=m.x,a.position.y+=m.y,a.position.z+=m.z,f.position.x-=m.x,f.position.y-=m.y,f.position.z-=m.z,a.userData.center=a.position.clone(),i&&i(1)}))}))},q=function(e){return new Promise((t=>{const r=new Image;r.setAttribute("crossOrigin","anonymous"),r.src=e,r.onload=function(){t(r)},r.onerror=function(){t()}}))},J=function({target:e}={}){if(!_context.compass||!_context.compass.canvas)return;let t=_context.compass.canvas,r=t.getContext("2d"),n=180/Math.PI*e.getAzimuthalAngle();n=(n+360)%360;const i=_context.compass.size,a=_context.renderer.domElement.scrollHeight,o=_context.renderer.domElement.scrollWidth,s=i<a?i:a<o?a:o;let l=_context.compass.dialPlate,c=_context.compass.pointer;t.width=s,t.height=s,r.translate(t.width/2,t.height/2),r.rotate(Math.PI/180*n),r.translate(-t.width/2,-t.height/2);let h=t.width/2-s/2,u=t.height/2-s/2;r.drawImage(l,h,u,s,s),r.translate(t.width/2,t.height/2),r.rotate(Math.PI/180*-n),r.translate(-t.width/2,-t.height/2),r.restore(),r.drawImage(c,0,0,s,s)};this.addEventListener=function(e,t,r){"transformControls"==e&&_context.transformControls.addEventListener(t,r)},this.removeEventListener=function(e,t,r){"transformControls"==e&&_context.transformControls.removeEventListener(t,r)},this.transformObject=function(t){const r=e.find(t);r&&_context.transformControls.attach(r)},this.untransformObject=function(){_context.transformControls.detach()},this.domElement=function(){return _context.renderer.domElement},this.setCompass=async function({isShow:e=!0,hor:t="right",ver:r="top",offset:n=[0,0],size:i=1}={}){let a=document.getElementById("compass");if(!e&&!a)return;if(!e&&a)return _context.orbitControls.removeEventListener("change",J),this.container.removeChild(a),void(_context.compass.canvas=void 0);if(!a){a=document.createElement("canvas"),a.setAttribute("id","compass"),a.style.position="absolute",a.style.pointerEvents="none",this.container.appendChild(a);let e=new Image;e.src=util$1.url(this.resourceBasePath,"./texture/compass/DialPlate.png"),e.onload=()=>{_context.compass={dialPlate:e},e=new Image,e.src=util$1.url(this.resourceBasePath,"./texture/compass/Pointer.png"),e.onload=()=>{_context.compass.pointer=e,_context.compass.size=i,_context.compass.canvas=a,J({target:_context.orbitControls}),_context.orbitControls.addEventListener("change",J)}}}let o=n[0],s=n[1];a.style.transform="unset",a.style.left="unset",a.style.right="unset",a.style.top="unset",a.style.bottom="unset","left"===t?a.style.left=`${o}px`:"right"===t&&(a.style.right=-o+"px"),"top"===r?a.style.top=`${s}px`:"bottom"===r&&(a.style.bottom=-s+"px"),"center"===t&&"middle"===r?(a.style.left=`calc(50% + ${o}px)`,a.style.top=`calc(50% + ${s}px)`,a.style.transform="translate(-50%, -50%)"):"center"===t?(a.style.left=`calc(50% + ${o}px)`,a.style.transform="translate(-50%, 0)"):"middle"===r&&(a.style.top=`calc(50% + ${s}px)`,a.style.transform="translate(0, -50%)"),_context.compass&&(_context.compass.size=i,J({target:_context.orbitControls}))},this.setWatermark=async function(e=[],t){let r=[];Array.isArray(e)||(e=[e]);const i=e;e=[];for(const t of i){let n=await q(t.src);n?(t.img=n,e.push(t)):r.push(t.src)}if(r.length>0)return void(t&&t(0,`${r.join("、")} 图片加载失败。`));let a=n.width,o=n.height,s=document.createElement("canvas");s.setAttribute("width",a),s.setAttribute("height",o);let l=s.getContext("2d");for(const t of e){let e=t.img.width*t.scale,r=t.img.height*t.scale,n=0;"right"===t.hor?n=a-e:"center"===t.hor&&(n=a/2-e/2);let i=0;"bottom"===t.ver?i=o-r:"center"===t.ver&&(i=o/2-r/2),n+=t.offset[0],i+=t.offset[1],l.globalAlpha=t.alpha,l.drawImage(t.img,n,i,e,r)}try{let e=s.toDataURL("image/png");_context.effectStore.visualEffect.watermark=e}catch(e){return void(t&&t(0,`生成水印失败：${e} 。`))}t&&t(1,{})},this.endSelectDrawable=function(){_context.selectControl.endSelectDrawable(...arguments)},this.selectDrawable=function(){_context.selectControl.startSelectDrawable(...arguments)},this.getModelBox=function(e){let t=this.defaultObjectTree.getItemByName(e).getGroup(),r=new Box3;return r.setFromObject(t),r},this.restrictCamera=function({limitDistance:e=[0,_context.camera.far],limitPitch:t=[-90,90],limitYaw:r=[-1/0,1/0],limitHeight:n=[-999999999,999999999],center:i=[0,0],radius:a=999999999},o){_context.orbitControls.minDistance=e[0]/_context.worldScale,_context.orbitControls.maxDistance=e[1]/_context.worldScale;let s=MathUtils.degToRad(90-t[1]);_context.orbitControls.minPolarAngle=s;let l=MathUtils.degToRad(90-t[0]);_context.orbitControls.maxPolarAngle=l;let c=r[0];180==c&&(c+=1e-4),c=(c+180)%360-180,c=MathUtils.degToRad(c),NaN==c&&(c=-1/0),_context.orbitControls.minAzimuthAngle=c;let h=r[1];180==h&&(h+=1e-4),h=(h+180)%360-180,h=MathUtils.degToRad(h),NaN==h&&(h=1/0),_context.orbitControls.maxAzimuthAngle=h,o&&o({result:1,message:"成功。"})},this.setSceneName=function(e){_context.sceneName=e},this.getSceneName=function(){return _context.sceneName},this.addBillboardAsset=function(t,r,n){e.remove(t);var i=new Group;let a=_context.sceneSettings.objectTree.children.find((e=>"IconAsset"===e.type&&e.name===r.iconAssetName));a=JSON.parse(JSON.stringify(a)),a.name=t,a.transform.position.x=r.pos.x,a.transform.position.y=r.pos.y,a.transform.position.z=r.pos.z,a.textParam.text=r.labelText,a.textParam.enableText=""!=a.textParam.text,a.textParam.color=r.labelColor,a.isVisible=void 0===r.isShow?a.isVisible:r.isShow,new IconItem(a,i,(()=>{for(const e of i.children[0].children)e.onBeforeRender=function(){this.userData.inView=!0};i.children[0].renderOrder=DRAWABLE_RENDER_ORDER_BASE+("number"==typeof r.renderOrder?r.renderOrder:0),e.add(t,i.children[0]),n&&n(e)}))},this.updateBillboardAsset=function(t,r,n){let i=_context.sceneSettings.objectTree.children.find((e=>"IconAsset"===e.type&&e.name===r.iconAssetName));i=JSON.parse(JSON.stringify(i)),i.name=t,i.transform.position.x=r.pos.x,i.transform.position.y=r.pos.y,i.transform.position.z=r.pos.z,i.textParam.text=r.labelText,i.textParam.enableText=""!=r.labelText,i.textParam.color=r.labelColor,i.isVisible=void 0===r.isShow?i.isVisible:r.isShow;let a=this.getIconAsset(t);if(a)a.update(i),n&&n(1);else{e.remove(t);var o=new Group;o.renderOrder=2,new IconItem(i,o,(()=>{o.children[0].renderOrder=DRAWABLE_RENDER_ORDER_BASE+("number"==typeof r.renderOrder?r.renderOrder:0),e.add(t,o.children[0]),n&&n(1)}))}},this.isContentAssets=function(e,t="IconAsset"){if(null==e||""==e)return!1;let r=e.indexOf("custom-")>-1,n=_context.sceneSettings.objectTree.children;return r?n.findIndex((r=>r.type===t&&r.isEditor&&r.name===e.replace("custom-","")))>-1:n.findIndex((r=>r.type==t&&!r.isEditor&&r.name===e))>-1},this.interruptCameraFly=function(){if(_context.orbitControls.removeEventListener("start",this.interruptCameraFly),_context.orbitControls.autoRotate)return _context.orbitControls.autoRotate=!1,_context.orbitControls.autoRotateSpeed=0,void _context.orbitControls.update();if(_context.targetCameraControls.isZoomTo){let e=this.getCamera(),t=new Vector3(e.targetX,e.targetY,e.targetZ),r=e.azimuthAngle,n=e.inclinationAngle,i=e.viewDistance;_context.targetCameraControls.zoomTo(t,r,n,i,0,!0,(()=>{-1!==j()&&this.setCamera({target:v,distance:y})}))}}.bind(this),this.drawableIsSelected=function(t,r){let n=e.find(r);return!!n&&("landmark"===t&&void 0!==n.children[3])},this.getAngleByPositions=function(e,t){let r=new Vector3(e.x,e.y,e.z);return 180*new Vector3(t.x,t.y,t.z).angleTo(r)/Math.PI},this.getDistanceByPositions=function(e,t){let r=new Vector3(e.x,e.y,e.z);return new Vector3(t.x,t.y,t.z).distanceTo(r)*_context.worldScale},this.positionLerp=function(e,t,r){let n=new Vector3(e.x,e.y,e.z),i=new Vector3(t.x,t.y,t.z);return n.lerp(i,r)},this.addPath=function(t,r,n){e.remove(t);let i=new Group;i.renderOrder=DRAWABLE_RENDER_ORDER_BASE+("number"==typeof r.renderOrder?r.renderOrder:0),i.name=t;let a=[];r.points.forEach((e=>{a.push(e.x),a.push(e.y),a.push(e.z)}));let o=util$1.interpolate(a,3);o=o||[];const s=util$1.interpolate(a,3,50,!0);let l=`texture/path/${r.pathType.toLowerCase()}.jpg`;_context.loaders.textureLoader.load(util$1.url(this.resourceBasePath,l),(a=>{a.wrapS=RepeatWrapping,a.wrapT=RepeatWrapping;var l=new THREE_MeshLine.MeshLineMaterial({fog:DRAWABLE_FOG,map:a,maskMap:a,useMaskMap:!0,color:new Color(r.color),opacity:r.alpha,resolution:new Vector2(window.innerWidth,window.innerHeight),sizeAttenuation:1,lineWidth:r.width*_context.worldScale,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest,alphaTest:.05,transparent:!0,side:DoubleSide,repeat:new Vector2(s/(4*r.width),1),colorPass:new Color(r.colorPass),passRange:r.passRange||0,pass:r.pass,faceUp:!0}),c=new THREE_MeshLine.MeshLine;c.setGeometry(o);var h=new Mesh(c.geometry,l);h.onBeforeRender=function(){this.userData.inView=!0},h.raycast=c.raycast,h.name=t,i.add(h),e.add(t,i);let u=0;"Arrow01"===r.pathType||"Arrow02"===r.pathType||"Arrow03"===r.pathType||"Arrow04"===r.pathType?u=1.3*r.width/s:"Arrow05"===r.pathType?u=1.5*r.width/s:"Arrow06"===r.pathType?u=5*r.width/s:"Segment01"===r.pathType?u=15*r.width/s:"Segment02"===r.pathType||"Segment03"===r.pathType?u=30*r.width/s:"Segment04"===r.pathType?u=15*r.width/s:("Segment05"===r.pathType||"Segment06"===r.pathType)&&(u=0);let d=new UVMeshLineAnimationController(l,!0,!1,-u,0);_context.animationStore.add(d),i.visible=r.isShow;let p=0;const f=r.points.length;for(let e=0;e<f-1;e++){const t=r.points[e],n=r.points[e+1],i=new Vector3(t.x,t.y,t.z),a=new Vector3(n.x,n.y,n.z);p+=i.distanceTo(a)}const m=p/2;let g=new Vector3;p=0;for(let e=0;e<f-1;e++){const t=r.points[e],n=r.points[e+1],i=new Vector3(t.x,t.y,t.z),a=new Vector3(n.x,n.y,n.z);if(p+=i.distanceTo(a),p>m){const e=p-m;g=i.lerp(a,1-e/i.distanceTo(a));break}}i.position.x+=g.x,i.position.y+=g.y,i.position.z+=g.z,h.position.x-=g.x,h.position.y-=g.y,h.position.z-=g.z,i.userData.center=i.position.clone(),n&&n(i)}))},this.updatePathPass=function(t,{colorPass:r,pass:n}){let i=e.find(t);if(!i)return;let a=i.children[0].material;a.pass=n,a.colorPass=new Color(r)},this.cameraFlyTo=function(e,t,r,n,i,a,o){_context.orbitControls.addEventListener("start",this.interruptCameraFly),_context.targetCameraControls.zoomTo(new Vector3(e.x,e.y,e.z),t,r,n*_context.worldScale,i,a,(e=>{_context.orbitControls.removeEventListener("start",this.interruptCameraFly),o&&o(e)}))},this.getCameraAutoRotate=()=>_context.orbitControls.autoRotate,this.getDatumShiftModel=function(){return _context.datumShiftModel},this.setDatumShiftModel=function(e){_context.datumShiftModel=e,E.setDatumShiftModel(e)},this.setReferencePoints=function(e){e instanceof Array&&!(e.length<2)||logger.warn("未提供有效的参考点信息。")},this.convertLLAToXYZ=function(e){return E.convertTransform(e)},this.convertXYZToLLA=function(e){return E.XYZToLLA(e)},this.getModelTransform=e=>{var t={};return _context.scene.models.children.map((r=>{r.name===e&&(t.position=JSON.parse(JSON.stringify(r.position)),t.rotation=JSON.parse(JSON.stringify(r.rotation)),t.rotation.x=t.rotation._x,t.rotation.y=t.rotation._y,t.rotation.z=t.rotation._z,t.scale=JSON.parse(JSON.stringify(r.scale)),t.rotation.x=t.rotation._x=MathUtils.radToDeg(t.rotation._x),t.rotation.y=t.rotation._y=MathUtils.radToDeg(t.rotation._y),t.rotation.z=t.rotation._z=MathUtils.radToDeg(t.rotation._z))})),t},this.setModelTransform=(e,t)=>{if(t)for(let r=0;r<_context.scene.models.children.length;r++)_context.scene.models.children[r].name===e&&this.setTransform(_context.scene.models.children[r],t)},this.setModelTransform2=(e,t)=>{let r=_context.scene.models.getObjectByName(e.id);if(!r)return void(t&&t({result:0,message:`失败，模型 ${e.id} 不存在。`}));let n=_context.animationStore.findNodeAnimation(r,ModelTransformAnimationController.type);n&&_context.animationStore.remove(n),n=new ModelTransformAnimationController(r,e),_context.animationStore.add(n),t&&t({result:1,message:"成功。"})},this.getModelTransformByUUID=e=>{var t={};let r=_context.scene.models.getObjectByProperty("uuid",e);return r&&r.uuid===e&&(t.position=JSON.parse(JSON.stringify(r.position)),t.rotation=JSON.parse(JSON.stringify(r.rotation)),t.rotation.x=t.rotation._x,t.rotation.y=t.rotation._y,t.rotation.z=t.rotation._z,t.scale=JSON.parse(JSON.stringify(r.scale)),t.rotation.x=t.rotation._x=MathUtils.radToDeg(t.rotation._x),t.rotation.y=t.rotation._y=MathUtils.radToDeg(t.rotation._y),t.rotation.z=t.rotation._z=MathUtils.radToDeg(t.rotation._z)),t},this.setModelTransformByUUID=(e,t,r=!1)=>{if(!t)return;if(r){var n={type:"mouseUp",mode:null};_context.transformControls.dispatchEvent({type:"mouseDown"})}let i=this.defaultObjectTree.getItemByUUID(e);i&&(i.transformNode=t),_context.scene.models.traverse((r=>{r.uuid===e&&this.setTransform(r,t)})),r&&(n.mode=_context.transformControls.mode,_context.transformControls.dispatchEvent(n)),this.nextRender((()=>{this.cutLevelByUUID(e,!1)}))},this.setTransformHistory=e=>{e>0?_context.transformStore.advance():e<0&&_context.transformStore.backOff()},this.clearTransformHistory=()=>{_context.transformStore.clear()},this.setTransformStoreMode=e=>{_context.transformStore.setMode(e)},this.onTransformEvent=(e,t)=>{_context.transformStore.addEventListener(e,t)},this.offTransformEvent=(e,t)=>{_context.transformStore.removeEventListener(e,t)},this.setModelOpacity=(e,t)=>{let r=_context.scene.models.getObjectByName(e);if(!r)return;let n=e=>{for(let t of e)t.material&&(t.userData.defaultOpacity||(t.userData.defaultOpacity={},t.userData.defaultOpacity.transparent=t.material.transparent,t.userData.defaultOpacity.opacity=t.material.opacity)),n(t.children)};n(r.children);let i=e=>{for(let r of e)r.material&&(r.material.transparent=!(t>=1)||r.userData.defaultOpacity.transparent,r.material.opacity=r.userData.defaultOpacity.opacity*t),i(r.children)};i(r.children)},this.setModelStyle=(e,{scale:t,isVisible:r,xRay:n,alpha:i,maskType:a,maskAlpha:o,maskColor:s,maskPicture:l,maskPictureScale:c,maskFlowSpeed:h,maskFlowDirection:u})=>{let d=_context.defaultObjectTree.getItemByName(e);if(!d)return;let p,f=d.getGroup();if(f){if("none"===a&&f.traverse((e=>{if(!e.isMesh)return;if(null==e.userData.material)return;let t=_context.animationStore.findMaterialAnimation(e.material,UVAnimationController.type);t&&_context.animationStore.remove(t),e.material.dispose(),e.material=e.userData.material,e.userData.material=void 0})),"color"===a&&(f.traverse((e=>{e.isMesh&&(void 0===e.userData.material&&(e.userData.material=e.material),e.material=new MeshLambertMaterial({color:s}))})),p=o),"picture"===a){let e=`texture/path/${l.toLowerCase()}.jpg`;f.traverse((t=>{if(!t.isMesh)return;if(void 0!==t.userData.defaultStyle)return;if(null!=t.userData.material){let e=_context.animationStore.findMaterialAnimation(t.material,UVAnimationController.type);e&&_context.animationStore.remove(e),t.material.map&&t.material.map.dispose(),t.material.dispose()}null==t.userData.material&&(t.userData.material=t.material);let r=_context.loaders.textureLoader.load(util$1.url(this.resourceBasePath,e));if(t.material=new MeshLambertMaterial({map:r,alphaMap:r}),r.wrapS=RepeatWrapping,r.wrapT=RepeatWrapping,void 0!==c&&(r.repeat.x=c,r.repeat.y=c),null!=h){t.material.map.wrapS=RepeatWrapping,t.material.map.wrapT=RepeatWrapping;let e=MathUtils.degToRad(u),r=h*Math.cos(e),n=h*Math.sin(e);r=Math.round(100*r)/100,n=Math.round(100*n)/100;let i=0!==r,a=0!==n,o=_context.animationStore.findMaterialAnimation(t.material,UVAnimationController.type);if(o)o.enableU=i,o.enableV=a,o.uSpeed=r,o.vSpeed=n;else{let e=new UVAnimationController(t.material,i,a,r,n);_context.animationStore.add(e)}}})),p=o}void 0!==t&&f.scale.setScalar(t),void 0!==n&&f.traverse((e=>{if(e.isMesh)if(e.material instanceof Array)for(const t of e.material)t.depthTest="off"===n;else e.material.depthTest="off"===n})),void 0===i&&void 0===p||(void 0===i&&(i=1),void 0===p&&(p=1),p*=i,f.traverse((e=>{if(e.isMesh&&!e.isWater)if(e.material instanceof Array)for(const t of e.material)t.opacity=p,t.transparent=p<1;else e.material.opacity=p,e.material.transparent=p<1}))),null!=r&&(f.visible=!!r)}},this.getModelNodeTransform=(e,t)=>{let r={};for(let n=0;n<this.defaultObjectTree.children.length;n++)switch(this.defaultObjectTree.children[n].type){case"ModelItem":this.defaultObjectTree.children[n].name===e&&(r=this.getModelTransformRecursion(this.defaultObjectTree.children[n].getGroup(),t));case"BuildingItem":this.defaultObjectTree.children[n].name===e?r=this.getModelTransformRecursion(this.defaultObjectTree.children[n].getGroup(),t):this.defaultObjectTree.children[n].children.forEach((n=>{switch(n.type){case"ModelItem":n.name===e&&(r=this.getModelTransformRecursion(n.getGroup(),t));case"BuildingFloorItem":n.name===e?r=this.getModelTransformRecursion(n.getGroup(),t):n.children.forEach((n=>{n.name===e&&(r=this.getModelTransformRecursion(n.getGroup(),t))}))}}))}return r},this.setModelNodeTransform=(e,t,r)=>{if(r)for(let n=0;n<this.defaultObjectTree.children.length;n++)switch(this.defaultObjectTree.children[n].type){case"ModelItem":this.defaultObjectTree.children[n].name===e&&this.setModelTransformRecursion(this.defaultObjectTree.children[n].getGroup(),t,r);case"BuildingItem":this.defaultObjectTree.children[n].name===e?this.setModelTransformRecursion(this.defaultObjectTree.children[n].getGroup(),t,r):this.defaultObjectTree.children[n].children.forEach((n=>{switch(n.type){case"ModelItem":n.name===e&&this.setModelTransformRecursion(n.getGroup(),t,r);case"BuildingFloorItem":n.name===e?this.setModelTransformRecursion(n.getGroup(),t,r):n.children.forEach((n=>{n.name===e&&this.setModelTransformRecursion(n.getGroup(),t,r)}))}}))}},this.getModelTransformRecursion=(e,t)=>{if(!(null!=e.children&&e.children.length>0))return!1;for(let n=0;n<e.children.length;n++){if(e.children[n].name===t){var r={};return r.position=JSON.parse(JSON.stringify(e.children[n].position)),r.rotation=JSON.parse(JSON.stringify(e.children[n].rotation)),r.rotation.x=r.rotation._x,r.rotation.y=r.rotation._y,r.rotation.z=r.rotation._z,r.scale=JSON.parse(JSON.stringify(e.children[n].scale)),r.rotation.x=r.rotation._x=MathUtils.radToDeg(r.rotation._x),r.rotation.y=r.rotation._y=MathUtils.radToDeg(r.rotation._y),r.rotation.z=r.rotation._z=MathUtils.radToDeg(r.rotation._z),r}{let r=this.getModelTransformRecursion(e.children[n],t);if(r)return r}}},this.setModelTransformRecursion=(e,t,r)=>{if(null!=e.children&&e.children.length>0)for(let n=0;n<e.children.length;n++){if(e.children[n].name===t)return r.position&&(e.children[n].position.x="number"==typeof r.position.x?r.position.x:e.children[n].position.x,e.children[n].position.y="number"==typeof r.position.y?r.position.y:e.children[n].position.y,e.children[n].position.z="number"==typeof r.position.z?r.position.z:e.children[n].position.z),r.rotation&&(e.children[n].rotation.order=r.rotation._order||e.children[n].rotation.order,e.children[n].rotation.x="number"==typeof r.rotation.x?MathUtils.degToRad(r.rotation.x):e.children[n].rotation.x,e.children[n].rotation.y="number"==typeof r.rotation.y?MathUtils.degToRad(r.rotation.y):e.children[n].rotation.y,e.children[n].rotation.z="number"==typeof r.rotation.z?MathUtils.degToRad(r.rotation.z):e.children[n].rotation.z),void(r.scale&&(e.children[n].scale.x="number"==typeof r.scale.x?r.scale.x:e.children[n].scale.x,e.children[n].scale.y="number"==typeof r.scale.y?r.scale.y:e.children[n].scale.y,e.children[n].scale.z="number"==typeof r.scale.z?r.scale.z:e.children[n].scale.z));this.setModelTransformRecursion(e.children[n],t,r)}},this.setTransform=(e,t)=>{t.position&&(e.position.x="number"==typeof t.position.x?t.position.x:e.position.x,e.position.y="number"==typeof t.position.y?t.position.y:e.position.y,e.position.z="number"==typeof t.position.z?t.position.z:e.position.z,_context.eventHandlerStore.cameraMove()),t.rotation&&(e.rotation.order=t.rotation._order||e.rotation.order,e.rotation.x="number"==typeof t.rotation.x?MathUtils.degToRad(t.rotation.x):e.rotation.x,e.rotation.y="number"==typeof t.rotation.y?MathUtils.degToRad(t.rotation.y):e.rotation.y,e.rotation.z="number"==typeof t.rotation.z?MathUtils.degToRad(t.rotation.z):e.rotation.z),t.scale&&(e.scale.x="number"==typeof t.scale.x?t.scale.x:e.scale.x,e.scale.y="number"==typeof t.scale.y?t.scale.y:e.scale.y,e.scale.z="number"==typeof t.scale.z?t.scale.z:e.scale.z)},this.getSceneTransform=()=>{var e={};return e.position=_context.scene.models.position,e.rotation=JSON.parse(JSON.stringify(_context.scene.models.rotation)),e.scale=_context.scene.models.scale,e.rotation.x=e.rotation._x=MathUtils.radToDeg(e.rotation._x),e.rotation.y=e.rotation._y=MathUtils.radToDeg(e.rotation._y),e.rotation.z=e.rotation._z=MathUtils.radToDeg(e.rotation._z),e},this.setSceneTransform=e=>{e&&(e.position&&(_context.scene.models.position.x="number"==typeof e.position.x?e.position.x:_context.scene.models.position.x,_context.scene.models.position.y="number"==typeof e.position.y?e.position.y:_context.scene.models.position.y,_context.scene.models.position.z="number"==typeof e.position.z?e.position.z:_context.scene.models.position.z),e.rotation&&(_context.scene.models.rotation.order=e.rotation._order||_context.scene.models.rotation.order,_context.scene.models.rotation.x="number"==typeof e.rotation._x?MathUtils.degToRad(e.rotation._x):_context.scene.models.rotation.x,_context.scene.models.rotation.y="number"==typeof e.rotation._y?MathUtils.degToRad(e.rotation._y):_context.scene.models.rotation.y,_context.scene.models.rotation.z="number"==typeof e.rotation._z?MathUtils.degToRad(e.rotation._z):_context.scene.models.rotation.z),e.scale&&(_context.scene.models.scale.x="number"==typeof e.scale.x?e.scale.x:_context.scene.models.scale.x,_context.scene.models.scale.y="number"==typeof e.scale.y?e.scale.y:_context.scene.models.scale.y,_context.scene.models.scale.z="number"==typeof e.scale.z?e.scale.z:_context.scene.models.scale.z))},this.setAvwToken=function(e,t,r){switch(e.toLowerCase()){case"header":let e={};"authorization:bearer"===t.toLowerCase()?e.Authorization="Bearer "+r:e[t]=r;for(let t in _context.loaders)"function"==typeof _context.loaders[t].setRequestHeader&&_context.loaders[t].setRequestHeader(e)}},this.addState=function(e){return _context.stateStore.add(e+"")},this.getStates=function(){return _context.stateStore.getStates()},this.setDefaultState=function(e){return _context.stateStore.setDefaultState(e)},this.removeState=function(e){_context.stateStore.remove(e)},this.updateState=function(e,t){return _context.stateStore.update(e,t)},this.copyState=function(e,t){return _context.stateStore.copyState(e,t)},this.getCurrentState=()=>{if(_context.stateStore)return _context.stateStore.getCurrentState()},this.synchronizaArticulation=()=>{_context.stateStore&&_context.stateStore.synchronizaArticulation()},this.synchronizaAnimation=()=>{_context.stateStore&&_context.stateStore.synchronizaAnimation()},this.recoverView=e=>{let t=null;_context.sceneSettings||this.saveSceneSettings(this.getSettings());let r=_context.sceneSettings.states.find((t=>t.name==e));t=r?r.settings.view:_context.sceneSettings.view,this.defaultView.applySettings(t)},this.setCurrentState=(e,t,r)=>{if(_context.stateStore){if(e)return this.notState||(this.notState=JSON.parse(JSON.stringify(this.getSettings()))),this.notDistance?(this.notState.view.camera.distanceMin=this.notDistance.minDistance,this.notState.view.camera.distanceMax=this.notDistance.maxDistance):(this.notDistance||(this.notDistance={}),this.notDistance.minDistance=this.notState.view.camera.distanceMin,this.notDistance.maxDistance=this.notState.view.camera.distanceMax),window.firstLoadEnd?U&&(this.notState.view.camera.targetX=U.targetX,this.notState.view.camera.targetY=U.targetY,this.notState.view.camera.targetZ=U.targetZ,this.notState.view.camera.distance=U.viewDistance,this.notState.view.camera.azimuth=U.azimuthAngle,this.notState.view.camera.inclination=U.inclinationAngle,this.notState.view.camera.fov=U.fov,this.notState.view.camera.maxDistance=U.distanceMax,this.notState.view.camera.minDistance=U.distanceMin,this.notState.view.camera.near=U.near,this.notState.view.camera.far=U.far,this.notState.view.camera.inclinationAngleMin=U.inclinationAngleMin,this.notState.view.camera.inclinationAngleMax=U.inclinationAngleMax):(window.firstLoadEnd=!0,_context.sceneSettings&&(this.notState.view.camera=_context.sceneSettings.view.camera),U&&(U.targetX=this.notState.view.camera.targetX,U.targetY=this.notState.view.camera.targetY,U.targetZ=this.notState.view.camera.targetZ,U.viewDistance=this.notState.view.camera.distance,U.azimuthAngle=this.notState.view.camera.azimuth,U.inclinationAngle=this.notState.view.camera.inclination,U.fov=this.notState.view.camera.fov,U.distanceMax=this.notState.view.camera.maxDistance,U.distanceMin=this.notState.view.camera.minDistance,U.near=this.notState.view.camera.near,U.far=this.notState.view.camera.far,U.inclinationAngleMin=this.notState.view.camera.inclinationAngleMin,U.inclinationAngleMax=this.notState.view.camera.inclinationAngleMax)),_context.stateStore.selectState(e,t,r);this.notState?(this.notState.view.camera.duration=1.5,this.applySceneSettings(this.notState,t),_context.stateStore.setNotState(),this.notState=null):(this.notState=JSON.parse(JSON.stringify(this.getSettings())),this.notState.view.camera.duration=1.5,this.applySceneSettings(this.notState,t),_context.stateStore.setNotState(),this.notState=null)}},this.saveCurrentStateSettings=()=>{_context.stateStore&&_context.stateStore.saveCurrentStateSettings()},this.saveCameraParam=(e,t)=>{_context.stateStore&&_context.stateStore.saveCameraParam(e,t)},this.getCameraDuration=()=>this.defaultView._camera.duration?this.defaultView._camera.duration:1.5,this.addBillboard=function(t,r,n,i){e.remove(t);var a=new Group;if(a.renderOrder=DRAWABLE_RENDER_ORDER_BASE+("number"==typeof r.renderOrder?r.renderOrder:0),a.position.set(r.pos.x,r.pos.y,r.pos.z),r.background){let e=_context.loaders.textureLoader.load(util$1.url(_context.instance.resourceBasePath,"texture/iconBackground/"+r.background+".png"));var o=new SpriteMaterial({map:e,color:new Color(r.backgroundColor),fog:DRAWABLE_FOG,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest,alphaTest:.1,transparent:!0,sizeAttenuation:r.sizeAttenuation,polygonOffset:r.polygonOffset,polygonOffsetFactor:r.polygonOffsetFactor,polygonOffsetUnits:r.polygonOffsetUnits}),s=new Sprite(o);s.onBeforeRender=function(){this.userData.inView=!0},s.name=t,s.scale.set(r.sizeAttenuation?Number(r.width)/30:Number(r.width)/3e3,r.sizeAttenuation?Number(r.height)/30:Number(r.height)/3e3,1);let n=-.1;if(s.center=new Vector2(r.offsetV/30*n+.5,r.offsetH/30*n+.5),r.backgroundColor&&"rgba"===r.backgroundColor.substring(0,4)){let e=r.backgroundColor.slice(4);e=e.split(","),e=parseFloat(e[3].replace(/[^0-9.]/gi,"")),s.material.opacity=e}a.add(s)}else a.add(new Group);return m.textureLoader.load(r.path,(o=>{var s=new SpriteMaterial({map:o,color:new Color("#ffffff"),fog:DRAWABLE_FOG,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest,alphaTest:.1,transparent:!0,sizeAttenuation:r.sizeAttenuation,polygonOffset:r.polygonOffset,polygonOffsetFactor:r.polygonOffsetFactor,polygonOffsetUnits:r.polygonOffsetUnits}),l=new Sprite(s);l.onBeforeRender=function(){this.userData.inView=!0},l.name=t,l.scale.set(r.sizeAttenuation?Number(r.width)/50:Number(r.width)/5e3,r.sizeAttenuation?Number(r.height)/50:Number(r.height)/5e3,1),a.add(l),l.center.set(r.offsetV,r.offsetH);null!=n&&n.enableText?Q(a,n).name=t:a.add(new Group),null!=r.enableAutoHidebyDistance&&(a.activeVisible=!0,a.enableAutoHidebyDistance=r.enableAutoHidebyDistance,a.minDistance=r.pointMinDistance*_context.worldScale,a.maxDistance=r.pointMaxDistance*_context.worldScale,_context.animationStore.addDistance(t,DistanceController,_context.camera,a)),e.add(t,a),r.isShow?(a.visible=!0,a.activeVisible=!0):(a.visible=!1,a.activeVisible=!1),i&&i(a)})),a};let Q=(t,r)=>{var n;if(null!=r){var i=r.canvas,a=new CanvasTexture(i),o=new SpriteMaterial({map:a,color:16777215,fog:DRAWABLE_FOG,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest,sizeAttenuation:r.sizeAttenuation});if((n=new Sprite(o)).onBeforeRender=function(){this.userData.inView=!0},n.scale.set(r.sizeAttenuation?.045*r.canvas.width:405e-6*r.canvas.width,r.sizeAttenuation?.045*r.canvas.height:405e-6*r.canvas.height,1),"left"===r.labelAlignment){let e=t.children[1].material.map.image.width,i=e/t.children[1].scale.x,o=a.image.width;e=e/i*(o/n.scale.x);let s=e/1.8/o*-1;n.center.set(s,r.offsetH)}else n.center.set(r.offsetV,r.offsetH);return n.visible=r.enableText,t?t.add(n):e.add(n),n}};this.updateBillboard=function(t,r,n,i){let a=e.find(t);if(null!=a){if(a.position.set(r.pos.x,r.pos.y,r.pos.z),r.background){let e=a.children[0];e.material.color=new Color(r.backgroundColor),e.material.map=_context.loaders.textureLoader.load(util$1.url(_context.instance.resourceBasePath,"texture/iconBackground/"+r.background+".png")),e.material.sizeAttenuation=r.sizeAttenuation,e.scale.set(r.sizeAttenuation?Number(r.width)/30:Number(r.width)/3e3,r.sizeAttenuation?Number(r.height)/30:Number(r.height)/3e3,1),e.material.depthWrite=_context.drawableDepthTest,e.material.depthTest=_context.drawableDepthTest;let t=-.1;e.center=new Vector2(r.offsetV/30*t+.5,r.offsetH/30*t+.5)}else a.children[0].traverse((e=>{e.geometry&&e.geometry.dispose(),e.material&&(e.material.dispose(),e.material.map&&e.material.map.dispose())})),a.children[0]=new Group;let e=a.children[1];e.material.sizeAttenuation=r.sizeAttenuation,e.scale.set(r.sizeAttenuation?Number(r.width)/50:Number(r.width)/5e3,r.sizeAttenuation?Number(r.height)/50:Number(r.height)/5e3,1),e.center.set(r.offsetV,r.offsetH),_context.loaders.textureLoader.load(r.path,(o=>{if(e.material.map=o,e.material.depthWrite=_context.drawableDepthTest,e.material.depthTest=_context.drawableDepthTest,null!=a.children[1]&&a.children[1])if(null!=n&&n)if(n.enableText){let r=new CanvasTexture(n.canvas),i=a.children[2];i.isGroup&&(a.remove(i),i=Q(a,n),i.name=t);let o=i.material;if(o.map=r,o.sizeAttenuation=n.sizeAttenuation,i.scale.set(n.sizeAttenuation?.045*n.canvas.width:405e-6*n.canvas.width,n.sizeAttenuation?.045*n.canvas.height:405e-6*n.canvas.height,1),"left"===n.labelAlignment){let t=e.material.map.image.width,a=t/e.scale.x,o=r.image.width;t=t/a*(o/i.scale.x);let s=t/1.75/o*-1;i.center.set(s,n.offsetH)}else i.center.set(n.offsetV,n.offsetH);i.visible=n.enableText}else a.children[2]=new Group;else a.children[2]=new Group;else if(n.enableText){X(a,n).name=t}null!=r.enableAutoHidebyDistance&&(a.activeVisible=!0,a.enableAutoHidebyDistance=r.enableAutoHidebyDistance,a.minDistance=r.pointMinDistance*_context.worldScale,a.maxDistance=r.pointMaxDistance*_context.worldScale,_context.animationStore.addDistance(t,DistanceController,_context.camera,a)),a.visible=r.isShow,a.activeVisible=r.isShow,i&&i(1)}))}},this.selectBillboard=function(t,r){var n=e.find(t);if(n&&r&&null==n.children[3]){var i=n.children[1],a=m.textureLoader.load(util$1.url(this.resourceBasePath,r.path)),o=new SpriteMaterial({map:a,color:16777215,fog:!1,sizeAttenuation:i.material.sizeAttenuation,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:-3e4,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest}),s=new Sprite(o);s.name=t+"_selector",s.position.set(i.position.x,i.position.y,i.position.z),s.scale.set(.02304/n.scale.x,.02304/n.scale.y,1),s.center=new Vector2(.5,.5),n.add(s)}},this.deselectBillboard=function(t){var r=e.find(t);if(!r)return;if(null==r.children[3])return;let n=r.children[3];n.material.map.dispose(),n.material.dispose(),n.geometry.dispose(),r.remove(n)},this.deselectAllBillboard=function(){e.forEach((e=>{for(let t of e.children)if(-1!=t.name.indexOf("_selector")){t.material.dispose(),t.geometry.dispose(),e.remove(t);break}}))},this.addBillboard3D=function(t,r,n){if(!t)return!1;if(!t.name)return!1;let i=t.name;e.remove(i);let a=new Group;a.name=i,e.add(i,a),a.position.set(t.position.x,t.position.y,t.position.z),a.scale.set(t.scale,t.scale,t.scale);let o=MathUtils.degToRad(t.rotation.x),s=MathUtils.degToRad(t.rotation.y),l=MathUtils.degToRad(t.rotation.z);if(a.rotation.set(o,s,l),t.enableAutoHidebyDistance&&(a.enableAutoHidebyDistance=t.enableAutoHidebyDistance,a.minDistance=t.minVisibleDistance*_context.worldScale,a.maxDistance=t.maxVisibleDistance*_context.worldScale,_context.animationStore.addDistance(i,DistanceController,_context.camera,a)),t.visible=t.isShow,r){let e=new PlaneGeometry(r.width,r.height,1,1),n=new MeshStandardMaterial,o=m.textureLoader.load(r.path);n.map=o,n.transparent=!0,n.side=DoubleSide,n.depthTest=t.depthTest,n.color.r*=r.brightness,n.color.g*=r.brightness,n.color.b*=r.brightness;let s=new Mesh(e,n);mesh.onBeforeRender=function(){this.userData.inView=!0},s.position.set(r.offset.x,r.offset.y,r.offset.z),s.scale.set(r.scale,r.scale,r.scale),s.visible=r.isShow,s.name=`${i}-icon`,a.add(s)}if(n){let e=new Text;e.text=n.content,e.font=n.font,e.fontSize=n.size,e.anchorX=n.alignment,e.anchorY="middle";let r=new Color(n.color);r.r*=n.brightness,r.g*=n.brightness,r.b*=n.brightness,e.color="#"+r.getHexString(),e.material.depthTest=t.depthTest,e.position.x=n.offset.x,e.position.y=n.offset.y,e.position.z=n.offset.z+.1,e.visible=n.isShow,e.name=`${i}-text`,a.add(e),e.sync()}},this.updateBillboard3D=function(t,r,n){if(!t)return;let i=e.find(t.name);if(!t)return;i.position.set(t.position.x,t.position.y,t.position.z),i.scale.set(t.scale,t.scale,t.scale);let a=MathUtils.degToRad(t.rotation.x),o=MathUtils.degToRad(t.rotation.y),s=MathUtils.degToRad(t.rotation.z);i.rotation.set(a,o,s),t.enableAutoHidebyDistance&&(i.enableAutoHidebyDistance=t.enableAutoHidebyDistance,i.minDistance=t.minVisibleDistance*_context.worldScale,i.maxDistance=t.maxVisibleDistance*_context.worldScale,_context.animationStore.addDistance(name,DistanceController,_context.camera,i)),t.visible=t.isShow;let l=i.children[0];if(r&&l){l.geometry=new PlaneGeometry(r.width,r.height,1,1);let e=l.material,n=m.textureLoader.load(r.path);e.map=n,e.transparent=!0,e.side=DoubleSide,e.depthTest=t.depthTest,e.color.r*=r.brightness,e.color.g*=r.brightness,e.color.b*=r.brightness,l.position.set(r.offset.x,r.offset.y,r.offset.z),l.scale.set(r.scale,r.scale,r.scale),l.visible=r.isShow}let c=i.children[1];if(n&&c){c.text=n.content,c.font=n.font,c.fontSize=n.size,c.anchorX=n.alignment,c.anchorY="middle";let e=new Color(n.color);e.r*=n.brightness,e.g*=n.brightness,e.b*=n.brightness,c.color="#"+e.getHexString(),c.material.depthTest=t.depthTest,c.position.x=n.offset.x,c.position.y=n.offset.y,c.position.z=n.offset.z+.1,c.visible=n.isShow,c.sync()}},this.addBar=function(t,r,n){e.remove(t);var i,a=new Group;a.renderOrder=DRAWABLE_RENDER_ORDER_BASE+("number"==typeof r.renderOrder?r.renderOrder:0),i="bar"==r.type||null==r.type?new BoxGeometry(1,1,1):new CylinderGeometry(.5,.5,1,32);let o=new MeshPhongMaterial({fog:DRAWABLE_FOG,opacity:r.alpha,transparent:!0,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest});if(o.color=new Color(r.color),o.emissive=new Color(r.color),o.emissiveIntensity=r.brightness,"linear"===r.columnPaint){o.vertexColors=!0;let e=util$1.colorToRGBAObject(r.colorMax),t=util$1.colorToRGBAObject(r.colorMin),n=new Color((e.r-t.r)/2+t.r,(e.g-t.g)/2+t.g,(e.b-t.b)/2+t.b);o.color=new Color("0xffffff"),o.emissive=n,o.emissiveIntensity=1.5*r.brightness;let a=[];for(let e=0;e<i.attributes.position.count;e++)a.push(1,1,1);i.setAttribute("color",new Float32BufferAttribute(a,3)),a=i.attributes.color;let s=new Color(r.colorMax),l=new Color(r.colorMin);for(let e=0;e<i.attributes.position.count;e++)i.attributes.position.array[3*e+1]>=.5?(a.setXYZ(e,s.r,s.g,s.b),a.setXYZ(e+1,s.r,s.g,s.b),a.setXYZ(e+2,s.r,s.g,s.b)):(a.setXYZ(e,l.r,l.g,l.b),a.setXYZ(e+1,l.r,l.g,l.b),a.setXYZ(e+2,l.r,l.g,l.b));a.needsUpdate=!0}var s=new Mesh(i,o);s.needsUpdate=!0,s.onBeforeRender=function(){this.userData.inView=!0},a.position.set(r.pos.x,r.pos.y+r.value*_context.worldScale*.5,r.pos.z),s.scale.set(r.width*_context.worldScale,r.value*_context.worldScale,r.width*_context.worldScale),r.alpha>0&&(s.castShadow=!0),a.add(s),s.name=t;var l=null;null!=n&&n.enableText&&((l=X(a,n)).name=t,l.position.y=r.value*_context.worldScale*.5),null!=r.enableAutoHidebyDistance&&(a.activeVisible=!0,a.enableAutoHidebyDistance=r.enableAutoHidebyDistance,a.minDistance=r.minDistance*_context.worldScale,a.maxDistance=r.maxDistance*_context.worldScale,_context.animationStore.addDistance(t,DistanceController,_context.camera,a)),e.add(t,a),r.isShow?(a.visible=!0,a.activeVisible=!0,!n.enableText&&l&&(l.visible=!1)):(a.visible=!1,a.activeVisible=!1,l&&(l.visible=!1))},this.addInstancedBar=function(t,r,n){e.remove(t);var i=new Group;i.renderOrder=2;var a=new Mesh("bar"==r.type||null==r.type?new BoxGeometry(1,1,1):new CylinderGeometry(.5,.5,1,32),new MeshPhongMaterial({fog:DRAWABLE_FOG,color:new Color(r.color),opacity:r.alpha,emissive:new Color(r.color),emissiveIntensity:r.brightness,transparent:!0,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest}));i.position.set(r.pos.x,r.pos.y+r.value*_context.worldScale*.5,r.pos.z),a.scale.set(r.width*_context.worldScale,r.value*_context.worldScale,r.width*_context.worldScale),r.alpha>0&&(a.castShadow=!0),i.add(a),a.name=t;var o=null;null!=n&&n.enableText&&((o=X(i,n)).name=t),null!=r.enableAutoHidebyDistance&&(i.activeVisible=!0,i.enableAutoHidebyDistance=r.enableAutoHidebyDistance,i.minDistance=r.minDistance*_context.worldScale,i.maxDistance=r.maxDistance*_context.worldScale,_context.animationStore.addDistance(t,DistanceController,_context.camera,i)),e.add(t,i),r.isShow?(i.visible=!0,i.activeVisible=!0,!n.enableText&&o&&(o.visible=!1)):(i.visible=!1,i.activeVisible=!1,o&&(o.visible=!1))},this.addBubble=function(t,r,n,i){_context.loaders.textureLoader.load(util$1.url(this.resourceBasePath,"texture/bubble/bubble.png"),(a=>{var o=new Group;o.renderOrder=DRAWABLE_RENDER_ORDER_BASE+("number"==typeof r.renderOrder?r.renderOrder:0);var s=new CircleGeometry(1,32),l=new MeshBasicMaterial({fog:DRAWABLE_FOG,color:r.color,opacity:Number(r.alpha),transparent:!0,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest});l.alphaMap=a;var c=new Mesh(s,l);c.onBeforeRender=function(){this.userData.inView=!0},c.name=t,o.add(c),o.position.set(r.pos.x,r.pos.y,r.pos.z),c.rotateX(-.5*Math.PI);let h=_context.animationStore.findNodeAnimation(t,NodeScaleAnimationController.type);h&&_context.animationStore.remove(h),h=new NodeScaleAnimationController(c,0,r.value*_context.worldScale,r.value*_context.worldScale*.8,r.diffSpeed*_context.worldScale,!0),_context.animationStore.add(h);var u=null;null!=n&&n.enableText&&((u=X(o,n)).name=t),null!=r.enableAutoHidebyDistance&&(o.activeVisible=!0,o.enableAutoHidebyDistance=r.enableAutoHidebyDistance,o.minDistance=r.minDistance*_context.worldScale,o.maxDistance=r.maxDistance*_context.worldScale,_context.animationStore.addDistance(t,DistanceController,_context.camera,o)),e.add(t,o),r.isShow?(o.visible=!0,o.activeVisible=!0,!n.enableText&&u&&(u.visible=!1)):(o.visible=!1,o.activeVisible=!1,u&&(u.visible=!1)),i&&i(1)}))},this.addInstancedBubble=function(t,r,n,i){if(!(r.points instanceof Array))return void(i&&i(0));let a="none"===r.fillArea.toLowerCase()?"texture/bubble/bubble.png":`texture/bubble/fill/${r.fillArea.toLowerCase()}.jpg`;_context.loaders.textureLoader.load(util$1.url(this.resourceBasePath,a),(n=>{var a=new Group;a.renderOrder=DRAWABLE_RENDER_ORDER_BASE+("number"==typeof r.renderOrder?r.renderOrder:0);var o=new CircleGeometry(1,32);o.rotateX(Math.PI/-2);let s=new InstancedMesh(o,new MeshBasicMaterial({alphaMap:n,fog:DRAWABLE_FOG,opacity:1,transparent:!0,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest}),INSTANCE_COUNT_MAX);s.count=r.points.length,s.name=t,s.onBeforeRender=function(){this.userData.inView=!0},s.instanceMatrix.setUsage(DynamicDrawUsage),s.visible=[],s.activeVisible=[],s.hideByDistance=[],s.minDistances=[],s.maxDistances=[],s.userData.names=r.points.map((e=>e.name));let l=new Object3D;for(let e=0;e<r.points.length;e++){"boolean"==typeof r.points[e].isShow?s.visible[e]=r.points[e].isShow:s.visible[e]=!0,l.position.set(r.points[e].position.x,r.points[e].position.y,r.points[e].position.z),l.scale.set(1,1,1),l.updateMatrix(),s.setMatrixAt(e,l.matrix.clone()),s.setColorAt(e,new Color(r.points[e].color));let n=_context.animationStore.findInstancedAnimation(s,e,InstancedBubbleAnimationController.type);n&&_context.animationStore.remove(n),null!=r.points[e].enableAutoHidebyDistance&&(s.activeVisible[e]=!0,s.hideByDistance[e]=r.points[e].enableAutoHidebyDistance,s.minDistances[e]=r.points[e].minDistance*_context.worldScale,s.maxDistances[e]=r.points[e].maxDistance*_context.worldScale),n=new InstancedBubbleAnimationController(s,e,0,r.points[e].value*_context.worldScale,.8*r.points[e].value*_context.worldScale,r.points[e].diffSpeed*_context.worldScale,!1,_context.camera),_context.animationStore.add(n);var c=null;null!=r.points[e].textParam&&r.points[e].textParam.enableText&&((c=X(a,r.points[e].textParam)).position.set(r.points[e].position.x,r.points[e].position.y,r.points[e].position.z),c.name=`__bubble_${t}_${e}`,c.renderOrder=DRAWABLE_RENDER_ORDER_BASE+("number"==typeof r.renderOrder?r.renderOrder:0),a.add(c),null!=r.points[e].enableAutoHidebyDistance&&(c.activeVisible=!0,c.enableAutoHidebyDistance=r.points[e].enableAutoHidebyDistance,c.minDistance=r.points[e].minDistance*_context.worldScale,c.maxDistance=r.points[e].maxDistance*_context.worldScale,_context.animationStore.addDistance(`__bubble_dc_${t}_${e}`,DistanceController,_context.camera,c))),r.isShow?!r.points[e].textParam.enableText&&c&&(c.visible=!1):c&&(c.visible=!1)}s.instanceColor.needsUpdate=!0,s.instanceMatrix.needsUpdate=!0,a.add(s),a.instancedBubble=s,e.add(t,a),r.isShow?(a.visible=!0,a.activeVisible=!0):(a.visible=!1,a.activeVisible=!1),i&&i(1)}))},this.updateInstancedBubble=function(t,r,n,i){let a=_context.objectStore.find(t);if(!a)return;"number"==typeof r.renderOrder&&(a.renderOrder=DRAWABLE_RENDER_ORDER_BASE+r.renderOrder);let o=a.instancedBubble;if(!o)return;if(!(r.points instanceof Array))return;o.count=r.points.length,o.name=t,o.onBeforeRender=function(){this.userData.inView=!0},o.instanceMatrix.setUsage(DynamicDrawUsage),o.activeVisible=[],o.hideByDistance=[],o.minDistances=[],o.maxDistances=[];let s=new Object3D;for(let e=0;e<r.points.length;e++){s.position.set(r.points[e].position.x,r.points[e].position.y,r.points[e].position.z),s.scale.set(1,1,1),s.updateMatrix(),o.setMatrixAt(e,s.matrix.clone()),o.setColorAt(e,new Color(r.points[e].color));let n=_context.animationStore.findInstancedAnimation(o,e,InstancedBubbleAnimationController.type);n&&_context.animationStore.remove(n),null!=r.points[e].enableAutoHidebyDistance&&(o.activeVisible[e]=!0,o.hideByDistance[e]=r.points[e].enableAutoHidebyDistance,o.minDistances[e]=r.points[e].minDistance*_context.worldScale,o.maxDistances[e]=r.points[e].maxDistance*_context.worldScale),n=new InstancedBubbleAnimationController(o,e,0,r.points[e].value*_context.worldScale,.8*r.points[e].value*_context.worldScale,r.points[e].diffSpeed*_context.worldScale,!1,_context.camera),_context.animationStore.add(n);var l=null;null!=r.points[e].textParam&&r.points[e].textParam.enableText&&((l=X(bubbleGroup,r.points[e].textParam)).position.set(r.points[e].position.x,r.points[e].position.y,r.points[e].position.z),l.name=`__bubble_${t}_${e}`,l.renderOrder=DRAWABLE_RENDER_ORDER_BASE+("number"==typeof r.renderOrder?r.renderOrder:0),bubbleGroup.add(l),null!=r.points[e].enableAutoHidebyDistance&&(l.activeVisible=!0,l.enableAutoHidebyDistance=r.points[e].enableAutoHidebyDistance,l.minDistance=r.points[e].minDistance*_context.worldScale,l.maxDistance=r.points[e].maxDistance*_context.worldScale,_context.animationStore.addDistance(`__bubble_dc_${t}_${e}`,DistanceController,_context.camera,l)))}o.instanceColor.needsUpdate=!0,o.instanceMatrix.needsUpdate=!0,bubbleGroup.add(o),e.add(t,bubbleGroup)},this.removeInstancedBubble=function(t){let r=_context.objectStore.find(t);if(!r)return;let n=r.instancedBubble;if(n){for(let e=0;e<n.count;e++){let t=_context.animationStore.findInstancedAnimation(n,e,InstancedBubbleAnimationController.type);t&&_context.animationStore.remove(t)}n.geometry.dispose();for(let e in n.material)n.material[e]instanceof Texture$1&&n.material[e].dispose();n.material.dispose(),n.dispose(),r.remove(n);for(let e of r.children){for(let t in e.material)e.material[t]instanceof Texture$1&&e.material[t].dispose();r.remove(e)}e.remove(t)}},this.addODLine=function(t,r,n,i){var a=new Group;let o,s,l,c;a.renderOrder=DRAWABLE_RENDER_ORDER_BASE+("number"==typeof r.renderOrder?r.renderOrder:0),a.name=t,o=new Vector3(r.startPos.x,r.startPos.y,r.startPos.z),c=new Vector3(r.endPos.x,r.endPos.y,r.endPos.z),s=new Vector3,l=new Vector3;var h=c.clone().add(o.clone().divideScalar(-1));s.lerpVectors(o,c,.25),l.lerpVectors(o,c,.75),s.setY(s.y+h.length()*parseFloat(r.curvatureCoefficient/100)),l.setY(l.y+h.length()*parseFloat(r.curvatureCoefficient/100));let u=new CubicBezierCurve3(o,s,l,c);var d=u.getPoints(32),p=u.getPointAt(.5);let f=[];d.forEach((e=>{f.push(e.x),f.push(e.y),f.push(e.z)}));let m="texture/odline/"+r.imageType.toLowerCase()+".jpg";_context.loaders.textureLoader.load(util$1.url(this.resourceBasePath,m),(o=>{o.wrapS=RepeatWrapping,o.wrapT=RepeatWrapping;let s=util$1.interpolate(f,3,50,!0)/(r.lineWidth*_context.worldScale/o.image.height*o.image.width);"default"===r.imageType.toLowerCase()?s/=4:"ray"===r.imageType.toLowerCase()&&(s=1);var l=new THREE_MeshLine.MeshLineMaterial({fog:DRAWABLE_FOG,map:o,maskMap:o,useMaskMap:!0,color:new Color(r.color),opacity:1,resolution:new Vector2(window.innerWidth,window.innerHeight),sizeAttenuation:1,lineWidth:r.lineWidth*_context.worldScale,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest,alphaTest:.05,transparent:!0,side:DoubleSide,repeat:new Vector2(s,1)}),c=new THREE_MeshLine.MeshLine;c.setGeometry(d);var h=new Mesh(c.geometry,l);h.onBeforeRender=function(){this.userData.inView=!0};let u=new UVMeshLineAnimationController(l,!0,!1,-r.animationSpeed*_context.worldScale/20,0);_context.animationStore.add(u),h.material.uniforms.dashOffset.value=1.5,h.labelPoint=p,h.raycast=c.raycast,h.name=t,a.add(h),a.position.set(h.position.x,h.position.y,h.position.z),a.userData.mesh=h;var m=null;null!=n&&n.enableText&&((m=X(a,n)).position.set(p.x,p.y,p.z),m.name=t),null!=r.enableAutoHidebyDistance&&(a.activeVisible=!0,a.distance=new Vector3,a.distance.set(p.x,p.y,p.z),a.enableAutoHidebyDistance=r.enableAutoHidebyDistance,a.minDistance=r.minDistance*_context.worldScale,a.maxDistance=r.maxDistance*_context.worldScale,_context.animationStore.addDistance(t,DistanceController,_context.camera,a)),e.add(t,a),r.isShow?(a.visible=!0,a.activeVisible=!0,!n.enableText&&m&&(m.visible=!1)):(a.visible=!1,a.activeVisible=!1,m&&(m.visible=!1)),i&&i(1,p)}))},this.addHeatMapLayer=function(t,r){var n=document.createElement("canvas");n.width=r.width,n.height=r.height,0==r.opacity&&(r.opacity=1e-7);var i=heatmap.create({container:n,gradient:r.gradient,opacity:r.opacity,radius:10,blur:.75,width:r.width,height:r.height}),a=n.getElementsByTagName("canvas")[0];let o=new PlaneGeometry(r.width,r.height),s=new Texture$1(a),l=new ShaderMaterial({fog:DRAWABLE_FOG,uniforms:{map:{value:s},bgMap:{value:u},color:{value:new Color(1,1,1)},brightness:{value:1}},vertexShader:HeatmapShader.vertexShader,fragmentShader:HeatmapShader.fragmentShader,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest,transparent:!0});if("dot"===r.style){var c=_context.loaders.textureLoader.load(util$1.url(this.resourceBasePath,"texture/heatmap/heatmap-dot.png"));c.wrapS=RepeatWrapping,c.wrapT=RepeatWrapping,l.uniforms.bgMap.value=c}else if("line"===r.style){var h=_context.loaders.textureLoader.load(util$1.url(this.resourceBasePath,"texture/heatmap/heatmap-line.png"));h.wrapS=RepeatWrapping,h.wrapT=RepeatWrapping,l.uniforms.bgMap.value=h}else{var u=_context.loaders.textureLoader.load(util$1.url(this.resourceBasePath,"texture/heatmap/heatmap-none.png"));u.wrapS=RepeatWrapping,u.wrapT=RepeatWrapping,l.uniforms.bgMap.value=u}l.uniforms.map.value.needsUpdate=!0;var d=new Mesh(o,l);d.onBeforeRender=function(){this.userData.inView=!0},d.name=t,d.rotation.x=-Math.PI/2+r.rotation.x,d.rotation.y=r.rotation.y,d.rotation.z=r.rotation.z,d.position.set(r.pos.x,r.pos.y,r.pos.z),null!=r.enableAutoHidebyDistance&&(d.activeVisible=!0,d.enableAutoHidebyDistance=r.enableAutoHidebyDistance,d.minDistance=r.minDistance*_context.worldScale,d.maxDistance=r.maxDistance*_context.worldScale,_context.animationStore.addDistance(t,DistanceController,_context.camera,d));let p=new Group;p.renderOrder=DRAWABLE_RENDER_ORDER_BASE+("number"==typeof r.renderOrder?r.renderOrder:0),p.name=t,p.add(d),p.userData={dom:a,heatmap:i,plane:d},e.add(t,p),r.isShow?(p.activeVisible=!0,p.visible=!0):(p.activeVisible=!1,p.visible=!1)},this.updateHeatMapData=function(t,r,n,i,a=1){var o=e.find(t);if(null!=o.userData){var s=o.userData.heatmap;null!=s&&s.setData({min:r,max:n,data:i});var l=o.userData.plane;l.scale.set(a*_context.worldScale,a*_context.worldScale,a*_context.worldScale);var c=o.userData.dom;if(null!=l&&null!=c){let e=new Texture$1(c);l.material.uniforms.map.value=e,l.material.uniforms.map.value.needsUpdate=!0}}},this.addArea=function(t,r,n,i){if(r.areaType)return void Z.call(this,t,r,n,i);var a=new Group;a.renderOrder=DRAWABLE_RENDER_ORDER_BASE+("number"==typeof r.renderOrder?r.renderOrder:0),a.name=t;for(var o=[],s=0;s<r.point.length;s+=2)o.push(new Vector2(r.point[s],r.point[s+1]));o.push(new Vector2(r.point[0],r.point[1]));var l,c,h=new Shape(o),u={depth:r.depth*_context.worldScale,bevelEnabled:!1,bevelSegments:1,steps:1,bevelSize:1,bevelThickness:10},d=new Mesh(new ExtrudeGeometry(h,u),new MeshBasicMaterial({fog:DRAWABLE_FOG,transparent:!0,color:new Color(r.color),shininess:0,opacity:r.alpha,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest}));d.onBeforeRender=function(){this.userData.inView=!0},d.name=t,a.add(d),d.geometry.computeBoundingSphere(),d.updateMatrixWorld(!0),null!=d.geometry.boundingSphere&&(l=d.geometry.boundingSphere.center),c=r.followPolygonColor?new Color(r.color):new Color(r.lineColor);var p=new LineMaterial({fog:DRAWABLE_FOG,opacity:r.lineAlpha,color:c,linewidth:r.lineWidth*_context.worldScale,dashed:!1,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest,transparent:!0});r.lineFlag||(p.visible=!1);for(var f=new LineGeometry,m=[],g=0;g<o.length;g++)m.push(o[g].x),m.push(o[g].y),m.push(0);f.setPositions(m);var y=new Line2(f,p);y.computeLineDistances(),y.scale.set(1,1,1),y.name=t,a.add(y);var v=null;null!=n&&n.enableText&&((v=X(a,n)).name=t,v.position.set(l.x,l.y,l.z)),a.rotation.set(.5*Math.PI,0,0),r.offset&&a.position.set(r.lonOffset,r.altOffset,r.latOffset),null!=r.enableAutoHidebyDistance&&(a.activeVisible=!0,a.enableAutoHidebyDistance=r.enableAutoHidebyDistance,a.minDistance=r.minDistance*_context.worldScale,a.maxDistance=r.maxDistance*_context.worldScale,_context.animationStore.addDistance(t,DistanceController,_context.camera,a));let b=_context.animationStore.findNodeAnimation(t,AreaLineAnimationController.type);b&&_context.animationStore.remove(b);let _=new Vector2(window.innerWidth,window.innerHeight);b=new AreaLineAnimationController(p,_),_context.animationStore.add(b),e.add(t,a),r.isShow?(a.activeVisible=!0,a.visible=!0,!n.enableText&&v&&(v.visible=!1)):(a.activeVisible=!1,a.visible=!1,v&&(v.visible=!1))},this.addTrail=function(t,r,n,i){var a=new Group;if(a.renderOrder=DRAWABLE_RENDER_ORDER_BASE+("number"==typeof r.renderOrder?r.renderOrder:0),a.name=t,r.background){let e=_context.loaders.textureLoader.load(util$1.url(_context.instance.resourceBasePath,"texture/iconBackground/"+r.background+".png")),n=new SpriteMaterial({map:e,color:new Color(r.backgroundColor),fog:DRAWABLE_FOG,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest,transparent:!0,sizeAttenuation:r.sizeAttenuation}),i=new Sprite(n);if(i.onBeforeRender=function(){this.userData.inView=!0},i.name=t,i.scale.set(r.sizeAttenuation?Number(r.width)/25:Number(r.width)/2500,r.sizeAttenuation?Number(r.height)/25:Number(r.height)/2500,1),i.center=new Vector2(r.offsetV,r.offsetH),r.backgroundColor&&"rgba"===r.backgroundColor.substring(0,4)){let e=r.backgroundColor.slice(4);e=e.split(","),e=parseFloat(e[3].replace(/[^0-9.]/gi,"")),i.material.opacity=e}i.renderOrder=-1,a.add(i)}else a.add(new Group);_context.loaders.textureLoader.load(r.path,(o=>{var s=new SpriteMaterial({map:o,color:new Color("#ffffff"),fog:DRAWABLE_FOG,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest,sizeAttenuation:r.sizeAttenuation});let l=new Sprite(s);l.onBeforeRender=function(){this.userData.inView=!0},l.scale.set(r.sizeAttenuation?Number(r.width)/50:Number(r.width)/5e3,r.sizeAttenuation?Number(r.height)/50:Number(r.height)/5e3,1),r.useIconAsset?l.center=new Vector2(r.offsetV,r.offsetH-.5):l.center=new Vector2(r.offsetV,r.offsetH),l.name=t,r.isShow||(l.visible=!1),a.add(l);var c=null;null!=n&&n.enableText?(c=Q(a,n)).name=t:a.add(new Group),a.position.set(r.pos.x,r.pos.y,r.pos.z),a.userData.startPos=r.pos,a.userData.targetPos=r.pos,A.add(t,a);var h=[];h.push(r.pos.x),h.push(r.pos.y),h.push(r.pos.z);var u=new THREE_MeshLine$1.MeshLine,d=_context.loaders.textureLoader.load(util$1.url(this.resourceBasePath,"texture/trail/trail.png"));d.wrapS=ClampToEdgeWrapping,d.wrapT=ClampToEdgeWrapping,d.repeat.set(1,1);var p=new Vector2(window.innerWidth,window.innerHeight);u.setPoints(h);s=new THREE_MeshLine.MeshLineMaterial({fog:DRAWABLE_FOG,map:d,useMap:!0,color:new Color(r.color),opacity:1,dashArray:0,dashOffset:1,dashRatio:0,resolution:p,sizeAttenuation:0,lineWidth:r.lineWidth*_context.worldScale,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest,alphaTest:r.strokes?.5:0,transparent:!0,side:DoubleSide,repeat:new Vector2(1,1)});var f=new Mesh(u.geometry,s);f.onBeforeRender=function(){this.userData.inView=!0},r.lineShowHidden&&r.isShow?f.visible=!0:f.visible=!1,e.add(t+"Line",f),a.userData.mesh=f,a.userData.currentTime=0,a.userData.trailDuration=r.duration;var m=new TrailController(a);let g=_context.animationStore.findLayerAnimation(t,TrailAnimationController.type);g&&_context.animationStore.remove(g),g=new TrailAnimationController(A,m,t),_context.animationStore.add(g),null!=r.enableAutoHidebyDistance&&(a.activeVisible=!0,a.enableAutoHidebyDistance=r.enableAutoHidebyDistance,a.minDistance=r.pointMinDistance*_context.worldScale,a.maxDistance=r.pointMaxDistance*_context.worldScale,_context.animationStore.addDistance(t,DistanceController,_context.camera,a),f.activeVisible=!0,f.enableAutoHidebyDistance=r.enableAutoHidebyDistance,f.minDistance=r.pointMinDistance*_context.worldScale,f.maxDistance=r.pointMaxDistance*_context.worldScale,_context.animationStore.addDistance(t+"Line",DistanceController,_context.camera,f)),e.add(t,a),r.isShow?(a.activeVisible=!0,a.visible=!0,f.activeVisible=!0,f.visible=!0,!n.enableText&&c&&(c.visible=!1)):(a.activeVisible=!1,a.visible=!1,f.activeVisible=!1,f.visible=!1,c&&(c.visible=!1)),i&&i(a)}))},this.updateTrail=function(t,r,n){var i=e.find(t),a=e.find(t+"Line");if(null!=i){if(i.userData.startPos=i.position.clone(),null!=r.pos&&(i.userData.targetPos=r.pos),i.userData.currentTime=0,i.userData.duration=Number(r.travelingTime),null!=r.duration&&r.duration&&(i.userData.trailDuration=r.duration),null!=r.enableAutoHidebyDistance&&(i.enableAutoHidebyDistance=r.enableAutoHidebyDistance,i.minDistance=r.pointMinDistance*_context.worldScale,i.maxDistance=r.pointMaxDistance*_context.worldScale,_context.animationStore.addDistance(t,DistanceController,_context.camera,i),a.enableAutoHidebyDistance=r.enableAutoHidebyDistance,a.minDistance=r.pointMinDistance*_context.worldScale,a.maxDistance=r.pointMaxDistance*_context.worldScale,_context.animationStore.addDistance(t+"Line",DistanceController,_context.camera,a)),null!=r.color&&r.color){let e=parseFloat(parseInt($(r.color).substring(0,2),16)/255),t=parseFloat(parseInt($(r.color).substring(2,4),16)/255),n=parseFloat(parseInt($(r.color).substring(4,6),16)/255);a.material.color.r=e,a.material.color.g=t,a.material.color.b=n}null!=r.lineWidth&&r.lineWidth&&(i.userData.mesh.material.lineWidth=r.lineWidth);let e=()=>{if(null!=i.children[2]&&i.children[2])if(null!=n&&n)if(n.enableText){let e=new CanvasTexture(n.canvas),t=i.children[2],a=t.material;if(a.map=e,a.sizeAttenuation=n.sizeAttenuation,t.scale.set(n.sizeAttenuation?.045*n.canvas.width:405e-6*n.canvas.width,n.sizeAttenuation?.045*n.canvas.height:405e-6*n.canvas.height,1),"left"===n.labelAlignment){let r=i.children[1].material.map.image.width,a=r/i.children[1].scale.x,o=e.image.width;r=r/a*(o/t.scale.x);let s=r/1.75/o*-1;t.center.set(s,n.offsetH)}else t.center.set(n.offsetV,n.offsetH);r.isShow?t.visible=n.enableText:t.visible=!1}else i.children.splice(2,1);else i.children.splice(2,1);else if(n.enableText){X(billboard,n).name=t}null==r.isShow||r.isShow?(i.visible=!0,i.activeVisible=!0,r.lineShowHidden?(i.userData.mesh.visible=!0,i.userData.mesh.activeVisible=!0):(i.userData.mesh.visible=!1,i.userData.mesh.activeVisible=!1)):(i.visible=!1,i.activeVisible=!1,r.isShow&&r.lineShowHidden?(i.userData.mesh.visible=!0,i.userData.mesh.activeVisible=!0):(i.userData.mesh.visible=!1,i.userData.mesh.activeVisible=!1))};if(r.useIconAsset){if(r.background)if(i.children[0]instanceof Group){let e=_context.loaders.textureLoader.load(util$1.url(_context.instance.resourceBasePath,"texture/iconBackground/"+r.background+".png")),n=new SpriteMaterial({map:e,color:new Color(r.backgroundColor),fog:DRAWABLE_FOG,depthWrite:_context.drawableDepthTest,depthTest:_context.drawableDepthTest,transparent:!0,sizeAttenuation:r.sizeAttenuation}),a=new Sprite(n);if(a.onBeforeRender=function(){this.userData.inView=!0},a.name=t,a.scale.set(r.sizeAttenuation?Number(r.width)/25:Number(r.width)/2500,r.sizeAttenuation?Number(r.height)/25:Number(r.height)/2500,1),a.center=new Vector2(r.offsetV,r.offsetH),r.backgroundColor&&"rgba"===r.backgroundColor.substring(0,4)){let e=r.backgroundColor.slice(4);e=e.split(","),e=parseFloat(e[3].replace(/[^0-9.]/gi,"")),a.material.opacity=e}a.renderOrder=-1,a.parent=i,i.children.splice(0,1),i.children.unshift(a)}else{let e=_context.loaders.textureLoader.load(util$1.url(_context.instance.resourceBasePath,"texture/iconBackground/"+r.background+".png"));i.children[0].material.map=e,i.children[0].material.color=new Color(r.backgroundColor),i.children[0].scale.set(r.sizeAttenuation?Number(r.width)/25:Number(r.width)/2500,r.sizeAttenuation?Number(r.height)/25:Number(r.height)/2500,1),i.children[0].center=new Vector2(r.offsetV,r.offsetH),i.children[0].renderOrder=-1}else i.children.splice(0,1),i.children.unshift(new Group);let n=_context.loaders.textureLoader.load(r.path);i.children[1].material.map=n,i.children[1].scale.set(r.sizeAttenuation?Number(r.width)/50:Number(r.width)/5e3,r.sizeAttenuation?Number(r.height)/50:Number(r.height)/5e3,1),i.children[1].center=new Vector2(r.offsetV,r.offsetH-.5),e()}else{i.children.splice(0,1),i.children.unshift(new Group);var o=r.path.substr(r.path.lastIndexOf("/")+1,r.path.length-r.path.lastIndexOf("/"));-1==i.children[1].material.map.image.src.indexOf(o)?_context.loaders.textureLoader.load(r.path,(t=>{i.children[1].material.map=t,i.children[1].scale.set(r.sizeAttenuation?Number(r.width)/50:Number(r.width)/5e3,r.sizeAttenuation?Number(r.height)/50:Number(r.height)/5e3,1),i.children[1].center=new Vector2(r.offsetV,r.offsetH),e()})):e()}}},this.removeLayer=function(t){var r=t.substr(t.lastIndexOf("/")+1,t.length-t.lastIndexOf("/"));"trail"==r&&(e.remove(t+"Line"),_context.animationStore.remove(_context.animationStore.findNodeAnimation(t+"Line",DistanceController.type)),_context.animationStore.remove(_context.animationStore.findNodeAnimation(t,TrailAnimationController.type))),"area"==r&&_context.animationStore.remove(_context.animationStore.findNodeAnimation(t,AreaLineAnimationController.type)),"odline"==r&&_context.animationStore.remove(_context.animationStore.findNodeAnimation(t,ODLineRollingAnimationController.type)),"bubble"==r&&_context.animationStore.remove(_context.animationStore.findNodeAnimation(t,NodeScaleAnimationController.type)),"instancedbubble"==r&&this.removeInstancedBubble(t),e.remove(t),_context.animationStore.remove(_context.animationStore.findNodeAnimation(t,DistanceController.type))},this.showLayer=function(t){e.find(t)&&(e.find(t).visible=!0,e.find(t).activeVisible=!0)},this.hideLayer=function(t){e.find(t)&&(e.find(t).visible=!1,e.find(t).activeVisible=!1)},this.addFireworks=function(e){e.type="fireworks",this.defaultEffectStore.spaceEffect.addEffect(e)},this.updateFireworks=function(e,t){t.type="fireworks",this.defaultEffectStore.spaceEffect.updateEffect(e,t)},this.showFireworks=function(e){this.defaultEffectStore.spaceEffect.showEffect(e)},this.hideFireworks=function(e){this.defaultEffectStore.spaceEffect.hideEffect(e)},this.renameFireworks=function(e,t){this.defaultEffectStore.spaceEffect.renameEffect(e,t)},this.removeFireworks=function(e){this.defaultEffectStore.spaceEffect.removeEffect(e)},this.addFirefly=function(e){e.type="firefly",this.defaultEffectStore.spaceEffect.addEffect(e)},this.addFireFly=function(e){return this.addFirefly(e)},this.updateFirefly=function(e,t){t.type="firefly",this.defaultEffectStore.spaceEffect.updateEffect(e,t)},this.updateFireFly=function(e,t){return this.updateFirefly(e,t)},this.showFirefly=function(e){this.defaultEffectStore.spaceEffect.showEffect(e)},this.showFireFly=function(e){return this.showFirefly(e)},this.hideFirefly=function(e){this.defaultEffectStore.spaceEffect.hideEffect(e)},this.hideFireFly=function(e){return this.hideFirefly(e)},this.renameFirefly=function(e,t){this.defaultEffectStore.spaceEffect.renameEffect(e,t)},this.renameFireFly=function(e,t){return this.renameFirefly(e,t)},this.removeFirefly=function(e){this.defaultEffectStore.spaceEffect.removeEffect(e)},this.removeFireFly=function(e){return this.removeFirefly(e)},this.addRainline=function(e){e.type="rainline",this.defaultEffectStore.spaceEffect.addEffect(e)},this.updateRainline=function(e,t){t.type="rainline",this.defaultEffectStore.spaceEffect.updateEffect(e,t)},this.showRainline=function(e){this.defaultEffectStore.spaceEffect.showEffect(e)},this.hideRainline=function(e){this.defaultEffectStore.spaceEffect.hideEffect(e)},this.renameRainline=function(e,t){this.defaultEffectStore.spaceEffect.renameEffect(e,t)},this.removeRainline=function(e){this.defaultEffectStore.spaceEffect.removeEffect(e)},this.addRain=function(e){e.type="rain",this.defaultEffectStore.spaceEffect.addEffect(e)},this.updateRain=function(e,t){t.type="rain",this.defaultEffectStore.spaceEffect.updateEffect(e,t)},this.showRain=function(e){this.defaultEffectStore.spaceEffect.showEffect(e)},this.hideRain=function(e){this.defaultEffectStore.spaceEffect.hideEffect(e)},this.renameRain=function(e,t){this.defaultEffectStore.spaceEffect.renameEffect(e,t)},this.removeRain=function(e){this.defaultEffectStore.spaceEffect.removeEffect(e)},this.addSnow=function(e){e.type="snow",this.defaultEffectStore.spaceEffect.addEffect(e)},this.updateSnow=function(e,t){t.type="snow",this.defaultEffectStore.spaceEffect.updateEffect(e,t)},this.showSnow=function(e){this.defaultEffectStore.spaceEffect.showEffect(e)},this.hideSnow=function(e){this.defaultEffectStore.spaceEffect.hideEffect(e)},this.renameSnow=function(e,t){this.defaultEffectStore.spaceEffect.renameEffect(e,t)},this.removeSnow=function(e){this.defaultEffectStore.spaceEffect.removeEffect(e)},this.add3DMarker=function(e,t){(new MarkerItem).load(e,((r,n)=>{let i=new Group;if(i.name=e.name+"title",n.add(i),e.canvas){let t=X(i,{canvas:e.canvas,sizeAttenuation:!1,width:414e-6*e.canvas.width,height:414e-6*e.canvas.height,offsetV:.5,offsetH:.5,enableText:!0});t.name=e.name,t.position.y=e.titleHeight*e.size}n.visible=e.isShow,n.activeVisible=e.isShow,t&&t(r,n)}))},this.update3DMarker=function(t,r,n){let i=e.find(t);if(i.children[0].path!==r.path)this.removeLayer(t),this.add3DMarker(r,n);else{i.remove(i.children[i.children.length-1]);let e=new Group;if(e.name=r.name+"title",i.add(e),r.canvas){let t=X(e,{canvas:r.canvas,sizeAttenuation:!1,width:414e-6*r.canvas.width,height:414e-6*r.canvas.height,offsetV:.5,offsetH:.5,enableText:!0});t.name=r.name,t.position.y=r.titleHeight*r.size}i.position.set(r.position[0],r.position[1],r.position[2]),i.children[0].scale.set(r.size,r.size,r.size),i.traverse((e=>{e.isMesh&&(r.opacity<.99?e.material.transparent=!0:e.material.transparent=e.userData.transparent,e.material.opacity=r.opacity)})),n&&n(1,i)}},this.addAnimatedSprite=(e={},t)=>{e.url&&_context.loaders.textureLoader.load(e.url,(r=>{let n=new SpriteMaterial({map:r,depthTest:!!e.depthTest});n.rotation=MathUtils.degToRad(e.rotation||0);let i=new AnimatedSprite(n,{dimension:e.dimension,duration:e.duration,fadeInFrame:e.fadeInFrame,fadeOutFrame:e.fadeOutFrame,loop:e.loop,destroyOnFinish:!!e.destroyOnFinish});i.name=e.name||util$1.randomString(8),e.center=e.center||[.5,.5],e.position=e.position||{x:0,y:0,z:0},e.scale=e.scale||{x:1,y:1,z:1},i.center.set(e.center[0],e.center[1]),i.position.set(e.position.x,e.position.y,e.position.z),i.scale.set(e.scale.x,e.scale.y,e.scale.z),_context.animationStore.add(i),_context.objectStore.add(i.name,i),e.autoPlay&&i.play(),"function"==typeof t&&t()}))},this.getStatistics=()=>_context.renderer?_context.rendererInfo:{fps:0,geometries:0,textures:0,calls:0,faces:0,vertices:0},this._onWebContextLost=()=>{document.getElementById("panel").innerHTML="<p>场景显示异常,请刷新重试！</p>",clearInterval(R),R=null},this.fpsPanelOn=()=>{let e=document.createElement("div");e.setAttribute("id","panel"),e.className="fps-panel",e.innerHTML='<p style="margin-left: 50px;float: left;" class="fps">\n                            FPS：0\n                          </p>\n\n                          <p style="margin-left: 20px;float: left;" class="faces">\n                            三角形数：0\n                          </p>\n\n                          <p style="margin-left: 20px;float: left;" class="vertices">\n                            顶点数：0\n                          </p>\n\n                          <p style="margin-left: 20px;float: left;" class="calls">\n                            DrawCall：0\n                          </p>',e.style="position: absolute;\n                      min-width: 543px;\n                      max-width: 80%;\n                      padding: 0 10px;                    \n                      height: 32px; \n                      left: 50%; \n                      transform: translateX(-50%);\n                      bottom: 20px;\n                      border-radius:8px;\n                      background-color: rgba(0,0,0,0.5);\n                      line-height: 32px;\n                      font-size: 14px;\n                      color: #CCCCCC;",this.container.appendChild(e);let t=document.getElementsByClassName("fps"),r=document.getElementsByClassName("faces"),n=document.getElementsByClassName("vertices"),i=document.getElementsByClassName("calls");R=setInterval((()=>{t[0].innerHTML="FPS："+util$1.formatWithRegex(this.getStatistics().fps),r[0].innerHTML="三角形数："+util$1.formatWithRegex(this.getStatistics().faces),n[0].innerHTML="顶点数："+util$1.formatWithRegex(this.getStatistics().vertices),i[0].innerHTML="DrawCall："+util$1.formatWithRegex(this.getStatistics().calls)}),1e3),_context&&_context.renderer&&_context.renderer.getContext()&&_context.renderer.getContext().canvas&&_context.renderer.getContext().canvas.removeEventListener&&_context.renderer.getContext().canvas.removeEventListener("webglcontextlost",this._onWebContextLost,!1),_context&&_context.renderer&&_context.renderer.getContext()&&_context.renderer.getContext().canvas&&_context.renderer.getContext().canvas.addEventListener&&_context.renderer.getContext().canvas.addEventListener("webglcontextlost",this._onWebContextLost,!1)},this.fpsPanelOff=()=>{clearInterval(R),R=null,document.getElementById("panel")&&document.getElementById("panel").remove(),_context&&_context.renderer&&_context.renderer.getContext()&&_context.renderer.getContext().canvas&&_context.renderer.getContext().canvas.removeEventListener&&_context.renderer.getContext().canvas.removeEventListener("webglcontextlost",this._onWebContextLost,!1)},this.leftButtonHandle=e=>{_context.orbitControls.keyOperate=e},this.autoRotate=(e,t=!0)=>{let r=util$1.isNumber(e)&&0!==e;r&&t?_context.orbitControls.addEventListener("start",this.interruptCameraFly):_context.orbitControls.removeEventListener("start",this.interruptCameraFly),_context.orbitControls.autoRotate=r,_context.orbitControls.autoRotateSpeed=e,_context.orbitControls.update()},this.setAutoRotate=function(e,t,r){e?this.autoRotate(t,r):this.autoRotate(0)},this.addDirectionalLight=e=>{logger.debug("TRACE: Core.addDirectionalLight() - Entering.",e),_context.lightStore.setDirectionalLight(e),logger.debug("TRACE: Core.addDirectionalLight() - Leaving.",e)},this.setDirectionalLight=e=>{logger.debug("TRACE: Core.setDirectionalLight() - Entering.",e);let t=JSON.parse(JSON.stringify(e));_context.lightStore.setDirectionalLight(t),logger.debug("TRACE: Core.setDirectionalLight() - Leaving.",e)},this.removeDirectionalLight=e=>{logger.debug("TRACE: Core.removeDirectionalLight() - Entering.",e),_context.lightStore.removeDirectionalLight(e),logger.debug("TRACE: Core.removeDirectionalLight() - Leaving.",e)},this.exportScene=(e,t,r)=>{if(logger.debug("TRACE: Core.exportScene() - Entering."),!f.dhExporter)return void logger.error("未定义导出器，无法导出。");let n;n=r&&"number"==typeof r.maxTextureSize?r.maxTextureSize:1/0,f.dhExporter.exportBlob({type:"glb",maxTextureSize:n,onFinish:e,onError:t}),logger.debug("TRACE: Core.exportScene() - Leaving.")},this.showLightHelpers=()=>{logger.debug("TRACE: Core.showLightHelpers() - Entering."),_context.lightStore.showLightHelpers(),logger.debug("TRACE: Core.showLightHelpers() - Leaving.")},this.hideLightHelpers=()=>{logger.debug("TRACE: Core.hideLightHelpers() - Entering."),_context.lightStore.hideLightHelpers(),logger.debug("TRACE: Core.hideLightHelpers() - Leaving.")},this.convertWorldToScreen=e=>{var t=new Vector3(e.x,e.y,e.z).project(_context.camera),r=this.container.clientWidth/2,n=this.container.clientHeight/2;return{x:Math.round(t.x*r+r),y:Math.round(-t.y*n+n)}},this.convertScreenToWorld=({x:e,y:t})=>{const r=e/this.container.scrollWidth*2-1,n=-t/this.container.scrollHeight*2+1,i=new Vector3(r,n,.5).unproject(_context.camera),a=_context.camera.position.clone(),o=i.clone().sub(a).normalize(),s=new Ray(i,o);this.getDatumShiftModel();const l=new Plane(new Vector3(0,1,0),0);let c=new Vector3;return s.intersectPlane(l,c),c},this.convertNDCToWorld=(e,t)=>{const r=e.x,n=e.y;if("string"==typeof t)switch(t.toLowerCase()){case"cameraortho":case"ortho":case"orthocamera":case"orthographic":case"orthographiccamera":t=_context.cameraOrtho;break;case"camera":case"perspective":case"perspectivecamera":default:t=_context.camera}t instanceof PerspectiveCamera||t instanceof OrthographicCamera||(t=_context.camera);return new Vector3(r,n,.5).unproject(t)},this.pickScreenToWorld=e=>{const t=e.x,r=e.y;let n=new Vector2(t/this.container.scrollWidth*2-1,-r/this.container.scrollHeight*2+1);_.setFromCamera(n,_context.camera);let i=_.intersectObjects(_context.scene.models.children,!0),a=[];for(let e=0;e<i.length;e++){if(!1===i[e].object.visible||!1===util$1.judegParentIsVisible(i[e].object))continue;let t=util$1.findObjectToBuilding(i[e].object.uuid);if(t){let r=_context.clippingStore.findCutBulidingByUUID(t.getGroup().uuid);if(r&&r.clippingController.pointClipTest(i[e].point))continue}a.push(i[e])}if(a.length>0){var o=a[0];if(o.distance>=0)return o.point}return{x:0,y:0,z:0}},this.pickNDCToWorld=(e,t)=>{const r=e.x,n=e.y;let i=new Vector2(r,n);if("string"==typeof t)switch(t.toLowerCase()){case"cameraortho":case"ortho":case"orthocamera":case"orthographic":case"orthographiccamera":t=_context.cameraOrtho;break;case"camera":case"perspective":case"perspectivecamera":default:t=_context.camera}t instanceof PerspectiveCamera||t instanceof OrthographicCamera||(t=_context.camera),_.setFromCamera(i,t);let a=_.intersectObjects(_context.scene.models.children,!0);if(a.length>0){let e=-1;for(let t=0;t<a.length;t++)if(a[t].object.visible){e=t;break}if(-1===e)return{x:0,y:0,z:0};let t=a[0];if(t.distance>=0)return t.point}return{x:0,y:0,z:0}},this.convertWorldToSceneLocal=e=>{let t=new Vector4(e.x,e.y,e.z,1),r=_context.scene.models.matrix.clone();return r.invert(),t.applyMatrix4(r),{x:t.x,y:t.y,z:t.z}},this.addModel=(e,t,r)=>(logger.debug("TRACE: Core.addModel() - Entering.",e),this.resetSettings(),e=e||{},logger.debug("TRACE: Core.addModel() - Leaving and return a Promise."),new Promise(((n,i)=>{if(_context.loaders.gltfLoader||(t&&t(0,"No loader initiated."),i(new Error("No loader initiated."))),e.name||(e.name=util$1.guid()),_context.modelStore.find(e.name))return t&&t(0,`Model with name ${e.name} already exists.`),void i(new Error(`Model with name ${e.name} already exists.`));_context.cacheStore.load({path:e.modelPath,type:"glb",onLoad:r=>{r.name=e.name,r.scene.traverse((e=>{if(util$1.capableForCastingShadow(e)&&(M++,e.castShadow=!0,e.receiveShadow=!0),e.material instanceof MeshStandardMaterial){e.material.alphaTest=.05,e.material.depthWrite=!0,e.material.depthTest=!0,e.material.vertexColors=!1,e.material.needsUpdate=!0,_context.materialStore.add(e.material.name,e.material,e);for(let t in e.material)e.material[t]instanceof Texture$1&&e.material[t].image&&_context.textureStore.add(e.material[t].name||`${e.material.name}#${t}`,e.material[t])}})),t&&t(1),n(),setTimeout((()=>{this.focus()}),500)},onProgress:r,onError:e=>{t?t(0,e):logger.debug(e),i(e)}})}))),this.rankUpNode=(e,t)=>{this.defaultObjectTree.rankUp(e,t)},this.rankDownNode=(e,t)=>{this.defaultObjectTree.rankDown(e,t)},this.preloadScene=(e,t,r)=>(logger.debug("TRACE: Core.preloadScene() - Entering.",e),e=e||{},logger.debug("TRACE: Core.preloadScene() - Leaving and return a Promise."),new Promise(((n,i)=>{_context.cacheStore.load({path:e.scenePath,type:"glb",onLoad:()=>{t&&t(1,"场景预载完毕。"),n()},onProgress:e=>{r&&r({type:"progress",total:e.total,loaded:e.loaded})},onError:r=>{t?t(0,`场景预载失败：${e.scenePath}`):logger.warn(`场景预载失败：${e.scenePath}`),i(`场景预载失败：${e.scenePath}`)}})}))),this.preloadResource=(e,t,r,n)=>{logger.debug("TRACE: Core.preloadResource() - Entering.",e),logger.debug("TRACE: Core.preloadResource() - Leaving and return a Promise."),_context.preloads||(_context.preloads=[]);for(let t=0;t<_context.preloads.length;t++)if(_context.preloads[t].key===e)return void _context.preloads[t].callback.push(r);_context.preloads.push({key:e,total:0,loaded:0,status:0,callback:[r]}),_context.cacheStore.load({path:e,type:t,onLoad:()=>{for(let t=0;t<_context.preloads.length;t++)if(_context.preloads[t].key===e){_context.preloads[t].status=1;break}let t=!0;for(let e=0;e<_context.preloads.length;e++)0===_context.preloads[e].status&&(t=!1);if(t){for(let t=0;t<_context.preloads.length;t++)1===_context.preloads[t].status?_context.preloads[t].callback.forEach((t=>{"function"==typeof t&&t(0,`资源预载成功。${e}`)})):-1===_context.preloads[t].status&&_context.preloads[t].callback.forEach((t=>{"function"==typeof t&&t(0,`资源预载失败。${e}`)}));_context.preloads.length=0}},onProgress:t=>{for(let r=0;r<_context.preloads.length;r++)if(_context.preloads[r].key===e){_context.preloads[r].total=t.total,_context.preloads[r].loaded=t.loaded;break}if(n){let e=0,t=0;for(let r=0;r<_context.preloads.length;r++)e+=_context.preloads[r].total,t+=_context.preloads[r].loaded;n({type:"progress",total:e,loaded:t})}},onError:t=>{for(let t=0;t<_context.preloads.length;t++)if(_context.preloads[t].key===e){_context.preloads[t].status=-1;break}let n=!0;for(let e=0;e<_context.preloads.length;e++)0===_context.preloads[e].status&&(n=!1);if(n){if("function"==typeof r){let e=0,t=0;for(let r=0;r<_context.preloads.length;r++)1===_context.preloads[r].status&&e++,-1===_context.preloads[r].status&&t++;0===e?r(0,"资源预载失败。"):r(1,0===t?"资源预载成功。":"部分资源预载失败。")}_context.preloads.length=0}}})},this.loadScene=(e,t,r)=>(logger.debug("TRACE: Core.loadScene() - Entering.",e),e=e||{},logger.debug("TRACE: Core.loadScene() - Leaving and return a Promise."),new Promise(((n,i)=>{e.name||(e.name=util$1.guid()),this.defaultObjectTree.loadModel({name:e.name,modelPath:e.scenePath},((e,r)=>{if(1===e){let e;r&&(_context.sceneSettings=util$1.cloneDeep(r),null!=r.sceneName&&(_context.sceneName=r.sceneName)),_context.sceneSettings.colorSpace&&this.setColorSpace(_context.sceneSettings.colorSpace),e=_context.sceneSettings.states&&_context.sceneSettings.states.length?_context.sceneSettings.states.find((e=>e.defaultState)).settings:_context.sceneSettings,_context.stateStore&&_context.stateStore.applySettings(_context.sceneSettings.states);let n=JSON.parse(JSON.stringify(e.view));n.camera.duration=0,this.defaultView.applySettings(n,(e=>{t&&t(e,"状态切换成功")}),!0),S=e&&e.lights?e.lights.skybox:"",this.defaultObjectTree.applySettings(e.objectTree),e.background&&(_context.background.mode=e.background.mode),_context.background.color=null,_context.background.texture=null,e.background&&(e.background.colorCSSValue&&this.setBackgroundColor(e.background.colorCSSValue),e.background.textureURL&&this.setBackgroundImage(e.background.textureURL),e.background.mode&&this.setBackgroundMode(e.background.mode,e)),_context.lightStore.applySettings(e.lights,(()=>{}),e.view.camera.duration),null!=_context.sceneSettings.sceneModelTransform&&null!=_context.sceneSettings.sceneModelTransform.position?(_context.scene.models.position.x=_context.sceneSettings.sceneModelTransform.position.x,_context.scene.models.position.y=_context.sceneSettings.sceneModelTransform.position.y,_context.scene.models.position.z=_context.sceneSettings.sceneModelTransform.position.z,_context.scene.models.rotation._order=_context.sceneSettings.sceneModelTransform.rotation._order,_context.scene.models.rotation._x=_context.sceneSettings.sceneModelTransform.rotation._x,_context.scene.models.rotation._y=_context.sceneSettings.sceneModelTransform.rotation._y,_context.scene.models.rotation._z=_context.sceneSettings.sceneModelTransform.rotation._z,_context.scene.models.scale.x=_context.sceneSettings.sceneModelTransform.scale.x,_context.scene.models.scale.y=_context.sceneSettings.sceneModelTransform.scale.y,_context.scene.models.scale.z=_context.sceneSettings.sceneModelTransform.scale.z):(_context.scene.models.position.x=0,_context.scene.models.position.y=0,_context.scene.models.position.z=0,_context.scene.models.rotation._order="XYZ",_context.scene.models.rotation._x=0,_context.scene.models.rotation._y=0,_context.scene.models.rotation._z=0,_context.scene.models.scale.x=1,_context.scene.models.scale.y=1,_context.scene.models.scale.z=1),this.defaultEffectStore.applySettings(e.effects),_context.sceneSettings.datumShiftModel&&(this.setDatumShiftModel(_context.sceneSettings.datumShiftModel),"number"==typeof _context.sceneSettings.datumShiftModel.scaleY&&(_context.worldScale=_context.sceneSettings.datumShiftModel.scaleX)),this.defaultObjectTree.children.forEach((e=>{if("BuildingItem"===e.type&&(e.children.forEach((e=>{e.level&&e.hide()})),e.floor)){this.cutLevel(e.getGroup().uuid,e.floor);for(let t=0;t<F.length;t++)F[t].uuid===e.getGroup().uuid&&(F.splice(t,1),t--);F.push({uuid:e.getGroup().uuid,level:e.floor})}}))}}),(e=>{r&&r({type:"progress",total:e.total,loaded:e.loaded})})),n(),setTimeout((()=>{this.focus()}),500)}),(e=>{t&&t(0,"读取场景失败。"),logger.warn("读取场景失败。"),reject("读取场景失败。")}))),this.calibrateCoordinate=e=>{e?this.switchCameraMode(1):this.switchCameraMode(0)},this.setCalibrateCoordinateParams=e=>{if(e.editor)if("none"!==e.editor.mode)if("basepoint"!==e.editor.mode)if("map"!==e.editor.mode)_context.datumShiftModel={};else{if(!(e&&e.center&&e.bounds&&e.bounds.sw&&e.bounds.ne))return;if("number"!=typeof e.center.lon||"number"!=typeof e.center.lat)return;if("number"!=typeof e.bounds.sw.lon||"number"!=typeof e.bounds.sw.lat)return;if("number"!=typeof e.bounds.ne.lon||"number"!=typeof e.bounds.ne.lat)return;let t={lon:e.center.lon,lat:e.center.lat,alt:e.center.alt||0,x:0,y:0,z:0},r={lon:e.bounds.sw.lon,lat:e.bounds.sw.lat,x:0,z:0},n={lon:e.bounds.ne.lon,lat:e.bounds.ne.lat,x:0,z:0},i=this.convertNDCToWorld({x:0,y:0},_context.cameraOrtho),a=this.convertNDCToWorld({x:-1,y:-1},_context.cameraOrtho),o=this.convertNDCToWorld({x:1,y:1},_context.cameraOrtho);i.divideScalar(_context.scene.models.scale.x),a.divideScalar(_context.scene.models.scale.x),o.divideScalar(_context.scene.models.scale.x),t.x=i.x,t.y=i.y,t.z=i.z,r.x=a.x,r.z=a.z,n.x=o.x,n.z=o.z;let s=(n.lon-r.lon)/(o.x-a.x),l=(n.lat-r.lat)/(a.z-o.z),c=t.lon-s*t.x,h=t.lat+l*t.z,u=util$1.lonLatToWebMercator(n.lon,t.lat),d=util$1.lonLatToWebMercator(r.lon,t.lat),p=u.x-d.x,f=Math.abs(n.x-r.x)/p,m=util$1.lonLatToWebMercator(c,h);this.setDatumShiftModel({type:"mercator",lon:0-m.x,lat:m.y,alt:0-t.alt,scaleX:f,scaleY:f*e.editor.YScale,scaleZ:f,origin:[c,h],editor:{mode:"map",lon:e.center.lon,lat:e.center.lat,alt:e.center.alt||0,rotation:this.getSceneRotationY(),scale:f,mapOperateMode:"default",mapCenter:[e.editor.mapCenter[0],e.editor.mapCenter[1]],mapZoom:e.editor.mapZoom,YScale:e.editor.YScale}})}else this.setDatumShiftModel({type:e.type,lon:e.lon,lat:e.lat,alt:e.alt,scaleX:e.scaleX,scaleY:e.scaleY,scaleZ:e.scaleZ,editor:{mode:"basepoint"}});else _context.datumShiftModel={editor:{mode:"none"}};else logger.warn("setCalibrateCoordinateParams() 无效的参数。")},this.setBackgroundMode=(e,t)=>{switch(_context.scene.background&&_context.scene.background.isColor&&(_context.background.color=_context.scene.background),_context.scene.background&&_context.scene.background instanceof Texture$1&&!(_context.scene.background instanceof CubeTexture)&&(_context.background.texture=_context.scene.background),_context.scene.background&&_context.scene.background instanceof CubeTexture&&(_context.background.cubeTexture=_context.scene.background),"none"===e&&(O=null),_context.background.mode=e,e.toLowerCase()){case"none":_context.lightStore.disableLightProbe(),_context.scene.background=null;break;case"color":_context.lightStore.disableLightProbe(),_context.background.color&&_context.background.color.isColor&&(_context.scene.background=_context.background.color,_context.effectStore.visualEffect._fogColorFromSkybox="#cccccc",_context.effectStore.visualEffect._setFog());break;case"image":_context.lightStore.disableLightProbe(),_context.background.texture&&_context.background.texture instanceof Texture$1&&(_context.scene.background=_context.background.texture,_context.effectStore.visualEffect._fogColorFromSkybox="#cccccc",_context.effectStore.visualEffect._setFog());break;case"skybox":if(_context.background.cubeTexture&&_context.background.cubeTexture instanceof CubeTexture){if(_context.scene.background===_context.background.cubeTexture)break;this.setGlobalIllumination({skybox:t?t.lights.skybox:this.getSettings().lights.skybox,ambientLight:t?t.lights.ambientLight:this.getSettings().lights.ambientLight,directionalLight:t?t.lights.directionalLights.GlobalDirectionalLight:this.getSettings().lights.directionalLights.GlobalDirectionalLight},(()=>{_context.scene.background=_context.background.cubeTexture,this.crossfade()}))}}util$1.markObjectsNeedsUpdate()},this.setBackgroundColor=(e=BACKGROUND_COLOR_DEFAULT)=>{e&&("string"==typeof e&&(e={type:"single",dataUrl:"",color1:e,color2:"",gradientValue:""}),"color"===_context.background.mode&&("single"===e.type?(_context.scene.background&&_context.scene.background.isColor&&_context.scene.background.setStyle?_context.scene.background.setStyle(e.color1):_context.scene.background=new Color(e.color1),O=null,_context.background.color=_context.scene.background,util$1.markObjectsNeedsUpdate()):"gradient"===e.type&&(new TextureLoader).load(util$1.base64ToBlob(e.dataUrl),(e=>{_context.scene.background=e,O=null,_context.scene.background.isColor=!0,_context.background.color=_context.scene.background,util$1.markObjectsNeedsUpdate()})),_context.background.colorCSSValue=e,_context.effectStore.visualEffect._fogColorFromSkybox="#cccccc",_context.effectStore.visualEffect._setFog()))},this.setBackgroundImage=e=>{if(e&&("string"==typeof e&&(e={textureName:e,customName:"",customDataUrl:"",imgType:"default"}),"image"===_context.background.mode)){let t=null;"default"===e.imgType?t=util$1.url(this.resourceBasePath,"texture/background/"+e.textureName+".png"):"custom"===e.imgType&&(t=e.customDataUrl),this._imageBackgroundUrl!=t&&(this.crossfadeFreeze(),this.crossfade(1e3)),this._imageBackgroundUrl=t,(new TextureLoader).load(t,(e=>{("image"===_context.background.mode||L)&&(!L&&_context.scene&&(_context.scene.background=e),O=null,_context.background.texture=e,util$1.markObjectsNeedsUpdate())})),_context.background.textureURL=e,_context.effectStore.visualEffect._fogColorFromSkybox="#cccccc",_context.effectStore.visualEffect._setFog()}},this.setBackgroundSkybox=(e,t,r)=>{if(O!==e){O=e;var n=this;_context?_context.cubeTextures?_context.cubeTextures[e]?(L||(_context.scene.background=_context.cubeTextures[e].envTexture),_context.background.cubeTexture=_context.cubeTextures[e].envTexture,_context.scene.environment=i.fromCubemap(_context.cubeTextures[e].envTexture).texture,_context.lightStore.enableLightProbe(),util$1.markObjectsNeedsUpdate(),util$1.isCSSColor(r)?(_context.effectStore.visualEffect._fogColor=r,_context.effectStore.visualEffect._fogColorFromSkybox=r):_context.effectStore.visualEffect._fogColorFromSkybox=util$1.lookupSkyboxFogColor(e,_context.scene.toneMapping),_context.effectStore.visualEffect._setFog(),n.crossfade()):_context.cacheStore.load({path:util$1.genCubeUrls(e,t),type:"cubetexture",onLoad:t=>{t.name=e,("skybox"===_context.background.mode||L)&&(L||(_context.scene.background=t),_context.scene.environment=i.fromCubemap(t).texture,_context.lightStore.enableLightProbe(),util$1.markObjectsNeedsUpdate(),util$1.isCSSColor(r)?(_context.effectStore.visualEffect._fogColor=r,_context.effectStore.visualEffect._fogColorFromSkybox=r):_context.effectStore.visualEffect._fogColorFromSkybox=util$1.lookupSkyboxFogColor(e,_context.scene.toneMapping),_context.effectStore.visualEffect._setFog(),n.crossfade()),_context.background.cubeTexture=t,_context.cubeTextures[e]={envTexture:null},_context.cubeTextures[e].envTexture=t}}):logger.debug("_context.cubeTextures 为空"):logger.debug("_context 为空")}},this.setSkybox=(e,t,r)=>{this.setBackgroundSkybox(e,t,r)},this.getSkyboxName=()=>S,this.setEnvTime=(e,t)=>{let r=new Date("0001/01/01 06:00:00"),n=new Date("0001/01/01 18:00:00"),i=180*(new Date(`0001/01/01 ${e.envTime}`)-r)/(n-r),a="#ff0000",o="skybox-day-10";i>180&&(i-=180,a="#0000ff",o="skybox-night-24"),i<0&&(i+=180,a="#0000ff",o="skybox-night-24"),(i<=5||i>=175)&&(a="#00ff00",o="skybox-dusk-6");let s=this.getSettings().lights.directionalLights.GlobalDirectionalLight,l=Math.sqrt(Math.pow(s.position[0],2)+Math.pow(s.position[1],2)),c=MathUtils.degToRad(i);if(s.position[0]=l*Math.cos(c),s.position[1]=l*Math.sin(c),null!=e.show){let t=new MeshBasicMaterial({color:a}),r=new Mesh(new BoxGeometry(e.show,e.show,e.show),t);r.position.set(s.position[0],s.position[1],s.position[2]),_context.scene.add(r)}this.setSkybox(Y(`texture/cubemap/${o}/`),".jpg"),_context.lightStore.setDirectionalLight(s,e.duration)},this.setGlobalIllumination=({skybox:e="",skyboxType:t=".jpg",ambientLight:r={color:"#ffffff",intensity:.75},directionalLight:n={name:"GlobalDirectionalLight",color:"#ffffff",position:[100,100,100],castShadow:!1,shadow:{},intensity:1,duration:0}}={},a)=>{logger.debug("TRACE: Core.setGlobalIllumination() - Entering."),O&&O!=Y(`texture/cubemap/${e}/`)&&this.crossfadeFreeze(),""===e?this.setBackgroundColor(BACKGROUND_COLOR_DEFAULT):"skybox"===_context.background.mode?O!=Y(`texture/cubemap/${e}/`)&&(S=e.replace("/","").replace("/",""),this.setBackgroundSkybox(Y(`texture/cubemap/${e}/`),t)):(S=e.replace("/","").replace("/",""),_context.loaders.cubeTextureLoader.load(util$1.genCubeUrls(Y(`texture/cubemap/${e}/`),t),(function(e){_context.background.cubeTexture=e,_context.scene?_context.scene.environment=i.fromCubemap(e).texture:logger.debug("_context.scene 为空")})),this.crossfade()),this.setAmbientLight(r.color,r.intensity),_context.lightStore.setDirectionalLight(n,n.duration),_context.stateStore.setGlobalIlluminationInCurrentState({skybox:e,skyboxType:t,ambientLight:r,directionalLight:n}),a&&a(1),logger.debug("TRACE: Core.setGlobalIllumination() - Leaving.")},this.getCamera=()=>{var e={};return e.positionX=_context.camera.position.x,e.positionY=_context.camera.position.y,e.positionZ=_context.camera.position.z,e.inclinationAngle=_context.orbitControls.getPolarAngle()/(Math.PI/2)*90-90,e.azimuthAngle=_context.orbitControls.getAzimuthalAngle()/Math.PI*180,e.viewDistance=Math.abs(_context.orbitControls.object.position.clone().sub(_context.orbitControls.target).length())/_context.worldScale,e.targetX=_context.orbitControls.target.x,e.targetY=_context.orbitControls.target.y,e.targetZ=_context.orbitControls.target.z,e.fov=_context.camera.fov,e.far=_context.camera.far,e.near=_context.camera.near,e.inclinationAngleMin=_context.orbitControls.minPolarAngle/Math.PI*180-90,e.inclinationAngleMax=_context.orbitControls.maxPolarAngle/Math.PI*180-90,e.distanceMin=_context.orbitControls.minDistance/_context.worldScale,e.distanceMax=_context.orbitControls.maxDistance/_context.worldScale,e.viewLimitRadius=_context.orbitControls.viewLimitRadius,e.autoRotate=_context.stateStore._camera.autoRotate,e.autoRotateSpeed=_context.stateStore._camera.autoRotateSpeed,e.autoRotateDirection=_context.stateStore._camera.autoRotateDirection,e},this.setCamera=(e,t)=>{if(t)if(""===this.getCurrentState()){let t=this.getCamera();e.target=e.target||{x:t.targetX,y:t.targetY,z:t.targetZ},e.azimuthAngle=e.azimuthAngle||0===e.azimuthAngle?e.azimuthAngle:t.azimuthAngle,e.inclinationAngle="number"==typeof e.inclinationAngle?e.inclinationAngle:t.inclinationAngle,e.distance="number"==typeof e.distance&&e.distance>0?e.distance:t.viewDistance,_context.targetCameraControls.zoomTo(new Vector3(e.target.x,e.target.y,e.target.z),e.azimuthAngle,e.inclinationAngle,e.distance*_context.worldScale,0,!0),_context.camera.fov=e.fov||_context.camera.fov,("number"!=typeof e.near||e.near<0)&&(e.near=_context.camera.near),("number"!=typeof e.far||e.far<0)&&(e.far=_context.camera.far),e.near<e.far&&(_context.camera.near=e.near,_context.camera.far=e.far,_context.camera.updateProjectionMatrix()),"number"==typeof e.inclinationAngleMin&&(_context.orbitControls.minPolarAngle=(e.inclinationAngleMin+90)/180*Math.PI),"number"==typeof e.inclinationAngleMax&&(_context.orbitControls.maxPolarAngle=(e.inclinationAngleMax+90)/180*Math.PI),"number"==typeof e.distanceMin&&(_context.orbitControls.minDistance=e.distanceMin*_context.worldScale),"number"==typeof e.distanceMax&&(_context.orbitControls.maxDistance=e.distanceMax*_context.worldScale),this.notDistance={minDistance:e.distanceMin*_context.worldScale,maxDistance:e.distanceMax*_context.worldScale},this.defaultEffectStore.visualEffect._updateCameraProjection(_context.camera),this.focus()}else this.notState.view.camera.viewDistanceMax=e.far,this.notState.view.camera.viewDistanceMin=e.near,this.notState.view.camera.distanceMax=e.distanceMax*_context.worldScale,this.notState.view.camera.distanceMin=e.distanceMin*_context.worldScale,this.notState.view.camera.fov=e.fov;else{let t=this.getCamera();e.target=e.target||{x:t.targetX,y:t.targetY,z:t.targetZ},e.azimuthAngle=e.azimuthAngle||0===e.azimuthAngle?e.azimuthAngle:t.azimuthAngle,e.inclinationAngle="number"==typeof e.inclinationAngle?e.inclinationAngle:t.inclinationAngle,e.distance="number"==typeof e.distance&&e.distance>0?e.distance:t.viewDistance,_context.targetCameraControls.zoomTo(new Vector3(e.target.x,e.target.y,e.target.z),e.azimuthAngle,e.inclinationAngle,e.distance*_context.worldScale,e.duration||0,!0),_context.camera.fov=e.fov||_context.camera.fov,("number"!=typeof e.near||e.near<0)&&(e.near=_context.camera.near),("number"!=typeof e.far||e.far<0)&&(e.far=_context.camera.far),e.near<e.far&&(_context.camera.near=e.near,_context.camera.far=e.far,_context.camera.updateProjectionMatrix()),"number"==typeof e.inclinationAngleMin&&(_context.orbitControls.minPolarAngle=(e.inclinationAngleMin+90)/180*Math.PI),"number"==typeof e.inclinationAngleMax&&(_context.orbitControls.maxPolarAngle=(e.inclinationAngleMax+90)/180*Math.PI),"number"==typeof e.distanceMin&&(_context.orbitControls.minDistance=e.distanceMin*_context.worldScale),"number"==typeof e.distanceMax&&(_context.orbitControls.maxDistance=e.distanceMax*_context.worldScale),this.defaultEffectStore.visualEffect._updateCameraProjection(_context.camera),this.focus()}},this.setCameraToModel=(e,t=0,r={},n=!1)=>{let i=null;if(_context.scene.models.traverse((t=>{t.name===e&&(i=t)})),!i)return;let a=(new Box3).setFromObject(i),o=new Vector3;a.getSize(o),C.x=(a.max.x+a.min.x)/2,C.y=(a.max.y+a.min.y)/2,C.z=(a.max.z+a.min.z)/2;let s=3*o.distanceTo(a.max.sub(a.min).divideScalar(2));(isNaN(C.x)||isNaN(C.y)||isNaN(C.z))&&(logger.warn("无法获取有效的模型大小。"),C.copy(i.position)),(isNaN(s)||s===1/0||s===-1/0)&&(s=100),s<=this.getCamera().near&&(s+=this.getCamera().near),a=null,o=null,_context.targetCameraControls.zoomTo(C,util$1.numberOrDefault(r.azimuthAngle,45),util$1.numberOrDefault(r.inclinationAngle,-45),util$1.numberOrDefault(r.distance,s)*_context.worldScale,util$1.numberOrDefault(t,0),!0,(()=>{this.focus()})),C=new Vector3},this.setCameraToNode=(e,t,r=0,n={},i=!1)=>{let a=null;_context.scene.models.traverse((t=>{t.name===e&&(a=t)}));let o=util$1.findNodeInThree(a,t);if(!o)return;let s=(new Box3).setFromObject(o),l=new Vector3;s.getSize(l),C.x=(s.max.x+s.min.x)/2,C.y=(s.max.y+s.min.y)/2,C.z=(s.max.z+s.min.z)/2;let c=3*l.distanceTo(s.max.sub(s.min).divideScalar(2));(isNaN(C.x)||isNaN(C.y)||isNaN(C.z))&&(logger.warn("无法获取有效的模型大小。"),C.copy(a.position)),(isNaN(c)||c===1/0||c===-1/0)&&(c=100),c<=this.getCamera().near&&(c+=this.getCamera().near),s=null,l=null,_context.targetCameraControls.zoomTo(C,util$1.numberOrDefault(n.azimuthAngle,45),util$1.numberOrDefault(n.inclinationAngle,-45),util$1.numberOrDefault(n.distance,c)*_context.worldScale,util$1.numberOrDefault(r,0),!0,(()=>{this.focus()})),C=new Vector3},this.setCameraToModelByUUID=(e,t=0,r={},n=!1,i=!1)=>{let a=null;if(_context.scene.models.traverse((t=>{t.uuid===e&&(a=t)})),!a)return;let o=(new Box3).setFromObject(a),s=new Vector3;o.getSize(s),C.x=(o.max.x+o.min.x)/2,C.y=(o.max.y+o.min.y)/2,C.z=(o.max.z+o.min.z)/2;let l=3*s.distanceTo(o.max.sub(o.min).divideScalar(2));(isNaN(C.x)||isNaN(C.y)||isNaN(C.z))&&(logger.warn("无法获取有效的模型大小。"),C.copy(a.position)),(isNaN(l)||l===1/0||l===-1/0)&&(l=100),l<=this.getCamera().near&&(l+=this.getCamera().near),o=null,s=null,this.nextRender((()=>{_context.targetCameraControls.zoomTo(C,util$1.numberOrDefault(r.azimuthAngle,45),util$1.numberOrDefault(r.inclinationAngle,-45),util$1.numberOrDefault(r.distance,l)*_context.worldScale,util$1.numberOrDefault(t,0),!0,(()=>{this.focus()})),C=new Vector3}),1)},this.getOrthoCamera=()=>{var e={};return e.positionX=_context.cameraOrtho.position.x,e.positionY=_context.cameraOrtho.position.y,e.positionZ=_context.cameraOrtho.position.z,e.viewDistance=Math.abs(_context.orthoCameraControls.object.position.clone().sub(_context.orthoCameraControls.target).length()),e.targetX=_context.orthoCameraControls.target.x,e.targetY=_context.orthoCameraControls.target.y,e.targetZ=_context.orthoCameraControls.target.z,e.far=_context.cameraOrtho.far,e.near=_context.cameraOrtho.near,e},this.setOrthoCamera=e=>{let t=_context.cameraOrtho;if(e.target&&"number"==typeof e.target.x&&"number"==typeof e.target.y&&"number"==typeof e.target.z&&!(isNaN(e.target.x)||isNaN(e.target.y)||isNaN(e.target.z))&&NaN!=e.target.x&&NaN!=e.target.y&&NaN!=e.target.z){if(e.target=e.target||{x:t.targetX,y:t.targetY,z:t.targetZ},e.distance="number"==typeof e.distance&&e.distance>0?e.distance:t.position.y-e.target.y,"number"==typeof e.width&&!isNaN(e.width)){let t=e.width,r=t/(_context.renderer.domElement.width/_context.renderer.domElement.height);_context.cameraOrtho.left=t/-2,_context.cameraOrtho.right=t/2,_context.cameraOrtho.top=r/2,_context.cameraOrtho.bottom=r/-2}_context.cameraOrtho.position.set(e.target.x,e.target.y+e.distance,e.target.z),_context.cameraOrtho.up.set(0,0,-1),_context.cameraOrtho.rotation.z=0,_context.cameraOrtho.zoom=1,_context.cameraOrtho.updateProjectionMatrix(),_context.cameraOrtho.updateMatrixWorld(),_context.orthoCameraControls.target.set(e.target.x,e.target.y,e.target.z),_context.orthoCameraControls.update()}},this.findParentPosition=e=>{let t=e.parent;t&&(C.x=t.position.x+C.x,C.y=t.position.y+C.y,C.z=t.position.z+C.z,this.findParentPosition(t,C))},this.findNode=(e,t)=>{let r=this.findModel(e);if(r)return r.findNode(t)},this.destroy=()=>{if(logger.debug("TRACE: Core.destroy() - Entering."),a)return;for(this.disableTransform(),a=!0,_context.scene.children.forEach((e=>{util$1.disposeThreeObject(e)}));_context.scene.children.length;)_context.scene.remove(_context.scene.children[0]);_context.renderer.domElement&&this.container.removeChild(_context.renderer.domElement),r&&r.domElement&&this.container.removeChild(r.domElement),R&&this.fpsPanelOff(),_context.transformStore.destroy(),_context.transformStore=null,_context.cacheStore.destroy(),_context.cacheStore=null,_context.scene.clear(),_context.scene=null,_context.camera=null,_context.targetCameraControls=null,_context.orbitControls=null,_context.animationStore=null,_context.effectStore=null,_context.lightStore=null,_context.materialStore=null,_context.modelStore=null,e=null,_context.textureStore=null,_context.datumShiftModel=null,o=!1,s=!1,f={},_context.loaders={},_context.paintControls.destroy(),this.notState=null,this.allState=null,_context.renderer.dispose(),_context.renderer.forceContextLoss(),_context.renderer.content=null;let t=_context.renderer.domElement.getContext("webgl");t&&t.getExtension("WEBGL_lose_context").loseContext(),_context.renderer=null,logger.debug("TRACE: Core.destroy() - Leaving.")},this.enableLut=()=>this.defaultEffectStore.enableLut(),this.disableLut=()=>this.defaultEffectStore.disableLut(),this.nextLut=()=>this.defaultEffectStore.nextLut(),this.findMaterial=e=>_context.materialStore.find(e),this.findMaterialInModel=(e,t)=>{let r=this.defaultObjectTree.children;for(let n=0;n<r.length;n++)if("ModelItem"===r[n].type){if(r[n].name===e)return r[n].getMaterials()[t]}else if("BuildingItem"===r[n].type)for(let i=0;i<r[n].children.length>0;i++)if("ModelItem"===r[n].children[i].type){if(r[n].children[i].name===e)return r[n].children[i].getMaterials()[t]}else if("BuildingFloorItem"===r[n].children[i].type)for(let a=0;a<r[n].children[i].children.length;a++)if(r[n].children[i].children[a].name===e)return r[n].children[i].children[a].getMaterials()[t]},this.findModel=(e,t)=>{let r,n=this;return _context.scene.models.traverse((function(i){i.name===e&&(t?n.findParent(i,t)&&(r=i):r=i)})),r},this.findParent=(e,t)=>{if(e.parent){if(e.parent.name===t)return e.parent;var r=this.findParent(e.parent,t);return r||void 0}},this.findTexture=e=>_context.textureStore.find(e),this.getModels=()=>_context.modelStore.getModels(),this.setNodeRotation=({enabled:e=!0,node:t,rotatingAxis:r="y",rotatingSpeed:n=.1})=>{if(e){let e=_context.animationStore.findNodeAnimation(t,NodeRotationAnimationController.type);e&&(e.reset(),_context.animationStore.remove(e)),e=new NodeRotationAnimationController(t,"x"===r,"y"===r,"z"===r,"x"===r?n:0,"y"===r?n:0,"z"===r?n:0),_context.animationStore.add(e)}else{let e=_context.animationStore.findNodeAnimation(t,NodeRotationAnimationController.type);e&&(e.reset(),_context.animationStore.remove(e))}},this.setNodeRotating=({enabled:e=!0,node:t,rotatingAxis:r="y",rotatingSpeed:n=.1})=>{let i=_context.animationStore.findNodeAnimation(t,NodeRotationAnimationController.type);if(i&&(i.reset(),_context.animationStore.remove(i)),e){let e=new NodeRotationAnimationController(t,"x"===r,"y"===r,"z"===r,"x"===r?n:0,"y"===r?n:0,"z"===r?n:0);_context.animationStore.add(e)}},this.setNodeScaling=({enabled:e=!0,node:t,startScale:r=1,stopScale:n=2,fadeOutScale:i=1.5,scalingSpeed:a=.1})=>{let o=_context.animationStore.findNodeAnimation(t,NodeScaleAnimationController.type);if(o&&(o.reset(),_context.animationStore.remove(o)),e){let e=new NodeScaleAnimationController(t,r,n,i,a,!0);_context.animationStore.add(e)}},this.setNodeBreathing=({enabled:e=!1,node:t,endBreathe:r=1.5,breathingSpeed:n=.1})=>{let i=_context.animationStore.findNodeAnimation(t,NodeBreatheAnimationController.type);if(i&&(i.reset(),_context.animationStore.remove(i)),e){let e=new NodeBreatheAnimationController(t,r,n,!0);_context.animationStore.add(e)}},this.getMaterials=()=>_context.materialStore.getAll(),this.setMaterialAnimation=({name:e="",enableTranslation:t=!1,translationSpeedU:r=.1,translationSpeedV:n=.1,modelName:i})=>{if(logger.debug("TRACE: Core.setMaterialAnimation() - Entering.",{name:e,enableTranslation:t,translationSpeedU:r,translationSpeedV:n}),!this.defaultObjectTree.getItemByName(i))return;let a=this.defaultObjectTree.getItemByName(i).materialStore.find(e);if(!a)return logger.debug(`Material with specified name (${e}) not found.`),void logger.debug("TRACE: Core.setMaterialAnimation() - Leaving.");if(a._enableTranslation=t,a._translationSpeedU=r,a._translationSpeedV=n,0===r&&0===n&&(t=!1),t){let e=_context.animationStore.findMaterialAnimation(a._material(),UVAnimationController.type);if(e)e.enableU=0!==r,e.enableV=0!==n,e.uSpeed=r,e.vSpeed=n;else{let e=new UVAnimationController(a._material(),0!==r,0!==n,r,n);_context.animationStore.add(e)}}else{let e=_context.animationStore.findMaterialAnimation(a._material(),UVAnimationController.type);e&&(e.reset(),a.enableUV&&(a.enableUV=!0),_context.animationStore.remove(e))}if(a._copies instanceof Array)for(let e of a._copies)if(e._enableTranslation=t,e._translationSpeedU=r,e._translationSpeedV=n,0===r&&0===n&&(t=!1),t){let t=_context.animationStore.findMaterialAnimation(e,UVAnimationController.type);if(t)t.enableU=0!==r,t.enableV=0!==n,t.uSpeed=r,t.vSpeed=n;else{let t=new UVAnimationController(e,0!==r,0!==n,r,n);_context.animationStore.add(t)}}else{let t=_context.animationStore.findMaterialAnimation(e,UVAnimationController.type);t&&(t.reset(),_context.animationStore.remove(t))}logger.debug("TRACE: Core.setMaterialAnimation() - Leaving.")},this.init=s=>{(s=s||{}).disableAvwExtensions,g=s.highDPI?window.devicePixelRatio:1,g=s.lowDPI?.5:g,g=s.dpi?s.dpi:g,l=!!s._isManaged,_context.pointerMode="classic","string"==typeof s.pointerMode&&"editor"===s.pointerMode.toLowerCase()&&(_context.pointerMode="editor"),"number"==typeof s.fpsLimit&&s.fpsLimit>0&&s.fpsLimit<240?_context.fpsLimit=s.fpsLimit:_context.fpsLimit=240,M=0,s.container?this.container=s.container:(this.container=document.body.appendChild(document.createElement("div")),o=!0),this.container.style.overflow="hidden",s.fillWindow||o?(o=!0,s.width=window.innerWidth,s.height=window.innerHeight,this.container.style.position="absolute",this.container.style.top="0px",this.container.style.right="0px",this.container.style.bottom="0px",this.container.style.left="0px"):(s.width=s.width||this.container.scrollWidth,s.height=s.height||this.container.scrollHeight),s.upgradeSuggest&&UpgradeSuggest.checkSuggestOn(),this.setResolution(s.width,s.height),n||this.setResolution(WIDTH_DEFAULT,HEIGHT_DEFAULT),_context.alpha="boolean"==typeof s.isTransparent&&s.isTransparent,_context.origin=s.origin?s.origin:window.location.origin,r=new Stats$1,r.domElement.style.position="absolute",r.domElement.style.top="0px",r.domElement.style.display="none",this.container.appendChild(r.domElement);let m=document.createElement("canvas");_context.renderer=new WebGLRenderer({canvas:m,alpha:_context.alpha,antialias:!1}),_context.renderer.autoClear=!0,_context.renderer.setPixelRatio(g),_context.renderer.setSize(n.width,n.height),this.container.appendChild(_context.renderer.domElement),window.addEventListener("resize",(()=>{o&&this.setResolution(window.innerWidth,window.innerHeight)})),_context.renderer.shadowMap.enabled=!0,_context.renderer.shadowMap.type=PCFSoftShadowMap,_context.renderer.toneMapping=NoToneMapping,_context.renderer.toneMappingExposure=1;let y=50,v=1,_=1e6;s.camera&&(y=s.camera.fieldOfView||y,v=s.camera.near||v,_=s.camera.far||_);let x=1*n.width/n.height;_context.camera=new PerspectiveCamera(y,x,v,_),_context.activeCamera=_context.camera,_context.camera.position.set(0,50,100),_context.cameraOrtho=new OrthographicCamera(-200*x,200*x,200,-200,v,_),_context.cameraOrtho.position.y=200,_context.cameraOrtho.lookAt(0,0,0),_context.orbitControls=new OrbitControls(_context.camera,_context.renderer.domElement),_context.orbitControls.enableDamping=!0,_context.orbitControls.dampingFactor=.2,_context.orbitControls.target.set(0,0,0),"editor"===_context.pointerMode&&(_context.orbitControls.keyOperate="paint"),_context.orbitControls.update(),_context.orbitControls.addEventListener("end",(()=>{util$1.markObjectsNeedsUpdate()})),_context.orthoCameraControls=new OrbitControls(_context.cameraOrtho,_context.renderer.domElement),_context.orthoCameraControls.zoomCenter="scene",_context.orthoCameraControls.zoomSpeed=.25,_context.orthoCameraControls.enableDamping=!1,_context.orthoCameraControls.enableRotate=!1,_context.orthoCameraControls.target.set(0,0,0),_context.orthoCameraControls.update(),_context.orthoCameraControls.enabled=!1,_context.targetCameraControls=new TargetCameraControls(_context.orbitControls),this.defaultView=new View({},_context.targetCameraControls,_context.camera),_context.transformControls=new TransformControls(_context.camera,_context.renderer.domElement),_context.transformStore=new TransformStore(_context.transformControls),_context.transformControls.addEventListener("translate",(e=>{this.cutLevelByUUID(e.object.uuid,!1)})),_context.transformControls.addEventListener("dragging-changed",(function(e){_context.orbitControls.enabled=!e.value,_context.orthoCameraControls.enabled=!e.value})),_context.transformControls.addEventListener("mouseUp",(function(e){let t=e.target.object,r={};if(t){r.position=JSON.parse(JSON.stringify(t.position)),r.rotation=JSON.parse(JSON.stringify(t.rotation)),r.rotation.x=r.rotation._x,r.rotation.y=r.rotation._y,r.rotation.z=r.rotation._z,r.scale=JSON.parse(JSON.stringify(t.scale)),r.rotation.x=r.rotation._x=MathUtils.radToDeg(r.rotation._x),r.rotation.y=r.rotation._y=MathUtils.radToDeg(r.rotation._y),r.rotation.z=r.rotation._z=MathUtils.radToDeg(r.rotation._z);let e=_context.defaultObjectTree.getItemByUUID(t.uuid);e&&(e.transformNode=r)}})),_context.scene=new Scene,_context.scene.name="__avwCore",_context.scene.models=new Group,_context.scene.models.name="__models",_context.scene.add(_context.scene.models),_context.scene.sysObjects=new Group,_context.scene.sysObjects.name="__sysObjects",_context.scene.sysObjects.renderOrder=1/0,_context.scene.add(_context.scene.sysObjects),_context.scene.noneModels=new Group,_context.scene.noneModels.name="__noneModels",_context.scene.axesHelper=new AxesHelper(50),_context.scene.axesHelper.name="__axesHelper",_context.scene.axesHelper.visible=!1,_context.scene.add(_context.scene.noneModels),_context.scene.sysObjects.add(_context.transformControls),_context.alpha||(_context.scene.background=new Color(BACKGROUND_COLOR_DEFAULT)),_context.scene.setNodeRotation=this.setNodeRotation,_context.scene.setNodeRotating=this.setNodeRotating,_context.scene.setNodeScaling=this.setNodeScaling,_context.scene.setNodeBreathing=this.setNodeBreathing,_context.scene.add(_context.scene.axesHelper),_context.loaders.gltfLoader=new DHLoader,_context.loaders.gltfLoaderAVWS=new DHLoaderAVWS,_context.loaders.dracoLoader=new DRACOLoader,_context.loaders.dracoLoader.setDecoderPath(util$1.url(this.resourceBasePath,"lib/draco/gltf/")),_context.loaders.gltfLoader.setDRACOLoader(_context.loaders.dracoLoader),_context.loaders.bufferGeometryLoader=new BufferGeometryLoader,_context.loaders.textureLoader=new TextureLoader,_context.loaders.cubeTextureLoader=new CubeTextureLoader,_context.cubeTextures={},_context.loaders.ddsLoader=new DDSLoader,_context.loaders.tgaLoader=new TGALoader,DefaultLoadingManager.addHandler(/\.tga$/i,_context.loaders.tgaLoader),DefaultLoadingManager.addHandler(/\.dds$/i,_context.loaders.ddsLoader),f.gltfExporter=new GLTFExporter$1,f.dhExporter=new DHExporter(_context.scene,this),_context.cacheStore=new CacheStore,_context.modelStore=new ModelStore(_context.scene),e=new ObjectStore(_context.scene),_context.objectStore=e,_context.sysObjectStore=new SysObjectStore(_context.scene),_context.textureStore=new TextureStore,_context.materialStore=new MaterialStore(_context.textureStore,this),_context.lightStore=new LightStore(_context.scene,this),i=new PMREMGenerator(_context.renderer),_context.effectStore=new EffectStore,this.defaultEffectStore=_context.effectStore,_context.stateStore=new StateStore,this.defaultNodeSelection=new NodeSelection(_context.scene,this),this.defaultModelSelection=new ModelSelection,_context.animationStore=new AnimationStore,_context.animationMixers=[],_context.clippingStore=new ClippingStore,t=new EventHandlerStore(_context.renderer,_context.scene,_context.camera),_context.eventHandlerStore=t,this.defaultObjectTree=new ObjectTree(_context.scene),_context.defaultObjectTree=this.defaultObjectTree,_context.statistics=new Statistics,E=new CoordinateConvertHelper,A=new BaseCarrierController((e=>{t.trailmove(e)})),new Raycaster,_context.drawableDepthTest="boolean"==typeof s.drawableDepthTest&&s.drawableDepthTest,_context.paintControls=new PaintControls,_context.paintControls.init(),_context.selectControl=new SelectControls,_context.instancedObjectStore=new InstancedObjectStore,s.camera&&(s.camera.target||"number"==typeof s.camera.azimuthAngle||"number"==typeof s.camera.inclinationAngle||"number"==typeof s.camera.distance)&&this.setCamera(s.camera),logger.debug("注册鼠标按下事件处理函数。"),_context.renderer.domElement.addEventListener("pointerdown",(function(e){_context.pointerDisabled||0==e.button&&(d=!0,p={x:e.offsetX,y:e.offsetY},h=!1,u=!1)}),!1),logger.debug("注册鼠标抬起事件处理函数。"),_context.renderer.domElement.addEventListener("pointerup",(r=>{if(_context.pointerDisabled)return;if(0!=r.button)return;d=!1;let n=!1;null!==p&&(n=Math.abs(r.offsetX-p.x)<3,!0===n&&(n=Math.abs(r.offsetY-p.y)<3),p=null),n?(t.onClick(r,e,E),"manual"===_context.effectStore.visualEffect.dofFocus&&(b.set(r.offsetX/_context.renderer.domElement.clientWidth*2-1,-r.offsetY/_context.renderer.domElement.clientHeight*2+1),this.focus())):"manual"===_context.effectStore.visualEffect.dofFocus&&(b.set(0,0),this.focus()),h=!0,u=!0}),!1),logger.debug("注册鼠标滑动事件。"),_context.renderer.domElement.addEventListener("pointermove",(r=>{_context.pointerDisabled||(u=h,h=!0,h&&u&&T||d||t.mouseHoverTest(r,e,E))}),!1),_context.renderer.domElement.addEventListener("wheel",(e=>{t.onWheel(e)}),!1),this.on("camerazoomstop",void 0,(()=>{this.focus()}),{debounce:!0}),OverrideMaterialManager.workaroundEnabled=!0,window.rStats&&(c.bS=new BrowserStats,c.glS=new glStats,c.tS=new threeStats(_context.renderer),c.rS=new rStats({userTimingAPI:!0,values:{frame:{caption:"Total frame time (ms)",over:16,average:!0,avgMs:100},fps:{caption:"Framerate (FPS)",below:30},calls:{caption:"Calls (three.js)",over:3e3},raf:{caption:"Time elapsed (ms)",average:!0,avgMs:100},setup:{caption:"Setup (ms)",average:!0,avgMs:100},rstats:{caption:"rStats update (ms)",average:!0,avgMs:100},focus:{caption:"Focus",average:!0,avgMs:100}},groups:[{caption:"Framerate",values:["fps","raf"]},{caption:"Frame Budget",values:["frame","setup","render"]}],fractions:[{base:"frame",steps:["texture","setup","render"]}],plugins:[c.bS,c.tS,c.glS]})),_context.clock=new Clock,a=!1,_context.renderer.info.autoReset=!1,l||(_context.deltaA=0,_context.frameTimeLimit=1/_context.fpsLimit,V()),_context.orbitControls.addEventListener("change",t.cameraMove.bind(t))},this.focus=()=>{logger.debug("focus requested."),(_context.effectStore.visualEffect.enableDOF||_context.effectStore.visualEffect.dofQuality<=0)&&(j(),logger.debug("focus done."),y>0&&(_context.effectStore.visualEffect.dofFocusDistance=1*y/(_context.camera.far-_context.camera.near)))},this.setToneMapping=(e=LinearToneMapping,t=1)=>{_context.renderer.toneMapping=e,_context.renderer.toneMappingExposure=t;let r=this.getMaterials();for(let e in r)r[e]._material()&&(r[e]._material().needsUpdate=!0)},this.hideModel=(e,t)=>{this.defaultObjectTree.hideItemByName(e,t)},this.showModel=(e,t)=>{this.defaultObjectTree.showItemByName(e,t)},this.hideNode=(e,t)=>{_context.modelStore.hideNode(e,t)},this.showNode=(e,t)=>{_context.modelStore.showNode(e,t)},this.hideAxesHelper=()=>{_context.scene.axesHelper.visible=!1},this.showAxesHelper=()=>{_context.scene.axesHelper.visible=!0},this.getObjectCount=()=>M,this.getDefaultObjectTree=()=>this.defaultObjectTree,this.playAnimation=(e,t,r)=>{_context.modelStore.playAnimation(e,t,r)},this.stopAnimation=(e,t)=>{_context.modelStore.stopAnimation(e,t)},this.getResolution=()=>n?{width:n.width,height:n.height}:void 0,this.setResolution=(e,t)=>{"number"!=typeof e||e<WIDTH_MIN||e>WIDTH_MAX||"number"!=typeof t||t<HEIGHT_MIN||t>HEIGHT_MAX||(n={width:e,height:t},a||(_context.camera.aspect=1*e/t,_context.camera.updateProjectionMatrix(),_context.renderer.setSize(e,t),_context.effectStore.setSize(e,t),_context.cameraOrtho.left=-200*_context.camera.aspect,_context.cameraOrtho.right=200*_context.camera.aspect,_context.cameraOrtho.top=200,_context.cameraOrtho.bottom=-200,_context.cameraOrtho.updateProjectionMatrix()))},this.changeSize=this.setResolution,this.setAmbientLight=(e,t)=>{_context.lightStore.setAmbientLight(e,t)},this.statsOn=()=>{r.domElement.style.display="block",s=!0},this.statsOff=()=>{r.domElement.style.display="none",s=!1},this.statsToggle=()=>{r.domElement.style.display=s?"none":"block",s=!s},this.switchCameraMode=(e=0)=>{T=1===e,T?(_context.cameraOrtho.position.x=0,_context.cameraOrtho.position.z=0,_context.cameraOrtho.position.y=1e3,_context.cameraOrtho.lookAt(0,0,0),_context.cameraOrtho.updateMatrixWorld(),_context.cameraOrtho.updateProjectionMatrix(),_context.orthoCameraControls.target.set(0,0,0),_context.orthoCameraControls.minPolarAngle=-89.999999/180*Math.PI,_context.orthoCameraControls.maxPolarAngle=-89.99999/180*Math.PI,_context.transformControls.camera=_context.cameraOrtho,_context.activeCamera=_context.cameraOrtho,_context.orbitControls.enabled=!1,_context.orthoCameraControls.enabled=!0):(_context.transformControls.camera=_context.camera,_context.activeCamera=_context.camera,_context.orthoCameraControls.enabled=!1,_context.orbitControls.enabled=!0)},this.getTextures=()=>_context.textureStore?_context.textureStore.getAll():[],this.getTexture=e=>_context.textureStore.find(e),this.resetSettings=()=>{_context.effectStore._composer&&_context.effectStore._composer.reset()},this.applySettings=(e,t,r)=>{null!=e.sceneName&&(_context.sceneName=e.sceneName),e.colorSpace&&this.setColorSpace(e.colorSpace);let n=null;if(n=e.states&&e.states.length&&e.preview?JSON.parse(JSON.stringify(e.states.find((e=>e.defaultState)).settings.view)):JSON.parse(JSON.stringify(e.view)),n.camera.duration=0,this.defaultView.applySettings(n),this.resetSettings(),!(e.objectTree.children instanceof Array))return void this.applyEffectSettings(e,t,r);let i=0,a=[],o=[];for(let e in m.gltfLoader.requestHeader)o.push({key:e,value:m.gltfLoader.requestHeader[e]});this.contentLengthPromisesRemove(e.objectTree.children,a,o),Promise.all(a).then((n=>{if(n instanceof Array)for(let e of n)i+=Number(e);logger.debug(i);let a=[],o=[],s=0;for(let t=0;t<e.objectTree.children.length;t++)a.push(new Promise((n=>{if("ModelItem"===e.objectTree.children[t].type)this.defaultObjectTree.addModel({name:e.objectTree.children[t].name,modelPath:e.objectTree.children[t].modelPath,transform:e.objectTree.children[t].transform,index:e.objectTree.children[t].index,isVisible:null==e.objectTree.children[t].isVisible||e.objectTree.children[t].isVisible,isLock:null!=e.objectTree.children[t].isLock&&e.objectTree.children[t].isLock},(e=>{n(e)}),(n=>{if(r){var a={name:e.objectTree.children[t].name,parent:"model",loaded:n.loaded};for(let e=0;e<o.length;e++)if(o[e].name===a.name&&o[e].parent===a.parent){var l=a.loaded-o[e].loaded;o.splice(e,1),e--}l||(l=a.loaded),o.push(a),s+=l,r({type:"progress",total:i,loaded:s})}logger.debug("progress",n)}));else if("IconAsset"===e.objectTree.children[t].type)new IconItem(e.objectTree.children[t],null,(e=>{n(e)}));else if("GroupItem"===e.objectTree.children[t].type){let r=new GroupItem(e.objectTree.children[t]);e.objectTree.children[t].children.map((e=>{switch(e.type){case"IconAsset":new IconItem(e,r);break;case"ModelAsset":r.childrenAdd(new InstancedObject(e,r))}})),n(1)}else if("BuildingItem"===e.objectTree.children[t].type){var a=e.objectTree.children[t].children,l=0,c=0;if(0===a.length)this.defaultObjectTree.addBuilding(e.objectTree.children[t],(e=>{n(e)}));else{for(let e=0;e<a.length;e++)switch(a[e].type){case"ModelItem":case"IconAsset":l++;break;case"BuildingFloorItem":if(0===a[e].children.length)l=1;else for(let t=0;t<a[e].children.length;t++)l++}this.defaultObjectTree.addBuilding(e.objectTree.children[t],(e=>{1===e&&++c===l&&(n(e),c=0,l=0)}),(e=>{if(r){let t;for(let r=0;r<o.length;r++)o[r].name===e.name&&o[r].parent===e.parent&&(t=e.loaded-o[r].loaded,o.splice(r,1),r--);t||(t=e.loaded),o.push(e),s+=t,r({type:"progress",total:i,loaded:s})}logger.debug("progress",e)}))}}})));Promise.all(a).then((()=>{this.applyEffectSettings(e,t),this.defaultObjectTree.applySettings(e.objectTree),this.defaultObjectTree.children.forEach((e=>{if("BuildingItem"===e.type&&(e.children.forEach((e=>{e.level&&e.hide()})),e.floor)){this.cutLevel(e.getGroup().uuid,e.floor);for(let t=0;t<F.length;t++)F[t].uuid===e.getGroup().uuid&&(F.splice(t,1),t--);F.push({uuid:e.getGroup().uuid,level:e.floor})}}))})).catch((e=>{logger.error(e)}))}))},this.getResourceScene=async(e,t,r,n,i)=>{if(null!=e.sceneName&&(_context.sceneName=e.sceneName),this.resetSettings(),!(e.objectTree.children instanceof Array))return void this.applyEffectSettings(e,t,r);let a=0,o=[],s=[];for(let e in m.gltfLoader.requestHeader)s.push({key:e,value:m.gltfLoader.requestHeader[e]});this.contentLengthPromisesRemove(e.objectTree.children,o,s),Promise.all(o).then((o=>{if(o instanceof Array)for(let e of o)a+=Number(e);logger.debug(a);let s=[],l=[],c=0;for(let t=0;t<e.objectTree.children.length;t++)s.push(new Promise((o=>{if("ModelItem"===e.objectTree.children[t].type)i.addModel({name:e.objectTree.children[t].name,modelPath:e.objectTree.children[t].modelPath,transform:e.objectTree.children[t].transform,index:e.objectTree.children[t].index,isVisible:null==e.objectTree.children[t].isVisible||e.objectTree.children[t].isVisible,isLock:null!=e.objectTree.children[t].isLock&&e.objectTree.children[t].isLock},(e=>{o(e)}),(n=>{if(r){var i={name:e.objectTree.children[t].name,parent:"model",loaded:n.loaded};for(let e=0;e<l.length;e++)if(l[e].name===i.name&&l[e].parent===i.parent){var o=i.loaded-l[e].loaded;l.splice(e,1),e--}o||(o=i.loaded),l.push(i),c+=o,r({type:"progress",total:a,loaded:c})}logger.debug("progress",n)}),n);else if("IconAsset"===e.objectTree.children[t].type)new IconItem(e.objectTree.children[t],n,(e=>{o(e)}),i);else if("GroupItem"===e.objectTree.children[t].type){let r=new GroupItem(e.objectTree.children[t],null,n,i);e.objectTree.children[t].children.map((e=>{switch(e.type){case"IconAsset":new IconItem(e,r);break;case"ModelAsset":r.childrenAdd(new InstancedObject(e,r))}})),o(1)}else if("BuildingItem"===e.objectTree.children[t].type){var s=e.objectTree.children[t].children,h=0,u=0;if(0===s.length)i.addBuilding(e.objectTree.children[t],(e=>{o(e)}),(()=>{}),n);else{for(let e=0;e<s.length;e++)switch(s[e].type){case"ModelItem":case"IconAsset":h++;break;case"BuildingFloorItem":if(0===s[e].children.length)h=1;else for(let t=0;t<s[e].children.length;t++)h++}i.addBuilding(e.objectTree.children[t],(e=>{1===e&&++u===h&&(o(e),u=0,h=0)}),(e=>{if(r){let t;for(let r=0;r<l.length;r++)l[r].name===e.name&&l[r].parent===e.parent&&(t=e.loaded-l[r].loaded,l.splice(r,1),r--);t||(t=e.loaded),l.push(e),c+=t,r({type:"progress",total:a,loaded:c})}logger.debug("progress",e)}),n)}}})));Promise.all(s).then((()=>{t()})).catch((e=>{logger.error(e)}))}))},this.applyEffectSettings=(e,t,r)=>{r&&r({type:"progress",total:1,loaded:1}),_context.sceneSettings=util$1.cloneDeep(e);let n=util$1.cloneDeep(e.view.camera);D.azimuthAngle=n.azimuth,D.inclinationAngle=n.inclination,D.fov=n.fov,D.viewDistance=n.distance,D.near=n.viewDistanceMin,D.far=n.viewDistanceMax,D.targetX=n.targetX,D.targetY=n.targetY,D.targetZ=n.targetZ,D.inclinationAngleMin=n.inclinationAngleMin,D.inclinationAngleMax=n.inclinationAngleMax,e.background&&(_context.background.mode=e.background.mode),_context.background.color=null,_context.background.texture=null,e.background&&(e.background.colorCSSValue&&this.setBackgroundColor(e.background.colorCSSValue),e.background.textureURL&&this.setBackgroundImage(e.background.textureURL),e.background.mode&&this.setBackgroundMode(e.background.mode,e)),this.defaultEffectStore.applySettings(e.effects),e.datumShiftModel&&this.setDatumShiftModel(e.datumShiftModel),_context.stateStore&&_context.stateStore.applySettings(e.states),null!=e.sceneModelTransform&&null!=e.sceneModelTransform.position&&(_context.scene.models.position.x=e.sceneModelTransform.position.x,_context.scene.models.position.y=e.sceneModelTransform.position.y,_context.scene.models.position.z=e.sceneModelTransform.position.z,_context.scene.models.rotation._order=e.sceneModelTransform.rotation._order,_context.scene.models.rotation._x=e.sceneModelTransform.rotation._x,_context.scene.models.rotation._y=e.sceneModelTransform.rotation._y,_context.scene.models.rotation._z=e.sceneModelTransform.rotation._z,_context.scene.models.scale.x=e.sceneModelTransform.scale.x,_context.scene.models.scale.y=e.sceneModelTransform.scale.y,_context.scene.models.scale.z=e.sceneModelTransform.scale.z),e.mapWorldRotationY&&(I=e.mapWorldRotationY),_context.paintControls&&_context.paintControls.updateWorld(),_context.lightStore.applySettings(e.lights,(()=>{t&&t(1,"applySettings() 加载完毕。")}),e.view.camera.duration),logger.debug("applySettings() 加载完毕。")},this.contentLengthPromisesRemove=(e,t,r)=>{e.map((e=>{if("ModelItem"===e.type){if(-1!=e.modelPath.indexOf("[[origin]]"))var n=e.modelPath.replace("[[origin]]",_context.origin);else n=e.modelPath;t.push(util$1.fetchContentLength(n,r))}else e.children&&e.children.length>0&&this.contentLengthPromisesRemove(e.children,t,r)}))},this.applySceneSettings=(e,t)=>{this.resetSettings(),e.background&&(_context.background.mode!=e.background.mode&&(this.crossfadeFreeze(),this.crossfade(1e3)),_context.background.mode=e.background.mode),_context.background.color=null,_context.background.texture=null,e.background&&(e.background.colorCSSValue&&(this._backgroundColorType!=e.background.colorCSSValue.type&&(this.crossfadeFreeze(),this.crossfade(1e3)),this._backgroundColorType=e.background.colorCSSValue.type,"single"==e.background.colorCSSValue.type?(this._backgroundColor1!=e.background.colorCSSValue.color1&&(this.crossfadeFreeze(),this.crossfade(1e3)),this._backgroundColor1=e.background.colorCSSValue.color1):"gradient"==e.background.colorCSSValue.type&&(this._backgroundColorUrl!=e.background.colorCSSValue.dataUrl&&(this.crossfadeFreeze(),this.crossfade(1e3)),this._backgroundColorUrl=e.background.colorCSSValue.dataUrl),this.setBackgroundColor(e.background.colorCSSValue)),e.background.textureURL&&this.setBackgroundImage(e.background.textureURL),e.background.mode&&this.setBackgroundMode(e.background.mode,e)),this.defaultObjectTree.applySettings(e.objectTree),this.defaultEffectStore.applySettings(e.effects),e.datumShiftModel&&this.setDatumShiftModel(e.datumShiftModel),_context.lightStore.applySettings(e.lights,(()=>{}),e.view.camera.duration),this.defaultObjectTree.children.forEach((e=>{if("BuildingItem"===e.type)if(e.children.forEach((e=>{e.level&&e.hide()})),e.floor){this.cutLevel(e.getGroup().uuid,e.floor);for(let t=0;t<F.length;t++)F[t].uuid===e.getGroup().uuid&&(F.splice(t,1),t--);F.push({uuid:e.getGroup().uuid,level:e.floor})}else this.cutLevel(e.getGroup().uuid,e.floor)})),this.nextRender((()=>{this.setAutoRotate(!1,0),this.defaultView.applySettings(e.view,(r=>{t&&t(r,"状态切换成功"),this.focus(),this.setAutoRotate(e.view.camera.autoRotate,util$1.getAutoRotateTime(e.view.camera.autoRotateSpeed,e.view.camera.autoRotateDirection))}))}),1),logger.debug("applySceneSettings() 应用完毕。")},this.saveSceneSettings=e=>{_context.sceneSettings=util$1.clone(e)},this.loadSceneSettings=()=>util$1.clone(_context.sceneSettings),this.disableLightProbe=()=>{_context.lightStore.disableLightProbe()},this.enableLightProbe=()=>{_context.lightStore.enableLightProbe()},this.off=(e,r,n)=>{t?t.remove(e,r,n):logger.error("事件处理管理器错误。")},this.on=(e,r,n)=>{t?t.add(e,r,n):logger.error("事件处理管理器错误。")},this._transformControlKeyUp=function(e){switch(e.keyCode){case 16:_context.transformControls.setTranslationSnap(null),_context.transformControls.setRotationSnap(null),_context.transformControls.setScaleSnap(null)}},this._transformControlKeyDown=function(e){e.keyCode},this.enableTransformOnModel=e=>{if(!_context.scene)return!1;if(!this.defaultObjectTree.getItemByName(e))return;let t=this.defaultObjectTree.getItemByName(e).getGroup();return!!(t&&t instanceof Object3D)&&(_context.transformControls.attach(t),this.setTransformMode("translate"),window.addEventListener("keydown",this._transformControlKeyDown),window.addEventListener("keyup",this._transformControlKeyUp),!0)},this.enableTransformOnNode=(e,t)=>{if(!_context.scene)return;if(this.disableTransform(),!this.defaultObjectTree.getItemByName(e))return;let r=this.defaultObjectTree.getItemByName(e).getGroup();if(r&&r instanceof Object3D){let e;if(r.traverse((function(r){r.name===t&&(e=r)})),e)return _context.transformControls.attach(e),this.setTransformMode("translate"),window.addEventListener("keydown",this._transformControlKeyDown),window.addEventListener("keyup",this._transformControlKeyUp),!0}return _context.effectStore.highlightObject(void 0),!1},this.transformControlChangeEvent=e=>{let t=e.target.object,r={};t&&(r.position=JSON.parse(JSON.stringify(t.position)),r.rotation=JSON.parse(JSON.stringify(t.rotation)),r.rotation.x=r.rotation._x,r.rotation.y=r.rotation._y,r.rotation.z=r.rotation._z,r.scale=JSON.parse(JSON.stringify(t.scale)),r.rotation.x=r.rotation._x=MathUtils.radToDeg(r.rotation._x),r.rotation.y=r.rotation._y=MathUtils.radToDeg(r.rotation._y),r.rotation.z=r.rotation._z=MathUtils.radToDeg(r.rotation._z)),_context.TransformChangeCallback&&_context.TransformChangeCallback(e,r)},this.enableTransformByUUID=(e,t)=>{if(!_context.scene)return!1;let r=_context.scene.models.getObjectByProperty("uuid",e);return!!(r&&r instanceof Object3D)&&(t&&(_context.TransformChangeCallback=t),_context.transformControls.addEventListener("objectChange",this.transformControlChangeEvent),_context.transformControls.attach(r),this.setTransformMode("translate"),window.addEventListener("keydown",this._transformControlKeyDown),window.addEventListener("keyup",this._transformControlKeyUp),!0)},this.getTransformMode=()=>_context.scene&&_context.transformControls?_context.transformControls.getMode():"",this.setTransformMode=e=>{if(!_context.scene||!_context.transformControls||"string"!=typeof e)return!1;switch(e.toLowerCase()){case"translate":case"rotate":case"scale":return L||_context.transformControls.setMode(e.toLowerCase()),!0}return!1},this.disableTransform=()=>{_context.scene&&(L||(_context.transformControls.removeEventListener("objectChange",this.transformControlChangeEvent),_context.transformControls.detach(),window.removeEventListener("keydown",this._transformControlKeyDown),window.removeEventListener("keyup",this._transformControlKeyUp)))},this.saveSceneCamera=()=>{D=JSON.parse(JSON.stringify(this.getCamera()))},this.onMapWorld=()=>{this.saveSceneCamera(),this.switchCameraMode(1),P=_context.background.mode,this.setBackgroundMode("none"),_context.orthoCameraControls.keyOperate="translation",_context.transformControls.attach(_context.scene.models),this.setTransformMode("rotate"),_context.transformControls.showX=!1,_context.transformControls.showY=!0,_context.transformControls.showZ=!1,k.rotation=JSON.parse(JSON.stringify(_context.scene.models.rotation)),I&&_context.scene.models.rotation.set(0,MathUtils.degToRad(I),0),L=!0},this.offMapWorld=()=>{L&&(L=!1,this.switchCameraMode(0),P&&this.setBackgroundMode(P),P=null,"editor"===_context.pointerMode?_context.orthoCameraControls.keyOperate="paint":_context.orthoCameraControls.keyOperate=null,this.disableTransform(),_context.transformControls.showX=!0,_context.transformControls.showY=!0,_context.transformControls.showZ=!0,_context.transformControls.showE=!1,I=this.getSceneRotationY(),this.notState&&(this.notState.datumShiftModel=JSON.parse(JSON.stringify(this.getSettings().datumShiftModel))),_context.scene.models.rotation.order=k.rotation._order,_context.scene.models.rotation.x=k.rotation._x,_context.scene.models.rotation.y=k.rotation._y,_context.scene.models.rotation.z=k.rotation._z)},this.onMapWorld1=()=>{_context.scene.models&&!L&&(this.switchCameraMode(1),P=_context.background.mode,this.setBackgroundMode("none"),this.leftButtonHandle("translation"),_context.transformControls.attach(_context.scene.models),window.addEventListener("keydown",this._transformControlKeyDown),window.addEventListener("keyup",this._transformControlKeyUp),this.setTransformMode("rotate"),_context.transformControls.showX=!1,_context.transformControls.showY=!1,_context.transformControls.showZ=!1,_context.transformControls.showE=!0,this.on("camerazoom","",(e=>{e.wheelDelta>0?(_context.scene.models.scale.x+=.05,_context.scene.models.scale.y+=.05,_context.scene.models.scale.z+=.05):(_context.scene.models.scale.x-=.05,_context.scene.models.scale.y-=.05,_context.scene.models.scale.z-=.05)})),k.position=JSON.parse(JSON.stringify(_context.scene.models.position)),k.rotation=JSON.parse(JSON.stringify(_context.scene.models.rotation)),k.scale=JSON.parse(JSON.stringify(_context.scene.models.scale)),_isWorldMapModelTransform&&(_context.scene.models.position.x=_isWorldMapModelTransform.position.x,_context.scene.models.position.y=_isWorldMapModelTransform.position.y,_context.scene.models.position.z=_isWorldMapModelTransform.position.z,_context.scene.models.rotation.order=_isWorldMapModelTransform.rotation._order,_context.scene.models.rotation.x=_isWorldMapModelTransform.rotation._x,_context.scene.models.rotation.y=_isWorldMapModelTransform.rotation._y,_context.scene.models.rotation.z=_isWorldMapModelTransform.rotation._z,_context.scene.models.scale.x=_isWorldMapModelTransform.scale.x,_context.scene.models.scale.y=_isWorldMapModelTransform.scale.y,_context.scene.models.scale.z=_isWorldMapModelTransform.scale.z),L=!0)},this.offMapWorld1=()=>{L&&(L=!1,this.switchCameraMode(0),P&&this.setBackgroundMode(P),P=null,this.leftButtonHandle(null),this.disableTransform(),_context.transformControls.showX=!0,_context.transformControls.showY=!0,_context.transformControls.showZ=!0,_context.transformControls.showE=!1,this.off("camerazoom","",""),_isWorldMapModelTransform.position=JSON.parse(JSON.stringify(_context.scene.models.position)),_isWorldMapModelTransform.rotation=JSON.parse(JSON.stringify(_context.scene.models.rotation)),_isWorldMapModelTransform.scale=JSON.parse(JSON.stringify(_context.scene.models.scale)),_context.scene.models.position.x=k.position.x,_context.scene.models.position.y=k.position.y,_context.scene.models.position.z=k.position.z,_context.scene.models.scale.x=k.scale.x,_context.scene.models.scale.y=k.scale.y,_context.scene.models.scale.z=k.scale.z)},this.getItemByName=e=>this.defaultObjectTree.getItemByName(e),this.findNodeByName=e=>this.defaultObjectTree.findNodeByName(e),this.addCubeCamera=(e,t,r)=>{let n=t.name;if(_context.ssr.find((t=>t.nodeName===n&&t.modelName===e&&t.materialName===r)))return;let i=new WebGLCubeRenderTarget(256,{format:RGBFormat,generateMipmaps:!0,minFilter:LinearMipmapLinearFilter}),a=new CubeCamera(1,2e3,i),o=(new Box3).setFromObject(_context.scene.models.getObjectByProperty("uuid",t.uuid||t.id)),s=new Vector3;o.getSize(s),a.position.y=s.y/2,a.name=util$1.randomString(8),_context.scene.models.getObjectByProperty("uuid",t.uuid||t.id).add(a),o=null,s=null,_context.ssr.push({cubeRenderTarget:i,cubeCamera:a,nodeName:n,modelName:e,materialName:r})},this.materialsInModelItem=(e,t)=>{var r=!1;for(let n in e)n===t.material&&e[n]._modelName===t.modelName&&(r=!0);return r},this.ssrOn=(e,t)=>{var r=null,n=null;if(N){let t=this.defaultObjectTree.getItemByUUID(N);for(let n=0;n<t.children.length&&!(r=util$1.findModelItemNodeByName(t.children[n],e));n++);}else if(t){let n=this.defaultObjectTree.getItemByName(t);for(let t=0;t<n.children.length&&!(r=util$1.findModelItemNodeByName(n.children[t],e));t++);}else r=this.findNodeByName(e);if(!r)return;if(r.enableSSR=!0,!r.modelName&&!t)return;n=t?this.defaultObjectTree.findModelFromBuilding(void 0,t,"modelName"):this.defaultObjectTree.findModelFromBuilding(void 0,r.modelName,"modelName");let i=this.defaultObjectTree.children.find((e=>e.name===n.name));if(i){var a={};null!=i.getMaterials?a=i:i.children.forEach((e=>{"ModelItem"===e.type?this.materialsInModelItem(e.materialStore._materials,r)&&(a=e):"BuildingFloorItem"===e.type&&e.children.forEach((e=>{e.materialStore&&this.materialsInModelItem(e.materialStore._materials,r)&&(a=e)}))})),a.materialStore&&("string"==typeof r.material?a.materialStore._materials[r.material].enableSSR&&this.addCubeCamera(a.name,r,r.material):r.material instanceof Array&&r.material.map((e=>{a.materialStore._materials[e].enableSSR&&this.addCubeCamera(a.name,r,e)})))}},this.ssrOff=(e,t)=>{let r=null;if(N){let t=this.defaultObjectTree.getItemByUUID(N);for(let n=0;n<t.children.length&&(r=util$1.findModelItemNodeByName(t.children[n],e),!r);n++);}else if(t){let n=this.defaultObjectTree.getItemByName(t);for(let t=0;t<n.children.length&&(r=util$1.findModelItemNodeByName(n.children[t],e),!r);t++);}else r=this.findNodeByName(e);if(r){r.enableSSR=!1;for(let t=0;t<_context.ssr.length;t++)_context.ssr[t].nodeName===e&&_context.ssr[t].modelName===r.modelName&&(this.findMaterialInModel(_context.ssr[t].modelName,_context.ssr[t].materialName)._material().envMap.dispose(),this.findMaterialInModel(_context.ssr[t].modelName,_context.ssr[t].materialName)._material().envMap=null,_context.ssr.splice(t,1))}},this.snapOn=(e,t)=>{switch(e){case"translation":_context.transformControls.translationSnap=t;break;case"rotation":_context.transformControls.rotationSnap=t/180*Math.PI;break;case"scale":_context.transformControls.scaleSnap=t}},this.snapOff=e=>{switch(e){case"translation":_context.transformControls.translationSnap=null;break;case"rotation":_context.transformControls.rotationSnap=null;break;case"scale":_context.transformControls.scaleSnap=null}},this.fadeOut=(e,t,r)=>{if(_context.renderer&&_context.renderer.domElement&&t)var n=_context.renderer.domElement.style.opacity||1,i=(e=e/100||10,setInterval((function(){n>0?_context.renderer.domElement.style.opacity=n=parseFloat(n-.1).toFixed(2):(clearInterval(i),r&&r())}),e));else r&&r()},this.fadeIn=(e,t)=>{if(!_context.renderer||!_context.renderer.domElement)return;let r=_context.renderer.domElement.style.opacity;if(""!==r&&1!==r)var n=_context.renderer.domElement.style.opacity||0,i=(e=e/100||10,setInterval((function(){n<1?_context.renderer.domElement.style.opacity=n=(parseFloat(n)+.1).toFixed(2):(clearInterval(i),t&&t())}),e));else t&&t()},this.clipNode=(e,t,r,n,i)=>{_context.clippingController&&(_context.clippingController.clear(),delete _context.clippingController),_context.clippingController=new ClippingController({meshes:[_context.scene.getObjectByName(e)],clippingPlanes:[{nx:t,ny:r,nz:n,d:i}]})},this.cutLevel=(e,t,r,n=!0)=>{var i=this.defaultObjectTree.getItemByUUID(e);if(i||(i=this.defaultObjectTree.getItemByName(e),e=i.getGroup().uuid),i||r&&r(0,"建筑不存在"),t){_context.clippingStore.findCutBulidingByUUID(e)&&_context.clippingStore.remove(e),i.floor=t,i.children.forEach((r=>{if(r.level===Number(t)){let t=(new Box3).setFromObject(r.getGroup()),n=new Vector3;t.getSize(n),_context.clippingStore.add(e,0,-1,0,t.max.y+.02*n.y),this.defaultObjectTree.getItemByUUID(e).children.forEach((e=>{if("IconAsset"===e.type){(e.getGroup().position.y||e.transform.position.y)>t.max.y?e.clipping=!0:e.clipping=!1}}))}})),n&&(this.defaultObjectTree.getItemByUUID(e)?this.defaultObjectTree.getItemByUUID(e).children.forEach((e=>{e.level===t?e.show():e.level&&e.hide()})):this.defaultObjectTree.getItemByName(e).children.forEach((e=>{e.level===t?e.show():e.level&&e.hide()})));for(let t=0;t<F.length;t++)F[t].uuid===e&&(F.splice(t,1),t--);let a={uuid:e,level:t};F.push(a),r&&r(1,"建筑拆解完成")}else{i.floor=t,_context.clippingStore.findCutBulidingByUUID(e)&&_context.clippingStore.remove(e),this.defaultObjectTree.getItemByUUID(e)?this.defaultObjectTree.getItemByUUID(e).children.forEach((t=>{if(t.level){n&&t.hide();let r=(new Box3).setFromObject(t.getGroup()),i=new Vector3;r.getSize(i),this.defaultObjectTree.getItemByUUID(e).children.forEach((e=>{if("IconAsset"===e.type){(e.getGroup().position.y||e.transform.position.y)>r.max.y&&(e.clipping=!1)}}))}})):n&&this.defaultObjectTree.getItemByName(e).children.forEach((e=>{e.level&&e.hide()}));for(let t=0;t<F.length;t++)F[t].uuid===e&&(F.splice(t,1),t--);r&&r(1,"建筑恢复完成")}},this.cutLevelByUUID=(e,t=!0)=>{let r=this.defaultObjectTree.getItemByUUID(e);if(r)if("BuildingItem"===r.type){if(!r.floor&&t)return void this.defaultObjectTree.getItemByUUID(e).children.forEach((e=>{e.level&&e.hide()}));this.cutLevel(e,r.floor,(()=>{}),t)}else{if(!r.getGroup)return;if(!r.getGroup().parent)return;this.cutLevelByUUID(r.getGroup().parent.uuid,t)}},this.setPaintMode=function({mode:e="roam",size:t=1,assets:r=[]},n,i){_context.paintControls&&_context.paintControls.setMode(e,t,r,n,i)},this.setPaintLayerName=function(e){_context.paintControls&&_context.paintControls.setLayerName(e)},this.setPaintData=function(e){_context.paintControls&&_context.paintControls.setData(e)},this.setOrbitDamping=e=>{"number"==typeof e&&(0===e&&(_context.orbitControls.enableDamping=!1),e>0&&(_context.orbitControls.dampingFactor=e))},this.getIconAsset=e=>{if(e)return this.defaultObjectTree.getAsset(e,"IconAsset")},this.objectIsHidedByName=e=>{_pitchOnModelName=e;let t=this.defaultObjectTree.children;if(e)F.forEach((e=>{_context.clippingStore.remove(e.name)})),B&&0===B.length&&(B=JSON.parse(JSON.stringify({children:util$1.getSettingsRecursively(t)}))),t.map((e=>{switch(e.type){case"ModelItem":case"IconAsset":e.hide();break;case"BuildingItem":e.hide(),e.children.map((e=>{switch(e.type){case"ModelItem":e.hide();break;case"BuildingFloorItem":e.hide(),e.children.map((e=>{e.hide()}))}}))}})),t.map((t=>{if(t.name===e)switch(t.type){case"ModelItem":t.show();break;case"BuildingItem":t.show(),t.children.map((e=>{switch(e.type){case"ModelItem":e.show();break;case"BuildingFloorItem":e.show(),e.children.map((e=>{e.show()}))}}))}else"BuildingItem"===t.type&&t.children.map((r=>{if(r.name===e)switch(t.show(),r.type){case"ModelItem":r.show();break;case"BuildingFloorItem":r.show(),r.children.map((e=>{e.show()}))}else"BuildingFloorItem"===r.type&&r.children.map((n=>{n.name===e&&(t.show(),r.show(),n.show())}))}))}));else{F.forEach((e=>{this.defaultObjectTree.getItemByName(e.name).children.forEach((t=>{if(t.level===Number(e.level)){let r=(new Box3).setFromObject(t.getGroup()),n=new Vector3;r.getSize(n),_context.clippingStore.add(e.name,0,-1,0,r.max.y+.02*n.y)}}))})),this.defaultObjectTree.children.map((e=>{B.children.map((t=>{e.name===t.name&&("ModelItem"===e.type||"IconAsset"===e.type?t.isVisible?e.show():e.hide():"BuildingItem"===e.type&&(t.isVisible?e.show():e.hide(),e.children.length>0&&e.children.map((e=>{t.children.map((t=>{e.name===t.name&&("ModelItem"===e.type||"IconAsset"===e.type?t.isVisible?e.show():e.hide():"BuildingFloorItem"===e.type&&(t.isVisible?e.show():e.hide(),e.children.length>0&&e.children.map((e=>{t.children.map((t=>{e.name===t.name&&(t.isVisible?e.show():e.hide())}))}))))}))}))))}))})),B=[]}},this.objectIsHidedByUUID=e=>{e&&!N&&(this.saveSceneCamera(),P=_context.background.mode),N=e;let t=this.defaultObjectTree.children;if(e)F.forEach((e=>{_context.clippingStore.remove(e.uuid)})),0===B.length&&(B=JSON.parse(JSON.stringify({children:util$1.getSettingsRecursively(t)}))),util$1.setObjectTreeIsHideRecursion(t),util$1.setObjectTreeShowByUUID(t,e);else{F.forEach((e=>{var t=this.defaultObjectTree.getItemByUUID(e.uuid);t||(t=this.defaultObjectTree.getItemByName(e.uuid)),t&&t.children.forEach((t=>{if(t.level===Number(e.level)){let r=(new Box3).setFromObject(t.getGroup()),n=new Vector3;r.getSize(n),_context.clippingStore.add(e.uuid,0,-1,0,r.max.y+.02*n.y)}}))}));let e=this.defaultObjectTree.children;util$1.recoverIsShowOrHide(B.children,e),B=[]}},this.crossfadeFreeze=()=>{_context.crossfade||(_context.crossfade=!0,G(),_context.crossfadeImageElement=document.createElement("img"),_context.crossfadeImageElement.style.position="absolute",_context.crossfadeImageElement.style.height=_context.renderer.domElement.clientHeight+"px",_context.crossfadeImageElement.style.width=_context.renderer.domElement.clientWidth+"px",_context.crossfadeImageElement.style.left=_context.renderer.domElement.clientLeft+"px",_context.crossfadeImageElement.style.top=_context.renderer.domElement.clientTop+"px",_context.crossfadeImageElement.style.pointerEvents="none",_context.crossfadeImageElement.src=_context.renderer.domElement.toDataURL(),_context.renderer.domElement.parentElement.appendChild(_context.crossfadeImageElement))},this.crossfade=e=>{if(!_context.crossfade||_context.onCrossfade)return;_context.onCrossfade=!0;var t=.9;let r;e=e/100||10;let n=(new Date).getTime();this.nextRender((()=>{var i;i=setInterval((function(){_context.crossfadeImageElement&&(r=((new Date).getTime()-n)/(e/10),(new Date).getTime()-n>100&&(r=100/(e/10)),n=(new Date).getTime(),t>0?_context.crossfadeImageElement.style.opacity=t-=.001*r:(clearInterval(i),_context.crossfadeImageElement.parentElement.removeChild(_context.crossfadeImageElement),_context.crossfadeImageElement=null,_context.crossfade=!1,_context.onCrossfade=!1))}),e)}))},this.saveCamera=e=>{void 0!==e&&(e?(U=this.getCamera(),_context.instance._notView=JSON.parse(JSON.stringify(this.defaultView.getSettings()))):U&&(U.target={x:U.targetX,y:U.targetY,z:U.targetZ},U.distance=U.viewDistance,U.duration=1.5,U.far=this.getCamera().far,U.fov=this.getCamera().fov,U.near=this.getCamera().near,U.duration=1.5,this.setCamera(U)))},this.getSceneRotationY=()=>{var e=new Vector3(0,0,1);return _context.scene.models.quaternion.setFromEuler(_context.scene.models.rotation),e.applyQuaternion(_context.scene.models.quaternion),(MathUtils.radToDeg(Math.atan2(-e.x,-e.z))+180+180)%360-180},this.setFPSLimit=e=>{"number"!=typeof e||e<1||e>240||isNaN(e)||(_context.frameTimeLimit=1/(1.013*e))},this.getSettings=e=>{if(e&&""!=this.getCurrentState())return this.notState?(this.notState.states=_context.stateStore.getSettings(),this.notState):this.getSettings();let t={};return t.objectTree=this.defaultObjectTree.getSettings(),B.children&&B.children.length>0&&util$1.recoverShowGetSettings(B.children,t.objectTree.children),t.states=_context.stateStore.getSettings(),t.effects={visualEffect:this.defaultEffectStore.visualEffect.getSettings(),spaceEffect:this.defaultEffectStore.spaceEffect.getSettings()},t.background={mode:_context.background.mode,colorCSSValue:_context.background.colorCSSValue,textureURL:_context.background.textureURL},t.lights=_context.lightStore.getSettings(),t.lights.skybox=S,t.datumShiftModel=_context.datumShiftModel,t.view=this.defaultView.getSettings(),(L||N)&&(e||(t.view.camera.azimuth=D.azimuthAngle,t.view.camera.inclination=D.inclinationAngle,t.view.camera.distance=D.viewDistance,t.view.camera.targetX=D.targetX,t.view.camera.targetY=D.targetY,t.view.camera.targetZ=D.targetZ,t.view.camera.inclinationAngleMin=D.inclinationAngleMin,t.view.camera.inclinationAngleMax=D.inclinationAngleMax,L&&!N&&(t.view.camera.viewDistanceMin=D.near,t.view.camera.viewDistanceMax=D.far,t.view.camera.fov=D.fov),t.background.mode=P)),t.sceneModelTransform={},L&&(t.sceneModelTransform.position=_context.scene.models.position,t.sceneModelTransform.rotation=_context.scene.models.rotation,t.sceneModelTransform.scale=_context.scene.models.scale),t.mapWorldRotationY=!L&&I?I:this.getSceneRotationY(),_context.effectStore.visualEffect._passes.outlinePass.effects[0].time=0,t.sceneName=_context.sceneName,t.colorSpace=this.getColorSpace(),t},this.getSettingsToJSON=e=>JSON.stringify(this.getSettings(),0,e?2:0),this.highlightMaterial=(e,t)=>{if(!_context.scene)return;_context.highlight||(_context.highlight={material:void 0}),e||t||_context.highlight.material&&_context.highlight.material._material()instanceof Material$1&&(delete _context.highlight.material._material().onBeforeCompile,_context.highlight.material._material().needsUpdate=!0,_context.highlight.material=void 0);let r=this.defaultObjectTree.findItemByName(e);if(!r)return;let n=r.findMaterial(t);n&&n._material()instanceof Material$1&&_context.highlight.material!==n&&(_context.highlight.material&&_context.highlight.material._material()instanceof Material$1&&(delete _context.highlight.material._material().onBeforeCompile,_context.highlight.material._material().needsUpdate=!0,_context.highlight.material=void 0),_context.highlight.material=n,n._material().onBeforeCompile=e=>{e.vertexShader=e.vertexShader.replace("void main() {",["varying vec2 vUvHighlight;","void main() {","  vUvHighlight = uv;"].join("\n")),e.fragmentShader=e.fragmentShader.replace("void main() {",["varying vec2 vUvHighlight;","void main() {"].join("\n")),e.fragmentShader=e.fragmentShader.replace("#include <map_fragment>",["#ifdef USE_MAP","  vec4 texelColor = mapTexelToLinear( texture2D( map, vUv ) );","\t diffuseColor = texelColor * diffuseColor;","#endif","float fracX = fract(vUvHighlight.x * 10.0);","float fracY = fract(vUvHighlight.y * 10.0);","if (abs(fracX - 0.5) <= 0.1 && abs(fracY - 0.5) <= 0.1) {","  diffuseColor = mix(diffuseColor, vec4(1.0, 0.15, 0.75, 1.0), 0.9);","}"].join("\n"))},n._material().needsUpdate=!0)},this.highlightModel=(e,t)=>{if(!_context.scene)return;if(!e)return _context.effectStore.highlightObject(void 0),!1;if(!this.defaultObjectTree.getItemByName(e))return;let r=this.defaultObjectTree.getItemByName(e).getGroup();if(r&&r instanceof Object3D){if("GroupItem"===r.type)r.getGroup().children.map((e=>{"Mesh"===e.type&&_context.effectStore.highlightObject(e,!0)}));else _context.effectStore.highlightObject(r,t);return!0}return _context.effectStore.highlightObject(void 0),!1},this.highlightNode=(e,t,r)=>{if(!_context.scene)return;if(!e)return _context.effectStore.highlightObject(void 0),!1;if(!this.defaultObjectTree.getItemByName(e))return;let n=this.defaultObjectTree.getItemByName(e).getGroup();if(null==t)return n?(_context.effectStore.highlightObject(n,r),!0):(_context.effectStore.highlightObject(void 0),!1);if(n&&n instanceof Object3D){let e;if(n.traverse((function(r){r.name===t&&(e=r)})),e)return _context.effectStore.highlightObject(e,r),!0}},this.highlightByUUID=(e,t)=>{let r=this.defaultObjectTree.getItemByUUID(e),n=null;if(z instanceof Array?(n=[],z.forEach((e=>{let t=this.defaultObjectTree.getItemByUUID(e);t&&n.push(t)}))):z&&(n=this.defaultObjectTree.getItemByUUID(z)),n&&n!==[]||(z=null),!_context.scene)return;if(_context.effectStore.highlightObject(void 0),!e)return _context.effectStore.highlightObject(void 0),n instanceof Array?n.forEach((e=>{e&&(e.getGroup().children[0].material.uniforms.outline.value=0)})):n&&(n.getGroup().children[0].material.uniforms.outline.value=0),z=null,!1;if(z){if(z==e)return;n instanceof Array?n.forEach((e=>{e&&(e.getGroup().children[0].material.uniforms.outline.value=0)})):n&&(n.getGroup().children[0].material.uniforms.outline.value=0),z=null}if(!r)return;if("IconAsset"===r.type)return z=e,r.getGroup().children[0].material.uniforms.outline.value=1,void _context.effectStore.highlightObject(void 0);"GroupItem"===r.type&&_context.effectStore.highlightObject(void 0);let i=null;return i=_context.scene.models.getObjectByProperty("uuid",e),!!i&&(i instanceof Object3D&&(z=[],i.traverse((e=>{"IconGroup"===e.type&&z.push(e.uuid)}))),z.length>0?(z.forEach((e=>{i.traverse((t=>{t.uuid===e&&(t.children[0].material.uniforms.outline.value=1)}))})),_context.effectStore.highlightObject(i)):_context.effectStore.highlightObject(i),!0)},this.highlightSpaceEffect=e=>{if(!_context.scene||!this.defaultEffectStore||!this.defaultEffectStore.spaceEffect)return;let t=this.defaultEffectStore.spaceEffect.findEffect(e);t?t.showHelper():this.defaultEffectStore.spaceEffect.hideHelpers()},this.highlightDirectionalLightHelper=(e,t)=>{if(!_context.scene)return;let r=_context.lightStore.findDirectionalLightHelper(e);if(r){t||_context.effectStore.highlightObject(void 0);for(let e of r.children)_context.effectStore.highlightObject(e,t);return!0}return _context.effectStore.highlightObject(void 0),!1},this.takeSnapshot=e=>_context.effectStore.takeSnapshot(e),this.getStatistics=()=>_context.renderer?_context.rendererInfo:{geometries:0,textures:0,calls:0,faces:0,vertices:0},this._debug=()=>({context:_context}),this._setInstancedObject=e=>{_context.instancedObject=new InstancedObject(e)},this.rotatingModel=e=>{e&&(_context.scene.models.traverse((t=>{if(t.name===e.id){let r=_context.animationStore.findNodeAnimation(t,NodeRotationAnimationController.type);r&&(r.reset(),_context.animationStore.remove(r));let n=0;0!==e.durationX&&(n=MathUtils.degToRad(60/e.durationX),"clockwise"==e.directionX&&(n=-n));let i=0;0!==e.durationY&&(i=MathUtils.degToRad(60/e.durationY),"clockwise"==e.directionY&&(i=-i));let a=0;0!==e.durationZ&&(a=MathUtils.degToRad(60/e.durationZ),"clockwise"==e.directionZ&&(a=-a)),r=new NodeRotationAnimationController(t,0!==e.durationX,0!==e.durationY,0!==e.durationZ,n,i,a),_context.animationStore.add(r)}})),setTimeout((()=>{this.cutLevelByUUID(e.id,!1)}),20))},this.setModelRotationState=e=>{e&&_context.scene.models.traverse((t=>{if(t.name===e.id){let r=_context.animationStore.findNodeAnimation(t,NodeRotationAnimationController.type);r&&("stop"==e.state?(r.reset(),_context.animationStore.remove(r)):"pause"==e.state?r.pause():"continue"==e.state&&r.resume())}}))},this.blinkingModel=e=>{if(e)for(let t=0;t<_context.scene.models.children.length;t++){const r=_context.scene.models.children[t];if(r.name===e.id){let t=_context.animationStore.findNodeAnimation(r,NodeBlinkingAnimationController.type);t&&(t.reset(),_context.animationStore.remove(t)),t=new NodeBlinkingAnimationController(r,e.duration,e.color,e.type),_context.animationStore.add(t);break}}},this.setModelBlinkState=e=>{e&&_context.scene.models.traverse((t=>{if(t.name===e.id){let r=_context.animationStore.findNodeAnimation(t,NodeBlinkingAnimationController.type);r&&("stop"==e.state?(r.reset(),_context.animationStore.remove(r)):"pause"==e.state?r.pause():"continue"==e.state&&r.resume())}}))},this.movingModel=e=>{e&&_context.scene.models.traverse((t=>{if(t.name===e.id){let r=_context.animationStore.findNodeAnimation(t,NodeMovingAnimationController.type);r&&(r.reset(),_context.animationStore.remove(r)),!e.points||e.points[0].speed&&0!=e.points[0].speed?e.points.splice(0,0,{x:t.position.x,y:t.position.y,z:t.position.z}):(t.position.x=e.points[0].x,t.position.y=e.points[0].y,t.position.z=e.points[0].z),r=new NodeMovingAnimationController(t,e.loopMode,e.reverse,e.direction,e.points,e.offset),_context.animationStore.add(r)}}))},this.setModelMoveState=e=>{e&&_context.scene.models.traverse((t=>{if(t.name===e.id){let r=_context.animationStore.findNodeAnimation(t,NodeMovingAnimationController.type);r&&("stop"==e.state?(r.reset(),_context.animationStore.remove(r)):"pause"==e.state?r.pause():"continue"==e.state&&r.resume())}}))},this.pathingModel=e=>{e&&(e.points.forEach((t=>{t.speed=e.speed})),_context.scene.models.traverse((t=>{if(t.name===e.id){let r=_context.animationStore.findNodeAnimation(t,NodeMovingAnimationController.type);r&&(r.reset(),_context.animationStore.remove(r)),r=new NodeMovingAnimationController(t,e.loopMode,e.reverse,e.direction,e.points,e.offset,e.pathId,e.passChange),_context.animationStore.add(r)}})))},this.updatePathingModel=(e,t,r)=>{_context.animationStore.findAnimationByPathId(e,NodeMovingAnimationController.type).forEach((n=>{n.reset();let i=n.points[0].speed;t.forEach((e=>{e.speed=i}));let a=new NodeMovingAnimationController(n.animationObject,n.loopMode,n.reverse,n.direction,t,n.offset,e,r);_context.animationStore.add(a),_context.animationStore.remove(n)}))},this.deletePathingModel=e=>{_context.animationStore.findAnimationByPathId(e,NodeMovingAnimationController.type).forEach((e=>{e.reset(),_context.animationStore.remove(e)}))},this.setModelPathingState=e=>{e&&_context.scene.models.traverse((t=>{if(t.name===e.id){let r=_context.animationStore.findNodeAnimation(t,NodeMovingAnimationController.type);r&&("stop"==e.state?(r.reset(),_context.animationStore.remove(r),e.passChange&&e.passChange({id:r.pathId,pass:0,ratio:0})):"pause"==e.state?r.pause():"continue"==e.state&&r.resume())}}))},this.selectModel=(e,t)=>{e&&_context.selectControl.startSelect({type:e.type,modelType:e.modelType,selectType:"select",events:t})},this.endSelectModel=e=>{e&&_context.selectControl.endSelect(e)},this.pickModel=(e,t)=>{e&&_context.selectControl.startSelect({type:e.type,modelType:e.modelType,selectType:"pick",events:t})},this.endPickModel=e=>{e&&_context.selectControl.endSelect(e)},this.clickModel=(e,t,r)=>{if(!e)return;let n="model"===e.modelType?"ModelItem":"BuildingItem",i=_context.scene.models.children.find((t=>t.name===e.id));if(i){if((_context.defaultObjectTree.findItemByObject3D(i)||{}).getType()===n){if(!0===i.visible){e.selected?_context.effectStore.highlightObject(i,!1):_context.effectStore.cancleHighlightObject(i);let n={type:e.modelType,id:i.name,selected:e.selected};r&&r(n),t&&t({result:1,message:"成功。"})}}else t&&t({result:0,message:"模型id和模型类型不匹配！"})}else t&&t({result:0,message:`模型${id}不存在！`})},this.clickModelType=(e,t)=>{if(!e)return;let r="model"===e.modelType?"ModelItem":"BuildingItem",n=[];_context.scene.models.children.forEach((t=>{(_context.defaultObjectTree.findItemByObject3D(t)||{}).getType()===r&&!0===t.visible&&(n.push(t),e.selected?_context.effectStore.highlightObject(t,!0):_context.effectStore.highlightObject())}));let i={type:e.modelType,selected:e.selected,data:n.map((e=>({id:e.name})))};t&&t(i)},this.clearModelSelected=e=>{_context.effectStore.highlightObject()},this.highlightBuilding=(e,t)=>{if(!e)return void(t&&t({result:0,message:"参数错误"}));let r=this.defaultObjectTree.getItemByName(e.id);r?("none"===e.type?_context.effectStore.highlightObject():_context.effectStore.highlightObject(r.getGroup(),!1),t&&t({result:1,message:"成功"})):t&&t({result:0,message:`建筑${e.id}不存在`})},this.highlightFloor=(e,t)=>{if(!e)return void(t&&t({result:0,message:"参数错误"}));let r,n=this.defaultObjectTree.getItemByName(e.id);n?"BuildingItem"===(_context.defaultObjectTree.findItemByObject3D(n.getGroup())||{}).getType()?(n.children.forEach((t=>{t.level===Number(e.floor)&&(r=t)})),r?("none"===e.type?_context.effectStore.highlightObject():this.highlightNode(n.name,r.name,!1),t&&t({result:1,message:"成功"})):t&&t({result:0,message:`楼层号${e.floor}不存在`})):t&&t({result:0,message:"指定的对象非建筑"}):t&&t({result:0,message:`建筑${e.id}不存在`})},this.highlightRoom=(e,t)=>{e?t&&t({result:0,message:"底层实现中..."}):t&&t({result:0,message:"参数错误"})},this.getBuildings=(e,t)=>{let r={result:1,message:"成功",buildings:[]};_context.scene.models.children.forEach((e=>{if("BuildingItem"===(_context.defaultObjectTree.findItemByObject3D(e)||{}).getType()){let t=this.defaultObjectTree.getItemByName(e.name),n={id:e.name,floors:[]};t.children.forEach((e=>{e.level&&n.floors.push({num:e.level,rooms:[]})})),r.buildings.push(n)}})),t&&t(r)},this.focusFloor=(e,t,r)=>{if(!e)return void(t&&t({result:0,message:"参数错误"}));let n,i=this.defaultObjectTree.getItemByName(e.buildingId);if(!i)return void(t&&t({result:0,message:`建筑${e.buildingId}不存在`}));if("BuildingItem"!==(_context.defaultObjectTree.findItemByObject3D(i.getGroup())||{}).getType())return void(t&&t({result:0,message:"指定的对象非建筑"}));if(i.children.forEach((t=>{t.level===Number(e.floor)&&(n=t)})),!n)return void(t&&t({result:0,message:`楼层号${e.floor}不存在`}));let a={floor:e.floor,idBuilding:e.buildingId};r.onFocusFloorStart&&r.onFocusFloorStart(a),this.setCameraToModel(n.name,0,{distance:e.distance}),r.onFocusFloorEnd&&r.onFocusFloorEnd(a),t&&t({result:1,message:"成功。"})},this.getInstancingProfile=()=>{let e={};_context.scene.models.traverse((t=>{if(!(t instanceof InstancedMesh))return;let r=`${t.parent.name} - ${t.name}`;"number"==typeof e[r]?e[r]++:e[r]=t.count}));let t=0,r=0;for(let n in e)r+=e[n],t++,logger.debug(`${n} 中的实例计数：${e[n]}`);logger.debug("实例网格（InstancedMesh）计数：",t),logger.debug("一个实例网格（InstancedMesh）中的实例（instance）平均数：",r/t)},this.getModelArticulation=(e,t)=>{if(!e)return void(t&&t({result:0,message:"参数错误"}));let r=this.defaultObjectTree.getItemByName(e.id);if(!r)return void(t&&t({result:0,message:`找不到名称为${e.id}的模型！`}));let n=[];r.articulations.forEach((e=>{let t={};switch(t.articulation=e.name,e.type){case"numeric":t.type="float",t.minValue=Math.min(...e._values),t.maxValue=Math.max(...e._values);break;case"boolean":t.type="bool";break;case"enum":t.type="enum",t.value=[...e._values];break;case"text":t.type="string"}n.push(t)})),t&&t({result:1,message:"成功",id:e.id,data:n})},this.setModelArticulation=(e,t)=>{if(!e)return void(t&&t({result:0,message:"参数错误"}));let r=this.defaultObjectTree.getItemByName(e.id);r?(e.data&&e.data.forEach((n=>{let i=r.articulations.find((e=>e._name==n.articulation));if(i){let t;switch(n.type){case"float":t=Number(n.value);break;case"enum":t=n.value;break;case"bool":t=Boolean(n.value)}i.set(t,e.duration)}else t&&t({result:0,message:`找不到名称为${n.articulation}的模型关节！`})})),t&&t({result:1,message:"成功"})):t&&t({result:0,message:`找不到名称为${e.id}的模型！`})},this.getModelAnimation=(e,t)=>{if(!e)return void(t&&t({result:0,message:"参数错误"}));let r=this.defaultObjectTree.getItemByName(e.id);if(!r)return void(t&&t({result:0,message:`找不到名称为${e.id}的模型！`}));let n=[];r.articulationAnimations.forEach((e=>{let t={};t.name=e.animationName,t.duration=0,e.articulationAnimationItems.forEach((e=>{t.duration+=e.continueTime}));let i=_context.animationStore.findAnimation(r.name+e.animationName,ArticulationAnimationGroupController.type);i?i.getIsPaused()?t.state="pause":t.state="playing":t.state="stop",n.push(t)})),t&&t({result:1,message:"成功",id:e.id,data:n})},this.playModelAnimation=(e,t)=>{if(!e)return void(t&&t({result:0,message:"参数错误"}));let r=this.defaultObjectTree.getItemByName(e.id);if(!r)return void(t&&t({result:0,message:`找不到名称为${e.id}的模型！`}));let n=r.articulationAnimations.find((t=>t.animationName===e.name));if(n){switch(e.state.toLocaleLowerCase()){case"begin":r.playArticulationAnimation(n.animationName);break;case"pause":r.pauseArticulationAnimation(n.animationName);break;case"restart":r.resumeArticulationAnimation(n.animationName);break;case"stop":r.resetArticulationAnimation(n.animationName)}t&&t({result:1,message:"成功"})}else t&&t({result:0,message:`找不到名称为${e.id}的动画！`})},this.addModelForApi=(e,t)=>{let r,n=!1;if(_context.instance.defaultObjectTree.children.forEach((t=>{t.name===e.id&&(n=!0),t.name===e.modelType&&(r=t)})),n)return void(t&&t({result:0,message:`模型${e.id}已经存在！`}));if(!r)return void(t&&t({result:0,message:`模型${e.modelType}不存在！`}));if(r.formApi)return void(t&&t({result:0,message:`模型${e.modelType}非可添加类型！`}));e.opacity="number"==typeof e.alpha&&e.alpha>=0&&e.alpha<=1?e.alpha:1;let i=_context.scene.models.children.find((t=>t.name==e.modelType));i||t&&t({result:1,message:`添加失败,未找到modelType为${e.modelType}的模型`});let a=util$1.cloneDeep(r.getSettings());if(a.name=e.id,a.loadModel=i,"ModelItem"==r.type&&_context.instance.defaultObjectTree.addItem(new ModelItem(a)),"IconAsset"==r.type&&new IconItem(a,null),"GroupItem"==r.type){let e=new GroupItem(a);a.children.forEach((t=>{switch(t.type){case"IconAsset":new IconItem(t,e);break;case"ModelAsset":let r={name:t.name,gltf:{scene:a.loadModel},transform:t.transform,points:t.points,matrix:t.matrix},n=e.children.find((e=>e.name===r.name));n?n.addInstanceIsMatrix(r.matrix):e.childrenAdd(new InstancedObject(r,e))}}))}"BuildingItem"==r.type&&_context.instance.defaultObjectTree.addBuilding(a),_context.instance.defaultObjectTree.children.find((t=>t.name===e.id)).formApi=!0;let o=i.clone();if(o.name=e.id,o.position.set(e.position.x,e.position.y,e.position.z),o.rotation.set(MathUtils.degToRad(e.rotation.x),MathUtils.degToRad(e.rotation.y),MathUtils.degToRad(e.rotation.z)),o.scale.set(e.scale.x,e.scale.y,e.scale.z),e.titleText){let t=new Group;t.name=e.id+"title";let r=X(t,{canvas:e.canvas,sizeAttenuation:!1,width:414e-6*e.canvas.width,height:414e-6*e.canvas.height,offsetV:.5,offsetH:.5,enableText:!0});r.name=e.id,r.position.set(e.position.x,e.position.y,e.position.z),o.children.push(t)}o.traverse((t=>{if("Mesh"==t.type)if(t.geometry=t.geometry.clone(),t.material instanceof Array){t.material=t.material.map((e=>e.clone()));for(let r of t.material)r.opacity=e.opacity,r.transparent=e.opacity<1}else t.material=t.material.clone(),t.material.opacity=e.opacity,t.material.transparent=e.opacity<1})),o.visible=""==(e.visible??"")||e.visible,o.activeVisible=o.visible,_context.scene.models.add(o),t&&t({result:1,message:"成功。"})},this.removeModelForApi=(e,t)=>{let r=_context.instance.defaultObjectTree.children.find((t=>t.name===e.id));if(!r)return void(t&&t({result:0,message:`模型${e.id}不存在！`}));if(!r.formApi)return void(t&&t({result:0,message:"非接口添加不能删除！"}));_context.instance.defaultObjectTree.removeItem(e.id);let n=_context.scene.models.children.find((t=>t.name==e.modelType));n&&util$1.disposeThreeObject(n),t&&t({result:1,message:"成功。"})},this.updateDrawableRenderOrder=(t,r)=>{if("string"!=typeof t)return!1;if("number"!=typeof r||r<0)return!1;let n=e.find(t);return!!n&&(n.renderOrder>=DRAWABLE_RENDER_ORDER_BASE&&(n.renderOrder=DRAWABLE_RENDER_ORDER_BASE+r,!0))},this.clampToModel=(e,t=!0)=>{if(!e)return void console.warn("clampToModel 接口参数无效。");if("number"!=typeof e.x||"number"!=typeof e.y||"number"!=typeof e.z)return void console.warn("clampToModel 接口参数无效。");w.set(new Vector3(e.x,e.y,e.z),new Vector3(0,-1,0));let r=w.intersectObjects(_context.scene.models.children,!0);if(0===r.length)return e;let n=-1;if(t){for(let e=0;e<r.length;e++)if(r[e].object.visible){n=e;break}if(-1===n)return e}else n=0;let i=r[n].point.clone();return{x:i.x,y:i.y,z:i.z}},this._debugClamp=(e=10,t=10,r=1,n=10)=>{for(let i=-Math.floor(e/2);i<e-Math.floor(e/2);i++)for(let e=-Math.floor(t/2);e<t-Math.floor(t/2);e++){let t={x:i*r,y:n,z:e*r},a=this.clampToModel(t),o={path:"./resource/icons/universal/icon_01.png",sizeAttenuation:!1,pos:t,width:30,height:30,enableAutoHidebyDistance:!1,pointMinDistance:10,pointMaxDistance:1e4,offsetV:.5,offsetH:.5,polygonOffset:!1,polygonOffsetFactor:.1,polygonOffsetUnits:1,isShow:!0,background:"icon_square",backgroundColor:"#0000ff"};this.addBillboard(`landmark-${i}-${e}`,o,void 0);let s={path:"./resource/icons/universal/icon_01.png",sizeAttenuation:!1,pos:a,width:60,height:60,enableAutoHidebyDistance:!1,pointMinDistance:10,pointMaxDistance:1e4,offsetV:.5,offsetH:.5,polygonOffset:!1,polygonOffsetFactor:.1,polygonOffsetUnits:1,isShow:!0,background:"icon_square",backgroundColor:"#ff0000"};this.addBillboard(`landmark2-${i}-${e}`,s,void 0)}},this.getWorldScale=()=>_context.worldScale,this.setSceneEffect=e=>{_context.drawableDepthTest=!e.isLayerTopMost},this.addGround=(e,t)=>{t=t||"#cfcfcf";const r=new PlaneGeometry;r.scale(e||2e3,e||2e3,1);let n=new Mesh(r,new MeshStandardMaterial({color:new Color(t),fog:!0}));n.rotateX(Math.PI/-2),n.name="__groundPlane",n.receiveShadow=!0,n.visible=!0,_context.scene.sysObjects.add(n)},this.getColorSpace=()=>{switch(_context.renderer.outputEncoding){case LinearEncoding:return"linear";case sRGBEncoding:return"srgb";case GammaEncoding:return"gamma"}},this.setColorSpace=e=>{if(e!==this.getColorSpace())switch(e.toLowerCase()){case"linear":_context.renderer.outputEncoding=LinearEncoding;break;case"srgb":_context.renderer.outputEncoding=sRGBEncoding;break;case"gamma":_context.renderer.outputEncoding=GammaEncoding}}}}const scene={};scene.Core=Core,scene.core={Model:Model,Node:Node,NodeSelection:NodeSelection,Map:Map$1,Material:Material,Texture:Texture};class Bar extends Drawable{constructor(e,t){super(e),this.alpha=e.alpha<0||e.alpha>1?1:e.alpha,this.altOffset=e.altOffset||0,this.barStyle=e.barStyle||"矩形",this.brightness=e.brightness||.5,this.color=e.color||"#ffffff",this.enableAutoHidebyDistance=e.enableAutoHidebyDistance||!1,this.heightRatio=e.heightRatio||1,this.isShow=0!=e.isShow&&1!=e.isShow||e.isShow,this.label=e.label||!1,this.labelBackground=e.labelBackground||"#00000055",this.labelCanvas=e.labelCanvas||"",this.labelColor=e.labelColor||"#ffffff",this.labelEnableItalic=e.labelEnableItalic||!1,this.labelFontBold=e.labelFontBold||!1,this.labelFontFamily=e.labelFontFamily||"微软雅黑, Microsoft Yahei, PingFang SC, Helvetica, Noto Sans CJK SC, Source Han Sans SC, SimHei, sans-serif",this.labelFontSize=e.labelFontSize||5,this.labelText=e.labelText||"默认值",this.labelXOffset=e.labelXOffset||.5,this.labelYOffset=e.labelYOffset||0,this.latOffset=e.latOffset||0,this.lonOffset=e.lonOffset||0,this.maxDistance=e.maxDistance||1e6,this.minDistance=e.minDistance||0,this.offset=e.offset||!1,this.position=e.position,this.sizeAttenuation=!(0==e.sizeAttenuation||!e.sizeAttenuation),this.value=e.value,null==this.value&&(this.value=e.values,null!=this.value&&logger.warn("检测到错误的柱图属性：'values' 。")),this.widthRatio=e.widthRatio||1,this.columnPaint=e.columnPaint||"solid",this.colorMax=e.colorMax||"#FF2626",this.colorMin=e.colorMin||"#FFFF00",this.context&&this.context.addBar(this.getFullName(),this.getBarParam(),this.getTextParam()),t&&t(1)}getBarParam(){var e;e="矩形"==this.barStyle?"bar":"cylinder";let t={lonOffset:this.lonOffset,latOffset:this.latOffset,altOffset:this.altOffset},r=JSON.parse(JSON.stringify(this.position));return r=this.convertLLAToXYZ(r,this.offset,t),{type:e,pos:r,offsetX:this.lonOffset,offsetY:this.latOffset,offsetZ:this.altOffset,color:this.color,brightness:this.brightness,maxDistance:Number(this.maxDistance),minDistance:Number(this.minDistance),enableAutoHidebyDistance:this.enableAutoHidebyDistance,alpha:this.alpha,width:this.widthRatio,value:this.value*this.heightRatio,isShow:this.isShow,renderOrder:this.zLevel,columnPaint:this.columnPaint,colorMax:this.colorMax,colorMin:this.colorMin}}getTextParam(){if(null!=this.labelCanvas&&this.labelCanvas)var e=this.labelCanvas;else e=this.generateLableCanvas(this.labelFontFamily,this.labelFontSize,this.labelFontBold,this.labelEnableItalic,this.labelBackground,this.labelColor,this.labelText);let t;return t=null!=e?{enableText:this.label,canvas:e,sizeAttenuation:this.sizeAttenuation,width:this.sizeAttenuation?.09*e.width:414e-6*e.width,height:this.sizeAttenuation?.09*e.height:414e-6*e.height,offsetV:this.labelXOffset,offsetH:this.labelYOffset}:{enableText:!1,canvas:e,sizeAttenuation:this.sizeAttenuation,width:this.sizeAttenuation?.09*e.width:414e-6*e.width,height:this.sizeAttenuation?.09*e.height:414e-6*e.height,offsetV:this.labelXOffset,offsetH:this.labelYOffset},t}removeBar(){this.context.removeLayer(this.getFullName())}toString(){return JSON.stringify(this)}updateBar(e){for(let t in e)null!=this[t]&&(this[t]=e[t],"values"==t&&(this.value=e.values,logger.warn("检测到错误的柱图属性：'values' 。")));this.context.removeLayer(this.getFullName()),this.context.addBar(this.getFullName(),this.getBarParam(),this.getTextParam())}}class Bubble extends Drawable{constructor(e,t){if(super(e),this.alpha=null!=e.alpha?e.alpha:1,this.altOffset=e.altOffset||0,this.animationSpeed=e.animationSpeed||1,this.brightness=e.brightness||1,this.bubbleColor=e.bubbleColor||"0xffffff",this.bubbleScale=e.bubbleScale>=0?e.bubbleScale:1,this.enableAutoHidebyDistance=e.enableAutoHidebyDistance||!1,this.isShow=0!=e.isShow&&1!=e.isShow||e.isShow,this.label=e.label||!1,this.labelBackground=e.labelBackground||"#00000055",this.labelCanvas=e.labelCanvas||"",this.labelColor=e.labelColor||"#ffffff",this.labelEnableItalic=e.labelEnableItalic||!1,this.labelFontBold=e.labelFontBold||!1,this.labelFontFamily=e.labelFontFamily||"微软雅黑, Microsoft Yahei, PingFang SC, Helvetica, Noto Sans CJK SC, Source Han Sans SC, SimHei, sans-serif",this.labelFontSize=e.labelFontSize||18,this.labelText=e.labelText||"默认值",this.labelXOffset=e.labelXOffset||0,this.labelYOffset=e.labelYOffset||0,this.latOffset=e.latOffset||0,this.lonOffset=e.lonOffset||0,this.maxDistance=e.maxDistance||1e8,this.minDistance=e.minDistance||0,this.offset=e.offset||!1,this.position=e.position||"",this.repeatMode=e.repeatMode||"repeat",this.sizeAttenuation=!(0==e.sizeAttenuation||!e.sizeAttenuation),this.value=e.value||1,this.context){let e={lonOffset:this.lonOffset,latOffset:this.latOffset,altOffset:this.altOffset};this.position=this.convertLLAToXYZ(this.position,this.offset,e),this.context.addBubble(this.getFullName(),this.getBubbleParam(),this.getTextParam(),(function(){t&&t(...arguments)}))}else t&&t(1)}getBubbleParam(){return{pos:this.position,offsetX:this.lonOffset,offsetY:this.latOffset,offsetZ:this.altOffset,value:Number(this.value)*Number(this.bubbleScale),diffSpeed:this.animationSpeed,repeatMode:this.repeatMode,color:this.bubbleColor,alpha:this.alpha,brightness:this.brightness,maxDistance:Number(this.maxDistance),minDistance:Number(this.minDistance),enableAutoHidebyDistance:this.enableAutoHidebyDistance,isShow:this.isShow,renderOrder:this.zLevel}}getTextParam(){if(null!=this.labelCanvas&&this.labelCanvas)var e=this.labelCanvas;else e=this.generateLableCanvas(this.labelFontFamily,this.labelFontSize,this.labelFontBold,this.labelEnableItalic,this.labelBackground,this.labelColor,this.labelText);let t;return t=null!=e?{enableText:this.label,canvas:e,sizeAttenuation:this.sizeAttenuation,width:this.sizeAttenuation?.01*e.width:45e-6*e.width,height:this.sizeAttenuation?.01*e.height:45e-6*e.height,offsetV:this.labelXOffset,offsetH:this.labelYOffset}:{enableText:!1,canvas:e,sizeAttenuation:this.sizeAttenuation,width:this.sizeAttenuation?.01*e.width:45e-6*e.width,height:this.sizeAttenuation?.01*e.height:45e-6*e.height,offsetV:this.labelXOffset,offsetH:this.labelYOffset},t}removeBubble(){this.context.removeLayer(this.getFullName())}toString(){return JSON.stringify(this)}updateBubble(e,t){let r={lonOffset:e.lonOffset,latOffset:e.latOffset,altOffset:e.altOffset};null!=e.position&&(e.position=this.convertLLAToXYZ(e.position,e.offset,r));for(let t in e)null!=this[t]&&(this[t]=e[t]);this.context.removeLayer(this.getFullName()),this.context.addBubble(this.getFullName(),this.getBubbleParam(),this.getTextParam(),(function(){t&&t(...arguments)}))}}class FlashMarker extends Drawable{constructor(e,t,r){if(super(e),this.autoStart=!!e.autoStart,this.duration=e.duration||1e4,this.height=e.height||"",this.icons=e.icons||["",""],this.interval=e.interval||500,this.position=e.position||"",this.sizeAttenuation=!1!==e.sizeAttenuation,this.width=e.width||"",this.context){let e={lonOffset:0,latOffset:0,altOffset:0};this.position=this.convertLLAToXYZ(this.position,this.offset,e),this.context.addFlashSpriteXYZ(`${t}/${this.name}`,this.icons,{x:this.position.x,y:this.position.y+this.height/2,z:this.position.z},this.width,this.height,this.sizeAttenuation,this.interval,this.duration,this.autoStart),r&&r(1)}r&&r(1)}toString(){return JSON.stringify(this)}}class HeatMap extends Drawable{constructor(e,t){super(e),e.points&&e.points instanceof Array?(this.enableAutoHidebyDistance=e.enableAutoHidebyDistance||!1,this.gradient=e.gradient||{1:"rgb(255,0,0)",.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"rgb(255, 255, 0)"},this.isShow=0!=e.isShow&&1!=e.isShow||e.isShow,this.maxDistance=e.maxDistance||1e6,this.minDistance=e.minDistance||0,this.offset=e.offset||[0,0,0],this.opacity=Number(e.opacity)<0?.6:Number(e.opacity),this.points=e.points||[],this.pointsType=e.pointsType||"xyz",this.radius=e.radius||10,this.style=e.style||"none",this.valueMax=e.valueMax,this.valueMin=e.valueMin,this.position=e.position||"",this.context&&(this.prepareCoreData(),this.context.addHeatMapLayer(this.getFullName(),this.getHeatMapParam()),this.context.updateHeatMapData(this.getFullName(),this.valueMin,this.valueMax,this._t,this._zoomFactor)),t&&t(1)):t&&t(0,"HeatMap() 参数错误。")}getHeatMapParam(){return{pos:this._positionXYZ,rotation:{x:0,y:0,z:0},width:this._width,height:this._height,gradient:this.gradient,opacity:this.opacity,style:this.style,maxDistance:Number(this.maxDistance),minDistance:Number(this.minDistance),enableAutoHidebyDistance:this.enableAutoHidebyDistance,isShow:this.isShow,renderOrder:this.zLevel}}hide(){this.hidden=!1,this.context}isHidden(){return this.isHidden}prepareCoreData(){let e=-200,t=200,r=-100,n=100,i=-6e6,a=6e7,o=0,s=0,l=0,c=Number.MAX_SAFE_INTEGER,h=0-Number.MAX_SAFE_INTEGER;"lla"==this.pointsType?(e=Math.max(...this.points.map((e=>e.lon))),t=Math.min(...this.points.map((e=>e.lon))),r=Math.max(...this.points.map((e=>e.lat))),n=Math.min(...this.points.map((e=>e.lat))),i=Math.max(...this.points.map((e=>e.alt))),a=Math.min(...this.points.map((e=>e.alt))),h=Math.max(...this.points.map((e=>e.value))),c=Math.min(...this.points.map((e=>e.value)))):(e=Math.max(...this.points.map((e=>e.x))),t=Math.min(...this.points.map((e=>e.x))),r=Math.max(...this.points.map((e=>e.z))),n=Math.min(...this.points.map((e=>e.z))),i=Math.max(...this.points.map((e=>e.y))),a=Math.min(...this.points.map((e=>e.y))),h=Math.max(...this.points.map((e=>e.value))),c=Math.min(...this.points.map((e=>e.value))));for(let e of this.points)if("lla"==this.pointsType){e.type="lla";let t=this.context.convertLLAToXYZ({x:e.lon,y:e.lat,z:e.alt});e.x=t.x,e.y=t.y,e.z=t.z,e.radius=this.radius}else e.radius=this.radius;o=(e+t)/2,s=(r+n)/2,l=(i+a)/2,this.offset&&3===this.offset.length&&(o+=this.offset[0],s+=this.offset[1],l+=this.offset[2]),this.ignoreAlt&&logger.warn("HeatMap.ignoreAlt = true (热力图贴地): to be implemented."),this._positionXYZ={},"lla"==this.pointsType?(this.position=new Position("lla").set(o,s,l),this._positionXYZ=this.context.convertLLAToXYZ({x:this.position.lon,y:this.position.lat,z:this.position.alt})):(this.position={lon:o,alt:s,lat:l},this._positionXYZ={x:this.position.lon,y:this.position.lat,z:this.position.alt}),this.valueMax=h,this.valueMin=c,this._t=[],this._xMax=0-Number.MAX_SAFE_INTEGER,this._yMax=0-Number.MAX_SAFE_INTEGER,this._xMin=Number.MAX_SAFE_INTEGER,this._yMin=Number.MAX_SAFE_INTEGER,this._radiusMax=0-Number.MAX_SAFE_INTEGER;for(let e of this.points)e.x>this._xMax&&(this._xMax=e.x),e.x<this._xMin&&(this._xMin=e.x),e.z>this._yMax&&(this._yMax=e.z),e.z<this._yMin&&(this._yMin=e.z),e.radius>this._radiusMax&&(this._radiusMax=e.radius);for(let e of this.points)this._t.push({x:(e.x-this._xMin+this._radiusMax*this.context.getWorldScale())/this.context.getWorldScale(),y:(e.z-this._yMin+this._radiusMax*this.context.getWorldScale())/this.context.getWorldScale(),value:e.value,radius:e.radius});this._width=(this._radiusMax*this.context.getWorldScale()*2+this._xMax-this._xMin)/this.context.getWorldScale(),this._height=(this._radiusMax*this.context.getWorldScale()*2+this._yMax-this._yMin)/this.context.getWorldScale(),this._zoomFactor=1;let u=this._width>this._height?this._width:this._height;if(u>4096){this._zoomFactor=u/4096,this._width=this._width/this._zoomFactor,this._height=this._height/this._zoomFactor;for(let e of this._t)e.x=Math.ceil(e.x/this._zoomFactor),e.y=Math.ceil(e.y/this._zoomFactor),e.radius=Math.ceil(e.radius/this._zoomFactor)}}removeHeatmap(){this.context&&this.context.removeLayer(this.getFullName())}show(){this.hidden=!0,this.context}toString(){return JSON.stringify(this)}updateHeatMapData(e){for(let t in e)null!=this[t]&&(this[t]=e[t]);this.context.removeLayer(this.getFullName()),this.prepareCoreData(),this.context.addHeatMapLayer(this.getFullName(),this.getHeatMapParam()),this.context.updateHeatMapData(this.getFullName(),this.valueMin,this.valueMax,this._t,this._zoomFactor)}}class InfoPanel extends Drawable{constructor(e,t,r,n,i,a){super(e),this.content=e.content||"",this.enableAutoPan=!!e.enableAutoPan,this.exclusive=!!e.exclusive,this.height=e.height||"",this.offset=e.offset||[0,0,0],this.position=e.position||"",this.width=e.width||"";var o=this;let s={lonOffset:this.offset[0],latOffset:this.offset[1],altOffset:this.offset[2]};3==this.offset.length?this.position=this.convertLLAToXYZ(this.position,!0,s):this.position=this.convertLLAToXYZ(this.position,!1,s);let l={};l.x=this.position.x,l.y=this.position.y,l.z=this.position.z,this.saveXyz(l);let c=this.context.convertWorldToScreen(l),h=document.createElement("div");if(this.content=this.content.replace('data-close="popup"',`data-close="popup-${this.name}"`),h.setAttribute("id",`${r}_${this.name}`),h.className=r,h.innerHTML=this.content.substring(0,4194304),h.style=`position: absolute;\n                            width: ${this.width}px; \n                            height: ${this.height}${"auto"===this.height?"":"px"}; \n                            left: ${c.x-this.width/2}px; \n                            top: ${c.y-("auto"===this.height?0:this.height)}px; `,this.exclusive)for(let e=t.container.childNodes.length-1;e>=0;e--)t.container.childNodes[e].className===r&&t.container.removeChild(t.container.childNodes[e]);if(t.container.appendChild(h),this.context.off(n.CAMERA_MOVE),this.context.on(n.CAMERA_MOVE,"",(function(e){let n=o.getLayer(i,r).getDrawables();if(n&&n.length>0)for(let e of n){let n=o.context.convertWorldToScreen(e.getXyz());for(let i=0;i<t.container.childNodes.length;i++)if(t.container.childNodes[i].getAttribute("id")===`${r}_${e.name}`){t.container.childNodes[i].style.left=n.x-t.container.childNodes[i].clientWidth/2+"px",t.container.childNodes[i].style.top=n.y-t.container.childNodes[i].clientHeight+"px";break}}})),this.closeButton=document.querySelector(`[data-close="popup-${this.name}"]`),this.closeButton&&(o.closeEventListener=o.closeButton.addEventListener("click",(function(){logger.debug("close handler triggered."),o.removeInfoPanel(o.name,"_sys_layer_info_panel_",t,"EVENTS",i)}))),o.enableAutoPan&&(c.x<o.width/2||c.y<h.clientHeight||c.x-o.width/2>t.container.offsetWidth||c.y-h.clientHeight>t.container.offsetHeight)){let e=o.getCamera();o.context.cameraFlyTo(l,e.posture[2],e.posture[1]>0?-15:e.posture[1],e.distance,3,!0)}a&&a(1)}getLayer(e,t){if(e instanceof Array)for(let r of e)if(r.name===t)return r}removeDrawable(e,t,r){if(!this.getLayer(t,r))return this;if(t instanceof Array)for(var n=0;n<t.length;n++)t[n].name===r&&t[n]._drawables.map(((r,i)=>{r.name==e&&t[n]._drawables.splice(i,1)}))}removeInfoPanel(e,t,r,n,i,a){for(let n=r.container.childNodes.length-1;n>=0;n--)r.container.childNodes[n].getAttribute("id")===`${t}_${e}`&&(r.container.removeChild(r.container.childNodes[n]),this.removeDrawable(e,i,t));a&&a(1,"成功")}}class InstancedBubble extends Drawable{constructor(e,t){if(super(e),this.isShow=0!=e.isShow&&1!=e.isShow||e.isShow,this.label=e.label||!1,this.labelBackground=e.labelBackground||"#00000055",this.labelCanvas=e.labelCanvas||"",this.labelColor=e.labelColor||"#ffffff",this.labelEnableItalic=e.labelEnableItalic||!1,this.labelFontBold=e.labelFontBold||!1,this.labelFontFamily=e.labelFontFamily||"微软雅黑, Microsoft Yahei, PingFang SC, Helvetica, Noto Sans CJK SC, Source Han Sans SC, SimHei, sans-serif",this.labelFontSize=e.labelFontSize||18,this.labelText=e.labelText||"默认值",this.labelXOffset=e.labelXOffset||0,this.labelYOffset=e.labelYOffset||0,this.sizeAttenuation=!(0==e.sizeAttenuation||!e.sizeAttenuation),this.fillArea=e.fillArea||"none",this.context){var r={points:[],repeatMode:"repeat",isShow:this.isShow,renderOrder:this.zLevel,fillArea:this.fillArea};for(let t of e.points)t.position=this.convertLLAToXYZ(t.position),r.points.push({name:t.name,position:t.position,offsetX:0,offsetY:0,offsetZ:0,value:t.value,diffSpeed:t.animationSpeed,repeatMode:"repeat",color:t.bubbleColor,alpha:1,brightness:1,enableAutoHidebyDistance:!1,textParam:{enableText:!1}});this.context.addInstancedBubble(this.getFullName(),r),this.points=r.points}t&&t(1)}removeBubble(){this.context.removeLayer(this.getFullName())}toString(){return JSON.stringify(this)}updateInstancedBubble(e={}){this.context.removeInstancedBubble(this.getFullName());var t={points:[],repeatMode:"repeat",isShow:e.isShow,renderOrder:this.zLevel,fillArea:e.fillArea||"none"};for(let r of e.points)r.position=this.convertLLAToXYZ(r.position),t.points.push({name:r.name,position:r.position,offsetX:0,offsetY:0,offsetZ:0,value:r.value,diffSpeed:r.animationSpeed,repeatMode:"repeat",color:r.bubbleColor,alpha:1,brightness:1,enableAutoHidebyDistance:!1,isShow:e.isShow,textParam:{enableText:!1}});this.context.addInstancedBubble(this.getFullName(),t),this.points=t.points}}class Landmark$1 extends Drawable{constructor(e,t){if(super(e),this.altOffset=e.altOffset||0,this.enableAutoHidebyDistance=e.enableAutoHidebyDistance||!1,this.height=e.height||"",this.icon=e.icon||"default",this.iconXOffset=e.iconXOffset||0,this.iconYOffset=e.iconYOffset||0,this.isShow=0!=e.isShow&&1!=e.isShow||e.isShow,this.label=e.label||!1,this.labelBackground=e.labelBackground||"#00000055",this.labelCanvas=e.labelCanvas||"",this.labelColor=e.labelColor||"#ffffff",this.labelEnableItalic=e.labelEnableItalic||!1,this.labelFontBold=e.labelFontBold||!1,this.labelFontFamily=e.labelFontFamily||"微软雅黑, Microsoft Yahei, PingFang SC, Helvetica, Noto Sans CJK SC, Source Han Sans SC, SimHei, sans-serif",this.labelFontSize=e.labelFontSize||18,this.labelText=e.labelText||"",this.labelXOffset=e.labelXOffset||0,this.labelYOffset=e.labelYOffset||0,this.latOffset=e.latOffset||0,this.lonOffset=e.lonOffset||0,this.labelAlignment=e.labelAlignment||"",this.maxDistance=e.maxDistance||1e8,e.hasOwnProperty("maxDistance")||e.hasOwnProperty("pointMaxDistance")&&(this.maxDistance=e.pointMaxDistance,logger.error("检测到错误的地标点属性：'pointMaxDistance' 。")),this.minDistance=e.minDistance||0,e.hasOwnProperty("minDistance")||e.hasOwnProperty("pointMinDistance")&&(this.maxDistance=e.pointMinDistance,logger.error("检测到错误的地标点属性：'pointMinDistance' 。")),this.offset=e.offset||!1,this.position=e.position,this.polygonOffset=e.polygonOffset||!1,this.polygonOffsetFactor=e.polygonOffsetFactor||0,this.polygonOffsetUnits=e.polygonOffsetUnits||0,this.sizeAttenuation=!(0==e.sizeAttenuation||!e.sizeAttenuation),this.width=e.width||"",this.background=e.background||"",this.backgroundColor=e.backgroundColor||"#ffffff",this.useIconAsset=e.useIconAsset,this.iconAssetName=e.iconAssetName,this.zLevel=e.zLevel||1,this.context){let e={lonOffset:this.lonOffset,latOffset:this.latOffset,altOffset:this.altOffset};this.position=this.convertLLAToXYZ(this.position,this.offset,e),this.useIconAsset?this.context.addBillboardAsset(this.getFullName(),{iconAssetName:this.iconAssetName,pos:{x:this.position.x,y:this.position.y,z:this.position.z},labelText:this.labelText,labelColor:this.labelColor,isShow:this.isShow,renderOrder:this.zLevel},t):this.context.addBillboard(this.getFullName(),this.getBillboardParam(),this.getTextParam(),t)}}generateLabelCanvas(){let e=document.createElement("canvas"),t=e.getContext("2d");return t.font=`${this.labelFontSize}px ${this.fontfamily}`,t.textAlign="center",t.textBaseline="middle",e.width=2*(t.measureText(this.labelText).width+this.labelFontSize),e.height=3.6*this.labelFontSize,t.fillStyle=this.labelBackground,t.fillRect(0,0,e.width,e.height),t.font=`${2*this.labelFontSize}px ${this.fontfamily}`,t.fillStyle=this.labelForeground,t.textAlign="center",t.textBaseline="middle",t.fillText(this.labelText,e.width/2,e.height/2),e}generateTooltipCanvas(){let e=document.createElement("canvas").getContext("2d");return e.width=w,e.height=h,e.fillStyle="#fff",e.fillRect(0,0,w,h),e.strokeStyle="#c00",e.shadowBlur=20,e.shadowColor="#c99",e.strokeWidth=30,e.beginPath(),e.moveTo(w/2,0),e.lineTo(0,h),e.lineTo(w,h),e.closePath(),e.stroke(),e}getBillboardParam(){let e=0,t=1e6;return isNaN(Number(this.minDistance))||(e=Number(this.minDistance)),isNaN(Number(this.maxDistance))||(t=Number(this.maxDistance)),{path:this.icon,sizeAttenuation:this.sizeAttenuation,pos:{x:this.position.x,y:this.position.y,z:this.position.z},width:this.width,height:this.height,enableAutoHidebyDistance:this.enableAutoHidebyDistance,pointMinDistance:Number(e),pointMaxDistance:Number(t),offsetV:this.iconXOffset,offsetH:this.iconYOffset,polygonOffset:this.polygonOffset,polygonOffsetFactor:this.polygonOffsetFactor,polygonOffsetUnits:this.polygonOffsetUnits,isShow:this.isShow,background:this.background,backgroundColor:this.backgroundColor,renderOrder:this.zLevel}}getTextParam(){if(null!=this.labelCanvas&&this.labelCanvas)var e=this.labelCanvas;else e=this.generateLableCanvas(this.labelFontFamily,this.labelFontSize,this.labelFontBold,this.labelEnableItalic,this.labelBackground,this.labelColor,this.labelText);let t;return t=null!=e?{enableText:this.label,canvas:e,sizeAttenuation:this.sizeAttenuation,width:this.sizeAttenuation?.01*e.width:45e-6*e.width,height:this.sizeAttenuation?.01*e.height:45e-6*e.height,offsetV:this.labelXOffset,offsetH:this.labelYOffset,labelAlignment:this.labelAlignment}:{enableText:!1,canvas:e,sizeAttenuation:this.sizeAttenuation,width:this.sizeAttenuation?.01*e.width:45e-6*e.width,height:this.sizeAttenuation?.01*e.height:45e-6*e.height,offsetV:this.labelXOffset,offsetH:this.labelYOffset,labelAlignment:this.labelAlignment},t}removeLandmark(){this.context.removeLayer(this.getFullName())}toString(){return JSON.stringify(this)}updateLandmark(e,t){if(null!=e.position){let t={lonOffset:e.lonOffset,latOffset:e.latOffset,altOffset:e.altOffset};e.position=this.convertLLAToXYZ(e.position,e.offset,t)}for(let t in e)this[t]=e[t],"pointMaxDistance"==t&&(e.hasOwnProperty("maxDistance")||(this.maxDistance=e.pointMaxDistance,logger.error("检测到错误的地标点属性：'pointMaxDistance' 。"))),"pointMinDistance"==t&&(e.hasOwnProperty("minDistance")||(this.maxDistance=e.pointMinDistance,logger.error("检测到错误的地标点属性：'pointMinDistance' 。")));this.useIconAsset?this.context.updateBillboardAsset(this.getFullName(),{iconAssetName:this.iconAssetName,pos:{x:this.position.x,y:this.position.y,z:this.position.z},labelText:this.labelText,labelColor:this.labelColor,isShow:this.isShow,renderOrder:this.zLevel},t):this.context.updateBillboard(this.getFullName(),this.getBillboardParam(),this.getTextParam(),t)}}class Marker extends Drawable{constructor(e,t,r){if(super(e),this.height=e.height||"",this.icon=e.icon||"",this.position=e.position||"",this.sizeAttenuation=!1!==e.sizeAttenuation,this.width=e.width||"",this.context){let e={lonOffset:0,latOffset:0,altOffset:0};this.position=this.convertLLAToXYZ(this.position,this.offset,e),this.context.addSpriteXYZ(`${t}/${this.name}`,this.icon,{x:this.position.x,y:this.position.y+this.height/2,z:this.position.z},this.width,this.height,this.sizeAttenuation),r&&r(1)}}toString(){return JSON.stringify(this)}}class Model$1{constructor(e,t){this.name=e.name||"",this.nodes=[],this.src=e.src||"",this.tags=e.tags||[],t&&t(1)}hide(){return this}load(e,t){return t&&t(1),this}show(){return this}toString(){return""}}class ODLine extends Drawable{constructor(e,t){super(e),this.alpha=e.alpha||1,this.altOffset=e.altOffset,this.animationSpeed=e.animationSpeed||1,this.color=e.color||"#FFFFFF",this.curvatureCoefficient=e.curvatureCoefficient,this.enableAutoHidebyDistance=e.enableAutoHidebyDistance||!1,this.endPos=e.endPos,this.imageType=e.imageType||"default",this.isShow=0!=e.isShow&&1!=e.isShow||e.isShow,this.label=e.label||!1,this.labelBackground=e.labelBackground||"#00000055",this.labelCanvas=e.labelCanvas||"",this.labelColor=e.labelColor||"#ffffff",this.labelEnableItalic=e.labelEnableItalic||!1,this.labelFontBold=e.labelFontBold||!1,this.labelFontFamily=e.labelFontFamily||"微软雅黑, Microsoft Yahei, PingFang SC, Helvetica, Noto Sans CJK SC, Source Han Sans SC, SimHei, sans-serif",this.labelFontSize=e.labelFontSize||5,this.labelText=e.labelText||"默认值",this.labelXOffset=e.labelXOffset||.5,this.labelYOffset=e.labelYOffset||.1,this.latOffset=e.latOffset,this.lineWidth=e.lineWidth||1,this.lonOffset=e.lonOffset,this.maxDistance=e.maxDistance||1e8,this.minDistance=e.minDistance||0,this.offset=e.offset,this.roundrobinModel=e.roundrobinModel||"circulation",this.sizeAttenuation=0!=e.sizeAttenuation&&1!=e.sizeAttenuation||e.sizeAttenuation,this.startPos=e.startPos,this.tensileCoefficient=e.tensileCoefficient||10,this.type=e.type,this.position=void 0,this.context?(this.getStartConvertLLAToXYZ(),this.getEndConvertLLAToXYZ(),this.context.addODLine(this.getFullName(),this.getODLineInfo(),this.getTextParam(),((e,r)=>{this.position=(new Position).set(r.x,r.y,r.z),t&&t(e)}))):t&&t(1)}getEndConvertLLAToXYZ(){if("lla"===this.endPos.type.toLowerCase())if(this.offset){let e=this.context.convertLLAToXYZ({x:this.endPos.lon+Number(this.lonOffset),y:this.endPos.lat+Number(this.latOffset),z:this.endPos.alt+Number(this.altOffset)});this.endPos.x=e.x,this.endPos.y=e.y,this.endPos.z=e.z}else{let e=this.context.convertLLAToXYZ({x:this.endPos.lon,y:this.endPos.lat,z:this.endPos.alt});this.endPos.x=e.x,this.endPos.y=e.y,this.endPos.z=e.z}}getODLineInfo(){return{maxDistance:Number(this.maxDistance),minDistance:Number(this.minDistance),enableAutoHidebyDistance:this.enableAutoHidebyDistance,startPos:this.startPos,endPos:this.endPos,curvatureCoefficient:this.curvatureCoefficient,animationSpeed:this.animationSpeed,useMap:!0,depthWrite:!1,depthTest:!1,alphaTest:0,sizeAttenuation:!1,dashRatio:0,repeat:{x:1,y:this.tensileCoefficient},lineWidth:this.lineWidth,color:this.color,dashArray:1,dashOffset:this.animationSpeed,transparent:!0,isShow:this.isShow,roundrobinModel:this.roundrobinModel,imageType:this.imageType,alpha:Number(this.alpha),renderOrder:this.zLevel}}getStartConvertLLAToXYZ(){if("lla"===this.startPos.type.toLowerCase())if(this.offset){let e=this.context.convertLLAToXYZ({x:this.startPos.lon+Number(this.lonOffset),y:this.startPos.lat+Number(this.latOffset),z:this.startPos.alt+Number(this.altOffset)});this.startPos.x=e.x,this.startPos.y=e.y,this.startPos.z=e.z}else{let e=this.context.convertLLAToXYZ({x:this.startPos.lon,y:this.startPos.lat,z:this.startPos.alt});this.startPos.x=e.x,this.startPos.y=e.y,this.startPos.z=e.z}}getTextParam(){if(null!=this.labelCanvas&&this.labelCanvas)var e=this.labelCanvas;else e=this.generateLableCanvas(this.labelFontFamily,this.labelFontSize,this.labelFontBold,this.labelEnableItalic,this.labelBackground,this.labelColor,this.labelText);let t;return t=null!=e?{enableText:this.label,canvas:e,sizeAttenuation:this.sizeAttenuation,width:this.sizeAttenuation?.09*e.width:405e-6*e.width,height:this.sizeAttenuation?.09*e.height:405e-6*e.height,offsetV:this.labelXOffset,offsetH:this.labelYOffset}:{enableText:!1,canvas:e,sizeAttenuation:this.sizeAttenuation,width:this.sizeAttenuation?.09*e.width:405e-6*e.width,height:this.sizeAttenuation?.09*e.height:405e-6*e.height,offsetV:this.labelXOffset,offsetH:this.labelYOffset},t}removeODLine(){this.context.removeLayer(this.getFullName())}toString(){return JSON.stringify(this)}updateODLine(e,t){for(let t in e)null!=this[t]&&(this[t]=e[t]);this.getStartConvertLLAToXYZ(),this.getEndConvertLLAToXYZ(),this.context.removeLayer(this.getFullName()),this.context.addODLine(this.getFullName(),this.getODLineInfo(),this.getTextParam(),((e,r)=>{this.position=(new Position).set(r.x,r.y,r.z),t&&t(e)}))}}class Trail extends Drawable{constructor(e,t){if(super(e),this.altOffset=e.altOffset,this.color=e.color,this.duration=e.duration,this.enableAutoHidebyDistance=e.enableAutoHidebyDistance||!1,this.height=e.height,this.icon=e.icon,this.iconXOffset=e.iconXOffset,this.iconYOffset=e.iconYOffset,this.isShow=0!=e.isShow&&1!=e.isShow||e.isShow,this.label=e.label||!1,this.labelBackground=e.labelBackground||"#00000055",this.labelCanvas=e.labelCanvas||"",this.labelColor=e.labelColor||"#ffffff",this.labelEnableItalic=e.labelEnableItalic||!1,this.labelFontBold=e.labelFontBold||!1,this.labelFontFamily=e.labelFontFamily||"微软雅黑, Microsoft Yahei, PingFang SC, Helvetica, Noto Sans CJK SC, Source Han Sans SC, SimHei, sans-serif",this.labelFontSize=e.labelFontSize||18,this.labelText=e.labelText||"默认值",this.labelXOffset=e.labelXOffset||0,this.labelYOffset=e.labelYOffset||0,this.latOffset=e.latOffset,this.lineShowHidden=e.lineShowHidden||!0,this.lineWidth=e.lineWidth,this.lonOffset=e.lonOffset,this.maxDistance=e.maxDistance||1e8,e.hasOwnProperty("maxDistance")||e.hasOwnProperty("pointMaxDistance")&&(this.maxDistance=e.pointMaxDistance,logger.error("检测到错误的地标点属性：'pointMaxDistance' 。")),this.minDistance=e.minDistance||0,this.travelingTime=void 0===e.travelingTime?1:e.travelingTime,e.hasOwnProperty("minDistance")||e.hasOwnProperty("pointMinDistance")&&(this.maxDistance=e.pointMinDistance,logger.error("检测到错误的地标点属性：'pointMinDistance' 。")),this.offset=e.offset,this.position=e.position,this.sizeAttenuation=!(0==e.sizeAttenuation||!e.sizeAttenuation),this.width=e.width,this.background=e.background||"",this.backgroundColor=e.backgroundColor||"#ffffff",this.labelAlignment=e.labelAlignment||"",this.useIconAsset=e.useIconAsset||!1,this.context){let e={lonOffset:this.lonOffset,latOffset:this.latOffset,altOffset:this.altOffset};this.position=this.convertLLAToXYZ(this.position,this.offset,e),this.context.addTrail(this.getFullName(),this.getTrailParam(),this.getTextParam(),t)}}getTextParam(){if(null!=this.labelCanvas&&this.labelCanvas)var e=this.labelCanvas;else e=this.generateLableCanvas(this.labelFontFamily,this.labelFontSize,this.labelFontBold,this.labelEnableItalic,this.labelBackground,this.labelColor,this.labelText);let t;return t=null!=e?{enableText:this.label,canvas:e,sizeAttenuation:this.sizeAttenuation,width:this.sizeAttenuation?.01*e.width:45e-6*e.width,height:this.sizeAttenuation?.01*e.height:45e-6*e.height,offsetV:this.labelXOffset,offsetH:this.labelYOffset,labelAlignment:this.labelAlignment}:{enableText:!1,canvas:e,sizeAttenuation:this.sizeAttenuation,width:this.sizeAttenuation?.01*e.width:45e-6*e.width,height:this.sizeAttenuation?.01*e.height:45e-6*e.height,offsetV:this.labelXOffset,offsetH:this.labelYOffset,labelAlignment:this.labelAlignment},t}getTrailParam(){let e=0,t=1e6;return isNaN(Number(this.minDistance))||(e=Number(this.minDistance)),isNaN(Number(this.maxDistance))||(t=Number(this.maxDistance)),{pos:this.position,color:this.color,duration:this.duration,lineWidth:this.lineWidth,lineShowHidden:this.lineShowHidden,pointMaxDistance:Number(t),pointMinDistance:Number(e),enableAutoHidebyDistance:this.enableAutoHidebyDistance,width:this.width,height:this.height,offsetV:this.iconXOffset,offsetH:this.iconYOffset,sizeAttenuation:this.sizeAttenuation,path:this.icon,useIconAsset:this.useIconAsset,isShow:this.isShow,background:this.background,backgroundColor:this.backgroundColor,travelingTime:this.travelingTime,renderOrder:this.zLevel}}removeTrail(){this.labelCanvas=null,this.context.removeLayer(this.getFullName())}toString(){return JSON.stringify(this)}updateTrail(e){if(null!=e.position){let t={lonOffset:e.lonOffset,latOffset:e.latOffset,altOffset:e.altOffset};e.position=this.convertLLAToXYZ(e.position,e.offset,t)}for(let t in e)null!=this[t]&&(this[t]=e[t],"pointMaxDistance"==t&&(e.hasOwnProperty("maxDistance")||(this.maxDistance=e.pointMaxDistance,logger.error("检测到错误的地标点属性：'pointMaxDistance' 。"))),"pointMinDistance"==t&&(e.hasOwnProperty("minDistance")||(this.maxDistance=e.pointMinDistance,logger.error("检测到错误的地标点属性：'pointMinDistance' 。"))));this.context.updateTrail(this.getFullName(),this.getTrailParam(),this.getTextParam())}}const _fontFamily="微软雅黑, Microsoft Yahei, PingFang SC, Helvetica, Noto Sans CJK SC, Source Han Sans SC, SimHei, sans-serif";class Area$1 extends Drawable{constructor(e,t){super(e),this.alpha=e.alpha>=0?e.alpha:1,this.altOffset=e.altOffset||0,this.color=e.color||"#ffffff",this.depth=e.depth||1,this.enableAutoHidebyDistance=e.enableAutoHidebyDistance||!1,this.followAreaColor="boolean"!=typeof e.followAreaColor||e.followAreaColor,this.isShow=0!=e.isShow&&1!=e.isShow||e.isShow,this.label=0!=e.label&&1!=e.label||e.label,this.labelBackground=e.labelBackground||"#00000055",this.labelCanvas=e.labelCanvas||"",this.labelColor=e.labelColor||"#ffffff",this.labelEnableItalic=e.labelEnableItalic||!1,this.labelFontBold=e.labelFontBold||!1,this.labelFontFamily=e.labelFontFamily||_fontFamily,this.labelFontSize=e.labelFontSize||18,this.labelText=e.labelText||"默认值",this.labelXOffset=e.labelXOffset||0,this.labelYOffset=e.labelYOffset||0,this.latOffset=e.latOffset||0,this.lineAlpha=e.lineAlpha||1,this.lineColor=e.lineColor||"#ffffff",this.lineFlag=!(0==e.lineFlag||!e.lineFlag),this.lineWidth=e.lineWidth||1,this.lonOffset=e.lonOffset||0,this.maxDistance=e.maxDistance||1e8,this.minDistance=e.minDistance||0,this.offset=0!=e.offset&&1!=e.offset||e.offset,this.points=e.points||[],this.fillArea=e.fillArea||"",this.areaType=e.areaType||"",this.fillType=e.fillType||"top",this.position=void 0,this.sizeAttenuation=!(0==e.sizeAttenuation||!e.sizeAttenuation),this.context?this.points&&this.points.length>=3?this.context.addArea(this.getFullName(),this.getAreaInfo(),this.getTextParam(),t):(logger.warn("点位不够，绘制区域图失败。"),t&&t(1)):t&&t(1)}updatePosition(e){let t=e.point[0],r=e.point[0],n=e.point[1],i=e.point[1];for(let a=0;a<e.point.length;a+=2)e.point[a]<t&&(t=e.point[a]),e.point[a]>r&&(r=e.point[a]),e.point[a+1]<n&&(n=e.point[a+1]),e.point[a+1]>i&&(i=e.point[a+1]);let a=(t+r)/2+e.lonOffset,o=this.depth/2+e.altOffset,s=-(n+i)/2+e.latOffset;this.position=(new Position).set(a,o,s)}getAreaInfo(){let e=0;for(var t=[],r=0;r<this.points.length;r++)if(this.points[r]&&"lla"===this.points[r].type.toLowerCase()){var n=this.context.convertLLAToXYZ({x:this.points[r].lon,y:this.points[r].lat,z:this.points[r].alt});t.push(n.x),t.push(-n.z),e=n.y}else t.push(this.points[r].x),t.push(-this.points[r].z),e=this.points[r].y;let i={point:t,depth:this.depth,areaType:this.areaType,color:this.color,alpha:this.alpha,fillArea:this.fillArea,fillType:this.fillType,followAreaColor:this.followAreaColor,lineAlpha:this.lineAlpha,lineColor:this.lineColor,lineWidth:this.lineWidth,maxDistance:Number(this.maxDistance),minDistance:Number(this.minDistance),enableAutoHidebyDistance:this.enableAutoHidebyDistance,offset:this.offset,lonOffset:Number(this.lonOffset),latOffset:Number(this.latOffset),altOffset:Number(this.altOffset+e),isShow:this.isShow,lineFlag:this.lineFlag,renderOrder:this.zLevel},a=this.getUvAnimation(this.areaType,this.fillArea);return Object.assign(i,a),this.updatePosition(i),i}getUvAnimation(e,t){let r={u:!1,v:!1,uSpeed:0,vSpeed:0,fillU:!1,fillV:!1,fillUSpeed:0,fillVSpeed:0,fillColor:this.color,fillAlpha:1};switch(e.toLowerCase()){case"arrow01":r.u=!0,r.v=!1,r.uSpeed=-.3,r.vSpeed=0;break;case"gradient02":r.u=!1,r.v=!0,r.uSpeed=0,r.vSpeed=.3;break;case"gradient03":case"grid01":r.u=!1,r.v=!1,r.uSpeed=0,r.vSpeed=0;break;case"grid03":r.u=!1,r.v=!0,r.uSpeed=0,r.vSpeed=.2;break;case"grid05":r.u=!1,r.v=!0,r.uSpeed=0,r.vSpeed=.3;break;case"segment01":r.u=!0,r.v=!1,r.uSpeed=-1,r.vSpeed=0;break;case"segment02":r.u=!1,r.v=!0,r.uSpeed=0,r.vSpeed=.1;break;case"segment03":r.u=!0,r.v=!1,r.uSpeed=-.3,r.vSpeed=0}switch(t.toLowerCase()){case"gradient01":case"gradient02":r.fillU=!0,r.fillV=!1,r.fillUSpeed=-.4,r.fillVSpeed=0;break;case"grid01":r.fillU=!0,r.fillV=!1,r.fillUSpeed=-.2,r.fillVSpeed=0;break;case"grid02":case"segment01":r.fillU=!0,r.fillV=!1,r.fillUSpeed=-.1,r.fillVSpeed=0;break;case"segment02":r.fillU=!0,r.fillV=!1,r.fillUSpeed=-.1,r.fillVSpeed=0,r.fillColor=this.lightenDarkenColor(this.color,200),r.fillAlpha=.8}return r}lightenDarkenColor(e,t){var r=!1;"#"==e[0]&&(e=e.slice(1),r=!0);var n=parseInt(e,16),i=(n>>16)+t;i>255?i=255:i<0&&(i=0);var a=(n>>8&255)+t;a>255?a=255:a<0&&(a=0);var o=(255&n)+t;return o>255?o=255:o<0&&(o=0),(r?"#":"")+(o|a<<8|i<<16).toString(16)}getTextParam(){if(null!=this.labelCanvas&&this.labelCanvas)var e=this.labelCanvas;else e=this.generateLableCanvas(this.labelFontFamily,this.labelFontSize,this.labelFontBold,this.labelEnableItalic,this.labelBackground,this.labelColor,this.labelText);let t;return t=null!=e?{enableText:this.label,canvas:e,sizeAttenuation:this.sizeAttenuation,width:this.sizeAttenuation?.01*e.width:45e-6*e.width,height:this.sizeAttenuation?.01*e.height:45e-6*e.height,offsetV:this.labelXOffset,offsetH:this.labelYOffset}:{enableText:!1,canvas:e,sizeAttenuation:this.sizeAttenuation,width:this.sizeAttenuation?.1*e.width:45e-6*e.width,height:this.sizeAttenuation?.1*e.height:45e-6*e.height,offsetV:this.labelXOffset,offsetH:this.labelYOffset},t}removeArea(){this.context.removeLayer(this.getFullName())}toString(){return JSON.stringify(this)}updateArea(e,t){for(let t in e)null!=this[t]&&(this[t]=e[t]);this.context.removeLayer(this.getFullName()),this.points&&this.points.length>=3?this.context.addArea(this.getFullName(),this.getAreaInfo(),this.getTextParam(),t):(logger.warn("点位不够，绘制区域图失败。"),t&&t(1))}}class Path$1$1 extends Drawable{constructor(e,t){super(e),this.points=e.points,this.color=e.color,this.colorPass=e.colorPass,this.pass=e.pass||0,this.passRange=e.passRange||0,this.pathType=e.pathType,this.width=e.width,this.pathType=e.pathType||"segment06",this.alpha=null!=e.alpha?e.alpha:1,this.isShow=null==e.isShow||e.isShow,this.position=void 0,this.context&&(this.getPointsConvertLLAToXYZ(),this.points.length>1?this.context.addPath(this.getFullName(),this.getPathInfo(),t):t&&t(1))}getPathInfo(){var e={points:this.points,color:this.color,colorPass:this.colorPass,pass:this.pass,passRange:this.passRange,pathType:this.pathType,width:this.width,alpha:this.alpha,isShow:this.isShow,renderOrder:this.zLevel};return this.updatePosition(),e}updatePosition(){let e=0;for(let t=0;t<this.points.length-1;t++){let r=this.points[t],n=this.points[t+1];e+=this.context.getDistanceByPositions(r,n)}e/=2;let t=0,r=0;for(let n=0;n<this.points.length-1;n++){let i=this.points[n],a=this.points[n+1];if(t+=this.context.getDistanceByPositions(i,a),t>e){r=n;break}}let n=t-e,i=this.points[r],a=this.points[r+1],o=n/this.context.getDistanceByPositions(i,a),s=this.context.positionLerp(i,a,1-o);this.position=(new Position).set(s.x,s.y,s.z)}getPointsConvertLLAToXYZ(){this.points.forEach((e=>{if("lla"===e.type.toLowerCase()){let t=this.context.convertLLAToXYZ({x:e.lon,y:e.lat,z:e.alt});e.x=t.x,e.y=t.y,e.z=t.z}}))}updatePath(e,t){for(let t in e)null!=this[t]&&(this[t]=e[t]);this.getPointsConvertLLAToXYZ(),this.context.removeLayer(this.getFullName()),this.points.length>1?this.context.addPath(this.getFullName(),this.getPathInfo(),t):t&&t(0)}updatePathPass({colorPass:e,pass:t}){void 0!==e&&(this.colorPass=e),void 0!==t&&(this.pass=t),this.context.updatePathPass(this.getFullName(),{colorPass:this.colorPass,pass:this.pass})}removePath(){this.context.removeLayer(this.getFullName())}toString(){return JSON.stringify(this)}}class SolidBillboard extends Drawable{constructor(e){super(e),this.depthTest=!0,this.enableAutoHidebyDistance=!0,this.iconBrightness=1,this.iconHeight=5,this.iconIsShow=!0,this.iconOffset={x:0,y:0,z:0},this.iconScale=1,this.iconUrl="./texture/pin.png",this.iconWidth=5,this.isShow=!0,this.maxDistance=1e6,this.minDistance=0,this.position=Position.Zero(),this.rotation={x:0,y:0,z:0},this.scale=1,this.textAlignment="居中",this.textBrightness=1,this.textColor="#ffffff",this.textContent="无文本",this.textFont="./texture/fonts/Noto Sans CJK Black.otf",this.textIsShow=!0,this.textOffset={x:0,y:0,z:0},this.textSize=20,this._params=e,this._checkMustParam(),this._updateProperty(),this._createBillboard()}_checkMustParam(){let e="立体标牌：未检测到以下必要属性：",t=!1;this._params.hasOwnProperty("name")||(e+=" name ",t=!0),this._params.hasOwnProperty("position")||(e+=" position ",t=!0),this._params.hasOwnProperty("iconUrl")||(e+=" iconUrl ",t=!0),t&&(e+="，将使用默认值替代。",logger.warn(e))}_updateProperty(){if(!this._params)return;if("object"!=typeof this._params)return;let e="检测到以下无效属性：",t=!1;for(let r in this._params)this.hasOwnProperty(r)||(t=!0,e+=` ${r} `);t&&(e+="。",logger.warn(e)),this._setProperty("position",3),this._setProperty("rotation",3),this._setProperty("scale",2),this._setProperty("enableAutoHidebyDistance",1),this._setProperty("maxDistance",2),this._setProperty("minDistance",2),this._setProperty("depthTest",1),this._setProperty("isShow",1),this._setProperty("iconUrl",4),this._setProperty("iconWidth",4),this._setProperty("iconHeight",4),this._setProperty("iconBrightness",2),this._setProperty("iconOffset",3),this._setProperty("iconScale",2),this._setProperty("iconIsShow",1),this._setProperty("textContent",4),this._setProperty("textFont",4),this._setProperty("textSize",2),this._setProperty("textBrightness",2),this._setProperty("textColor",4),this._setProperty("textAlignment",4),this._setProperty("textOffset",3),this._setProperty("textIsShow",1)}_setProperty(e,t){if(null==this[e])return;if(!this._params.hasOwnProperty(e))return;let r=this._params[e];if(null==r||null==r)return;let n=1==t?"boolean":2==t?"number":3==t?"object":4==t?"string":"any";if("any"!=n)if(n!=typeof r)if("string"!=n){if("number"==n){let t=Number(r);if(!isNaN(t))return void(this[e]=t)}(n="boolean")&&(this[e]=!!r)}else this[e]=r.toString();else this[e]=r;else this[e]=r}_createBillboard(){if(!this.context)return;let e=this.getBillboardParam(),t=this.getIconParam(),r=this.getTextParam();this.context.addBillboard3D(e,t,r)}updateSolidBillboard(e){if(this._params=e,!e)return;this._updateProperty();let t=this.getBillboardParam(),r=this.getIconParam(),n=this.getTextParam();this.context.updateBillboard3D(t,r,n)}removeSolidBillboard(){this.context.removeLayer(this.getFullName())}getBillboardParam(){return this.position=this.convertLLAToXYZ(this.position,!1),{name:this.getFullName(),position:this.position,rotation:this.rotation,scale:this.scale,enableAutoHidebyDistance:this.enableAutoHidebyDistance,maxVisibleDistance:this.maxDistance,minVisibleDistance:this.minDistance,depthTest:this.depthTest,isShow:this.isShow}}getIconParam(){return{path:this.iconUrl,width:this.iconWidth,height:this.iconHeight,brightness:this.iconBrightness,offset:this.iconOffset,scale:this.iconScale,isShow:this.iconIsShow}}getTextParam(){let e={content:this.textContent,font:this.textFont,size:this.textSize/10,brightness:this.textBrightness,color:this.textColor,offset:this.textOffset,isShow:this.textIsShow,alignment:"center"};return"居左"==this.textAlignment?e.alignment="right":"居友"==this.textAlignment&&(e.alignment="left"),e}}var _layers=[],_layerZLevel=1,_modelTips={},_overlayTips={},_models=Symbol("models"),_core=Symbol("core"),_camera$1=Symbol("camera"),_showStats=Symbol("showStats"),_isPerfTesting=!1,_sceneApiUrl="",_sceneConfigPath="",_sceneName="",_defaultModelConfigPath="",_defaultModelPath="",_eventHandler={lodchange:{default:[]},cameramove:{default:[]},camerazoom:{default:[]},click:{default:[],byType:{sprite:[],billboard:[],landmark:[],bubble:[],bar:[],odLine:[],trail:[],area:[],drawable:[],model:[],building:[],scene:[]},dblclick:{default:void 0,byType:{marker:void 0,building:void 0,scene:void 0}},mousedown:{default:void 0,byType:{marker:void 0,building:void 0,scene:void 0}},mousehover:{default:void 0,byType:{marker:void 0,building:void 0,scene:void 0}},mouseup:{default:void 0,byType:{marker:void 0,building:void 0,scene:void 0}}},mousehover:{default:[],byType:{sprite:[],billboard:[],landmark:[],bubble:[],bar:[],odLine:[],trail:[],area:[],drawable:[],model:[],building:[],scene:[]},dblclick:{default:void 0,byType:{marker:void 0,building:void 0,scene:void 0}},mousedown:{default:void 0,byType:{marker:void 0,building:void 0,scene:void 0}},mousehover:{default:void 0,byType:{marker:void 0,building:void 0,scene:void 0}},mouseup:{default:void 0,byType:{marker:void 0,building:void 0,scene:void 0}}},unmousehover:{default:[],byType:{sprite:[],billboard:[],landmark:[],bubble:[],bar:[],odLine:[],trail:[],area:[],drawable:[],model:[],building:[],scene:[]},dblclick:{default:void 0,byType:{marker:void 0,building:void 0,scene:void 0}},mousedown:{default:void 0,byType:{marker:void 0,building:void 0,scene:void 0}},mousehover:{default:void 0,byType:{marker:void 0,building:void 0,scene:void 0}},mouseup:{default:void 0,byType:{marker:void 0,building:void 0,scene:void 0}}},trailmove:{default:[]}},_watermarks={};const _SYS_MODEL_TIP="_sys_model_tip_",_SYS_OVERLAY_TIP="_sys_overlay_tip_",_DISTANCE_MAX=Number.MAX_SAFE_INTEGER,_DISTANCE_MIN=0,_SYS_LAYER_INFO_PANEL="_sys_layer_info_panel_",_SYS_LAYER_HEAT_MAP="_sys_layer_heat_map_",_SYS_LAYER_SOLID_BILLBOARD="_sys_layer_solid_billboard_",_SYS_POPUP="_sys_popup_",_EVENTS={LOD_CHANGE:"lodchange",MOUSE_DOWN:"mousedown",MOUSE_UP:"mouseup",MOUSE_HOVER:"mousehover",UNMOUSE_HOVER:"unmousehover",CLICK:"click",DOUBLE_CLICK:"dblclick",CAMERA_MOVE:"cameramove",CAMERA_ZOOM:"camerazoom",TRAIL_MOVE:"trailmove"},_SCENE_CONFIG_FILE_NAME="SceneConfig.json",_ACCESS_TOKEN_LENGTH_MIN=20;class Scene$1{constructor(e,t){this.additionalInfo=e.additionalInfo||{},this.author=e.author||"",this.name=e.name||"",this.options={},this.type=e.type||"",this.url=e.url||"",logger.debug("附加信息"),logger.debug(this.additionalInfo),_layers=[],_models=[],_core={},_showStats=!1;var r=this;window.addEventListener("resize",(function(){r.options&&r.options.container&&_core.changeSize(r.options.container.offsetWidth,r.options.container.offsetHeight)}),!1),t&&t(1)}get domElement(){return _core.domElement()}addExplosion({url:e,position:t,scale:r,duration:n,depthTest:i,loop:a,autoPlay:o,destroyOnFinish:s,dimension:l,center:c,fadeOutFrame:h,rotation:u,callback:d}){"lla"===t.type&&(t=_core.convertLLAToXYZ({x:t.lon,y:t.lat,z:t.alt})),_core.addAnimatedSprite({name:"explosion_"+util.randomString(8),url:this.additionalInfo.resourceBasePath+e,position:{x:t.x,y:t.y,z:t.z},scale:{x:r,y:r,z:r},duration:n,depthTest:i,loop:a,autoPlay:o,destroyOnFinish:s,dimension:l,center:c,fadeOutFrame:h,rotation:u},d)}transformDrawable(e,t){const r=this.getLayer(e);if(!r)return;const n=r.getDrawable(t);if(!n)return;const i=n.getFullName();_core.transformObject(i)}untransformDrawable(){_core&&_core.untransformObject()}addEventListener(){_core.addEventListener(...arguments)}removeEventListener(){_core.removeEventListener(...arguments)}setCompass(e,t){return new Promise((r=>{let n={};n.hor=e.dockHorizontal,n.ver=e.dockVertical,n.offset=e.offset,n.size=e.size,n.isShow=e.visible,_core.setCompass(n),t&&t(1,"完成。"),r(1,"完成。")}))}addWatermark(e,t,r){return new Promise((n=>{if(_watermarks[e])return r&&r(0,`已存在 ${e} 水印。`),void n({result:0,message:`已存在 ${e} 水印。`});const i=JSON.parse(JSON.stringify(_watermarks));i[e]=t;let a=[];for(const e in i){const t=i[e];a.push({src:t.url,hor:t.dockHorizontal,ver:t.dockVertical,offset:t.offset,scale:t.scale,alpha:t.alpha})}_core.setWatermark(a,((i,a)=>{1===i&&(_watermarks[e]=t),r&&r(i,a),n({result:i,message:a})}))}))}removeWatermark(e,t){return new Promise((r=>{if(!_watermarks[e])return t&&t(0,`不存在 ${e} 水印。`),void r({result:0,message:`不存在 ${e} 水印。`});delete _watermarks[e];let n=[];for(const e in _watermarks){if(void 0===e)continue;const t=_watermarks[e];n.push({src:t.url,hor:t.dockHorizontal||"left",ver:t.dockVertical||"top",offset:t.offset||[0,0],scale:t.scale||1,alpha:t.alpha||1})}_core.setWatermark(n,((e,n)=>{t&&t(e,n),r({result:e,message:n})}))}))}takeSnapshot(e,t,r=.92){return void 0===e&&(e=this.options.container.offsetWidth),void 0===t&&(t=this.options.container.offsetHeight),_core.takeSnapshot({targetWidth:e,targetHeight:t,targetEncoder:r})}endSelectOverlay(){_core.endSelectDrawable(...arguments)}selectOverlay(e,t){_core.selectDrawable(e,(e=>{if(!t)return;let r=[];for(const t of e){let e=t.name.split("/"),n=this.getLayer(e[0]);if(!n)continue;let i=n.getDrawable(e[1]);!r.find((e=>e==i))&&r.push(i)}t(r)}))}getModelBox(e){return _core.getModelBox(e)}restrictCamera(e,t){if(e){if((e=JSON.parse(JSON.stringify(e))).limitHeight=e.limitCoordZ,"lla"==e.center.type){let t=_core.convertLLAToXYZ({x:e.center.lon,y:e.center.lat,z:e.center.alt});e.center.x=t.x,e.center.y=t.y,e.center.z=t.z}e.center=[e.center.x,e.center.z]}else e={};_core.restrictCamera(e,t)}setResolution({width:e,height:t,fpsMax:r}){_core.setResolution(e,t),"number"==typeof r&&_core.setFPSLimit(r)}getSceneName(){return _core.getSceneName()}isContentAssets(){return _core.isContentAssets(...arguments)}interruptCameraFly(){_core.interruptCameraFly()}getCameraDetailed(){return _core.getCamera()}drawableIsSelected(e,t){let r=this.getLayer(e);if(!r)return!1;let n=r.getDrawable(t);return!!n&&_core.drawableIsSelected(n.type,n.getFullName())}setCameraToModel(){_core.setCameraToModel(...arguments)}getAngleByPositions(e,t){if("lla"===e.type.toLowerCase()){let t=this.convertLLAToXYZ(e);e.x=t.x,e.y=t.y,e.z=t.z}if("lla"===t.type.toLowerCase()){let e=this.convertLLAToXYZ(t);t.x=e.x,t.y=e.y,t.z=e.z}return _core.getAngleByPositions(e,t)}getDistanceByPositions(e,t){if("lla"===e.type.toLowerCase()){let t=this.convertLLAToXYZ(e);e.x=t.x,e.y=t.y,e.z=t.z}if("lla"===t.type.toLowerCase()){let e=this.convertLLAToXYZ(t);t.x=e.x,t.y=e.y,t.z=e.z}return _core.getDistanceByPositions(e,t)/_core.getWorldScale()}setWeather({name:e,size:t,density:r,type:n,direction:i=0,offset:a={x:0,y:0,z:0},followCamera:o},s){let l={name:e,size:t,density:r,direction:i,offset:a,followCamera:o};if("snow"==n)_core.removeSnow(e),_core.addSnow(l);else{if("rain"!=n)return void(s&&s({result:0,message:`失败，天气 ${e} 暂未实现。`}));_core.removeRain(e),_core.addRain(l)}s&&s({result:1,message:"成功。"})}add3DMarker(e,t){if((e=JSON.parse(JSON.stringify(e))).position&&"lla"===e.position.type.toLowerCase()){let t=this.convertLLAToXYZ(e.position);e.position.x=t.x,e.position.y=t.y,e.position.z=t.z}e.position=[e.position.x,e.position.y,e.position.z],e.titleText&&(e.canvas=this._generateLableCanvas("微软雅黑",5,!1,!1,e.titleBackgroundColor,e.titleColor,e.titleText)),e.name=`_sys_3dmarker_layer_/${e.name}/3dmarker`,_core.add3DMarker(e,t)}update3DMarker(e,t){if((e=JSON.parse(JSON.stringify(e))).position&&"lla"===e.position.type.toLowerCase()){let t=this.convertLLAToXYZ(e.position);e.position.x=t.x,e.position.y=t.y,e.position.z=t.z}e.position=[e.position.x,e.position.y,e.position.z],e.titleText&&(e.canvas=this._generateLableCanvas("微软雅黑",5,!1,!1,e.titleBackgroundColor,e.titleColor,e.titleText)),e.name=`_sys_3dmarker_layer_/${e.name}/3dmarker`,_core.update3DMarker(e.name,e,t)}remove3DMarker(e){e=`_sys_3dmarker_layer_/${e}/3dmarker`,_core.removeLayer(e)}show3DMarker(e){e=`_sys_3dmarker_layer_/${e}/3dmarker`,_core.showLayer(e)}hide3DMarker(e){e=`_sys_3dmarker_layer_/${e}/3dmarker`,_core.hideLayer(e)}showFPSPanel(e){e?_core.fpsPanelOn():_core.fpsPanelOff()}getStatistics(){return _core.getStatistics()}addModelTip(e,t){let r=_core.defaultObjectTree.getItemByName(e.id);if(!r)return void t({result:0,message:`失败，模型 ${e.id} 不存在。`});let n=r.getGroup().position,i=_core.convertWorldToScreen(n),a=`${_SYS_MODEL_TIP}_${e.id}`;if(document.getElementById(a))return void t({result:0,message:`失败，模型 ${e.id} 的提示框已存在。`});let o=document.createElement("div");o.style=`\n      pointer-events: none;\n      position: absolute;\n      width: ${e.size[0]}px; \n      height: ${e.size[1]}px; \n      left: ${i.x+e.offset[0]}px; \n      top: ${i.y-e.size[1]-e.offset[1]}px; \n    `;let s=null;e.isShowClose&&(s=document.createElement("div"),o.appendChild(s),s.style=`\n        height: 18px;\n        width: 18px;\n        position: absolute;\n        top: 2px;\n        right: 2px;\n        cursor: pointer;\n        pointer-events: auto;\n        background-image: url('${this.additionalInfo.resourceBasePath}/texture/ui/close.png');\n      `,s.onmouseenter=()=>{s.style.backgroundImage=`url('${this.additionalInfo.resourceBasePath}/texture/ui/close-hover.png')`},s.onmouseleave=()=>{s.style.backgroundImage=`url('${this.additionalInfo.resourceBasePath}/texture/ui/close.png')`});let l=e.layer+"_"+e.id;if(e.divId){let t=document.getElementById(e.divId);o.appendChild(t);let r=o.querySelector("[data-close]");r&&r.addEventListener("click",(e=>{this.options.container.removeChild(o),delete _overlayTips[l]}))}else{let t=document.createElement("iframe");t.setAttribute("src",e.url),t.setAttribute("scrolling","no"),t.setAttribute("id",a),t.style=`\n      width: ${e.size[0]}px;\n      height: ${e.size[1]}px;\n      border: none;\n      pointer-events: none;\n    `,o.appendChild(t),t.onload=()=>{let r=t.contentDocument.querySelector("[data-close]");r&&r.addEventListener("click",(t=>{this.options.container.removeChild(o),delete _modelTips[e.id]}))}}e.isShowClose&&s.addEventListener("click",(()=>{this.options.container.removeChild(o),delete _modelTips[e.id]})),this.options.container.appendChild(o),_modelTips[e.id]=e,_modelTips[e.id].dom=o,_modelTips[e.id].model=r,this.tipFollowingMaster(),t({result:1,message:"成功。"})}removeModelTip(e,t){_modelTips[e.id]?(this.options.container.removeChild(_modelTips[e.id].dom),delete _modelTips[e.id],t&&t({result:1,message:"成功。"})):t&&t({result:0,message:`失败，没有找到 ${e.id} 的标牌。`})}addModelForApi(e,t){if(e.position&&"lla"===e.position.type.toLowerCase()){let t=this.convertLLAToXYZ(e.position);e.position.x=t.x,e.position.y=t.y,e.position.z=t.z}e.titleText&&(e.titleColor=e.titleColor||"#ffffff",e.titleBackgroundColor=e.titleBackgroundColor||"#333333",e.canvas=this._generateLableCanvas("微软雅黑",5,!1,!1,e.titleBackgroundColor,e.titleColor,e.titleText)),_core.addModelForApi(e,t)}removeModelForApi(e,t){_core.removeModelForApi(e,t)}addOverlayTip(e,t){let r=this.getLayer(e.layer);if(!r)return void(t&&t(0,`绘制物 ${e.id} 不存在。`));let n=r.getDrawablePosition(e.id);if(!n)return void(t&&t(0,`绘制物 ${e.id} 不存在。`));if(!n.position)return void(t&&t(0,`绘制物 ${e.id} 没有中心点。`));let i=`${_SYS_OVERLAY_TIP}_${e.layer}_${e.id}`;if(document.getElementById(i))return void(t&&t(0,`绘制物 ${e.id} 的提示框已存在。`));if("lla"==n.position.type){let e=_core.convertLLAToXYZ({x:n.position.lon,y:n.position.lat,z:n.position.alt});n.position.x=e.x,n.position.y=e.y,n.position.z=e.z}let a=_core.convertWorldToScreen(n.position),o=document.createElement("div");o.style=`\n      pointer-events: none;\n      position: absolute;\n      width: ${e.size[0]}px; \n      height: ${e.size[1]}px; \n      left: ${a.x+e.offset[0]}px; \n      top: ${a.y-e.size[1]-e.offset[1]}px; \n    `;let s=null;e.isShowClose&&(s=document.createElement("div"),o.appendChild(s),s.style=`\n        height: 18px;\n        width: 18px;\n        position: absolute;\n        top: 2px;\n        right: 2px;\n        cursor: pointer;\n        pointer-events: auto;\n        background-image: url('${this.additionalInfo.resourceBasePath}/texture/ui/close.png');\n      `,s.onmouseenter=()=>{s.style.backgroundImage=`url('${this.additionalInfo.resourceBasePath}/texture/ui/close-hover.png')`},s.onmouseleave=()=>{s.style.backgroundImage=`url('${this.additionalInfo.resourceBasePath}/texture/ui/close.png')`});let l=e.layer+"_"+e.id;if(e.divId){let t=document.getElementById(e.divId);o.appendChild(t);let r=o.querySelector("[data-close]");r&&r.addEventListener("click",(e=>{this.options.container.removeChild(o),delete _overlayTips[l]}))}else{let t=document.createElement("iframe");t.setAttribute("src",e.url),t.setAttribute("scrolling","no"),t.setAttribute("id",i),t.style=`\n      width: ${e.size[0]}px;\n      height: ${e.size[1]}px;\n      border: none;\n      pointer-events: none;\n    `,o.appendChild(t),t.onload=()=>{let e=t.contentDocument.querySelector("[data-close]");e&&e.addEventListener("click",(e=>{this.options.container.removeChild(o),delete _overlayTips[l]}))}}e.isShowClose&&s.addEventListener("click",(()=>{this.options.container.removeChild(o),delete _overlayTips[l]})),this.options.container.appendChild(o),_overlayTips[l]=e,_overlayTips[l].dom=o,_overlayTips[l].drawable=n,this.tipFollowingMaster(),t&&t(1,"已添加标牌。")}tipFollowingMaster(){for(let e in _overlayTips){let t=_overlayTips[e];if("lla"==t.drawable.position.type){let e=_core.convertLLAToXYZ({x:t.drawable.position.lon,y:t.drawable.position.lat,z:t.drawable.position.alt});t.drawable.position.x=e.x,t.drawable.position.y=e.y,t.drawable.position.z=e.z}let r=_core.convertWorldToScreen(t.drawable.position);t.dom.style.left=`${r.x+t.offset[0]}px`,t.dom.style.top=r.y-t.size[1]-t.offset[1]+"px"}for(let e in _modelTips){let t=_modelTips[e],r=t.model.getGroup().position,n=_core.convertWorldToScreen(r);t.dom.style.left=`${n.x+t.offset[0]}px`,t.dom.style.top=n.y-t.size[1]-t.offset[1]+"px"}}removeOverlayTip(e,t){let r=e.layer+"_"+e.id;_overlayTips[r]?(this.options.container.removeChild(_overlayTips[r].dom),delete _overlayTips[r],t&&t({result:1,message:"成功。"})):t&&t({result:0,message:`失败，没有找到 ${e.id} 的标牌。`})}addPath(e,t,r){if(null!=t||null!=t.points)return t.type="path",this.addDrawable(e,t,r);r&&r(0,"绘制路径失败")}addArea(e,t,r){return new Promise((n=>{if(null==t&&null==t.points&&t.points.length<3)return r&&r(0,"绘制区域图失败"),void n();t.type="area",this.addDrawable(e,t,(function(){r&&r(1),n()}))}))}addBar(e,t,r){if(t)return t.type="bar",this.addDrawable(e,t,r);r&&r(0,"Scene.addBar(layerName, barInfo, callback) 传入参数有误。")}addBubble(e,t,r){return new Promise((n=>{if(!t)return r&&r(0,"Scene.addBubble(layerName, bubbleInfo, callback) 传入参数有误。"),void n();t.type="bubble",this.addDrawable(e,t,(function(){r&&r(...arguments),n()}))}))}addInstancedBubble(e,t,r){if(t)return t.name=e,t.type="instancedbubble",this.addDrawable(e,t,r);r&&r(0,"Scene.addInstancedBubble(layerName, bubbleInfo, callback) 传入参数有误。")}addDrawable(e,t,r){e&&"string"==typeof e&&""!==e||(e=util.randomString(4));let n,i=this.getLayer(e);if(i||(this.addLayer({name:e,type:"instancedbubble"==t.type?"instanced":""}),i=this.getLayer(e)),i.getDrawable(t.name))r?r(0,"Scene.addDrawable(layerName, drawableInfo, callback) 已存在指定图层和名称的绘制物。"):logger.warn("Scene.addDrawable(layerName, drawableInfo, callback) 已存在指定图层和名称的绘制物。");else{switch(t.instance=this.toString(),t.context=_core,t.parent=e,t.zLevel=i.zLevel,t.type.toLowerCase()){case"area":n=new Area$1(t,r);break;case"bar":n=new Bar(t);break;case"bubble":n=new Bubble(t,r);break;case"instancedbubble":n=new InstancedBubble(t);break;case"flashmarker":n=new FlashMarker(t,e);break;case"heatmap":n=new HeatMap(t);break;case"infopanel":n=new InfoPanel(t,this.options,_SYS_LAYER_INFO_PANEL,_EVENTS,_layers);break;case"landmark":n=new Landmark$1(t,r);break;case"marker":n=new Marker(t,e);break;case"odline":n=new ODLine(t,r);break;case"path":n=new Path$1$1(t,r);break;case"solidbillboard":n=new SolidBillboard(t);break;case"trail":n=new Trail(t,r)}if(n)return this.getLayer(e).addDrawable(n,(function(){})),this;r&&r(0,"Scene.addDrawable(layerName, drawableInfo, callback) 传入参数有误。")}}addFirefly(e){if(e.position&&"lla"===e.position.type.toLowerCase()){let t=_core.convertLLAToXYZ({x:e.position.lon,y:e.position.lat,z:e.position.alt});e.position.x=t.x,e.position.y=t.y,e.position.z=t.z}_core.addFireFly(e)}addFireworks(e){if(e.position&&"lla"===e.position.type.toLowerCase()){let t=_core.convertLLAToXYZ({x:e.position.lon,y:e.position.lat,z:e.position.alt});e.position.x=t.x,e.position.y=t.y,e.position.z=t.z}_core.addFireworks(e)}addHeatMap(e,t,r){if(e&&""!==e||(e=_SYS_LAYER_HEAT_MAP),t){if(t.type="heatmap",t.points&&t.points instanceof Array)return this.addDrawable(e,t,r);r?r(0,"Scene.addHeatMap(heatMapInfo, callback) 传入参数有误。"):logger.warn("Scene.addHeatMap(heatMapInfo, callback) 传入参数有误。")}else r?r(0,"Scene.addHeatMap(heatMapInfo, callback) 传入参数有误。"):logger.warn("Scene.addHeatMap(heatMapInfo, callback) 传入参数有误。")}addInfoPanel(e,t){if(e)return e.exclusive&&this.getLayer(_SYS_LAYER_INFO_PANEL)&&this.getLayer(_SYS_LAYER_INFO_PANEL).clearDrawables(),e.type="infopanel",this.addDrawable(_SYS_LAYER_INFO_PANEL,e,t);t&&t(0,"Scene.addInfoPanel(infoPanelInfo, callback) 传入参数有误。")}async addLandmark(e,t,r){if(t)return t.type="landmark",new Promise(((n,i)=>{this.addDrawable(e,t,(e=>{e?n(e):i(),r&&r(this)}))}));r&&r(0,"Scene.addLandmark(layerName, landmarkInfo, callback) 传入参数有误。")}addLayer(e,t){return e.name&&""!==e.name||(e.name=util.randomString(8)),this.getLayer(e.name)?(t(0,`已存在同名图层（${e.name}) 。`),this):(e.zLevel=_layerZLevel++,_layers.push(new Layer$1(e,t)),this)}addODLine(e,t,r){return new Promise((n=>{if(!t)return r&&r(0,"Scene.addODLine(layerName, odLineInfo, callback) 传入参数有误。"),void n();t.type="odline",this.addDrawable(e,t,(function(){r&&r(...arguments),n()}))}))}addPopup(e,t){if(e)return e.name=_SYS_POPUP,e.exclusive=!0,e.exclusive&&this.getLayer(_SYS_LAYER_INFO_PANEL)&&this.getLayer(_SYS_LAYER_INFO_PANEL).clearDrawables(),this.addDrawable(_SYS_LAYER_INFO_PANEL,e,t);t&&t(0,"Scene.addPopup(popupInfo, callback) 传入参数有误。")}addRain(e){_core.addRain(e)}addRainline(e){if(e.position&&"lla"===e.position.type.toLowerCase()){let t=_core.convertLLAToXYZ({x:e.position.lon,y:e.position.lat,z:e.position.alt});e.position.x=t.x,e.position.y=t.y,e.position.z=t.z}_core.addRainline(e)}addSnow(e){_core.addSnow(e)}addSolidBillboard(e,t){if(e)return e.type="solidbillboard",this.addDrawable(_SYS_LAYER_SOLID_BILLBOARD,e,t);t&&t(0,"addSolidBillboard(info, callback) 传入参数有误。")}async addTrail(e,t,r){if(t)return t.type="trail",new Promise(((r,n)=>this.addDrawable(e,t,(e=>{e?r(e):n()}))));r&&r(0,"Scene.addTrail(layerName, trailInfo, callback) 传入参数有误。")}buildingReset(e){if(e&&""!==e.toString()||(e=""),!this.options.buildingIndex||!this.options.buildingIndex.length||this.options.buildingIndex.length<=0)return logger.warn("未加载有效的建筑物信息，无法切换到室内视图，请联系场景提供者。"),this;if(""===e)for(let e of this.options.buildingIndex)this.buildingReset(e.id);else{let t;for(let r of this.options.buildingIndex)if(r.id===e.toString()){t=r;break}if(!t)return logger.warn(`未找到指定的楼宇：${e}。`),this;if(!t.floors||!t.floors.length||t.floors.length<=0)return logger.warn(`楼宇 ${e} 未加载有效的楼层信息，无法切换到室内视图，请联系场景提供者。`),this;for(let e of t.floors)this.resetNode("main",e.nodeName)}return this}buildingSlideOut(e){let t,r="main";if(!e)return logger.warn(`Scene.buildingSlideOut() params - ${e||void 0}`),this;if(!e.buildingId||""===e.buildingId.toString())return logger.warn(`Scene.buildingSlideOut() 传入参数无效：params.buildingId - ${e.buildingId||void 0}`),this;if(!e.floorIds||!e.floorIds.length||e.floorIds.length<=0||e.floorIds.length>999)return logger.warn(`Scene.buildingSlideOut() 传入参数无效：params.floorIds - ${e.floorIds||void 0}`),this;if(!this.options.buildingIndex||!this.options.buildingIndex.length||this.options.buildingIndex.length<=0)return logger.warn("Scene.buildingSlideOut() 未加载有效的楼宇信息，无法高亮显示楼层，请联系场景提供者。"),this;for(let r of this.options.buildingIndex)if(r.id===e.buildingId.toString()){t=r;break}if(!t)return logger.warn(`Scene.buildingSlideOut() 未找到指定的楼宇：${e.buildingId}。`),this;if(!t.floors||!t.floors.length||t.floors.length<=0)return logger.warn("Scene.buildingSlideOut() 未加载有效的楼层信息，无法高亮显示楼层，请联系场景提供者。"),this;this.buildingReset(t.id);let n=e.floorIds;for(let i of t.floors)for(let t=n.length-1;t>=0;t--)i.id===n[t]&&(this.translateNode(r,{nodeName:i.nodeName,color:e.color||"#0096FF",opacity:e.opacity||.65},!0),this.translateNode(r,{nodeName:i.nodeName,offset:e.offset}),n.splice(t,1));return n&&n.length>0?(logger.warn(`Scene.buildingSlideOut() 未找到指定的楼层：${n}。`),this):this}camera(e,t,r){return this.setCamera(e,t,r),this}cameraFlyTo(e,t,r){if(!e||!e.target||!e.posture||3!==e.posture.length||Number(e.distance)<_DISTANCE_MIN||Number(e.distance)>_DISTANCE_MAX)return void logger.warn("摄像机设置参数有误。");let n;n="lla"===e.target.type?_core.convertLLAToXYZ({x:e.target.lon,y:e.target.lat,z:e.target.alt}):e.target,_camera$1=e;let i=0,a=0;return i=Number(e.posture[2]),a=Number(e.posture[1]),90===a&&(a=89.99999),-90===a&&(a=-89.99999),0===e.distance&&(e.distance=1e-5),_core.cameraFlyTo(n,Number(i),Number(a),Number(e.distance),t,!0,r||void 0),this}clearBackgroundImage(){_core.clearBackground()}clearFog(){_core.clearFog()}clearHeatMap(e,t){if(e&&""!==e||(e=_SYS_LAYER_HEAT_MAP),!this.getLayer(e)||!this.getLayer(e).getDrawables()||this.getLayer(e).getDrawables().length<=0)t&&t(1,"无热力图需要清除。");else for(let t=this.getLayer(e).getDrawables().length-1;t>=0;t--){let r=this.getLayer(e).getDrawables()[t];this.getLayer(e).removeDrawable(r.name,(function(e,t){1===e&&r.removeHeatmap()}))}}clearInfoPanels(e){var t=this;this.getLayer(_SYS_LAYER_INFO_PANEL)&&this.getLayer(_SYS_LAYER_INFO_PANEL).clearDrawables((function(r,n){if(1===r){for(let e=t.options.container.childNodes.length-1;e>=0;e--)t.options.container.childNodes[e].className===_SYS_LAYER_INFO_PANEL&&t.options.container.removeChild(t.options.container.childNodes[e]);_core.off(_EVENTS.CAMERA_MOVE),e&&e(1,"成功。")}else e&&e(0,n)})),e&&e(1,"成功")}clearLayer(e,t){if(e===_SYS_LAYER_INFO_PANEL)return this.clearInfoPanels(),this;let r=this.getLayer(e);if(r){for(let t=r.getDrawables().length-1;t>=0;t--)this.removeDrawable(e,r.getDrawables()[t].name);return t&&t(1,"成功清除图层中的绘制物。"),this}return t&&t(0,`未找到名为 ${e} 的图层。`),this}clearODLine(){_core.clearODLine()}clearOverlays(){for(let e=_layers.length-1;e>=0;e--)this.removeLayer(_layers[e].name);return this}clearSkyBox(){_core.clearBackground()}closePopup(e){this.clearInfoPanels(e)}convertLLAToXYZ(e){return _core.convertLLAToXYZ({x:e.lon,y:e.lat,z:e.alt})}convertScreenToWorld(e){let t=_core.convertScreenToWorld(e),r=_core.convertXYZToLLA({x:t.x,y:t.y,z:t.z});return{x:t.x,y:t.y,z:t.z,lon:r.x,lat:r.y,alt:r.z}}convertWorldToScreen(e){return _core.convertWorldToScreen(e)}convertXYZToLLA(e){return _core.convertXYZToLLA(e)}convertXYZToLLAByCoordinate(e,t){return _core.convertXYZTOLLAByCoordinate(e,t)}deselectAllLandmark(){_core.deselectAllBillboard()}deselectLandmark(e,t){if(this.getLayer(e)){let r=this.getLayer(e).getDrawable(t);if(!r||"landmark"!==r.type.toLowerCase()&&"trail"!==r.type.toLowerCase())return;_core.deselectBillboard(r.getFullName())}}destroy(e){this.url=null,this.name=null,this.author=null,this.type=null,this.additionalInfo=null,_layers=null,_models=null,_core.destroy(),_core=null,_showStats=null;for(let e=this.options.container.children.length-1;e>=0;e--)this.options.container.removeChild(this.options.container.children[e]);this.options=null,e&&e(1)}fpsPanelOff(){_core.fpsPanelOff()}fpsPanelOn(){_core.fpsPanelOn()}getAdditionalInfo(){return this.additionalInfo}getBar(e,t){if(this.getLayer(e)){let r=this.getLayer(e).getDrawable(t);return r&&"bar"===r.type.toLowerCase()?r:void 0}}getBubble(e,t){if(this.getLayer(e)){let r=this.getLayer(e).getDrawable(t);return r&&"bubble"===r.type.toLowerCase()?r:void 0}}getBuildingInfo(e,t){if(!e||""===e.toString())return logger.warn("Scene.getBuildingInfo() 无效的参数。"),t&&t(0,void 0),this;if(!this.options.buildingIndex||!this.options.buildingIndex.length||this.options.buildingIndex.length<=0)return logger.warn("Scene.getBuildingInfo() 未加载有效的建筑物信息，无法获取建筑信息，请联系场景提供者。"),t&&t(0,void 0),this;let r;for(let t of this.options.buildingIndex)if(t.id===e.toString()){r=t;break}return r?(t&&t(1,r),this):(logger.warn(`Scene.getBuildingInfo() 未找到指定的楼宇：${e}。`),t&&t(0,void 0),this)}getCamera(){let e=_core.getCamera();return e?{target:{type:"xyz",x:e.targetX,y:e.targetY,z:e.targetZ},posture:[0,e.inclinationAngle,e.azimuthAngle],distance:e.viewDistance}:void logger.warn("获取摄像机参数失败。")}getDatumShiftModel(){return _core.getDatumShiftModel()}getDrawable(e,t){return this.getLayer(e)?this.getLayer(e).getDrawable(t):void 0}getDrawables(){return _layers}getInfoPanel(e){let t="不存在的infoPanel";var r=this;for(let n=r.options.container.childNodes.length-1;n>=0;n--)r.options.container.childNodes[n].getAttribute("id")===`${_SYS_LAYER_INFO_PANEL}_${e}`&&(t=r.options.container.childNodes[n]);return t}getInfoPanels(){return this.getLayer(_SYS_LAYER_INFO_PANEL)?this.getLayer(_SYS_LAYER_INFO_PANEL).getDrawables():[]}getLandmark(e,t){if(this.getLayer(e)){let r=this.getLayer(e).getDrawable(t);return r&&"landmark"===r.type.toLowerCase()?r:void 0}}getLayer(e){if(_layers instanceof Array)for(let t of _layers)if(t.name===e)return t}getLayers(){return _layers}getModelParam(e){return _core.getModelParam(e)}getName(){return this.name}getUrl(){return this.url}getView(){_camera$1=this.getCamera();let e=_core.convertXYZToLLA({x:_camera$1.target.x,y:_camera$1.target.y,z:_camera$1.target.z});return{center:[e.x,e.y,e.z],rph:_camera$1.posture,distance:_camera$1.distance}}hideAllModels(){for(let e of _models)e.name&&_core.hideModelByName(e.name)}hideDrawable(e,t,r){if(this.getLayer(e)){let n=this.getLayer(e).getDrawable(t);if(null==n)return void logger.warn(`绘制物 ${t} 不存在。`);let i=n.getFullName();return"trail"===i.substr(i.lastIndexOf("/")+1,i.length-i.lastIndexOf("/"))?(_core.hideLayer(i+"Line"),_core.hideLayer(i)):_core.hideLayer(i),n.isShow=!1,void(r&&r(0,`成功隐藏 ${e} 图层的绘制物。`))}r&&r(0,`未找到名为 ${e} 图层的绘制物。`);let n=e+"_"+t;if(_overlayTips[n]){_overlayTips[n].dom.style.display="none"}return this}hideFirefly(e){_core.hideFireFly(e)}hideFireworks(e){_core.hideFireworks(e)}hideInfoPanel(){var e=this;if(null!=e.getLayer(_SYS_LAYER_INFO_PANEL)){let t=e.getLayer(_SYS_LAYER_INFO_PANEL).getDrawables();if(t&&t.length>0)for(let r of t)for(let t=0;t<e.options.container.childNodes.length;t++)if(e.options.container.childNodes[t].getAttribute("id")===`${_SYS_LAYER_INFO_PANEL}_${r.name}`){e.options.container.childNodes[t].style.display="none";break}}}hideLayer(e,t){let r=this.getLayer(e);if(r){for(let e=r.getDrawables().length-1;e>=0;e--){let t=r.getDrawables()[e];if(t){let e=t.getFullName();"trail"===e.substr(e.lastIndexOf("/")+1,e.length-e.lastIndexOf("/"))?(_core.hideLayer(e+"Line"),_core.hideLayer(e)):_core.hideLayer(e),t.isShow=!1;let n=r.name+"_"+t.name;if(_overlayTips[n]){_overlayTips[n].dom.style.display="none"}}}return t&&t(1,"成功隐藏图层中的绘制物。"),this}}hideModelByName(e,t){_core.hideModel(e,t)}hideNode(e,t){return _core.setNodeVisibility(e,t,!1),this}hideRain(e){_core.hideRain(e)}hideRainline(e){_core.hideRainline(e)}hideSnow(e){_core.hideSnow(e)}init(e,t,r){if(this.options=e,this.url&&e.container){if(!this.options.container)return logger.warn(`模型加载出错。无效的容器名称（${this.options.container}）。`),void(t&&t(0));_core=new scene.Core,this.additionalInfo&&this.additionalInfo.resourceBasePath&&(_core.resourceBasePath=this.additionalInfo.resourceBasePath),!0===e.editMode&&(e.pointerMode="editor"),_core.init(e),this.options.accessToken&&this.options.accessToken.length>64&&_core.setAvwToken("header","authorization:bearer",this.options.accessToken),_core.loadScene({scenePath:this.url},((r,n)=>{if(1==r){var i={};if(null==e.coordinateSystem&&null!=e.center&&3==e.center.length&&(e.coordinateSystem=Scene$1.SURFACE),e.center&&3==e.center.length&&null!=e.coordinateSystem){switch(e.coordinateSystem){case Scene$1.SURFACE:e.center[0]>180||e.center[0]<-180||e.center[1]>90||e.center[1]<-90?(i.type="xyz",e.center[0]=0,e.center[1]=0,e.center[2]=0):i.type="surface";break;case Scene$1.XYZ:i.type="xyz";break;case Scene$1.ECEF:i.type="ecef";break;case Scene$1.PLANAR_LOCAL:i.type="planarlocal";break;case Scene$1.MERCATOR:i.type="mercator";break;case Scene$1.WGS84:i.type="surface"}i.lon=e.center[0],i.lat=e.center[1],i.alt=e.center[2],e.scale&&3==e.scale.length?(i.scaleX=e.scale[0],i.scaleY=e.scale[1],i.scaleZ=e.scale[2]):(i.scaleX=1,i.scaleY=1,i.scaleZ=1),_core.setDatumShiftModel(i)}e.camera&&this.cameraFlyTo(e.camera,0),t&&t(1)}else t&&t(0,n)}),(e=>{"progress"===e.type&&e.total<e.loaded?r&&r({type:"progress",total:e.loaded,loaded:e.loaded}):r&&r(e)})),_core.on(_EVENTS.CAMERA_MOVE,"",this.tipFollowingMaster)}return this}loadScene(e,t,r){_core.loadScene(e,t,r)}off(e,t,r){t&&""!==t?(void 0===r&&(_eventHandler[_EVENTS.CLICK].byType[t]=[],_core.off(e,t,"")),_eventHandler[_EVENTS.CLICK].byType[t].map(((n,i)=>{n.callback===r&&(_core.off(e,t,n.coreCallback),_eventHandler[_EVENTS.CLICK].byType[t].splice(i,1))}))):(void 0===r&&(_eventHandler[_EVENTS.CLICK].default=[],_core.off(e,t,"")),_eventHandler[_EVENTS.CLICK].default.map(((n,i)=>{n.callback===r&&(_core.off(e,t,n.coreCallback),_eventHandler[_EVENTS.CLICK].default.splice(i,1))})))}on(e,t,r){if(e&&r){var n=this;switch(e){case _EVENTS.LOD_CHANGE:""===t.toLowerCase()&&(_eventHandler[e].default=r,_core.on("lodchange","",(t=>{_eventHandler[e].default(t)})));break;case _EVENTS.CLICK:if(null==_eventHandler[e].byType[t.toLowerCase()])return;if("model"===t.toLowerCase()){let n={callback:r,coreCallback:function(e,t,r){if(t){var n={name:t.name,type:"model",position:t.position,positionLla:t.positionLla,_name:t._name};_eventHandler[_EVENTS.CLICK].byType.model[r].callback(e,n)}}};_eventHandler[e].byType[t.toLowerCase()].push(n),_core.on(e,"model",n.coreCallback)}if("building"===t.toLowerCase()){let n={callback:r,coreCallback:function(e,t,r){if(t){var n={name:t.name,type:"building",position:t.position,positionLla:t.positionLla,selectedType:t.selectedType};_eventHandler[_EVENTS.CLICK].byType.building[r].callback(e,n)}}};_eventHandler[e].byType[t.toLowerCase()].push(n),_core.on(e,"building",n.coreCallback)}if("scene"===t.toLowerCase()){let n={callback:r,coreCallback:function(e,t,r){if(t)if("background"===t.type)_eventHandler[_EVENTS.CLICK].byType.scene[r].callback(e,t);else{var n={name:t.name,type:"model",position:t.position,positionLla:t.positionLla};_eventHandler[_EVENTS.CLICK].byType.scene[r].callback(e,n)}}};_eventHandler[e].byType[t.toLowerCase()].push(n),_core.on(e,"scene",n.coreCallback)}if("landmark"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){let n=a.getDrawable(i[1]);n.positionLla=t.positionLla,_eventHandler[_EVENTS.CLICK].byType.landmark[r].callback(e,n)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"landmark",i.coreCallback)}if("bubble"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){let t=a.getDrawable(i[1]);_eventHandler[_EVENTS.CLICK].byType.bubble[r].callback(e,t)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"bubble",i.coreCallback)}if("bar"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){let t=a.getDrawable(i[1]);_eventHandler[_EVENTS.CLICK].byType.bar[r].callback(e,t)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"bar",i.coreCallback)}if("trail"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){let t=a.getDrawable(i[1]);_eventHandler[_EVENTS.CLICK].byType.trail[r].callback(e,t)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"trail",i.coreCallback)}if("odline"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){_core.convertXYZToLLA({x:t.position.x,y:t.position.y,z:t.position.z});let n=a.getDrawable(i[1]);_eventHandler[_EVENTS.CLICK].byType.odline[r].callback(e,n)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"odline",i.coreCallback)}if("area"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){let t=a.getDrawable(i[1]);_eventHandler[_EVENTS.CLICK].byType.area[r].callback(e,t)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"area",i.coreCallback)}if("drawable"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a)if("odline"==i[2]){_core.convertXYZToLLA({x:t.position.x,y:t.position.y,z:t.position.z});let n=a.getDrawable(i[1]);_eventHandler[_EVENTS.CLICK].byType.drawable[r].callback(e,n)}else if("instancedbubble"==i[2]){let n=t.userData.names[t.instanceId],o=a.getDrawable(i[1]);_eventHandler[_EVENTS.CLICK].byType.drawable[r].callback(e,o,n)}else{let t=a.getDrawable(i[1]);_eventHandler[_EVENTS.CLICK].byType.drawable[r].callback(e,t)}else{let n=t.parent.name.split("/");t.parent.parent&&(n=t.parent.parent.name.split("/")),3==n.length&&_eventHandler[_EVENTS.CLICK].byType.drawable[r].callback(e,{parent:n[1],name:n[1]})}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"drawable",i.coreCallback)}break;case _EVENTS.DOUBLE_CLICK:case _EVENTS.MOUSE_DOWN:_core.on(e,t,r);break;case _EVENTS.MOUSE_HOVER:if(null==_eventHandler[e].byType[t.toLowerCase()])return;if("model"===t.toLowerCase()){let n={callback:r,coreCallback:function(e,t,r){if(t){var n={name:t.name,type:"model",position:t.position,positionLla:t.positionLla};_eventHandler[_EVENTS.MOUSE_HOVER].byType.model[r].callback(e,n)}}};_eventHandler[e].byType[t.toLowerCase()].push(n),_core.on(e,"model",n.coreCallback)}if("building"===t.toLowerCase()){let n={callback:r,coreCallback:function(e,t,r){if(t){var n={name:t.name,type:"building",position:t.position,positionLla:t.positionLla,selectedType:t.selectedType};_eventHandler[_EVENTS.MOUSE_HOVER].byType.building[r].callback(e,n)}}};_eventHandler[e].byType[t.toLowerCase()].push(n),_core.on(e,"building",n.coreCallback)}if("scene"===t.toLowerCase()){let n={callback:r,coreCallback:function(e,t,r){if(t)if("background"===t.type)_eventHandler[_EVENTS.MOUSE_HOVER].byType.scene[r].callback(e,t);else{var n={name:t.name,type:"model",position:t.position,positionLla:t.positionLla};_eventHandler[_EVENTS.MOUSE_HOVER].byType.scene[r].callback(e,n)}}};_eventHandler[e].byType[t.toLowerCase()].push(n),_core.on(e,"scene",n.coreCallback)}if("landmark"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){let n=a.getDrawable(i[1]);n.positionLla=t.positionLla,_eventHandler[_EVENTS.MOUSE_HOVER].byType.landmark[r].callback(e,n)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"landmark",i.coreCallback)}if("bubble"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){let t=a.getDrawable(i[1]);_eventHandler[_EVENTS.MOUSE_HOVER].byType.bubble[r].callback(e,t)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"bubble",i.coreCallback)}if("bar"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){let t=a.getDrawable(i[1]);_eventHandler[_EVENTS.MOUSE_HOVER].byType.bar[r].callback(e,t)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"bar",i.coreCallback)}if("trail"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){let t=a.getDrawable(i[1]);_eventHandler[_EVENTS.MOUSE_HOVER].byType.trail[r].callback(e,t)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"trail",i.coreCallback)}if("odline"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){_core.convertXYZToLLA({x:t.position.x,y:t.position.y,z:t.position.z});let n=a.getDrawable(i[1]);_eventHandler[_EVENTS.MOUSE_HOVER].byType.odline[r].callback(e,n)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"odline",i.coreCallback)}if("area"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){let t=a.getDrawable(i[1]);_eventHandler[_EVENTS.MOUSE_HOVER].byType.area[r].callback(e,t)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"area",i.coreCallback)}if("drawable"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a)if("odline"==i[2]){_core.convertXYZToLLA({x:t.position.x,y:t.position.y,z:t.position.z});let n=a.getDrawable(i[1]);_eventHandler[_EVENTS.MOUSE_HOVER].byType.drawable[r].callback(e,n)}else if("instancedbubble"==i[2]){let n=t.userData.names[t.instanceId],o=a.getDrawable(i[1]);_eventHandler[_EVENTS.MOUSE_HOVER].byType.drawable[r].callback(e,o,n)}else{let t=a.getDrawable(i[1]);_eventHandler[_EVENTS.MOUSE_HOVER].byType.drawable[r].callback(e,t)}else{let n=t.parent.name.split("/");t.parent.parent&&(n=t.parent.parent.name.split("/")),3==n.length&&_eventHandler[_EVENTS.MOUSE_HOVER].byType.drawable[r].callback(e,{parent:n[1],name:n[1]})}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"drawable",i.coreCallback)}break;case _EVENTS.UNMOUSE_HOVER:if(null==_eventHandler[e].byType[t.toLowerCase()])return;if("model"===t.toLowerCase()){let n={callback:r,coreCallback:function(e,t,r){if(t){var n={name:t.name,type:"model",position:t.position,positionLla:t.positionLla};_eventHandler[_EVENTS.UNMOUSE_HOVER].byType.model[r].callback(e,n)}}};_eventHandler[e].byType[t.toLowerCase()].push(n),_core.on(e,"model",n.coreCallback)}if("building"===t.toLowerCase()){let n={callback:r,coreCallback:function(e,t,r){if(t){var n={name:t.name,type:"building",position:t.position,positionLla:t.positionLla,selectedType:t.selectedType};_eventHandler[_EVENTS.UNMOUSE_HOVER].byType.building[r].callback(e,n)}}};_eventHandler[e].byType[t.toLowerCase()].push(n),_core.on(e,"building",n.coreCallback)}if("scene"===t.toLowerCase()){let n={callback:r,coreCallback:function(e,t,r){if(t)if("background"===t.type)_eventHandler[_EVENTS.UNMOUSE_HOVER].byType.scene[r].callback(e,t);else{var n={name:t.name,type:"model",position:t.position,positionLla:t.positionLla};_eventHandler[_EVENTS.UNMOUSE_HOVER].byType.scene[r].callback(e,n)}}};_eventHandler[e].byType[t.toLowerCase()].push(n),_core.on(e,"scene",n.coreCallback)}if("landmark"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){let n=a.getDrawable(i[1]);n.positionLla=t.positionLla,_eventHandler[_EVENTS.UNMOUSE_HOVER].byType.landmark[r].callback(e,n)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"landmark",i.coreCallback)}if("bubble"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){let t=a.getDrawable(i[1]);_eventHandler[_EVENTS.UNMOUSE_HOVER].byType.bubble[r].callback(e,t)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"bubble",i.coreCallback)}if("bar"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){let t=a.getDrawable(i[1]);_eventHandler[_EVENTS.UNMOUSE_HOVER].byType.bar[r].callback(e,t)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"bar",i.coreCallback)}if("trail"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){let t=a.getDrawable(i[1]);_eventHandler[_EVENTS.UNMOUSE_HOVER].byType.trail[r].callback(e,t)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"trail",i.coreCallback)}if("odline"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){_core.convertXYZToLLA({x:t.position.x,y:t.position.y,z:t.position.z});let n=a.getDrawable(i[1]);_eventHandler[_EVENTS.UNMOUSE_HOVER].byType.odline[r].callback(e,n)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"odline",i.coreCallback)}if("area"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a){let t=a.getDrawable(i[1]);_eventHandler[_EVENTS.UNMOUSE_HOVER].byType.area[r].callback(e,t)}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"area",i.coreCallback)}if("drawable"===t.toLowerCase()){let i={callback:r,coreCallback:function(e,t,r){if(t){let i=t.name.split("/"),a=n.getLayer(i[0]);if(a)if("odline"==i[2]){_core.convertXYZToLLA({x:t.position.x,y:t.position.y,z:t.position.z});let n=a.getDrawable(i[1]);_eventHandler[_EVENTS.UNMOUSE_HOVER].byType.drawable[r].callback(e,n)}else if("instancedbubble"==i[2]){let n=t.userData.names[t.instanceId],o=a.getDrawable(i[1]);_eventHandler[_EVENTS.UNMOUSE_HOVER].byType.drawable[r].callback(e,o,n)}else{let t=a.getDrawable(i[1]);_eventHandler[_EVENTS.UNMOUSE_HOVER].byType.drawable[r].callback(e,t)}else{let n=t.parent.name.split("/");t.parent.parent&&(n=t.parent.parent.name.split("/")),3==n.length&&_eventHandler[_EVENTS.UNMOUSE_HOVER].byType.drawable[r].callback(e,{parent:n[1],name:n[1]})}}}};_eventHandler[e].byType[t.toLowerCase()].push(i),_core.on(e,"drawable",i.coreCallback)}break;case _EVENTS.MOUSE_UP:case _EVENTS.CAMERA_MOVE:case _EVENTS.CAMERA_ZOOM:_core.on(e,t,r);break;case _EVENTS.TRAIL_MOVE:let i={callback:r,coreCallback:function(e,t){if(e){var r=[],n=[];for(var i in e)r.push(e[i]);r.map((e=>{var t=_core.convertXYZToLLA({x:e.position.x,y:e.position.y,z:e.position.z});e.position.lon=t.x,e.position.lat=t.y,e.position.alt=t.z;let r={name:e.name.substring(e.name.indexOf("/")+1,e.name.lastIndexOf("/")),position:e.position,type:"trail"};n.push(r)})),_eventHandler[_EVENTS.TRAIL_MOVE].default[t].callback(n)}}};_eventHandler[e].default.push(i),_core.on(e,"",i.coreCallback);break;default:logger.warn("注册事件处理函数参数有误。")}}else logger.warn("注册事件处理函数参数有误。")}removeArea(e,t){if(this.getLayer(e)){let r=this.getLayer(e).getDrawable(t);null!=r&&r?(this.spliceDrawable(e,t),r.removeArea()):logger.warn("未找到图层名为："+e+"，绘制物名称为："+t+"的绘制物。")}}removeBar(e,t){if(this.getLayer(e)){let r=this.getLayer(e).getDrawable(t);null!=r&&r?(this.spliceDrawable(e,t),r.removeBar()):logger.warn("未找到图层名为："+e+"，绘制物名称为："+t+"的绘制物。")}}removeBubble(e,t){if(this.getLayer(e)){let r=this.getLayer(e).getDrawable(t);null!=r&&r?(this.spliceDrawable(e,t),r.removeBubble()):logger.warn("未找到图层名为："+e+"，绘制物名称为："+t+"的绘制物。")}}removeDrawable(e,t,r){if(this.getLayer(e)){let n=this.getLayer(e).getDrawable(t);if(!n)return this;this.spliceDrawable(e,t),_core.removeLayer(n.getFullName()),r&&r(0,`成功删除 ${e} 图层的绘制物。`)}else r&&r(0,`未找到名为 ${e} 图层的绘制物。`);let n=e+"_"+t;if(_overlayTips[n]){let e=_overlayTips[n];this.options.container.removeChild(e.dom),delete _overlayTips[n]}return this}removeFirefly(e){_core.removeFireFly(e)}removeFireworks(e){_core.removeFireworks(e)}removeHeatMap(e,t,r){e&&""!==e||(e=_SYS_LAYER_HEAT_MAP);let n=this.getLayer(e).getDrawable(t);null!=n&&n?(this.spliceDrawable(e,t),n.removeHeatmap()):logger.warn("未找到指定图层下指定名称的绘制物。")}removeInfoPanel(e,t){if(this.getLayer(_SYS_LAYER_INFO_PANEL)){var r=this.getLayer(_SYS_LAYER_INFO_PANEL).getDrawable(e);null!=r&&r&&r.removeInfoPanel(e,_SYS_LAYER_INFO_PANEL,this.options,_EVENTS,_layers,t)}else logger.warn("目前没有绘制信息标牌")}removeLandmark(e,t){if(this.getLayer(e)){let r=this.getLayer(e).getDrawable(t);null!=r&&r?(this.spliceDrawable(e,t),r.removeLandmark()):logger.warn("未找到图层名为："+e+"，绘制物名称为："+t+"的绘制物。")}}removeLayer(e,t){e===_SYS_LAYER_INFO_PANEL&&this.clearInfoPanels(),e===_SYS_LAYER_HEAT_MAP&&this.clearHeatMap();for(let r=_layers.length-1;r>=0;r--)if(_layers[r].name===e){for(let t=_layers[r].getDrawables().length-1;t>=0;t--){let n=_layers[r].getDrawables()[t];_core.removeLayer(n.getFullName());let i=e+"_"+n.name;if(_overlayTips[i]){let e=_overlayTips[i];this.options.container.removeChild(e.dom),delete _overlayTips[i]}}return _layers.splice(r,1),t&&t(1,"成功移除图层。"),this}return t&&t(0,`未找到名为 ${e} 的图层。`),this}removeODLine(e,t){if(this.getLayer(e)){let r=this.getLayer(e).getDrawable(t);null!=r&&r?(this.spliceDrawable(e,t),r.removeODLine()):logger.warn("未找到指定图层下指定名称的绘制物。")}}removePopup(e){var t=this.getLayer(_SYS_LAYER_INFO_PANEL).getDrawable(_SYS_POPUP);null!=t&&t&&t.removeInfoPanel(_SYS_POPUP,_SYS_LAYER_INFO_PANEL,this.options,_EVENTS,_layers,e)}removeRain(e){_core.removeRain(e)}removeRainline(e){_core.removeRainline(e)}removeSnow(e){_core.removeSnow(e)}removeSolidBillboard(e,t){let r=this.getLayer(_SYS_LAYER_SOLID_BILLBOARD).getDrawable(e);null!=r&&null!=r?(r.removeSolidBillboard(),this.getLayer(_SYS_LAYER_SOLID_BILLBOARD).removeDrawable(e)):t&&t(0,"未找到对应的立体标牌")}removeTrail(e,t,r){let n=this.getLayer(e).getDrawable(t);null!=n&&null!=n?(n.removeTrail(),this.getLayer(e).removeDrawable(t)):r&&r(0,"未找到对应的trail")}resetNode(e,t){return _core.resetNodeParamRecursive(e,{nodeName:t}),this}resetNodeParam(e,t){_core.resetNodeParam(e,t)}selectLandmark(e,t){if(this.getLayer(e)){let r=this.getLayer(e).getDrawable(t);if(!r||"landmark"!==r.type.toLowerCase()&&"trail"!==r.type.toLowerCase())return;_core.selectBillboard(r.getFullName(),{path:"texture/ui/highlight-landmark.png"})}}setAutoRotate(e,t,r){void 0===r&&(r=!0),e?_core.autoRotate(t,r):_core.autoRotate(0)}setBackgroundColor(e){_core.setBackgroundColor(e)}setBackgroundImage(e){_core.setBackgroundImage(e)}setCamera(e,t,r){if(null!=t&&null!=t||(t=0),!e)return void logger.warn("摄像机设置参数有误：不能为空。");if(!e.target)return void logger.warn("摄像机设置参数有误：target 不能为空。",JSON.stringify(e.target));if(!e.posture)return void logger.warn("摄像机设置参数有误：posture 不能为空。");if(3!==e.posture.length)return void logger.warn("摄像机设置参数有误：posture 必须为长度为 3 的数组。");if(Number(e.distance)<_DISTANCE_MIN||Number(e.distance)>_DISTANCE_MAX)return void logger.warn(`摄像机设置参数有误：distance 只能在 ${_DISTANCE_MIN} ~ ${_DISTANCE_MAX} 之间。`);_camera$1=e;let n=0,i=0;var a=null;n=Number(e.posture[2]),i=Number(e.posture[1]),a="lla"===e.target.type?_core.convertLLAToXYZ({x:e.target.lon,y:e.target.lat,z:e.target.alt}):e.target,90==i&&(i=89.99999),-90==i&&(i=-89.99999),0==e.distance&&(e.distance=1e-5),_core.cameraFlyTo(a,Number(n),Number(i),Number(e.distance),t,!0,r||void 0)}getCameraAutoRotate(){return _core.getCameraAutoRotate()}setEnvTime(e){var t=e.envTime.split(/:|：| |-|\//);return null==t[0]||t[0]>=24||null==t[1]||t[1]>=60||null!=t[1]&&t[1]>=60?{result:0,message:`时间 ${e.envTime} 格式错误。`}:(e.envTime=t.join(":"),e.duration<0?{result:0,message:"duration 属性必须大于等于 0。"}:(_core.setEnvTime(e),{result:1}))}setDatumShiftModel(e){_core.setDatumShiftModel(e)}setModelTransform(e,t,r){if(_core.defaultObjectTree.getItemByName(e)){if(t.position&&"lla"===t.position.type.toLowerCase()){let e=this.convertLLAToXYZ(t.position);t.position.x=e.x,t.position.y=e.y,t.position.z=e.z}null!=t.rotation&&(t.position&&"lla"===t.position.type.toLowerCase()?t.rotation={x:t.rotation[0],y:t.rotation[1],z:t.rotation[2]}:t.rotation={x:t.rotation[0],y:t.rotation[2],z:t.rotation[1]}),null!=t.scale&&(t.scale={x:t.scale[0],y:t.scale[1],z:t.scale[2]}),_core.setModelTransform(e,t),r&&r({result:1,message:"成功。"})}else r&&r({result:0,message:`失败，模型 ${e} 不存在。`})}setModelTransform2(e,t){if(e.position&&"lla"===e.position.type.toLowerCase()){let t=this.convertLLAToXYZ(e.position);e.position.x=t.x,e.position.y=t.y,e.position.z=t.z}e.position&&"lla"===e.position.type.toLowerCase()?(e.rotation={x:e.rotationX,y:e.rotationY,z:e.rotationZ},e.scale={x:e.scaleX,y:e.scaleY,z:e.scaleZ}):(e.rotation={x:e.rotationX,y:e.rotationZ,z:e.rotationY},e.scale={x:e.scaleX,y:e.scaleZ,z:e.scaleY}),_core.setModelTransform2(e,t)}setModelOpacity(e,t){_core.setModelOpacity(e,t)}setModelVisible(e,t){let r=_core.defaultObjectTree.getItemByName(e);if(r&&(t?r.show():r.hide()),_modelTips[e]){_modelTips[e].dom.style.display=t?"unset":"none"}}setModelStyle(e,t,r){_core.defaultObjectTree.getItemByName(e)?(_core.setModelStyle(e,t),r&&r({result:1,message:"成功。"})):r({result:0,message:`失败，模型 ${e} 不存在。`})}showAllModels(){for(let e of _models)e.name&&_core.showModel(e.name)}showDrawable(e,t,r){if(this.getLayer(e)){let n=this.getLayer(e).getDrawable(t);if(null==n)return void logger.warn(`绘制物 ${t} 不存在。`);let i=n.getFullName();return"trail"===i.substr(i.lastIndexOf("/")+1,i.length-i.lastIndexOf("/"))?(_core.showLayer(i+"Line"),_core.showLayer(i)):_core.showLayer(i),n.isShow=!0,void(r&&r(0,`成功显示绘制物 ${t}。 `))}r&&r(0,`绘制物 ${e} 不存在。`);let n=e+"_"+t;if(_overlayTips[n]){_overlayTips[n].dom.style.display="unset"}return this}showFirefly(e){_core.showFireFly(e)}showFireworks(e){_core.showFireworks(e)}showHeatMap(e,t){return this.clearHeatMap(),this.addHeatMap(_SYS_LAYER_HEAT_MAP,e,t)}showInfoPanel(){var e=this;if(null!=e.getLayer(_SYS_LAYER_INFO_PANEL)){let t=e.getLayer(_SYS_LAYER_INFO_PANEL).getDrawables();if(t&&t.length>0)for(let r of t)for(let t=0;t<e.options.container.childNodes.length;t++)if(e.options.container.childNodes[t].getAttribute("id")===`${_SYS_LAYER_INFO_PANEL}_${r.name}`){e.options.container.childNodes[t].style.display="block";break}}}showLayer(e,t){let r=this.getLayer(e);if(r){for(let e=r.getDrawables().length-1;e>=0;e--){let t=r.getDrawables()[e];if(t){let e=t.getFullName();"trail"===e.substr(e.lastIndexOf("/")+1,e.length-e.lastIndexOf("/"))?(_core.showLayer(e+"Line"),_core.showLayer(e)):_core.showLayer(e),t.isShow=!0;let n=r.name+"_"+t.name;if(_overlayTips[n]){_overlayTips[n].dom.style.display="unset"}}}return t&&t(1,"成功隐藏图层中的绘制物。"),this}}showModelByName(e,t){_core.showModel(e,t)}showNode(e,t){return _core.setNodeVisibility(e,t,!0),this}showRain(e){_core.showRain(e)}showRainline(e){_core.showRainline(e)}showSnow(e){_core.showSnow(e)}statsOff(){_showStats=!0,_core.statsOff()}statsOn(){_showStats=!0,_core.statsOn()}statsToggle(){_showStats?(_showStats=!1,_core.statsOff()):(_showStats=!0,_core.statsOn())}switchIndoor(e){let t,r;if(!e)return logger.warn(`Scene.switchIndoor() params - ${e||void 0}`),this;if(!e.buildingId||""===e.buildingId.toString())return logger.warn(`Scene.switchIndoor() 传入参数无效：params.buildingId - ${e.buildingId||void 0}`),this;if(!e.floorId||""===e.floorId.toString())return logger.warn(`Scene.switchIndoor() 传入参数无效：params.floorId - ${e.floorId||void 0}`),this;if(!this.options.buildingIndex||!this.options.buildingIndex.length||this.options.buildingIndex.length<=0)return logger.warn("Scene.switchIndoor() 未加载有效的建筑物信息，无法切换到室内视图，请联系场景提供者。"),this;for(let r of this.options.buildingIndex)if(r.id===e.buildingId.toString()){t=r;break}if(!t)return logger.warn(`Scene.switchIndoor() 未找到指定的楼宇：${e.buildingId}。`),this;if(!t.floors||!t.floors.length||t.floors.length<=0)return logger.warn(`Scene.switchIndoor() 未找到指定的楼层：${e.floorId}。`),this;for(let n of t.floors)if(n.id===e.floorId.toString()){r=n;break}if(!r)return logger.warn(`Scene.switchIndoor() 未找到指定的楼层：${e.floorId}。`),this;for(let e of t.floors)e.order>r.order&&this.hideNode("main",e.nodeName);return this}switchOutdoor(e){if(e&&""!==e.toString()||(e=""),!this.options.buildingIndex||!this.options.buildingIndex.length||this.options.buildingIndex.length<=0)return logger.warn("Scene.switchOutdoor() 未加载有效的建筑物信息，无法切换到室外视图，请联系场景提供者。"),this;if(""===e)for(let e of this.options.buildingIndex)this.switchOutdoor(e.id);else{let t;for(let r of this.options.buildingIndex)if(r.id===e.toString()){t=r;break}if(!t)return logger.warn(`Scene.switchOutdoor() 未找到指定的楼宇：${e}。`),this;if(!t.floors||!t.floors.length||t.floors.length<=0)return logger.warn(`Scene.switchOutdoor() 楼宇 ${e} 未加载有效的楼层信息，无法切换到室外视图，请联系场景提供者。`),this;for(let e of t.floors)this.showNode("main",e.nodeName)}return this}translateNode(e,t,r){return e&&t.nodeName?(r?_core.translateNodeParamRecursive(e,t):_core.translateNodeParam(e,t),this):(logger.warn("translateNode() 参数无效。"),this)}translateNodeParam(e,t){_core.translateNodeParam(e,t)}updateArea(e,t,r,n){return new Promise((i=>{let a=this.getLayer(e).getDrawable(t);a&&null!=a?a.updateArea(r,(()=>{void 0!==_overlayTips[e+"_"+t]&&this.tipFollowingMaster(),n&&n(1),i()})):(n&&n(0,"未找到图层名为："+e+"，绘制物名称为："+t+"的绘制物！"),i())}))}updatePath(e,t,r,n){return new Promise((i=>{let a=this.getLayer(e);if(!a)return n&&n(0,"未找到图层："+e+"！"),void i();let o=a.getDrawable(t);if(!o)return n&&n(0,"未找到绘制物："+e+"！"),void i();o.updatePath(r,(()=>{void 0!==_overlayTips[e+"_"+t]&&this.tipFollowingMaster(),n&&n(1,"已更新绘制物："+e+"！"),i()}))}))}updatePathPass(e,t,r,n){let i=this.getLayer(e);if(!i)return void(n&&n(0,"未找到图层："+e+"！"));let a=i.getDrawable(t);a?(a.updatePathPass(r),n&&n(1,"已更新绘制物："+e+"！")):n&&n(0,"未找到绘制物："+e+"！")}addPath(e,t,r){return new Promise((n=>{if(null==t&&null==t.points)return r&&r(0,"绘制路径失败"),void n(obj);t.type="path",this.addDrawable(e,t,(e=>{r&&r(this),n(e)}))}))}updateBar(e,t,r,n){let i=this.getLayer(e).getDrawable(t);if(i&&null!=i){i.updateBar(r);void 0!==_overlayTips[e+"_"+t]&&this.tipFollowingMaster()}else n&&n(0,"未找到图层名为："+e+"，绘制物名称为："+t+"的绘制物！")}updateBubble(e,t,r,n){let i=this.getDrawable(e,t);if(i&&null!=i){i.updateBubble(r);void 0!==_overlayTips[e+"_"+t]&&this.tipFollowingMaster()}else n&&n(0,"未找到图层名为："+e+"，绘制物名称为："+t+"的绘制物！")}updateInstancedBubble(e,t,r){let n=e,i=this.getDrawable(e,n);i&&null!=i?i.updateInstancedBubble(t):r&&r(0,"未找到图层名为："+e+"，绘制物名称为："+n+"的绘制物！")}updateFirefly(e,t){if(t.position&&"lla"===t.position.type.toLowerCase()){let e=_core.convertLLAToXYZ({x:t.position.lon,y:t.position.lat,z:t.position.alt});t.position.x=e.x,t.position.y=e.y,t.position.z=e.z}_core.updateFireFly(e,t)}updateFireworks(e,t){if(t.position&&"lla"===t.position.type.toLowerCase()){let e=_core.convertLLAToXYZ({x:t.position.lon,y:t.position.lat,z:t.position.alt});t.position.x=e.x,t.position.y=e.y,t.position.z=e.z}_core.updateFireworks(e,t)}updateHeatMapData(e,t,r){e&&""!==e||(e=_SYS_LAYER_HEAT_MAP);let n=this.getDrawable(e,t);if(n&&"heatmap"===n.type)return null!=r.opacity&&(n.opacity=r.opacity),n.points=r.points||n.points,n.radius=r.radius||n.radius,n.gradient=r.gradient||n.gradient,n.offset=r.offset||n.offset,n.style=r.style||n.style,n.enableViewDistance=r.enableViewDistance||!1,n.maxVisibleDistance=r.maxVisibleDistance||n.maxVisibleDistance,n.minVisibleDistance=r.minVisibleDistance||n.minVisibleDistance,this.removeHeatMap(e,t),this.addDrawable(e,n);logger.warn("Scene.updateHeatMapData(layerName, heatMapName, params)) 未找到指定的热力图。")}updateLandmark(e,t,r,n){return new Promise((i=>{let a=this.getDrawable(e,t);a&&null!=a?a.updateLandmark(r,(()=>{void 0!==_overlayTips[e+"_"+t]&&this.tipFollowingMaster(),n&&n(),i()})):(n&&n(0,"未找到图层名为："+e+"，绘制物名称为："+t+"的绘制物！"),i())}))}updateODLine(e,t,r,n){let i=this.getDrawable(e,t);if(i&&null!=i){i.updateODLine(r);void 0!==_overlayTips[e+"_"+t]&&this.tipFollowingMaster()}else n&&n(0,"未找到图层名为："+e+"，绘制物名称为："+t+"的绘制物！")}updateRain(e,t){_core.updateRain(e,t)}updateRainline(e,t){if(t.position&&"lla"===t.position.type.toLowerCase()){let e=_core.convertLLAToXYZ({x:t.position.lon,y:t.position.lat,z:t.position.alt});t.position.x=e.x,t.position.y=e.y,t.position.z=e.z}_core.updateRainline(e,t)}updateSnow(e,t){_core.updateSnow(e,t)}updateSolidBillboard(e,t,r){if(this.getLayer(_SYS_LAYER_SOLID_BILLBOARD)){let n=this.getLayer(_SYS_LAYER_SOLID_BILLBOARD).getDrawable(e);n&&null!=n?n.updateSolidBillboard(t):r&&r(0,"未找到名为："+e+"的立体标牌！")}else logger.warn("名为"+e+"的立体标牌不存在")}updateTrail(e,t,r,n){if(this.getLayer(e)){let i=this.getLayer(e).getDrawable(t);if(i&&null!=i){i.updateTrail(r);void 0!==_overlayTips[e+"_"+t]&&this.tipFollowingMaster()}else n&&n(0,"未找到图层名为："+e+"，绘制物名称为："+t+"的绘制物！")}else logger.warn("名为"+e+"的图层不存在")}view(e){if(!e||!e.center||!e.rph||Number(e.distance)<0)return logger.warn("视图设置参数有误。"),this;if(3!==e.center.length||3!==e.rph.length)return logger.warn("视图设置参数有误。"),this;let t=new Position("lla").set(e.center[0],e.center[1],e.center[2]),r=_core.convertLLAToXYZ({x:t.lon,y:t.lat,z:t.alt});return r.type="xyz",this.setCamera({target:r,posture:e.rph,distance:e.distance},0),this}zoomIn(e){let t=_core.getCamera();t&&(t.viewDistance=t.viewDistance/2,_core.cameraFlyTo({x:t.targetX,y:t.targetY,z:t.targetZ},t.azimuthAngle,t.inclinationAngle,t.viewDistance,e?1:0,!0))}zoomOut(e){let t=_core.getCamera();t&&(t.viewDistance=2*t.viewDistance,_core.cameraFlyTo({x:t.targetX,y:t.targetY,z:t.targetZ},t.azimuthAngle,t.inclinationAngle,t.viewDistance,e?1:0,!0))}getSceneObjects(){return _core.defaultObjectTree.children.map((e=>({name:e.name,type:e.type,isVisible:e.isVisible,isCustom:e.isCustom,src:e.map})))}async getSceneIconAssets(){let e=_core.defaultObjectTree.children.filter((e=>"IconAsset"==e.type)),t=[],r=e.map((e=>({name:e.name,type:e.type,isVisible:e.isVisible,isCustom:e.isCustom})));return e.forEach((e=>{t.push(util.syntheticImage(e.backgroundMap,e.param.backgroundColor,e.map))})),(await Promise.all(t)).forEach(((e,t)=>{r[t].src=e})),r}getStates(){return _core.getStates()}switchState(e,t,r){_core.getStates()?_core.setCurrentState(e,t,r):logger.warn("状态列表为空")}showBuildingFloor(e,t,r,n){if(!e)return;let i=_core.defaultObjectTree.getItemByName(e);i?_core.cutLevel(i.getGroup().uuid,r,n):n(!1,`模型${e}不存在`)}resetNodeParam(e,t){_core.resetNodeParam(e,t)}invokeCore(e){if("function"!=typeof _core[e])return;let t=[];for(let e=1;e<arguments.length;e++)t.push(arguments[e]);return _core[e](...t)}_debugCore(){return _core}_resolveScenePaths(){return-1!==this.url.indexOf("/",this.url.length-1)&&(this.url=this.url.substring(0,this.url.length-1)),_sceneName=this.url.substring(this.url.lastIndexOf("/")+1,this.url.length),_sceneConfigPath=this.url+`/${_SCENE_CONFIG_FILE_NAME}`,_defaultModelPath=this.url+`/model/${_sceneName}.avwm`,_defaultModelConfigPath=this.url+`/model/${_sceneName}.avwc`,new Promise(((e,t)=>{if(this.options.accessToken&&this.options.accessToken.length>_ACCESS_TOKEN_LENGTH_MIN){_sceneApiUrl=this.url.substring(0,this.url.lastIndexOf("/"));let r=util.fetchJSON(_sceneApiUrl,"POST",[{key:"content-type",value:"application/json"},{key:"authorization",value:"Bearer "+this.options.accessToken}],{modelKey:`/${_sceneName}/${_SCENE_CONFIG_FILE_NAME}`}),n=util.fetchJSON(_sceneApiUrl,"POST",[{key:"content-type",value:"application/json"},{key:"authorization",value:"Bearer "+this.options.accessToken}],{modelKey:`/${_sceneName}/model/${_sceneName}.avwm`}),i=util.fetchJSON(_sceneApiUrl,"POST",[{key:"content-type",value:"application/json"},{key:"authorization",value:"Bearer "+this.options.accessToken}],{modelKey:`/${_sceneName}/model/${_sceneName}.avwc`});Promise.all([r,n,i]).then((r=>{try{for(let e in r)r[e]=JSON.parse(r[e])}catch(e){t(e)}_sceneConfigPath=r[0].success?r[0].modelUrl:"",_defaultModelPath=r[1].success?r[1].modelUrl:"",_defaultModelConfigPath=r[2].success?r[2].modelUrl:"",_defaultModelPath.startsWith("http://")&&(_defaultModelPath=_defaultModelPath.replace("http://","//")),_defaultModelPath.startsWith("https://")&&(_defaultModelPath=_defaultModelPath.replace("https://","//")),_defaultModelConfigPath.startsWith("http://")&&(_defaultModelConfigPath=_defaultModelConfigPath.replace("http://","//")),_defaultModelConfigPath.startsWith("https://")&&(_defaultModelConfigPath=_defaultModelConfigPath.replace("https://","//")),_sceneConfigPath.startsWith("http://")&&(_sceneConfigPath=_sceneConfigPath.replace("http://","//")),_sceneConfigPath.startsWith("https://")&&(_sceneConfigPath=_sceneConfigPath.replace("https://","//")),e()})).catch((e=>{t(e)}))}else e()}))}_generateLableCanvas(e,t,r,n,i,a,o){let s=document.createElement("canvas"),l=s.getContext("2d");var c=8*t,h="";r&&(h="bold");var u="";return n&&(u="italic"),l.font=`${u} ${h} ${c}px ${e}`,s.width=l.measureText(o).width+c,s.height=2*c,l.fillStyle=i,l.fillRect(0,0,s.width,s.height),l.font=`${u} ${h} ${c}px ${e}`,l.fillStyle=a,l.textAlign="center",l.textBaseline="middle",l.fillText(o,s.width/2,s.height/2),s}rotatingModel(e,t){_core.defaultObjectTree.getItemByName(e.id)?(_core.rotatingModel(e),t&&t({result:1,message:"成功。"})):t({result:0,message:`失败，模型 ${e.id} 不存在。`})}setModelRotationState(e,t){_core.defaultObjectTree.getItemByName(e.id)?(_core.setModelRotationState(e),t&&t({result:1,message:"成功。"})):t({result:0,message:`失败，模型 ${e.id} 不存在。`})}blinkingModel(e,t){_core.defaultObjectTree.getItemByName(e.id)?(_core.blinkingModel(e),t&&t({result:1,message:"成功。"})):t({result:0,message:`失败，模型 ${e.id} 不存在。`})}setModelBlinkState(e,t){_core.defaultObjectTree.getItemByName(e.id)?(_core.setModelBlinkState(e),t&&t({result:1,message:"成功。"})):t({result:0,message:`失败，模型 ${e.id} 不存在。`})}movingModel(e,t){if(_core.defaultObjectTree.getItemByName(e.id)){if(0==e.coordType){let t=[];e.points&&e.points.forEach((e=>{let r=this.convertLLAToXYZ(e);r.speed=e.speed,t.push(r)})),e.points=t}_core.movingModel({id:e.id,loopMode:e.loopMode,reverse:e.reverse,direction:e.direction,offset:e.offset,points:e.points}),t&&t({result:1,message:"成功。"})}else t({result:0,message:`失败，模型 ${e.id} 不存在。`})}setModelMoveState(e,t){_core.defaultObjectTree.getItemByName(e.id)?(_core.setModelMoveState(e),t&&t({result:1,message:"成功。"})):t({result:0,message:`失败，模型 ${e.id} 不存在。`})}pathingModel(e,t){_core.defaultObjectTree.getItemByName(e.id)?(_core.pathingModel(e),t&&t({result:1,message:"成功。"})):t({result:0,message:`失败，模型 ${e.id} 不存在。`})}updatePathingModel({layer:e,setPathPass:t}={}){let r=e.getPositions(),n=e.id;_core.updatePathingModel(n,r,t)}deletePathingModel({layerIds:e}){e.forEach((e=>{_core.deletePathingModel(e)}))}setModelPathingState(e,t){_core.defaultObjectTree.getItemByName(e.id)?(_core.setModelPathingState(e),t&&t({result:1,message:"成功。"})):t({result:0,message:`失败，模型 ${e.id} 不存在。`})}selectModel(e,t){_core.selectModel(e,t)}endSelectModel(e){_core.endSelectModel(e)}pickModel(e,t){_core.pickModel(e,t)}endPickModel(e){_core.endPickModel(e)}clickModel(e,t,r){_core.defaultObjectTree.getItemByName(e.id)?_core.clickModel(e,t,r):t({result:0,message:`失败，模型 ${e.id} 不存在。`})}clickModelType(e,t){_core.clickModelType(e,t)}clearModelSelected(e){_core.clearModelSelected(e)}highlightBuilding(e,t){_core.highlightBuilding(e,t)}highlightFloor(e,t){_core.highlightFloor(e,t)}highlightRoom(e,t){_core.highlightRoom(e,t)}getBuildings(e,t){_core.getBuildings(e,t)}focusFloor(e,t,r){_core.focusFloor(e,t,r)}getModelArticulation(e,t){_core.getModelArticulation(e,t)}setModelArticulation(e,t){_core.setModelArticulation(e,t)}getModelAnimation(e,t){_core.getModelAnimation(e,t)}playModelAnimation(e,t){_core.playModelAnimation(e,t)}getWorldScale(){return _core.getWorldScale()}removeMarker(e,t,r){e!==_SYS_LAYER_INFO_PANEL&&e!==_SYS_LAYER_HEAT_MAP?this.removeDrawable(e,t,r):r&&r(0,"参数错误。")}triggerMarker(e,t,r){let n=this.getDrawable(e,t);switch(void 0===n&&logger.warn("Scene.triggerMarker(layerName, markerName, action) 未找到指定的散点。",e,t,r),r){case Scene$1.MARKER_ACTION.FLASH_START:_core.startFlashSprite(n.parent+"/"+n.name);break;case Scene$1.MARKER_ACTION.FLASH_STOP:_core.stopFlashSprite(n.parent+"/"+n.name);break;default:logger.warn("Scene.triggerMarker(layerName, markerName, action) 传入参数有误。",e,t,r)}return this}triggerMarkerByFullName(e,t){if(!e||""===e)return void logger.warn("Scene.triggerMarkerByFullName(markerFullName, action) 传入参数有误。",e,t);let r=e.split("/");if(r&&r.length&&2==r.length)return this.triggerMarker(r[0],r[1],t);logger.warn("Scene.triggerMarkerByFullName(markerFullName, action) 传入参数有误。",e,t)}removeFireFly(e){_core.removeFireFly(e)}addMarker(e,t,r){if(t)return t.type="marker",this.addDrawable(e,t,r);r&&r(0,"Scene.addMarker(markerInfo, callback) 传入参数有误。")}addMarkers(e,t){if(t&&t instanceof Array){for(let r of t)r.type="marker",this.addDrawable(e,r);return this}callback&&callback(0,"Scene.addMarkers(layerName, markers, callback) 传入参数有误。")}addFlashMarker(e,t,r){if(t)if(t.icons instanceof Array){if(!(t.icons.length<=0||t.icons.length>64))return t.type="flashmarker",this.addDrawable(e,t,r);r&&r(0,"Scene.addFlashMarker(markerInfo, callback) 传入参数有误。闪烁图片个数在 1 - 64 之间。")}else r&&r(0,"Scene.addFlashMarker(markerInfo, callback) 传入参数有误。");else r&&r(0,"Scene.addFlashMarker(markerInfo, callback) 传入参数有误。")}addFlashMarkers(e,t){if(t&&t instanceof Array){for(let r of t)r.type="flashmarker",this.addDrawable(e,r);return this}callback&&callback(0,"Scene.addMarkers(layerName, markers, callback) 传入参数有误。")}isMarkerFlashing(e,t){let r=this.getDrawable(e,t);if(void 0!==r)return _core.isSpriteFlashing(r.parent+"/"+r.name);logger.warn("Scene.isMarkerFlashing(layerName, markerName) 未找到指定的散点。",e,t)}isMarkerFlashingByFullName(e){if(!e||""===e)return void logger.warn("Scene.isMarkerFlashingByFullName(markerFullName) 传入参数有误。",e);let t=e.split("/");if(t&&t.length&&2==t.length)return this.isMarkerFlashing(t[0],t[1]);logger.warn("Scene.isMarkerFlashingByFullName(markerFullName) 传入参数有误。",e)}addFireFly(e){if(e.position&&"lla"===e.position.type.toLowerCase()){let t=_core.convertLLAToXYZ({x:e.position.lon,y:e.position.lat,z:e.position.alt});e.position.x=t.x,e.position.y=t.y,e.position.z=t.z}_core.addFireFly(e)}additionalInfo(e){return this.additionalInfo=e,this}author(e){return this.author=e,this}changeScene(e){let t=this.lodSceneConfig.find((t=>t.model===e));if(t){for(let t of this.lodSceneConfig)t.model!==e?this.hideModelByName(t.model):this.showModelByName(t.model);t.config&&this.loadSceneConfig(t.config)}}clearPerfLog(){_core.clearPerfLog()}getAuthor(){return this.author}getLastPerfLog(){return _core.getLastPerfLog()}getSceneConfig(){}getType(){return this.type}getTypeText(){switch(this.type){case Scene$1.TYPE.NATIVE:return"Digihail";case Scene$1.TYPE.HW_PARK:return"Huawei Park";default:return"Unknown"}}hideFireFly(e){_core.hideFireFly(e)}initMulti(e,t){switch(this.options=e,this.options.coordinateSystem||(this.options.coordinateSystem=Scene$1.COORDINATE_SYSTEM.SURFACE),this.options.coordinateSystem){case Scene$1.COORDINATE_SYSTEM.SURFACE:case Scene$1.COORDINATE_SYSTEM.ECEF:case Scene$1.COORDINATE_SYSTEM.PLANAR_GLOBAL:case Scene$1.COORDINATE_SYSTEM.PLANAR_LOCAL:break;case Scene$1.COORDINATE_SYSTEM.WGS84:this.options.coordinateSystem=Scene$1.COORDINATE_SYSTEM.SURFACE;break;case Scene$1.COORDINATE_SYSTEM.XYZ:break;default:this.options.coordinateSystem=Scene$1.COORDINATE_SYSTEM.SURFACE}switch(this.options.angleUnit||(this.options.angleUnit=Scene$1.ANGLE_UNIT.DEGREE),this.options.angleUnit){case Scene$1.ANGLE_UNIT.DEGREE:case Scene$1.ANGLE_UNIT.RAD:break;default:this.options.angleUnit=Scene$1.ANGLE_UNIT.DEGREE}if(this.url&&e.container){-1!==this.url.indexOf("/",this.url.length-1)&&(this.url=this.url.substring(0,this.url.length-1)),this.url.startsWith("http://")&&(this.url=this.url.replace("http://","//")),this.url.startsWith("https://")&&(this.url=this.url.replace("https://","//"));let a=this.url+`/${_SCENE_CONFIG_FILE_NAME}`;try{let o={fogEnable:!1,fogColor:"#00aaff",fogNear:200,fogFar:2e4,clearPassEnable:!0,clearColor:"#00aaff",clearAlpha:1,texturePassEnable:!1,texturePassImagePath:"texture/backgroundImage.png",texturePassOpacity:1,cubeTexturePassEnable:!1,cubeTextureFolderPath:"texture/cubemap/day/",cubeTexturePostFix:".png",cubeTexturePassOpacity:1,renderPassEnable:!0,ssaoPassEnable:!1,kernelRadius:16,minDistance:.001,maxDistance:.3,bloomPassEnable:!1,exposure:1,bloomStrength:1.5,bloomThreshold:1,bloomRadius:.01,taaRenderPassEnable:!1,smaaPassEnable:!0,fxaaPassEnable:!1,filmPassEnable:!1,noiseIntensity:.8,scanlinesIntensity:.325,scanlinesCount:256,grayscale:!1,glitchPassEnable:!1,halftonePassEnable:!1,pixelPassEnable:!1,pixelSize:16,blurPassEnable:!0,blurExposure:.02,showSky:!1,oceanEnable:!1,oceanVerticalOffset:1,fireflyEnable:!1,resourceBasePath:"",isManaged:!1};if(this.type===Scene$1.TYPE.GIS_3D&&(o.isManaged=!0),this.additionalInfo&&this.additionalInfo.resourceBasePath&&(o.resourceBasePath=this.additionalInfo.resourceBasePath),!this.options.container)return logger.warn(`模型加载出错。无效的容器名称（${this.options.container}）。`),void(t&&t(0));o.width=this.options.container.offsetWidth||window.innerWidth,o.height=this.options.container.offsetHeight||window.innerHeight,this.options.container.style.width=o.width+"px",this.options.container.style.height=o.height+"px",this.options.container.style.backgroundColor="#303f50",this.options.container.style.outline="0 none !important",this.options.container.style.blur="expression(this.onFocus=this.blur())";try{var r=new XMLHttpRequest,n=this;r.onreadystatechange=function(){if(4==r.readyState){if(200==r.status||304==r.status)try{let e=JSON.parse(r.responseText);if(e){logger.debug("已读取场景配置（可选）。");for(let t in e)o[t]=e[t]}}catch(e){logger.debug(`场景配置（可选）内容无效，已忽略：${e}`)}else logger.debug("未找到场景配置（可选），已忽略。");let a=[];if(o.models&&o.models.length>0)for(let e of o.models)e.name&&e.type&&(e.pathModel=`${n.url}/model/${e.name}.${e.type}`,"avwm"===e.type.toLowerCase()?e.pathConfig=`${n.url}/model/${e.name}.avwc`:e.pathConfig="",e.lastUpdated>-1&&(e.pathModel+=`^lastUpdated=${e.lastUpdated}`),a.push(e));if(0===a.length&&(a=[{name:"main",type:"avwm",lastUpdated:-1,offset:[0,0,0],rotation:[0,0,0],pathModel:`${n.url}/model/main.avwm`,pathConfig:`${n.url}/model/main.avmc`}]),_models=[],(_core=new avw.AVW.Core(e.container,o)).LoadModel(a[0].name,a[0].pathModel,o,(function(e,i){if(1===e){"boolean"!=typeof a[0].visible||a[0].visible||_core.hideModelByName(a[0].name);try{r.onreadystatechange=function(){if(4==r.readyState){if(200==r.status||204==r.status)try{let e=JSON.parse(r.responseText);if(e){if(logger.debug("已读取模型节点配置（可选）。"),e.nodeSettings&&e.nodeSettings.length&&e.nodeSettings.length>0)for(let t of e.nodeSettings)_core.setNodeParam(a[0].name,t);if(e.materialSettings&&e.materialSettings.length&&e.materialSettings.length>0)for(let t of e.materialSettings)_core.setMaterialParam(a[0].name,t);e.buildingIndex&&e.buildingIndex.length&&e.buildingIndex.length>0&&(n.options.buildingIndex=e.buildingIndex)}}catch(e){logger.debug(`模型节点配置（可选）内容无效，已忽略：${e}。`)}else logger.debug("未找到模型节点配置（可选），已忽略。");t&&t(1,"完成。")}},logger.debug(`寻找模型节点配置（可选）：“${a[0].pathConfig}”。`),r.open("GET",a[0].pathConfig,!0),r.send()}catch(e){logger.debug("未找到模型节点配置（可选），已忽略。")}}else t&&t(e,i)}),(function(e,t){logger.debug("onProgress",e,t)})),_models.push(new Model$1({name:a[0].name,src:a[0].pathModel})),a.length>1){logger.debug("读取到多个模型请求。",a);for(let e=1;e<a.length;e++)_core.LoadModel(a[e].name,a[e].pathModel,void 0,(function(t,r){1===t&&("boolean"!=typeof a[e].visible||a[e].visible||_core.hideModelByName(a[e].name),_models.push(new Model$1({name:a[e].name,src:a[e].pathModel})))}))}!n.options.accessToken&&(n.url.indexOf("sip")>=0||n.url.indexOf("ark")>=0&&n.url.indexOf("ou")>=0&&n.url.indexOf("uz")>=0)&&(_core.LoadModel("misc01",n.url+"/model/misc01.avwm"),_core.LoadModel("misc02",n.url+"/model/misc02.avwm"),_models.push(new Model$1({name:"misc01",src:n.url+"/model/misc01.avwm"})),_models.push(new Model$1({name:"misc02",src:n.url+"/model/misc01.avwm"}))),(n.url.indexOf("china")>=0||n.url.indexOf("black")>=0&&n.url.indexOf("blue")>=0)&&(_core.LoadModel("beijing",n.url+"/model/beijing.avwm"),_core.LoadModel("hebei",n.url+"/model/hebei.avwm"),_models.push(new Model$1({name:"beijing",src:n.url+"/model/beijing.avwm"})),_models.push(new Model$1({name:"hebei",src:n.url+"/model/hebei.avwm"})));var i={};if(n.options.center&&3===n.options.center.length?(i.lon=n.options.center[0],i.lat=n.options.center[1],i.alt=n.options.center[2],i.scaleX=1,i.scaleY=1,i.scaleZ=1):o.center&&3===o.center.length?(i.lon=o.center[0],i.lat=o.center[1],i.alt=o.center[2],i.scaleX=1,i.scaleY=1,i.scaleZ=1):(n.options.coordinateSystem=Scene$1.COORDINATE_SYSTEM.XYZ,logger.warn("未设置基准经纬度，将无法使用经度、纬度、海拔高度作为坐标。已自动将场景坐标系统设置为“XYZ（右手坐标系）”。")),n.options.view?n.view(n.options.view):n.options.camera&&n.setCamera(n.options.camera),o.lighting){let e=o.lighting;if(e.skyLight&&e.directLights&&e.directLights[0]&&(_core.setDefaultLight(e.skyLight,e.directLights[0]),e.directLights.length>1))for(let t=1;t<e.directLights.length;t++)_core.addDirLight(e.directLights[t])}}};var i=a;logger.debug(`寻找场景配置（可选）：${i}`),r.open("GET",i,!0),r.send()}catch(e){logger.debug("未找到场景配置（可选），已忽略。")}}catch(e){logger.warn(`模型加载出错。${e}`),_models=[],t&&t(0,`模型加载出错。${e}`)}}return this}leftButtonHandle(e){_core.leftButtonHandle(e)}name(e){return this.name=e,this}loadSceneConfig(e,t){}perfTest(e,t,r){e&&e.start&&e.phrases instanceof Array?(e.start&&this.setCamera(new Camera$1({target:new Position(e.positionType).set(e.start.target[0],e.start.target[1],e.start.target[2]),posture:e.start.posture,distance:e.start.distance})),this.perfTestFlyTo(e.phrases,0,e.positionType,t,r)):logger.warn("perfTest(testing) 参数错误。",e)}perfTestFlyTo(e,t,r,n,i){if(_isPerfTesting){var a=this;if(i&&i(t/e.length),t>=e.length){if(this.stopPerfLog(),n){let e=this.getLastPerfLog();n(e)}}else switch(e[t].type.toLowerCase()){case"flyto":this.flyTo({center:e[t].target,rph:e[t].posture,distance:e[t].distance},e[t].duration,0,0,(function(){a.perfTestFlyTo(e,++t,r,n,i)}));break;case"sleep":setTimeout((function(){a.perfTestFlyTo(e,++t,r,n,i)}),1e3*e[t].duration)}}}render(){_core.render()}setBackgroundTransparent(){_core.setBackgroundTransparent()}setDefaultBackgroundImage(){_core.setDefaultBackgroundImage()}setDefaultFog(){_core.setDefaultFog()}setDefaultSkyBox(){_core.setDefaultSkyBox()}setFog(e){}setMaterialParam(e,t){_core.setMaterialParam(e,t)}setNodeParam(e,t){_core.setNodeParam(e,t)}setOcean(e){_core.initOcean(e)}setSceneConfig(e){_core.setSceneConfig(e)}setSize(e,t){_core.changeSize(e,t)}setSky(e){_core.initSky(e)}setSkybox(e,t,r="#ffffff"){_core.setSkybox(e,t,r)}showFireFly(e){_core.showFireFly(e)}skybox(e){let t;switch(e){case Scene$1.SKYBOX.NIGHT:t={cubeTexturePassEnable:!0,cubeTextureFolderPath:"texture/cubemap/night/",cubeTexturePostFix:".png",cubeTexturePassOpacity:1,fogColor:"0x1f517b",showSky:!1};break;case Scene$1.SKYBOX.DUSK:t={cubeTexturePassEnable:!0,cubeTextureFolderPath:"texture/cubemap/dusk/",cubeTexturePostFix:".png",cubeTexturePassOpacity:1,fogColor:"0xbe6769",showSky:!1};break;case Scene$1.SKYBOX.DAY:t={cubeTexturePassEnable:!0,cubeTextureFolderPath:"texture/cubemap/day/",cubeTexturePostFix:".png",cubeTexturePassOpacity:1,fogColor:"0xa4dae6",showSky:!1};break;case Scene$1.SKYBOX.SIMPLE:default:t={cubeTexturePassEnable:!1,showSky:!0}}return _core.setSkyBox({skyboxPath:t.cubeTextureFolderPath,filetype:t.cubeTexturePostFix,enabled:!0}),_core.setFog({fogColor:Number(t.fogColor),fogAppearDist:0,fogDisAppearDist:1e3,enabled:!0}),this}spliceDrawable(e,t){this.getLayer(e)._drawables.map(((r,n)=>{r.name==t&&this.getLayer(e)._drawables.splice(n,1)}))}startPerfLog(){_isPerfTesting=!0,_core.startPerfLog()}stopPerfLog(){_isPerfTesting=!1,_core.stopPerfLog()}switch(e,t,r,n){this.destroy(),this.url=e.url||"",this.name=e.name||"",this.author=e.author||"",this.type=e.type||"",this.additionalInfo=e.additionalInfo||{},this.options=t||this.options,_layers=[],_models=[],_core={},_showStats=!1,this.init(t,(function(e){n(e)}))}toJson(){return JSON.stringify(_layers)}type(e){return this.type=e,this}updateFireFly(e,t){if(t.position&&"lla"===t.position.type.toLowerCase()){let e=_core.convertLLAToXYZ({x:t.position.lon,y:t.position.lat,z:t.position.alt});t.position.x=e.x,t.position.y=e.y,t.position.z=e.z}_core.updateFireFly(e,t)}url(e){return this.url=e,this}setSceneEffect(e){_core.setSceneEffect(e)}getIconAssetInfo(e){return _core.defaultObjectTree.children.find((t=>"IconAsset"==t.type&&t.name==e))}}Scene$1.TYPE={NATIVE:Symbol("NATIVE"),HW_PARK:Symbol("HW_PARK"),GIS_3D:Symbol("GIS_3D")},Scene$1.XYZ=Symbol("XYZ"),Scene$1.SURFACE=Symbol("SURFACE"),Scene$1.ECEF=Symbol("ECEF"),Scene$1.PLANAR_LOCAL=Symbol("PLANAR_LOCAL"),Scene$1.MERCATOR=Symbol("MERCATOR"),Scene$1.WGS84=Symbol("WGS84"),Scene$1.ANGLE_UNIT={DEGREE:Symbol("DEGREE"),RAD:Symbol("RAD")},Scene$1.TRANS_TYPE={LINEAR:Symbol("LINEAR"),SINE:Symbol("SINE"),CUBIC:Symbol("CUBIC")},Scene$1.EASE_TYPE={IN:Symbol("IN"),OUT:Symbol("OUT"),IN_OUT:Symbol("IN_OUT")},Scene$1.SKYBOX={DAY:Symbol("DAY"),DUSK:Symbol("DUSK"),NIGHT:Symbol("NIGHT")},Scene$1.MARKER_ACTION={FLASH_START:Symbol("FLASH_START"),FLASH_STOP:Symbol("FLASH_STOP")},window.logger={debug:function(){},info:function(){},warn:function(){},error:function(){},dir:function(){},time:function(){},timeEnd:function(){}},window.isDebug&&(window.logger={debug:console.debug.bind(window.console),info:console.info.bind(window.console),warn:console.warn.bind(window.console),error:console.error.bind(window.console),dir:console.dir.bind(window.console),time:console.time.bind(window.console),timeEnd:console.timeEnd.bind(window.console)}),logger.debug("avw.scene.js v2.2.0 (BUILD_20210730_1610), Copyright Digital Hail.");const scene$1=function(e,t){return new Scene$1(e,t)},debug=function(e){window.logger=e?{debug:console.debug.bind(window.console),info:console.info.bind(window.console),warn:console.warn.bind(window.console),error:console.error.bind(window.console),dir:console.dir.bind(window.console),time:console.time.bind(window.console),timeEnd:console.timeEnd.bind(window.console)}:{debug:function(){},info:function(){},warn:function(){},error:function(){},dir:function(){},time:function(){},timeEnd:function(){}}};class BaseComponent{constructor(){this.isComponent=!0,this.type="baseComponent",this.scene={},this.interfaceList=[]}setScene(e){this.scene=e}getInterface(){return this.interfaceList||[]}addEventListener(e,t){void 0===this._listeners&&(this._listeners={});const r=this._listeners;void 0===r[e]&&(r[e]=[]),-1===r[e].indexOf(t)&&r[e].push(t)}removeEventListener(e,t){if(void 0===this._listeners)return;const r=this._listeners[e];if(void 0!==r){const e=r.indexOf(t);-1!==e&&r.splice(e,1)}}dispatchEvent(e){if(void 0===this._listeners)return;const t=this._listeners[e.type];if(void 0!==t){e.target=this;const r=t.slice(0);for(let t=0,n=r.length;t<n;t++)r[t].call(this,e);e.target=null}}typeEquals(e){return this.type===e}deepCopy(e){return JSON.parse(JSON.stringify(e))}getMapLevelByResolution(){const e=this.scene.tgapp.container.scrollWidth,t=this.scene.tgapp.container.scrollHeight,r=this.scene.convertScreenToWorld({x:0,y:t/2}),n=this.scene.convertScreenToWorld({x:e,y:t/2}),i=(new Position).set(r.x,r.y,r.z),a=(new Position).set(n.x,n.y,n.z),o=this.scene.getDistanceByPositions(i,a)/e,s=(r.lat+n.lat)/2,l=156543.03*Math.cos(Math.PI/180*s)/o;return Math.floor(Math.log2(l))}getSceneRange(){const e=this.scene.tgapp.container.scrollWidth,t=this.scene.tgapp.container.scrollHeight,r=this.scene.convertScreenToWorld({x:0,y:0}),n=this.scene.convertScreenToWorld({x:0,y:t}),i=this.scene.convertScreenToWorld({x:e,y:0}),a=this.scene.convertScreenToWorld({x:e,y:t}),o=[r.lon,n.lon,i.lon,a.lon],s=[r.lat,n.lat,i.lat,a.lat],l=Math.min(...o),c=Math.max(...o);return[l,Math.min(...s),c,Math.max(...s)]}}class Resource extends BaseComponent{constructor(){super(),this.isResource=!0,this.type="Resource",this.resourcePath="/",this.resource={},this.resourceFileName="resource.json",this.areaType=["arrow01","gradient01","gradient02","gradient03","grid01","grid02","grid03","grid04","grid05","segment01","segment02","segment03"]}setResourcePath(e){return this.resourcePath=e,new Promise(((t,r)=>{let n=new XMLHttpRequest;n.onreadystatechange=()=>{4===n.readyState&&(200==n.status||204==n.status||304==n.status?(this.resource=JSON.parse(n.responseText),void 0!==this.resource.clusters&&this.resource.icons.push(...this.resource.clusters),t("已加载资源库配置。")):r("加载资源库配置错误。"))},n.open("GET",`${e}\\${this.resourceFileName}`,!0),n.send(null)}))}isContain_IconAsset(e){let t=this.scene.isContentAssets(e);return t||(e=e.toLowerCase(),t=-1!==this.resource.icons.findIndex((t=>t.name==e))),t}getIconAsset(e){return new Promise(((t,r)=>{if(this.scene.isContentAssets(e))return void t({useIconAsset:!0,iconAssetName:e.indexOf("custom-")>-1?e.replace("custom-",""):e});e=e.toLowerCase();let n=this.resource.icons.find((t=>t.name==e)),i=new XMLHttpRequest;i.onreadystatechange=()=>{if(4===i.readyState)if(200==i.status||204==i.status||304==i.status){let e=JSON.parse(i.responseText);e.icon=`${this.resourcePath}${n.path}`,e.useIconAsset=!1,t(e)}else logger.error(`图标样式资源 ${n.style} 读取失败，错误码:${i.status}`),r({})},i.open("GET",`${this.resourcePath}${n.style}`,!0),i.send(null)}))}getMarkerAsset(e){e=e.toLowerCase();let t=this.resource.markers.find((t=>t.name==e));if(t)return t=this.deepCopy(t),t.path=`${this.resourcePath}${t.path}`,t}isContain_AreaType(e){return e=e.toLowerCase(),-1!==this.areaType.indexOf(e)}getIconAssetInfo(e){return this.scene.getIconAssetInfo(e)}}const resource=new Resource;var shapefile$1={exports:{}};!function(e,t){!function(e){var t=function(){return this._array=null,Promise.resolve()},r=function(){var e=this._array;return this._array=null,Promise.resolve(e?{done:!1,value:e}:{done:!0,value:void 0})};function n(e){return new i(e instanceof Uint8Array?e:new Uint8Array(e))}function i(e){this._array=e}i.prototype.read=r,i.prototype.cancel=t;var a=function(e){return fetch(e).then((function(e){return e.body&&e.body.getReader?e.body.getReader():e.arrayBuffer().then(n)}))},o=function(e){return new Promise((function(t,r){var i=new XMLHttpRequest;i.responseType="arraybuffer",i.onload=function(){t(n(i.response))},i.onerror=r,i.ontimeout=r,i.open("GET",e,!0),i.send()}))};function s(e){return("function"==typeof fetch?a:o)(e)}function l(e){return"function"==typeof e.read?e:e.getReader()}var c=new Uint8Array(0),h=function(){return this._source.cancel()};function u(e,t){if(!e.length)return t;if(!t.length)return e;var r=new Uint8Array(e.length+t.length);return r.set(e),r.set(t,e.length),r}var d=function(){var e=this,t=e._array.subarray(e._index);return e._source.read().then((function(r){return e._array=c,e._index=0,r.done?t.length>0?{done:!1,value:t}:{done:!0,value:void 0}:{done:!1,value:u(t,r.value)}}))},p=function(e){if((e|=0)<0)throw new Error("invalid length");var t=this,r=this._array.length-this._index;if(this._index+e<=this._array.length)return Promise.resolve(this._array.subarray(this._index,this._index+=e));var n=new Uint8Array(e);return n.set(this._array.subarray(this._index)),function i(){return t._source.read().then((function(a){return a.done?(t._array=c,t._index=0,r>0?n.subarray(0,r):null):r+a.value.length>=e?(t._array=a.value,t._index=e-r,n.set(a.value.subarray(0,e-r),r),n):(n.set(a.value,r),r+=a.value.length,i())}))}()};function f(e){return"function"==typeof e.slice?e:new m("function"==typeof e.read?e:e.getReader())}function m(e){this._source=e,this._array=c,this._index=0}m.prototype.read=d,m.prototype.slice=p,m.prototype.cancel=h;var g=function(){return this._source.cancel()},y=function(e){return!(e=e.trim())||isNaN(e=+e)?null:e},v={B:y,C:function(e){return e.trim()||null},D:function(e){return new Date(+e.substring(0,4),e.substring(4,6)-1,+e.substring(6,8))},F:y,L:function(e){return!/^[nf]$/i.test(e)&&(!!/^[yt]$/i.test(e)||null)},M:y,N:y},b=function(){var e=this,t=1;return e._source.slice(e._recordLength).then((function(r){return r&&26!==r[0]?{done:!1,value:e._fields.reduce((function(n,i){return n[i.name]=v[i.type](e._decode(r.subarray(t,t+=i.length))),n}),{})}:{done:!0,value:void 0}}))},_=function(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)},x=function(e,t){return(e=f(e)).slice(32).then((function(r){var n=_(r);return e.slice(n.getUint16(8,!0)-32).then((function(r){return new w(e,t,n,_(r))}))}))};function w(e,t,r,n){this._source=e,this._decode=t.decode.bind(t),this._recordLength=r.getUint16(10,!0),this._fields=[];for(var i=0;13!==n.getUint8(i);i+=32){for(var a=0;a<11&&0!==n.getUint8(i+a);++a);this._fields.push({name:this._decode(new Uint8Array(n.buffer,n.byteOffset+i,a)),type:String.fromCharCode(n.getUint8(i+11)),length:n.getUint8(i+16)})}}var S=w.prototype;function M(){return this._source.cancel()}S.read=b,S.cancel=g;var T=function(e){var t,r=40,n=e.getInt32(36,!0),i=new Array(n);for(t=0;t<n;++t,r+=16)i[t]=[e.getFloat64(r,!0),e.getFloat64(r+8,!0)];return{type:"MultiPoint",coordinates:i}},A=function(e){return{type:"Point",coordinates:[e.getFloat64(4,!0),e.getFloat64(12,!0)]}},E=function(e){var t,r=44,n=e.getInt32(36,!0),i=e.getInt32(40,!0),a=new Array(n),o=new Array(i),s=[],l=[];for(t=0;t<n;++t,r+=4)a[t]=e.getInt32(r,!0);for(t=0;t<i;++t,r+=16)o[t]=[e.getFloat64(r,!0),e.getFloat64(r+8,!0)];return a.forEach((function(e,t){var r=o.slice(e,a[t+1]);C(r)?s.push([r]):l.push(r)})),l.forEach((function(e){s.some((function(t){if(L(t[0],e))return t.push(e),!0}))||s.push([e])})),1===s.length?{type:"Polygon",coordinates:s[0]}:{type:"MultiPolygon",coordinates:s}};function C(e){if((t=e.length)<4)return!1;for(var t,r=0,n=e[t-1][1]*e[0][0]-e[t-1][0]*e[0][1];++r<t;)n+=e[r-1][1]*e[r][0]-e[r-1][0]*e[r][1];return n>=0}function L(e,t){for(var r,n=-1,i=t.length;++n<i;)if(r=D(e,t[n]))return r>0;return!1}function D(e,t){for(var r=t[0],n=t[1],i=-1,a=0,o=e.length,s=o-1;a<o;s=a++){var l=e[a],c=l[0],h=l[1],u=e[s],d=u[0],p=u[1];if(R(l,u,t))return 0;h>n!=p>n&&r<(d-c)*(n-h)/(p-h)+c&&(i=-i)}return i}function R(e,t,r){var n=r[0]-e[0],i=r[1]-e[1];if(0===n&&0===i)return!0;var a=t[0]-e[0],o=t[1]-e[1];if(0===a&&0===o)return!1;var s=(n*a+i*o)/(a*a+o*o);return!(s<0||s>1)&&(0===s||1===s||s*a===n&&s*o===i)}var P=function(e){var t,r=44,n=e.getInt32(36,!0),i=e.getInt32(40,!0),a=new Array(n),o=new Array(i);for(t=0;t<n;++t,r+=4)a[t]=e.getInt32(r,!0);for(t=0;t<i;++t,r+=16)o[t]=[e.getFloat64(r,!0),e.getFloat64(r+8,!0)];return 1===n?{type:"LineString",coordinates:o}:{type:"MultiLineString",coordinates:a.map((function(e,t){return o.slice(e,a[t+1])}))}},O=function(e,t){var r=new Uint8Array(e.length+t.length);return r.set(e,0),r.set(t,e.length),r},I=function(){var e=this;return++e._index,e._source.slice(12).then((function(t){if(null==t)return{done:!0,value:void 0};var r=_(t);function n(){return e._source.slice(4).then((function(a){return null==a?{done:!0,value:void 0}:(r=_(t=O(t.slice(4),a))).getInt32(0,!1)!==e._index?n():i()}))}function i(){var i=2*r.getInt32(4,!1)-4,a=r.getInt32(8,!0);return i<0||a&&a!==e._type?n():e._source.slice(i).then((function(r){return{done:!1,value:a?e._parse(_(O(t.slice(8),r))):null}}))}return i()}))},k={0:function(){return null},1:A,3:P,5:E,8:T,11:A,13:P,15:E,18:T,21:A,23:P,25:E,28:T},B=function(e){return(e=f(e)).slice(100).then((function(t){return new N(e,_(t))}))};function N(e,t){var r=t.getInt32(32,!0);if(!(r in k))throw new Error("unsupported shape type: "+r);this._source=e,this._type=r,this._index=0,this._parse=k[r],this.bbox=[t.getFloat64(36,!0),t.getFloat64(44,!0),t.getFloat64(52,!0),t.getFloat64(60,!0)]}var F=N.prototype;function U(){}F.read=I,F.cancel=M;var z=function(){return Promise.all([this._dbf&&this._dbf.cancel(),this._shp.cancel()]).then(U)},H=function(){var e=this;return Promise.all([e._dbf?e._dbf.read():{value:{}},e._shp.read()]).then((function(e){var t=e[0],r=e[1];return r.done?r:{done:!1,value:{type:"Feature",properties:t.value,geometry:r.value}}}))},G=function(e,t,r){return Promise.all([B(e),t&&x(t,r)]).then((function(e){return new V(e[0],e[1])}))};function V(e,t){this._shp=e,this._dbf=t,this.bbox=e.bbox}var j=V.prototype;function W(e,t,r){return"string"==typeof t?(/\.dbf$/.test(t)||(t+=".dbf"),t=s(t)):t instanceof ArrayBuffer||t instanceof Uint8Array?t=n(t):null!=t&&(t=l(t)),"string"==typeof e?(/\.shp$/.test(e)||(e+=".shp"),void 0===t&&(t=s(e.substring(0,e.length-4)+".dbf").catch((function(){}))),e=s(e)):e=e instanceof ArrayBuffer||e instanceof Uint8Array?n(e):l(e),Promise.all([e,t]).then((function(e){var t=e[0],n=e[1],i="windows-1252";return r&&null!=r.encoding&&(i=r.encoding),G(t,n,n&&new TextDecoder(i))}))}function Y(e,t){return"string"==typeof e?(/\.shp$/.test(e)||(e+=".shp"),e=s(e)):e=e instanceof ArrayBuffer||e instanceof Uint8Array?n(e):l(e),Promise.resolve(e).then(B)}function X(e,t){var r="windows-1252";return t&&null!=t.encoding&&(r=t.encoding),r=new TextDecoder(r),"string"==typeof e?(/\.dbf$/.test(e)||(e+=".dbf"),e=s(e)):e=e instanceof ArrayBuffer||e instanceof Uint8Array?n(e):l(e),Promise.resolve(e).then((function(e){return x(e,r)}))}function $(e,t,r){return W(e,t,r).then((function(e){var t=[],r={type:"FeatureCollection",features:t,bbox:e.bbox};return e.read().then((function n(i){return i.done?r:(t.push(i.value),e.read().then(n))}))}))}j.read=H,j.cancel=z,e.open=W,e.openShp=Y,e.openDbf=X,e.read=$,Object.defineProperty(e,"__esModule",{value:!0})}(t)}(0,shapefile$1.exports);var shapefile=getDefaultExportFromCjs(shapefile$1.exports);class Layer{constructor(e,t={},r=[]){this.isLayer=!0,this.id=e||(new Date).toLocaleString({hour12:!1}),this.source=JSON.parse(JSON.stringify(t)),this.data=r,this.isShow=null==t.visible||t.visible,this.allowClickSelected=!1,this.allowHoverSelected=!1}getData(e){return this.data.find((t=>t.id==e))}addData(e){this.getData(e.id)?logger.warn(`TGApp.Layer: 已经存在数据对象 ${e.id}。`):this.data.push(e)}getPositions(){let e=[];for(const t of this.data)e.push(...t.getPositions());return e}getPositionsByDataId(e){let t=[],r=this.getData(e);return r&&t.push(...r.getPositions()),t}getPositionsByLegend(e){let t=[];for(const r of this.data)r.legendEquals(e)&&t.push(...r.getPositions());return t}}class Data{constructor(e,t={}){this.isData=!0,this.id=e||(new Date).toLocaleString({hour12:!1}),this.positions=[],this.source=JSON.parse(JSON.stringify(t)),this.parent=null,this.legend=void 0,this.area=void 0,this.segment=void 0,this.isSelected=!1}setSource(e){this.source=JSON.parse(JSON.stringify(e))}getPositions(){return this.positions||[]}legendEquals(e){return this.legend===e}}class BaseOverlay extends BaseComponent{constructor(){super(),this.isOverlay=!0,this.type="baseOverlay",this.layers=[],this.allowClickSelected=!1,this.allowHoverSelected=!1,this.isShowDecorator=!0;let e=Object.getOwnPropertyNames(resource.__proto__);for(const t of e)"constructor"!=t&&(this[t]=resource[t].bind(resource))}setScene(e){super.setScene(e),this.layers=[],this.scene.on("click","drawable",this.onDrawableMouseClick),this.scene.addEventListener("transformControls","translate",(e=>this._onDrawableTranslate(e))),this.scene.addEventListener("transformControls","mouseDown",(e=>this._onDrawableTransformStart(e))),this.scene.addEventListener("transformControls","mouseUp",(e=>this._onDrawableTransformEnd(e)));const t=this.scene.tgapp.events;for(const e in t){t[e].length>0&&this.addSceneEventListener(e)}}getLayers(){return this.layers||[]}getLayer(e){return this.layers.find((t=>t.id==e))}getLayerByDataId(e){for(let t of this.layers){if(t.getData(e))return t}}addLayer(e){this.getLayer(e.id)?logger.warn(`TGApp.Overlay: 已经存在图层 ${e.id}。`):this.layers.push(e)}createLayer(e,t={},r=[]){let n=new Layer(e,t,r);return n.allowClickSelected=this.allowClickSelected,n.allowHoverSelected=this.allowHoverSelected,this.addLayer(n),n}createData(e,t,r){let n=new Data(e,t);return r&&(r.addData(n),n.parent=r),n}showLayer(e){let t=this.getLayer(e);return!!t&&(t.isShow=!0,this.scene.showLayer(e),this.dispatchEvent({type:"showLayer",layerIds:[e]}),!0)}hideLayer(e){let t=this.getLayer(e);return!!t&&(t.isShow=!1,this.scene.hideLayer(e),this.dispatchEvent({type:"hideLayer",layerIds:[e]}),!0)}showAllLayer(){let e=[];for(const t of this.layers)!0!==t.isPlot&&(t.isShow=!0,this.scene.showLayer(t.id),e.push(t.id));return this.dispatchEvent({type:"showLayer",layerIds:e}),!0}hideAllLayer(){let e=[];for(const t of this.layers)!0!==t.isPlot&&(t.isShow=!1,this.scene.hideLayer(t.id),e.push(t.id));return this.dispatchEvent({type:"hideLayer",layerIds:e}),!0}removeLayer(e){let t=this.layers.findIndex((t=>t.id==e));return-1!=t&&(this.layers.splice(t,1),this.scene.removeLayer(e),this.dispatchEvent({type:"removeLayer",layerIds:[e]}),!0)}removeAllLayer(){if(this.layers.length<=0)return!1;let e=[];for(let t=this.layers.length-1;t>=0;t--){const r=this.layers[t];!0!==r.isPlot&&(this.scene.removeLayer(r.id),e.push(r.id),this.layers.splice(t,1))}return this.dispatchEvent({type:"removeLayer",layerIds:e}),!0}openMouseSelection(e,t,r){void 0!==r&&(this.isShowDecorator=!!r);let n=void 0===e;n&&("click"===t&&(this.allowClickSelected=!0),"hover"===t&&(this.allowHoverSelected=!0));let i=[];if(n)i=this.getLayers();else{let t=this.getLayer(e);t&&i.push(t)}for(const e of i)"click"===t&&(e.allowClickSelected=!0),"hover"===t&&(e.allowHoverSelected=!0);this.selectionData()}closeMouseSelection(e,t){let r=void 0===e;r&&("click"===t&&(this.allowClickSelected=!1),"hover"===t&&(this.allowHoverSelected=!1),void 0===t&&(this.allowClickSelected=!1,this.allowHoverSelected=!1));let n=[];if(r)n=this.getLayers();else{let t=this.getLayer(e);t&&n.push(t)}for(const e of n){"click"===t&&(e.allowClickSelected=!1),"hover"===t&&(e.allowHoverSelected=!1),void 0===t&&(e.allowClickSelected=!1,e.allowHoverSelected=!1);for(const t of e.data)t.isSelected=!1}this.selectionData()}selectionData(e,t){if(void 0!==e&&e.length>0){e=e.map((e=>({dataId:e.id,layerId:e.parent.id})));for(const e of this.getLayers())for(const t of e.data)t.isSelected=!1,this.scene.deselectLandmark(e.id,t.id);for(const e of this.getLayers())for(const t of e.data)t.isSelected=!1,this.scene.deselectLandmark(e.id,t.id);for(const r of e){this.getLayer(r.layerId).getData(r.dataId).isSelected=t}}for(const e of this.getLayers())for(const t of e.data)t.isSelected&&this.isShowDecorator?this.scene.selectLandmark(e.id,t.id):this.scene.deselectLandmark(e.id,t.id)}onMouseSelection(e,t){let r=!1;"click"===e&&t.parent.allowClickSelected&&(this.selectionData([t],!t.isSelected),r=!0),"hover"===e&&t.parent.allowHoverSelected&&(this.selectionData([t],!0),r=!0),"unhover"===e&&t.parent.allowHoverSelected&&(this.selectionData([t],!1),r=!0),r&&t.parent.allowClickSelected&&this.scene.tgapp.triggerEvent.onClickOverlayResult({type:this.type,id:t.id,selected:t.isSelected})}addSceneEventListener(){}removeSceneEventListener(){}_onDrawableMouseEvent(e,t,r,n){if(!r)return;let i,a=this.layers.find((e=>e.id==r.parent));a&&(i=n?a.data.find((e=>e.id==n)):a.data.find((e=>e.id==r.name)),i&&(this.onMouseSelection(e,i),this.onMouseEvent({type:e,layer:a,data:i,event:t,obj:r})))}onDrawableMouseClick=this._onDrawableMouseEvent.bind(this,"click");onDrawableMouseHover=this._onDrawableMouseEvent.bind(this,"hover");onDrawableUnmouseHover=this._onDrawableMouseEvent.bind(this,"unhover");_onDrawableTransformStart({target:e}){const t=e.object,r=t.name.split("/")[0],n=t.name.split("/")[1],i=this.getLayer(r);if(!i)return;const a=i.getData(n);a&&"translate"===e.mode&&this.scene.tgapp.triggerEvent.onTransformAxisDragStart({idObj:a.id,idLayer:i.id,overlayType:this.type})}_onDrawableTransformEnd({target:e}){const t=e.object,r=t.name.split("/")[0],n=t.name.split("/")[1],i=this.getLayer(r);if(!i)return;const a=i.getData(n);a&&"translate"===e.mode&&this.onTranslateDragEndEvent({target:e,object:t,layer:i,data:a})}_onDrawableTranslate({target:e}){const t=e.object,r=t.name.split("/")[0],n=t.name.split("/")[1],i=this.getLayer(r);if(!i)return;const a=i.getData(n);a&&"translate"===e.mode&&this.onTransformAxisDrag({target:e,object:t,layer:i,data:a})}onTranslateDragEndEvent({object:e,layer:t,data:r}={}){const n=e.position,i={idObj:r.id,idLayer:t.id,overlayType:this.type};if(0===t.source.coordType){const e=this.scene.convertXYZToLLA({x:n.x,y:n.y,z:n.z});i.coordType=0,i.data=[{coord:[e.x,e.y],coordZ:e.z}]}else i.coordType=t.source.coordType,i.data=[{coord:[n.x,n.y],coordZ:n.z}];this.scene.tgapp.triggerEvent.onTransformAxisDragEnd(i)}onTransformAxisDrag({object:e,layer:t,data:r}={}){const n=e.position,i={idObj:r.id,idLayer:t.id,overlayType:this.type};if(0===t.source.coordType){const e=this.scene.convertXYZToLLA({x:n.x,y:n.y,z:n.z});i.coordType=0,i.data=[{coord:[e.x,e.y],coordZ:e.z}]}else i.coordType=t.source.coordType,i.data=[{coord:[n.x,n.y],coordZ:n.z}];this.scene.tgapp.triggerEvent.onTransformAxisDrag(i)}onMouseEvent({}={}){}onFocusEvent({}={}){}}class Path extends BaseOverlay{constructor(){super(),this.type="path",this.interfaceList=["addPath","updatePathCoord","updatePathStyle","addPathShp","setPathPass"]}addPath({id:e,points:t,pass:r,isPlot:n}={},i){if(this.getLayer(e))return void(i&&i({result:0,message:`失败，已存在 ${e} 路径。`}));let a=this.deepCopy(arguments[0]);a.data=[{id:e,points:t}],null==r&&(a.pass=0);let o=this._convertLayer(a);this._drawLayer(o,i),void 0!==n&&(o.isPlot=!0),this.dispatchEvent({type:"addPath",layer:o})}updatePathCoord({id:e,points:t}={},r){if(!this.getLayer(e))return void(r&&r({result:0,message:`失败，未找到 ${e} 路径。`}));let n=this.deepCopy(arguments[0]);n.data=[{id:e,points:t}];let i=this._convertLayer(n);this._drawLayer(i,r),this.dispatchEvent({type:"updatePathCoord",layer:i,setPathPass:this.setPathPass})}updatePathStyle({id:e}={},t){if(!this.getLayer(e))return void(t&&t({result:0,message:`失败，未找到 ${e} 路径。`}));let r=this.deepCopy(arguments[0]),n=this._convertLayer(r);this._drawLayer(n,t),this.dispatchEvent({type:"updatePathStyle",layer:n})}setPathPass({id:e,pass:t,ratio:r=1},n){let i=path,a=i.getLayer(e);if(!a)return void(n&&n({result:0,message:`失败，未找到 ${e} 路径。`}));let o=a.getData(e);if(!o)return void(n&&n({result:0,message:`失败，未找到 ${e} 路径。`}));if(!o.inView)return void(n&&n({result:0,message:`失败，${e} 路径未绘制。`}));let s=a.getPositions(),l=s.length;if(t>=l||t<0)return;let c=0,h=0;for(let e=0;e<l-1;e++){let r=s[e],n=s[e+1],a=i.scene.getDistanceByPositions(r,n);c+=a,t>=e+1&&(h+=a)}h+=i.scene.getDistanceByPositions(s[t],s[t+1])*r,t=h/c,i.scene.updatePathPass(a.id,o.id,{pass:t})}async addPathShp({id:e,shpPath:t,coordZ:r}={},n){if(this.getLayer(e))return void(n&&n({result:0,message:`失败，已存在 ${e} 路径。`}));let i=this.deepCopy(arguments[0]);i.data=[],await shapefile.open(t).then((t=>t.read().then((async function n(a){if(a.done)return;let o={id:e+"-"+i.data.length,points:[]};for(const e of a.value.geometry.coordinates)!e||e.length<2||o.points.push({coord:e,coordZ:r});return i.data.push(o),await t.read().then(n)})))).catch((e=>logger.error(e.stack)));let a=this._convertLayer(i);this._drawLayer(a,n),this.dispatchEvent({type:"addPathShp",layer:a})}_convertLayer({id:e,name:t,coordType:r,coordTypeZ:n,type:i,color:a,pass:o,colorPass:s,width:l,isAppend:c=!0,data:h=[]}={}){let u=this.getLayer(e);u||(u=this.createLayer(e,arguments[0]),u.source.data=[]),c||(u.source.data=[],u.data.forEach((e=>this.scene.removeDrawable(u.id,e.id))),u.data=[]),null!=t&&(u.source.name=t),null!=r&&(u.source.coordType=r),null!=n&&(u.source.coordTypeZ=n),null!=i&&(u.source.type=i),null!=a&&(u.source.color=a),null!=s&&(u.source.colorPass=s),null!=l&&(u.source.width=l),null!=o&&(u.source.pass=o);for(const e of h){if(null==e.id)continue;e.coordType=u.source.coordType;let t=u.source.data.findIndex((t=>t.id===e.id));-1==t?u.source.data.push(e):u.source.data[t].points.push(...e.points)}for(const e of u.source.data){let t=u.getData(e.id);t||(t=this.createData(e.id,e,u));let r=0==e.coordType?"lla":"xyz",n=e.points.map((e=>new Position(r).set(e.coord[0],e.coord[1],e.coordZ)));t.positions=n,t.color=u.source.color,t.colorPass=u.source.colorPass,t.type=u.source.type,t.width=u.source.width,t.pass=u.source.pass}return u}async _drawLayer(e,t){if(this.scene){for(const t of e.data){let r={};r.name=t.id,r.points=t.positions,r.color=t.color,r.colorPass=t.colorPass,r.pass=t.pass,r.pathType=t.type,r.width=t.width,r.isShow=e.isShow,t.inView?await this.scene.updatePath(e.id,t.id,r):(await this.scene.addPath(e.id,r),t.inView=!0)}t&&t({result:1,message:"成功。"})}}addSceneEventListener(e){"onPathHover"!==e&&"onPathUnhover"!==e||this.scene.tgapp.events[e].length<=0||this.scene.tgapp.events[e].length>1||("onPathHover"===e&&this.scene.on("mousehover","drawable",this.onDrawableMouseHover),"onPathUnhover"===e&&this.scene.on("unmousehover","drawable",this.onDrawableUnmouseHover))}removeSceneEventListener(e){"onPathHover"!==e&&"onPathUnhover"!==e||this.scene.tgapp.events[e].length>0||("onPathHover"===e&&this.scene.off("mousehover","drawable",this.onDrawableMouseHover),"onPathUnhover"===e&&this.scene.off("unmousehover","drawable",this.onDrawableUnmouseHover))}onTranslateDragEndEvent({object:e,layer:t,data:r}={}){const n=e.position,i=e.userData.center,a={idObj:r.id,idLayer:t.id,overlayType:this.type,data:[]},o=n.x-i.x,s=n.y-i.y,l=n.z-i.z;if(0===t.source.coordType){a.coordType=0;for(const e of r.positions){let t=e.x+o,r=e.y+s,n=e.z+l;if("lla"===e.type){const i=this.scene.convertLLAToXYZ(e);t=i.x+o,r=i.y+s,n=i.z+l}const i=this.scene.convertXYZToLLA({x:t,y:r,z:n});a.data.push({coord:[i.x,i.y],coordZ:i.z})}}else{a.coordType=t.source.coordType;let e=position.x+o,r=position.y+s,n=position.z+l;a.data.push({coord:[e,r],coordZ:n})}this.scene.tgapp.triggerEvent.onTransformAxisDragEnd(a)}onTransformAxisDrag({object:e,layer:t,data:r}={}){const n=e.position,i=e.userData.center,a={idObj:r.id,idLayer:t.id,overlayType:this.type,data:[]},o=n.x-i.x,s=n.y-i.y,l=n.z-i.z;if(0===t.source.coordType){a.coordType=0;for(const e of r.positions){let t=e.x+o,r=e.y+s,n=e.z+l;if("lla"===e.type){const i=this.scene.convertLLAToXYZ(e);t=i.x+o,r=i.y+s,n=i.z+l}const i=this.scene.convertXYZToLLA({x:t,y:r,z:n});a.data.push({coord:[i.x,i.y],coordZ:i.z})}}else{a.coordType=t.source.coordType;let e=position.x+o,r=position.y+s,n=position.z+l;a.data.push({coord:[e,r],coordZ:n})}this.scene.tgapp.triggerEvent.onTransformAxisDrag(a)}onMouseEvent({type:e,layer:t,data:r,event:n}={}){"click"==e&&r.parent.allowClickSelected?this.scene.tgapp.triggerEvent.onPathClick({id:r.id,selected:r.isSelected,coord:[n.longitude,n.latitude],label:r.label,type:r.source.type}):"hover"!=e?"unhover"!=e||this.scene.tgapp.triggerEvent.onPathUnhover({id:r.id}):this.scene.tgapp.triggerEvent.onPathHover({id:r.id,coord:[n.longitude,n.latitude]})}onFocusEvent({type:e,layerId:t}={}){"focusStart"!==e?"focusEnd"!==e?"focusAllStart"!==e?"focusAllEnd"!==e||this.scene.tgapp.triggerEvent.onFocusAllPathEnd({}):this.scene.tgapp.triggerEvent.onFocusAllPathStart({}):this.scene.tgapp.triggerEvent.onFocusPathEnd({id:t}):this.scene.tgapp.triggerEvent.onFocusPathStart({id:t})}}const path=new Path;class Camera extends BaseComponent{constructor(){super(),this.type="Camera",this.interfaceList=["setCamera","getCameraInfo","rotateCamera","restrictCamera","setCameraRestrictionState","pathingCamera","setCameraPathingState","roamingCamera","setCameraRoamingState"],this.cameraState="free",this.roamingParams={},this.pathingParams={},this.restrict={limitPitch:[0,180],limitYaw:[-1/0,1/0],limitDistance:[0,999999],state:"restricted"}}setScene(e){super.setScene(e),this.cameraState="free",this.scene.on("cameramove","",Util.throttle((()=>{if(this.scene.tgapp.triggerEvent.onCameraMove){let e=this.scene.getView(),t=(e.rph[2]+360)%360,r={coordType:0,coordTypeZ:0,centerCoord:[Math.round(1e7*e.center[0])/1e7,Math.round(1e7*e.center[1])/1e7],coordZ:Math.round(100*e.center[2])/100,distance:Math.round(100*e.distance)/100,pitch:-Math.round(100*e.rph[1])/100,heading:Math.round(100*t)/100};this.scene.tgapp.triggerEvent.onCameraMove(r)}}),500))}setCamera({duration:e,coordType:t,centerCoord:r,coordZ:n,pitch:i,heading:a,distance:o,fly:s}={},l){let c=[];if(e<=0&&c.push("duration"),(i<1||i>89)&&c.push("pitch"),(a<0||a>359)&&c.push("heading"),c.length>0)return void(l&&l({result:0,message:`错误，属性：${c.join("、")} 值错误`}));this.scene.getCameraAutoRotate()&&(this.scene.interruptCameraFly(),this.cameraState="free");let h=new Camera$1({target:new Position(0==t?"lla":"xyz").set(r[0],r[1],n),posture:[0,-i,360-a],distance:o});this.cameraState="flying",this.scene.setCamera(h,s?e:0,(()=>this.cameraState="free")),l&&l({result:1,message:"成功。"})}getCameraInfo({},e){let t=this.scene.getView(),r=(t.rph[2]+360)%360,n={coordType:0,coordTypeZ:0,centerCoord:[Math.round(1e7*t.center[0])/1e7,Math.round(1e7*t.center[1])/1e7],coordZ:Math.round(100*t.center[2])/100,distance:Math.round(100*t.distance)/100,pitch:-Math.round(100*t.rph[1])/100,heading:360-Math.round(100*r)/100,status:this.cameraState};e&&e({result:1,message:"成功。",...n})}rotateCamera({duration:e,direction:t,enabled:r,interruptable:n},i){if(e<=0)return void(i&&i({result:0,message:"失败，飞行时间无效。"}));this.scene.interruptCameraFly(),this.cameraState="orbiting";let a=60/Math.abs(e);"counterclockwise"==t&&(a=-a),this.scene.setAutoRotate(r,a,n),i&&i({result:1,message:"成功。"})}restrictCamera(e,t){let r=0==(e=JSON.parse(JSON.stringify(e))).coordType?"lla":"xyz";e.center=new Position(r),e.center.set(e.center[0],e.center[1],0);let n=this.restrict.state;this.restrict=e,this.restrict.state=n,"free"!==e.state&&this.scene.restrictCamera(this.restrict,t)}setCameraRestrictionState(e,t){this.restrict.state=e.state,"free"==e.state?this.scene.restrictCamera(void 0,t):this.scene.restrictCamera(this.restrict,t)}roamingCamera(e,t){this.roamingParams=JSON.parse(JSON.stringify(e)),this.roamingParams.loopMode=this.roamingParams.loopMode.toLowerCase(),this.roamingParams.index=0;let r=this.roamingParams.points,n=0==this.roamingParams.coordType?"lla":"xyz";for(const e of r)e.target=new Position(n),e.target.set(e.coord[0],e.coord[1],e.coordZ);this.cameraState="roaming",this.scene.tgapp.triggerEvent.onCameraRoamingStart({});let i=JSON.parse(JSON.stringify(r[this.roamingParams.index]));i.speed=0,this._cameraRoamingFly(i,this._roamingTraverse),t&&t({result:1,message:"成功。"})}setCameraRoamingState({state:e="stop"}={},t){"roaming"==this.cameraState?("stop"==e.toLowerCase()&&(this.scene.interruptCameraFly(),this.roamingParams={},this.cameraState="free",this.scene.tgapp.triggerEvent.onCameraRoamingEnd({})),"pause"==e.toLowerCase()&&this.scene.interruptCameraFly(),"continue"==e.toLowerCase()&&null!=this.roamingParams.index&&(this.roamingParams.index>0&&this.roamingParams.index--,this._roamingTraverse()),t&&t({result:1,message:"成功。"})):t&&t({result:0,message:"失败，摄像机没有处于漫游状态。"})}_roamingTraverse(){if(null==this.roamingParams.index)return;this.roamingParams.index++;let e=this.roamingParams.points,t=this.roamingParams.index,r=this.roamingParams.loopMode;if("none"!=r){if("round"==r)return t>=e.length&&(this.roamingParams.points=e.reverse(),this.roamingParams.index=1,t=1),void this._cameraRoamingFly(e[t],this._roamingTraverse);if("repeat"!=r);else if(t>=e.length){this.roamingParams.index=0;let t=JSON.parse(JSON.stringify(e[0]));t.speed=0,this._cameraRoamingFly(t,this._roamingTraverse)}else this._cameraRoamingFly(e[t],this._roamingTraverse)}else t>=e.length?(this.roamingParams={},this.cameraState="free",this.scene.tgapp.triggerEvent.onCameraRoamingEnd({})):this._cameraRoamingFly(e[t],this._roamingTraverse)}_cameraRoamingFly({target:e,pitch:t,yaw:r,distance:n,speed:i}={},a){if(0!=i){let t=this.scene.getCameraDetailed(),r=(new Position).set(t.positionX,t.positionY,t.positionZ);i=this.scene.getDistanceByPositions(r,e)/i}a=a.bind(this),this.scene.setCamera({target:e,posture:[0,-t,r],distance:n},i,(({isInterrupt:e}={})=>{e||setTimeout(a,5)}))}pathingCamera(e,t){if(this.pathingParams=this.deepCopy(e),this.pathingParams.index=0,this.pathingParams.positions=[],!this._readPathData())return t&&t({result:0,message:`失败，不存在 ${this.pathingParams.pathId} 路径点。`}),void(this.pathingParams={});path.removeEventListener("updatePathCoord",this._onUpdatePathCoord),path.addEventListener("updatePathCoord",this._onUpdatePathCoord),path.removeEventListener("removeLayer",this._onRemovePath),path.addEventListener("removeLayer",this._onRemovePath),this.cameraState="pathing",this.scene.tgapp.triggerEvent.onCameraToMoveStart({}),this._cameraPathingFly(this._pathingTraverse,0),t&&t({result:1,message:"成功。"})}_onUpdatePathCoord({layer:e}){let t=camera;e.id===t.pathingParams.pathId&&(t.scene.interruptCameraFly(),t.pathingCamera(t.pathingParams))}_onRemovePath({layerIds:e}){let t=camera;e.find((e=>e===t.pathingParams.pathId))&&(t.scene.interruptCameraFly(),t.pathingParams={},t.cameraState="free",t.scene.tgapp.triggerEvent.onCameraToMoveEnd({}))}setCameraPathingState({state:e="stop"}={},t){"pathing"==this.cameraState?("stop"==e.toLowerCase()&&(this.scene.interruptCameraFly(),this.pathingParams={},this.cameraState="free",this.scene.tgapp.triggerEvent.onCameraToMoveEnd({})),"pause"==e.toLowerCase()&&this.scene.interruptCameraFly(),"continue"==e.toLowerCase()&&null!=this.pathingParams.index&&(this.pathingParams.index>0&&this.pathingParams.index--,this._pathingTraverse()),t&&t({result:1,message:"成功。"})):t&&t({result:0,message:"失败，摄像机没有处于路径移动状态。"})}_readPathData(){let e=path.getLayer(this.pathingParams.pathId);return!!e&&(this.pathingParams.positions=e.getPositions(),!(this.pathingParams.positions<=0)&&(this.pathingParams.reverse&&(this.pathingParams.positions=this.pathingParams.positions.reverse()),!0))}_pathingTraverse(){if(null==this.pathingParams.index)return;this.pathingParams.index++;let e=this.pathingParams.positions,t=this.pathingParams.index,r=this.pathingParams.loopMode;if("none"!=r)return"round"==r?(t>=e.length&&(this.pathingParams.positions=e.reverse(),this.pathingParams.index=1),void this._cameraPathingFly(this._pathingTraverse)):void("repeat"!=r||(t>=e.length?(this.pathingParams.index=0,this._cameraPathingFly(this._pathingTraverse,0)):this._cameraPathingFly(this._pathingTraverse)));t>=e.length?(this.pathingParams={},this.cameraState="free",this.scene.tgapp.triggerEvent.onCameraToMoveEnd({})):this._cameraPathingFly(this._pathingTraverse)}_cameraPathingFly(e,t){let r=this.pathingParams.positions[this.pathingParams.index],n=this.pathingParams.pitch,i=this.pathingParams.distance;if("lla"==r.type){let e=this.scene.convertLLAToXYZ(r);r.x=e.x,r.y=e.y,r.z=e.z}let a=this.scene.getCameraDetailed(),o=180*Math.atan2(a.targetX-r.x,a.targetZ-r.z)/Math.PI,s=(new Position).set(a.targetX,a.targetY,a.targetZ),l=this.scene.getDistanceByPositions(s,r);null==t&&(t=this.pathingParams.speed),0!=t&&(t=l/t),e=e.bind(this);let c=()=>{this.scene.setCamera({target:r,posture:[0,-n,o],distance:i},t,(({isInterrupt:t}={})=>{t||setTimeout(e,5)}))};this.scene.setCamera({target:s,posture:[0,-n,o],distance:a.viewDistance},.2,(({isInterrupt:e}={})=>{e||setTimeout(c,5)}))}}const camera=new Camera;class Landmark extends BaseOverlay{constructor(){super(),this.type="landmark",this.interfaceList=["addLandmark","updateLandmarkCoord","updateLandmarkStyle","getLandmarkScreenPosition"]}addLandmark({id:e,iconName:t,coord:r,coordZ:n,isPlot:i}={},a){if(!this.isContain_IconAsset(t))return void(a&&a({result:0,message:`失败，不存在 ${t} 图标资源。`}));if(this.getLayer(e))return void(a&&a({result:0,message:`失败，已存在 ${e} 地标点。`}));let o=this.deepCopy(arguments[0]);o.data=[{id:e,coord:r,coordZ:n}];let s=this._convertLayer(o);void 0!==i&&(s.isPlot=!0),this._drawLayer(s,a)}updateLandmarkCoord({id:e,coord:t,coordZ:r}={},n){if(!this.getLayer(e))return void(n&&n({result:0,message:`失败，未找到 ${e} 地标点。`}));let i=this.deepCopy(arguments[0]);i.data=[{id:e,coord:t,coordZ:r}];let a=this._convertLayer(i);this._drawLayer(a,n)}updateLandmarkStyle({id:e,iconName:t}={},r){if(!this.isContain_IconAsset(t))return void(r&&r({result:0,message:`失败，不存在 ${t} 图标资源。`}));if(!this.getLayer(e))return void(r&&r({result:0,message:`失败，未找到 ${e} 地标点。`}));let n=this.deepCopy(arguments[0]),i=this._convertLayer(n);this._drawLayer(i,r)}getLandmarkScreenPosition({id:e},t){if(!this.getLayer(e))return void(t&&t({result:0,message:`失败，未找到 ${e} 地标点。`}));let r=this.scene.getDrawable(e,e);if(!r)return void(t&&t({result:0,message:`失败，未找到 ${e} 地标点。`}));let n=this.scene.convertWorldToScreen(r.position),i=[n.x/this.scene.tgapp.container.scrollWidth,n.y/this.scene.tgapp.container.scrollHeight],a=[n.x,n.y];t&&t({result:1,message:"成功。",id:e,ndc:i,screenPosition:a})}_convertLayer({id:e}={}){let t=this.getLayer(e);return t||(t=this.createLayer(e,arguments[0])),this._updateLayer(t,arguments[0]),this._updateData(t),t}_updateLayer(e,{coordType:t,coordTypeZ:r,iconName:n,label:i,data:a=[]}={}){null!=t&&(e.source.coordType=t),null!=r&&(e.source.coordTypeZ=r),null!=n&&(e.source.iconName=n),null!=i&&(e.source.label=i);let o=0==e.source.coordType?"lla":"xyz";for(const t of a){t.position=new Position(o),t.position.set(t.coord[0],t.coord[1],t.coordZ);let r=e.source.data.findIndex((e=>e.id===t.id));-1==r?e.source.data.push(t):e.source.data[r]=t}}_updateData(e){for(const t of e.source.data){let r=e.getData(t.id);r?r.setSource(t):r=this.createData(t.id,t,e),r.positions=[r.source.position],r.label=e.source.label,r.iconName=e.source.iconName}}async _drawLayer(e,t){if(this.scene){for(const t of e.data){let r=await this.getIconAsset(t.iconName);r.name=t.id,r.position=t.positions[0],r.label=!!t.label,r.labelText=t.label,r.isShow=e.isShow,t.inView?await this.scene.updateLandmark(e.id,t.id,r):(await this.scene.addLandmark(e.id,r),t.inView=!0)}t&&t({result:1,message:"成功。"})}}addSceneEventListener(e){"onLandmarkHover"!==e&&"onLandmarkUnhover"!==e||this.scene.tgapp.events[e].length<=0||this.scene.tgapp.events[e].length>1||("onLandmarkHover"===e&&this.scene.on("mousehover","drawable",this.onDrawableMouseHover),"onLandmarkUnhover"===e&&this.scene.on("unmousehover","drawable",this.onDrawableUnmouseHover))}removeSceneEventListener(e){"onLandmarkHover"!==e&&"onLandmarkUnhover"!==e||this.scene.tgapp.events[e].length>0||("onLandmarkHover"===e&&this.scene.off("mousehover","drawable",this.onDrawableMouseHover),"onLandmarkUnhover"===e&&this.scene.off("unmousehover","drawable",this.onDrawableUnmouseHover))}onMouseEvent({type:e,layer:t,data:r}={}){"click"==e&&r.parent.allowClickSelected?this.scene.tgapp.triggerEvent.onLandmarkClick({id:r.id,selected:r.isSelected,label:r.label,type:r.source.type}):"hover"!=e?"unhover"!=e||this.scene.tgapp.triggerEvent.onLandmarkUnhover({id:r.id}):this.scene.tgapp.triggerEvent.onLandmarkHover({id:r.id})}onFocusEvent({type:e,layerId:t}={}){"focusStart"!==e?"focusEnd"!==e?"focusAllStart"!==e?"focusAllEnd"!==e||this.scene.tgapp.triggerEvent.onFocusAllLandmarkEnd({}):this.scene.tgapp.triggerEvent.onFocusAllLandmarkStart({}):this.scene.tgapp.triggerEvent.onFocusLandmarkEnd({id:t}):this.scene.tgapp.triggerEvent.onFocusLandmarkStart({id:t})}}const landmark=new Landmark;class Area extends BaseOverlay{constructor(){super(),this.type="area",this.interfaceList=["addArea","updateAreaCoord","updateAreaStyle","addAreaShp"]}addArea({id:e,type:t,points:r,isPlot:n}={},i){if(!this.isContain_AreaType(t))return i&&i({result:0,message:`失败，不存在 ${t} 区域类型。`}),!1;if(this.getLayer(e))return void(i&&i({result:0,message:`失败，已存在 ${e} 区域轮廓。`}));let a=this.deepCopy(arguments[0]);a.data=[{id:e,points:r}];let o=this._convertLayer(a);void 0!==n&&(o.isPlot=!0),this._drawLayer(o,i)}updateAreaCoord({id:e,points:t}={},r){if(!this.getLayer(e))return void(r&&r({result:0,message:`失败，未找到 ${e} 区域轮廓。`}));let n=this.deepCopy(arguments[0]);n.data=[{id:e,points:t}];let i=this._convertLayer(n);this._drawLayer(i,r)}updateAreaStyle({id:e}={},t){if(!this.getLayer(e))return void(t&&t({result:0,message:`失败，未找到 ${e} 区域轮廓。`}));let r=this.deepCopy(arguments[0]),n=this._convertLayer(r);this._drawLayer(n,t)}async addAreaShp({id:e,shpPath:t}={},r){if(this.getLayer(e))return void(r&&r({result:0,message:`失败，已存在 ${e} 区域轮廓。`}));let n=this.deepCopy(arguments[0]);n.data=[{id:e,points:[]}],null==n.coordZ&&(n.coordZ=0),await shapefile.open(t).then((async e=>e.read().then((async function t(r){if(r.done)return;let i=e=>{if(!(e.length<=0))if("number"==typeof e[0])n.data[0].points.push({coord:e});else for(const t of e)i(t)};return i(r.value.geometry.coordinates),await e.read().then(t)})))).catch((e=>logger.error(e.stack)));let i=this._convertLayer(n);this._drawLayer(i,r)}_convertLayer({id:e}={}){let t=this.getLayer(e);return t||(t=this.createLayer(e,arguments[0])),this._updateLayer(t,arguments[0]),this._updateData(t),t}_updateLayer(e,{name:t,coordType:r,coordTypeZ:n,coordZ:i,type:a,color:o,areaHeight:s,fillArea:l,fillPosition:c,data:h=[]}={}){null!=t&&(e.source.name=t),null!=r&&(e.source.coordType=r),null!=n&&(e.source.coordTypeZ=n),null!=i&&(e.source.coordZ=i),null!=a&&(e.source.type=a),null!=o&&(e.source.color=o),null!=s&&(e.source.areaHeight=s),null!=l&&(e.source.fillArea=l),null!=c&&(e.source.fillPosition=c);for(const t of h){let r=e.source.data.findIndex((e=>e.id===t.id));-1==r?e.source.data.push(t):e.source.data[r]=t}}_updateData(e){for(const t of e.source.data){let r=e.getData(t.id);r?r.setSource(t):r=this.createData(t.id,t,e);let n=0==e.source.coordType?"lla":"xyz",i=t.points.map((t=>new Position(n).set(t.coord[0],t.coord[1],e.source.coordZ)));r.positions=i,r.fillArea=e.source.fillArea,r.type=e.source.type,r.areaHeight=e.source.areaHeight,r.color=e.source.color,r.fillPosition=e.source.fillPosition}}async _drawLayer(e,t){if(this.scene){for(const t of e.data){let r={};r.name=t.id,r.points=t.positions,r.fillArea=t.fillArea,r.areaType=t.type,r.depth=t.areaHeight,r.lineColor=t.color,r.color=t.color,r.fillType=t.fillPosition,r.label=!1,r.isShow=e.isShow,t.inView?await this.scene.updateArea(e.id,t.id,r):(await this.scene.addArea(e.id,r),t.inView=!0)}t&&t({result:1,message:"成功。"})}}addSceneEventListener(e){"onAreaHover"!==e&&"onAreaUnhover"!==e||this.scene.tgapp.events[e].length<=0||this.scene.tgapp.events[e].length>1||("onAreaHover"===e&&this.scene.on("mousehover","drawable",this.onDrawableMouseHover),"onAreaUnhover"===e&&this.scene.on("unmousehover","drawable",this.onDrawableUnmouseHover))}removeSceneEventListener(e){"onAreaHover"!==e&&"onAreaUnhover"!==e||this.scene.tgapp.events[e].length>0||("onAreaHover"===e&&this.scene.off("mousehover","drawable",this.onDrawableMouseHover),"onAreaUnhover"===e&&this.scene.off("unmousehover","drawable",this.onDrawableUnmouseHover))}onTranslateDragEndEvent({object:e,layer:t,data:r}={}){const n=e.position,i=e.userData.center,a={idObj:r.id,idLayer:t.id,overlayType:this.type,data:[]},o=n.x-i.x,s=n.y-i.y,l=n.z-i.z;if(0===t.source.coordType){a.coordType=0;for(const e of r.positions){let t=e.x+o,r=e.y+s,n=e.z+l;if("lla"===e.type){const i=this.scene.convertLLAToXYZ(e);t=i.x+o,r=i.y+s,n=i.z+l}const i=this.scene.convertXYZToLLA({x:t,y:r,z:n});a.data.push({coord:[i.x,i.y],coordZ:i.z})}}else{a.coordType=t.source.coordType;let e=position.x+o,r=position.y+s,n=position.z+l;a.data.push({coord:[e,r],coordZ:n})}this.scene.tgapp.triggerEvent.onTransformAxisDragEnd(a)}onTransformAxisDrag({object:e,layer:t,data:r}={}){const n=e.position,i=e.userData.center,a={idObj:r.id,idLayer:t.id,overlayType:this.type,data:[]},o=n.x-i.x,s=n.y-i.y,l=n.z-i.z;if(0===t.source.coordType){a.coordType=0;for(const e of r.positions){let t=e.x+o,r=e.y+s,n=e.z+l;if("lla"===e.type){const i=this.scene.convertLLAToXYZ(e);t=i.x+o,r=i.y+s,n=i.z+l}const i=this.scene.convertXYZToLLA({x:t,y:r,z:n});a.data.push({coord:[i.x,i.y],coordZ:i.z})}}else{a.coordType=t.source.coordType;let e=position.x+o,r=position.y+s,n=position.z+l;a.data.push({coord:[e,r],coordZ:n})}this.scene.tgapp.triggerEvent.onTransformAxisDrag(a)}onMouseEvent({type:e,layer:t,data:r,event:n}={}){"click"==e&&r.parent.allowClickSelected?this.scene.tgapp.triggerEvent.onAreaClick({id:r.id,selected:r.isSelected,coord:[n.longitude,n.latitude],label:r.label,type:r.source.type}):"hover"!=e?"unhover"!=e||this.scene.tgapp.triggerEvent.onAreaUnhover({id:r.id}):this.scene.tgapp.triggerEvent.onAreaHover({id:r.id,coord:[n.longitude,n.latitude]})}onFocusEvent({type:e,layerId:t}={}){"focusStart"!==e?"focusEnd"!==e?"focusAllStart"!==e?"focusAllEnd"!==e||this.scene.tgapp.triggerEvent.onFocusAllAreaEnd({}):this.scene.tgapp.triggerEvent.onFocusAllAreaStart({}):this.scene.tgapp.triggerEvent.onFocusAreaEnd({id:t}):this.scene.tgapp.triggerEvent.onFocusAreaStart({id:t})}}const area=new Area;class LandmarkLayer extends BaseOverlay{constructor(){super(),this.type="landmarkLayer",this.interfaceList=["addLandmarkLayer","updateLandmarkLayerCoord","updateLandmarkLayerStyle"]}addLandmarkLayer({id:e}={},t){if(this.getLayer(e))return void(t&&t({result:0,message:`失败，已存在 ${e} 地标图。`}));let r=this.deepCopy(arguments[0]),n=this._convertLayer(r);this._drawLayer(n,t)}updateLandmarkLayerCoord({id:e,isAppend:t=!0}={},r){if(!this.getLayer(e))return void(r&&r({result:0,message:`失败，未找到 ${e} 地标图。`}));let n=this.deepCopy(arguments[0]);n.dataAppend=t;let i=this._convertLayer(n);this._drawLayer(i,r)}updateLandmarkLayerStyle({id:e,isAppend:t=!0}={},r){if(!this.getLayer(e))return void(r&&r({result:0,message:`失败，未找到 ${e} 地标图。`}));let n=this.deepCopy(arguments[0]);n.legendAppend=t;let i=this._convertLayer(n);this._drawLayer(i,r)}_convertLayer({id:e,dataAppend:t=!0,legendAppend:r=!0}={}){let n=this.getLayer(e);if(n||(n=this.createLayer(e,arguments[0])),!t){n.source.data=[];for(const e of n.data)this.scene.removeDrawable(n.id,e.id);n.data=[]}if(!r){n.source.legends=[];for(const e of n.data)this.scene.removeDrawable(n.id,e.id);n.data=[]}return this._updateLayer(n,arguments[0]),this._updateData(n),n}_updateLayer(e,{name:t,coordType:r,coordTypeZ:n,autoScale:i,legends:a=[],data:o=[]}={}){null!=t&&(e.source.name=t),null!=r&&(e.source.coordType=r),null!=n&&(e.source.coordTypeZ=n),null!=i&&(e.source.autoScale=i);for(const t of a){let r=e.source.legends.findIndex((e=>e.name==t.name));-1==r?e.source.legends.push(t):e.source.legends[r]=t}let s=0==e.source.coordType?"lla":"xyz";for(const t of o){t.position=new Position(s),t.position.set(t.coord[0],t.coord[1],t.coordZ);let r=e.source.data.findIndex((e=>e.id===t.id));-1==r?e.source.data.push(t):e.source.data[r]=t}}_updateData(e){for(const t of e.source.data){let r=e.getData(t.id);r?r.setSource(t):r=this.createData(t.id,t,e);let n=e.source.legends.find((e=>e.name==r.source.type));n?(r.legend=n.name,r.color=n.color,r.iconName=n.iconName):(r.legend=void 0,r.color=void 0,r.iconName=void 0),r.positions=[r.source.position],r.label=r.source.label,r.autoScale=e.source.autoScale}}async _drawLayer(e,t){if(!this.scene)return;let r=[],n=[];for(const t of e.data){if(null==t.legend){r.push(t.source.type);continue}if(!this.isContain_IconAsset(t.iconName)){n.push(t.iconName);continue}let i=await this.getIconAsset(t.iconName);i.name=t.id,i.position=t.positions[0],i.label=!!t.label,i.labelText=t.label,i.labelColor=t.color,i.sizeAttenuation=t.autoScale,i.isShow=e.isShow,t.inView?await this.scene.updateLandmark(e.id,t.id,i):(await this.scene.addLandmark(e.id,i),t.inView=!0)}if(t)if(n.length>0||r.length>0){let e="错误，";r.length>0&&(e+=`图例 ${r.join("、")} 不存在。`),n.length>0&&(e+=`图标 ${n.join("、")} 不存在。`),t({result:1,message:e})}else t({result:1,message:"成功。"})}addSceneEventListener(e){"onLandmarkLayerHover"!==e&&"onLandmarkLayerUnhover"!==e||this.scene.tgapp.events[e].length<=0||this.scene.tgapp.events[e].length>1||("onLandmarkLayerHover"===e&&this.scene.on("mousehover","drawable",this.onDrawableMouseHover),"onLandmarkLayerUnhover"===e&&this.scene.on("unmousehover","drawable",this.onDrawableUnmouseHover))}removeSceneEventListener(e){"onLandmarkLayerHover"!==e&&"onLandmarkLayerUnhover"!==e||this.scene.tgapp.events[e].length>0||("onLandmarkLayerHover"===e&&this.scene.off("mousehover","drawable",this.onDrawableMouseHover),"onLandmarkLayerUnhover"===e&&this.scene.off("unmousehover","drawable",this.onDrawableUnmouseHover))}onMouseEvent({type:e,layer:t,data:r}={}){"click"==e&&r.parent.allowClickSelected?this.scene.tgapp.triggerEvent.onLandmarkLayerClick({idObj:r.id,idLayer:t.id,selected:r.isSelected,label:r.label,type:r.source.type}):"hover"!=e?"unhover"!=e||this.scene.tgapp.triggerEvent.onLandmarkLayerUnhover({idObj:r.id,idLayer:t.id}):this.scene.tgapp.triggerEvent.onLandmarkLayerHover({idObj:r.id,idLayer:t.id})}onFocusEvent({type:e,layerId:t,dataId:r,legend:n}={}){"focusStart"!==e?"focusEnd"!==e?"focusAllStart"!==e?"focusAllEnd"!==e?"focusLayerStart"!==e?"focusLayerEnd"!==e?"focusLegendStart"!==e?"focusLegendEnd"!==e||this.scene.tgapp.triggerEvent.onFocusLandmarkLayerLegendEnd({idLayer:t,legend:n}):this.scene.tgapp.triggerEvent.onFocusLandmarkLayerLegendStart({idLayer:t,legend:n}):this.scene.tgapp.triggerEvent.onFocusLandmarkLayerObjEnd({idLayer:t,idObj:r}):this.scene.tgapp.triggerEvent.onFocusLandmarkLayerObjStart({idLayer:t,idObj:r}):this.scene.tgapp.triggerEvent.onFocusAllLandmarkLayerEnd({}):this.scene.tgapp.triggerEvent.onFocusAllLandmarkLayerStart({}):this.scene.tgapp.triggerEvent.onFocusLandmarkLayerEnd({idLayer:t}):this.scene.tgapp.triggerEvent.onFocusLandmarkLayerStart({idLayer:t})}}const landmarkLayer=new LandmarkLayer;class RoadSgHeatLayer extends BaseOverlay{constructor(){super(),this.type="roadSgHeatLayer",this.interfaceList=["addRoadSgHeatLayerCoord","updateRoadSgHeatLayerCoord","updateRoadSgHeatLayerStyle","updateRoadSgHeatLayerSegment"]}addRoadSgHeatLayerCoord({id:e,alpha:t},r){if("number"!=typeof t||t<0||t>1)return void(r&&r({result:0,message:"失败，alpha 属性值错误。"}));if(this.getLayer(e))return void(r&&r({result:0,message:`失败，已存在 ${e} 路径段热力图。`}));let n=this.deepCopy(arguments[0]),i=this._convertLayer(n);this._drawLayer(i,r)}updateRoadSgHeatLayerCoord({id:e,isAppend:t},r){let n=this.getLayer(e);if(!n)return void(r&&r({result:0,message:`失败，未找到 ${e} 路径段热力图。`}));let i=this.deepCopy(arguments[0]);i.dataAppend=t,this._convertLayer(i),this._drawLayer(n,r)}updateRoadSgHeatLayerStyle({id:e,alpha:t},r){let n=this.getLayer(e);if(null!=t&&("number"!=typeof t||t<0||t>1))return void(r&&r({result:0,message:"失败，alpha 属性值错误。"}));if(!n)return void(r&&r({result:0,message:`失败，未找到 ${e} 路径段热力图。`}));let i=this.deepCopy(arguments[0]);this._convertLayer(i),this._drawLayer(n,r)}updateRoadSgHeatLayerSegment({id:e,isAppend:t},r){let n=this.getLayer(e);if(!n)return void(r&&r({result:0,message:`失败，未找到 ${e} 路径段热力图。`}));let i=this.deepCopy(arguments[0]);i.segmentAppend=t,this._convertLayer(i),this._drawLayer(n,r)}_convertLayer({id:e,dataAppend:t=!0,segmentAppend:r=!0}={}){let n=this.getLayer(e);if(n||(n=this.createLayer(e,arguments[0])),!r){n.source.segments=[];for(const e of n.data)this.scene.removeDrawable(n.id,e.id);n.data=[]}if(!t){n.source.data=[];for(const e of n.data)this.scene.removeDrawable(n.id,e.id);n.data=[]}return this._updateLayer(n,arguments[0]),this._updateData(n),n}_updateLayer(e,{name:t,coordType:r,coordTypeZ:n,alpha:i,width:a,colorMax:o,colorMin:s,valueMax:l,valueMin:c,segments:h=[],data:u=[]}={}){null!=t&&(e.source.name=t),null!=r&&(e.source.coordType=r),null!=n&&(e.source.coordTypeZ=n),null!=i&&(e.source.alpha=i),null!=a&&(e.source.width=a),null!=o&&(e.source.colorMax=o),null!=s&&(e.source.colorMin=s),null!=l&&(e.source.valueMax=l),null!=c&&(e.source.valueMin=c);for(const t of h){let r=e.source.segments.findIndex((e=>e.name==t.name));-1==r?e.source.segments.push(t):e.source.segments[r]=t}for(const t of u){let r=e.source.data.findIndex((e=>e.name===t.name));-1==r?e.source.data.push(t):e.source.data[r]=t}}_updateData(e){for(const t of e.source.data){let r=e.getData(t.name);r?r.setSource(t):r=this.createData(t.name,t,e);let n=e.source.segments.find((e=>e.name==t.name));if(n){r.segment=n.name;let t=0==e.source.coordType?"lla":"xyz";r.positions=n.points.map((e=>new Position(t).set(e.coord[0],e.coord[1],e.coordZ)))}else r.segment=void 0,r.positions=[];r.color=this._getColorByRatio(e.source,t.value),r.width=e.source.width,r.alpha=e.source.alpha}}_drawLayer(e,t){if(!this.scene)return;let r=[];for(const t of e.data){if(!t.segment){r.push(t.id);continue}let n={};n.name=t.id,n.points=t.positions,n.color=t.color,n.colorPass=t.color,n.width=t.width,n.alpha=t.alpha,n.isShow=e.isShow,t.inView?this.scene.updatePath(e.id,t.id,n):(this.scene.addPath(e.id,n),t.inView=!0)}t&&t({result:1,message:"成功。"})}_getColorByRatio(e,t){let r=this._colorToRgba(e.colorMax),n=this._colorToRgba(e.colorMin),i=e.valueMax,a=e.valueMin;if(t<a)return"rgba("+n.join(",")+")";if(t>i)return"rgba("+r.join(",")+")";let o=(t-a)/(i-a),s=this._subtraction(r,n),l=this._multiplication(s,o);return"rgba("+this._multiply(n,l).join(",")+")"}_colorToRgba(e){var t=e.toLowerCase(),r=1;if(t&&/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{4}|[0-9a-fA-f]{6}|[0-9a-fA-f]{8})$/.test(t)){if(4===t.length||5===t.length){for(var n="#",i=1;i<t.length;i+=1)n+=t.slice(i,i+1).concat(t.slice(i,i+1));t=n}9===t.length&&(r=(parseInt("0x"+t.slice(7,9))/255).toFixed(2));var a=[];for(i=1;i<7;i+=2)a.push(parseInt("0x"+t.slice(i,i+2)));return[...a,r]}return t}_subtraction(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2],e[3]-t[3]]}_multiplication(e,t){return[Math.round(e[0]*t),Math.round(e[1]*t),Math.round(e[2]*t),Math.round(e[3]*t)]}_multiply(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2],e[3]+t[3]]}addSceneEventListener(e){"onRoadSgHeatLayerHover"!==e&&"onRoadSgHeatLayerUnhover"!==e||this.scene.tgapp.events[e].length<=0||this.scene.tgapp.events[e].length>1||("onRoadSgHeatLayerHover"===e&&this.scene.on("mousehover","drawable",this.onDrawableMouseHover),"onRoadSgHeatLayerUnhover"===e&&this.scene.on("unmousehover","drawable",this.onDrawableUnmouseHover))}removeSceneEventListener(e){"onRoadSgHeatLayerHover"!==e&&"onRoadSgHeatLayerUnhover"!==e||this.scene.tgapp.events[e].length>0||("onRoadSgHeatLayerHover"===e&&this.scene.off("mousehover","drawable",this.onDrawableMouseHover),"onRoadSgHeatLayerUnhover"===e&&this.scene.off("unmousehover","drawable",this.onDrawableUnmouseHover))}onMouseEvent({type:e,layer:t,data:r,event:n}={}){"click"==e&&r.parent.allowClickSelected&&this.scene.tgapp.triggerEvent.onRoadSgHeatLayerClick({nameSegment:r.id,idLayer:t.id,selected:r.isSelected,coord:[n.longitude,n.latitude],label:r.label,type:r.source.type}),"hover"==e&&this.scene.tgapp.triggerEvent.onRoadSgHeatLayerHover({nameSegment:r.id,idLayer:t.id,coord:[n.longitude,n.latitude]}),"unhover"==e&&this.scene.tgapp.triggerEvent.onRoadSgHeatLayerUnhover({nameSegment:r.id,idLayer:t.id})}onFocusEvent({type:e,layerId:t,dataId:r}={}){"focusStart"!==e?"focusEnd"!==e?"focusAllStart"!==e?"focusAllEnd"!==e?"focusLayerStart"!==e?"focusLayerEnd"!==e||this.scene.tgapp.triggerEvent.onFocusRoadSgHeatEnd({idLayer:t,nameSegment:r}):this.scene.tgapp.triggerEvent.onFocusRoadSgHeatStart({idLayer:t,nameSegment:r}):this.scene.tgapp.triggerEvent.onFocusAllRoadSgHeatLayerEnd({}):this.scene.tgapp.triggerEvent.onFocusAllRoadSgHeatLayerStart({}):this.scene.tgapp.triggerEvent.onFocusRoadSgHeatLayerEnd({idLayer:t}):this.scene.tgapp.triggerEvent.onFocusRoadSgHeatLayerStart({idLayer:t})}}const roadSgHeatLayer=new RoadSgHeatLayer;class TypeAreaLayer extends BaseOverlay{constructor(){super(),this.type="typeAreaLayer",this.interfaceList=["addTypeAreaLayer","updateTypeAreaLayerCoord","updateTypeAreaLayerStyle","updateTypeAreaLayerArea"]}addTypeAreaLayer({id:e,alpha:t}={},r){if("number"!=typeof t||t<0||t>1)return void(r&&r({result:0,message:"失败，alpha 属性值错误。"}));if(this.getLayer(e))return void(r&&r({result:0,message:`失败，已存在 ${e} 类别区域图。`}));let n=this.deepCopy(arguments[0]),i=this._convertLayer(n);this._drawLayer(i,r)}updateTypeAreaLayerCoord({id:e,isAppend:t=!0}={},r){if(!this.getLayer(e))return void(r&&r({result:0,message:`失败，未找到 ${e} 类型区域图。`}));let n=this.deepCopy(arguments[0]);n.dataAppend=t;let i=this._convertLayer(n);this._drawLayer(i,r)}updateTypeAreaLayerStyle({id:e,alpha:t,isAppend:r=!0}={},n){if(null!=t&&("number"!=typeof t||t<0||t>1))return void(n&&n({result:0,message:"失败，alpha 属性值错误。"}));if(!this.getLayer(e))return void(n&&n({result:0,message:`失败，未找到 ${e} 类型区域图。`}));let i=this.deepCopy(arguments[0]);i.legendAppend=r;let a=this._convertLayer(i);this._drawLayer(a,n)}updateTypeAreaLayerArea({id:e,isAppend:t=!0}={},r){if(!this.getLayer(e))return void(r&&r({result:0,message:`失败，未找到 ${e} 类型区域图。`}));let n=this.deepCopy(arguments[0]);n.areaAppend=t;let i=this._convertLayer(n);this._drawLayer(i,r)}_convertLayer({id:e,dataAppend:t=!0,areaAppend:r=!0,legendAppend:n=!0}={}){let i=this.getLayer(e);return i||(i=this.createLayer(e,arguments[0]),i.source.areas=[],i.source.legends=[],i.source.data=[]),r||(i.source.areas=[],i.data.forEach((e=>this.scene.removeDrawable(i.id,e.id))),i.data=[]),n||(i.source.legends=[],i.data.forEach((e=>this.scene.removeDrawable(i.id,e.id))),i.data=[]),t||(i.source.data=[],i.data.forEach((e=>this.scene.removeDrawable(i.id,e.id))),i.data=[]),this._updateLayer(i,arguments[0]),this._updateData(i),i}_updateLayer(e,{name:t,coordType:r,coordTypeZ:n,coordZ:i,alpha:a,areas:o=[],legends:s=[],data:l=[]}={}){null!=t&&(e.source.name=t),null!=r&&(e.source.coordType=r),null!=n&&(e.source.coordTypeZ=n),null!=i&&(e.source.coordZ=i),null!=a&&(e.source.alpha=a);for(let t of s){let r=e.source.legends.findIndex((e=>e.name==t.name));-1==r?e.source.legends.push(t):e.source.legends[r]=t}for(let t of o){null==t.name&&(t.name=t.areaName);let r=e.source.areas.findIndex((e=>e.name==t.name));-1==r?e.source.areas.push(t):e.source.areas[r].points.push(...t.points)}for(const t of l){let r=e.source.data.findIndex((e=>e.areaName==t.areaName));-1==r?e.source.data.push(t):e.source.data[r]=t}}_updateData(e){let t=0==e.source.coordType?"lla":"xyz";for(const r of e.source.data){let n=e.data.find((e=>e.id==r.areaName));n?n.setSource(r):n=this.createData(r.areaName,r,e);let i=e.source.areas.find((e=>e.name==r.areaName));i?(n.area=i.name,n.positions=i.points.map((r=>{let n=new Position(t);return n.set(r.coord[0],r.coord[1],e.source.coordZ),n}))):(n.area=void 0,n.positions=[]);let a=e.source.legends.find((e=>e.name==r.legendName));a?(n.legend=a.name,n.fillArea=a.fillArea,n.areaType=a.type,n.lineColor=a.color,n.color=a.color,n.depth=a.areaHeight,n.fillType=a.fillPosition):(n.legend=void 0,n.fillArea=void 0,n.areaType=void 0,n.lineColor=void 0,n.color=void 0,n.depth=void 0,n.fillType=void 0),n.alpha=e.source.alpha}}_drawLayer(e,t){if(!this.scene)return;let r=[],n=[],i=[];for(const t of e.data){if(null==t.area){r.push(t.source.areaName),this.scene.removeDrawable(e.id,t.id);continue}if(null==t.legend){n.push(t.source.legendName),this.scene.removeDrawable(e.id,t.id);continue}if(!this.isContain_AreaType(t.areaType)){this.scene.removeDrawable(e.id,t.id),i.push(t.source.type);continue}let a={};a.name=t.id,a.fillArea=t.fillArea,a.alpha=t.alpha,a.points=t.positions,a.areaType=t.areaType,a.lineColor=t.lineColor,a.color=t.color,a.depth=t.depth,a.fillType=t.fillType,a.label=!1,a.isShow=e.isShow,t.inView?this.scene.updateArea(e.id,t.id,a):(this.scene.addArea(e.id,a),t.inView=!0)}t&&t({result:1,message:"成功。"})}addSceneEventListener(e){"onTypeAreaLayerHover"!==e&&"onTypeAreaLayerUnhover"!==e||this.scene.tgapp.events[e].length<=0||this.scene.tgapp.events[e].length>1||("onTypeAreaLayerHover"===e&&this.scene.on("mousehover","drawable",this.onDrawableMouseHover),"onTypeAreaLayerUnhover"===e&&this.scene.on("unmousehover","drawable",this.onDrawableUnmouseHover))}removeSceneEventListener(e){"onTypeAreaLayerHover"!==e&&"onTypeAreaLayerUnhover"!==e||this.scene.tgapp.events[e].length>0||("onTypeAreaLayerHover"===e&&this.scene.off("mousehover","drawable",this.onDrawableMouseHover),"onTypeAreaLayerUnhover"===e&&this.scene.off("unmousehover","drawable",this.onDrawableUnmouseHover))}onMouseEvent({type:e,layer:t,data:r,event:n}={}){"click"==e&&this.scene.tgapp.triggerEvent.onTypeAreaLayerClick({nameArea:r.area,idLayer:t.id,selected:r.isSelected,coord:[n.longitude,n.latitude],label:void 0===r.label?null:r.label,type:void 0===r.type?null:r.type}),"hover"==e&&this.scene.tgapp.triggerEvent.onTypeAreaLayerHover({nameArea:r.area,idLayer:t.id,coord:[n.longitude,n.latitude]}),"unhover"==e&&this.scene.tgapp.triggerEvent.onTypeAreaLayerUnhover({nameArea:r.area,idLayer:t.id})}onFocusEvent({type:e,layerId:t,dataId:r,legend:n}={}){"focusStart"!==e?"focusEnd"!==e?"focusAllStart"!==e?"focusAllEnd"!==e?"focusLayerStart"!==e?"focusLayerEnd"!==e?"focusLegendStart"!==e?"focusLegendEnd"!==e||this.scene.tgapp.triggerEvent.onFocusTypeAreaLayerLegendEnd({idLayer:t,legend:n}):this.scene.tgapp.triggerEvent.onFocusTypeAreaLayerLegendStart({idLayer:t,legend:n}):this.scene.tgapp.triggerEvent.onFocusTypeAreaEnd({idLayer:t,nameArea:r}):this.scene.tgapp.triggerEvent.onFocusTypeAreaStart({idLayer:t,nameArea:r}):this.scene.tgapp.triggerEvent.onFocusAllTypeAreaLayerEnd({}):this.scene.tgapp.triggerEvent.onFocusAllTypeAreaLayerStart({}):this.scene.tgapp.triggerEvent.onFocusTypeAreaLayerEnd({idLayer:t}):this.scene.tgapp.triggerEvent.onFocusTypeAreaLayerStart({idLayer:t})}}const typeAreaLayer=new TypeAreaLayer;class RoadPtHeatLayer extends BaseOverlay{constructor(){super(),this.type="roadPtHeatLayer",this.interfaceList=["addRoadPtHeatLayerCoord","updateRoadPtHeatLayerCoord","updateRoadPtHeatLayerStyle"]}addRoadPtHeatLayerCoord({id:e,alpha:t,data:r=[]},n){if("number"!=typeof t||t<0||t>1)return void(n&&n({result:0,message:"失败，alpha 属性值错误。"}));if(this.getLayer(e))return void(n&&n({result:0,message:`失败，已存在 ${e} 路径点热力图。`}));if(r.length<=1)return void(n&&n({result:0,message:"失败，点数据太少,无法绘制路径。"}));let i=this.deepCopy(arguments[0]),a=this._convertLayer(i);this._drawLayer(a,n)}updateRoadPtHeatLayerCoord({id:e,isAppend:t},r){let n=this.getLayer(e);if(!n)return void(r&&r({result:0,message:`失败，未找到 ${e} 路径点热力图。`}));let i=this.deepCopy(arguments[0]);i.dataAppend=t,this._convertLayer(i),this._drawLayer(n,r)}updateRoadPtHeatLayerStyle({id:e,alpha:t},r){let n=this.getLayer(e);if(null!=t&&("number"!=typeof t||t<0||t>1))return void(r&&r({result:0,message:"失败，alpha 属性值错误。"}));if(!n)return void(r&&r({result:0,message:`失败，未找到 ${e} 路径点热力图。`}));let i=this.deepCopy(arguments[0]);this._convertLayer(i),this._drawLayer(n,r)}_convertLayer({id:e,dataAppend:t=!0}={}){let r=this.getLayer(e);if(r||(r=this.createLayer(e,arguments[0]),r.source.data=[]),!t){r.source.data=[];for(const e of r.data)this.scene.removeDrawable(r.id,e.id);r.data=[]}return this._updateLayer(r,arguments[0]),this._updateData(r),r}_updateLayer(e,{name:t,coordType:r,coordTypeZ:n,alpha:i,width:a,colorMax:o,colorMin:s,valueMax:l,valueMin:c,data:h=[]}={}){null!=t&&(e.source.name=t),null!=r&&(e.source.coordType=r),null!=n&&(e.source.coordTypeZ=n),null!=i&&(e.source.alpha=i),null!=a&&(e.source.width=a),null!=o&&(e.source.colorMax=o),null!=s&&(e.source.colorMin=s),null!=l&&(e.source.valueMax=l),null!=c&&(e.source.valueMin=c);let u=0==e.source.coordType?"lla":"xyz";h.forEach((t=>{t.position=new Position(u),"lla"===u?t.position.set(t.coord[0],t.coord[1],t.coordZ):"xyz"===u&&t.position.set(t.coord[0],t.coordZ,t.coord[1]),e.source.data.push(t)}))}_updateData(e){e.source.data.forEach(((t,r)=>{if(r<e.source.data.length-1){let n=e.getData(e.source.id+r);n?n.setSource(e.source.data):n=this.createData(e.source.id+r,e.source.data,e);let i=e.source.data[r+1];n.positions=[t.position,i.position],n.color=this._getColorByRatio(e.source,t.value),n.colorPass=this._getColorByRatio(e.source,e.source.data[r+1].value),n.passRange=.5,n.pass=.5,n.width=e.source.width,n.alpha=e.source.alpha}}))}_drawLayer(e,t){this.scene&&(e.data.forEach(((t,r)=>{let n={};n.name=e.id+r,n.points=t.positions,n.color=t.color,n.colorPass=t.colorPass,n.width=t.width,n.alpha=t.alpha,n.isShow=e.isShow,n.zLevel=e.zLevel,n.pass=t.pass,n.passRange=t.passRange,t.inView?this.scene.updatePath(e.id,t.id,n):(this.scene.addPath(e.id,n),t.inView=!0)})),t&&t({result:1,message:"成功。"}))}_getColorByRatio(e,t){let r=this._colorToRgba(e.colorMax),n=this._colorToRgba(e.colorMin),i=e.valueMax,a=e.valueMin;if(t<a)return"rgba("+n.join(",")+")";if(t>i)return"rgba("+r.join(",")+")";let o=(t-a)/(i-a),s=this._subtraction(r,n),l=this._multiplication(s,o);return"rgba("+this._multiply(n,l).join(",")+")"}_colorToRgba(e){var t=e.toLowerCase(),r=1;if(t&&/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{4}|[0-9a-fA-f]{6}|[0-9a-fA-f]{8})$/.test(t)){if(4===t.length||5===t.length){for(var n="#",i=1;i<t.length;i+=1)n+=t.slice(i,i+1).concat(t.slice(i,i+1));t=n}9===t.length&&(r=(parseInt("0x"+t.slice(7,9))/255).toFixed(2));var a=[];for(i=1;i<7;i+=2)a.push(parseInt("0x"+t.slice(i,i+2)));return[...a,r]}return t}_subtraction(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2],e[3]-t[3]]}_multiplication(e,t){return[Math.round(e[0]*t),Math.round(e[1]*t),Math.round(e[2]*t),Math.round(e[3]*t)]}_multiply(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2],e[3]+t[3]]}addSceneEventListener(e){"onRoadPtHeatLayerHover"!==e&&"onRoadPtHeatLayerUnhover"!==e||this.scene.tgapp.events[e].length<=0||this.scene.tgapp.events[e].length>1||("onRoadPtHeatLayerHover"===e&&this.scene.on("mousehover","drawable",this.onDrawableMouseHover),"onRoadPtHeatLayerUnhover"===e&&this.scene.on("unmousehover","drawable",this.onDrawableUnmouseHover))}removeSceneEventListener(e){"onRoadPtHeatLayerHover"!==e&&"onRoadPtHeatLayerUnhover"!==e||this.scene.tgapp.events[e].length>0||("onRoadPtHeatLayerHover"===e&&this.scene.off("mousehover","drawable",this.onDrawableMouseHover),"onRoadPtHeatLayerUnhover"===e&&this.scene.off("unmousehover","drawable",this.onDrawableUnmouseHover))}onMouseEvent({type:e,layer:t,data:r,event:n}={}){"click"==e&&r.parent.allowClickSelected&&this.scene.tgapp.triggerEvent.onRoadPtHeatLayerClick({idLayer:t.id,selected:r.isSelected,coord:[n.longitude,n.latitude]}),"hover"==e&&this.scene.tgapp.triggerEvent.onRoadPtHeatLayerHover({idLayer:t.id,coord:[n.longitude,n.latitude]}),"unhover"==e&&this.scene.tgapp.triggerEvent.onRoadPtHeatLayerUnhover({idLayer:t.id})}onFocusEvent({type:e,layerId:t}={}){"focusStart"!==e?"focusEnd"!==e?"focusAllStart"!==e?"focusAllEnd"!==e||this.scene.tgapp.triggerEvent.onFocusAllRoadPtHeatLayerEnd({}):this.scene.tgapp.triggerEvent.onFocusAllRoadPtHeatLayerStart({}):this.scene.tgapp.triggerEvent.onFocusRoadPtHeatLayerEnd({idLayer:t}):this.scene.tgapp.triggerEvent.onFocusRoadPtHeatLayerStart({idLayer:t})}}var roadPtHeatLayer=new RoadPtHeatLayer;class ColorAreaLayer extends BaseOverlay{constructor(){super(),this.type="colorAreaLayer",this.interfaceList=["addColorAreaLayer","updateColorAreaLayerCoord","updateColorAreaLayerStyle","updateColorAreaLayerArea"]}addColorAreaLayer({id:e,alpha:t}={},r){if("number"!=typeof t||t<0||t>1)return void(r&&r({result:0,message:"失败，alpha 属性值错误。"}));if(this.getLayer(e))return void(r&&r({result:0,message:`失败，已存在 ${e} 数值区域图。`}));let n=this.deepCopy(arguments[0]),i=this._convertLayer(n);this._drawLayer(i,r)}updateColorAreaLayerCoord({id:e,isAppend:t=!0}={},r){if(!this.getLayer(e))return void(r&&r({result:0,message:`失败，未找到 ${e} 数值区域图。`}));let n=this.deepCopy(arguments[0]);n.dataAppend=t;let i=this._convertLayer(n);this._drawLayer(i,r)}updateColorAreaLayerStyle({id:e,alpha:t}={},r){if(null!=t&&("number"!=typeof t||t<0||t>1))return void(r&&r({result:0,message:"失败，alpha 属性值错误。"}));if(!this.getLayer(e))return void(r&&r({result:0,message:`失败，未找到 ${e} 类型区域图。`}));let n=this.deepCopy(arguments[0]),i=this._convertLayer(n);this._drawLayer(i,r)}updateColorAreaLayerArea({id:e,isAppend:t=!0}={},r){if(!this.getLayer(e))return void(r&&r({result:0,message:`失败，未找到 ${e} 类型区域图。`}));let n=this.deepCopy(arguments[0]);n.areaAppend=t;let i=this._convertLayer(n);this._drawLayer(i,r)}_convertLayer({id:e,dataAppend:t=!0,areaAppend:r=!0}={}){let n=this.getLayer(e);return n||(n=this.createLayer(e,arguments[0]),n.source.areas=[],n.source.data=[]),r||(n.source.areas=[],n.data.forEach((e=>this.scene.removeDrawable(n.id,e.id))),n.data=[]),t||(n.source.data=[],n.data.forEach((e=>this.scene.removeDrawable(n.id,e.id))),n.data=[]),this._updateLayer(n,arguments[0]),this._updateData(n),n}_updateLayer(e,{name:t,coordType:r,coordTypeZ:n,coordZ:i,alpha:a,type:o,areaHeight:s,fillArea:l,fillPosition:c,colorMax:h,colorMin:u,valueMax:d,valueMin:p,areas:f=[],data:m=[]}={}){null!=t&&(e.source.name=t),null!=r&&(e.source.coordType=r),null!=n&&(e.source.coordTypeZ=n),null!=i&&(e.source.coordZ=i),null!=a&&(e.source.alpha=a),null!=o&&(e.source.type=o),null!=s&&(e.source.areaHeight=s),null!=l&&(e.source.fillArea=l),null!=c&&(e.source.fillPosition=c),null!=h&&(e.source.colorMax=h),null!=u&&(e.source.colorMin=u),null!=d&&(e.source.valueMax=d),null!=p&&(e.source.valueMin=p);for(const t of f){let r=e.source.areas.findIndex((e=>e.name==t.name));-1==r?e.source.areas.push(t):e.source.areas[r].points.push(...t.points)}for(const t of m){let r=e.source.data.findIndex((e=>e.areaName==t.areaName));-1==r?e.source.data.push(t):e.source.data[r]=t}}_updateData(e){let t=0==e.source.coordType?"lla":"xyz";for(const r of e.source.data){let n=e.data.find((e=>e.id==r.areaName));n?n.setSource(r):n=this.createData(r.areaName,r,e);let i=e.source.areas.find((e=>e.name==r.areaName));i?(n.area=i.name,n.positions=i.points.map((r=>{let n=new Position(t);return n.set(r.coord[0],r.coord[1],e.source.coordZ),n}))):(n.area=void 0,n.positions=[]),n.fillArea=e.source.fillArea,n.alpha=e.source.alpha,n.type=e.source.type,n.lineColor=this._getColorByRatio(e.source,n.source.value),n.color=this._getColorByRatio(e.source,n.source.value),n.areaHeight=e.source.areaHeight,n.fillPosition=e.source.fillPosition}}_drawLayer(e,t){if(!this.scene)return;let r=[],n=[];for(const t of e.data){if(null==t.area){r.push(t.source.areaName),this.scene.removeDrawable(e.id,t.id);continue}if(!this.isContain_AreaType(t.type)){n.push(t.source.type),this.scene.removeDrawable(e.id,t.id);continue}let i={};i.name=t.id,i.fillArea=t.fillArea,i.areaType=t.type,i.alpha=t.alpha,i.points=t.positions,i.lineColor=t.lineColor,i.color=t.color,i.depth=t.areaHeight,i.fillType=t.fillPosition,i.label=!1,i.isShow=e.isShow,t.inView?this.scene.updateArea(e.id,t.id,i):(this.scene.addArea(e.id,i),t.inView=!0)}t&&t({result:1,message:"成功。"})}_getColorByRatio(e,t){let r=this._colorToRgba(e.colorMax),n=this._colorToRgba(e.colorMin),i=e.valueMax,a=e.valueMin;if(t<a)return"rgba("+n.join(",")+")";if(t>i)return"rgba("+r.join(",")+")";let o=(t-a)/(i-a),s=this._subtraction(r,n),l=this._multiplication(s,o);return"rgba("+this._multiply(n,l).join(",")+")"}_colorToRgba(e){var t=e.toLowerCase(),r=1;if(t&&/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{4}|[0-9a-fA-f]{6}|[0-9a-fA-f]{8})$/.test(t)){if(4===t.length||5===t.length){for(var n="#",i=1;i<t.length;i+=1)n+=t.slice(i,i+1).concat(t.slice(i,i+1));t=n}9===t.length&&(r=(parseInt("0x"+t.slice(7,9))/255).toFixed(2));var a=[];for(i=1;i<7;i+=2)a.push(parseInt("0x"+t.slice(i,i+2)));return[...a,r]}return t}_subtraction(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2],e[3]-t[3]]}_multiplication(e,t){return[Math.round(e[0]*t),Math.round(e[1]*t),Math.round(e[2]*t),Math.round(e[3]*t)]}_multiply(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2],e[3]+t[3]]}addSceneEventListener(e){"onColorAreaLayerHover"!==e&&"onColorAreaLayerUnhover"!==e||this.scene.tgapp.events[e].length<=0||this.scene.tgapp.events[e].length>1||("onColorAreaLayerHover"===e&&this.scene.on("mousehover","drawable",this.onDrawableMouseHover),"onColorAreaLayerUnhover"===e&&this.scene.on("unmousehover","drawable",this.onDrawableUnmouseHover))}removeSceneEventListener(e){"onColorAreaLayerHover"!==e&&"onColorAreaLayerUnhover"!==e||this.scene.tgapp.events[e].length>0||("onColorAreaLayerHover"===e&&this.scene.off("mousehover","drawable",this.onDrawableMouseHover),"onColorAreaLayerUnhover"===e&&this.scene.off("unmousehover","drawable",this.onDrawableUnmouseHover))}onMouseEvent({type:e,layer:t,data:r,event:n}={}){"click"==e&&r.parent.allowClickSelected&&this.scene.tgapp.triggerEvent.onColorAreaLayerClick({nameArea:r.id,idLayer:t.id,selected:r.isSelected,coord:[n.longitude,n.latitude],label:r.label,type:r.source.type}),"hover"==e&&this.scene.tgapp.triggerEvent.onColorAreaLayerHover({nameArea:r.id,idLayer:t.id,coord:[n.longitude,n.latitude]}),"unhover"==e&&this.scene.tgapp.triggerEvent.onColorAreaLayerUnhover({nameArea:r.id,idLayer:t.id})}onFocusEvent({type:e,layerId:t,dataId:r}={}){"focusStart"!==e?"focusEnd"!==e?"focusAllStart"!==e?"focusAllEnd"!==e?"focusLayerStart"!==e?"focusLayerEnd"!==e||this.scene.tgapp.triggerEvent.onFocusColorAreaEnd({idLayer:t,nameArea:r}):this.scene.tgapp.triggerEvent.onFocusColorAreaStart({idLayer:t,nameArea:r}):this.scene.tgapp.triggerEvent.onFocusAllColorAreaLayerEnd({}):this.scene.tgapp.triggerEvent.onFocusAllColorAreaLayerStart({}):this.scene.tgapp.triggerEvent.onFocusColorAreaLayerEnd({idLayer:t}):this.scene.tgapp.triggerEvent.onFocusColorAreaLayerStart({idLayer:t})}}const colorAreaLayer=new ColorAreaLayer;class CircularArea extends BaseOverlay{constructor(){super(),this.type="circularArea",this.interfaceList=["addCircularArea","updateCircularAreaCoord","updateCircularAreaStyle"]}addCircularArea({id:e,type:t,radius:r}={},n){if("number"!=typeof r||r<=0)return n&&n({result:0,message:`失败，radius 属性错误的数值： ${r} 。`}),!1;if(!this.isContain_AreaType(t))return n&&n({result:0,message:`失败，不存在 ${t} 区域类型。`}),!1;if(this.getLayer(e))return void(n&&n({result:0,message:`失败，已存在 ${e} 圆形区域。`}));let i=this.deepCopy(arguments[0]),a=this._getPositions(i);i.data=[{id:e,positions:a}];let o=this._convertLayer(i);this._drawLayer(o,n)}updateCircularAreaCoord({id:e,radius:t}={},r){if("number"!=typeof t||t<=0)return r&&r({result:0,message:`失败，radius 属性错误的数值： ${t} 。`}),!1;if(!this.getLayer(e))return void(r&&r({result:0,message:`失败，未找到 ${e} 圆形区域。`}));let n=this.deepCopy(arguments[0]),i=this._getPositions(n);n.data=[{id:e,positions:i}];let a=this._convertLayer(n);this._drawLayer(a,r)}updateCircularAreaStyle({id:e}={},t){if(!this.getLayer(e))return void(t&&t({result:0,message:`失败，未找到 ${e} 圆形区域。`}));let r=this.deepCopy(arguments[0]),n=this._convertLayer(r);this._drawLayer(n,t)}_getPositions({coordType:e,center:t,coordZ:r,radius:n,density:i=1}={}){n*=this.scene.getWorldScale(),t=0==e?this.scene.convertLLAToXYZ({lon:t[0],lat:t[1],alt:r}):{x:t[0],y:t[1],z:r};let a=[];for(let e=0;e<=360;e+=i){let r=Math.PI/180*e,i=n*Math.cos(r),o=n*Math.sin(r),s=new Position;s.set(t.x+i,t.y,t.z-o),a.push(s)}return a}_convertLayer({id:e}={}){let t=this.getLayer(e);return t||(t=this.createLayer(e,arguments[0])),this._updateLayer(t,arguments[0]),this._updateData(t),t}_updateLayer(e,{name:t,coordType:r,coordTypeZ:n,coordZ:i,type:a,color:o,areaHeight:s,fillArea:l,fillPosition:c,data:h=[]}={}){null!=t&&(e.source.name=t),null!=r&&(e.source.coordType=r),null!=n&&(e.source.coordTypeZ=n),null!=i&&(e.source.coordZ=i),null!=a&&(e.source.type=a),null!=o&&(e.source.color=o),null!=s&&(e.source.areaHeight=s),null!=l&&(e.source.fillArea=l),null!=c&&(e.source.fillPosition=c);for(const t of h){t.coordType=e.source.coordType;let r=e.source.data.findIndex((e=>e.id===t.id));-1==r?e.source.data.push(t):e.source.data[r]=t}}_updateData(e){for(const t of e.source.data){let r=e.getData(t.id);r?r.setSource(t):r=this.createData(t.id,t,e),r.positions=r.source.positions,r.fillArea=e.source.fillArea,r.type=e.source.type,r.areaHeight=e.source.areaHeight,r.color=e.source.color,r.fillPosition=e.source.fillPosition}}async _drawLayer(e,t){if(this.scene){for(const t of e.data){let r={};r.name=t.id,r.points=t.positions,r.fillArea=t.fillArea,r.areaType=t.type,r.depth=t.areaHeight,r.lineColor=t.color,r.color=t.color,r.fillType=t.fillPosition,r.label=!1,r.isShow=e.isShow,t.inView?await this.scene.updateArea(e.id,t.id,r):(await this.scene.addArea(e.id,r),t.inView=!0)}t&&t({result:1,message:"成功。"})}}addSceneEventListener(e){"onCircularAreaHover"!==e&&"onCircularAreaUnhover"!==e||this.scene.tgapp.events[e].length<=0||this.scene.tgapp.events[e].length>1||("onCircularAreaHover"===e&&this.scene.on("mousehover","drawable",this.onDrawableMouseHover),"onCircularAreaUnhover"===e&&this.scene.on("unmousehover","drawable",this.onDrawableUnmouseHover))}removeSceneEventListener(e){"onCircularAreaHover"!==e&&"onCircularAreaUnhover"!==e||this.scene.tgapp.events[e].length>0||("onCircularAreaHover"===e&&this.scene.off("mousehover","drawable",this.onDrawableMouseHover),"onCircularAreaUnhover"===e&&this.scene.off("unmousehover","drawable",this.onDrawableUnmouseHover))}onMouseEvent({type:e,layer:t,data:r,event:n}={}){"click"==e&&r.parent.allowClickSelected?this.scene.tgapp.triggerEvent.onCircularAreaClick({id:r.id,selected:r.isSelected,coord:[n.longitude,n.latitude],label:r.label,type:r.source.type}):"hover"!=e?"unhover"!=e||this.scene.tgapp.triggerEvent.onCircularAreaUnhover({id:r.id}):this.scene.tgapp.triggerEvent.onCircularAreaHover({id:r.id,coord:[n.longitude,n.latitude]})}onFocusEvent({type:e,layerId:t}={}){"focusStart"!==e?"focusEnd"!==e?"focusAllStart"!==e?"focusAllEnd"!==e||this.scene.tgapp.triggerEvent.onFocusAllCircularAreaEnd({}):this.scene.tgapp.triggerEvent.onFocusAllCircularAreaStart({}):this.scene.tgapp.triggerEvent.onFocusCircularAreaEnd({id:t}):this.scene.tgapp.triggerEvent.onFocusCircularAreaStart({id:t})}}const circularArea=new CircularArea;class Grid3DLayer extends BaseOverlay{constructor(){super(),this.type="3DGridLayer",this.interfaceList=["add3DGridLayer","update3DGridLayerCoord","update3DGridLayerStyle"]}add3DGridLayer({id:e,gridAlpha:t}={},r){if("number"!=typeof t||t<0||t>1)return void(r&&r({result:0,message:"失败，gridAlpha 属性值错误。"}));if(this.getLayer(e))return void(r&&r({result:0,message:`失败，已存在 ${e} 栅格图。`}));let n=this.deepCopy(arguments[0]),i=this._convertLayer(n);this._drawLayer(i,r)}update3DGridLayerCoord({id:e}={},t){if(!this.getLayer(e))return void(t&&t({result:0,message:`失败，未找到 ${e} 栅格图。`}));let r=this.deepCopy(arguments[0]),n=this._convertLayer(r);this._drawLayer(n,t)}update3DGridLayerStyle({id:e,gridAlpha:t}={},r){if(null!=t&&("number"!=typeof t||t<0||t>1))return void(r&&r({result:0,message:"失败，gridAlpha 属性值错误。"}));if(!this.getLayer(e))return void(r&&r({result:0,message:`失败，未找到 ${e} 栅格图。`}));let n=this.deepCopy(arguments[0]),i=this._convertLayer(n);this._drawLayer(i,r)}_convertLayer({id:e,isAppend:t=!0}={}){let r=this.getLayer(e);if(r||(r=this.createLayer(e,arguments[0])),!t){r.source.data=[];for(const e of r.data)this.scene.removeDrawable(r.id,e.id);r.data=[]}return this._updateLayer(r,arguments[0]),this._updateData(r),r}_updateLayer(e,{name:t,coordType:r,coordTypeZ:n,coordZ:i,gridType:a,gridHeight:o,gridAlpha:s,gridGap:l,gridWidth:c,colorMax:h,colorMin:u,valueMax:d,valueMin:p,data:f=[]}={}){null!=t&&(e.source.name=t),null!=r&&(e.source.coordType=r),null!=n&&(e.source.coordTypeZ=n),null!=i&&(e.source.coordZ=i),null!=a&&(e.source.gridType=a),null!=o&&(e.source.gridHeight=o),null!=s&&(e.source.gridAlpha=s),null!=l&&(e.source.gridGap=l),null!=c&&(e.source.gridWidth=c),null!=h&&(e.source.colorMax=h),null!=u&&(e.source.colorMin=u),null!=d&&(e.source.valueMax=d),null!=p&&(e.source.valueMin=p);for(const t of f){let r=e.source.data.findIndex((e=>e.id===t.id));-1==r?e.source.data.push(t):e.source.data[r]=t}}_updateData(e){this._maxWidth(e.source);for(const t of e.source.data){let r=e.getData(t.id);r?r.setSource(t):r=this.createData(t.id,t,e),r.positions=[r.source.position],r.gridHeight=e.source.gridHeight,r.gridWidth=e.source.gridWidth,r.color=this._getColorByRatio(e.source,r.source.value),r.gridType="grid"==e.source.gridType?"矩形":"cylinder",r.gridAlpha=e.source.gridAlpha,r.maxWidth=e.source.maxWidth}}_maxWidth({coordType:e,coordZ:t,gridWidth:r,data:n}={}){let i=0==e?"lla":"xyz";for(const e of n)e.position=new Position(i),e.position.set(e.coord[0],e.coord[1],t);let a=r;for(const e of n)for(const t of n){if(e.id===t.id)continue;let r=this.scene.getDistanceByPositions(e.position,t.position);r<a&&(a=r)}arguments[0].maxWidth=a}_getColorByRatio(e,t){let r=this._colorToRgba(e.colorMax),n=this._colorToRgba(e.colorMin),i=e.valueMax,a=e.valueMin;if(t<a)return"rgba("+n.join(",")+")";if(t>i)return"rgba("+r.join(",")+")";let o=(t-a)/(i-a),s=this._subtraction(r,n),l=this._multiplication(s,o);return"rgba("+this._multiply(n,l).join(",")+")"}_colorToRgba(e){var t=e.toLowerCase(),r=1;if(t&&/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{4}|[0-9a-fA-f]{6}|[0-9a-fA-f]{8})$/.test(t)){if(4===t.length||5===t.length){for(var n="#",i=1;i<t.length;i+=1)n+=t.slice(i,i+1).concat(t.slice(i,i+1));t=n}9===t.length&&(r=(parseInt("0x"+t.slice(7,9))/255).toFixed(2));var a=[];for(i=1;i<7;i+=2)a.push(parseInt("0x"+t.slice(i,i+2)));return[...a,r]}return t}_subtraction(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2],e[3]-t[3]]}_multiplication(e,t){return[Math.round(e[0]*t),Math.round(e[1]*t),Math.round(e[2]*t),Math.round(e[3]*t)]}_multiply(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2],e[3]+t[3]]}async _drawLayer(e,t){if(this.scene){for(const t of e.data){let r={};r.name=t.id,r.position=t.positions[0],r.value=t.gridHeight,r.color=t.color,r.barStyle=t.gridType,r.alpha=t.gridAlpha,r.widthRatio=t.gridWidth,r.isShow=e.isShow,t.inView?await this.scene.updateBar(e.id,t.id,r):(await this.scene.addBar(e.id,r),t.inView=!0)}t&&t({result:1,message:"成功。"})}}addSceneEventListener(e){"on3DGridLayerHover"!==e&&"on3DGridLayerUnhover"!==e||this.scene.tgapp.events[e].length<=0||this.scene.tgapp.events[e].length>1||("on3DGridLayerHover"===e&&this.scene.on("mousehover","drawable",this.onDrawableMouseHover),"on3DGridLayerUnhover"===e&&this.scene.on("unmousehover","drawable",this.onDrawableUnmouseHover))}removeSceneEventListener(e){"on3DGridLayerHover"!==e&&"on3DGridLayerUnhover"!==e||this.scene.tgapp.events[e].length>0||("on3DGridLayerHover"===e&&this.scene.off("mousehover","drawable",this.onDrawableMouseHover),"on3DGridLayerUnhover"===e&&this.scene.off("unmousehover","drawable",this.onDrawableUnmouseHover))}onMouseEvent({type:e,layer:t,data:r,event:n}={}){"click"==e&&r.parent.allowClickSelected&&this.scene.tgapp.triggerEvent.on3DGridLayerClick({idObj:r.id,idLayer:t.id,selected:r.isSelected,coord:[n.longitude,n.latitude],label:r.label,type:r.source.type}),"hover"==e&&this.scene.tgapp.triggerEvent.on3DGridLayerHover({idObj:r.id,idLayer:t.id,coord:[n.longitude,n.latitude]}),"unhover"==e&&this.scene.tgapp.triggerEvent.on3DGridLayerUnhover({idObj:r.id,idLayer:t.id})}onFocusEvent({type:e,layerId:t}={}){"focusStart"!==e?"focusEnd"!==e?"focusAllStart"!==e?"focusAllEnd"!==e||this.scene.tgapp.triggerEvent.onFocusAll3DGridLayerEnd({}):this.scene.tgapp.triggerEvent.onFocusAll3DGridLayerStart({}):this.scene.tgapp.triggerEvent.onFocus3DGridLayerEnd({idLayer:t}):this.scene.tgapp.triggerEvent.onFocus3DGridLayerStart({idLayer:t})}}const grid3DLayer=new Grid3DLayer;class HeatMapLayer extends BaseOverlay{constructor(){super(),this.type="heatMapLayer",this.interfaceList=["addHeatMapLayer","updateHeatMapLayerCoord","updateHeatMapLayerStyle"]}addHeatMapLayer({id:e,alpha:t,type:r}={},n){if("number"!=typeof t||t<0||t>1)return void(n&&n({result:0,message:"失败，alpha 属性值错误。"}));if("default"!=r&&"dot"!=r)return void(n&&n({result:0,message:"失败，type 属性值错误。"}));if(this.getLayer(e))return void(n&&n({result:0,message:`失败，已存在 ${e} 地标图。`}));let i=this.deepCopy(arguments[0]),a=this._convertLayer(i);this._drawLayer(a,n)}updateHeatMapLayerCoord({id:e}={},t){if(!this.getLayer(e))return void(t&&t({result:0,message:`失败，未找到 ${e} 地标图。`}));let r=this.deepCopy(arguments[0]),n=this._convertLayer(r);this._drawLayer(n,t)}updateHeatMapLayerStyle({id:e,alpha:t,type:r}={},n){if(null!=t&&("number"!=typeof t||t<0||t>1))return void(n&&n({result:0,message:"失败，alpha 属性值错误。"}));if(null!=r&&"default"!=r&&"dot"!=r)return void(n&&n({result:0,message:"失败，type 属性值错误。"}));if(!this.getLayer(e))return void(n&&n({result:0,message:`失败，未找到 ${e} 地标图。`}));let i=this.deepCopy(arguments[0]);i.isAppend=!0;let a=this._convertLayer(i);this._drawLayer(a,n)}_convertLayer({id:e,isAppend:t=!1}={}){let r=this.getLayer(e);if(r||(r=this.createLayer(e,arguments[0])),!t){r.source.data=[];for(const e of r.data)this.scene.removeDrawable(r.id,e.id);r.data=[]}return this._updateLayer(r,arguments[0]),this._updateData(r),r}_updateLayer(e,{name:t,coordType:r,coordTypeZ:n,coordZ:i,type:a,alpha:o,colorMax:s,colorMin:l,valueMax:c,valueMin:h,radius:u,data:d=[]}={}){null!=t&&(e.source.name=t),null!=r&&(e.source.coordType=r),null!=n&&(e.source.coordTypeZ=n),null!=i&&(e.source.coordZ=i),null!=a&&(e.source.type=a),null!=o&&(e.source.alpha=o),null!=s&&(e.source.colorMax=s),null!=l&&(e.source.colorMin=l),null!=c&&(e.source.valueMax=c),null!=h&&(e.source.valueMin=h),null!=u&&(e.source.radius=u);for(const t of d)e.source.data.push(t)}_updateData(e){let t=e.getData(e.source.id);t?t.setSource(e.source):t=this.createData(e.source.id,e.source,e);let r=0==e.source.coordType?"lla":"xyz",n=[];for(const t of e.source.data){let i=new Position(r);i.set(t.coord[0],t.coord[1],e.source.coordZ),i.value=this._getValueByRatio(e.source,t.value),n.push(i)}if("lla"===r)for(const e of n){let t=this.scene.convertLLAToXYZ(e);e.x=t.x,e.y=t.y,e.z=t.z}t.positions=n,t.alpha=e.source.alpha,t.type="dot"!=e.source.type?"none":"dot",t.radius=e.source.radius,t.valueMax=e.source.valueMax,t.valueMin=e.source.valueMin,t.gradient={0:e.source.colorMin,.33:"#00ff00",.66:"#ffff00",1:e.source.colorMax},t.points=n.map((e=>({value:e.value,x:e.x,y:e.y,z:e.z})))}async _drawLayer(e,t){if(this.scene){for(const t of e.data){let r={};r.name=t.id,r.opacity=t.alpha,r.style=t.type,r.radius=Math.ceil(t.radius),r.valueMax=t.valueMax,r.valueMin=t.valueMin,r.gradient=t.gradient,r.points=t.points,r.enableAutoHidebyDistance=!1,r.pointsType="xyz",r.isShow=e.isShow,t.inView?await this.scene.updateHeatMapData(e.id,t.id,r):(await this.scene.addHeatMap(e.id,r),t.inView=!0)}t&&t({result:1,message:"成功。"})}}_getValueByRatio(e,t){let r=e.valueMax,n=e.valueMin;return t<n?n:t>r?r:t}addSceneEventListener(e){"onHeatmapLayerHover"!==e&&"onHeatmapLayerUnhover"!==e||this.scene.tgapp.events[e].length<=0||this.scene.tgapp.events[e].length>1||("onHeatmapLayerHover"===e&&this.scene.on("mousehover","drawable",this.onDrawableMouseHover),"onHeatmapLayerUnhover"===e&&this.scene.on("unmousehover","drawable",this.onDrawableUnmouseHover))}removeSceneEventListener(e){"onHeatmapLayerHover"!==e&&"onHeatmapLayerUnhover"!==e||this.scene.tgapp.events[e].length>0||("onHeatmapLayerHover"===e&&this.scene.off("mousehover","drawable",this.onDrawableMouseHover),"onHeatmapLayerUnhover"===e&&this.scene.off("unmousehover","drawable",this.onDrawableUnmouseHover))}onMouseEvent({type:e,layer:t,data:r,event:n}={}){"click"==e&&r.parent.allowClickSelected?this.scene.tgapp.triggerEvent.onHeatmapLayerClick({idLayer:t.id,coord:[n.longitude,n.latitude],selected:r.isSelected,label:r.label,type:r.source.type}):"hover"!=e?"unhover"!=e||this.scene.tgapp.triggerEvent.onHeatmapLayerUnhover({idLayer:t.id}):this.scene.tgapp.triggerEvent.onHeatmapLayerHover({idLayer:t.id,coord:[n.longitude,n.latitude]})}onFocusEvent({type:e,layerId:t}={}){"focusStart"!==e?"focusEnd"!==e?"focusAllStart"!==e?"focusAllEnd"!==e||this.scene.tgapp.triggerEvent.onFocusAllHeatmapLayerEnd({}):this.scene.tgapp.triggerEvent.onFocusAllHeatmapLayerStart({}):this.scene.tgapp.triggerEvent.onFocusHeatmapLayerEnd({idLayer:t}):this.scene.tgapp.triggerEvent.onFocusHeatmapLayerStart({idLayer:t})}}const heatMapLayer=new HeatMapLayer;class BubbleLayer extends BaseOverlay{constructor(){super(),this.type="bubbleLayer",this.interfaceList=["addBubbleLayer","updateBubbleLayerCoord","updateBubbleLayerStyle"]}addBubbleLayer({id:e,fillArea:t}={},r){let n=this.getLayer(e);if(n)return void(r&&r({result:0,message:`失败，已存在 ${e} 气泡图。`}));let i=this.deepCopy(arguments[0]);n=this._convertLayer(i),this._drawLayer(n,r)}updateBubbleLayerCoord({id:e}={},t){let r=this.getLayer(e);if(!r)return void(t&&t({result:0,message:`失败，未找到 ${e} 气泡图。`}));let n=this.deepCopy(arguments[0]);this._convertLayer(n),this._drawLayer(r,t)}updateBubbleLayerStyle({id:e,fillArea:t}={},r){let n=this.getLayer(e);if(!n)return void(r&&r({result:0,message:`失败，未找到 ${e} 气泡图。`}));let i=this.deepCopy(arguments[0]);this._convertLayer(i),this._drawLayer(n,r)}_convertLayer({id:e,isAppend:t=!0}={}){let r=this.getLayer(e);if(r||(r=this.createLayer(e,arguments[0])),!t){r.source.data=[];for(const e of r.data)this.scene.removeDrawable(r.id,e.id);r.data=[]}return this._updateLayer(r,arguments[0]),this._updateData(r),r}_updateLayer(e,{name:t,coordType:r,coordTypeZ:n,fillArea:i,speed:a,radiusMax:o,radiusMin:s,valueMax:l,valueMin:c,legends:h=[],data:u=[]}={}){null!=t&&(e.source.name=t),null!=r&&(e.source.coordType=r),null!=n&&(e.source.coordTypeZ=n),null!=i&&(e.source.fillArea=i),null!=a&&(e.source.speed=a),null!=o&&(e.source.radiusMax=o),null!=s&&(e.source.radiusMin=s),null!=l&&(e.source.valueMax=l),null!=c&&(e.source.valueMin=c);for(const t of h){let r=e.source.legends.findIndex((e=>e.name==t.name));-1==r?e.source.legends.push(t):e.source.legends[r]=t}for(const t of u){let r=e.source.data.findIndex((e=>e.id===t.id));-1==r?e.source.data.push(t):e.source.data[r]=t}}_updateData(e){let t=0==e.source.coordType?"lla":"xyz";for(const r of e.source.data){let n=e.getData(r.id);n?n.setSource(r):n=this.createData(r.id,r,e);let i=e.source.legends.find((e=>e.name==n.source.type));i?(n.legend=i.name,n.color=i.color):(n.legend=void 0,n.color=void 0);let a=new Position(t);a.set(r.coord[0],r.coord[1],r.coordZ),n.positions=[a],n.value=this._getValueByRatio(e.source,r.value),n.speed=e.source.speed}}_getValueByRatio(e,t){let r=e.radiusMax,n=e.radiusMin,i=e.valueMax,a=e.valueMin,o=r-n,s=i-a;return 0==o||0==s?r:t<a?n:t>i?r:(t-a)*(o/s)+n}async _drawLayer(e,t){if(!this.scene)return;let r=[],n=!1,i=[];for(const t of e.data){if(null==t.legend){r.push(t.source.type),this.scene.removeDrawable(e.id,t.id);continue}let a={};a.name=t.id,a.position=t.positions[0],a.value=t.value,a.bubbleColor=t.color,a.animationSpeed=t.speed,a.isShow=e.isShow,i.push(a),n=n||t.inView}if(i.length>0){n?this.scene.updateInstancedBubble(e.id,{isShow:e.isShow,points:i,fillArea:e.source.fillArea||"none"}):await this.scene.addInstancedBubble(e.id,{isShow:e.isShow,points:i,fillArea:e.source.fillArea||"none"});for(const t of e.data)t.inView=!0}t&&t({result:1,message:"成功。"})}addSceneEventListener(e){"onBubbleLayerHover"!==e&&"onBubbleLayerUnhover"!==e||this.scene.tgapp.events[e].length<=0||this.scene.tgapp.events[e].length>1||("onBubbleLayerHover"===e&&this.scene.on("mousehover","drawable",this.onDrawableMouseHover),"onBubbleLayerUnhover"===e&&this.scene.on("unmousehover","drawable",this.onDrawableUnmouseHover))}removeSceneEventListener(e){"onBubbleLayerHover"!==e&&"onBubbleLayerUnhover"!==e||this.scene.tgapp.events[e].length>0||("onBubbleLayerHover"===e&&this.scene.off("mousehover","drawable",this.onDrawableMouseHover),"onBubbleLayerUnhover"===e&&this.scene.off("unmousehover","drawable",this.onDrawableUnmouseHover))}onMouseEvent({type:e,layer:t,data:r}={}){"click"==e&&r.parent.allowClickSelected?this.scene.tgapp.triggerEvent.onBubbleLayerClick({idObj:r.id,idLayer:t.id,selected:r.isSelected,label:r.label,type:r.source.type}):"hover"!=e?"unhover"!=e||this.scene.tgapp.triggerEvent.onBubbleLayerUnhover({idObj:r.id,idLayer:t.id}):this.scene.tgapp.triggerEvent.onBubbleLayerHover({idObj:r.id,idLayer:t.id})}onFocusEvent({type:e,layerId:t,dataId:r,legend:n}={}){"focusStart"!==e?"focusEnd"!==e?"focusAllStart"!==e?"focusAllEnd"!==e?"focusLayerStart"!==e?"focusLayerEnd"!==e?"focusLegendStart"!==e?"focusLegendEnd"!==e||this.scene.tgapp.triggerEvent.onFocusBubbleLayerLegendEnd({idLayer:t,legend:n}):this.scene.tgapp.triggerEvent.onFocusBubbleLayerLegendStart({idLayer:t,legend:n}):this.scene.tgapp.triggerEvent.onFocusBubbleLayerObjEnd({idLayer:t,idObj:r}):this.scene.tgapp.triggerEvent.onFocusBubbleLayerObjStart({idLayer:t,idObj:r}):this.scene.tgapp.triggerEvent.onFocusAllBubbleLayerEnd({}):this.scene.tgapp.triggerEvent.onFocusAllBubbleLayerStart({}):this.scene.tgapp.triggerEvent.onFocusBubbleLayerEnd({idLayer:t}):this.scene.tgapp.triggerEvent.onFocusBubbleLayerStart({idLayer:t})}}const bubbleLayer=new BubbleLayer;class Column3DLayer extends BaseOverlay{constructor(){super(),this.type="3DColumnLayer",this.interfaceList=["add3DColumnLayer","update3DColumnLayerCoord","update3DColumnLayerStyle"]}add3DColumnLayer({id:e,columnAlpha:t,columnPaint:r}={},n){let i=this.getLayer(e);if(i)return void(n&&n({result:0,message:`失败，已存在 ${e} 柱图。`}));if("number"!=typeof t||t<0||t>1)return void(n&&n({result:0,message:"失败，columnAlpha 属性值错误。"}));let a=this.deepCopy(arguments[0]);i=this._convertLayer(a),this._drawLayer(i,n)}update3DColumnLayerCoord({id:e}={},t){let r=this.getLayer(e);if(!r)return void(t&&t({result:0,message:`失败，未找到 ${e} 柱图。`}));let n=this.deepCopy(arguments[0]);this._convertLayer(n),this._drawLayer(r,t)}update3DColumnLayerStyle({id:e,columnAlpha:t,columnPaint:r}={},n){let i=this.getLayer(e);if(!i)return void(n&&n({result:0,message:`失败，未找到 ${e} 柱图。`}));if(null!=t&&("number"!=typeof t||t<0||t>1))return void(n&&n({result:0,message:"失败，columnAlpha 属性值错误。"}));let a=this.deepCopy(arguments[0]);i=this._convertLayer(a),this._drawLayer(i,n)}_convertLayer({id:e,isAppend:t=!0}={}){let r=this.getLayer(e);if(r||(r=this.createLayer(e,arguments[0])),!t){r.source.data=[];for(const e of r.data)this.scene.removeDrawable(r.id,e.id);r.data=[]}return this._updateLayer(r,arguments[0]),this._updateData(r),r}_updateLayer(e,{name:t,coordType:r,coordTypeZ:n,coordZ:i,columnType:a,columnMinHeight:o,columnMaxHeight:s,columnAlpha:l,columnPaint:c,columnGap:h,columnWidth:u,colorMax:d,colorMin:p,valueMax:f,valueMin:m,labelColor:g,labelBackgroundColor:y,legends:v=[],data:b=[]}={}){null!=t&&(e.source.name=t),null!=r&&(e.source.coordType=r),null!=n&&(e.source.coordTypeZ=n),null!=i&&(e.source.coordZ=i),null!=a&&(e.source.columnType=a),null!=o&&(e.source.columnMinHeight=o),null!=s&&(e.source.columnMaxHeight=s),null!=l&&(e.source.columnAlpha=l),null!=c&&(e.source.columnPaint=c),null!=h&&(e.source.columnGap=h),null!=u&&(e.source.columnWidth=u),null!=d&&(e.source.colorMax=d),null!=p&&(e.source.colorMin=p),null!=f&&(e.source.valueMax=f),null!=m&&(e.source.valueMin=m),null!=g&&(e.source.labelColor=g),null!=y&&(e.source.labelBackgroundColor=y);for(const t of b){let r=e.source.data.findIndex((e=>e.id===t.id));-1==r?e.source.data.push(t):e.source.data[r]=t}for(const t of v){let r=e.source.legends.findIndex((e=>e.name===t.name));-1==r?e.source.legends.push(t):e.source.legends[r]=t}}_updateData(e){this._maxWidth(e.source);for(const t of e.source.data){let r=e.getData(t.id);r?r.setSource(t):r=this.createData(t.id,t,e),r.positions=[r.source.position],r.value=this._getValueByRatio(e.source,r.source.value),"solid"===e.source.columnPaint||"linear"===e.source.columnPaint?r.color=this._getColorByRatio(e.source,r.source.value):"legend"===e.source.columnPaint&&(r.color=this._getColorByLegend(e.source,r.source.value)),void 0===r.enableLabel&&(r.enableLabel=!1),r.labelText=r.source.label,r.labelColor=e.source.labelColor,r.labelBackgroundColor=e.source.labelBackgroundColor,r.columnType="cube"==e.source.columnType?"矩形":"cylinder",r.columnAlpha=e.source.columnAlpha,r.columnWidth=e.source.columnWidth,r.columnPaint=e.source.columnPaint,r.colorMax=e.source.colorMax,r.colorMin=e.source.colorMin}}_maxWidth({coordType:e,coordZ:t,columnWidth:r,data:n}={}){let i=0==e?"lla":"xyz";for(const e of n)e.position=new Position(i),e.position.set(e.coord[0],e.coord[1],t);let a=r;for(const e of n)for(const t of n){if(e.id===t.id)continue;let r=this.scene.getDistanceByPositions(e.position,t.position);r<a&&(a=r)}arguments[0].maxWidth=a}_getValueByRatio(e,t){let r=e.columnMaxHeight,n=e.columnMinHeight,i=e.valueMax,a=e.valueMin,o=r-n,s=i-a;return 0==o||0==s?r:t<a?n:t>i?r:(t-a)*(o/s)+n}_getColorByLegend(e,t){let r=e.legends.find((e=>e.minValue<t&&e.maxValue>=t));return r?r.color:"#ffffff"}_getColorByRatio(e,t){let r=this._colorToRgba(e.colorMax),n=this._colorToRgba(e.colorMin),i=e.valueMax,a=e.valueMin;if(t<a)return"rgba("+n.join(",")+")";if(t>i)return"rgba("+r.join(",")+")";let o=(t-a)/(i-a),s=this._subtraction(r,n),l=this._multiplication(s,o);return"rgba("+this._multiply(n,l).join(",")+")"}_colorToRgba(e){var t=e.toLowerCase(),r=1;if(t&&/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{4}|[0-9a-fA-f]{6}|[0-9a-fA-f]{8})$/.test(t)){if(4===t.length||5===t.length){for(var n="#",i=1;i<t.length;i+=1)n+=t.slice(i,i+1).concat(t.slice(i,i+1));t=n}9===t.length&&(r=(parseInt("0x"+t.slice(7,9))/255).toFixed(2));var a=[];for(i=1;i<7;i+=2)a.push(parseInt("0x"+t.slice(i,i+2)));return[...a,r]}return t}_subtraction(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2],e[3]-t[3]]}_multiplication(e,t){return[Math.round(e[0]*t),Math.round(e[1]*t),Math.round(e[2]*t),Math.round(e[3]*t)]}_multiply(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2],e[3]+t[3]]}async _drawLayer(e,t){if(this.scene){for(const t of e.data){let r={};r.name=t.id,r.position=t.positions[0],r.value=t.value,r.color=t.color,r.barStyle=t.columnType,r.alpha=t.columnAlpha,r.widthRatio=t.columnWidth,r.label=t.enableLabel,r.labelText=t.labelText,r.labelColor=t.labelColor,r.labelBackground=t.labelBackgroundColor,r.isShow=e.isShow,r.columnPaint=t.columnPaint,r.colorMax=t.colorMax,r.colorMin=t.colorMin,t.inView?await this.scene.updateBar(e.id,t.id,r):(await this.scene.addBar(e.id,r),t.inView=!0)}t&&t({result:1,message:"成功。"})}}addSceneEventListener(e){"on3DColumnLayerHover"!==e&&"on3DColumnLayerUnhover"!==e||this.scene.tgapp.events[e].length<=0||this.scene.tgapp.events[e].length>1||("on3DColumnLayerHover"===e&&this.scene.on("mousehover","drawable",this.onDrawableMouseHover),"on3DColumnLayerUnhover"===e&&this.scene.on("unmousehover","drawable",this.onDrawableUnmouseHover))}removeSceneEventListener(e){"on3DColumnLayerHover"!==e&&"on3DColumnLayerUnhover"!==e||this.scene.tgapp.events[e].length>0||("on3DColumnLayerHover"===e&&this.scene.off("mousehover","drawable",this.onDrawableMouseHover),"on3DColumnLayerUnhover"===e&&this.scene.off("unmousehover","drawable",this.onDrawableUnmouseHover))}onMouseEvent({type:e,layer:t,data:r,event:n}={}){if("click"==e&&r.parent.allowClickSelected&&(this.scene.tgapp.triggerEvent.on3DColumnLayerClick({idObj:r.id,idLayer:t.id,selected:r.isSelected,coord:[n.longitude,n.latitude],label:r.label,type:r.source.type}),r.labelText)){for(const e of t.data)e!==r&&!0===e.enableLabel&&(e.enableLabel=!e.enableLabel,this.scene.updateBar(t.id,e.id,{label:e.enableLabel}));r.enableLabel=!r.enableLabel,this.scene.updateBar(t.id,r.id,{label:r.enableLabel})}"hover"==e&&this.scene.tgapp.triggerEvent.on3DColumnLayerHover({idObj:r.id,idLayer:t.id,coord:[n.longitude,n.latitude]}),"unhover"==e&&this.scene.tgapp.triggerEvent.on3DColumnLayerUnhover({idObj:r.id,idLayer:t.id})}onFocusEvent({type:e,layerId:t}={}){"focusStart"!==e?"focusEnd"!==e?"focusAllStart"!==e?"focusAllEnd"!==e||this.scene.tgapp.triggerEvent.onFocusAll3DColumnLayerEnd({}):this.scene.tgapp.triggerEvent.onFocusAll3DColumnLayerStart({}):this.scene.tgapp.triggerEvent.onFocus3DColumnLayerEnd({idLayer:t}):this.scene.tgapp.triggerEvent.onFocus3DColumnLayerStart({idLayer:t})}}const column3DLayer=new Column3DLayer;class TrailLayer extends BaseOverlay{constructor(){super(),this.type="trailLayer",this.interfaceList=["addTrailLayer","updateTrailLayerCoord","updateTrailLayerStyle"],this.objLifeTimer=null}setScene(e){super.setScene(e),null!==this.objLifeTimer&&clearInterval(this.objLifeTimer),this.objLifeTimer=setInterval(this._objLifeTest.bind(this),1e3)}_objLifeTest(){if(!this.layers||this.layers.length<=0)return;let e=new Date;for(let t=this.layers.length-1;t>=0;t--){const r=this.layers[t];if(void 0===r)continue;if(!r.data||r.data.length<=0){this.scene.removeLayer(r.id),this.layers.splice(t,1);continue}for(let t=r.data.length-1;t>=0;t--){const n=r.data[t];if(!n.timestamp)continue;if((e-n.timestamp-1e3)/1e3>=r.source.objLife){let e=r.source.data.findIndex((e=>e.id===n.id));r.source.data.splice(e,1),r.data.splice(t,1),this.scene.removeDrawable(r.id,n.id)}}}}addTrailLayer({id:e,trackStyle:t}={},r){let n=this.getLayer(e);if("style001"!==t)return void(r&&r({result:0,message:"失败，trackStyle 属性值错误。"}));if(n)return void(r&&r({result:0,message:`失败，已存在 ${e} 轨迹图。`}));let i=this.deepCopy(arguments[0]);n=this._convertLayer(i),this._drawLayer(n,r)}updateTrailLayerCoord({id:e,isAppend:t=!0}={},r){let n=this.getLayer(e);if(!n)return void(r&&r({result:0,message:`失败，未找到 ${e} 轨迹图。`}));let i=this.deepCopy(arguments[0]);i.dataAppend=t,this._convertLayer(i),this._drawLayer(n,r)}updateTrailLayerStyle({id:e,trackStyle:t,isAppend:r=!0}={},n){let i=this.getLayer(e);if("style001"!==t&&void 0!==t)return void(n&&n({result:0,message:"失败，trackStyle 属性值错误。"}));if(!i)return void(n&&n({result:0,message:`失败，未找到 ${e} 轨迹图。`}));let a=this.deepCopy(arguments[0]);a.legendAppend=r,this._convertLayer(a),this._drawLayer(i,n)}_convertLayer({id:e,dataAppend:t=!0,legendAppend:r=!0}={}){let n=this.getLayer(e);if(n||(n=this.createLayer(e,arguments[0])),!t){n.source.data=[];for(const e of n.data)this.scene.removeDrawable(n.id,e.id);n.data=[]}if(!r){n.source.legends=[];for(const e of n.data)this.scene.removeDrawable(n.id,e.id);n.data=[]}return this._updateLayer(n,arguments[0]),this._updateData(n),n}_updateLayer(e,{name:t,coordType:r,coordTypeZ:n,trackStyle:i,trackDuration:a,trackWidth:o,objLife:s,time:l,legends:c=[],data:h=[]}={}){null!=t&&(e.source.name=t),null!=r&&(e.source.coordType=r),null!=n&&(e.source.coordTypeZ=n),null!=i&&(e.source.trackStyle=i),null!=a&&(e.source.trackDuration=a),null!=o&&(e.source.trackWidth=o),null!=s&&(e.source.objLife=s),null!=l&&(e.source.time=l);for(const t of c){let r=e.source.legends.findIndex((e=>e.name==t.name));-1==r?e.source.legends.push(t):e.source.legends[r]=t}for(const t of h){let r=e.source.data.findIndex((e=>e.id===t.id));-1==r?e.source.data.push(t):e.source.data[r]=t}}_updateData(e){let t=0==e.source.coordType?"lla":"xyz";for(const r of e.source.data){let n=e.getData(r.id);n?n.setSource(r):n=this.createData(r.id,r,e);let i=e.source.legends.find((e=>e.name==n.source.type));i?(n.legend=i.name,n.trackColor=i.trackColor,n.iconName=i.iconName):(n.legend=void 0,n.trackColor=void 0,n.iconName=void 0);let a=new Position(t);a.set(n.source.coord[0],n.source.coord[1],n.source.coordZ),n.positions=[a],n.label=n.source.label,n.trackDuration=e.source.trackDuration,n.trackWidth=e.source.trackWidth,n.time=e.source.duration||1}}async _drawLayer(e,t){if(!this.scene)return;let r=[],n=[];for(const t of e.data){if(null==t.legend){r.push(t.source.type),this.scene.removeDrawable(e.id,t.id);continue}if(!this.isContain_IconAsset(t.iconName)){n.push(t.iconName),this.scene.removeDrawable(e.id,t.id);continue}let i=await this.getIconAsset(t.iconName);if(i.labelText=t.label,i.label=!!t.label,i.useIconAsset){let e=this.getIconAssetInfo(i.iconAssetName);i.icon=e.map,i.background=e.param.background,i.backgroundColor=e.param.backgroundColor,i.height=e.param.height,i.width=e.param.width,i.offsetV=e.param.offsetV,i.offsetH=e.param.offsetH,i.iconXOffset=e.param.offsetV,i.iconYOffset=e.param.offsetH,i.labelFontFamily=e.textParam.fontFamily,i.labelFontSize=e.textParam.fontSize,i.labelFontBold=e.textParam.fontBold,i.label=!!i.labelText,i.labelEnableItalic=e.textParam.enableItalic,i.labelBackground=e.textParam.background,i.labelColor=e.textParam.color,i.labelXOffset=e.textParam.offsetV,i.labelYOffset=-e.textParam.offsetH}i.name=t.id,i.position=t.positions[0],i.duration=t.trackDuration,i.lineWidth=t.trackWidth,i.color=t.trackColor,i.travelingTime=t.time,i.zLevel=e.zLevel,t.inView?await this.scene.updateTrail(e.id,t.id,i):(await this.scene.addTrail(e.id,i),t.inView=!0),e.isShow?overlays[this.type].showLayer(e.id):overlays[this.type].hideLayer(e.id),t.timestamp=new Date}if(t)if(n.length>0||r.length>0){let e="错误，";r.length>0&&(e+=`图例 ${r.join("、")} 不存在。`),n.length>0&&(e+=`图标 ${n.join("、")} 不存在。`),t({result:1,message:e})}else t({result:1,message:"成功。"})}addSceneEventListener(e){"onTrailLayerHover"!==e&&"onTrailLayerUnhover"!==e||this.scene.tgapp.events[e].length<=0||this.scene.tgapp.events[e].length>1||("onTrailLayerHover"===e&&this.scene.on("mousehover","drawable",this.onDrawableMouseHover),"onTrailLayerUnhover"===e&&this.scene.on("unmousehover","drawable",this.onDrawableUnmouseHover))}removeSceneEventListener(e){"onTrailLayerHover"!==e&&"onTrailLayerUnhover"!==e||this.scene.tgapp.events[e].length>0||("onTrailLayerHover"===e&&this.scene.off("mousehover","drawable",this.onDrawableMouseHover),"onTrailLayerUnhover"===e&&this.scene.off("unmousehover","drawable",this.onDrawableUnmouseHover))}onMouseEvent({type:e,layer:t,data:r}={}){"click"==e&&r.parent.allowClickSelected?this.scene.tgapp.triggerEvent.onTrailLayerClick({idObj:r.id,idLayer:t.id,selected:r.isSelected,label:r.label,type:r.source.type}):"hover"!=e?"unhover"!=e||this.scene.tgapp.triggerEvent.onTrailLayerUnhover({idObj:r.id,idLayer:t.id}):this.scene.tgapp.triggerEvent.onTrailLayerHover({idObj:r.id,idLayer:t.id})}onFocusEvent({type:e,layerId:t,dataId:r,legend:n}={}){"focusStart"!==e?"focusEnd"!==e?"focusAllStart"!==e?"focusAllEnd"!==e?"focusLayerStart"!==e?"focusLayerEnd"!==e?"focusLegendStart"!==e?"focusLegendEnd"!==e||this.scene.tgapp.triggerEvent.onFocusTrailLayerLegendEnd({idLayer:t,legend:n}):this.scene.tgapp.triggerEvent.onFocusTrailLayerLegendStart({idLayer:t,legend:n}):this.scene.tgapp.triggerEvent.onFocusTrailLayerObjEnd({idLayer:t,idObj:r}):this.scene.tgapp.triggerEvent.onFocusTrailLayerObjStart({idLayer:t,idObj:r}):this.scene.tgapp.triggerEvent.onFocusAllTrailLayerEnd({}):this.scene.tgapp.triggerEvent.onFocusAllTrailLayerStart({}):this.scene.tgapp.triggerEvent.onFocusTrailLayerEnd({idLayer:t}):this.scene.tgapp.triggerEvent.onFocusTrailLayerStart({idLayer:t})}}const trailLayer=new TrailLayer;class ODLineLayer extends BaseOverlay{constructor(){super(),this.type="ODLineLayer",this.interfaceList=["addODLineLayer","updateODLineLayerCoord","updateODLineLayerStyle"]}addODLineLayer({id:e,lineSpeed:t,curvature:r}={},n){let i=this.getLayer(e);if(i)return void(n&&n({result:0,message:`失败，已存在 ${e} 关系图。`}));if("number"!=typeof t||t<0)return void(n&&n({result:0,message:"失败，lineSpeed 属性值错误。"}));if(r>1||r<0)return void(n&&n({result:0,message:"失败，curvature 属性值错误。"}));let a=this.deepCopy(arguments[0]);i=this._convertLayer(a),this._drawLayer(i,n),this.dispatchEvent({type:"addODLineLayer",layer:i})}updateODLineLayerCoord({id:e,isAppend:t=!0}={},r){let n=this.getLayer(e);if(!n)return void(r&&r({result:0,message:`失败，未找到 ${e} 关系图。`}));let i=this.deepCopy(arguments[0]);i.dataAppend=t,this._convertLayer(i),this._drawLayer(n,r),this.dispatchEvent({type:"updateODLineLayerCoord",layer:n})}updateODLineLayerStyle({id:e,lineSpeed:t,curvature:r,isAppend:n=!0}={},i){let a=this.getLayer(e);if(!a)return void(i&&i({result:0,message:`失败，未找到 ${e} 气泡图。`}));if("number"!=typeof t||t<0)return void(i&&i({result:0,message:"失败，lineSpeed 属性值错误。"}));if(r>1||r<0)return void(i&&i({result:0,message:"失败，curvature 属性值错误。"}));let o=this.deepCopy(arguments[0]);o.legendAppend=n,this._convertLayer(o),this._drawLayer(a,i),this.dispatchEvent({type:"updateODLineLayerStyle",layer:a})}_convertLayer({id:e,dataAppend:t=!0,legendAppend:r=!0}={}){let n=this.getLayer(e);return n||(n=this.createLayer(e,arguments[0])),t||(n.source.data=[],this.scene.removeLayer(n.id),n.data=[]),r||(n.source.legends=[],this.scene.removeLayer(n.id),n.data=[]),this._updateLayer(n,arguments[0]),this._updateData(n),n}_updateLayer(e,{name:t,coordType:r,coordTypeZ:n,valueMax:i,valueMin:a,isShowBubble:o,bubbleRadiusMax:s,bubbleRadiusMin:l,bubbleSpeed:c,lineWidthMax:h,lineWidthMin:u,lineSpeed:d,curvature:p,legends:f=[],data:m=[]}={}){null!=t&&(e.source.name=t),null!=r&&(e.source.coordType=r),null!=n&&(e.source.coordTypeZ=n),null!=i&&(e.source.valueMax=i),null!=a&&(e.source.valueMin=a),null!=o&&(e.source.isShowBubble=o),null!=s&&(e.source.bubbleRadiusMax=s),null!=l&&(e.source.bubbleRadiusMin=l),null!=c&&(e.source.bubbleSpeed=c),null!=h&&(e.source.lineWidthMax=h),null!=u&&(e.source.lineWidthMin=u),null!=d&&(e.source.lineSpeed=d),null!=p&&(e.source.curvature=p);for(const t of f){let r=e.source.legends.findIndex((e=>e.name==t.name));-1==r?e.source.legends.push(t):e.source.legends[r]=t}for(const t of m){let r=e.source.data.findIndex((e=>e.id===t.id));-1==r?e.source.data.push(t):e.source.data[r]=t}}_updateData(e){let t=0==e.source.coordType?"lla":"xyz";for(const r of e.source.data){let n=e.getData(r.id);n?n.setSource(r):n=this.createData(r.id,r,e);let i=e.source.legends.find((e=>e.name==n.source.type));i?(n.legend=i.name,n.lineColor=i.lineColor,n.type=i.type,n.bubbleColor=i.bubbleColor,n.labelColor=i.labelColor,n.labelBackgroundColor=i.labelBackgroundColor):(n.legend=void 0,n.lineColor=void 0,n.type=void 0,n.bubbleColor=void 0,n.labelColor=void 0,n.labelBackgroundColor=void 0);let a=new Position(t);a.set(n.source.startCoord[0],n.source.startCoord[1],n.source.startCoordZ);let o=new Position(t);o.set(n.source.targetCoord[0],n.source.targetCoord[1],n.source.targetCoordZ),n.positions=[a,o],n.lineSpeed=e.source.lineSpeed,n.curvature=e.source.curvature,n.bubbleSpeed=e.source.bubbleSpeed,n.lineWidth=this._getLineWidthByRatio(e.source,n.source.value),n.value=this._getBubbleRadiusByRatio(e.source,n.source.value),n.isShowBubble=e.source.isShowBubble,n.label=n.source.label}}_getLineWidthByRatio(e,t){let r=e.lineWidthMax,n=e.lineWidthMin,i=e.valueMax,a=e.valueMin,o=r-n,s=i-a;return 0==o||0==s?r:t<a?n:t>i?r:(t-a)*(o/s)+n}_getBubbleRadiusByRatio(e,t){let r=e.bubbleRadiusMax,n=e.bubbleRadiusMin,i=e.valueMax,a=e.valueMin,o=r-n,s=i-a;return 0==o||0==s?r:t<a?n:t>i?r:(t-a)*(o/s)+n}async _drawLayer(e,t){if(!this.scene)return;let r=[],n=!1,i=!1;const a=[],o=[],s=[];for(const t of e.data){if(null==t.legend){r.push(t.source.type),this.scene.removeDrawable(e.id,t.id),this.scene.removeDrawable(e.id,t.id+"-start"),this.scene.removeDrawable(e.id,t.id+"-end");continue}i=i||!!t.inView;const l={};l.name=t.id,l.startPos=t.positions[0],l.endPos=t.positions[1],l.color=t.lineColor,l.animationSpeed=t.lineSpeed,l.curvatureCoefficient=50*t.curvature,l.imageType=t.type.toLowerCase(),l.lineWidth=t.lineWidth,l.label=!!t.label,l.labelText=t.label,l.labelBackground=t.labelBackgroundColor,l.labelColor=t.labelColor,l.sizeAttenuation=!1,l.isShow=e.isShow,t.inView?o.push(l):(a.push(l),t.inView=!0);const c={};c.name=t.id+"-start",c.position=t.positions[0],c.value=t.value,c.bubbleColor=t.bubbleColor,c.animationSpeed=t.bubbleSpeed,c.isShow=e.isShow&&t.isShowBubble;const h={};h.name=t.id+"-end",h.position=t.positions[1],h.value=t.value,h.bubbleColor=t.bubbleColor,h.animationSpeed=t.bubbleSpeed,h.isShow=e.isShow&&t.isShowBubble,s.push(c,h),n=c.isShow&&h.isShow}s.length>0&&(i?await this.scene.updateInstancedBubble(e.id,{isShow:n,points:s}):await this.scene.addInstancedBubble(e.id,{isShow:n,points:s}));for(const t of a)await this.scene.addODLine(e.id,t);for(const t of o)await this.scene.updateODLine(e.id,t.name,t);t&&t({result:1,message:"成功。"})}addSceneEventListener(e){"onODLineLayerHover"!==e&&"onODLineLayerUnhover"!==e||this.scene.tgapp.events[e].length<=0||this.scene.tgapp.events[e].length>1||("onODLineLayerHover"===e&&this.scene.on("mousehover","drawable",this.onDrawableMouseHover),"onODLineLayerUnhover"===e&&this.scene.on("unmousehover","drawable",this.onDrawableUnmouseHover))}removeSceneEventListener(e){"onODLineLayerHover"!==e&&"onODLineLayerUnhover"!==e||this.scene.tgapp.events[e].length>0||("onODLineLayerHover"===e&&this.scene.off("mousehover","drawable",this.onDrawableMouseHover),"onODLineLayerUnhover"===e&&this.scene.off("unmousehover","drawable",this.onDrawableUnmouseHover))}_onDrawableMouseEvent(e,t,r){if(!r)return;let n=this.layers.find((e=>e.id==r.parent));if(!n)return;let i=n.data.find((e=>{let t=e.id,n=e.id+"-start",i=e.id+"-end";return t==r.name||n===r.name||i===r.name}));i&&(this.onMouseSelection(e,i),"click"==e&&i.parent.allowClickSelected?this.scene.tgapp.triggerEvent.onODLineLayerClick({idObj:i.id,idLayer:n.id,selected:i.isSelected,label:i.label,type:i.source.type}):"hover"!=e?"unhover"!=e||this.scene.tgapp.triggerEvent.onODLineLayerUnhover({idObj:i.id,idLayer:n.id}):this.scene.tgapp.triggerEvent.onODLineLayerHover({idObj:i.id,idLayer:n.id}))}onFocusEvent({type:e,layerId:t,dataId:r,legend:n}={}){"focusStart"!==e?"focusEnd"!==e?"focusAllStart"!==e?"focusAllEnd"!==e?"focusLayerStart"!==e?"focusLayerEnd"!==e?"focusLegendStart"!==e?"focusLegendEnd"!==e||this.scene.tgapp.triggerEvent.onFocusODLineLayerLegendEnd({idLayer:t,legend:n}):this.scene.tgapp.triggerEvent.onFocusODLineLayerLegendStart({idLayer:t,legend:n}):this.scene.tgapp.triggerEvent.onFocusODLineLayerObjEnd({idLayer:t,idObj:r}):this.scene.tgapp.triggerEvent.onFocusODLineLayerobjStart({idLayer:t,idObj:r}):this.scene.tgapp.triggerEvent.onFocusAllODLineLayerEnd({}):this.scene.tgapp.triggerEvent.onFocusAllODLineLayerStart({}):this.scene.tgapp.triggerEvent.onFocusODLineLayerEnd({idLayer:t}):this.scene.tgapp.triggerEvent.onFocusODLineLayerStart({idLayer:t})}}const odLineLayer=new ODLineLayer;class Marker3D extends BaseOverlay{constructor(){super(),this.type="3DMarker",this.interfaceList=["add3DMarker","update3DMarkerCoord","update3DMarkerStyle"]}add3DMarker({id:e,type:t,coordType:r,alpha:n,coord:i,coordZ:a}={},o){"explosion"===t&&(t="explosion01");let s=this.getLayer(e),l=this.getMarkerAsset(t);if(n>1||n<0)return void(o&&o({result:0,message:"失败，alpha 属性值错误。"}));if(s)return void(o&&o({result:0,message:`失败，已存在 ${e} 特效。`}));if(!l)return void(o&&o({result:0,message:`失败，不存在 ${t} 特效类型。`}));if(!0===l.isExplosion){let e=0==r?"lla":"xyz";const t=new Position(e);t.set(i[0],i[1],a),"xyz"===e&&t.set(i[0],a,i[1]);const n=arguments[0];return void this.scene.addExplosion({position:t,url:l.url,loop:void 0===n.loop?l.loop:n.loop,autoPlay:void 0===n.autoPlay?l.autoPlay:n.autoPlay,depthTest:void 0===n.depthTest?l.depthTest:n.depthTest,destroyOnFinish:void 0===n.destroyOnFinish?l.destroyOnFinish:n.destroyOnFinish,scale:n.scale||l.scale,duration:n.duration||l.duration,dimension:n.dimension||l.dimension,center:n.center||l.center,fadeOutFrame:n.fadeOutFrame||l.fadeOutFrame,rotation:n.rotation||l.rotation},(()=>o&&o({result:1,message:"成功。"})))}let c=this.deepCopy(arguments[0]);c.asset=l,s=this._convertLayer(c),this._drawLayer(s,o)}update3DMarkerCoord({id:e}={},t){let r=this.getLayer(e);if(!r)return void(t&&t({result:0,message:`失败，未找到 ${e} 特效。`}));let n=this.deepCopy(arguments[0]);r=this._convertLayer(n),this._drawLayer(r,t)}update3DMarkerStyle({id:e,alpha:t,type:r}={},n){let i=this.getLayer(e),a=this.getMarkerAsset(r);if(void 0!==t&&(t>1||t<0))return void(n&&n({result:0,message:"失败，alpha 属性值错误。"}));if(!i)return void(n&&n({result:0,message:`失败，未找到 ${e} 特效。`}));if(!a)return void(n&&n({result:0,message:`失败，不存在 ${r} 特效类型。`}));let o=this.deepCopy(arguments[0]);o.asset=a,i=this._convertLayer(o),this._drawLayer(i,n)}_convertLayer({id:e,coordType:t,coordTypeZ:r,alpha:n,scale:i,type:a,titleText:o,titleColor:s,titleBackgroundColor:l,coord:c,coordZ:h,asset:u}={}){let d=this.getLayer(e);d||(d=this.createLayer(e,arguments[0])),null!=t&&(d.source.coordType=t),null!=r&&(d.source.coordTypeZ=r),null!=n&&(d.source.alpha=n),null!=i&&(d.source.scale=i),null!=a&&(d.source.type=a),null!=o&&(d.source.titleText=o),null!=s&&(d.source.titleColor=s),null!=l&&(d.source.titleBackgroundColor=l),null!=c&&(d.source.coord=c),null!=h&&(d.source.coordZ=h),null!=u&&(d.source.asset=u);let p=d.getData(e);p?p.setSource(d.source):p=this.createData(e,d.source,d);let f=0==p.source.coordType?"lla":"xyz",m=new Position(f);return m.set(p.source.coord[0],p.source.coord[1],p.source.coordZ),p.positions=[m],p.asset=p.source.asset,p.alpha=p.source.alpha,p.scale=p.source.scale,p.titleText=p.source.titleText,p.titleColor=p.source.titleColor,p.titleBackgroundColor=p.source.titleBackgroundColor,d}async _drawLayer(e,t){if(this.scene){for(const t of e.data){let r={};Object.assign(r,t.asset),r.name=t.id,r.opacity=t.alpha,r.size=t.scale,r.position=t.positions[0],r.titleText=t.titleText,r.titleColor=t.titleColor,r.titleBackgroundColor=t.titleBackgroundColor,r.isShow=e.isShow,t.inView?await this.scene.update3DMarker(r):(await this.scene.add3DMarker(r),t.inView=!0)}t&&t({result:1,message:"成功。"})}}addSceneEventListener(e){"on3DMarkerHover"!==e&&"on3DMarkerUnhover"!==e||this.scene.tgapp.events[e].length<=0||this.scene.tgapp.events[e].length>1||("on3DMarkerHover"===e&&this.scene.on("mousehover","drawable",this.onDrawableMouseHover),"on3DMarkerUnhover"===e&&this.scene.on("unmousehover","drawable",this.onDrawableUnmouseHover))}removeSceneEventListener(e){"on3DMarkerHover"!==e&&"on3DMarkerUnhover"!==e||this.scene.tgapp.events[e].length>0||("on3DMarkerHover"===e&&this.scene.off("mousehover","drawable",this.onDrawableMouseHover),"on3DMarkerUnhover"===e&&this.scene.off("unmousehover","drawable",this.onDrawableUnmouseHover))}onMouseEvent({type:e,layer:t,data:r}={}){"click"==e&&r.parent.allowClickSelected?this.scene.tgapp.triggerEvent.on3DMarkerClick({id:r.id,selected:r.isSelected,label:r.label,type:r.source.type}):"hover"!=e?"unhover"!=e||this.scene.tgapp.triggerEvent.on3DMarkerUnhover({id:r.id}):this.scene.tgapp.triggerEvent.on3DMarkerHover({id:r.id})}onFocusEvent({type:e,layerId:t}={}){"focusStart"!==e?"focusEnd"!==e?"focusAllStart"!==e?"focusAllEnd"!==e||this.scene.tgapp.triggerEvent.onFocusAll3DMarkerEnd({}):this.scene.tgapp.triggerEvent.onFocusAll3DMarkerStart({}):this.scene.tgapp.triggerEvent.onFocus3DMarkerEnd({id:t}):this.scene.tgapp.triggerEvent.onFocus3DMarkerStart({id:t})}showLayer(e){return!!this.getLayer(e)&&(this.scene.show3DMarker(e),this.dispatchEvent({type:"showLayer",layerIds:[e]}),!0)}hideLayer(e){return!!this.getLayer(e)&&(this.scene.hide3DMarker(e),this.dispatchEvent({type:"hideLayer",layerIds:[e]}),!0)}showAllLayer(){let e=[];for(const t of this.layers)this.scene.show3DMarker(t.id),e.push(t.id);return this.dispatchEvent({type:"showLayer",layerIds:e}),!0}hideAllLayer(){let e=[];for(const t of this.layers)this.scene.hide3DMarker(t.id),e.push(t.id);return this.dispatchEvent({type:"hideLayer",layerIds:e}),!0}removeLayer(e){let t=this.layers.findIndex((t=>t.id==e));return-1!=t&&(this.layers.splice(t,1),this.scene.remove3DMarker(e),this.dispatchEvent({type:"removeLayer",layerIds:[e]}),!0)}removeAllLayer(){if(this.layers.length<=0)return!1;let e=[];for(const t of this.layers)this.scene.remove3DMarker(t.id),e.push(t.id);return this.layers=[],this.dispatchEvent({type:"removeLayer",layerIds:e}),!0}}const marker3D=new Marker3D;class Controllor extends BaseComponent{constructor(){super(),this.type="Controllor",this.interfaceList=["showObjectAxis","setOverlayVisibility","setOverlayTypeVisibility","removeOverlay","clearOverlayType","addOverlayTip","removeOverlayTip","getOverlaysByType","getOverlaysByLayer","getOverlaysOrder","moveOverlayForward","moveOverlayBackward","selectOverlay","endSelectOverlay","pickOverlay","endPickOverlay","clickOverlay","clickOverlayType","clearOverlaySelected"],this.selectOverlayParam=null}setScene(e){super.setScene(e),this.selectOverlayParam=null}showObjectAxis({idLayer:e,id:t,axisType:r}={},n){if(""!==t&&void 0!==t||(t=e),"transform"===r)this.scene.transformDrawable(e,t);else{if("none"!==r)return void(n&&n({result:0,message:`失败，${r} 类型暂未实现。`}));this.scene.untransformDrawable()}n&&n({result:1,message:"成功。"})}setOverlayVisibility({overlayType:e,visible:t,id:r}={},n){if(!overlays[e])return void(n&&n({result:0,message:`失败，不存在 ${e} 覆盖物类型。`}));let i=!1;i=t?overlays[e].showLayer(r):overlays[e].hideLayer(r),n&&n(i?{result:1,message:"成功。"}:{result:0,message:`失败，未找到 ${r} 覆盖物。`})}setOverlayTypeVisibility({overlayType:e,visible:t}={},r){overlays[e]?(t?overlays[e].showAllLayer():overlays[e].hideAllLayer(),r&&r({result:1,message:"成功。"})):r&&r({result:0,message:`失败，不存在 ${e} 覆盖物类型。`})}removeOverlay({id:e,overlayType:t}={},r){if(!overlays[t])return void(r&&r({result:0,message:`失败，不存在 ${t} 覆盖物类型。`}));let n=overlays[t].removeLayer(e);r&&r(n?{result:1,message:"成功。"}:{result:0,message:`失败，未找到 ${e} 覆盖物。`})}clearOverlayType({overlayType:e}={},t){if("all"==e)for(const e in overlays)overlays[e].removeAllLayer();else{if(!overlays[e])return void(t&&t({result:0,message:`失败，不存在 ${e} 覆盖物类型。`}));if(!overlays[e].removeAllLayer())return void t({result:0,message:`失败，未找到 ${e} 类型覆盖物。`})}t&&t({result:1,message:"成功。"})}addOverlayTip({id:e,overlayType:t,url:r,divId:n,isShowClose:i,size:a,offset:o}={},s){if(!overlays[t])return void(s&&s({result:0,message:`失败，不存在 ${t} 覆盖物类型。`}));let l=overlays[t].getLayerByDataId(e);if(!l)return void(s&&s({result:0,message:`失败，未找到 ${t} 类型的 ${e} 绘制物。`}));if(""==r&&""==n)return void(s&&s({result:0,message:"参数url和divId不能同时为空!"}));if(""!=n&&!document.getElementById(n))return void(s&&s({result:0,message:`${n}不存在!`}));let c={};c.url=r,c.divId=n,c.isShowClose=i,c.size=a,c.offset=o,c.layer=l.id,c.id=e,this.scene.addOverlayTip(c,((e,t)=>{s&&s(e?{result:1,message:"成功。"}:{result:0,message:`失败。${t}`})}))}removeOverlayTip({id:e,overlayType:t}={},r){if(!overlays[t])return void(r&&r({result:0,message:`失败，不存在 ${t} 覆盖物类型。`}));let n=overlays[t].getLayerByDataId(e);if(n){let e=this.deepCopy(arguments[0]);return e.layer=n.id,void this.scene.removeOverlayTip(e,r)}r&&r({result:0,message:`失败，未找到 ${t} 类型的 ${e} 绘制物。`})}getOverlaysByType({overlayType:e}={},t){if(!overlays[e])return void(t&&t({result:0,message:`失败，不存在 ${e} 覆盖物类型。`}));let r=overlays[e].getLayers(),n=[];for(const e of r)for(const t of e.data)n.push({id:t.id,name:t.name||""});t&&t({result:1,message:"成功。",type:e,data:n})}getOverlaysByLayer({idLayer:e,layerType:t}={},r){if(!overlays[t])return void(r&&r({result:0,message:`失败，不存在 ${t} 类型覆盖物。`}));let n=overlays[t].getLayer(e);if(!n)return void(r&&r({result:0,message:`失败，不存在 ${e} 覆盖物。`}));let i=[];for(const e of n.data)i.push({id:e.id});r&&r({result:1,message:"成功。",type:t,data:i})}getOverlaysOrder({}={},e){let t=[];for(let e of this.scene.getLayers())t.push({id:e.name,zLevel:e.zLevel});t.sort(((e,t)=>e.zLevel-t.zLevel)),t.filter(((e,t)=>{e.index=t+1,delete e.zLevel})),e&&e({result:1,message:"成功。",data:t})}moveOverlayForward({idLayer:e,offset:t}={},r){if("number"!=typeof t||t<0)return void(r&&r({result:0,message:`失败，offset（偏移量）${t} 无效，取值应当为数字，且大于等于零。`}));let n=[];for(let e of this.scene.getLayers())n.push({id:e.name,zLevel:e.zLevel});n.sort(((e,t)=>e.zLevel-t.zLevel)),n.filter(((e,t)=>{e.index=t+1}));let i,a=n.find((t=>t.id===e));if(!a)return void(r&&r({result:0,message:`失败，不存在 ${e} 覆盖物。`}));let o=a.index+t;i=o>=n.length||0===t?(n[n.length-1].zLevel+Math.floor(n[n.length-1].zLevel+1))/2:(n[o-1].zLevel+n[o].zLevel)/2,this.scene.getLayer(e).updateZLevel(i)?r&&r({result:1,message:"成功。"}):r&&r({result:0,message:`失败，前移 ${e} 时发生未知错误。`})}moveOverlayBackward({idLayer:e,offset:t}={},r){if("number"!=typeof t||t<0)return void(r&&r({result:0,message:`失败，offset（偏移量）${t} 无效，取值应当为数字，且大于等于零。`}));let n=[];for(let e of this.scene.getLayers())n.push({id:e.name,zLevel:e.zLevel});n.sort(((e,t)=>e.zLevel-t.zLevel)),n.filter(((e,t)=>{e.index=t+1}));let i,a=n.find((t=>t.id===e));if(!a)return void(r&&r({result:0,message:`失败，不存在 ${e} 覆盖物。`}));let o=a.index-t;i=o<=1||0===t?(n[0].zLevel+Math.ceil(n[0].zLevel-1))/2:(n[o-2].zLevel+n[o-1].zLevel)/2,this.scene.getLayer(e).updateZLevel(i)?r&&r({result:1,message:"成功。"}):r&&r({result:0,message:`失败，后移 ${e} 时发生未知错误。`})}pickOverlay({overlayType:e,idLayer:t,type:r,isShowDecorator:n}={},i){""===r&&(r=void 0),""===t&&(t=void 0),"click"===r||"hover"===r?overlays[e]?(overlays[e].openMouseSelection(t,r,n),i&&i({result:1,message:"成功。"})):i&&i({result:0,message:`失败。不存在 ${e} 类型的绘制物。`}):i&&i({result:0,message:"失败。type 属性值错误。"})}endPickOverlay({overlayType:e,idLayer:t,type:r}={},n){if(""===r&&(r=void 0),""===t&&(t=void 0),""===e&&(e=void 0),"click"===r||"hover"===r||void 0===r)if(null==e||overlays[e]){if(void 0===e)for(const e in overlays)overlays[e].closeMouseSelection(t,r);else overlays[e].closeMouseSelection(t,r);n&&n({result:1,message:"成功。"})}else n&&n({result:0,message:`失败。不存在 ${e} 类型的绘制物。`});else n&&n({result:0,message:"失败。type 属性值错误。"})}clickOverlay({id:e,overlayType:t,idLayer:r,selected:n}={},i){let a,o;""===r&&(r=void 0),void 0===r&&(r=e),overlays[t]?(a=overlays[t].getLayer(r),a?(o=a.data.find((t=>t.id==e)),o?(overlays[t].selectionData([o],n),i&&i({result:1,message:"成功。"})):i&&i({result:0,message:`失败，不存在 ${e} ID的覆盖物。`})):i&&i({result:0,message:`失败，不存在 ${r} ID的覆盖物。`})):i&&i({result:0,message:`失败，不存在 ${t} 覆盖物类型。`})}clickOverlayType({overlayType:e,idLayer:t,selected:r}={},n){if(""===t&&(t=void 0),!overlays[e])return void(n&&n({result:0,message:`失败，不存在 ${e} 覆盖物类型。`}));let i=[];if(t){let r=overlays[e].getLayer(t);r&&i.push(...r.data)}else for(const t of overlays[e].getLayers())i.push(...t.data);overlays[e].selectionData(i,r),this.scene.tgapp.triggerEvent.onClickOverlayTypeResult({type:e,selected:r,data:i.map((e=>({id:e.id})))}),n&&n({result:1,message:"成功。"})}clearOverlaySelected({},e){for(const e in overlays){let t=[];for(const r of overlays[e].getLayers())t.push(...r.data);overlays[e].selectionData(t,!1)}e&&e({result:1,message:"成功。"})}selectOverlay({type:e,overlayType:t}={},r){overlays[t]?"rect"===e||"circle"===e||"polygon"===e?(this.selectOverlayParam=this.deepCopy(arguments[0]),this.scene.selectOverlay({type:e},(e=>{let t=this.selectOverlayParam.overlayType,r=e.filter((e=>!!overlays[t].getLayer(e.parent)));null!=this.selectOverlayParam.idLayer&&(r=r.filter((e=>e.parent==this.selectOverlayParam.idLayer)));let n=[];for(const e of r){let r=overlays[t].getLayer(e.parent);n.push(r.getData(e.name))}overlays[t].selectionData(n,!0),r={type:t,data:r.map((e=>({id:e.name})))},"rect"==this.selectOverlayParam.type&&this.scene.tgapp.triggerEvent.onRectOverlaySelectionResult(r),"circle"==this.selectOverlayParam.type&&this.scene.tgapp.triggerEvent.onCircleOverlaySelectionResult(r),"polygon"==this.selectOverlayParam.type&&this.scene.tgapp.triggerEvent.onPolygonOverlaySelectionResult(r)})),r&&r({result:1,message:"成功。"})):r&&r({result:0,message:`失败，不存在 ${e} 选择类型。`}):r&&r({result:0,message:`失败，不存在 ${t} 覆盖物类型。`})}endSelectOverlay({},e){this.scene.endSelectOverlay(),this.selectOverlayParam=null,e&&e({result:1,message:"成功。"})}}const controllor=new Controllor;class Agg extends BaseComponent{constructor(){super(),this.type="Agg",this.interfaceList=["addAggData","updateAggData","countAggData","searchDataByPoint","searchDataByArea","searchDataByPath","removeAggData","removeAllAggData"],this.serverHost="http://127.0.0.1:9696/V3.1"}addAggData(e,t){this.postRequest("addAggData",e,(({code:e,message:r})=>{1===e?t&&t({result:1,message:"成功。"}):t&&t({result:0,message:`失败，${r}`})}))}updateAggData(e,t){this.postRequest("updateAggData",e,(({code:e,message:r})=>{1===e?t&&t({result:1,message:"成功。"}):t&&t({result:0,message:`失败，${r}`})}))}countAggData({id:e},t){this.getRequest(`countAggData/${e}`,(({code:e,message:r,data:n})=>{1===e?t&&t({result:1,message:"成功。",count:n}):t&&t({result:0,message:`失败，${r}`})}))}searchDataByPoint(e,t){this.postRequest("searchDataByPoint",e,(({code:e,message:r,data:n})=>{1===e?t&&t({result:1,message:"成功。",data:n}):t&&t({result:0,message:`失败，${r}`})}))}searchDataByArea(e,t){this.postRequest("searchDataByArea",e,(({code:e,message:r,data:n})=>{1===e?t&&t({result:1,message:"成功。",data:n}):t&&t({result:0,message:`失败，${r}`})}))}searchDataByPath(e,t){this.postRequest("searchDataByPath",e,(({code:e,message:r,data:n})=>{1===e?t&&t({result:1,message:"成功。",data:n}):t&&t({result:0,message:`失败，${r}`})}))}removeAggData(e,t){this.postRequest("removeAggData",e,(({code:e,message:r,data:n})=>{1===e?t&&t({result:1,message:"成功。",data:n}):t&&t({result:0,message:`失败，${r}`})}))}removeAllAggData({id:e},t){let r=`removeAllAggData/${e}`;this.deleteRequest(r,(({code:e,message:r,data:n})=>{1===e?t&&t({result:1,message:"成功。",count:n}):t&&t({result:0,message:`失败，${r}`})}))}postRequest(e,t,r){return new Promise((n=>{let i=new XMLHttpRequest;i.open("post",`${this.serverHost}/${e}`,!0),i.setRequestHeader("Content-Type","application/json"),i.onreadystatechange=()=>{4===i.readyState&&(200==i.status||204==i.status||304==i.status?(r&&r(JSON.parse(i.responseText)),n(JSON.parse(i.responseText))):(r&&r({code:0,message:"服务连接超时！"}),n()))},i.send(JSON.stringify(t))}))}getRequest(e,t){return new Promise((r=>{let n=new XMLHttpRequest;n.open("get",`${this.serverHost}/${e}`,!0),n.onreadystatechange=()=>{4===n.readyState&&(200==n.status||204==n.status||304==n.status?(t&&t(JSON.parse(n.responseText)),r(JSON.parse(n.responseText))):(t&&t({code:0,message:"服务连接超时！"}),r()))},n.send()}))}deleteRequest(e,t){return new Promise((r=>{let n=new XMLHttpRequest;n.open("delete",`${this.serverHost}/${e}`,!0),n.onreadystatechange=()=>{4===n.readyState&&(200==n.status||204==n.status||304==n.status?(t&&t(JSON.parse(n.responseText)),r(JSON.parse(n.responseText))):(t&&t({code:0,message:"服务连接超时！"}),r()))},n.send()}))}}const agg=new Agg;class AggLandmarkLayer extends BaseOverlay{constructor(){super(),this.type="aggLandmarkLayer",this.interfaceList=["addAggLandmarkLayer","updateAggLandmarkLayerStyle"]}setScene(e){super.setScene(e),this._registerMouseEvent()}addAggLandmarkLayer({id:e,aggDataId:t,aggRadius:r,aggType:n}={},i){let a=this.getLayer(e);if(a)return void(i&&i({result:0,message:`失败，已存在 ${e} 聚合地标图。`}));let o=this.deepCopy(arguments[0]);a=this.createLayer(e,o),agg.postRequest("AddAggLayerData",{aggDataId:t,aggRadius:r,aggType:n},(({code:e,message:t})=>{1===e?this._updateLayer(a,i):i&&i({result:0,message:`失败，${t}`})}))}updateAggLandmarkLayerStyle({id:e,iconName:t,clusters:r}={},n){let i=this.getLayer(e);i?(void 0!==t&&(i.source.iconName=t),void 0!==r&&(i.source.clusters=r),this._updateLayer(i,n)):n&&n({result:0,message:`失败，未找到 ${e} 聚合地标图。`})}_registerMouseEvent(){this.scene.domElement.addEventListener("pointerdown",(()=>{this._isPress=!0})),document.addEventListener("pointerup",(()=>{this._isPress&&this._onMouseUp()}))}_onMouseUp(){if(this._isPress=!1,!controllor.selectOverlayParam)for(const e of this.getLayers())this._updateLayer(e)}async _updateLayer(e,t){let r=await agg.postRequest("queryAggLandmarkLayer",{aggDataId:e.source.aggDataId,aggRadius:e.source.aggRadius,aggType:e.source.aggType,maxCount:e.source.drawMax,range:this.getSceneRange(),mapLevel:this.getMapLevelByResolution()});r?1===r.code?(this._updateData(e,r.data),this._drawLayer(e,t)):t&&t({result:0,message:`失败，${r.message}`}):t&&t({result:0,message:"失败，服务连接超时。"})}_updateData(e,t){for(const t of e.data)this.scene.removeDrawable(e.id,t.id);e.data=[];for(const r of t){let t=new Position("lla");t.set(r.coord[0],r.coord[1],e.source.coordZ),r.isCluster&&(t.alt=r.coordZ);let n=e.source.iconName,i=1;if(r.isCluster){let t=e.source.clusters.find((e=>{let t=r.label>=e.value_range_min,n=r.label<=e.value_range_max;return t&&n}));t&&(n=t.clustersIcon),t&&(i=t.size)}let a=this.createData(r.id,r,e);a.positions=[t],a.iconName=n,a.scale=i/10,a.label=r.label}}async _drawLayer(e,t){let r=[];for(const t of e.data){if(!this.isContain_IconAsset(t.iconName)){r.push(t.iconName);continue}let n=await this.getIconAsset(t.iconName);n.name=t.id,n.position=t.positions[0],n.label=!!t.label,n.labelText=t.label,n.isShow=e.isShow,n.width*=t.scale,n.height*=t.scale,await this.scene.addLandmark(e.id,n),t.inView=!0}t&&(r.length>0?t({result:1,message:`错误，图标 ${r.join("、")} 不存在。`}):t({result:1,message:"成功。"}))}}const aggLandmarkLayer=new AggLandmarkLayer;class EventLayer extends BaseOverlay{constructor(){super(),this.type="eventLayer",this.interfaceList=["addEventLayer","updateEventLayerCoord","updateEventLayerStyle"]}addEventLayer({id:e}={},t){if(this.getLayer(e))return void(t&&t({result:0,message:`失败，已存在 ${e} 事件图。`}));let r=this.deepCopy(arguments[0]),n=this.#convertLayer(r);this.#drawLayer(n,t)}updateEventLayerCoord({id:e}={},t){if(!this.getLayer(e))return void(t&&t({result:0,message:`失败，未找到 ${e} 事件图。`}));let r=this.deepCopy(arguments[0]),n=this.#convertLayer(r);this.#drawLayer(n,t)}updateEventLayerStyle({id:e}={},t){if(!this.getLayer(e))return void(t&&t({result:0,message:`失败，未找到 ${e} 事件图。`}));let r=this.deepCopy(arguments[0]),n=this.#convertLayer(r);this.#drawLayer(n,t)}#convertLayer({id:e,isAppend:t=!0}={}){let r=this.getLayer(e);return r||(r=this.createLayer(e,arguments[0])),!0!==t&&(r.source.areas=[],r.data.forEach((e=>this.scene.removeDrawable(r.id,e.id))),r.data=[]),this.#updateLayer(r,arguments[0]),this.#updateData(r),r}#updateLayer(e,{name:t,coordType:r,coordTypeZ:n,legends:i=[],data:a=[]}={}){null!=t&&(e.source.name=t),null!=r&&(e.source.coordType=r),null!=n&&(e.source.coordTypeZ=n);for(const t of i){let r=e.source.legends.findIndex((e=>e.name==t.name));-1==r?e.source.legends.push(t):e.source.legends[r]=t}for(const t of a){let r=e.source.data.findIndex((e=>e.id==t.id));-1==r?e.source.data.push(t):e.source.data[r]=t}}#updateData(e){let t=0==e.source.coordType?"lla":"xyz";for(const r of e.source.data){let n=e.data.find((e=>e.id==r.id));n?n.setSource(r):n=this.createData(r.id,r,e);const i=new Position(t);i.set(r.coord[0],r.coord[1],r.coordZ),"xyz"===t&&i.set(r.coord[0],r.coordZ,r.coord[1]),n.positions=[i];let a=e.source.legends.find((e=>e.name==n.source.type));a?(n.legend=a.name,n.icon=a.icon,n.type=a.type,n.color=a.color,n.fillArea=a.fillArea,n.speed=a.speed,n.radius=a.radius):(n.legend=void 0,n.icon=void 0,n.type=void 0,n.color=void 0,n.fillArea=void 0,n.speed=void 0,n.radius=void 0),n.message=n.source.message}}async#drawLayer(e,t){if(!this.scene)return;let r=[],n=[];const i=[];let a=!1;for(const t of e.data){if(null==t.legend){r.push(t.source.type);continue}if(!this.isContain_IconAsset(t.icon)){n.push(t.icon);continue}a=a||t.inView;let o=await this.getIconAsset(t.icon);o.name=t.id,o.position=t.positions[0],o.label=!!t.message,o.labelText=t.message,o.isShow=e.isShow,o.zLevel=e.zLevel,t.inView?await this.scene.updateLandmark(e.id,t.id,o):(await this.scene.addLandmark(e.id,o),t.inView=!0);let s={};s.name=t.id,s.position=t.positions[0],s.value=t.radius,s.bubbleColor=t.color,s.animationSpeed=t.speed,s.isShow=e.isShow,i.push(s)}i.length>0&&(a?this.scene.updateInstancedBubble(e.id,{isShow:e.isShow,points:i}):await this.scene.addInstancedBubble(e.id,{isShow:e.isShow,points:i})),t&&t({result:1,message:"成功。"})}addSceneEventListener(e){"onEventLayerHover"!==e&&"onEventLayerUnhover"!==e||this.scene.tgapp.events[e].length<=0||this.scene.tgapp.events[e].length>1||("onEventLayerHover"===e&&this.scene.on("mousehover","drawable",this.onDrawableMouseHover),"onEventLayerUnhover"===e&&this.scene.on("unmousehover","drawable",this.onDrawableUnmouseHover))}removeSceneEventListener(e){"onEventLayerHover"!==e&&"onEventLayerUnhover"!==e||this.scene.tgapp.events[e].length>0||("onEventLayerHover"===e&&this.scene.off("mousehover","drawable",this.onDrawableMouseHover),"onEventLayerUnhover"===e&&this.scene.off("unmousehover","drawable",this.onDrawableUnmouseHover))}onMouseEvent({type:e,layer:t,data:r}={}){"click"==e&&r.parent.allowClickSelected&&this.scene.tgapp.triggerEvent.onEventLayerClick({idObj:r.id,idLayer:t.id,selected:r.isSelected}),"hover"==e&&this.scene.tgapp.triggerEvent.onEventLayerHover({idObj:r.id,idLayer:t.id}),"unhover"==e&&this.scene.tgapp.triggerEvent.onEventLayerUnhover({idObj:r.id,idLayer:t.id})}onFocusEvent({type:e,layerId:t,dataId:r,legend:n}={}){"focusStart"!==e?"focusEnd"!==e?"focusAllStart"!==e?"focusAllEnd"!==e?"focusLayerStart"!==e?"focusLayerEnd"!==e?"focusLegendStart"!==e?"focusLegendEnd"!==e||this.scene.tgapp.triggerEvent.onFocusEventLayerLegendEnd({idLayer:t,legend:n}):this.scene.tgapp.triggerEvent.onFocusEventLayerLegendStart({idLayer:t,legend:n}):this.scene.tgapp.triggerEvent.onFocusEventLayerObjEnd({idLayer:t,idObj:r}):this.scene.tgapp.triggerEvent.onFocusEventLayerObjStart({idLayer:t,idObj:r}):this.scene.tgapp.triggerEvent.onFocusAllEventLayerEnd({}):this.scene.tgapp.triggerEvent.onFocusAllEventLayerStart({}):this.scene.tgapp.triggerEvent.onFocusEventLayerEnd({idLayer:t}):this.scene.tgapp.triggerEvent.onFocusEventLayerStart({idLayer:t})}}const eventLayer=new EventLayer,overlays=[];overlays[landmark.type]=landmark,overlays[path.type]=path,overlays[area.type]=area,overlays[landmarkLayer.type]=landmarkLayer,overlays[roadSgHeatLayer.type]=roadSgHeatLayer,overlays[typeAreaLayer.type]=typeAreaLayer,overlays[roadPtHeatLayer.type]=roadPtHeatLayer,overlays[colorAreaLayer.type]=colorAreaLayer,overlays[circularArea.type]=circularArea,overlays[grid3DLayer.type]=grid3DLayer,overlays[heatMapLayer.type]=heatMapLayer,overlays[bubbleLayer.type]=bubbleLayer,overlays[column3DLayer.type]=column3DLayer,overlays[trailLayer.type]=trailLayer,overlays[odLineLayer.type]=odLineLayer,overlays[marker3D.type]=marker3D,overlays[eventLayer.type]=eventLayer,overlays[aggLandmarkLayer.type]=aggLandmarkLayer;class Focus extends BaseComponent{constructor(){super(),this.type="focus",this.interfaceList=["focusById","focusByType","focusByLayer","focusByLegend","focusModel","focusModelByType","focusFloor","focusRoom","focusBuilding"]}focusById({id:e,overlayType:t,distance:r}={},n){if(!overlays[t])return void(n&&n({result:0,message:`失败，不存在 ${t} 类型覆盖物。`}));let i=overlays[t].getLayer(e);if(!i)return void(n&&n({result:0,message:`失败，不存在 ${e} 覆盖物。`}));let a=i.getPositions();if(0==a.length)return void(n&&n({result:0,message:"失败，未找到覆盖物。"}));overlays[t].onFocusEvent({type:"focusStart",layerId:e});let{center:o}=this._boxVisualCalc(a),s=new Camera$1({target:o,posture:[0,-45,0],distance:r});this.scene.setCamera(s,.5,(()=>{overlays[t].onFocusEvent({type:"focusEnd",layerId:e})})),n&&n({result:1,message:"成功。"})}focusByType({overlayType:e}={},t){if(!overlays[e])return void(t&&t({result:0,message:`失败，不存在 ${e} 类型覆盖物。`}));let r=[],n=overlays[e].getLayers();for(const e of n)r.push(...e.getPositions());if(0==r.length)return void(t&&t({result:0,message:"失败，未找到覆盖物。"}));overlays[e].onFocusEvent({type:"focusAllStart"});let{center:i,distance:a}=this._boxVisualCalc(r),o=new Camera$1({target:i,posture:[0,-45,0],distance:a});this.scene.setCamera(o,0,(()=>{overlays[e].onFocusEvent({type:"focusAllEnd"})})),t&&t({result:1,message:"成功。"})}focusByLayer({id:e,idLayer:t,layerType:r,distance:n}={},i){if(!overlays[r])return void(i&&i({result:0,message:`失败，不存在 ${r} 类型覆盖物。`}));let a=overlays[r].getLayer(t);if(!a)return void(i&&i({result:0,message:`失败，不存在 ${t} 覆盖物图层。`}));let o=a.getPositionsByDataId(e);if(0==o.length)return void(i&&i({result:0,message:"失败，未找到覆盖物。"}));overlays[r].onFocusEvent({type:"focusLayerStart",layerId:t,dataId:e});let{center:s}=this._boxVisualCalc(o),l=new Camera$1({target:s,posture:[0,-45,0],distance:n});this.scene.setCamera(l,0,(()=>{overlays[r].onFocusEvent({type:"focusLayerEnd",layerId:t,dataId:e})})),i&&i({result:1,message:"成功。"})}focusByLegend({legend:e,idLayer:t,layerType:r}={},n){if(!overlays[r])return void(n&&n({result:0,message:`失败，不存在 ${r} 类型覆盖物。`}));let i=overlays[r].getLayer(t);if(!i)return void(n&&n({result:0,message:`失败，不存在 ${t} 覆盖物图层。`}));let a=i.getPositionsByLegend(e);if(0==a.length)return void(n&&n({result:0,message:"失败，未找到覆盖物。"}));overlays[r].onFocusEvent({type:"focusLegendStart",layerId:t,legend:e});let{center:o,distance:s}=this._boxVisualCalc(a),l=new Camera$1({target:o,posture:[0,-45,0],distance:s});this.scene.setCamera(l,0,(()=>{overlays[r].onFocusEvent({type:"focusLegendEnd",layerId:t,legend:e})})),n&&n({result:1,message:"成功。"})}focusModel({id:e,modelType:t,distance:r},n){let i=t.toLowerCase();if("model"==i)i="ModelItem";else{if("building"!=i)return void(n&&n({result:0,message:`失败，不支持 ${t} 类型。`}));i="BuildingItem"}let a={id:e},o=this.scene.getSceneObjects().find((t=>t.name==e));o&&o.type===i?(this.scene.tgapp.triggerEvent.onFocusModelStart&&this.scene.tgapp.triggerEvent.onFocusModelStart(a),this.scene.setCameraToModel(o.name,0,{distance:r}),this.scene.tgapp.triggerEvent.onFocusModelEnd&&this.scene.tgapp.triggerEvent.onFocusModelEnd(a),n&&n({result:1,message:"成功。"})):n&&n({result:0,message:`失败，未找到 ${t} 类型的 ${e}。`})}focusModelByType({modelType:e},t){let r=e.toLowerCase();if("model"==r)r="ModelItem";else{if("building"!=r)return void(t&&t({result:0,message:`失败，不支持 ${e} 类型。`}));r="BuildingItem"}let n=this.scene.getSceneObjects();n=n.filter((e=>e.type==r));let i=[];if(n.map((e=>{let t=this.scene.getModelBox(e.name);i.push((new Position).set(t.max.x,t.max.y,t.max.z)),i.push((new Position).set(t.min.x,t.min.y,t.min.z))})),0==i.length)return void(t&&t({result:0,message:"失败，未找到模型。"}));"ModelItem"===r?this.scene.tgapp.triggerEvent.onFocusAllModelStart&&this.scene.tgapp.triggerEvent.onFocusAllModelStart({}):"BuildingItem"===r&&this.scene.tgapp.triggerEvent.onFocusAllBuildingStart&&this.scene.tgapp.triggerEvent.onFocusAllBuildingStart({});let{center:a,distance:o}=this._boxVisualCalc(i),s=new Camera$1({target:a,posture:[0,-45,0],distance:o});this.scene.setCamera(s,0),"ModelItem"===r?this.scene.tgapp.triggerEvent.onFocusAllModelEnd&&this.scene.tgapp.triggerEvent.onFocusAllModelEnd({}):"BuildingItem"===r&&this.scene.tgapp.triggerEvent.onFocusAllBuildingEnd&&this.scene.tgapp.triggerEvent.onFocusAllBuildingEnd({}),t&&t({result:1,message:"成功。"})}focusBuilding(e,t){if(!e)return void(t&&t({result:0,message:"参数异常"}));let r=this.scene.getSceneObjects().find((t=>t.name==e.buildingId&&"BuildingItem"==t.type));if(!r)return void(t&&t({result:0,message:`失败，未找到id为的${e.buildingId}建筑。`}));let n={id:e.buildingId};this.scene.tgapp.triggerEvent.onFocusBuildingStart&&this.scene.tgapp.triggerEvent.onFocusBuildingStart(n),this.scene.setCameraToModel(r.name,0,{distance:e.distance}),this.scene.tgapp.triggerEvent.onFocusBuildingEnd&&this.scene.tgapp.triggerEvent.onFocusBuildingEnd(n),t&&t({result:1,message:"成功。"})}focusFloor(e,t){this.scene.focusFloor(e,t,{onFocusFloorStart:this.scene.tgapp.triggerEvent.onFocusFloorStart,onFocusFloorEnd:this.scene.tgapp.triggerEvent.onFocusFloorEnd})}focusRoom(e,t){t&&t({result:0,message:"工程师小哥努力实现中..."})}_boxVisualCalc(e){for(let t of e)if("lla"===t.type){let e=this.scene.convertLLAToXYZ(t);t.x=e.x,t.y=e.y,t.z=e.z}let t=e[0],r=100;if(1!=e.length){let n=e.sort(((e,t)=>e.x-t.x)),i=(n[0].x+n[n.length-1].x)/2,a=n[0].x,o=e.sort(((e,t)=>e.y-t.y)),s=(o[0].y+o[o.length-1].y)/2,l=o[0].y,c=e.sort(((e,t)=>e.z-t.z)),h=(c[0].z+c[c.length-1].z)/2,u=c[0].z;t=(new Position).set(i,s,h);let d=(new Position).set(a,l,u);r=this.scene.getDistanceByPositions(t,d)/this.scene.getWorldScale(),r<100&&(r=100)}return{center:t,distance:3*r}}}const focus=new Focus;class Other extends BaseComponent{constructor(){super(),this.type="Other",this.interfaceList=["getStates","switchState","setEnvTime","setEnvWeather","takeSnapshot","getScenesInfo","showSceneInfo","setResolution","getAppInfo","addWatermark","removeWatermark","setLogMode","setCompass","setSceneEffect"]}getStates({},e){let t=this.scene.getStates();e&&e({result:1,message:"成功。",states:t})}switchState(e,t){null==e.duration&&(e.duration=1),this.scene.switchState(e.name,((e,r)=>{e?t&&t({result:1,message:"成功。"}):t&&t({result:0,message:`失败，${r}`})}),this.scene.tgapp.triggerEvent.onStateChanged)}setEnvTime(e,t){let r=this.scene.setEnvTime(e);t&&t({result:r.result,message:0===r.result?r.message:"成功。"})}setEnvWeather({envWeather:e},t){this.scene.removeRain("lightrain"),this.scene.removeRain("lightsnow"),this.scene.removeRain("moderaterain"),this.scene.removeRain("moderatesnow"),this.scene.removeRain("heavyrain"),this.scene.removeRain("heavysnow");let r=e.toLowerCase(),n=10,i=100,a="snow";switch(r){case"lightrain":n=5,i=16e3,a="rain";break;case"lightsnow":n=3,i=1e4;break;case"moderaterain":n=10,i=2e4,a="rain";break;case"moderatesnow":n=5,i=16e3;break;case"heavyrain":n=15,i=5e4,a="rain";break;case"heavysnow":n=10,i=2e4;break;case"sunny":return void(t&&t({result:1,message:"成功。"}));default:return void(t&&t({result:0,message:`失败，天气 ${e} 暂不支持。`}))}this.scene.setWeather({name:r,size:n,density:i,type:a,direction:0,followCamera:!0,typeOnly:!0},t)}async getScenesInfo({},e){let t={result:1,message:"成功。",mode:"scene",scenes:{}};t.scenes.name=this.scene.getSceneName(),t.scenes.default=!0,t.scenes.url=this.scene.tgapp.url,t.scenes.token=this.scene.tgapp.token;let r=await this.scene.getSceneIconAssets();t.customIcons=r.map((e=>({name:`custom-${e.name}`,url:"",bitmap:e.src}))),e&&e(t)}getAppInfo({},e){e&&e({result:1,message:"成功。",tgApiSdkVer:"3.2",tgApiDocUrl:"https://www.tuguan.net/doc/tg-api/",sceneSdkVer:"3.2.1",clientWidth:this.scene.tgapp.container.scrollWidth,clientHeight:this.scene.tgapp.container.scrollHeight})}showSceneInfo({isOpen:e=!1},t){this.scene.showFPSPanel(e),t&&t({result:1,message:"成功。"})}async addWatermark(e,t){if(e.scale<.01||e.scale>100)return void(t&&t({result:0,message:"失败，scale 属性值错误。"}));if(e.alpha<0||e.alpha>1)return void(t&&t({result:0,message:"失败，alpha 属性值错误。"}));let r=await this.scene.addWatermark(e.watermarkId,e);1===r.result?t&&t({result:1,message:"成功。"}):t&&t({result:0,message:`失败，${r.message}`})}async removeWatermark(e,t){let r=await this.scene.removeWatermark(e.watermarkId);1===r.result?t&&t({result:1,message:"成功。"}):t&&t({result:0,message:`失败，${r.message}`})}takeSnapshot({width:e,height:t,encoder:r}={},n){let i=this.scene.takeSnapshot(e,t,r);n&&n({result:1,message:"成功。",snapshot:i})}setResolution(e,t){e.width>this.scene.tgapp.container.scrollWidth&&(e.width=this.scene.tgapp.container.scrollWidth),e.height>this.scene.tgapp.container.scrollHeight&&(e.height=this.scene.tgapp.container.scrollHeight-4),this.scene.setResolution(e),this.scene.tgapp.triggerEvent.onResolutionChange({width:e.width,height:e.height}),t&&t({result:1,message:"成功。"})}setLogMode({mode:e=!1},t){debug(e),t&&t({result:1,message:"成功。"})}async setCompass(e,t){await this.scene.setCompass(e),t&&t({result:1,message:"成功。"})}setSceneEffect(e,t){this.scene.setSceneEffect(e),t&&t({result:1,message:"成功。"})}}const other=new Other;class Datum extends BaseComponent{constructor(){super(),this.type="Datum",this.interfaceList=["getBaseCenter","setBaseCenter","getDefaultBaseCenter","resetDefaultBaseCenter"],this.defaultDatum=null,this.currentOrigin=null}setScene(e){super.setScene(e),this.defaultDatum=this.scene.getDatumShiftModel(),this.currentOrigin=this._getDefaultOrigin()}getBaseCenter({},e){this.defaultDatum?e&&e({result:1,message:"成功。",...this.currentOrigin}):e&&e({result:0,message:"失败，没有基准设置。"})}setBaseCenter({originLon:e,originLat:t,originHeight:r},n){if(!this.defaultDatum)return void(n&&n({result:0,message:"失败，没有基准设置。"}));let i=JSON.parse(JSON.stringify(this.defaultDatum));if("mercator"===i.type){let n=this._lonLatToWebMercator(e,t);i.lon=-n.x,i.lat=n.y,i.alt=-r}else i.lon=e,i.lat=t,i.alt=r;this.currentOrigin.originLon=e,this.currentOrigin.originLat=t,this.currentOrigin.originHeight=r,this.scene.setDatumShiftModel(i),n&&n({result:1,message:"成功。"})}getDefaultBaseCenter({},e){this.defaultDatum?e&&e({result:1,message:"成功。",...this._getDefaultOrigin()}):e&&e({result:0,message:"失败，没有基准设置。"})}resetDefaultBaseCenter({},e){this.defaultDatum?(this.currentOrigin=this._getDefaultOrigin(),this.scene.setDatumShiftModel(this.defaultDatum),e&&e({result:1,message:"成功。"})):e&&e({result:0,message:"失败，没有基准设置。"})}_getDefaultOrigin(){let e={originLon:0,originLat:0,originHeight:0};return this.defaultDatum?("surface"===this.defaultDatum.type?(e.originLon=this.defaultDatum.lon,e.originLat=this.defaultDatum.lat,e.originHeight=this.defaultDatum.alt):"mercator"===this.defaultDatum.type&&(e.originLon=this.defaultDatum.origin[0],e.originLat=this.defaultDatum.origin[1],e.originHeight=-this.defaultDatum.alt),e):e}_lonLatToWebMercator(e,t){if("number"!=typeof e||"number"!=typeof t)return{x:0,y:0};let r=20037508.34*e/180,n=Math.log(Math.tan((90+t)*Math.PI/360))/(Math.PI/180);return n=20037508.34*n/180,{x:r,y:n}}}const datum=new Datum;class Models extends BaseComponent{constructor(){super(),this.type="Models",this.interfaceList=["getModelsByType","setModelTransform","setModelTransform2","setModelCoord","setModelStyle","setModelVisibility","showBuildingFloor","resetBuildingFloor","addModelTip","removeModelTip","rotatingModel","setModelRotationState","blinkingModel","setModelBlinkState","movingModel","setModelMoveState","pathingModel","setModelPathingState","selectModel","endSelectModel","pickModel","endPickModel","clickModel","clickModelType","clearModelSelected","getModelArticulation","setModelArticulation","getModelAnimation","setModelAnimation","playModelAnimation","highlightBuilding","highlightFloor","highlightRoom","getBuildings","addModel","removeModel"]}selectModelObj={};selectBuildingObj={};setScene(e){super.setScene(e),this.scene.on("click","model",((e,t)=>this._onModelMouseClick(e,t))),this.scene.on("click","building",((e,t)=>this._onBuildingMouseClick(e,t)))}addSceneEventListener(e){if("onModelHover"===e||"onModelUnhover"===e){if(this.scene.tgapp.events[e].length<=0)return;if(this.scene.tgapp.events[e].length>1)return;"onModelHover"===e&&this.scene.on("mousehover","drawable",this.onModelMouseHover),"onModelUnhover"===e&&this.scene.on("unmousehover","drawable",this.unModelMouseHover)}if("onBuildingHover"!==e&&"onFloorHover"!==e&&"onBuildingUnhover"!==e&&"onFloorUnhover"!==e){if("onBuildingHover"===e||"onFloorHover"===e){if(this.scene.tgapp.events.onBuildingHover.length>1)return;if(this.scene.tgapp.events.onBuildingHover.length>1)return;if(1===this.scene.tgapp.events.onBuildingHover.length&&1===this.scene.tgapp.events.onBuildingHover.length)return}"onBuildingHover"!==e&&"onFloorHover"!==e||this.scene.on("mousehover","drawable",this.onBuildingMouseHover),"onBuildingUnhover"!==e&&"onFloorUnhover"!==e||this.scene.on("unmousehover","drawable",this.unBuildingMouseHover)}}removeSceneEventListener(e){if("onModelHover"===e||"onModelUnhover"===e){if(this.scene.tgapp.events[e].length<=0)return;if(this.scene.tgapp.events[e].length>1)return;"onModelHover"===e&&this.scene.off("mousehover","drawable",this.onModelMouseHover),"onModelUnhover"===e&&this.scene.off("unmousehover","drawable",this.unModelMouseHover)}if("onBuildingHover"!==e&&"onFloorHover"!==e&&"onBuildingUnhover"!==e&&"onFloorUnhover"!==e){if("onBuildingHover"===e||"onFloorHover"===e){if(this.scene.tgapp.events.onBuildingHover.length>1)return;if(this.scene.tgapp.events.onBuildingHover.length>1)return;if(1===this.scene.tgapp.events.onBuildingHover.length&&1===this.scene.tgapp.events.onBuildingHover.length)return}"onBuildingHover"!==e&&"onFloorHover"!==e||this.scene.off("mousehover","drawable",this.onBuildingMouseHover),"onBuildingUnhover"!==e&&"onFloorUnhover"!==e||this.scene.off("unmousehover","drawable",this.unBuildingMouseHover)}}_onModelMouseClick(e,t){if(this.scene.tgapp.events.onModelClick.length>0||this.scene.tgapp.oldEvents.onModelClick){let e=!0;this.selectModelObj&&t._name==this.selectModelObj.id&&(e=!this.selectModelObj.selected),this.scene.clickModel({id:t._name,modelType:t.type,selected:e});let r={id:t._name,selected:e};this.selectModelObj=r,this.scene.tgapp.triggerEvent.onModelClick(r)}}_onModelMouseHover(e,t){this.scene.tgapp.triggerEvent.onModelHover({id:t.name})}onModelMouseHover=this._onModelMouseHover.bind(this);_unModelMouseHover(e,t){this.scene.tgapp.triggerEvent.onModelUnhover({id:t.name})}unModelMouseHover=this._unModelMouseHover.bind(this);_onBuildingMouseClick(e,t){if(this.scene.tgapp.events.onBuildingClick.length>0||this.scene.tgapp.oldEvents.onBuildingClick){let e=!0;this.selectBuildingObj&&t.name==this.selectBuildingObj.id&&(e=!this.selectBuildingObj.selected),this.scene.clickModel({id:t.name,modelType:t.type,selected:e});let r={id:t.name,selected:e};this.selectBuildingObj=r,"Buildingtem"===t.selectedType?this.scene.tgapp.triggerEvent.onBuildingClick(r):"BuildingFloorItem"===t.selectedType&&this.scene.tgapp.triggerEvent.onFloorClick(r)}}_onBuildingMouseHover(e,t){"Buildingtem"===t.selectedType?this.scene.tgapp.triggerEvent.onBuildingHover({id:t.name}):"BuildingFloorItem"===t.selectedType&&this.scene.tgapp.triggerEvent.onFloorHover({id:t.name})}onBuildingMouseHover=this._onBuildingMouseHover.bind(this);_unBuildingMouseHover(e,t){("Buildingtem"===t.selectedType||"BuildingFloorItem"===t.selectedType)&&this.scene.tgapp.triggerEvent.onFloorUnhover({id:t.name})}unBuildingMouseHover=this._unBuildingMouseHover.bind(this);getModelsByType({modelType:e},t){let r=e.toLowerCase();if("model"==r)r="ModelItem";else if("building"==r)r="BuildingItem";else{if("icon"!=r)return void(t&&t({result:0,message:`失败，未找到 ${e} 类型的模型。`}));r="IconAsset"}let n={type:e},i=this.scene.getSceneObjects();i=i.filter((e=>e.type==r)),n=i.map((e=>({id:e.name,isVisible:e.isVisible}))),t&&t({result:1,message:"成功。",type:e,data:n})}setModelTransform(e,t){let r={},n=0==e.coordType?"lla":"xyz";if(r.position=new Position(n),r.position.set(e.coord[0],e.coord[1],e.coordZ),"xyz"===n&&r.position.set(e.coord[0],e.coordZ,e.coord[1]),e.rotation&&(r.rotation=e.rotation,r.rotation[0]=-r.rotation[0],r.rotation[1]=-r.rotation[1],r.rotation[2]=180-r.rotation[2]),e.scale&&(r.scale=e.scale,"xyz"===n)){let e=r.scale[1];r.scale[1]=r.scale[2],r.scale[2]=e}this.scene.setModelTransform(e.id,r,t)}setModelTransform2(e,t){if(!e)return void(t&&t({result:0,message:"参数异常！"}));if(e.isChangeCoordX=!0,e.isChangeCoordY=!0,e.isChangeCoordZ=!0,e.isChangeRotationX=!0,e.isChangeRotationY=!0,e.isChangeRotationZ=!0,e.isChangeScaleX=!0,e.isChangeScaleY=!0,e.isChangeScaleZ=!0,void 0!==e.coordX&&""!==e.coordX&&null!==e.coordX||(e.isChangeCoordX=!1,e.coordX=0),0==e.coordType?(void 0!==e.coordY&&""!==e.coordY&&null!==e.coordY||(e.isChangeCoordY=!1,e.coordY=0),void 0!==e.coordZ&&""!==e.coordZ&&null!==e.coordZ||(e.isChangeCoordZ=!1,e.coordZ=0)):(void 0!==e.coordY&&""!==e.coordY&&null!==e.coordY||(e.isChangeCoordZ=!1,e.coordZ=0),void 0!==e.coordZ&&""!==e.coordZ&&null!==e.coordZ||(e.isChangeCoordY=!1,e.coordY=0)),void 0!==e.rotationX&&""!==e.rotationX&&null!==e.rotationX||(e.isChangeRotationX=!1),0==e.coordType?(void 0!==e.rotationY&&""!==e.rotationY&&null!==e.rotationY||(e.isChangeRotationY=!1),void 0!==e.rotationZ&&""!==e.rotationZ&&null!==e.rotationZ||(e.isChangeRotationZ=!1)):(void 0!==e.rotationY&&""!==e.rotationY&&null!==e.rotationY||(e.isChangeRotationZ=!1),void 0!==e.rotationZ&&""!==e.rotationZ&&null!==e.rotationZ||(e.isChangeRotationY=!1)),void 0!==e.scaleX&&""!==e.scaleX&&null!==e.scaleX||(e.isChangeScaleX=!1),0==e.coordType?(void 0!==e.scaleY&&""!==e.scaleY&&null!==e.scaleY||(e.isChangeScaleY=!1),void 0!==e.scaleZ&&""!==e.scaleZ&&null!==e.scaleZ||(e.isChangeScaleZ=!1)):(void 0!==e.scaleY&&""!==e.scaleY&&null!==e.scaleY||(e.isChangeScaleZ=!1),void 0!==e.scaleZ&&""!==e.scaleZ&&null!==e.scaleZ||(e.isChangeScaleY=!1)),e.isChangeScaleX&&e.scaleX<=0)return void(t&&t({result:0,message:"模型缩放参数错误!"}));if(e.isChangeScaleY&&e.scaleY<=0)return void(t&&t({result:0,message:"模型缩放参数错误!"}));if(e.isChangeScaleZ&&e.scaleZ<=0)return void(t&&t({result:0,message:"模型缩放参数错误!"}));if(e.duration<=0)return void(t&&t({result:0,message:"基础变换持续时长参数错误!"}));e.rotationX=-e.rotationX,e.rotationY=-e.rotationY,e.rotationZ=180-e.rotationZ;let r=0==e.coordType?"lla":"xyz";e.position=new Position(r),e.position.set(e.coordX,e.coordY,e.coordZ),"xyz"==r&&e.position.set(e.coordX,e.coordZ,e.coordY),this.scene.setModelTransform2(e,t)}setModelCoord(e,t){let r={},n=0==e.coordType?"lla":"xyz";r.position=new Position(n),r.position.set(e.coord[0],e.coord[1],e.coordZ),this.scene.setModelTransform(e.id,r,t)}setModelStyle(e,t){null!=e.maskFlowDirection&&(e.maskFlowDirection=e.maskFlowDirection>360?360:e.maskFlowDirection<0?0:e.maskFlowDirection),this.scene.setModelStyle(e.id,e,t)}setModelVisibility(e,t){this.scene.setModelVisible(e.name,e.isShow),t&&t({result:1,message:"成功。"})}showBuildingFloor(e,t){null==e.animation||1==e.animation?this.scene.showBuildingFloor(e.id,e.animation,e.floor,((e,r)=>{t&&t(e?{result:1,message:"成功。"}:{result:0,message:`失败，${r}`})})):t&&t({result:0,message:"失败，animation 属性值错误。"})}resetBuildingFloor(e,t){null==e.animation||1==e.animation?this.scene.showBuildingFloor(e.id,e.animation,null,((e,r)=>{t&&t(e?{result:1,message:"成功。"}:{result:0,message:`失败，${r}`})})):t&&t({result:0,message:"失败，animation 属性值错误。"})}addModelTip(e,t){this.scene.addModelTip(e,t)}removeModelTip(e,t){this.scene.removeModelTip(e,t)}addModel(e,t){let r=0==e.coordType?"lla":"xyz";e.position=new Position(r),e.position.set(e.coord[0],e.coord[1],e.coordZ),"xyz"==r&&e.position.set(e.coord[0],e.coordZ,e.coord[1]),e.rotation={x:e.rotation[0],y:-e.rotation[1],z:180-e.rotation[2]},e.scale={x:e.scale,y:e.scale,z:e.scale},this.scene.addModelForApi(e,t)}removeModel(e,t){this.scene.removeModelForApi(e,t)}rotatingModel(e,t){e.durationX<0||e.durationY<0||e.durationZ<0?t&&t({result:0,message:"旋转周期应为非负数。"}):this.scene.rotatingModel(e,t)}setModelRotationState(e,t){["pause","continue","stop"].includes(e.state)?this.scene.setModelRotationState(e,t):t&&t({result:0,message:"参数错误"})}blinkingModel(e,t){e.duration<=0?t&&t({result:0,message:"闪烁周期应为正数。"}):"default"==e.type?this.scene.blinkingModel(e,t):t&&t({result:0,message:"闪烁风格目前只支持default"})}setModelBlinkState(e,t){["pause","continue","stop"].includes(e.state)?this.scene.setModelBlinkState(e,t):t&&t({result:0,message:"参数错误"})}movingModel(e,t){let r=0==e.coordType?"lla":"xyz",n=[];e.points&&e.points.forEach((e=>{let t=new Position(r);t.set(e.coord[0],e.coord[1],e.coordZ),"xyz"===r&&t.set(e.coord[0],e.coordZ,e.coord[1]),t.speed=e.speed,n.push(t)})),e.points=n,this.scene.movingModel(e,t)}setModelMoveState(e,t){["pause","continue","stop"].includes(e.state)?this.scene.setModelMoveState(e,t):t&&t({result:0,message:"参数错误"})}pathingModel(e,t){let r=path.getLayer(e.pathId);r||t&&t({result:0,message:`失败，不存在 ${e.pathId} 路径。`});let n=r.getPositions();if(!n||n.length<=0)return t&&t({result:0,message:`失败，不存在 ${e.pathId} 路径点。`}),!1;e.points=n,e.passChange=path.setPathPass,this.scene.pathingModel(e,t),path.removeEventListener("updatePathCoord",this.scene.updatePathingModel),path.removeEventListener("removeLayer",this.scene.deletePathingModel),path.addEventListener("updatePathCoord",this.scene.updatePathingModel),path.addEventListener("removeLayer",this.scene.deletePathingModel)}setModelPathingState(e,t){["pause","continue","stop"].includes(e.state)?(e.passChange=path.setPathPass,this.scene.setModelPathingState(e,t),"stop"==e.state&&(path.removeEventListener("updatePathCoord",this.scene.updatePathingModel),path.removeEventListener("removeLayer",this.scene.deletePathingModel))):t&&t({result:0,message:"参数错误"})}selectModel(e,t){if(!["building","model"].includes(e.modelType.toLowerCase())||!["rect","circle","polygon"].includes(e.type.toLowerCase()))return void(t&&t({result:0,message:"参数错误!"}));let r=this.scene.tgapp.triggerEvent.onRectModelSelectionResult;switch(e.type){case"rect":r=this.scene.tgapp.triggerEvent.onRectModelSelectionResult;break;case"circle":r=this.scene.tgapp.triggerEvent.onCircleModelSelectionResult;break;case"polygon":r=this.scene.tgapp.triggerEvent.onPolygonModelSelectionResult}this.scene.selectModel(e,r),t&&t({result:1,message:"成功。"})}endSelectModel(e,t){this.scene.endSelectModel(e),t&&t({result:1,message:"成功。"})}pickModel(e,t){["building","model"].includes(e.modelType.toLowerCase())&&["click","hover"].includes(e.type.toLowerCase())?(this.scene.pickModel(e,this.scene.tgapp.triggerEvent.onClickModelResult),t&&t({result:1,message:"成功。"})):t&&t({result:0,message:"参数错误!"})}endPickModel(e,t){this.scene.endPickModel(e),t&&t({result:1,message:"成功。"})}clickModel(e,t){this.scene.clickModel(e,t,this.scene.tgapp.triggerEvent.onClickModelResult)}clickModelType(e,t){this.scene.clickModelType(e,this.scene.tgapp.triggerEvent.onClickModelTypeResult),t&&t({result:1,message:"成功。"})}clearModelSelected(e,t){this.scene.clearModelSelected(e),t&&t({result:1,message:"成功。"})}getModelArticulation(e,t){this.scene.getModelArticulation(e,t)}setModelArticulation(e,t){this.scene.setModelArticulation(e,t)}getModelAnimation(e,t){this.scene.getModelAnimation(e,t)}setModelAnimation(e,t){t&&t({result:0,message:"努力实现中..."})}playModelAnimation(e,t){this.scene.playModelAnimation(e,t)}highlightBuilding(e,t){"style1"==e.type?this.scene.highlightBuilding(e,t):t&&t({result:0,message:"高亮风格目前只支持style1"})}highlightFloor(e,t){"style1"==e.type?this.scene.highlightFloor(e,t):t&&t({result:0,message:"高亮风格目前只支持style1"})}highlightRoom(e,t){this.scene.highlightRoom(e,t)}getBuildings(e,t){this.scene.getBuildings(e,t)}}const models=new Models;class EventListener extends BaseComponent{constructor(){super(),this.type="eventListener",this.interfaceList=["addEventListener","removeEventListener"]}setScene(e){super.setScene(e)}addEventListener(e,t){for(const t in overlays){overlays[t].addSceneEventListener(e.eventName)}models.addSceneEventListener(e.eventName),t&&t({result:1,message:"成功。"})}removeEventListener(e,t){for(const t in overlays){overlays[t].removeSceneEventListener(e.eventName)}models.removeSceneEventListener(e.eventName),t&&t({result:1,message:"成功。"})}}const eventListener=new EventListener,components={};components[resource.type]=resource,components[camera.type]=camera,components[focus.type]=focus,components[controllor.type]=controllor,components[datum.type]=datum,components[other.type]=other,components[models.type]=models,components[agg.type]=agg,components[eventListener.type]=eventListener,Object.assign(components,overlays);class TGScene2Renderer{constructor(){this.container=null,this.url="",this.token="",this.resourceBasePath="",this.resolution=null,this.events=null,this.scene=null}init({container:e,url:t,token:r,resourceBasePath:n,resolution:i,events:a,editMode:o},s,l){this.container=e,this.url=t,this.token=r,this.resourceBasePath=n,this.resolution=i,this.events=a,this.editMode=o,this.resourceBasePath||(this.resourceBasePath="./scene"),this._loadScene(s,l)}_loadScene(e,t){this.scene=scene$1({url:this.url,additionalInfo:{resourceBasePath:this.resourceBasePath}}),this._initEventFrame(),this.scene.tgapp.triggerEvent.onServiceConnected({});let r={container:this.container,accessToken:this.token,editMode:this.editMode};this.resolution&&(r.width=this.resolution[0]>4096?4096:this.resolution[0],r.height=this.resolution[1]>2160?2160:this.resolution[1]),this.scene.init(r,(t=>this._sceneLoaded(t,e)),t)}_initEventFrame(){this.scene.tgapp={container:this.container,url:this.url,token:this.token,resourceBasePath:this.resourceBasePath,resolution:this.resolution},this.scene.tgapp.events=this.events,this.scene.tgapp.oldEvents={};for(const e in this.events)this[e]=(t,r)=>{this.scene.tgapp.oldEvents[e]=r};this.scene.tgapp.triggerEvent={};for(const e in this.events)this.scene.tgapp.triggerEvent[e]=t=>{this.scene.tgapp.events[e].map((e=>e(t))),this.scene.tgapp.oldEvents[e]&&this.scene.tgapp.oldEvents[e](t)}}async _sceneLoaded(e,t){if(1==e){this.scene.on("click","scene",(e=>{this.scene.tgapp.triggerEvent.onSceneClick({data:[{coord:[e.longitude,e.latitude],coordZ:e.altitude,coordType:0},{coord:[e.clickX,e.clickZ],coordZ:e.clickY,coordType:1}]})}));for(const e in components){let t=components[e];if(t.isComponent){t.setScene(this.scene);let e=t.getInterface();for(const r of e)this[r]=t[r].bind(t)}t.isResource&&await t.setResourcePath(`${this.resourceBasePath}/resource`)}this.scene.tgapp.triggerEvent.onSceneInit({name:"",default:!0}),t&&t({result:1,message:"成功，场景已加载。"})}else t&&t({result:0,message:"失败，场景未能正常加载。"})}destroy({},e){this.scene?(this.scene.off("click","scene"),this.scene.destroy(),this.scene=null,e&&e({result:1,message:"成功。"})):e&&e({result:0,message:"失败，试图销毁已经销毁的场景。"})}_debug(){return{scene:this.scene,components:components,core:this.scene._debugCore(),context:this.scene._debugCore()._debug().context}}}class TGRendererFactory{constructor(){this.getRenderer=({mode:e="",url:t="",container:r}={})=>{switch(e.toLowerCase()){case"streaming3":return new TGStreaming3Renderer({url:t,container:r});case"scene2":return new TGScene2Renderer({container:r})}}}}class EventRegister{constructor(e){this.events=e}register(){let e=this;Object.keys(eventMap).forEach((t=>{e.events[t]||(e.events[t]=[])}))}}class App{constructor(){const e={};let t=function(t,r){let n=t.eventName;e[n]||(n="on"+n.replace(n[0],n[0].toUpperCase()),e[n])?t.callback?-1==e[n].findIndex((e=>e==t.callback))?(e[n].push(t.callback),this.renderer&&this.renderer.addEventListener?this.renderer.addEventListener(t,r):r&&r({result:1,message:"成功。"})):r&&r({result:0,message:`失败，事件 ${t.eventName} 已注册此回调。`}):r&&r({result:0,message:"失败，添加事件监听的回调函数不应为空。"}):r&&r({result:0,message:`失败，事件 ${t.eventName} 不存在。`})},r=function(t,r){let n=t.eventName;if(!e[t.eventName]&&(n="on"+n.replace(n[0],n[0].toUpperCase()),!e[n]))return void(r&&r({result:0,message:`失败，事件 ${t.eventName} 不存在。`}));if(!t.callback)return e[n]=[],void(this.renderer&&this.renderer.removeEventListener?this.renderer.removeEventListener(t,r):r&&r({result:1,message:"成功。"}));let i=e[n].findIndex((e=>e==t.callback));-1!=i?(e[n].splice(i,1),this.renderer&&this.renderer.removeEventListener?this.renderer.removeEventListener(t,r):r&&r({result:1,message:"成功。"})):r&&r({result:0,message:`失败，事件 ${t.eventName} 未注册此回调。`})};new EventRegister(e).register(),window.onbeforeunload=function(){for(const t of e.onBrowserClose)t({})},document.addEventListener("visibilitychange",(function(){if(document.hidden)for(const t of e.onBrowserMinimize)t({})})),this.about=new About,this.about.print();var n=new TGRendererFactory;this.initScene=({container:t,mode:r="",url:i="",token:a="",resourceBasePath:o,resolution:s,isShareToken:l=!1,showDefaultLoading:c=!0,editMode:h=!1,useTCP:u=!0}={},d,p)=>{if(this.container=t,logger.debug({url:i,token:a,mode:r}),this.container=t,"scene"===r?r="scene2":"streaming"===r&&(r="streaming3"),this.renderer=n.getRenderer({mode:r}),!this.renderer)return logger.error("初始化失败：未初始化渲染器。"),void(Util.isFunction(d)&&d({result:0,message:"初始化失败：未初始化渲染器。"}));TGInterface.ensureImplements(this.renderer,TGRendererInterface),this.renderer.init({container:t,url:i,token:a,resourceBasePath:o,resolution:s,isShareToken:l,events:e,showDefaultLoading:c,editMode:h,useTCP:u},d,p)},this.uniCall=(n="",i={},a)=>{if(logger.debug({method:n,params:i}),"addEventListener"!==n)if("removeEventListener"!==n){if(!this.renderer)return logger.error("调用接口失败：未初始化渲染器。"),void(Util.isFunction(a)&&a({result:0,message:"调用接口失败：未初始化渲染器。"}));if(!Util.isStringNotEmpty(n))return logger.warn("调用接口失败：必须提供接口名称。"),void(Util.isFunction(a)&&a({result:0,message:"调用接口失败：必须提供接口名称。"}));if("function"!=typeof this.renderer[n])return window.notArr||(window.notArr=[]),notArr.push(n),logger.warn(`调用接口失败：请求的接口（${n}）不存在。`),void(Util.isFunction(a)&&a({result:0,message:`调用接口失败：请求的接口（${n}）不存在。`}));if("destroy"===n)for(const t in e)e[t]=[];this.renderer[n](i,a)}else r.call(this,i,a);else t.call(this,i,a)},this._debug=()=>{if(this.renderer._debug)return this.renderer._debug()}}}exports.App=App,Object.defineProperty(exports,"__esModule",{value:!0})}));
